{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "/schemas/core/webhook-payload.json",
  "title": "Webhook Payload",
  "description": "Payload structure sent to webhook endpoints when async task status changes. Fully adopts A2A Protocol's push notification payload structure (A2A Specification Section 4.3.3). The payload is a StreamResponse object containing exactly one of: task (Task object), message (Message object), statusUpdate (TaskStatusUpdateEvent), or artifactUpdate (TaskArtifactUpdateEvent). ADCP declares only the structure of parts.data (DataPart data field) within Message objects for task-specific payloads.",
  "type": "object",
  "oneOf": [
    {
      "type": "object",
      "properties": {
        "task": {
          "$ref": "/schemas/core/a2a-task.json",
          "description": "A Task object containing the current state of the task (A2A Specification Section 4.1.1)."
        }
      },
      "required": ["task"],
      "additionalProperties": false
    },
    {
      "type": "object",
      "properties": {
        "message": {
          "$ref": "/schemas/core/a2a-message.json",
          "description": "A Message object containing a message response (A2A Specification Section 4.1.4). ADCP declares only the structure of parts[].data (DataPart data field) for task-specific payloads."
        }
      },
      "required": ["message"],
      "additionalProperties": false
    },
    {
      "type": "object",
      "properties": {
        "statusUpdate": {
          "$ref": "/schemas/core/a2a-task-status-update-event.json",
          "description": "A TaskStatusUpdateEvent indicating a status change (A2A Specification Section 4.2.1)."
        }
      },
      "required": ["statusUpdate"],
      "additionalProperties": false
    },
    {
      "type": "object",
      "properties": {
        "artifactUpdate": {
          "$ref": "/schemas/core/a2a-task-artifact-update-event.json",
          "description": "A TaskArtifactUpdateEvent indicating artifact update (A2A Specification Section 4.2.2)."
        }
      },
      "required": ["artifactUpdate"],
      "additionalProperties": false
    }
  ],
  "notes": [
    "Webhooks are ONLY triggered when the initial response status is 'submitted' (long-running operations)",
    "This payload structure fully adopts A2A Protocol's push notification payload format (A2A Specification Section 4.3.3)",
    "The payload is a StreamResponse object (A2A Specification Section 3.2.3) containing exactly one of: task, message, statusUpdate, or artifactUpdate",
    "For status change events (like input-required, failed, working), use statusUpdate: {statusUpdate: {taskId, contextId, status: {state, message: {parts: [...]}, timestamp}, final}}",
    "For final completion with full task state, use task: {task: {id, contextId, status: {state, message: {parts: [...]}, timestamp}, ...}}",
    "Task ID is in statusUpdate.taskId (for statusUpdate) or task.id (for task variant)",
    "Task status state is in statusUpdate.status.state or task.status.state",
    "ADCP declares only the structure of parts[].data (DataPart data field) within Message objects - the task-specific payload",
    "Extract task data from statusUpdate.status.message.parts or task.status.message.parts array: find the DataPart (part with 'data' property) and use its data field",
    "For example, a create_media_buy webhook will have statusUpdate.status.message.parts or task.status.message.parts with a DataPart containing {data: {media_buy_id, buyer_ref, packages, ...}}",
    "TextPart (part with 'text' property) provides human-readable context but is optional",
    "The statusUpdate.final flag indicates if this is the final event in the stream",
    "Your webhook handler receives the complete A2A-compatible StreamResponse structure needed to process the result"
  ],
  "examples": [
    {
      "description": "Webhook for input-required status (human approval needed) - A2A StreamResponse with statusUpdate",
      "data": {
        "statusUpdate": {
          "taskId": "task_456",
          "contextId": "ctx_abc123",
          "status": {
            "state": "input-required",
            "timestamp": "2025-01-22T10:15:00Z",
            "message": {
              "messageId": "msg_456_001",
              "role": "agent",
              "parts": [
                {
                  "text": "Campaign budget $150K requires VP approval to proceed"
                },
                {
                  "data": {
                    "errors": [
                      {
                        "code": "APPROVAL_REQUIRED",
                        "message": "Budget exceeds auto-approval threshold of $100K. Awaiting VP approval before media buy creation.",
                        "field": "packages[0].budget"
                      }
                    ]
                  }
                }
              ]
            }
          },
          "final": false
        }
      }
    },
    {
      "description": "Webhook for completed create_media_buy - A2A StreamResponse with task object",
      "data": {
        "task": {
          "id": "task_456",
          "contextId": "ctx_abc123",
          "status": {
            "state": "completed",
            "timestamp": "2025-01-22T10:30:00Z",
            "message": {
              "messageId": "msg_456_002",
              "role": "agent",
              "parts": [
                {
                  "text": "Media buy created successfully with 2 packages ready for creative assignment"
                },
                {
                  "data": {
                    "media_buy_id": "mb_12345",
                    "buyer_ref": "nike_q1_campaign_2024",
                    "creative_deadline": "2024-01-30T23:59:59Z",
                    "packages": [
                      {
                        "package_id": "pkg_12345_001",
                        "buyer_ref": "nike_ctv_package",
                        "product_id": "ctv_sports_premium",
                        "budget": 60000,
                        "pacing": "even",
                        "pricing_option_id": "cpm-fixed-sports",
                        "paused": false,
                        "creative_assignments": [],
                        "format_ids_to_provide": [
                          {
                            "agent_url": "https://creative.adcontextprotocol.org",
                            "id": "video_standard_30s"
                          }
                        ]
                      }
                    ]
                  }
                }
              ]
            }
          }
        }
      }
    },
    {
      "description": "Webhook for failed sync_creatives - A2A StreamResponse with statusUpdate",
      "data": {
        "statusUpdate": {
          "taskId": "task_789",
          "contextId": "ctx_abc123",
          "status": {
            "state": "failed",
            "timestamp": "2025-01-22T10:46:00Z",
            "message": {
              "messageId": "msg_789_001",
              "role": "agent",
              "parts": [
                {
                  "text": "Creative sync failed due to invalid asset URLs"
                }
              ]
            }
          },
          "final": true
        }
      }
    }
  ]
}
