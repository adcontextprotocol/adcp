{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "/schemas/v1/media-buy/get-media-buy-delivery-response.json",
  "title": "Get Media Buy Delivery Response",
  "description": "Response payload for get_media_buy_delivery task",
  "type": "object",
  "properties": {
    "adcp_version": {
      "type": "string",
      "description": "AdCP schema version used for this response",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "notification_type": {
      "type": "string",
      "enum": ["scheduled", "final", "delayed", "adjusted"],
      "description": "Type of webhook notification (only present in webhook deliveries): scheduled = regular periodic update, final = campaign completed, delayed = data not yet available, adjusted = resending period with updated data"
    },
    "partial_data": {
      "type": "boolean",
      "description": "Indicates if any media buys in this webhook have missing/delayed data (only present in webhook deliveries)"
    },
    "unavailable_count": {
      "type": "integer",
      "minimum": 0,
      "description": "Number of media buys with reporting_delayed or failed status (only present in webhook deliveries when partial_data is true)"
    },
    "sequence_number": {
      "type": "integer",
      "minimum": 1,
      "description": "Sequential notification number (only present in webhook deliveries, starts at 1)"
    },
    "next_expected_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp for next expected notification (only present in webhook deliveries when notification_type is not 'final')"
    },
    "reporting_period": {
      "type": "object",
      "description": "Date range for the report. All periods use UTC timezone.",
      "properties": {
        "start": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 start timestamp in UTC (e.g., 2024-02-05T00:00:00Z)"
        },
        "end": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 end timestamp in UTC (e.g., 2024-02-05T23:59:59Z)"
        }
      },
      "required": ["start", "end"],
      "additionalProperties": false
    },
    "currency": {
      "type": "string",
      "description": "ISO 4217 currency code",
      "pattern": "^[A-Z]{3}$"
    },
    "aggregated_totals": {
      "type": "object",
      "description": "Combined metrics across all returned media buys. Only included in API responses (get_media_buy_delivery), not in webhook notifications.",
      "properties": {
        "impressions": {
          "type": "number",
          "description": "Total impressions delivered across all media buys",
          "minimum": 0
        },
        "spend": {
          "type": "number",
          "description": "Total amount spent across all media buys",
          "minimum": 0
        },
        "clicks": {
          "type": "number",
          "description": "Total clicks across all media buys (if applicable)",
          "minimum": 0
        },
        "video_completions": {
          "type": "number",
          "description": "Total video completions across all media buys (if applicable)",
          "minimum": 0
        },
        "media_buy_count": {
          "type": "integer",
          "description": "Number of media buys included in the response",
          "minimum": 0
        }
      },
      "required": ["impressions", "spend", "media_buy_count"],
      "additionalProperties": false
    },
    "media_buy_deliveries": {
      "type": "array",
      "description": "Array of delivery data for media buys. When used in webhook notifications, may contain multiple media buys aggregated by publisher. When used in get_media_buy_delivery API responses, typically contains requested media buys.",
      "items": {
        "type": "object",
        "properties": {
          "media_buy_id": {
            "type": "string",
            "description": "Publisher's media buy identifier"
          },
          "buyer_ref": {
            "type": "string",
            "description": "Buyer's reference identifier for this media buy"
          },
          "status": {
            "type": "string",
            "description": "Current media buy status. In webhook context, reporting_delayed indicates data temporarily unavailable.",
            "enum": ["pending", "active", "paused", "completed", "failed", "reporting_delayed"]
          },
          "message": {
            "type": "string",
            "description": "Human-readable message (typically present when status is reporting_delayed or failed)"
          },
          "expected_availability": {
            "type": "string",
            "format": "date-time",
            "description": "When delayed data is expected to be available (only present when status is reporting_delayed)"
          },
          "is_adjusted": {
            "type": "boolean",
            "description": "Indicates this delivery contains updated data for a previously reported period. Buyer should replace previous period data with these totals."
          },
          "pricing_model": {
            "$ref": "/schemas/v1/enums/pricing-model.json",
            "description": "Pricing model used for this media buy"
          },
          "totals": {
            "type": "object",
            "description": "Aggregate metrics for this media buy across all packages",
            "properties": {
              "impressions": {
                "type": "number",
                "description": "Total impressions delivered",
                "minimum": 0
              },
              "spend": {
                "type": "number",
                "description": "Total amount spent",
                "minimum": 0
              },
              "effective_rate": {
                "type": "number",
                "description": "Effective rate paid per unit based on pricing_model (e.g., actual CPM for 'cpm', actual cost per completed view for 'cpcv', actual cost per point for 'cpp')",
                "minimum": 0
              },
              "clicks": {
                "type": "number",
                "description": "Total clicks (for CPC or general reporting)",
                "minimum": 0
              },
              "ctr": {
                "type": "number",
                "description": "Click-through rate (clicks/impressions)",
                "minimum": 0,
                "maximum": 1
              },
              "views": {
                "type": "number",
                "description": "Total views at threshold (for CPV)",
                "minimum": 0
              },
              "completed_views": {
                "type": "number",
                "description": "Total 100% completions (for CPCV)",
                "minimum": 0
              },
              "video_completions": {
                "type": "number",
                "description": "DEPRECATED: Use completed_views instead",
                "minimum": 0
              },
              "completion_rate": {
                "type": "number",
                "description": "Completion rate (completed_views/impressions)",
                "minimum": 0,
                "maximum": 1
              },
              "conversions": {
                "type": "number",
                "description": "Total conversions (reserved for future CPA pricing support)",
                "minimum": 0
              },
              "leads": {
                "type": "number",
                "description": "Total leads generated (reserved for future CPL pricing support)",
                "minimum": 0
              },
              "grps": {
                "type": "number",
                "description": "Gross Rating Points delivered (for CPP)",
                "minimum": 0
              },
              "reach": {
                "type": "number",
                "description": "Unique individuals reached",
                "minimum": 0
              },
              "frequency": {
                "type": "number",
                "description": "Average frequency per individual",
                "minimum": 0
              },
              "quartile_data": {
                "type": "object",
                "description": "Video quartile completion data",
                "properties": {
                  "q1_views": {
                    "type": "number",
                    "description": "25% completion views",
                    "minimum": 0
                  },
                  "q2_views": {
                    "type": "number",
                    "description": "50% completion views",
                    "minimum": 0
                  },
                  "q3_views": {
                    "type": "number",
                    "description": "75% completion views",
                    "minimum": 0
                  },
                  "q4_views": {
                    "type": "number",
                    "description": "100% completion views",
                    "minimum": 0
                  }
                }
              },
              "dooh_metrics": {
                "type": "object",
                "description": "DOOH-specific delivery metrics (only included for DOOH campaigns)",
                "properties": {
                  "loop_plays": {
                    "type": "integer",
                    "description": "Number of times ad played in rotation across all screens",
                    "minimum": 0
                  },
                  "screens_used": {
                    "type": "integer",
                    "description": "Number of unique screens displaying the ad",
                    "minimum": 0
                  },
                  "screen_time_seconds": {
                    "type": "integer",
                    "description": "Total time ad was displayed across all screens in seconds",
                    "minimum": 0
                  },
                  "sov_achieved": {
                    "type": "number",
                    "description": "Actual share of voice delivered as decimal (0.0 to 1.0, e.g., 0.15 = 15%)",
                    "minimum": 0,
                    "maximum": 1
                  },
                  "calculation_basis": {
                    "type": "object",
                    "description": "Transparency into how DOOH metrics were calculated",
                    "properties": {
                      "total_loop_opportunities": {
                        "type": "integer",
                        "description": "Total number of loop plays available during campaign period",
                        "minimum": 0
                      },
                      "venue_traffic_estimate": {
                        "type": "integer",
                        "description": "Estimated number of people who passed by screens",
                        "minimum": 0
                      },
                      "impression_multiplier": {
                        "type": "number",
                        "description": "Average impressions per loop play based on venue traffic",
                        "minimum": 0
                      },
                      "data_source": {
                        "type": "string",
                        "description": "Source of audience measurement data with date",
                        "examples": ["geopath_december_2024", "vistar_q4_2024"]
                      }
                    }
                  },
                  "venue_breakdown": {
                    "type": "array",
                    "description": "Per-venue performance breakdown",
                    "items": {
                      "type": "object",
                      "properties": {
                        "venue_id": {
                          "type": "string",
                          "description": "Venue identifier"
                        },
                        "venue_name": {
                          "type": "string",
                          "description": "Human-readable venue name"
                        },
                        "venue_type": {
                          "type": "string",
                          "description": "Venue type (e.g., 'airport', 'transit', 'retail', 'billboard')"
                        },
                        "impressions": {
                          "type": "integer",
                          "description": "Impressions delivered at this venue",
                          "minimum": 0
                        },
                        "loop_plays": {
                          "type": "integer",
                          "description": "Loop plays at this venue",
                          "minimum": 0
                        },
                        "screens_used": {
                          "type": "integer",
                          "description": "Number of screens used at this venue",
                          "minimum": 0
                        }
                      },
                      "required": ["venue_id", "impressions"],
                      "additionalProperties": false
                    }
                  }
                },
                "additionalProperties": false
              }
            },
            "required": ["spend"],
            "additionalProperties": true
          },
          "by_package": {
            "type": "array",
            "description": "Metrics broken down by package",
            "items": {
              "type": "object",
              "properties": {
                "package_id": {
                  "type": "string",
                  "description": "Publisher's package identifier"
                },
                "buyer_ref": {
                  "type": "string",
                  "description": "Buyer's reference identifier for this package"
                },
                "impressions": {
                  "type": "number",
                  "description": "Package impressions",
                  "minimum": 0
                },
                "spend": {
                  "type": "number",
                  "description": "Package spend",
                  "minimum": 0
                },
                "clicks": {
                  "type": "number",
                  "description": "Package clicks",
                  "minimum": 0
                },
                "views": {
                  "type": "number",
                  "description": "Package views (for CPV)",
                  "minimum": 0
                },
                "completed_views": {
                  "type": "number",
                  "description": "Package completed views (for CPCV)",
                  "minimum": 0
                },
                "video_completions": {
                  "type": "number",
                  "description": "DEPRECATED: Use completed_views instead",
                  "minimum": 0
                },
                "conversions": {
                  "type": "number",
                  "description": "Package conversions (reserved for future CPA pricing support)",
                  "minimum": 0
                },
                "leads": {
                  "type": "number",
                  "description": "Package leads (reserved for future CPL pricing support)",
                  "minimum": 0
                },
                "grps": {
                  "type": "number",
                  "description": "Package GRPs (for CPP)",
                  "minimum": 0
                },
                "pacing_index": {
                  "type": "number",
                  "description": "Delivery pace (1.0 = on track, <1.0 = behind, >1.0 = ahead)",
                  "minimum": 0
                },
                "dooh_metrics": {
                  "type": "object",
                  "description": "DOOH-specific metrics for this package (only included for DOOH campaigns)",
                  "properties": {
                    "loop_plays": {
                      "type": "integer",
                      "description": "Loop plays for this package",
                      "minimum": 0
                    },
                    "screens_used": {
                      "type": "integer",
                      "description": "Screens used for this package",
                      "minimum": 0
                    },
                    "screen_time_seconds": {
                      "type": "integer",
                      "description": "Screen time for this package in seconds",
                      "minimum": 0
                    },
                    "sov_achieved": {
                      "type": "number",
                      "description": "Actual SOV for this package (0.0 to 1.0)",
                      "minimum": 0,
                      "maximum": 1
                    }
                  },
                  "additionalProperties": false
                }
              },
              "required": ["package_id", "spend"],
              "additionalProperties": true
            }
          },
          "daily_breakdown": {
            "type": "array",
            "description": "Day-by-day delivery",
            "items": {
              "type": "object",
              "properties": {
                "date": {
                  "type": "string",
                  "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
                  "description": "Date (YYYY-MM-DD)"
                },
                "impressions": {
                  "type": "number",
                  "description": "Daily impressions",
                  "minimum": 0
                },
                "spend": {
                  "type": "number",
                  "description": "Daily spend",
                  "minimum": 0
                }
              },
              "required": ["date", "impressions", "spend"],
              "additionalProperties": false
            }
          }
        },
        "required": ["media_buy_id", "status", "totals", "by_package"],
        "additionalProperties": false
      }
    },
    "errors": {
      "type": "array",
      "description": "Task-specific errors and warnings (e.g., missing delivery data, reporting platform issues)",
      "items": {
        "$ref": "/schemas/v1/core/error.json"
      }
    }
  },
  "required": ["adcp_version", "reporting_period", "currency", "media_buy_deliveries"],
  "additionalProperties": false
}