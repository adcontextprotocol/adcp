{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "/schemas/v1/media-buy/get-media-buy-delivery-response.json",
  "title": "Get Media Buy Delivery Response",
  "description": "Response payload for get_media_buy_delivery task",
  "type": "object",
  "properties": {
    "adcp_version": {
      "type": "string",
      "description": "AdCP schema version used for this response",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "notification_type": {
      "type": "string",
      "enum": ["scheduled", "final", "delayed", "correction"],
      "description": "Type of webhook notification (only present in webhook deliveries): scheduled = regular periodic update, final = campaign completed, delayed = data not yet available, correction = out-of-band correction for late-arriving data"
    },
    "partial_data": {
      "type": "boolean",
      "description": "Indicates if any media buys in this webhook have missing/delayed data (only present in webhook deliveries)"
    },
    "unavailable_count": {
      "type": "integer",
      "minimum": 0,
      "description": "Number of media buys with reporting_delayed or failed status (only present in webhook deliveries when partial_data is true)"
    },
    "sequence_number": {
      "type": "integer",
      "minimum": 1,
      "description": "Sequential notification number (only present in webhook deliveries, starts at 1)"
    },
    "next_expected_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp for next expected notification (only present in webhook deliveries when notification_type is not 'final')"
    },
    "reporting_period": {
      "type": "object",
      "description": "Date range for the report",
      "properties": {
        "start": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 start timestamp with timezone offset"
        },
        "end": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 end timestamp with timezone offset"
        },
        "duration_hours": {
          "type": "number",
          "description": "Actual duration in hours (may be 23, 24, or 25 due to DST transitions)",
          "minimum": 0
        },
        "is_dst_transition": {
          "type": "boolean",
          "description": "Indicates if this period includes a DST transition"
        },
        "dst_transition_type": {
          "type": "string",
          "enum": ["spring_forward", "fall_back"],
          "description": "Type of DST transition (only present when is_dst_transition is true)"
        }
      },
      "required": ["start", "end"],
      "additionalProperties": false
    },
    "currency": {
      "type": "string",
      "description": "ISO 4217 currency code",
      "pattern": "^[A-Z]{3}$"
    },
    "aggregated_totals": {
      "type": "object",
      "description": "Combined metrics across all returned media buys. Only included in API responses (get_media_buy_delivery), not in webhook notifications.",
      "properties": {
        "impressions": {
          "type": "number",
          "description": "Total impressions delivered across all media buys",
          "minimum": 0
        },
        "spend": {
          "type": "number",
          "description": "Total amount spent across all media buys",
          "minimum": 0
        },
        "clicks": {
          "type": "number",
          "description": "Total clicks across all media buys (if applicable)",
          "minimum": 0
        },
        "video_completions": {
          "type": "number",
          "description": "Total video completions across all media buys (if applicable)",
          "minimum": 0
        },
        "media_buy_count": {
          "type": "integer",
          "description": "Number of media buys included in the response",
          "minimum": 0
        }
      },
      "required": ["impressions", "spend", "media_buy_count"],
      "additionalProperties": false
    },
    "media_buy_deliveries": {
      "type": "array",
      "description": "Array of delivery data for media buys. When used in webhook notifications, may contain multiple media buys aggregated by publisher. When used in get_media_buy_delivery API responses, typically contains requested media buys.",
      "items": {
        "type": "object",
        "properties": {
          "media_buy_id": {
            "type": "string",
            "description": "Publisher's media buy identifier"
          },
          "buyer_ref": {
            "type": "string",
            "description": "Buyer's reference identifier for this media buy"
          },
          "status": {
            "type": "string",
            "description": "Current media buy status. In webhook context, reporting_delayed indicates data temporarily unavailable.",
            "enum": ["pending", "active", "paused", "completed", "failed", "reporting_delayed"]
          },
          "message": {
            "type": "string",
            "description": "Human-readable message (typically present when status is reporting_delayed or failed)"
          },
          "expected_availability": {
            "type": "string",
            "format": "date-time",
            "description": "When delayed data is expected to be available (only present when status is reporting_delayed)"
          },
          "is_correction": {
            "type": "boolean",
            "description": "Indicates this delivery replaces a previously reported period (for late-arriving data)"
          },
          "correction_reason": {
            "type": "string",
            "description": "Explanation of why correction was needed (only present when is_correction is true)"
          },
          "adjustments": {
            "type": "array",
            "description": "Incremental adjustments to previously reported periods (for late-arriving data)",
            "items": {
              "type": "object",
              "properties": {
                "period": {
                  "type": "string",
                  "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
                  "description": "Date being adjusted (YYYY-MM-DD)"
                },
                "impressions": {
                  "type": "number",
                  "description": "Additional impressions to add"
                },
                "spend": {
                  "type": "number",
                  "description": "Additional spend to add"
                },
                "clicks": {
                  "type": "number",
                  "description": "Additional clicks to add"
                },
                "reason": {
                  "type": "string",
                  "description": "Explanation of adjustment"
                }
              },
              "required": ["period", "reason"],
              "additionalProperties": false
            }
          },
          "totals": {
            "type": "object",
            "description": "Aggregate metrics for this media buy across all packages",
            "properties": {
              "impressions": {
                "type": "number",
                "description": "Total impressions delivered",
                "minimum": 0
              },
              "spend": {
                "type": "number",
                "description": "Total amount spent",
                "minimum": 0
              },
              "clicks": {
                "type": "number",
                "description": "Total clicks (if applicable)",
                "minimum": 0
              },
              "ctr": {
                "type": "number",
                "description": "Click-through rate (clicks/impressions)",
                "minimum": 0,
                "maximum": 1
              },
              "video_completions": {
                "type": "number",
                "description": "Total video completions (if applicable)",
                "minimum": 0
              },
              "completion_rate": {
                "type": "number",
                "description": "Video completion rate (completions/impressions)",
                "minimum": 0,
                "maximum": 1
              }
            },
            "required": ["impressions", "spend"],
            "additionalProperties": false
          },
          "by_package": {
            "type": "array",
            "description": "Metrics broken down by package",
            "items": {
              "type": "object",
              "properties": {
                "package_id": {
                  "type": "string",
                  "description": "Publisher's package identifier"
                },
                "buyer_ref": {
                  "type": "string",
                  "description": "Buyer's reference identifier for this package"
                },
                "impressions": {
                  "type": "number",
                  "description": "Package impressions",
                  "minimum": 0
                },
                "spend": {
                  "type": "number",
                  "description": "Package spend",
                  "minimum": 0
                },
                "clicks": {
                  "type": "number",
                  "description": "Package clicks",
                  "minimum": 0
                },
                "video_completions": {
                  "type": "number",
                  "description": "Package video completions",
                  "minimum": 0
                },
                "pacing_index": {
                  "type": "number",
                  "description": "Delivery pace (1.0 = on track, <1.0 = behind, >1.0 = ahead)",
                  "minimum": 0
                }
              },
              "required": ["package_id", "impressions", "spend"],
              "additionalProperties": false
            }
          },
          "daily_breakdown": {
            "type": "array",
            "description": "Day-by-day delivery",
            "items": {
              "type": "object",
              "properties": {
                "date": {
                  "type": "string",
                  "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
                  "description": "Date (YYYY-MM-DD)"
                },
                "impressions": {
                  "type": "number",
                  "description": "Daily impressions",
                  "minimum": 0
                },
                "spend": {
                  "type": "number",
                  "description": "Daily spend",
                  "minimum": 0
                }
              },
              "required": ["date", "impressions", "spend"],
              "additionalProperties": false
            }
          },
          "webhook_health": {
            "type": "object",
            "description": "Webhook delivery health metrics (only present in get_media_buy_delivery API responses when webhook is configured, not in webhook notifications themselves)",
            "properties": {
              "webhook_url": {
                "type": "string",
                "format": "uri",
                "description": "Configured webhook endpoint URL"
              },
              "last_delivery_attempt": {
                "type": "string",
                "format": "date-time",
                "description": "When publisher last attempted delivery (success or failure)"
              },
              "last_successful_delivery": {
                "type": "string",
                "format": "date-time",
                "description": "Most recent successful delivery"
              },
              "last_failure": {
                "type": "string",
                "format": "date-time",
                "description": "Most recent failed delivery attempt"
              },
              "last_failure_reason": {
                "type": "string",
                "description": "Human-readable error from last failure"
              },
              "total_attempts": {
                "type": "integer",
                "minimum": 0,
                "description": "Lifetime webhook delivery attempts"
              },
              "total_successes": {
                "type": "integer",
                "minimum": 0,
                "description": "Lifetime successful deliveries"
              },
              "total_failures": {
                "type": "integer",
                "minimum": 0,
                "description": "Lifetime failed deliveries"
              },
              "circuit_breaker_status": {
                "type": "string",
                "enum": ["CLOSED", "OPEN", "HALF_OPEN"],
                "description": "Current circuit breaker state: CLOSED = normal operation, OPEN = endpoint down, HALF_OPEN = testing recovery"
              },
              "next_scheduled_delivery": {
                "type": "string",
                "format": "date-time",
                "description": "When next webhook is scheduled"
              }
            },
            "required": ["webhook_url", "total_attempts", "total_successes", "total_failures", "circuit_breaker_status"],
            "additionalProperties": false
          }
        },
        "required": ["media_buy_id", "status", "totals", "by_package"],
        "additionalProperties": false
      }
    },
    "errors": {
      "type": "array",
      "description": "Task-specific errors and warnings (e.g., missing delivery data, reporting platform issues)",
      "items": {
        "$ref": "/schemas/v1/core/error.json"
      }
    }
  },
  "required": ["adcp_version", "reporting_period", "currency", "media_buy_deliveries"],
  "additionalProperties": false
}