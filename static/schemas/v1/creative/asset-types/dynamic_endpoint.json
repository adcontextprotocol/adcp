{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "/schemas/v1/creative/asset-types/dynamic_endpoint.json",
  "title": "Dynamic Endpoint Asset Type Schema",
  "description": "Schema for dynamic creative rendering - either an embed tag (HTML/JS/VAST) or a webhook that returns content at render time",
  "oneOf": [
    {
      "type": "object",
      "description": "Embed tag for client-side dynamic rendering (HTML/JavaScript/VAST)",
      "properties": {
        "asset_id": {
          "type": "string",
          "pattern": "^[a-z0-9_]+$",
          "description": "Unique identifier for this asset within the format"
        },
        "asset_type": {
          "type": "string",
          "const": "dynamic_endpoint"
        },
        "required": {
          "type": "boolean",
          "description": "Whether this asset is mandatory for the format"
        },
        "delivery_method": {
          "type": "string",
          "const": "tag",
          "description": "Indicates this is an embed tag"
        },
        "tag_type": {
          "type": "string",
          "enum": ["html", "javascript", "vast"],
          "description": "Type of tag content"
        },
        "tag_content": {
          "type": "string",
          "description": "The actual tag code (HTML snippet, JavaScript, or VAST XML)"
        },
        "supported_macros": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Universal macros this tag expects (e.g., DEVICE_TYPE, COUNTRY, WEATHER)"
        }
      },
      "required": ["asset_id", "asset_type", "required", "delivery_method", "tag_type", "tag_content"],
      "additionalProperties": false
    },
    {
      "type": "object",
      "description": "Webhook for server-side dynamic rendering",
      "properties": {
        "asset_id": {
          "type": "string",
          "pattern": "^[a-z0-9_]+$",
          "description": "Unique identifier for this asset within the format"
        },
        "asset_type": {
          "type": "string",
          "const": "dynamic_endpoint"
        },
        "required": {
          "type": "boolean",
          "description": "Whether this asset is mandatory for the format"
        },
        "delivery_method": {
          "type": "string",
          "const": "webhook",
          "description": "Indicates this is a server-side webhook"
        },
        "url": {
          "type": "string",
          "format": "uri",
          "description": "Webhook URL to call for dynamic content"
        },
        "method": {
          "type": "string",
          "enum": ["GET", "POST"],
          "default": "POST",
          "description": "HTTP method"
        },
        "timeout_ms": {
          "type": "integer",
          "minimum": 10,
          "maximum": 5000,
          "default": 500,
          "description": "Maximum time to wait for response in milliseconds"
        },
        "supported_macros": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Universal macros to pass to webhook (e.g., DEVICE_TYPE, COUNTRY, WEATHER)"
        },
        "response_type": {
          "type": "string",
          "enum": ["html", "json", "xml", "javascript"],
          "description": "Expected content type of webhook response"
        },
        "security": {
          "type": "object",
          "description": "Security configuration for webhook calls",
          "properties": {
            "method": {
              "type": "string",
              "enum": ["hmac_sha256", "api_key", "none"],
              "description": "Authentication method"
            },
            "hmac_header": {
              "type": "string",
              "description": "Header name for HMAC signature (e.g., 'X-Signature')"
            },
            "api_key_header": {
              "type": "string",
              "description": "Header name for API key (e.g., 'X-API-Key')"
            }
          },
          "required": ["method"]
        },
        "fallback_required": {
          "type": "boolean",
          "default": true,
          "description": "Whether a fallback asset must be provided if webhook fails"
        }
      },
      "required": ["asset_id", "asset_type", "required", "delivery_method", "url", "response_type", "security"],
      "additionalProperties": false
    }
  ]
}
