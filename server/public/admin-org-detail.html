<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Organization Details - AdCP Registry</title>
  <link rel="stylesheet" href="/design-system.css">
  <script src="/js/company-types.js"></script>
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <style>
    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-wide);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    .breadcrumb {
      margin-bottom: var(--space-4);
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }
    .breadcrumb a {
      color: var(--color-brand);
      text-decoration: none;
    }
    .breadcrumb a:hover {
      text-decoration: underline;
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-5);
    }
    h1 {
      margin-bottom: var(--space-2);
      color: var(--color-text-heading);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    h2 {
      font-size: var(--text-lg);
      margin-bottom: var(--space-4);
      color: var(--color-text-heading);
    }
    .subtitle {
      color: var(--color-text-secondary);
      margin-bottom: var(--space-4);
    }

    /* Engagement level */
    .engagement-fires {
      font-size: var(--text-xl);
      letter-spacing: 2px;
    }
    .engagement-reasons {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-1);
    }

    /* Engagement signals */
    .signal-item {
      display: flex;
      justify-content: space-between;
      padding: var(--space-2) 0;
      border-bottom: var(--border-1) solid var(--color-gray-100);
      font-size: var(--text-sm);
    }
    .signal-item:last-child {
      border-bottom: none;
    }
    .signal-label {
      color: var(--color-text-secondary);
    }
    .signal-value {
      font-weight: var(--font-medium);
    }
    .signal-value.positive {
      color: var(--color-success-600);
    }
    .signal-value.negative {
      color: var(--color-text-muted);
    }
    .interest-badge {
      display: inline-block;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
    }
    .interest-low { background: var(--color-gray-200); color: var(--color-text-secondary); }
    .interest-medium { background: var(--color-warning-100); color: var(--color-warning-700); }
    .interest-high { background: var(--color-success-100); color: var(--color-success-700); }
    .interest-very_high { background: var(--color-success-200); color: var(--color-success-800); }

    /* Grid layout */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-5);
    }
    @media (max-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    /* Info rows */
    .info-row {
      display: flex;
      padding: var(--space-2) 0;
      border-bottom: var(--border-1) solid var(--color-gray-100);
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      width: 140px;
      font-weight: var(--font-semibold);
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
    }
    .info-value {
      flex: 1;
      font-size: var(--text-sm);
    }

    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
    }
    .status-signed_up { background: var(--color-info-100); color: var(--color-info-700); }
    .status-prospect { background: var(--color-gray-200); color: var(--color-text-heading); }
    .status-contacted { background: var(--color-info-100); color: var(--color-info-700); }
    .status-responded { background: var(--color-warning-100); color: var(--color-warning-700); }
    .status-interested { background: var(--color-primary-100); color: var(--color-primary-700); }
    .status-negotiating { background: var(--color-primary-200); color: var(--color-primary-800); }
    .status-converted { background: var(--color-success-100); color: var(--color-success-700); }
    .status-declined { background: var(--color-error-100); color: var(--color-error-700); }
    .status-disqualified { background: var(--color-gray-300); color: var(--color-text-muted); }
    .status-member { background: var(--color-success-600); color: white; font-weight: var(--font-bold); }

    /* Members list */
    .members-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .members-list li {
      padding: var(--space-2) 0;
      border-bottom: var(--border-1) solid var(--color-gray-100);
      font-size: var(--text-sm);
    }
    .members-list li:last-child {
      border-bottom: none;
    }
    .member-role {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-left: var(--space-2);
    }
    .member-name-link {
      color: var(--color-brand);
      text-decoration: none;
      cursor: pointer;
    }
    .member-name-link:hover {
      text-decoration: underline;
    }

    /* Working groups */
    .wg-badge {
      display: inline-block;
      padding: var(--space-1) var(--space-2);
      margin-right: var(--space-2);
      margin-bottom: var(--space-2);
      background: var(--color-primary-100);
      color: var(--color-primary-700);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
    }

    /* Activities timeline */
    .timeline {
      position: relative;
      padding-left: var(--space-6);
    }
    .timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--color-gray-200);
    }
    .timeline-item {
      position: relative;
      padding-bottom: var(--space-5);
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -22px;
      top: 4px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--color-brand);
      border: 2px solid var(--color-bg-card);
    }
    .timeline-item.is-next-step::before {
      background: var(--color-warning-500);
    }
    .timeline-item.completed::before {
      background: var(--color-success-500);
    }
    .timeline-date {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-bottom: var(--space-1);
    }
    .timeline-type {
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      text-transform: capitalize;
    }
    .timeline-description {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-1);
    }
    .timeline-meta {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }

    /* Next steps */
    .next-step-item {
      padding: var(--space-3);
      background: var(--color-warning-50);
      border-left: 3px solid var(--color-warning-500);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-3);
    }
    .next-step-item.overdue {
      background: var(--color-error-50);
      border-left-color: var(--color-error-500);
    }
    .next-step-due {
      font-size: var(--text-xs);
      color: var(--color-warning-600);
      margin-bottom: var(--space-1);
    }
    .next-step-item.overdue .next-step-due {
      color: var(--color-error-600);
    }
    .next-step-description {
      font-size: var(--text-sm);
    }
    .next-step-owner {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }

    /* Buttons */
    .btn {
      padding: var(--space-2) var(--space-4);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .btn-primary {
      background: var(--color-brand);
      color: white;
    }
    .btn-primary:hover {
      background: var(--color-primary-700);
    }
    .btn-secondary {
      background: var(--color-gray-200);
      color: var(--color-text-heading);
    }
    .btn-secondary:hover {
      background: var(--color-gray-300);
    }
    .btn-sm {
      padding: var(--space-1) var(--space-2);
      font-size: var(--text-xs);
    }
    .btn-success {
      background: var(--color-success-600);
      color: white;
    }
    .btn-success:hover {
      background: var(--color-success-700);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: var(--color-surface-overlay);
    }
    .modal-content {
      background-color: var(--color-bg-card);
      margin: var(--space-8) auto;
      padding: var(--space-8);
      border-radius: var(--radius-md);
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-5);
      padding-bottom: var(--space-4);
      border-bottom: var(--border-2) solid var(--color-gray-200);
    }
    .modal-close {
      font-size: var(--text-3xl);
      font-weight: var(--font-bold);
      color: var(--color-text-secondary);
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      line-height: 1;
    }
    .modal-close:hover {
      color: var(--color-text-heading);
    }

    /* Form */
    .form-group {
      margin-bottom: var(--space-4);
    }
    .form-group label {
      display: block;
      margin-bottom: var(--space-1);
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      color: var(--color-text-heading);
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: var(--space-2.5);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
    }
    .form-hint {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      font-size: var(--text-sm);
      cursor: pointer;
      padding: var(--space-1) var(--space-2);
      background: var(--color-gray-100);
      border-radius: var(--radius-sm);
      transition: background-color 0.15s;
    }
    .checkbox-label:hover {
      background: var(--color-gray-200);
    }
    .checkbox-label:has(input:checked) {
      background: var(--color-primary-100);
      color: var(--color-primary-700);
    }
    .checkbox-label input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    .modal-actions {
      display: flex;
      gap: var(--space-2.5);
      justify-content: flex-end;
      margin-top: var(--space-6);
      padding-top: var(--space-4);
      border-top: var(--border-1) solid var(--color-gray-200);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: var(--space-12);
      color: var(--color-text-secondary);
    }

    .empty-state {
      text-align: center;
      padding: var(--space-8);
      color: var(--color-text-muted);
      font-size: var(--text-sm);
    }


    /* Pending Invoices */
    .invoice-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: var(--space-3);
      background: var(--color-bg-subtle);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-2);
    }
    .invoice-item:last-child {
      margin-bottom: 0;
    }
    .invoice-info {
      flex: 1;
    }
    .invoice-product {
      font-weight: var(--font-semibold);
      margin-bottom: var(--space-1);
    }
    .invoice-amount {
      font-size: var(--text-lg);
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
    }
    .invoice-meta {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }
    .invoice-status {
      display: inline-block;
      padding: var(--space-0.5) var(--space-1.5);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      margin-left: var(--space-2);
    }
    .invoice-status.open {
      background: var(--color-warning-100);
      color: var(--color-warning-700);
    }
    .invoice-status.draft {
      background: var(--color-gray-200);
      color: var(--color-text-heading);
    }
    .invoice-actions {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      align-items: flex-end;
    }
    .btn-danger {
      background: var(--color-error-100);
      color: var(--color-error-700);
      border: var(--border-1) solid var(--color-error-200);
    }
    .btn-danger:hover {
      background: var(--color-error-200);
    }

    /* Owner selector */
    .owner-selector {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
    }
    .owner-name {
      cursor: pointer;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      transition: var(--transition-all);
    }
    .owner-name:hover {
      background: var(--color-gray-100);
    }
    .owner-dropdown {
      display: none;
      position: relative;
    }
    .owner-dropdown.active {
      display: block;
    }
    .owner-dropdown select {
      padding: var(--space-1) var(--space-2);
      border: var(--border-1) solid var(--color-gray-300);
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
      cursor: pointer;
    }
    .watch-btn {
      padding: var(--space-1);
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: var(--text-base);
      opacity: 0.4;
      transition: var(--transition-all);
    }
    .watch-btn:hover {
      opacity: 0.7;
    }
    .watch-btn.watching {
      opacity: 1;
      color: var(--color-warning-500);
    }
    .watch-btn.watching:hover {
      opacity: 0.8;
    }

    /* Domain list */
    .domains-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .domain-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-2) 0;
      border-bottom: var(--border-1) solid var(--color-gray-100);
      font-size: var(--text-sm);
    }
    .domain-item:last-child {
      border-bottom: none;
    }
    .domain-info {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .domain-name {
      font-family: var(--font-mono);
    }
    .domain-badge {
      display: inline-block;
      padding: var(--space-0.5) var(--space-1.5);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .domain-badge.primary {
      background: var(--color-primary-100);
      color: var(--color-primary-700);
    }
    .domain-badge.verified {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .domain-badge.workos {
      background: var(--color-info-100);
      color: var(--color-info-700);
    }
    .domain-badge.manual {
      background: var(--color-gray-200);
      color: var(--color-text-heading);
    }
    .domain-actions {
      display: flex;
      gap: var(--space-1);
    }
    .btn-icon {
      padding: var(--space-1);
      font-size: var(--text-xs);
      background: transparent;
      border: none;
      color: var(--color-text-muted);
      cursor: pointer;
    }
    .btn-icon:hover {
      color: var(--color-text-heading);
    }
    .btn-icon.danger:hover {
      color: var(--color-error-600);
    }
    /* Quick follow-up inline form */
    .quick-followup {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-4);
      padding-top: var(--space-4);
      border-top: var(--border-1) solid var(--color-gray-200);
    }
    .quick-followup-input {
      flex: 1;
      padding: var(--space-2) var(--space-3);
      border: var(--border-1) solid var(--color-gray-300);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }
    .quick-followup-input:focus {
      outline: none;
      border-color: var(--color-brand);
      box-shadow: 0 0 0 2px var(--color-brand-light);
    }
    .quick-followup-input::placeholder {
      color: var(--color-text-muted);
    }
  </style>
</head>
<body>
  <!-- AAO top navigation -->
  <div id="adcp-nav"></div>

  <div id="loading" class="loading">
    Loading organization details...
  </div>

  <div id="content" style="display: none;">
    <div class="container">
      <div class="breadcrumb">
        <a href="/admin/prospects">Prospects</a> / <span id="breadcrumbName">Organization</span>
      </div>

      <!-- Header Card -->
      <div class="card">
        <div class="card-header">
          <div>
            <h1>
              <span id="orgName">Loading...</span>
              <span id="engagementFires" class="engagement-fires"></span>
            </h1>
            <div id="engagementReasons" class="engagement-reasons"></div>
          </div>
          <div style="display: flex; gap: var(--space-2);">
            <button class="btn btn-secondary" onclick="openPaymentLinkModal()" title="Generate payment link">ðŸ’³ Pay Link</button>
            <button class="btn btn-secondary" onclick="openInvoiceModal()" title="Send invoice">ðŸ“„ Invoice</button>
            <button class="btn btn-secondary" onclick="openEditOrgModal()">Edit</button>
            <button class="btn btn-secondary" onclick="openLogActivityModal()">Log Activity</button>
            <button class="btn btn-secondary" onclick="runAIEnrichment()" id="aiEnrichBtn" title="Research and enrich this prospect using AI">AI Enrich</button>
            <button class="btn btn-primary" onclick="openAddNextStepModal()">Add Next Step</button>
          </div>
        </div>

        <div class="grid-2">
          <div>
            <div class="info-row">
              <span class="info-label">Status</span>
              <span class="info-value" id="orgStatus">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Source</span>
              <span class="info-value" id="orgSource">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Company Type</span>
              <span class="info-value" id="orgType">-</span>
            </div>
            <div class="info-row" id="parentOrgRow" style="display: none;">
              <span class="info-label">Parent Org</span>
              <span class="info-value" id="orgParent">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Owner</span>
              <span class="info-value" id="orgOwner">
                <span class="owner-selector">
                  <span id="ownerDisplay" class="owner-name" onclick="showOwnerDropdown()" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' ')showOwnerDropdown()">-</span>
                  <div id="ownerDropdown" class="owner-dropdown">
                    <select id="ownerSelect" onchange="assignOwner(this.value)">
                      <option value="">Unassigned</option>
                    </select>
                  </div>
                  <button id="watchBtn" class="watch-btn" onclick="toggleWatch()" title="Watch this organization">â˜†</button>
                </span>
              </span>
            </div>
          </div>
          <div>
            <div class="info-row">
              <span class="info-label">Contact</span>
              <span class="info-value" id="orgContact">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Created</span>
              <span class="info-value" id="orgCreated">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Last Activity</span>
              <span class="info-value" id="orgLastActivity">-</span>
            </div>
            <div class="info-row" id="invoiceRequestedRow" style="display: none;">
              <span class="info-label">Invoice Requested</span>
              <span class="info-value" id="orgInvoiceRequested">-</span>
            </div>
          </div>
        </div>

        <div id="orgNotes" style="margin-top: var(--space-4); display: none;">
          <strong style="font-size: var(--text-sm);">Notes:</strong>
          <div id="orgNotesText" style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-top: var(--space-1); white-space: pre-wrap;"></div>
        </div>
      </div>

      <div class="grid-2">
        <!-- Left Column -->
        <div>
          <!-- Engagement Signals -->
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
              <h2 id="engagementSectionTitle" style="margin-bottom: 0;">Engagement Signals</h2>
              <button id="setInterestBtn" class="btn btn-secondary btn-sm" onclick="openInterestLevelModal()">Set Interest</button>
            </div>
            <div id="engagementSignalsContent">
              <div class="signal-item">
                <span class="signal-label" id="interestLevelLabel">Interest Level</span>
                <span class="signal-value" id="signalInterestLevel">-</span>
              </div>
              <div class="signal-item">
                <span class="signal-label">Member Profile</span>
                <span class="signal-value" id="signalMemberProfile">-</span>
              </div>
              <div class="signal-item">
                <span class="signal-label">Dashboard Logins (30d)</span>
                <span class="signal-value" id="signalLoginCount">-</span>
              </div>
              <div class="signal-item">
                <span class="signal-label">Last Login</span>
                <span class="signal-value" id="signalLastLogin">-</span>
              </div>
              <div class="signal-item">
                <span class="signal-label">Working Groups</span>
                <span class="signal-value" id="signalWorkingGroups">-</span>
              </div>
              <div class="signal-item">
                <span class="signal-label">Email Clicks (30d)</span>
                <span class="signal-value" id="signalEmailClicks">-</span>
              </div>
            </div>
          </div>

          <!-- Company Profile (Enrichment Data) -->
          <div class="card" id="companyProfileCard" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
              <h2 style="margin-bottom: 0;">Company Profile</h2>
              <button class="btn btn-secondary btn-sm" onclick="refreshEnrichment()" id="refreshEnrichmentBtn">Refresh</button>
            </div>
            <div id="companyProfileContent">
              <div class="signal-item">
                <span class="signal-label">Industry</span>
                <span class="signal-value" id="profileIndustry">-</span>
              </div>
              <div class="signal-item">
                <span class="signal-label">Sub-Industry</span>
                <span class="signal-value" id="profileSubIndustry">-</span>
              </div>
              <div class="signal-item">
                <span class="signal-label">Revenue</span>
                <span class="signal-value" id="profileRevenue">-</span>
              </div>
              <div class="signal-item">
                <span class="signal-label">Employees</span>
                <span class="signal-value" id="profileEmployees">-</span>
              </div>
              <div class="signal-item">
                <span class="signal-label">Founded</span>
                <span class="signal-value" id="profileFounded">-</span>
              </div>
              <div class="signal-item">
                <span class="signal-label">Location</span>
                <span class="signal-value" id="profileLocation">-</span>
              </div>
              <div class="signal-item" id="profileLinkedInRow" style="display: none;">
                <span class="signal-label">LinkedIn</span>
                <span class="signal-value" id="profileLinkedIn">-</span>
              </div>
            </div>
            <div id="profileDescription" style="margin-top: var(--space-3); font-size: var(--text-sm); color: var(--color-text-secondary); display: none;"></div>
            <div id="profileEnrichedAt" style="margin-top: var(--space-3); font-size: var(--text-xs); color: var(--color-text-muted);"></div>
          </div>

          <!-- Addie Research -->
          <div class="card" id="addieResearchCard" style="display: none;">
            <h2>Addie Research</h2>
            <div id="addieResearchList" class="empty-state">
              No research available
            </div>
          </div>

          <!-- Member Insights -->
          <div class="card" id="memberInsightsCard" style="display: none;">
            <h2>Member Insights</h2>
            <div id="memberInsightsList" class="empty-state">
              No insights yet
            </div>
          </div>

          <!-- Pricing & Discount -->
          <div class="card" id="pricingCard">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
              <h2 style="margin-bottom: 0;">Pricing & Discount</h2>
              <button class="btn btn-secondary btn-sm" onclick="openDiscountModal()" id="manageDiscountBtn">Set Discount</button>
            </div>
            <div id="pricingContent">
              <div class="signal-item">
                <span class="signal-label">Recommended</span>
                <span class="signal-value" id="pricingSuggestedTier">-</span>
              </div>
              <div class="signal-item">
                <span class="signal-label">List Price</span>
                <span class="signal-value" id="pricingListPrice">-</span>
              </div>
              <div id="pricingRationaleRow" class="signal-item" style="display: none;">
                <span class="signal-label">Rationale</span>
                <span class="signal-value" id="pricingRationale" style="font-size: var(--text-sm); color: var(--color-text-muted);">-</span>
              </div>
              <div class="signal-item" id="discountRow" style="display: none;">
                <span class="signal-label">Discount</span>
                <span class="signal-value" id="pricingDiscount">-</span>
              </div>
              <div class="signal-item" id="netPriceRow" style="display: none;">
                <span class="signal-label">Net Price</span>
                <span class="signal-value" id="pricingNetPrice" style="color: var(--color-success-600); font-weight: var(--font-bold);">-</span>
              </div>
              <div class="signal-item" id="promoCodeRow" style="display: none;">
                <span class="signal-label">Promo Code</span>
                <span class="signal-value" id="pricingPromoCode">-</span>
              </div>
            </div>
            <div id="discountDetails" style="margin-top: var(--space-3); padding: var(--space-3); background: var(--color-success-50); border-radius: var(--radius-sm); display: none;">
              <div style="font-size: var(--text-sm);">
                <strong id="discountReasonLabel">Reason:</strong>
                <span id="discountReasonText"></span>
              </div>
              <div style="font-size: var(--text-xs); color: var(--color-text-muted); margin-top: var(--space-1);">
                Granted by <span id="discountGrantedBy"></span> on <span id="discountGrantedAt"></span>
              </div>
            </div>
          </div>

          <!-- Pending Invoices -->
          <div class="card" id="pendingInvoicesCard" style="display: none;">
            <h2>Pending Invoices</h2>
            <div id="pendingInvoicesList" class="empty-state">
              No pending invoices
            </div>
          </div>

          <!-- Next Steps -->
          <div class="card">
            <h2>Pending Next Steps</h2>
            <div id="nextStepsList" class="empty-state">
              No pending next steps
            </div>
            <form id="quickFollowUpForm" class="quick-followup" onsubmit="saveQuickFollowUp(event)">
              <input type="text" id="quickFollowUpText" placeholder="e.g. Talk to Dave Osborne about pricing..." class="quick-followup-input" autocomplete="off">
              <button type="submit" class="btn btn-primary btn-sm" id="quickFollowUpBtn">Add</button>
            </form>
          </div>

          <!-- Team Members -->
          <div class="card">
            <h2>Team Members <span id="memberCount" style="font-weight: normal; color: var(--color-text-muted);"></span></h2>
            <ul id="membersList" class="members-list">
              <li class="empty-state">No members yet</li>
            </ul>
          </div>

          <!-- Working Groups -->
          <div class="card">
            <h2>Working Groups</h2>
            <div id="workingGroupsList" class="empty-state">
              Not in any working groups
            </div>
          </div>

          <!-- Linked Domains -->
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
              <h2 style="margin-bottom: 0;">Linked Domains</h2>
              <button class="btn btn-secondary btn-sm" onclick="openAddDomainModal()">+ Add Domain</button>
            </div>
            <div id="domainsList" class="empty-state">
              No domains linked
            </div>
          </div>
        </div>

        <!-- Right Column - Activity Timeline -->
        <div>
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
              <h2 style="margin-bottom: 0;">Activity Timeline</h2>
              <button class="btn btn-secondary btn-sm" onclick="openLogActivityModal()">+ Log Activity</button>
            </div>
            <div id="activityTimeline" class="timeline">
              <div class="empty-state">No activities logged yet</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Organization Modal -->
  <div id="editOrgModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>Edit Organization</h2>
        <button class="modal-close" onclick="closeEditOrgModal()">&times;</button>
      </div>
      <form id="editOrgForm" onsubmit="saveOrgChanges(event)">
        <div class="form-group">
          <label>Organization Name</label>
          <input type="text" id="editOrgName" placeholder="e.g., LinkedIn">
        </div>

        <div class="form-group">
          <label>Parent Organization</label>
          <select id="editParentOrg">
            <option value="">None (independent)</option>
          </select>
          <div class="form-hint">If this is a subsidiary or division, select the parent company.</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Status</label>
            <select id="editOrgStatus" onchange="toggleDisqualificationReason()">
              <option value="prospect">Prospect</option>
              <option value="signed_up">Signed Up</option>
              <option value="contacted">Contacted</option>
              <option value="responded">Responded</option>
              <option value="interested">Interested</option>
              <option value="negotiating">Negotiating</option>
              <option value="converted">Converted</option>
              <option value="declined">Declined</option>
              <option value="disqualified">Disqualified</option>
            </select>
          </div>
          <div class="form-group">
            <label>Owner</label>
            <select id="editOrgOwner">
              <option value="">Not assigned</option>
            </select>
          </div>
        </div>

        <div id="disqualificationReasonGroup" class="form-group" style="display: none;">
          <label>Disqualification Reason</label>
          <input type="text" id="editDisqualificationReason" placeholder="e.g., This is us, Competitor, Not in target market">
          <div class="form-hint">Explain why this org should not be contacted.</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Company Types</label>
            <div class="checkbox-group" id="editOrgTypes">
              <label class="checkbox-label">
                <input type="checkbox" name="company_type" value="brand"> Brand
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="company_type" value="publisher"> Publisher
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="company_type" value="agency"> Agency
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="company_type" value="adtech"> Ad Tech
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="company_type" value="data"> Data & Measurement
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="company_type" value="ai"> AI & Tech Platforms
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="company_type" value="other"> Other
              </label>
            </div>
            <div class="form-hint">Select all that apply.</div>
          </div>
          <div class="form-group">
            <label>Source</label>
            <select id="editOrgSource">
              <option value="">Not specified</option>
              <option value="aao_launch_list">AAO Launch List</option>
              <option value="slack">Slack</option>
              <option value="referral">Referral</option>
              <option value="inbound">Inbound</option>
              <option value="organic">Organic</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Revenue Tier</label>
          <select id="editRevenueTier">
            <option value="">Unknown</option>
            <option value="under_1m">Under $1M (Startup)</option>
            <option value="1m_5m">$1M - $5M</option>
            <option value="5m_50m">$5M - $50M</option>
            <option value="50m_250m">$50M - $250M</option>
            <option value="250m_1b">$250M - $1B</option>
            <option value="1b_plus">Over $1B (Enterprise)</option>
          </select>
          <div class="form-hint">Used to determine membership pricing tier.</div>
        </div>

        <h3 style="margin-top: var(--space-5); margin-bottom: var(--space-4); font-size: var(--text-base);">Contact Info</h3>

        <div class="form-row">
          <div class="form-group">
            <label>Contact Name</label>
            <input type="text" id="editContactName">
          </div>
          <div class="form-group">
            <label>Contact Email</label>
            <input type="email" id="editContactEmail">
          </div>
        </div>

        <div class="form-group">
          <label>Contact Title</label>
          <input type="text" id="editContactTitle" placeholder="e.g., VP Engineering">
        </div>

        <h3 style="margin-top: var(--space-5); margin-bottom: var(--space-4); font-size: var(--text-base);">Follow-up</h3>

        <div class="form-row">
          <div class="form-group">
            <label>Next Action</label>
            <input type="text" id="editNextAction" placeholder="e.g., Send follow-up email">
          </div>
          <div class="form-group">
            <label>Next Action Date</label>
            <input type="date" id="editNextActionDate">
          </div>
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea id="editOrgNotes" placeholder="Any relevant notes about this organization..."></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeEditOrgModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="saveOrgBtn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Log Activity Modal -->
  <div id="activityModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="activityModalTitle">Log Activity</h2>
        <button class="modal-close" onclick="closeActivityModal()">&times;</button>
      </div>
      <form id="activityForm" onsubmit="saveActivity(event)">
        <div class="form-group">
          <label>Activity Type *</label>
          <select id="activityType" required>
            <option value="">Select type...</option>
            <option value="call">Call</option>
            <option value="email">Email</option>
            <option value="meeting">Meeting</option>
            <option value="slack_dm">Slack DM</option>
            <option value="event">Event</option>
            <option value="referral">Referral</option>
            <option value="invoice_requested">Invoice Requested</option>
            <option value="note">Note</option>
          </select>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea id="activityDescription" placeholder="What happened?"></textarea>
        </div>

        <div class="form-group">
          <label>Date</label>
          <input type="datetime-local" id="activityDate">
          <div class="form-hint">Leave blank for now</div>
        </div>

        <div id="nextStepFields" style="display: none; margin-top: var(--space-4); padding-top: var(--space-4); border-top: var(--border-1) solid var(--color-gray-200);">
          <h3 style="font-size: var(--text-base); margin-bottom: var(--space-4);">Next Step</h3>

          <div class="form-row">
            <div class="form-group">
              <label>Due Date</label>
              <input type="date" id="nextStepDueDate">
            </div>
            <div class="form-group">
              <label>Owner</label>
              <select id="nextStepOwner">
                <option value="">Not assigned</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="isNextStep" onchange="toggleNextStepFields()">
            This creates a follow-up task
          </label>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeActivityModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="saveActivityBtn">Save Activity</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Interest Level Modal -->
  <div id="interestLevelModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h2 id="interestModalTitle">Set Interest Level</h2>
        <button class="modal-close" onclick="closeInterestLevelModal()">&times;</button>
      </div>
      <form id="interestLevelForm" onsubmit="saveInterestLevel(event)">
        <div class="form-group">
          <label id="interestModalLabel">Interest Level</label>
          <select id="interestLevelSelect">
            <option value="">Not set</option>
            <option value="low">Low - Not a good fit / not interested</option>
            <option value="medium">Medium - Lukewarm / maybe later</option>
            <option value="high">High - Interested / actively engaged</option>
            <option value="very_high">Very High - Ready to move forward</option>
          </select>
        </div>

        <div class="form-group">
          <label>Note (optional)</label>
          <textarea id="interestLevelNote" placeholder="e.g., Per conversation with CEO on 12/28..." rows="3"></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeInterestLevelModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Domain Modal -->
  <div id="addDomainModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h2>Add Domain</h2>
        <button class="modal-close" onclick="closeAddDomainModal()">&times;</button>
      </div>
      <form id="addDomainForm" onsubmit="addDomain(event)">
        <div class="form-group">
          <label>Domain *</label>
          <input type="text" id="domainInput" placeholder="e.g., acme.com" required pattern="^[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?)+$">
          <div class="form-hint">Enter the domain without http:// or www.</div>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="domainIsPrimary">
            Set as primary domain
          </label>
          <div class="form-hint">Primary domain is used for enrichment lookups.</div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeAddDomainModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="addDomainBtn">Add Domain</button>
        </div>
      </form>
    </div>
  </div>

  <!-- User Context Modal -->
  <div id="userContextModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 id="userContextModalTitle">Member Context</h2>
        <button class="modal-close" onclick="closeUserContextModal()">&times;</button>
      </div>
      <div id="userContextModalBody" style="padding: var(--space-4);">
        <!-- Content populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Payment Link Modal -->
  <div id="paymentLinkModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2>Generate Payment Link</h2>
        <button class="modal-close" onclick="closePaymentLinkModal()">&times;</button>
      </div>

      <p id="paymentLinkOrgName" style="margin-bottom: var(--space-4); color: var(--color-text-secondary);"></p>

      <!-- Discount notice -->
      <div id="paymentLinkDiscountNotice" style="display: none; margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-success-50); border-radius: var(--radius-sm);">
        <div style="font-size: var(--text-sm);">
          <strong style="color: var(--color-success-700);">Discount will be applied:</strong>
          <span id="paymentLinkDiscountText"></span>
        </div>
        <div style="margin-top: var(--space-2);">
          <label style="font-size: var(--text-sm);">
            <input type="checkbox" id="applyDiscountToPaymentLink" checked>
            Include discount in payment link
          </label>
        </div>
      </div>

      <div id="paymentLinkProducts" style="margin-bottom: var(--space-4);">
        Loading products...
      </div>

      <div id="paymentLinkResult" style="display: none;">
        <div style="background: var(--color-success-50); border: 1px solid var(--color-success-200); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">
          <strong style="color: var(--color-success-700);">Payment Link Generated!</strong>
          <p style="margin: var(--space-2) 0 0; font-size: var(--text-sm); color: var(--color-text-secondary);">
            Copy this link and send it to the prospect:
          </p>
        </div>
        <div style="display: flex; gap: var(--space-2);">
          <input type="text" id="paymentLinkUrl" readonly style="flex: 1; padding: var(--space-2); font-size: var(--text-sm); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
          <button class="btn btn-primary btn-sm" onclick="copyPaymentLink()">Copy</button>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closePaymentLinkModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Generate Invoice Modal -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>Generate Invoice</h2>
        <button class="modal-close" onclick="closeInvoiceModal()">&times;</button>
      </div>

      <p id="invoiceOrgName" style="margin-bottom: var(--space-4); color: var(--color-text-secondary);"></p>

      <form id="invoiceForm" onsubmit="submitInvoice(event)">
        <!-- Product Selection -->
        <div id="invoiceProductSection">
          <div class="form-group">
            <label>Select Product</label>
            <div id="invoiceProducts" style="margin-bottom: var(--space-4);">
              Loading products...
            </div>
          </div>
        </div>

        <!-- Billing Details (shown after product selection) -->
        <div id="invoiceBillingSection" style="display: none;">
          <div class="form-group">
            <label>Selected Product</label>
            <div id="selectedProductDisplay" style="padding: var(--space-2); background: var(--color-gray-50); border-radius: var(--radius-md); margin-bottom: var(--space-3);"></div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Contact Name *</label>
              <input type="text" id="invoiceContactName" required>
            </div>
            <div class="form-group">
              <label>Contact Email *</label>
              <input type="email" id="invoiceContactEmail" required>
            </div>
          </div>

          <div class="form-group">
            <label>Company Name *</label>
            <input type="text" id="invoiceCompanyName" required>
          </div>

          <h4 style="margin-top: var(--space-4); margin-bottom: var(--space-3); font-size: var(--text-sm); color: var(--color-text-heading);">Billing Address</h4>

          <div class="form-group">
            <label>Street Address *</label>
            <input type="text" id="invoiceAddressLine1" required>
          </div>

          <div class="form-group">
            <label>Address Line 2</label>
            <input type="text" id="invoiceAddressLine2">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>City *</label>
              <input type="text" id="invoiceCity" required>
            </div>
            <div class="form-group">
              <label>State/Province *</label>
              <input type="text" id="invoiceState" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Postal Code *</label>
              <input type="text" id="invoicePostalCode" required>
            </div>
            <div class="form-group">
              <label>Country *</label>
              <input type="text" id="invoiceCountry" value="US" required>
            </div>
          </div>
        </div>

        <!-- Draft Review Section (shown after billing details, before sending) -->
        <div id="invoiceDraftReview" style="display: none;">
          <div style="background: var(--color-info-50); border: 1px solid var(--color-info-200); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">
            <strong style="color: var(--color-info-700);">Review Invoice Draft</strong>
            <p style="margin: var(--space-2) 0 0; font-size: var(--text-sm); color: var(--color-text-secondary);">
              Please review all details before sending. The invoice will be emailed to the contact.
            </p>
          </div>

          <div id="draftReviewContent" style="background: var(--color-bg-subtle); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">
            <!-- Populated by JavaScript -->
          </div>

          <div id="draftMissingFields" style="display: none; background: var(--color-warning-50); border: 1px solid var(--color-warning-200); border-radius: var(--radius-md); padding: var(--space-3); margin-bottom: var(--space-4);">
            <strong style="color: var(--color-warning-700); font-size: var(--text-sm);">Missing Information</strong>
            <ul id="missingFieldsList" style="margin: var(--space-2) 0 0; padding-left: var(--space-4); font-size: var(--text-sm); color: var(--color-warning-700);"></ul>
          </div>
        </div>

        <!-- Success Message -->
        <div id="invoiceResult" style="display: none;">
          <div style="background: var(--color-success-50); border: 1px solid var(--color-success-200); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">
            <strong style="color: var(--color-success-700);">Invoice Sent!</strong>
            <p style="margin: var(--space-2) 0 0; font-size: var(--text-sm); color: var(--color-text-secondary);">
              The invoice has been emailed to the contact. You can also share this link:
            </p>
          </div>
          <div style="display: flex; gap: var(--space-2);">
            <input type="text" id="invoiceUrl" readonly style="flex: 1; padding: var(--space-2); font-size: var(--text-sm); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
            <button type="button" class="btn btn-primary btn-sm" onclick="copyInvoiceLink()">Copy</button>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeInvoiceModal()">Close</button>
          <button type="button" class="btn btn-secondary" id="backToEditBtn" style="display: none;" onclick="backToEditInvoice()">Edit Details</button>
          <button type="button" class="btn btn-primary" id="prepareDraftBtn" style="display: none;" onclick="prepareDraft()">Prepare Draft</button>
          <button type="submit" class="btn btn-primary" id="sendInvoiceBtn" style="display: none;">Send Invoice</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Discount Modal -->
  <div id="discountModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 id="discountModalTitle">Set Discount</h2>
        <button class="modal-close" onclick="closeDiscountModal()">&times;</button>
      </div>

      <form id="discountForm" onsubmit="saveDiscount(event)">
        <div class="form-group">
          <label>Discount Type</label>
          <select id="discountType" onchange="toggleDiscountInputs()">
            <option value="percent">Percentage</option>
            <option value="amount">Fixed Amount</option>
          </select>
        </div>

        <div class="form-group" id="discountPercentGroup">
          <label>Discount Percentage *</label>
          <input type="number" id="discountPercent" min="1" max="100" placeholder="e.g., 20">
          <div class="form-hint">Enter a value between 1 and 100</div>
        </div>

        <div class="form-group" id="discountAmountGroup" style="display: none;">
          <label>Discount Amount (USD) *</label>
          <input type="number" id="discountAmount" min="1" step="1" placeholder="e.g., 500">
          <div class="form-hint">Enter the discount amount in dollars</div>
        </div>

        <div class="form-group">
          <label>Reason *</label>
          <select id="discountReasonSelect" onchange="toggleCustomReason()">
            <option value="">Select a reason...</option>
            <option value="startup">Startup / Early Stage</option>
            <option value="nonprofit">Nonprofit Organization</option>
            <option value="early_adopter">Early Adopter</option>
            <option value="strategic">Strategic Partner</option>
            <option value="volume">Multi-Year / Volume</option>
            <option value="custom">Other (custom reason)</option>
          </select>
        </div>

        <div class="form-group" id="customReasonGroup" style="display: none;">
          <label>Custom Reason *</label>
          <input type="text" id="discountCustomReason" placeholder="e.g., Referred by existing member">
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="createStripeCoupon" checked>
            Create Stripe coupon & promo code
          </label>
          <div class="form-hint">Generates a unique promo code the prospect can use at checkout</div>
        </div>

        <div id="currentDiscountInfo" style="display: none; margin-top: var(--space-4); padding: var(--space-3); background: var(--color-warning-50); border-radius: var(--radius-sm);">
          <div style="font-size: var(--text-sm); font-weight: var(--font-semibold); color: var(--color-warning-700);">Current Discount</div>
          <div style="font-size: var(--text-sm); margin-top: var(--space-1);" id="currentDiscountText"></div>
          <button type="button" class="btn btn-sm btn-danger" style="margin-top: var(--space-2);" onclick="removeDiscount()">Remove Discount</button>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeDiscountModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="saveDiscountBtn">Save Discount</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let orgData = null;
    let stakeholders = [];
    let domainsData = null;
    let currentUserId = null;
    let teamMembers = [];
    let productsData = []; // Store products for pricing calculations
    const orgId = window.location.pathname.split('/').pop();

    async function loadOrganization() {
      try {
        // Load org data, stakeholders, domains, and team members in parallel
        const [orgResponse, stakeholdersResponse, domainsResponse, teamResponse] = await Promise.all([
          fetch(`/api/admin/organizations/${orgId}`),
          fetch(`/api/admin/organizations/${orgId}/stakeholders`),
          fetch(`/api/admin/organizations/${orgId}/domains`),
          fetch('/api/admin/team')
        ]);

        if (!orgResponse.ok) {
          if (orgResponse.status === 401) {
            window.AdminSidebar.redirectToLogin();
            return;
          }
          if (orgResponse.status === 404) {
            document.getElementById('loading').innerHTML =
              '<p style="color: var(--color-error-600);">Organization not found. <a href="/admin/prospects">Back to prospects</a></p>';
            return;
          }
          throw new Error('Failed to load organization');
        }

        orgData = await orgResponse.json();
        stakeholders = stakeholdersResponse.ok ? await stakeholdersResponse.json() : [];
        domainsData = domainsResponse.ok ? await domainsResponse.json() : { domains: [], workos_domains: [] };
        teamMembers = teamResponse.ok ? await teamResponse.json() : [];

        renderOrganization();
        renderOwnerSelector();
        populateOwnerDropdowns();
        renderDomains();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch (error) {
        console.error('Error loading organization:', error);
        document.getElementById('loading').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load organization. <a href="/auth/login">Try logging in again</a></p>';
      }
    }

    function renderOrganization() {
      // Breadcrumb and title
      document.getElementById('breadcrumbName').textContent = orgData.name;
      document.getElementById('orgName').textContent = orgData.name;
      document.title = `${orgData.name} - AdCP Registry`;

      // Check if this is a paying member
      const isPayingMember = orgData.subscription_status === 'active' || orgData.subscription_status === 'trialing';

      // Engagement indicator - different for members vs prospects
      const engagementLevel = orgData.engagement_level || 1;
      let engagementIndicator;
      if (isPayingMember) {
        // For members: stars represent engagement/happiness
        engagementIndicator = 'â­'.repeat(engagementLevel);
      } else {
        // For prospects: fires represent sales heat
        engagementIndicator = 'ðŸ”¥'.repeat(engagementLevel);
      }
      document.getElementById('engagementFires').textContent = engagementIndicator;
      document.getElementById('engagementReasons').textContent =
        orgData.engagement_reasons?.join(' â€¢ ') || (isPayingMember ? 'New member' : 'Cold');

      // Render engagement signals with context-appropriate title
      renderEngagementSignals(orgData.engagement_signals, isPayingMember);

      // Status - show "Member" prominently for paying customers
      const status = orgData.prospect_status || 'prospect';
      let statusHtml = '';
      if (isPayingMember) {
        statusHtml = `<span class="status-badge status-member">Member</span>`;
        if (orgData.subscription_product_name) {
          statusHtml += ` <span style="font-size: var(--text-xs); color: var(--color-text-muted);">${escapeHtml(orgData.subscription_product_name)}</span>`;
        }
      } else {
        statusHtml = `<span class="status-badge status-${status}">${status.replace('_', ' ')}</span>`;
        if (status === 'disqualified' && orgData.disqualification_reason) {
          statusHtml += `<br><span style="font-size: var(--text-xs); color: var(--color-text-muted);">${escapeHtml(orgData.disqualification_reason)}</span>`;
        }
      }
      document.getElementById('orgStatus').innerHTML = statusHtml;

      // Source
      const sourceLabels = {
        'aao_launch_list': 'AAO Launch List',
        'slack': 'Slack',
        'referral': 'Referral',
        'inbound': 'Inbound',
        'organic': 'Organic'
      };
      document.getElementById('orgSource').textContent =
        sourceLabels[orgData.prospect_source] || orgData.prospect_source || '-';

      // Type(s) - uses shared config from /js/company-types.js
      const types = orgData.company_types || (orgData.company_type ? [orgData.company_type] : []);
      document.getElementById('orgType').textContent = formatCompanyTypes(types);

      // Parent organization
      const parentRow = document.getElementById('parentOrgRow');
      const parentEl = document.getElementById('orgParent');
      if (orgData.parent_organization_id && orgData.parent_name) {
        parentRow.style.display = '';
        parentEl.innerHTML = `<a href="/admin/org/${orgData.parent_organization_id}">${escapeHtml(orgData.parent_name)}</a>`;
      } else if (orgData.parent_organization_id) {
        parentRow.style.display = '';
        parentEl.innerHTML = `<a href="/admin/org/${orgData.parent_organization_id}">${orgData.parent_organization_id}</a>`;
      } else {
        parentRow.style.display = 'none';
      }

      // Owner is now handled by renderOwnerSelector()

      // Contact
      let contactHtml = '-';
      if (orgData.prospect_contact_name || orgData.prospect_contact_email) {
        contactHtml = '';
        if (orgData.prospect_contact_name) {
          contactHtml += orgData.prospect_contact_name;
          if (orgData.prospect_contact_title) {
            contactHtml += ` <span style="color: var(--color-text-muted);">(${orgData.prospect_contact_title})</span>`;
          }
        }
        if (orgData.prospect_contact_email) {
          contactHtml += `<br><a href="mailto:${orgData.prospect_contact_email}">${orgData.prospect_contact_email}</a>`;
        }
      }
      document.getElementById('orgContact').innerHTML = contactHtml;

      // Dates
      document.getElementById('orgCreated').textContent =
        orgData.created_at ? new Date(orgData.created_at).toLocaleDateString() : '-';
      document.getElementById('orgLastActivity').textContent =
        orgData.last_activity_at ? new Date(orgData.last_activity_at).toLocaleDateString() : '-';

      // Invoice requested
      if (orgData.invoice_requested_at) {
        document.getElementById('invoiceRequestedRow').style.display = 'flex';
        document.getElementById('orgInvoiceRequested').textContent =
          new Date(orgData.invoice_requested_at).toLocaleDateString();
      }

      // Notes
      if (orgData.prospect_notes) {
        document.getElementById('orgNotes').style.display = 'block';
        document.getElementById('orgNotesText').textContent = orgData.prospect_notes;
      }

      // Members
      renderMembers();

      // Working groups
      renderWorkingGroups();

      // Activities
      renderActivities();

      // Next steps
      renderNextSteps();

      // Pending invoices
      renderPendingInvoices();

      // Company profile (enrichment data)
      renderCompanyProfile();

      // Pricing & discount
      loadPricingData();

      // Addie research
      loadAddieResearch();

      // Member insights
      loadMemberInsights();
    }

    function renderMembers() {
      const list = document.getElementById('membersList');
      const count = document.getElementById('memberCount');

      if (!orgData.members || orgData.members.length === 0) {
        list.innerHTML = '<li class="empty-state">No members yet</li>';
        count.textContent = '';
        return;
      }

      count.textContent = `(${orgData.members.length})`;
      list.innerHTML = orgData.members.map(member => {
        const name = [member.firstName, member.lastName].filter(Boolean).join(' ') || member.email;
        const escapedName = escapeHtml(name);
        const escapedNameJs = escapeJs(name);
        const escapedEmail = escapeHtml(member.email);
        const memberId = member.id;
        return `
          <li>
            ${memberId
              ? `<a href="#" class="member-name-link" onclick="showUserContext('${escapeJs(memberId)}', 'workos', '${escapedNameJs}'); return false;">${escapedName}</a>`
              : escapedName}
            <span class="member-role">${escapeHtml(member.role)}</span>
            <br><span style="font-size: var(--text-xs); color: var(--color-text-muted);">${escapedEmail}</span>
          </li>
        `;
      }).join('');
    }

    function renderWorkingGroups() {
      const container = document.getElementById('workingGroupsList');

      if (!orgData.working_groups || orgData.working_groups.length === 0) {
        container.innerHTML = '<div class="empty-state">Not in any working groups</div>';
        return;
      }

      container.innerHTML = orgData.working_groups.map(wg =>
        `<span class="wg-badge">${wg.name}</span>`
      ).join('');
    }

    function renderNextSteps() {
      const container = document.getElementById('nextStepsList');

      if (!orgData.next_steps || orgData.next_steps.length === 0) {
        container.innerHTML = '<div class="empty-state">No pending next steps</div>';
        return;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      container.innerHTML = orgData.next_steps.map(step => {
        const dueDate = step.next_step_due_date ? new Date(step.next_step_due_date) : null;
        const isOverdue = dueDate && dueDate < today;

        return `
          <div class="next-step-item ${isOverdue ? 'overdue' : ''}">
            <div class="next-step-due">
              ${dueDate ? (isOverdue ? 'Overdue: ' : 'Due: ') + dueDate.toLocaleDateString() : 'No due date'}
            </div>
            <div class="next-step-description">${step.description || step.activity_type}</div>
            ${step.next_step_owner_name ? `<div class="next-step-owner">Owner: ${step.next_step_owner_name}</div>` : ''}
            <button class="btn btn-success btn-sm" style="margin-top: var(--space-2);" onclick="completeNextStep(${step.id})">Mark Complete</button>
          </div>
        `;
      }).join('');
    }

    function renderPendingInvoices() {
      const card = document.getElementById('pendingInvoicesCard');
      const container = document.getElementById('pendingInvoicesList');

      // Filter out $0 invoices and sort by largest amount first
      const pendingInvoices = (orgData.pending_invoices || [])
        .filter(inv => inv.amount_due > 0)
        .sort((a, b) => b.amount_due - a.amount_due);

      if (pendingInvoices.length === 0) {
        card.style.display = 'none';
        return;
      }

      card.style.display = 'block';

      // Helper function to format currency
      const formatCurrency = (amountCents, currency) => {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: (currency || 'USD').toUpperCase()
        }).format(amountCents / 100);
      };

      container.innerHTML = pendingInvoices.map(invoice => {
        const createdDate = new Date(invoice.created).toLocaleDateString();
        const dueDate = invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : 'N/A';
        const statusLabel = invoice.status === 'open' ? 'Sent' : 'Draft';

        return `
          <div class="invoice-item" data-invoice-id="${invoice.id}">
            <div class="invoice-info">
              <div class="invoice-product">
                ${invoice.product_name || 'Invoice'}
                <span class="invoice-status ${invoice.status}">${statusLabel}</span>
              </div>
              <div class="invoice-amount">${formatCurrency(invoice.amount_due, invoice.currency)}</div>
              <div class="invoice-meta">
                Created: ${createdDate} &bull; Due: ${dueDate}
                ${invoice.customer_email ? ` &bull; ${invoice.customer_email}` : ''}
              </div>
            </div>
            <div class="invoice-actions">
              ${invoice.hosted_invoice_url ? `
                <a href="${invoice.hosted_invoice_url}" target="_blank" class="btn btn-sm btn-secondary">View Invoice</a>
              ` : ''}
              <button class="btn btn-sm btn-danger" onclick="voidInvoice('${invoice.id}', '${invoice.status}')">
                ${invoice.status === 'draft' ? 'Delete' : 'Void'} Invoice
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function voidInvoice(invoiceId, status) {
      const action = status === 'draft' ? 'delete' : 'void';
      if (!confirm(`Are you sure you want to ${action} this invoice? This cannot be undone.`)) {
        return;
      }

      try {
        let response;
        if (status === 'draft') {
          response = await fetch(`/api/admin/invoices/${invoiceId}`, {
            method: 'DELETE'
          });
        } else {
          response = await fetch(`/api/admin/invoices/${invoiceId}/void`, {
            method: 'POST'
          });
        }

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar.redirectToLogin();
            return;
          }
          const data = await response.json();
          throw new Error(data.message || `Failed to ${action} invoice`);
        }

        // Remove the invoice from the list
        const invoiceEl = document.querySelector(`[data-invoice-id="${invoiceId}"]`);
        if (invoiceEl) {
          invoiceEl.remove();
        }

        // Check if there are any remaining invoices
        const remaining = document.querySelectorAll('.invoice-item');
        if (remaining.length === 0) {
          document.getElementById('pendingInvoicesCard').style.display = 'none';
        }

        alert(`Invoice ${action === 'void' ? 'voided' : 'deleted'} successfully`);
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function renderActivities() {
      const container = document.getElementById('activityTimeline');

      if (!orgData.activities || orgData.activities.length === 0) {
        container.innerHTML = '<div class="empty-state">No activities logged yet</div>';
        return;
      }

      const typeLabels = {
        'call': 'Call',
        'email': 'Email',
        'meeting': 'Meeting',
        'slack_dm': 'Slack DM',
        'event': 'Event',
        'note': 'Note',
        'invoice_requested': 'Invoice Requested',
        'referral': 'Referral'
      };

      container.innerHTML = orgData.activities.map(activity => {
        const date = new Date(activity.activity_date);
        const isNextStep = activity.is_next_step && !activity.next_step_completed_at;
        const isCompleted = activity.next_step_completed_at;

        return `
          <div class="timeline-item ${isNextStep ? 'is-next-step' : ''} ${isCompleted ? 'completed' : ''}">
            <div class="timeline-date">${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            <div class="timeline-type">${typeLabels[activity.activity_type] || activity.activity_type}</div>
            ${activity.description ? `<div class="timeline-description">${activity.description}</div>` : ''}
            <div class="timeline-meta">
              ${activity.logged_by_name ? `Logged by ${activity.logged_by_name}` : ''}
              ${activity.is_next_step ? ` â€¢ ${activity.next_step_completed_at ? 'Completed' : 'Pending follow-up'}` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // =========================================================================
    // Company Profile (Enrichment Data)
    // =========================================================================

    function renderCompanyProfile() {
      const card = document.getElementById('companyProfileCard');

      // Check if we have any enrichment data
      const hasEnrichment = orgData.enrichment_industry ||
                           orgData.enrichment_revenue ||
                           orgData.enrichment_employee_count ||
                           orgData.enrichment_at;

      if (!hasEnrichment) {
        card.style.display = 'none';
        return;
      }

      card.style.display = 'block';

      // Industry
      document.getElementById('profileIndustry').textContent =
        orgData.enrichment_industry || '-';

      // Sub-industry
      const subIndustryEl = document.getElementById('profileSubIndustry');
      if (orgData.enrichment_sub_industry) {
        subIndustryEl.textContent = orgData.enrichment_sub_industry;
        subIndustryEl.parentElement.style.display = 'flex';
      } else {
        subIndustryEl.parentElement.style.display = 'none';
      }

      // Revenue
      let revenueText = '-';
      if (orgData.enrichment_revenue_range) {
        revenueText = orgData.enrichment_revenue_range;
      } else if (orgData.enrichment_revenue) {
        revenueText = formatCurrency(orgData.enrichment_revenue);
      }
      document.getElementById('profileRevenue').textContent = revenueText;

      // Employees
      let employeeText = '-';
      if (orgData.enrichment_employee_count_range) {
        employeeText = orgData.enrichment_employee_count_range;
      } else if (orgData.enrichment_employee_count) {
        employeeText = orgData.enrichment_employee_count.toLocaleString();
      }
      document.getElementById('profileEmployees').textContent = employeeText;

      // Founded
      document.getElementById('profileFounded').textContent =
        orgData.enrichment_founded_year || '-';

      // Location
      const location = [orgData.enrichment_city, orgData.enrichment_country]
        .filter(Boolean).join(', ');
      document.getElementById('profileLocation').textContent = location || '-';

      // LinkedIn
      const linkedInRow = document.getElementById('profileLinkedInRow');
      if (orgData.enrichment_linkedin_url) {
        linkedInRow.style.display = 'flex';
        document.getElementById('profileLinkedIn').innerHTML =
          `<a href="${escapeHtml(orgData.enrichment_linkedin_url)}" target="_blank" style="color: var(--color-brand);">View Profile</a>`;
      } else {
        linkedInRow.style.display = 'none';
      }

      // Description
      const descEl = document.getElementById('profileDescription');
      if (orgData.enrichment_description) {
        descEl.style.display = 'block';
        descEl.textContent = orgData.enrichment_description;
      } else {
        descEl.style.display = 'none';
      }

      // Enriched at
      const enrichedAtEl = document.getElementById('profileEnrichedAt');
      if (orgData.enrichment_at) {
        const enrichedDate = new Date(orgData.enrichment_at);
        enrichedAtEl.textContent = `Data from ${orgData.enrichment_source || 'enrichment'} â€¢ Updated ${enrichedDate.toLocaleDateString()}`;
      }
    }

    function formatCurrency(amount) {
      if (!amount) return '-';
      if (amount >= 1000000000) {
        return '$' + (amount / 1000000000).toFixed(1) + 'B';
      } else if (amount >= 1000000) {
        return '$' + (amount / 1000000).toFixed(1) + 'M';
      } else if (amount >= 1000) {
        return '$' + (amount / 1000).toFixed(0) + 'K';
      }
      return '$' + amount.toLocaleString();
    }

    async function refreshEnrichment() {
      const btn = document.getElementById('refreshEnrichmentBtn');
      btn.disabled = true;
      btn.textContent = 'Refreshing...';

      try {
        const response = await fetch(`/api/admin/organizations/${orgId}/enrich`, {
          method: 'POST'
        });

        if (!response.ok) {
          throw new Error('Failed to refresh enrichment');
        }

        // Reload the page to show updated data
        loadOrganization();
      } catch (error) {
        alert('Error refreshing enrichment: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Refresh';
      }
    }

    // =========================================================================
    // Addie Research
    // =========================================================================

    async function loadAddieResearch() {
      const card = document.getElementById('addieResearchCard');
      const container = document.getElementById('addieResearchList');

      try {
        const response = await fetch(`/api/admin/organizations/${orgId}/addie-research`);

        if (!response.ok) {
          if (response.status === 404) {
            // No endpoint yet, hide the card
            card.style.display = 'none';
            return;
          }
          throw new Error('Failed to load Addie research');
        }

        const data = await response.json();

        if (!data.interactions || data.interactions.length === 0) {
          card.style.display = 'none';
          return;
        }

        card.style.display = 'block';
        container.innerHTML = data.interactions.map(interaction => {
          const date = new Date(interaction.created_at);
          return `
            <div class="research-item" style="padding: var(--space-3) 0; border-bottom: var(--border-1) solid var(--color-gray-100);">
              <div style="font-size: var(--text-xs); color: var(--color-text-muted); margin-bottom: var(--space-1);">
                ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                ${interaction.user_name ? ` â€¢ Conversation with ${escapeHtml(interaction.user_name)}` : ''}
              </div>
              <div style="font-size: var(--text-sm);">
                ${escapeHtml(interaction.summary || interaction.output_text?.substring(0, 200) || 'No summary')}
                ${interaction.output_text?.length > 200 ? '...' : ''}
              </div>
              ${interaction.tools_used?.length > 0 ? `
                <div style="font-size: var(--text-xs); color: var(--color-text-muted); margin-top: var(--space-1);">
                  Tools: ${interaction.tools_used.join(', ')}
                </div>
              ` : ''}
            </div>
          `;
        }).join('');

        // Remove last border
        const lastItem = container.querySelector('.research-item:last-child');
        if (lastItem) {
          lastItem.style.borderBottom = 'none';
        }

      } catch (error) {
        console.error('Error loading Addie research:', error);
        card.style.display = 'none';
      }
    }

    // =========================================================================
    // Member Insights
    // =========================================================================

    async function loadMemberInsights() {
      const card = document.getElementById('memberInsightsCard');
      const container = document.getElementById('memberInsightsList');

      try {
        const response = await fetch(`/api/admin/organizations/${orgId}/member-insights`);

        if (!response.ok) {
          if (response.status === 404) {
            // No endpoint yet, hide the card
            card.style.display = 'none';
            return;
          }
          throw new Error('Failed to load member insights');
        }

        const data = await response.json();

        if (!data.insights || data.insights.length === 0) {
          card.style.display = 'none';
          return;
        }

        card.style.display = 'block';

        // Group insights by member
        const byMember = {};
        data.insights.forEach(insight => {
          const key = insight.member_name || insight.slack_user_id || 'Unknown';
          if (!byMember[key]) {
            byMember[key] = [];
          }
          byMember[key].push(insight);
        });

        container.innerHTML = Object.entries(byMember).map(([member, insights]) => `
          <div style="margin-bottom: var(--space-4);">
            <div style="font-weight: var(--font-semibold); margin-bottom: var(--space-2);">${escapeHtml(member)}</div>
            ${insights.map(insight => `
              <div style="display: flex; gap: var(--space-2); padding: var(--space-1) 0; font-size: var(--text-sm);">
                <span style="background: var(--color-primary-100); color: var(--color-primary-700); padding: var(--space-0.5) var(--space-1.5); border-radius: var(--radius-sm); font-size: var(--text-xs); font-weight: var(--font-medium);">
                  ${escapeHtml(insight.insight_type)}
                </span>
                <span>${escapeHtml(insight.value)}</span>
                ${insight.confidence ? `
                  <span style="font-size: var(--text-xs); color: var(--color-text-muted);">
                    (${insight.confidence})
                  </span>
                ` : ''}
              </div>
            `).join('')}
          </div>
        `).join('');

      } catch (error) {
        console.error('Error loading member insights:', error);
        card.style.display = 'none';
      }
    }

    // Edit Organization Modal functions
    async function openEditOrgModal() {
      // Populate form with current values
      document.getElementById('editOrgName').value = orgData.name || '';
      document.getElementById('editOrgStatus').value = orgData.prospect_status || 'prospect';
      document.getElementById('editOrgOwner').value = orgData.prospect_owner || '';
      document.getElementById('editOrgSource').value = orgData.prospect_source || '';
      document.getElementById('editContactName').value = orgData.prospect_contact_name || '';
      document.getElementById('editContactEmail').value = orgData.prospect_contact_email || '';
      document.getElementById('editContactTitle').value = orgData.prospect_contact_title || '';
      document.getElementById('editNextAction').value = orgData.prospect_next_action || '';
      document.getElementById('editNextActionDate').value = orgData.prospect_next_action_date ? orgData.prospect_next_action_date.split('T')[0] : '';
      document.getElementById('editOrgNotes').value = orgData.prospect_notes || '';
      document.getElementById('editDisqualificationReason').value = orgData.disqualification_reason || '';

      // Populate company types checkboxes
      const types = orgData.company_types || (orgData.company_type ? [orgData.company_type] : []);
      const checkboxes = document.querySelectorAll('#editOrgTypes input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.checked = types.includes(cb.value);
      });

      // Populate revenue tier
      document.getElementById('editRevenueTier').value = orgData.revenue_tier || '';

      // Load parent organization options
      await loadParentOrgOptions();

      // Show/hide disqualification reason based on status
      toggleDisqualificationReason();

      document.getElementById('editOrgModal').style.display = 'block';
    }

    async function loadParentOrgOptions() {
      const select = document.getElementById('editParentOrg');
      // Keep the "None" option
      select.innerHTML = '<option value="">None (independent)</option>';

      try {
        // Fetch organizations that could be parents (exclude current org)
        const response = await fetch('/api/admin/prospects?limit=200');
        if (!response.ok) return;

        const data = await response.json();
        const orgs = data.prospects || [];

        // Sort by name and add as options
        orgs
          .filter(o => o.workos_organization_id !== orgId) // Exclude self
          .sort((a, b) => a.name.localeCompare(b.name))
          .forEach(org => {
            const option = document.createElement('option');
            option.value = org.workos_organization_id;
            option.textContent = org.name;
            if (org.workos_organization_id === orgData.parent_organization_id) {
              option.selected = true;
            }
            select.appendChild(option);
          });
      } catch (error) {
        console.error('Error loading parent org options:', error);
      }
    }

    function toggleDisqualificationReason() {
      const status = document.getElementById('editOrgStatus').value;
      const group = document.getElementById('disqualificationReasonGroup');
      group.style.display = status === 'disqualified' ? 'block' : 'none';
    }

    function closeEditOrgModal() {
      document.getElementById('editOrgModal').style.display = 'none';
    }

    function openRevenueTierModal() {
      // Open the edit modal and focus on revenue tier field
      openEditOrgModal().then(() => {
        document.getElementById('editRevenueTier').focus();
      });
    }

    async function saveOrgChanges(event) {
      event.preventDefault();

      const status = document.getElementById('editOrgStatus').value;

      // Collect selected company types from checkboxes
      const selectedTypes = Array.from(document.querySelectorAll('#editOrgTypes input[type="checkbox"]:checked'))
        .map(cb => cb.value);

      const data = {
        name: document.getElementById('editOrgName').value || null,
        parent_organization_id: document.getElementById('editParentOrg').value || null,
        prospect_status: status,
        prospect_owner: document.getElementById('editOrgOwner').value || null,
        company_types: selectedTypes.length > 0 ? selectedTypes : null,
        revenue_tier: document.getElementById('editRevenueTier').value || null,
        prospect_source: document.getElementById('editOrgSource').value || null,
        prospect_contact_name: document.getElementById('editContactName').value || null,
        prospect_contact_email: document.getElementById('editContactEmail').value || null,
        prospect_contact_title: document.getElementById('editContactTitle').value || null,
        prospect_next_action: document.getElementById('editNextAction').value || null,
        prospect_next_action_date: document.getElementById('editNextActionDate').value || null,
        prospect_notes: document.getElementById('editOrgNotes').value || null,
        disqualification_reason: status === 'disqualified' ? document.getElementById('editDisqualificationReason').value || null : null
      };

      const btn = document.getElementById('saveOrgBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const response = await fetch(`/api/admin/prospects/${orgId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar.redirectToLogin();
            return;
          }
          throw new Error('Failed to save changes');
        }

        closeEditOrgModal();
        loadOrganization(); // Refresh data
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Changes';
      }
    }

    // Activity Modal functions
    function openLogActivityModal() {
      document.getElementById('activityModalTitle').textContent = 'Log Activity';
      document.getElementById('activityForm').reset();
      document.getElementById('nextStepFields').style.display = 'none';
      document.getElementById('activityModal').style.display = 'block';
    }

    function openAddNextStepModal() {
      document.getElementById('activityModalTitle').textContent = 'Add Next Step';
      document.getElementById('activityForm').reset();
      document.getElementById('activityType').value = 'note';
      document.getElementById('isNextStep').checked = true;
      document.getElementById('nextStepFields').style.display = 'block';
      document.getElementById('activityModal').style.display = 'block';
    }

    function closeActivityModal() {
      document.getElementById('activityModal').style.display = 'none';
    }

    function toggleNextStepFields() {
      const isNextStep = document.getElementById('isNextStep').checked;
      document.getElementById('nextStepFields').style.display = isNextStep ? 'block' : 'none';
    }

    async function saveActivity(event) {
      event.preventDefault();

      const isNextStep = document.getElementById('isNextStep').checked;
      const nextStepOwner = document.getElementById('nextStepOwner').value;

      const data = {
        activity_type: document.getElementById('activityType').value,
        description: document.getElementById('activityDescription').value || null,
        activity_date: document.getElementById('activityDate').value || null,
        is_next_step: isNextStep,
        next_step_due_date: isNextStep ? document.getElementById('nextStepDueDate').value || null : null,
        next_step_owner_name: isNextStep ? nextStepOwner || null : null
      };

      const btn = document.getElementById('saveActivityBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const response = await fetch(`/api/admin/organizations/${orgId}/activities`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar.redirectToLogin();
            return;
          }
          throw new Error('Failed to save activity');
        }

        closeActivityModal();
        loadOrganization(); // Refresh data
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Activity';
      }
    }

    async function saveQuickFollowUp(event) {
      event.preventDefault();

      const input = document.getElementById('quickFollowUpText');
      const btn = document.getElementById('quickFollowUpBtn');
      const description = input.value.trim();

      if (!description) return;

      // Get current user's name for the owner
      const currentUserMember = teamMembers.find(m => currentUserId && m.user_id === currentUserId);
      const ownerName = currentUserMember?.user_name || null;

      // Default due date to tomorrow
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const dueDate = tomorrow.toISOString().split('T')[0];

      const data = {
        activity_type: 'note',
        description: description,
        is_next_step: true,
        next_step_due_date: dueDate,
        next_step_owner_name: ownerName
      };

      btn.disabled = true;
      btn.textContent = '...';

      try {
        const response = await fetch(`/api/admin/organizations/${orgId}/activities`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar.redirectToLogin();
            return;
          }
          throw new Error('Failed to save follow-up');
        }

        input.value = '';
        loadOrganization(); // Refresh data
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Add';
      }
    }

    async function completeNextStep(activityId) {
      try {
        const response = await fetch(`/api/admin/organizations/${orgId}/activities/${activityId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            next_step_completed_at: new Date().toISOString()
          })
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar.redirectToLogin();
            return;
          }
          throw new Error('Failed to complete step');
        }

        loadOrganization(); // Refresh data
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Owner selector and watch functions
    function renderOwnerSelector() {
      const ownerDisplay = document.getElementById('ownerDisplay');
      const ownerSelect = document.getElementById('ownerSelect');
      const watchBtn = document.getElementById('watchBtn');

      // Find owner stakeholder
      const ownerStakeholder = stakeholders.find(s => s.role === 'owner');
      const isCurrentUserOwner = ownerStakeholder && currentUserId && ownerStakeholder.user_id === currentUserId;

      // Update owner display
      // Fall back to legacy prospect_owner field if no stakeholder owner exists
      if (ownerStakeholder) {
        ownerDisplay.textContent = isCurrentUserOwner ? 'Me' : ownerStakeholder.user_name;
      } else if (orgData.prospect_owner) {
        ownerDisplay.textContent = orgData.prospect_owner;
      } else {
        ownerDisplay.textContent = 'Unassigned';
      }

      // Populate owner dropdown using DOM APIs to prevent XSS
      ownerSelect.innerHTML = '';
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Unassigned';
      ownerSelect.appendChild(defaultOption);

      teamMembers.forEach(member => {
        const option = document.createElement('option');
        option.value = member.user_id;
        option.textContent = member.user_id === currentUserId ? 'Me' : member.user_name;
        if (ownerStakeholder && ownerStakeholder.user_id === member.user_id) {
          option.selected = true;
        }
        ownerSelect.appendChild(option);
      });

      // Update watch button
      // Check if current user is watching (interested role) - but not if they're the owner
      const isWatching = stakeholders.some(s =>
        currentUserId && s.user_id === currentUserId && s.role === 'interested'
      );

      if (isCurrentUserOwner) {
        // Hide watch button if user is owner
        watchBtn.style.display = 'none';
      } else {
        watchBtn.style.display = 'inline-block';
        watchBtn.className = isWatching ? 'watch-btn watching' : 'watch-btn';
        watchBtn.textContent = isWatching ? 'â­' : 'â˜†';
        watchBtn.title = isWatching ? 'Stop watching' : 'Watch this organization';
      }
    }

    function populateOwnerDropdowns() {
      const editOrgOwner = document.getElementById('editOrgOwner');
      const nextStepOwner = document.getElementById('nextStepOwner');

      editOrgOwner.innerHTML = '<option value="">Not assigned</option>';
      nextStepOwner.innerHTML = '<option value="">Not assigned</option>';

      teamMembers.forEach(member => {
        const isMe = currentUserId && member.user_id === currentUserId;
        const displayName = isMe ? `${member.user_name} (me)` : member.user_name;

        // Edit modal uses legacy prospect_owner field (stores name)
        const editOption = document.createElement('option');
        editOption.value = member.user_name;
        editOption.textContent = displayName;
        editOrgOwner.appendChild(editOption);

        // Next step dropdown uses name for next_step_owner_name field
        const nextStepOption = document.createElement('option');
        nextStepOption.value = member.user_name;
        nextStepOption.textContent = displayName;
        nextStepOwner.appendChild(nextStepOption);
      });
    }

    function showOwnerDropdown() {
      const dropdown = document.getElementById('ownerDropdown');
      const display = document.getElementById('ownerDisplay');

      dropdown.classList.add('active');
      display.style.display = 'none';

      // Focus the select
      const select = document.getElementById('ownerSelect');
      select.focus();

      // Close dropdown when clicking outside
      const closeDropdown = (e) => {
        if (!dropdown.contains(e.target) && e.target !== display) {
          dropdown.classList.remove('active');
          display.style.display = 'inline';
          document.removeEventListener('click', closeDropdown);
        }
      };
      setTimeout(() => document.addEventListener('click', closeDropdown), 0);
    }

    async function assignOwner(userId) {
      const dropdown = document.getElementById('ownerDropdown');
      const display = document.getElementById('ownerDisplay');

      // Hide dropdown, show display
      dropdown.classList.remove('active');
      display.style.display = 'inline';

      try {
        let response;
        if (!userId) {
          // Remove owner - find and delete owner stakeholder
          const ownerStakeholder = stakeholders.find(s => s.role === 'owner');
          if (ownerStakeholder) {
            response = await fetch(`/api/admin/organizations/${orgId}/stakeholders/${ownerStakeholder.id}`, {
              method: 'DELETE'
            });
          }
        } else {
          // Assign new owner
          const teamMember = teamMembers.find(m => m.user_id === userId);
          response = await fetch(`/api/admin/organizations/${orgId}/stakeholders`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              user_id: userId,
              user_name: teamMember?.user_name || userId,
              user_email: teamMember?.user_email,
              role: 'owner'
            })
          });
        }

        if (response && !response.ok) {
          if (response.status === 401) {
            window.AdminSidebar.redirectToLogin();
            return;
          }
          throw new Error('Failed to update owner');
        }

        // Refresh stakeholders
        const stakeholdersResponse = await fetch(`/api/admin/organizations/${orgId}/stakeholders`);
        stakeholders = stakeholdersResponse.ok ? await stakeholdersResponse.json() : [];
        renderOwnerSelector();
      } catch (error) {
        console.error('Error assigning owner:', error);
        alert('Failed to assign owner. Please try again.');
      }
    }

    async function toggleWatch() {
      const isWatching = stakeholders.some(s =>
        currentUserId && s.user_id === currentUserId && s.role === 'interested'
      );

      try {
        let response;
        if (isWatching) {
          // Stop watching - remove self as stakeholder
          response = await fetch(`/api/admin/organizations/${orgId}/stakeholders/me`, {
            method: 'DELETE'
          });
        } else {
          // Start watching - add self as interested
          response = await fetch(`/api/admin/organizations/${orgId}/stakeholders/me`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role: 'interested' })
          });
        }

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar.redirectToLogin();
            return;
          }
          throw new Error('Failed to update watch status');
        }

        // Refresh stakeholders
        const stakeholdersResponse = await fetch(`/api/admin/organizations/${orgId}/stakeholders`);
        stakeholders = stakeholdersResponse.ok ? await stakeholdersResponse.json() : [];
        renderOwnerSelector();
      } catch (error) {
        console.error('Error toggling watch:', error);
        alert('Failed to update watch status. Please try again.');
      }
    }

    // ========================================
    // LINKED DOMAINS
    // ========================================

    // HTML escape to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Escape for use in JavaScript string literals within onclick attributes
    function escapeJs(text) {
      if (!text) return '';
      return String(text)
        .replace(/\\/g, '\\\\')
        .replace(/'/g, "\\'")
        .replace(/"/g, '\\"')
        .replace(/\n/g, '\\n')
        .replace(/\r/g, '\\r');
    }

    // Helper to refresh domains list
    async function refreshDomains() {
      const domainsResponse = await fetch(`/api/admin/organizations/${orgId}/domains`);
      domainsData = domainsResponse.ok ? await domainsResponse.json() : { domains: [], workos_domains: [] };
      renderDomains();
    }

    function renderDomains() {
      const container = document.getElementById('domainsList');

      if (!domainsData || (domainsData.domains.length === 0 && domainsData.workos_domains.length === 0)) {
        container.innerHTML = '<div class="empty-state">No domains linked</div>';
        return;
      }

      // Combine local domains with any WorkOS-only domains
      const allDomains = [...domainsData.domains];
      const localDomainNames = new Set(allDomains.map(d => d.domain.toLowerCase()));

      // Add WorkOS domains that aren't in our local DB yet
      for (const wosDomain of domainsData.workos_domains) {
        if (!localDomainNames.has(wosDomain.domain.toLowerCase())) {
          allDomains.push({
            domain: wosDomain.domain,
            is_primary: false,
            verified: wosDomain.state === 'verified',
            source: 'workos',
            workos_only: true
          });
        }
      }

      if (allDomains.length === 0) {
        container.innerHTML = '<div class="empty-state">No domains linked</div>';
        return;
      }

      container.innerHTML = `<ul class="domains-list">
        ${allDomains.map(d => {
          const escapedDomain = escapeHtml(d.domain);
          const badges = [];
          if (d.is_primary) badges.push('<span class="domain-badge primary">Primary</span>');
          if (d.verified) badges.push('<span class="domain-badge verified">Verified</span>');
          badges.push(`<span class="domain-badge ${escapeHtml(d.source)}">${d.source === 'workos' ? 'WorkOS' : 'Manual'}</span>`);

          return `
            <li class="domain-item" data-domain="${escapedDomain}">
              <div class="domain-info">
                <span class="domain-name">${escapedDomain}</span>
                ${badges.join(' ')}
              </div>
              <div class="domain-actions">
                ${!d.verified ? `<button class="btn btn-sm btn-primary" data-action="verify">Verify</button>` : ''}
                ${!d.is_primary && !d.workos_only ? `<button class="btn btn-sm btn-secondary" data-action="set-primary">Set Primary</button>` : ''}
                <button class="btn-icon danger" data-action="remove" title="Remove domain" aria-label="Remove domain ${escapedDomain}">&times;</button>
              </div>
            </li>
          `;
        }).join('')}
      </ul>`;

      // Event delegation for domain actions
      container.addEventListener('click', handleDomainAction);
    }

    function handleDomainAction(e) {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;

      const domainItem = btn.closest('[data-domain]');
      if (!domainItem) return;

      const domain = domainItem.dataset.domain;
      const action = btn.dataset.action;

      if (action === 'set-primary') {
        setDomainPrimary(domain, btn);
      } else if (action === 'remove') {
        removeDomain(domain, btn);
      } else if (action === 'verify') {
        verifyDomain(domain, btn);
      }
    }

    function openAddDomainModal() {
      document.getElementById('addDomainForm').reset();
      document.getElementById('addDomainModal').style.display = 'block';
    }

    function closeAddDomainModal() {
      document.getElementById('addDomainModal').style.display = 'none';
    }

    // Helper to safely parse error response
    async function getErrorMessage(response, defaultMsg) {
      try {
        const data = await response.json();
        return data.error || defaultMsg;
      } catch {
        return defaultMsg;
      }
    }

    async function addDomain(event) {
      event.preventDefault();

      const domain = document.getElementById('domainInput').value.trim().toLowerCase();
      const isPrimary = document.getElementById('domainIsPrimary').checked;

      const btn = document.getElementById('addDomainBtn');
      btn.disabled = true;
      btn.textContent = 'Adding...';

      try {
        const response = await fetch(`/api/admin/organizations/${orgId}/domains`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ domain, is_primary: isPrimary })
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar.redirectToLogin();
            return;
          }
          throw new Error(await getErrorMessage(response, 'Failed to add domain'));
        }

        closeAddDomainModal();
        await refreshDomains();
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Add Domain';
      }
    }

    async function setDomainPrimary(domain, btn) {
      const originalText = btn ? btn.textContent : '';
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Setting...';
      }

      try {
        const response = await fetch(`/api/admin/organizations/${orgId}/domains/${encodeURIComponent(domain)}/primary`, {
          method: 'PUT'
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar.redirectToLogin();
            return;
          }
          throw new Error(await getErrorMessage(response, 'Failed to set primary domain'));
        }

        await refreshDomains();
      } catch (error) {
        alert('Error: ' + error.message);
        if (btn) {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }
    }

    async function removeDomain(domain, btn) {
      if (!confirm(`Remove domain "${escapeHtml(domain)}" from this organization?`)) return;

      if (btn) {
        btn.disabled = true;
      }

      try {
        const response = await fetch(`/api/admin/organizations/${orgId}/domains/${encodeURIComponent(domain)}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar.redirectToLogin();
            return;
          }
          throw new Error(await getErrorMessage(response, 'Failed to remove domain'));
        }

        await refreshDomains();
      } catch (error) {
        alert('Error: ' + error.message);
        if (btn) {
          btn.disabled = false;
        }
      }
    }

    async function verifyDomain(domain, btn) {
      const originalText = btn ? btn.textContent : '';
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Verifying...';
      }

      try {
        // Reuse the add domain endpoint - it handles verification of existing domains
        const response = await fetch(`/api/admin/organizations/${orgId}/domains`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ domain: domain.toLowerCase() })
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar.redirectToLogin();
            return;
          }
          throw new Error(await getErrorMessage(response, 'Failed to verify domain'));
        }

        await refreshDomains();
      } catch (error) {
        alert('Error: ' + error.message);
        if (btn) {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }
    }

    // ========================================
    // ENGAGEMENT SIGNALS
    // ========================================

    function renderEngagementSignals(signals, isPayingMember = false) {
      if (!signals) return;

      // Update section title and button text based on member status
      const titleEl = document.getElementById('engagementSectionTitle');
      const interestBtn = document.getElementById('setInterestBtn');
      const interestLabel = document.getElementById('interestLevelLabel');
      if (isPayingMember) {
        titleEl.textContent = 'Member Engagement';
        interestBtn.textContent = 'Set Satisfaction';
        interestLabel.textContent = 'Satisfaction';
      } else {
        titleEl.textContent = 'Engagement Signals';
        interestBtn.textContent = 'Set Interest';
        interestLabel.textContent = 'Interest Level';
      }

      // Interest level (or Satisfaction for members)
      const interestEl = document.getElementById('signalInterestLevel');
      if (signals.interest_level) {
        const levelLabels = {
          'low': 'Low',
          'medium': 'Medium',
          'high': 'High',
          'very_high': 'Very High'
        };
        let html = `<span class="interest-badge interest-${signals.interest_level}">${levelLabels[signals.interest_level]}</span>`;
        if (signals.interest_level_set_by) {
          html += ` <span style="color: var(--color-text-muted); font-size: var(--text-xs);">by ${signals.interest_level_set_by}</span>`;
        }
        if (signals.interest_level_set_at) {
          const setDate = new Date(signals.interest_level_set_at);
          html += ` <span style="color: var(--color-text-muted); font-size: var(--text-xs);">(${setDate.toLocaleDateString()})</span>`;
        }
        interestEl.innerHTML = html;
      } else {
        interestEl.innerHTML = '<span class="negative">Not set</span>';
      }

      // Member profile
      const profileEl = document.getElementById('signalMemberProfile');
      profileEl.innerHTML = signals.has_member_profile
        ? '<span class="positive">Configured</span>'
        : '<span class="negative">Not configured</span>';

      // Login count
      const loginEl = document.getElementById('signalLoginCount');
      loginEl.innerHTML = signals.login_count_30d > 0
        ? `<span class="positive">${signals.login_count_30d}</span>`
        : '<span class="negative">0</span>';

      // Last login
      const lastLoginEl = document.getElementById('signalLastLogin');
      if (signals.last_login) {
        const lastLogin = new Date(signals.last_login);
        lastLoginEl.textContent = lastLogin.toLocaleDateString();
      } else {
        lastLoginEl.innerHTML = '<span class="negative">Never</span>';
      }

      // Working groups
      const wgEl = document.getElementById('signalWorkingGroups');
      wgEl.innerHTML = signals.working_group_count > 0
        ? `<span class="positive">${signals.working_group_count}</span>`
        : '<span class="negative">0</span>';

      // Email clicks
      const emailEl = document.getElementById('signalEmailClicks');
      emailEl.innerHTML = signals.email_click_count_30d > 0
        ? `<span class="positive">${signals.email_click_count_30d}</span>`
        : '<span class="negative">0</span>';
    }

    // Interest Level Modal
    function openInterestLevelModal() {
      const modal = document.getElementById('interestLevelModal');
      const select = document.getElementById('interestLevelSelect');
      const note = document.getElementById('interestLevelNote');

      // Update modal title based on member status
      const isPayingMember = orgData.subscription_status === 'active' || orgData.subscription_status === 'trialing';
      document.getElementById('interestModalTitle').textContent = isPayingMember ? 'Set Satisfaction Level' : 'Set Interest Level';
      document.getElementById('interestModalLabel').textContent = isPayingMember ? 'Satisfaction Level' : 'Interest Level';

      // Pre-populate with current values
      if (orgData.engagement_signals) {
        select.value = orgData.engagement_signals.interest_level || '';
        note.value = orgData.engagement_signals.interest_level_note || '';
      }

      modal.style.display = 'block';
    }

    function closeInterestLevelModal() {
      document.getElementById('interestLevelModal').style.display = 'none';
    }

    async function saveInterestLevel(event) {
      event.preventDefault();

      const interest_level = document.getElementById('interestLevelSelect').value || null;
      const note = document.getElementById('interestLevelNote').value.trim() || null;

      try {
        const response = await fetch(`/api/admin/organizations/${orgId}/interest-level`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ interest_level, note })
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar.redirectToLogin();
            return;
          }
          throw new Error('Failed to save interest level');
        }

        const data = await response.json();

        // Update the local data and re-render
        orgData.engagement_signals = data.engagement_signals;
        renderEngagementSignals(data.engagement_signals);

        // Re-fetch the full org data to get updated engagement level/reasons
        const orgResponse = await fetch(`/api/admin/organizations/${orgId}`);
        if (orgResponse.ok) {
          orgData = await orgResponse.json();
          const isPayingMember = orgData.subscription_status === 'active' || orgData.subscription_status === 'trialing';
          const engagementLevel = orgData.engagement_level || 1;
          const indicator = isPayingMember ? 'â­'.repeat(engagementLevel) : 'ðŸ”¥'.repeat(engagementLevel);
          document.getElementById('engagementFires').textContent = indicator;
          document.getElementById('engagementReasons').textContent =
            orgData.engagement_reasons?.join(' â€¢ ') || (isPayingMember ? 'New member' : 'Cold');
          // Re-render engagement signals with correct context
          renderEngagementSignals(orgData.engagement_signals, isPayingMember);
        }

        closeInterestLevelModal();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // ========================================
    // USER CONTEXT MODAL
    // ========================================

    async function showUserContext(userId, type, userName) {
      const modal = document.getElementById('userContextModal');
      const modalTitle = document.getElementById('userContextModalTitle');
      const modalBody = document.getElementById('userContextModalBody');

      modalTitle.textContent = `Context: ${userName}`;
      modalBody.innerHTML = '<div style="text-align: center; padding: var(--space-8);"><p>Loading context...</p></div>';
      modal.style.display = 'block';

      try {
        const response = await fetch(`/api/admin/users/${userId}/context?type=${type}`);
        if (!response.ok) {
          throw new Error('Failed to fetch context');
        }
        const context = await response.json();
        modalBody.innerHTML = renderUserContext(context, userId);
      } catch (error) {
        console.error('Error fetching context:', error);
        modalBody.innerHTML = `
          <div style="text-align: center; padding: var(--space-8); color: var(--color-error-600);">
            <p>Failed to load context.</p>
            <button class="btn btn-secondary" onclick="showUserContext('${escapeJs(userId)}', '${escapeJs(type)}', '${escapeJs(userName)}')">Retry</button>
          </div>
        `;
      }
    }

    function closeUserContextModal() {
      document.getElementById('userContextModal').style.display = 'none';
    }

    function renderUserContext(context, userId) {
      let html = '';

      // Addie's Goal Section
      if (context.addie_goal) {
        html += '<div style="background: var(--color-primary-50); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">';
        html += '<h3 style="font-size: var(--text-sm); margin-bottom: var(--space-2);">Addie\'s Goal</h3>';
        html += `<div style="font-weight: var(--font-medium); color: var(--color-text-heading);">${escapeHtml(context.addie_goal.goal_name || context.addie_goal.goal_key)}</div>`;
        if (context.addie_goal.reasoning) {
          html += `<p style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-top: var(--space-1);">${escapeHtml(context.addie_goal.reasoning)}</p>`;
        }
        html += '</div>';
      }

      // Identity Section
      html += '<div style="margin-bottom: var(--space-4);">';
      html += '<h3 style="font-size: var(--text-sm); margin-bottom: var(--space-2);">Identity</h3>';
      html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-3);">';

      if (context.workos_user) {
        html += renderContextItem('Email', context.workos_user.email);
        const name = `${context.workos_user.first_name || ''} ${context.workos_user.last_name || ''}`.trim();
        if (name) html += renderContextItem('Name', name);
      }

      if (context.slack_user && !context.workos_user) {
        html += renderContextItem('Email', context.slack_user.email || 'Not set');
        html += renderContextItem('Slack Name', context.slack_user.display_name || context.slack_user.real_name || 'Not set');
      }

      // Status badges
      const statusItems = [];
      if (context.is_member) statusItems.push('<span style="display: inline-block; padding: 2px 8px; background: var(--color-success-100); color: var(--color-success-700); border-radius: var(--radius-sm); font-size: var(--text-xs); font-weight: var(--font-medium);">Member</span>');
      if (context.slack_linked) statusItems.push('<span style="display: inline-block; padding: 2px 8px; background: #4A154B20; color: #4A154B; border-radius: var(--radius-sm); font-size: var(--text-xs); font-weight: var(--font-medium);">Slack</span>');

      if (statusItems.length > 0) {
        html += `<div style="background: var(--color-gray-50); padding: var(--space-3); border-radius: var(--radius-md); grid-column: 1 / -1;">
          <div style="font-size: var(--text-xs); color: var(--color-text-muted); margin-bottom: var(--space-1);">Status</div>
          <div style="display: flex; gap: var(--space-1);">${statusItems.join(' ')}</div>
        </div>`;
      }

      html += '</div></div>';

      // Organization Section
      if (context.organization) {
        html += '<div style="margin-bottom: var(--space-4);">';
        html += '<h3 style="font-size: var(--text-sm); margin-bottom: var(--space-2);">Organization</h3>';
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-3);">';
        html += renderContextItem('Company', context.organization.name);
        const subStatus = context.organization.subscription_status || 'None';
        html += renderContextItem('Subscription', subStatus);
        html += '</div></div>';
      }

      // Activity Section
      html += '<div style="margin-bottom: var(--space-4);">';
      html += '<h3 style="font-size: var(--text-sm); margin-bottom: var(--space-2);">Activity</h3>';
      html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-3);">';

      if (context.engagement) {
        html += renderContextItem('Dashboard Logins (30d)', context.engagement.login_count_30d.toString());
        if (context.engagement.last_login) {
          html += renderContextItem('Last Login', new Date(context.engagement.last_login).toLocaleDateString());
        }
        html += renderContextItem('Email Clicks (30d)', context.engagement.email_click_count_30d.toString());
      }

      if (context.slack_activity) {
        html += renderContextItem('Slack Messages (30d)', context.slack_activity.total_messages_30d.toString());
        html += renderContextItem('Reactions Given', context.slack_activity.total_reactions_30d.toString());
        if (context.slack_activity.last_activity_at) {
          html += renderContextItem('Last Slack Activity', new Date(context.slack_activity.last_activity_at).toLocaleDateString());
        }
      }

      html += '</div></div>';

      // Working Groups Section
      if (context.working_groups && context.working_groups.length > 0) {
        html += '<div style="margin-bottom: var(--space-4);">';
        html += '<h3 style="font-size: var(--text-sm); margin-bottom: var(--space-2);">Working Groups</h3>';
        html += '<div style="display: flex; flex-wrap: wrap; gap: var(--space-1);">';
        context.working_groups.forEach(wg => {
          html += `<span style="display: inline-block; padding: 2px 8px; background: var(--color-primary-100); color: var(--color-primary-700); border-radius: var(--radius-sm); font-size: var(--text-xs); font-weight: var(--font-medium);">${escapeHtml(wg.name)}${wg.is_leader ? ' (Leader)' : ''}</span>`;
        });
        html += '</div></div>';
      }

      // Insights Section
      if (context.insights && context.insights.length > 0) {
        html += '<div style="margin-bottom: var(--space-4);">';
        html += '<h3 style="font-size: var(--text-sm); margin-bottom: var(--space-2);">Insights</h3>';
        html += '<div style="max-height: 150px; overflow-y: auto;">';
        context.insights.forEach(insight => {
          html += `<div style="background: var(--color-gray-50); border-radius: var(--radius-sm); padding: var(--space-2) var(--space-3); margin-bottom: var(--space-2);">
            <div style="font-weight: var(--font-medium); font-size: var(--text-xs); color: var(--color-text-heading);">${escapeHtml(insight.type_name || 'Insight')}</div>
            <div style="font-size: var(--text-sm); color: var(--color-text-primary);">${escapeHtml(insight.value)}</div>
          </div>`;
        });
        html += '</div></div>';
      }

      // Link to full user view
      html += `<div style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--color-gray-200);">
        <a href="/admin/users" class="btn btn-secondary" style="text-decoration: none;">View in Users Page</a>
      </div>`;

      return html;
    }

    function renderContextItem(label, value) {
      return `
        <div style="background: var(--color-gray-50); padding: var(--space-3); border-radius: var(--radius-md);">
          <div style="font-size: var(--text-xs); color: var(--color-text-muted); margin-bottom: var(--space-1);">${escapeHtml(label)}</div>
          <div style="font-size: var(--text-sm); color: var(--color-text-heading); font-weight: var(--font-medium);">${escapeHtml(value)}</div>
        </div>
      `;
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }

    // Close modals on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeUserContextModal();
      }
    });

    // Check for link_domain query parameter
    async function checkLinkDomainParam() {
      const params = new URLSearchParams(window.location.search);
      const linkDomain = params.get('link_domain');

      // Validate domain format (alphanumeric, hyphens, dots only, reasonable length)
      const isValidDomain = linkDomain && /^[a-z0-9][a-z0-9.-]{0,252}[a-z0-9]$/i.test(linkDomain);

      if (isValidDomain) {
        // Wait for org to load
        await loadOrganization();

        // Clean up URL immediately (wrap in try/catch for edge cases)
        try {
          const url = new URL(window.location);
          url.searchParams.delete('link_domain');
          window.history.replaceState({}, '', url);
        } catch (e) {
          console.warn('Could not clean up URL:', e);
        }

        // Directly add the domain to the org
        try {
          const response = await fetch(`/api/admin/organizations/${orgId}/domains`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ domain: linkDomain.toLowerCase(), is_primary: true })
          });

          if (!response.ok) {
            if (response.status === 401) {
              window.AdminSidebar.redirectToLogin();
              return;
            }
            throw new Error(await getErrorMessage(response, 'Failed to link domain'));
          }

          // Refresh domains to show the newly added domain
          await refreshDomains();
        } catch (error) {
          alert('Error linking domain: ' + error.message);
        }
      } else {
        loadOrganization();
      }
    }

    // =========================================================================
    // Payment Link Functions
    // =========================================================================

    function openPaymentLinkModal() {
      document.getElementById('paymentLinkOrgName').textContent = `For: ${orgData?.name || 'Unknown'}`;
      document.getElementById('paymentLinkProducts').innerHTML = 'Loading products...';
      document.getElementById('paymentLinkProducts').style.display = 'block';
      document.getElementById('paymentLinkResult').style.display = 'none';

      // Show discount notice if org has a discount
      const discountNotice = document.getElementById('paymentLinkDiscountNotice');
      if (orgData.discount_percent || orgData.discount_amount_cents) {
        discountNotice.style.display = 'block';
        let discountText = '';
        if (orgData.discount_percent) {
          discountText = `${orgData.discount_percent}% off`;
        } else {
          discountText = `$${(orgData.discount_amount_cents / 100).toFixed(0)} off`;
        }
        if (orgData.stripe_promotion_code) {
          discountText += ` (code: ${orgData.stripe_promotion_code})`;
        }
        document.getElementById('paymentLinkDiscountText').textContent = discountText;
        document.getElementById('applyDiscountToPaymentLink').checked = true;
      } else {
        discountNotice.style.display = 'none';
      }

      document.getElementById('paymentLinkModal').style.display = 'block';

      loadPaymentLinkProducts();
    }

    async function loadPaymentLinkProducts() {
      try {
        const response = await fetch(`/api/admin/prospects/${orgId}/payment-link`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}) // No lookup_key = get product list
        });

        if (!response.ok) {
          throw new Error('Failed to load products');
        }

        const data = await response.json();

        if (data.needs_selection && data.products) {
          renderPaymentLinkProducts(data.products);
        }
      } catch (error) {
        console.error('Error loading products:', error);
        document.getElementById('paymentLinkProducts').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load products. Please try again.</p>';
      }
    }

    function renderPaymentLinkProducts(products) {
      const container = document.getElementById('paymentLinkProducts');

      if (products.length === 0) {
        container.innerHTML = '<p style="color: var(--color-text-secondary);">No products available for this account type.</p>';
        return;
      }

      container.innerHTML = products.map(product => {
        const price = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD'
        }).format(product.amount_cents / 100);

        const displayName = escapeHtml(product.display_name);
        const lookupKey = escapeHtml(product.lookup_key);
        const tiers = product.revenue_tiers?.length > 0
          ? `<span style="font-size: var(--text-xs); color: var(--color-text-muted);">(${product.revenue_tiers.map(t => escapeHtml(t)).join(', ')})</span>`
          : '';

        return `
          <button class="product-select-btn" onclick="generatePaymentLink('${lookupKey}')" style="
            display: block;
            width: 100%;
            text-align: left;
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-bg-card);
            cursor: pointer;
            transition: var(--transition-all);
          " onmouseover="this.style.borderColor='var(--color-brand)'" onmouseout="this.style.borderColor='var(--color-border)'">
            <strong>${displayName}</strong> ${tiers}
            <br>
            <span style="color: var(--color-brand); font-weight: var(--font-semibold);">${price}/year</span>
          </button>
        `;
      }).join('');
    }

    async function generatePaymentLink(lookupKey) {
      const container = document.getElementById('paymentLinkProducts');
      container.innerHTML = '<p>Generating payment link...</p>';

      try {
        // Check if discount should be applied
        const applyDiscount = document.getElementById('applyDiscountToPaymentLink')?.checked;
        const body = { lookup_key: lookupKey };

        if (applyDiscount && orgData.stripe_coupon_id) {
          body.coupon_id = orgData.stripe_coupon_id;
        } else if (applyDiscount && orgData.stripe_promotion_code) {
          body.promotion_code = orgData.stripe_promotion_code;
        }

        const response = await fetch(`/api/admin/prospects/${orgId}/payment-link`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || data.error || 'Failed to generate payment link');
        }

        if (data.success && data.payment_url) {
          container.style.display = 'none';
          document.getElementById('paymentLinkDiscountNotice').style.display = 'none';
          document.getElementById('paymentLinkUrl').value = data.payment_url;
          document.getElementById('paymentLinkResult').style.display = 'block';
        } else {
          throw new Error(data.message || 'Unknown error');
        }
      } catch (error) {
        console.error('Error generating payment link:', error);
        container.innerHTML = `<p style="color: var(--color-error-600);">Error: ${error.message}</p>`;
      }
    }

    function copyPaymentLink() {
      const input = document.getElementById('paymentLinkUrl');
      input.select();
      navigator.clipboard.writeText(input.value).then(() => {
        alert('Payment link copied to clipboard!');
      }).catch(() => {
        document.execCommand('copy');
        alert('Payment link copied to clipboard!');
      });
    }

    function closePaymentLinkModal() {
      document.getElementById('paymentLinkModal').style.display = 'none';
      // Reset the products display for next time
      document.getElementById('paymentLinkProducts').style.display = 'block';
    }

    // =========================================================================
    // Invoice Functions
    // =========================================================================

    let selectedInvoiceProduct = null;

    function openInvoiceModal() {
      selectedInvoiceProduct = null;

      document.getElementById('invoiceOrgName').textContent = `For: ${orgData?.name || 'Unknown'}`;
      document.getElementById('invoiceProducts').innerHTML = 'Loading products...';
      document.getElementById('invoiceProductSection').style.display = 'block';
      document.getElementById('invoiceBillingSection').style.display = 'none';
      document.getElementById('invoiceDraftReview').style.display = 'none';
      document.getElementById('invoiceResult').style.display = 'none';
      document.getElementById('sendInvoiceBtn').style.display = 'none';
      document.getElementById('prepareDraftBtn').style.display = 'none';
      document.getElementById('backToEditBtn').style.display = 'none';
      document.getElementById('invoiceForm').reset();

      // Pre-fill from org data
      if (orgData) {
        document.getElementById('invoiceContactName').value = orgData.prospect_contact_name || '';
        document.getElementById('invoiceContactEmail').value = orgData.prospect_contact_email || '';
        document.getElementById('invoiceCompanyName').value = orgData.name || '';
      }

      document.getElementById('invoiceModal').style.display = 'block';

      loadInvoiceProducts();
    }

    async function loadInvoiceProducts() {
      try {
        const response = await fetch('/api/admin/products');
        if (!response.ok) throw new Error('Failed to load products');

        const data = await response.json();
        const invoiceableProducts = data.products.filter(p => p.is_invoiceable);

        // Sort products by price (lowest first for better UX)
        invoiceableProducts.sort((a, b) => (a.amount_cents || 0) - (b.amount_cents || 0));

        renderInvoiceProducts(invoiceableProducts);
      } catch (error) {
        console.error('Error loading products:', error);
        document.getElementById('invoiceProducts').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load products. Please try again.</p>';
      }
    }

    function getRecommendedInvoiceProduct(products) {
      // Get the org's revenue tier
      let orgRevenueTier = orgData?.revenue_tier;

      // If no revenue_tier set, try to derive from enrichment data
      if (!orgRevenueTier && orgData?.enrichment_revenue_range) {
        const rangeMap = {
          'under $1m': 'under_1m',
          '$1m-$5m': '1m_5m',
          '$5m-$50m': '5m_50m',
          '$50m-$250m': '50m_250m',
          '$250m-$1b': '250m_1b',
          'over $1b': '1b_plus'
        };
        const lowerRange = orgData.enrichment_revenue_range.toLowerCase();
        for (const [key, value] of Object.entries(rangeMap)) {
          if (lowerRange.includes(key.replace('$', '').replace('-', ' to '))) {
            orgRevenueTier = value;
            break;
          }
        }
      }

      if (!orgRevenueTier) return null;

      // Find products that match the org's revenue tier
      const matchingProducts = products.filter(p => {
        if (!p.revenue_tiers || p.revenue_tiers.length === 0) return true;
        return p.revenue_tiers.includes(orgRevenueTier);
      });

      // Return highest priced matching product (same logic as pricing section)
      if (matchingProducts.length > 0) {
        return matchingProducts.reduce((a, b) => (b.amount_cents || 0) > (a.amount_cents || 0) ? b : a);
      }
      return null;
    }

    function calculateDiscountedPrice(amountCents) {
      if (orgData?.discount_percent) {
        return Math.round(amountCents * (1 - orgData.discount_percent / 100));
      } else if (orgData?.discount_amount_cents) {
        return Math.max(0, amountCents - orgData.discount_amount_cents);
      }
      return amountCents;
    }

    function renderInvoiceProducts(products) {
      const container = document.getElementById('invoiceProducts');

      if (products.length === 0) {
        container.innerHTML = '<p style="color: var(--color-text-secondary);">No invoiceable products available.</p>';
        return;
      }

      const recommendedProduct = getRecommendedInvoiceProduct(products);
      const hasDiscount = orgData?.discount_percent || orgData?.discount_amount_cents;

      // Show discount info at top if applicable
      let headerHtml = '';
      if (hasDiscount) {
        const discountText = orgData.discount_percent
          ? `${orgData.discount_percent}% discount`
          : `${formatPriceCurrency(orgData.discount_amount_cents)} discount`;
        headerHtml = `
          <div style="margin-bottom: var(--space-3); padding: var(--space-2) var(--space-3); background: var(--color-success-50); border-radius: var(--radius-md); border: 1px solid var(--color-success-200);">
            <span style="color: var(--color-success-700); font-weight: var(--font-medium);">
              ${discountText} will be applied
            </span>
          </div>
        `;
      }

      container.innerHTML = headerHtml + products.map(product => {
        const listPrice = product.amount_cents || 0;
        const netPrice = hasDiscount ? calculateDiscountedPrice(listPrice) : listPrice;

        const listPriceFormatted = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(listPrice / 100);

        const netPriceFormatted = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(netPrice / 100);

        const interval = product.billing_interval ? `/${product.billing_interval}` : '';
        const displayName = escapeHtml(product.display_name || product.product_name);
        const lookupKey = escapeHtml(product.lookup_key);
        const description = product.description ? escapeHtml(product.description) : '';
        const isRecommended = recommendedProduct && product.lookup_key === recommendedProduct.lookup_key;

        // Build price display
        let priceHtml;
        if (hasDiscount && listPrice !== netPrice) {
          priceHtml = `
            <span style="text-decoration: line-through; color: var(--color-text-muted); margin-right: var(--space-2);">${listPriceFormatted}</span>
            <span style="color: var(--color-success-600); font-weight: var(--font-semibold);">${netPriceFormatted}${interval}</span>
          `;
        } else {
          priceHtml = `<span style="color: var(--color-brand); font-weight: var(--font-semibold);">${listPriceFormatted}${interval}</span>`;
        }

        // Build recommended badge
        const recommendedBadge = isRecommended
          ? `<span style="display: inline-block; margin-left: var(--space-2); padding: 2px 8px; font-size: var(--text-xs); background: var(--color-brand); color: white; border-radius: var(--radius-full);">Recommended</span>`
          : '';

        const borderColor = isRecommended ? 'var(--color-brand)' : 'var(--color-border)';
        const borderWidth = isRecommended ? '2px' : '1px';

        return `
          <button type="button" class="product-select-btn"
            data-lookup-key="${lookupKey}"
            data-display-name="${displayName}"
            data-amount="${listPrice}"
            data-border-color="${borderColor}"
            style="
            display: block;
            width: 100%;
            text-align: left;
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            border: ${borderWidth} solid ${borderColor};
            border-radius: var(--radius-md);
            background: var(--color-bg-card);
            cursor: pointer;
            transition: var(--transition-all);
          ">
            <strong>${displayName}</strong>${recommendedBadge}
            <br>
            ${priceHtml}
            ${description ? `<br><span style="font-size: var(--text-xs); color: var(--color-text-muted);">${description}</span>` : ''}
          </button>
        `;
      }).join('');

      // Add event listeners to avoid XSS from inline onclick
      container.querySelectorAll('.product-select-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          selectInvoiceProduct(
            btn.dataset.lookupKey,
            btn.dataset.displayName,
            parseInt(btn.dataset.amount, 10)
          );
        });
        btn.addEventListener('mouseover', () => {
          btn.style.borderColor = 'var(--color-brand)';
        });
        btn.addEventListener('mouseout', () => {
          btn.style.borderColor = btn.dataset.borderColor;
        });
      });
    }

    function selectInvoiceProduct(lookupKey, productName, amountCents) {
      selectedInvoiceProduct = { lookupKey, productName, amountCents };

      const hasDiscount = orgData?.discount_percent || orgData?.discount_amount_cents;
      const netPrice = hasDiscount ? calculateDiscountedPrice(amountCents) : amountCents;

      const listPriceFormatted = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amountCents / 100);

      const netPriceFormatted = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(netPrice / 100);

      let priceDisplay;
      if (hasDiscount && amountCents !== netPrice) {
        priceDisplay = `
          <span style="text-decoration: line-through; color: var(--color-text-muted);">${listPriceFormatted}</span>
          <span style="color: var(--color-success-600); font-weight: var(--font-semibold); margin-left: var(--space-2);">${netPriceFormatted}</span>
        `;
      } else {
        priceDisplay = `<span style="color: var(--color-brand);">${listPriceFormatted}</span>`;
      }

      document.getElementById('selectedProductDisplay').innerHTML = `
        <strong>${productName}</strong> - ${priceDisplay}
      `;

      document.getElementById('invoiceProductSection').style.display = 'none';
      document.getElementById('invoiceBillingSection').style.display = 'block';
      document.getElementById('invoiceDraftReview').style.display = 'none';
      document.getElementById('prepareDraftBtn').style.display = 'inline-block';
      document.getElementById('sendInvoiceBtn').style.display = 'none';
      document.getElementById('backToEditBtn').style.display = 'none';
    }

    function prepareDraft() {
      // Collect all invoice data for review
      const contactName = document.getElementById('invoiceContactName').value;
      const contactEmail = document.getElementById('invoiceContactEmail').value;
      const companyName = document.getElementById('invoiceCompanyName').value;
      const addressLine1 = document.getElementById('invoiceAddressLine1').value;
      const addressLine2 = document.getElementById('invoiceAddressLine2').value;
      const city = document.getElementById('invoiceCity').value;
      const state = document.getElementById('invoiceState').value;
      const postalCode = document.getElementById('invoicePostalCode').value;
      const country = document.getElementById('invoiceCountry').value;

      // Check for missing required fields
      const missingFields = [];
      if (!contactName) missingFields.push('Contact Name');
      if (!contactEmail) missingFields.push('Contact Email');
      if (!companyName) missingFields.push('Company Name');
      if (!addressLine1) missingFields.push('Street Address');
      if (!city) missingFields.push('City');
      if (!state) missingFields.push('State/Province');
      if (!postalCode) missingFields.push('Postal Code');
      if (!country) missingFields.push('Country');

      // Calculate pricing
      const hasDiscount = orgData?.discount_percent || orgData?.discount_amount_cents;
      const listPrice = selectedInvoiceProduct.amountCents;
      const netPrice = hasDiscount ? calculateDiscountedPrice(listPrice) : listPrice;

      const listPriceFormatted = new Intl.NumberFormat('en-US', {
        style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0
      }).format(listPrice / 100);

      const netPriceFormatted = new Intl.NumberFormat('en-US', {
        style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0
      }).format(netPrice / 100);

      // Build discount info
      let discountHtml = '';
      if (hasDiscount && listPrice !== netPrice) {
        const discountText = orgData.discount_percent
          ? `${orgData.discount_percent}% discount`
          : `${formatPriceCurrency(orgData.discount_amount_cents)} off`;
        const savingsFormatted = new Intl.NumberFormat('en-US', {
          style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0
        }).format((listPrice - netPrice) / 100);
        discountHtml = `
          <div style="margin-top: var(--space-2); padding: var(--space-2); background: var(--color-success-50); border-radius: var(--radius-sm);">
            <span style="color: var(--color-success-700); font-size: var(--text-sm);">
              ${discountText} applied (saves ${savingsFormatted})
            </span>
          </div>
        `;
      }

      // Build address display
      const addressParts = [addressLine1];
      if (addressLine2) addressParts.push(addressLine2);
      addressParts.push(`${city}, ${state} ${postalCode}`);
      addressParts.push(country);
      const fullAddress = addressParts.filter(Boolean).join('<br>');

      // Populate review content
      document.getElementById('draftReviewContent').innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
          <div>
            <div style="font-size: var(--text-xs); color: var(--color-text-muted); text-transform: uppercase; margin-bottom: var(--space-1);">Company</div>
            <div style="font-weight: var(--font-semibold);">${escapeHtml(companyName) || '<em style="color: var(--color-error-500);">Not provided</em>'}</div>
          </div>
          <div>
            <div style="font-size: var(--text-xs); color: var(--color-text-muted); text-transform: uppercase; margin-bottom: var(--space-1);">Contact</div>
            <div style="font-weight: var(--font-semibold);">${escapeHtml(contactName) || '<em style="color: var(--color-error-500);">Not provided</em>'}</div>
            <div style="color: var(--color-text-secondary); font-size: var(--text-sm);">${escapeHtml(contactEmail) || '<em style="color: var(--color-error-500);">Not provided</em>'}</div>
          </div>
        </div>

        <hr style="margin: var(--space-4) 0; border: none; border-top: 1px solid var(--color-border);">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
          <div>
            <div style="font-size: var(--text-xs); color: var(--color-text-muted); text-transform: uppercase; margin-bottom: var(--space-1);">Product</div>
            <div style="font-weight: var(--font-semibold);">${escapeHtml(selectedInvoiceProduct.productName)}</div>
          </div>
          <div>
            <div style="font-size: var(--text-xs); color: var(--color-text-muted); text-transform: uppercase; margin-bottom: var(--space-1);">Amount</div>
            ${hasDiscount && listPrice !== netPrice
              ? `<div><span style="text-decoration: line-through; color: var(--color-text-muted);">${listPriceFormatted}</span> <span style="color: var(--color-success-600); font-weight: var(--font-semibold);">${netPriceFormatted}</span></div>`
              : `<div style="font-weight: var(--font-semibold);">${listPriceFormatted}</div>`
            }
            ${discountHtml}
          </div>
        </div>

        <hr style="margin: var(--space-4) 0; border: none; border-top: 1px solid var(--color-border);">

        <div>
          <div style="font-size: var(--text-xs); color: var(--color-text-muted); text-transform: uppercase; margin-bottom: var(--space-1);">Billing Address</div>
          <div style="line-height: 1.5;">${fullAddress || '<em style="color: var(--color-error-500);">Not provided</em>'}</div>
        </div>
      `;

      // Show/hide missing fields warning
      const missingFieldsDiv = document.getElementById('draftMissingFields');
      const missingFieldsList = document.getElementById('missingFieldsList');
      if (missingFields.length > 0) {
        missingFieldsList.innerHTML = missingFields.map(f => `<li>${f}</li>`).join('');
        missingFieldsDiv.style.display = 'block';
      } else {
        missingFieldsDiv.style.display = 'none';
      }

      // Update UI state
      document.getElementById('invoiceBillingSection').style.display = 'none';
      document.getElementById('invoiceDraftReview').style.display = 'block';
      document.getElementById('prepareDraftBtn').style.display = 'none';
      document.getElementById('backToEditBtn').style.display = 'inline-block';
      document.getElementById('sendInvoiceBtn').style.display = missingFields.length === 0 ? 'inline-block' : 'none';
    }

    function backToEditInvoice() {
      document.getElementById('invoiceDraftReview').style.display = 'none';
      document.getElementById('invoiceBillingSection').style.display = 'block';
      document.getElementById('prepareDraftBtn').style.display = 'inline-block';
      document.getElementById('backToEditBtn').style.display = 'none';
      document.getElementById('sendInvoiceBtn').style.display = 'none';
    }

    async function submitInvoice(event) {
      event.preventDefault();

      if (!selectedInvoiceProduct) {
        alert('Please select a product first');
        return;
      }

      const btn = document.getElementById('sendInvoiceBtn');
      btn.disabled = true;
      btn.textContent = 'Sending...';

      const data = {
        lookup_key: selectedInvoiceProduct.lookupKey,
        company_name: document.getElementById('invoiceCompanyName').value,
        contact_name: document.getElementById('invoiceContactName').value,
        contact_email: document.getElementById('invoiceContactEmail').value,
        billing_address: {
          line1: document.getElementById('invoiceAddressLine1').value,
          line2: document.getElementById('invoiceAddressLine2').value || undefined,
          city: document.getElementById('invoiceCity').value,
          state: document.getElementById('invoiceState').value,
          postal_code: document.getElementById('invoicePostalCode').value,
          country: document.getElementById('invoiceCountry').value,
        }
      };

      // Include coupon_id if the org has a discount configured
      if (orgData?.stripe_coupon_id) {
        data.coupon_id = orgData.stripe_coupon_id;
      }

      try {
        const response = await fetch(`/api/admin/prospects/${orgId}/invoice`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || error.message || 'Failed to send invoice');
        }

        const result = await response.json();

        if (result.success && result.invoice_url) {
          document.getElementById('invoiceBillingSection').style.display = 'none';
          document.getElementById('invoiceDraftReview').style.display = 'none';
          document.getElementById('sendInvoiceBtn').style.display = 'none';
          document.getElementById('backToEditBtn').style.display = 'none';
          document.getElementById('invoiceUrl').value = result.invoice_url;
          document.getElementById('invoiceResult').style.display = 'block';

          // Refresh the org data to show the new pending invoice
          loadOrganization();
        } else {
          throw new Error(result.message || 'Unknown error');
        }
      } catch (error) {
        console.error('Error sending invoice:', error);
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Send Invoice';
      }
    }

    function copyInvoiceLink() {
      const input = document.getElementById('invoiceUrl');
      input.select();
      navigator.clipboard.writeText(input.value).then(() => {
        alert('Invoice link copied to clipboard!');
      }).catch(() => {
        document.execCommand('copy');
        alert('Invoice link copied to clipboard!');
      });
    }

    function closeInvoiceModal() {
      document.getElementById('invoiceModal').style.display = 'none';
      selectedInvoiceProduct = null;
    }

    // =========================================================================
    // Pricing & Discount Functions
    // =========================================================================

    async function loadPricingData() {
      try {
        // Load products to determine suggested tier pricing
        const response = await fetch('/api/admin/products');
        if (response.ok) {
          const data = await response.json();
          productsData = data.products || [];
        }
      } catch (error) {
        console.error('Error loading products:', error);
      }

      renderPricing();
    }

    function renderPricing() {
      // Get the org's revenue tier - either explicitly set or derived from enrichment
      let orgRevenueTier = orgData.revenue_tier;
      let revenueTierSource = orgData.revenue_tier ? 'manual' : null;

      // If no revenue_tier set, try to derive from enrichment data
      if (!orgRevenueTier && orgData.enrichment_revenue_range) {
        // enrichment_revenue_range might be something like "$1M-$5M" - try to map it
        const rangeMap = {
          'under $1m': 'under_1m',
          '$1m-$5m': '1m_5m',
          '$5m-$50m': '5m_50m',
          '$50m-$250m': '50m_250m',
          '$250m-$1b': '250m_1b',
          'over $1b': '1b_plus'
        };
        const lowerRange = orgData.enrichment_revenue_range.toLowerCase();
        for (const [key, value] of Object.entries(rangeMap)) {
          if (lowerRange.includes(key.replace('$', '').replace('-', ' to '))) {
            orgRevenueTier = value;
            revenueTierSource = 'enrichment';
            break;
          }
        }
      }

      // Filter membership products for companies (orgs in admin are always companies)
      // Include products that either: have no customer_types restriction, or explicitly allow 'company'
      const membershipProducts = productsData.filter(p =>
        p.category === 'membership' &&
        p.billing_type === 'subscription' &&
        (!p.customer_types || p.customer_types.length === 0 || p.customer_types.includes('company'))
      );

      // Find products that match the org's revenue tier
      // If product has no revenue_tiers restriction, it's available to all
      // If product has revenue_tiers, org must match one of them
      let matchingProducts = membershipProducts.filter(p => {
        if (!p.revenue_tiers || p.revenue_tiers.length === 0) {
          return true; // Available to all
        }
        return orgRevenueTier && p.revenue_tiers.includes(orgRevenueTier);
      });

      // Sort matching products by price (highest first)
      matchingProducts.sort((a, b) => (b.amount_cents || 0) - (a.amount_cents || 0));

      // Only recommend a product if we have revenue tier data
      // If we don't know the tier, don't guess - show "Unknown" and let the admin set it
      const suggestedProduct = orgRevenueTier && matchingProducts.length > 0 ? matchingProducts[0] : null;

      // Build context about what we know (even if we can't make a recommendation)
      const pricingContext = buildPricingContext({
        orgRevenueTier,
        revenueTierSource,
        suggestedProduct,
        companyTypes: orgData.company_types || [],
        employeeCount: orgData.enrichment_employee_count,
        fundingStage: orgData.enrichment_funding_stage,
        fundingTotal: orgData.enrichment_funding_total,
        foundedYear: orgData.enrichment_founded_year,
      });

      // Display product info
      if (suggestedProduct) {
        document.getElementById('pricingSuggestedTier').textContent = suggestedProduct.display_name || suggestedProduct.product_name;
        if (matchingProducts.length > 1) {
          document.getElementById('pricingSuggestedTier').innerHTML +=
            ` <span style="font-size: var(--text-xs); color: var(--color-text-muted);">(${matchingProducts.length} options)</span>`;
        }
      } else {
        // No recommendation - we don't have enough data
        document.getElementById('pricingSuggestedTier').innerHTML =
          `<span style="color: var(--color-text-muted);">Unknown</span>` +
          ` <button onclick="openRevenueTierModal()" style="margin-left: 8px; font-size: var(--text-xs); color: var(--color-brand); background: none; border: none; cursor: pointer; text-decoration: underline;">Set tier</button>`;
      }

      // Display list price
      let listPrice = suggestedProduct?.amount_cents || 0;
      document.getElementById('pricingListPrice').textContent =
        listPrice > 0 ? formatPriceCurrency(listPrice) + '/year' : '-';

      // Display context (what we know about this org)
      if (pricingContext) {
        document.getElementById('pricingRationaleRow').style.display = 'flex';
        document.getElementById('pricingRationale').innerHTML = pricingContext;
      } else {
        document.getElementById('pricingRationaleRow').style.display = 'none';
      }

      // Check for discount
      const hasDiscount = orgData.discount_percent || orgData.discount_amount_cents;

      if (hasDiscount) {
        document.getElementById('discountRow').style.display = 'flex';
        document.getElementById('netPriceRow').style.display = 'flex';
        document.getElementById('manageDiscountBtn').textContent = 'Edit Discount';

        let discountText = '';
        let netPrice = listPrice;

        if (orgData.discount_percent) {
          discountText = `${orgData.discount_percent}% off`;
          netPrice = Math.round(listPrice * (1 - orgData.discount_percent / 100));
        } else if (orgData.discount_amount_cents) {
          discountText = formatPriceCurrency(orgData.discount_amount_cents) + ' off';
          netPrice = Math.max(0, listPrice - orgData.discount_amount_cents);
        }

        document.getElementById('pricingDiscount').innerHTML =
          `<span style="color: var(--color-success-600);">${discountText}</span>`;
        document.getElementById('pricingNetPrice').textContent =
          formatPriceCurrency(netPrice) + '/year';

        // Show promo code if available
        if (orgData.stripe_promotion_code) {
          document.getElementById('promoCodeRow').style.display = 'flex';
          document.getElementById('pricingPromoCode').innerHTML =
            `<code style="background: var(--color-gray-100); padding: 2px 6px; border-radius: 4px;">${escapeHtml(orgData.stripe_promotion_code)}</code>
             <button onclick="copyPromoCode('${escapeHtml(orgData.stripe_promotion_code)}')" style="margin-left: 8px; font-size: var(--text-xs); color: var(--color-brand); background: none; border: none; cursor: pointer;">Copy</button>`;
        }

        // Show discount details
        document.getElementById('discountDetails').style.display = 'block';
        document.getElementById('discountReasonText').textContent = orgData.discount_reason || '-';
        document.getElementById('discountGrantedBy').textContent = orgData.discount_granted_by || 'Unknown';
        document.getElementById('discountGrantedAt').textContent =
          orgData.discount_granted_at ? new Date(orgData.discount_granted_at).toLocaleDateString() : '-';
      } else {
        document.getElementById('discountRow').style.display = 'none';
        document.getElementById('netPriceRow').style.display = 'none';
        document.getElementById('promoCodeRow').style.display = 'none';
        document.getElementById('discountDetails').style.display = 'none';
        document.getElementById('manageDiscountBtn').textContent = 'Set Discount';
      }
    }

    function formatPriceCurrency(cents) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(cents / 100);
    }

    function formatRevenueTierDisplay(tier) {
      const tierLabels = {
        'under_1m': 'Under $1M',
        '1m_5m': '$1M-$5M',
        '5m_50m': '$5M-$50M',
        '50m_250m': '$50M-$250M',
        '250m_1b': '$250M-$1B',
        '1b_plus': 'Over $1B'
      };
      return tierLabels[tier] || tier;
    }

    function buildPricingContext(params) {
      const {
        orgRevenueTier,
        revenueTierSource,
        suggestedProduct,
        companyTypes,
        employeeCount,
        fundingStage,
        fundingTotal,
        foundedYear,
      } = params;

      const signals = [];

      // If we have a revenue tier, show how we know it
      if (orgRevenueTier && revenueTierSource === 'manual') {
        signals.push(`Revenue: ${formatRevenueTierDisplay(orgRevenueTier)}`);
      } else if (orgRevenueTier && revenueTierSource === 'enrichment') {
        signals.push(`Revenue: ${formatRevenueTierDisplay(orgRevenueTier)} (enrichment)`);
      }

      // Funding info - strong signal for startups
      if (fundingStage || fundingTotal) {
        let fundingInfo = '';
        if (fundingStage) {
          // Escape enrichment data to prevent XSS
          fundingInfo = escapeHtml(String(fundingStage));
        }
        if (fundingTotal) {
          const totalFormatted = fundingTotal >= 1000000
            ? `$${(fundingTotal / 1000000).toFixed(1)}M`
            : `$${(fundingTotal / 1000).toFixed(0)}K`;
          fundingInfo = fundingInfo ? `${fundingInfo} (${totalFormatted} raised)` : `${totalFormatted} raised`;
        }
        signals.push(fundingInfo);
      }

      // Founded year - helps identify startups
      if (foundedYear) {
        const currentYear = new Date().getFullYear();
        const age = currentYear - foundedYear;
        if (age <= 2) {
          signals.push(`Founded ${foundedYear} (startup)`);
        } else if (age <= 5) {
          signals.push(`Founded ${foundedYear}`);
        }
      }

      // Employee count
      if (employeeCount) {
        if (employeeCount >= 1000) {
          signals.push(`${employeeCount.toLocaleString()} employees (enterprise)`);
        } else if (employeeCount >= 100) {
          signals.push(`${employeeCount.toLocaleString()} employees (mid-market)`);
        } else if (employeeCount >= 10) {
          signals.push(`${employeeCount.toLocaleString()} employees`);
        } else {
          signals.push(`${employeeCount} employees (early stage)`);
        }
      }

      // Company type
      if (companyTypes && companyTypes.length > 0) {
        const typeLabels = {
          'brand': 'Brand',
          'publisher': 'Publisher',
          'agency': 'Agency',
          'adtech': 'Ad Tech',
          'data': 'Data & Measurement',
          'ai': 'AI & Tech',
          'other': 'Other'
        };
        const typeNames = companyTypes.map(t => typeLabels[t] || t).join(', ');
        signals.push(typeNames);
      }

      // If no signals at all, return null
      if (signals.length === 0) {
        return suggestedProduct ? null : '<span style="color: var(--color-warning-600);">No data - set revenue tier to recommend a membership</span>';
      }

      return signals.join(' Â· ');
    }

    function copyPromoCode(code) {
      navigator.clipboard.writeText(code).then(() => {
        alert('Promo code copied!');
      });
    }

    // Discount Modal Functions
    function openDiscountModal() {
      // Reset form
      document.getElementById('discountForm').reset();
      document.getElementById('discountType').value = 'percent';
      document.getElementById('discountPercentGroup').style.display = 'block';
      document.getElementById('discountAmountGroup').style.display = 'none';
      document.getElementById('customReasonGroup').style.display = 'none';

      // Show current discount if exists
      const currentInfo = document.getElementById('currentDiscountInfo');
      if (orgData.discount_percent || orgData.discount_amount_cents) {
        currentInfo.style.display = 'block';
        let currentText = '';
        if (orgData.discount_percent) {
          currentText = `${orgData.discount_percent}% discount`;
          document.getElementById('discountType').value = 'percent';
          document.getElementById('discountPercent').value = orgData.discount_percent;
        } else {
          currentText = `$${orgData.discount_amount_cents / 100} discount`;
          document.getElementById('discountType').value = 'amount';
          document.getElementById('discountAmount').value = orgData.discount_amount_cents / 100;
          toggleDiscountInputs();
        }
        if (orgData.discount_reason) {
          currentText += ` - ${orgData.discount_reason}`;
        }
        document.getElementById('currentDiscountText').textContent = currentText;
        document.getElementById('discountModalTitle').textContent = 'Edit Discount';
      } else {
        currentInfo.style.display = 'none';
        document.getElementById('discountModalTitle').textContent = 'Set Discount';
      }

      document.getElementById('discountModal').style.display = 'block';
    }

    function closeDiscountModal() {
      document.getElementById('discountModal').style.display = 'none';
    }

    function toggleDiscountInputs() {
      const type = document.getElementById('discountType').value;
      document.getElementById('discountPercentGroup').style.display = type === 'percent' ? 'block' : 'none';
      document.getElementById('discountAmountGroup').style.display = type === 'amount' ? 'block' : 'none';
    }

    function toggleCustomReason() {
      const reason = document.getElementById('discountReasonSelect').value;
      document.getElementById('customReasonGroup').style.display = reason === 'custom' ? 'block' : 'none';
    }

    async function saveDiscount(event) {
      event.preventDefault();

      const type = document.getElementById('discountType').value;
      const reasonSelect = document.getElementById('discountReasonSelect').value;
      const customReason = document.getElementById('discountCustomReason').value;
      const createStripeCoupon = document.getElementById('createStripeCoupon').checked;

      // Validate
      let discountValue;
      if (type === 'percent') {
        discountValue = parseInt(document.getElementById('discountPercent').value);
        if (!discountValue || discountValue < 1 || discountValue > 100) {
          alert('Please enter a valid percentage between 1 and 100');
          return;
        }
      } else {
        discountValue = parseInt(document.getElementById('discountAmount').value);
        if (!discountValue || discountValue < 1) {
          alert('Please enter a valid discount amount');
          return;
        }
      }

      if (!reasonSelect) {
        alert('Please select a reason for the discount');
        return;
      }

      if (reasonSelect === 'custom' && !customReason.trim()) {
        alert('Please enter a custom reason');
        return;
      }

      const reason = reasonSelect === 'custom' ? customReason : reasonSelect;

      const btn = document.getElementById('saveDiscountBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const body = {
          reason,
          create_stripe_coupon: createStripeCoupon
        };

        if (type === 'percent') {
          body.discount_percent = discountValue;
        } else {
          body.discount_amount_cents = discountValue * 100; // Convert to cents
        }

        const response = await fetch(`/api/admin/organizations/${orgId}/discount`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || error.message || 'Failed to save discount');
        }

        const result = await response.json();

        closeDiscountModal();
        loadOrganization(); // Refresh to show updated discount

        if (result.promotion_code) {
          alert(`Discount saved! Promo code: ${result.promotion_code}`);
        } else {
          alert('Discount saved!');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Discount';
      }
    }

    async function removeDiscount() {
      if (!confirm('Are you sure you want to remove this discount?')) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/organizations/${orgId}/discount`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || error.message || 'Failed to remove discount');
        }

        closeDiscountModal();
        loadOrganization(); // Refresh
        alert('Discount removed');
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // AI Enrichment function
    async function runAIEnrichment() {
      const btn = document.getElementById('aiEnrichBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Researching...';

      try {
        const response = await fetch(`/api/admin/cleanup/analyze-with-ai/${orgId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar.redirectToLogin();
            return;
          }
          if (response.status === 503) {
            alert('AI enrichment is not configured. ANTHROPIC_API_KEY is required.');
            return;
          }
          throw new Error(await getErrorMessage(response, 'Failed to run AI enrichment'));
        }

        const result = await response.json();

        // Show results in a modal or alert
        let message = result.analysis || 'Analysis complete.';
        if (result.tool_calls && result.tool_calls.length > 0) {
          const updates = result.tool_calls.filter(tc =>
            ['update_prospect', 'enrich_prospect'].includes(tc.tool)
          );
          if (updates.length > 0) {
            message += '\n\nActions taken:\n' + updates.map(u =>
              `- ${u.tool}: ${typeof u.result === 'string' ? u.result.substring(0, 100) : JSON.stringify(u.result).substring(0, 100)}`
            ).join('\n');
          }
        }

        alert(message);

        // Reload the organization to show any updates
        loadOrganization();

      } catch (error) {
        console.error('AI enrichment error:', error);
        alert('Error running AI enrichment: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    // Initialize
    checkLinkDomainParam();
  </script>
</body>
</html>
