<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Organization Details - AdCP Registry</title>
  <link rel="stylesheet" href="/design-system.css">
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <style>
    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-wide);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    .breadcrumb {
      margin-bottom: var(--space-4);
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }
    .breadcrumb a {
      color: var(--color-brand);
      text-decoration: none;
    }
    .breadcrumb a:hover {
      text-decoration: underline;
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-5);
    }
    h1 {
      margin-bottom: var(--space-2);
      color: var(--color-text-heading);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    h2 {
      font-size: var(--text-lg);
      margin-bottom: var(--space-4);
      color: var(--color-text-heading);
    }
    .subtitle {
      color: var(--color-text-secondary);
      margin-bottom: var(--space-4);
    }

    /* Engagement level */
    .engagement-fires {
      font-size: var(--text-xl);
      letter-spacing: 2px;
    }
    .engagement-reasons {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-1);
    }

    /* Grid layout */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-5);
    }
    @media (max-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    /* Info rows */
    .info-row {
      display: flex;
      padding: var(--space-2) 0;
      border-bottom: var(--border-1) solid var(--color-gray-100);
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      width: 140px;
      font-weight: var(--font-semibold);
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
    }
    .info-value {
      flex: 1;
      font-size: var(--text-sm);
    }

    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
    }
    .status-signed_up { background: var(--color-info-100); color: var(--color-info-700); }
    .status-prospect { background: var(--color-gray-200); color: var(--color-text-heading); }
    .status-contacted { background: var(--color-info-100); color: var(--color-info-700); }
    .status-responded { background: var(--color-warning-100); color: var(--color-warning-700); }
    .status-interested { background: var(--color-primary-100); color: var(--color-primary-700); }
    .status-negotiating { background: var(--color-primary-200); color: var(--color-primary-800); }
    .status-converted { background: var(--color-success-100); color: var(--color-success-700); }
    .status-declined { background: var(--color-error-100); color: var(--color-error-700); }

    /* Members list */
    .members-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .members-list li {
      padding: var(--space-2) 0;
      border-bottom: var(--border-1) solid var(--color-gray-100);
      font-size: var(--text-sm);
    }
    .members-list li:last-child {
      border-bottom: none;
    }
    .member-role {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-left: var(--space-2);
    }

    /* Working groups */
    .wg-badge {
      display: inline-block;
      padding: var(--space-1) var(--space-2);
      margin-right: var(--space-2);
      margin-bottom: var(--space-2);
      background: var(--color-primary-100);
      color: var(--color-primary-700);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
    }

    /* Activities timeline */
    .timeline {
      position: relative;
      padding-left: var(--space-6);
    }
    .timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--color-gray-200);
    }
    .timeline-item {
      position: relative;
      padding-bottom: var(--space-5);
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -22px;
      top: 4px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--color-brand);
      border: 2px solid var(--color-bg-card);
    }
    .timeline-item.is-next-step::before {
      background: var(--color-warning-500);
    }
    .timeline-item.completed::before {
      background: var(--color-success-500);
    }
    .timeline-date {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-bottom: var(--space-1);
    }
    .timeline-type {
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      text-transform: capitalize;
    }
    .timeline-description {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-1);
    }
    .timeline-meta {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }

    /* Next steps */
    .next-step-item {
      padding: var(--space-3);
      background: var(--color-warning-50);
      border-left: 3px solid var(--color-warning-500);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-3);
    }
    .next-step-item.overdue {
      background: var(--color-error-50);
      border-left-color: var(--color-error-500);
    }
    .next-step-due {
      font-size: var(--text-xs);
      color: var(--color-warning-600);
      margin-bottom: var(--space-1);
    }
    .next-step-item.overdue .next-step-due {
      color: var(--color-error-600);
    }
    .next-step-description {
      font-size: var(--text-sm);
    }
    .next-step-owner {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }

    /* Buttons */
    .btn {
      padding: var(--space-2) var(--space-4);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .btn-primary {
      background: var(--color-brand);
      color: white;
    }
    .btn-primary:hover {
      background: var(--color-primary-700);
    }
    .btn-secondary {
      background: var(--color-gray-200);
      color: var(--color-text-heading);
    }
    .btn-secondary:hover {
      background: var(--color-gray-300);
    }
    .btn-sm {
      padding: var(--space-1) var(--space-2);
      font-size: var(--text-xs);
    }
    .btn-success {
      background: var(--color-success-600);
      color: white;
    }
    .btn-success:hover {
      background: var(--color-success-700);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: var(--color-surface-overlay);
    }
    .modal-content {
      background-color: var(--color-bg-card);
      margin: var(--space-8) auto;
      padding: var(--space-8);
      border-radius: var(--radius-md);
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-5);
      padding-bottom: var(--space-4);
      border-bottom: var(--border-2) solid var(--color-gray-200);
    }
    .modal-close {
      font-size: var(--text-3xl);
      font-weight: var(--font-bold);
      color: var(--color-text-secondary);
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      line-height: 1;
    }
    .modal-close:hover {
      color: var(--color-text-heading);
    }

    /* Form */
    .form-group {
      margin-bottom: var(--space-4);
    }
    .form-group label {
      display: block;
      margin-bottom: var(--space-1);
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      color: var(--color-text-heading);
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: var(--space-2.5);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
    }
    .form-hint {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }
    .modal-actions {
      display: flex;
      gap: var(--space-2.5);
      justify-content: flex-end;
      margin-top: var(--space-6);
      padding-top: var(--space-4);
      border-top: var(--border-1) solid var(--color-gray-200);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: var(--space-12);
      color: var(--color-text-secondary);
    }

    .empty-state {
      text-align: center;
      padding: var(--space-8);
      color: var(--color-text-muted);
      font-size: var(--text-sm);
    }

    /* Stakeholders */
    .stakeholders-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .stakeholder-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-2) 0;
      border-bottom: var(--border-1) solid var(--color-gray-100);
      font-size: var(--text-sm);
    }
    .stakeholder-item:last-child {
      border-bottom: none;
    }
    .stakeholder-role {
      display: inline-block;
      padding: var(--space-0.5) var(--space-1.5);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      margin-left: var(--space-2);
    }
    .stakeholder-role.owner {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .stakeholder-role.interested {
      background: var(--color-primary-100);
      color: var(--color-primary-700);
    }
    .stakeholder-role.connected {
      background: var(--color-gray-200);
      color: var(--color-text-heading);
    }
    .btn-connected {
      background: var(--color-success-100);
      color: var(--color-success-700);
      border: var(--border-1) solid var(--color-success-200);
    }
    .btn-connected:hover {
      background: var(--color-success-200);
    }
  </style>
</head>
<body>
  <!-- AAO top navigation -->
  <div id="adcp-nav"></div>

  <div id="loading" class="loading">
    Loading organization details...
  </div>

  <div id="content" style="display: none;">
    <div class="container">
      <div class="breadcrumb">
        <a href="/admin/prospects">Prospects</a> / <span id="breadcrumbName">Organization</span>
      </div>

      <!-- Header Card -->
      <div class="card">
        <div class="card-header">
          <div>
            <h1>
              <span id="orgName">Loading...</span>
              <span id="engagementFires" class="engagement-fires"></span>
            </h1>
            <div id="engagementReasons" class="engagement-reasons"></div>
          </div>
          <div style="display: flex; gap: var(--space-2);">
            <button class="btn btn-secondary" onclick="openEditOrgModal()">Edit</button>
            <button class="btn btn-secondary" onclick="openLogActivityModal()">Log Activity</button>
            <button class="btn btn-primary" onclick="openAddNextStepModal()">Add Next Step</button>
          </div>
        </div>

        <div class="grid-2">
          <div>
            <div class="info-row">
              <span class="info-label">Status</span>
              <span class="info-value" id="orgStatus">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Source</span>
              <span class="info-value" id="orgSource">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Company Type</span>
              <span class="info-value" id="orgType">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Owner</span>
              <span class="info-value" id="orgOwner">-</span>
            </div>
          </div>
          <div>
            <div class="info-row">
              <span class="info-label">Contact</span>
              <span class="info-value" id="orgContact">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Created</span>
              <span class="info-value" id="orgCreated">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Last Activity</span>
              <span class="info-value" id="orgLastActivity">-</span>
            </div>
            <div class="info-row" id="invoiceRequestedRow" style="display: none;">
              <span class="info-label">Invoice Requested</span>
              <span class="info-value" id="orgInvoiceRequested">-</span>
            </div>
          </div>
        </div>

        <div id="orgNotes" style="margin-top: var(--space-4); display: none;">
          <strong style="font-size: var(--text-sm);">Notes:</strong>
          <p id="orgNotesText" style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-top: var(--space-1);"></p>
        </div>
      </div>

      <div class="grid-2">
        <!-- Left Column -->
        <div>
          <!-- Next Steps -->
          <div class="card">
            <h2>Pending Next Steps</h2>
            <div id="nextStepsList" class="empty-state">
              No pending next steps
            </div>
          </div>

          <!-- Team Members -->
          <div class="card">
            <h2>Team Members <span id="memberCount" style="font-weight: normal; color: var(--color-text-muted);"></span></h2>
            <ul id="membersList" class="members-list">
              <li class="empty-state">No members yet</li>
            </ul>
          </div>

          <!-- Working Groups -->
          <div class="card">
            <h2>Working Groups</h2>
            <div id="workingGroupsList" class="empty-state">
              Not in any working groups
            </div>
          </div>

          <!-- Account Stakeholders -->
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
              <h2 style="margin-bottom: 0;">Account Team</h2>
              <button id="connectBtn" class="btn btn-secondary btn-sm" onclick="toggleMyConnection()">I'm connected</button>
            </div>
            <div id="stakeholdersList" class="empty-state">
              No team members assigned
            </div>
          </div>
        </div>

        <!-- Right Column - Activity Timeline -->
        <div>
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
              <h2 style="margin-bottom: 0;">Activity Timeline</h2>
              <button class="btn btn-secondary btn-sm" onclick="openLogActivityModal()">+ Log Activity</button>
            </div>
            <div id="activityTimeline" class="timeline">
              <div class="empty-state">No activities logged yet</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Organization Modal -->
  <div id="editOrgModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>Edit Organization</h2>
        <button class="modal-close" onclick="closeEditOrgModal()">&times;</button>
      </div>
      <form id="editOrgForm" onsubmit="saveOrgChanges(event)">
        <div class="form-row">
          <div class="form-group">
            <label>Status</label>
            <select id="editOrgStatus">
              <option value="signed_up">Signed Up</option>
              <option value="prospect">Prospect</option>
              <option value="contacted">Contacted</option>
              <option value="responded">Responded</option>
              <option value="interested">Interested</option>
              <option value="negotiating">Negotiating</option>
              <option value="converted">Converted</option>
              <option value="declined">Declined</option>
            </select>
          </div>
          <div class="form-group">
            <label>Owner</label>
            <select id="editOrgOwner">
              <option value="">Not assigned</option>
              <option value="Brian">Brian</option>
              <option value="Randy">Randy</option>
              <option value="Matt">Matt</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Company Type</label>
            <select id="editOrgType">
              <option value="">Not specified</option>
              <option value="adtech">Ad Tech</option>
              <option value="agency">Agency</option>
              <option value="brand">Brand</option>
              <option value="publisher">Publisher</option>
            </select>
          </div>
          <div class="form-group">
            <label>Source</label>
            <select id="editOrgSource">
              <option value="">Not specified</option>
              <option value="aao_launch_list">AAO Launch List</option>
              <option value="slack">Slack</option>
              <option value="referral">Referral</option>
              <option value="inbound">Inbound</option>
              <option value="organic">Organic</option>
            </select>
          </div>
        </div>

        <h3 style="margin-top: var(--space-5); margin-bottom: var(--space-4); font-size: var(--text-base);">Contact Info</h3>

        <div class="form-row">
          <div class="form-group">
            <label>Contact Name</label>
            <input type="text" id="editContactName">
          </div>
          <div class="form-group">
            <label>Contact Email</label>
            <input type="email" id="editContactEmail">
          </div>
        </div>

        <div class="form-group">
          <label>Contact Title</label>
          <input type="text" id="editContactTitle" placeholder="e.g., VP Engineering">
        </div>

        <h3 style="margin-top: var(--space-5); margin-bottom: var(--space-4); font-size: var(--text-base);">Follow-up</h3>

        <div class="form-row">
          <div class="form-group">
            <label>Next Action</label>
            <input type="text" id="editNextAction" placeholder="e.g., Send follow-up email">
          </div>
          <div class="form-group">
            <label>Next Action Date</label>
            <input type="date" id="editNextActionDate">
          </div>
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea id="editOrgNotes" placeholder="Any relevant notes about this organization..."></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeEditOrgModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="saveOrgBtn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Log Activity Modal -->
  <div id="activityModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="activityModalTitle">Log Activity</h2>
        <button class="modal-close" onclick="closeActivityModal()">&times;</button>
      </div>
      <form id="activityForm" onsubmit="saveActivity(event)">
        <div class="form-group">
          <label>Activity Type *</label>
          <select id="activityType" required>
            <option value="">Select type...</option>
            <option value="call">Call</option>
            <option value="email">Email</option>
            <option value="meeting">Meeting</option>
            <option value="slack_dm">Slack DM</option>
            <option value="event">Event</option>
            <option value="referral">Referral</option>
            <option value="invoice_requested">Invoice Requested</option>
            <option value="note">Note</option>
          </select>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea id="activityDescription" placeholder="What happened?"></textarea>
        </div>

        <div class="form-group">
          <label>Date</label>
          <input type="datetime-local" id="activityDate">
          <div class="form-hint">Leave blank for now</div>
        </div>

        <div id="nextStepFields" style="display: none; margin-top: var(--space-4); padding-top: var(--space-4); border-top: var(--border-1) solid var(--color-gray-200);">
          <h3 style="font-size: var(--text-base); margin-bottom: var(--space-4);">Next Step</h3>

          <div class="form-row">
            <div class="form-group">
              <label>Due Date</label>
              <input type="date" id="nextStepDueDate">
            </div>
            <div class="form-group">
              <label>Owner</label>
              <select id="nextStepOwner">
                <option value="">Not assigned</option>
                <option value="Brian">Brian</option>
                <option value="Randy">Randy</option>
                <option value="Matt">Matt</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="isNextStep" onchange="toggleNextStepFields()">
            This creates a follow-up task
          </label>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeActivityModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="saveActivityBtn">Save Activity</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let orgData = null;
    let stakeholders = [];
    let currentUserId = null;
    const orgId = window.location.pathname.split('/').pop();

    async function loadOrganization() {
      try {
        // Load org data and stakeholders in parallel
        const [orgResponse, stakeholdersResponse] = await Promise.all([
          fetch(`/api/admin/organizations/${orgId}`),
          fetch(`/api/admin/organizations/${orgId}/stakeholders`)
        ]);

        if (!orgResponse.ok) {
          if (orgResponse.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          if (orgResponse.status === 404) {
            document.getElementById('loading').innerHTML =
              '<p style="color: var(--color-error-600);">Organization not found. <a href="/admin/prospects">Back to prospects</a></p>';
            return;
          }
          throw new Error('Failed to load organization');
        }

        orgData = await orgResponse.json();
        stakeholders = stakeholdersResponse.ok ? await stakeholdersResponse.json() : [];

        // Get current user ID from AdminNav if available
        if (window.AdminNav && window.AdminNav.user) {
          currentUserId = window.AdminNav.user.id;
        }

        renderOrganization();
        renderStakeholders();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch (error) {
        console.error('Error loading organization:', error);
        document.getElementById('loading').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load organization. <a href="/auth/login">Try logging in again</a></p>';
      }
    }

    function renderOrganization() {
      // Breadcrumb and title
      document.getElementById('breadcrumbName').textContent = orgData.name;
      document.getElementById('orgName').textContent = orgData.name;
      document.title = `${orgData.name} - AdCP Registry`;

      // Engagement level (fire emojis)
      const fires = 'ðŸ”¥'.repeat(orgData.engagement_level || 1);
      document.getElementById('engagementFires').textContent = fires;
      document.getElementById('engagementReasons').textContent =
        orgData.engagement_reasons?.join(' â€¢ ') || 'Cold';

      // Status
      const status = orgData.prospect_status || 'signed_up';
      document.getElementById('orgStatus').innerHTML =
        `<span class="status-badge status-${status}">${status.replace('_', ' ')}</span>`;

      // Source
      const sourceLabels = {
        'aao_launch_list': 'AAO Launch List',
        'slack': 'Slack',
        'referral': 'Referral',
        'inbound': 'Inbound',
        'organic': 'Organic'
      };
      document.getElementById('orgSource').textContent =
        sourceLabels[orgData.prospect_source] || orgData.prospect_source || '-';

      // Type
      const typeLabels = {
        'adtech': 'Ad Tech',
        'agency': 'Agency',
        'brand': 'Brand',
        'publisher': 'Publisher'
      };
      document.getElementById('orgType').textContent =
        typeLabels[orgData.company_type] || orgData.company_type || '-';

      // Owner
      document.getElementById('orgOwner').textContent = orgData.prospect_owner || '-';

      // Contact
      let contactHtml = '-';
      if (orgData.prospect_contact_name || orgData.prospect_contact_email) {
        contactHtml = '';
        if (orgData.prospect_contact_name) {
          contactHtml += orgData.prospect_contact_name;
          if (orgData.prospect_contact_title) {
            contactHtml += ` <span style="color: var(--color-text-muted);">(${orgData.prospect_contact_title})</span>`;
          }
        }
        if (orgData.prospect_contact_email) {
          contactHtml += `<br><a href="mailto:${orgData.prospect_contact_email}">${orgData.prospect_contact_email}</a>`;
        }
      }
      document.getElementById('orgContact').innerHTML = contactHtml;

      // Dates
      document.getElementById('orgCreated').textContent =
        orgData.created_at ? new Date(orgData.created_at).toLocaleDateString() : '-';
      document.getElementById('orgLastActivity').textContent =
        orgData.last_activity_at ? new Date(orgData.last_activity_at).toLocaleDateString() : '-';

      // Invoice requested
      if (orgData.invoice_requested_at) {
        document.getElementById('invoiceRequestedRow').style.display = 'flex';
        document.getElementById('orgInvoiceRequested').textContent =
          new Date(orgData.invoice_requested_at).toLocaleDateString();
      }

      // Notes
      if (orgData.prospect_notes) {
        document.getElementById('orgNotes').style.display = 'block';
        document.getElementById('orgNotesText').textContent = orgData.prospect_notes;
      }

      // Members
      renderMembers();

      // Working groups
      renderWorkingGroups();

      // Activities
      renderActivities();

      // Next steps
      renderNextSteps();
    }

    function renderMembers() {
      const list = document.getElementById('membersList');
      const count = document.getElementById('memberCount');

      if (!orgData.members || orgData.members.length === 0) {
        list.innerHTML = '<li class="empty-state">No members yet</li>';
        count.textContent = '';
        return;
      }

      count.textContent = `(${orgData.members.length})`;
      list.innerHTML = orgData.members.map(member => {
        const name = [member.firstName, member.lastName].filter(Boolean).join(' ') || member.email;
        return `
          <li>
            ${name}
            <span class="member-role">${member.role}</span>
            <br><span style="font-size: var(--text-xs); color: var(--color-text-muted);">${member.email}</span>
          </li>
        `;
      }).join('');
    }

    function renderWorkingGroups() {
      const container = document.getElementById('workingGroupsList');

      if (!orgData.working_groups || orgData.working_groups.length === 0) {
        container.innerHTML = '<div class="empty-state">Not in any working groups</div>';
        return;
      }

      container.innerHTML = orgData.working_groups.map(wg =>
        `<span class="wg-badge">${wg.name}</span>`
      ).join('');
    }

    function renderNextSteps() {
      const container = document.getElementById('nextStepsList');

      if (!orgData.next_steps || orgData.next_steps.length === 0) {
        container.innerHTML = '<div class="empty-state">No pending next steps</div>';
        return;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      container.innerHTML = orgData.next_steps.map(step => {
        const dueDate = step.next_step_due_date ? new Date(step.next_step_due_date) : null;
        const isOverdue = dueDate && dueDate < today;

        return `
          <div class="next-step-item ${isOverdue ? 'overdue' : ''}">
            <div class="next-step-due">
              ${dueDate ? (isOverdue ? 'Overdue: ' : 'Due: ') + dueDate.toLocaleDateString() : 'No due date'}
            </div>
            <div class="next-step-description">${step.description || step.activity_type}</div>
            ${step.next_step_owner_name ? `<div class="next-step-owner">Owner: ${step.next_step_owner_name}</div>` : ''}
            <button class="btn btn-success btn-sm" style="margin-top: var(--space-2);" onclick="completeNextStep(${step.id})">Mark Complete</button>
          </div>
        `;
      }).join('');
    }

    function renderActivities() {
      const container = document.getElementById('activityTimeline');

      if (!orgData.activities || orgData.activities.length === 0) {
        container.innerHTML = '<div class="empty-state">No activities logged yet</div>';
        return;
      }

      const typeLabels = {
        'call': 'Call',
        'email': 'Email',
        'meeting': 'Meeting',
        'slack_dm': 'Slack DM',
        'event': 'Event',
        'note': 'Note',
        'invoice_requested': 'Invoice Requested',
        'referral': 'Referral'
      };

      container.innerHTML = orgData.activities.map(activity => {
        const date = new Date(activity.activity_date);
        const isNextStep = activity.is_next_step && !activity.next_step_completed_at;
        const isCompleted = activity.next_step_completed_at;

        return `
          <div class="timeline-item ${isNextStep ? 'is-next-step' : ''} ${isCompleted ? 'completed' : ''}">
            <div class="timeline-date">${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            <div class="timeline-type">${typeLabels[activity.activity_type] || activity.activity_type}</div>
            ${activity.description ? `<div class="timeline-description">${activity.description}</div>` : ''}
            <div class="timeline-meta">
              ${activity.logged_by_name ? `Logged by ${activity.logged_by_name}` : ''}
              ${activity.is_next_step ? ` â€¢ ${activity.next_step_completed_at ? 'Completed' : 'Pending follow-up'}` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // Edit Organization Modal functions
    function openEditOrgModal() {
      // Populate form with current values
      document.getElementById('editOrgStatus').value = orgData.prospect_status || 'signed_up';
      document.getElementById('editOrgOwner').value = orgData.prospect_owner || '';
      document.getElementById('editOrgType').value = orgData.company_type || '';
      document.getElementById('editOrgSource').value = orgData.prospect_source || '';
      document.getElementById('editContactName').value = orgData.prospect_contact_name || '';
      document.getElementById('editContactEmail').value = orgData.prospect_contact_email || '';
      document.getElementById('editContactTitle').value = orgData.prospect_contact_title || '';
      document.getElementById('editNextAction').value = orgData.prospect_next_action || '';
      document.getElementById('editNextActionDate').value = orgData.prospect_next_action_date ? orgData.prospect_next_action_date.split('T')[0] : '';
      document.getElementById('editOrgNotes').value = orgData.prospect_notes || '';

      document.getElementById('editOrgModal').style.display = 'block';
    }

    function closeEditOrgModal() {
      document.getElementById('editOrgModal').style.display = 'none';
    }

    async function saveOrgChanges(event) {
      event.preventDefault();

      const data = {
        prospect_status: document.getElementById('editOrgStatus').value,
        prospect_owner: document.getElementById('editOrgOwner').value || null,
        company_type: document.getElementById('editOrgType').value || null,
        prospect_source: document.getElementById('editOrgSource').value || null,
        prospect_contact_name: document.getElementById('editContactName').value || null,
        prospect_contact_email: document.getElementById('editContactEmail').value || null,
        prospect_contact_title: document.getElementById('editContactTitle').value || null,
        prospect_next_action: document.getElementById('editNextAction').value || null,
        prospect_next_action_date: document.getElementById('editNextActionDate').value || null,
        prospect_notes: document.getElementById('editOrgNotes').value || null
      };

      const btn = document.getElementById('saveOrgBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const response = await fetch(`/api/admin/prospects/${orgId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          throw new Error('Failed to save changes');
        }

        closeEditOrgModal();
        loadOrganization(); // Refresh data
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Changes';
      }
    }

    // Activity Modal functions
    function openLogActivityModal() {
      document.getElementById('activityModalTitle').textContent = 'Log Activity';
      document.getElementById('activityForm').reset();
      document.getElementById('nextStepFields').style.display = 'none';
      document.getElementById('activityModal').style.display = 'block';
    }

    function openAddNextStepModal() {
      document.getElementById('activityModalTitle').textContent = 'Add Next Step';
      document.getElementById('activityForm').reset();
      document.getElementById('activityType').value = 'note';
      document.getElementById('isNextStep').checked = true;
      document.getElementById('nextStepFields').style.display = 'block';
      document.getElementById('activityModal').style.display = 'block';
    }

    function closeActivityModal() {
      document.getElementById('activityModal').style.display = 'none';
    }

    function toggleNextStepFields() {
      const isNextStep = document.getElementById('isNextStep').checked;
      document.getElementById('nextStepFields').style.display = isNextStep ? 'block' : 'none';
    }

    async function saveActivity(event) {
      event.preventDefault();

      const isNextStep = document.getElementById('isNextStep').checked;
      const nextStepOwner = document.getElementById('nextStepOwner').value;

      const data = {
        activity_type: document.getElementById('activityType').value,
        description: document.getElementById('activityDescription').value || null,
        activity_date: document.getElementById('activityDate').value || null,
        is_next_step: isNextStep,
        next_step_due_date: isNextStep ? document.getElementById('nextStepDueDate').value || null : null,
        next_step_owner_name: isNextStep ? nextStepOwner || null : null
      };

      const btn = document.getElementById('saveActivityBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const response = await fetch(`/api/admin/organizations/${orgId}/activities`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          throw new Error('Failed to save activity');
        }

        closeActivityModal();
        loadOrganization(); // Refresh data
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Activity';
      }
    }

    async function completeNextStep(activityId) {
      try {
        const response = await fetch(`/api/admin/organizations/${orgId}/activities/${activityId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            next_step_completed_at: new Date().toISOString()
          })
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          throw new Error('Failed to complete step');
        }

        loadOrganization(); // Refresh data
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Stakeholder functions
    function renderStakeholders() {
      const container = document.getElementById('stakeholdersList');
      const connectBtn = document.getElementById('connectBtn');

      // Check if current user is already a stakeholder
      const myStakeholder = stakeholders.find(s => s.user_id === currentUserId);

      if (myStakeholder) {
        connectBtn.textContent = 'Connected';
        connectBtn.classList.add('btn-connected');
      } else {
        connectBtn.textContent = "I'm connected";
        connectBtn.classList.remove('btn-connected');
      }

      if (!stakeholders || stakeholders.length === 0) {
        container.innerHTML = '<div class="empty-state">No team members assigned</div>';
        return;
      }

      const roleLabels = {
        'owner': 'Owner',
        'interested': 'Interested',
        'connected': 'Connected'
      };

      container.innerHTML = `<ul class="stakeholders-list">
        ${stakeholders.map(s => `
          <li class="stakeholder-item">
            <div>
              ${s.user_name}
              <span class="stakeholder-role ${s.role}">${roleLabels[s.role] || s.role}</span>
              ${s.user_email ? `<br><span style="font-size: var(--text-xs); color: var(--color-text-muted);">${s.user_email}</span>` : ''}
            </div>
            ${s.user_id === currentUserId ? `<button class="btn btn-sm btn-secondary" onclick="removeMyConnection()">Remove</button>` : ''}
          </li>
        `).join('')}
      </ul>`;
    }

    async function toggleMyConnection() {
      const myStakeholder = stakeholders.find(s => s.user_id === currentUserId);

      try {
        if (myStakeholder) {
          // Already connected - do nothing (use Remove button instead)
          return;
        }

        // Add self as connected
        const response = await fetch(`/api/admin/organizations/${orgId}/stakeholders/me`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role: 'connected' })
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          throw new Error('Failed to update connection');
        }

        // Refresh stakeholders list
        const stakeholdersResponse = await fetch(`/api/admin/organizations/${orgId}/stakeholders`);
        stakeholders = stakeholdersResponse.ok ? await stakeholdersResponse.json() : [];
        renderStakeholders();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function removeMyConnection() {
      if (!confirm('Remove yourself from this account team?')) return;

      try {
        const response = await fetch(`/api/admin/organizations/${orgId}/stakeholders/me`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          throw new Error('Failed to remove connection');
        }

        // Refresh stakeholders list
        const stakeholdersResponse = await fetch(`/api/admin/organizations/${orgId}/stakeholders`);
        stakeholders = stakeholdersResponse.ok ? await stakeholdersResponse.json() : [];
        renderStakeholders();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }

    // Initialize
    loadOrganization();
  </script>
</body>
</html>
