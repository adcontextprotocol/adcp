<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Admin - AdCP Registry</title>
  <link rel="stylesheet" href="/design-system.css">
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <style>
    body {
      background: var(--color-bg-page);
    }

    .container {
      max-width: var(--container-wide);
      margin: var(--space-6) auto;
      padding: 0 var(--space-5);
    }

    .page-header {
      margin-bottom: var(--space-6);
    }

    .page-header h1 {
      color: var(--color-text-heading);
      margin-bottom: var(--space-1);
    }

    .page-header .subtitle {
      color: var(--color-text-secondary);
    }

    /* Goal sections - the 3 pillars */
    .goal-section {
      background: var(--color-bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }

    .goal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-border);
    }

    .goal-title-group {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .goal-icon {
      font-size: var(--text-xl);
    }

    .goal-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
    }

    .goal-subtitle {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }

    /* Trend indicator in header */
    .trend-badge {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
    }

    .trend-badge.up {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }

    .trend-badge.down {
      background: var(--color-error-100);
      color: var(--color-error-700);
    }

    .trend-badge.neutral {
      background: var(--color-gray-100);
      color: var(--color-gray-600);
    }

    /* Metrics grid inside goal */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: var(--space-4);
    }

    .metric-card {
      text-align: center;
      padding: var(--space-3);
      background: var(--color-bg-subtle);
      border-radius: var(--radius-md);
    }

    .metric-card.clickable {
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .metric-card.clickable:hover,
    .metric-card.clickable:focus {
      background: var(--color-gray-100);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .metric-card.clickable:focus {
      outline: 2px solid var(--color-brand);
      outline-offset: 2px;
    }

    .metric-value {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--color-brand);
      line-height: 1.2;
    }

    .metric-value.muted {
      color: var(--color-text-muted);
    }

    .metric-label {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      margin-top: var(--space-1);
    }

    .metric-trend {
      font-size: var(--text-xs);
      margin-top: var(--space-1);
    }

    .metric-trend.up {
      color: var(--color-success-600);
    }

    .metric-trend.down {
      color: var(--color-error-600);
    }

    /* Hero metric - larger */
    .hero-metric {
      background: var(--gradient-primary);
      color: white;
      padding: var(--space-4);
      border-radius: var(--radius-md);
      text-align: center;
    }

    .hero-metric .metric-value {
      font-size: var(--text-3xl);
      color: white;
    }

    .hero-metric .metric-label {
      color: rgba(255, 255, 255, 0.8);
    }

    .hero-metric .metric-trend {
      color: rgba(255, 255, 255, 0.9);
    }

    .hero-metric.clickable {
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .hero-metric.clickable:hover,
    .hero-metric.clickable:focus {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      filter: brightness(1.05);
    }

    .hero-metric.clickable:focus {
      outline: 2px solid white;
      outline-offset: 2px;
    }

    /* Clickable goal header */
    .goal-header.clickable {
      cursor: pointer;
      transition: all 0.15s ease;
      margin: calc(-1 * var(--space-5));
      margin-bottom: var(--space-4);
      padding: var(--space-5);
      padding-bottom: var(--space-3);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }

    .goal-header.clickable:hover,
    .goal-header.clickable:focus {
      background: var(--color-bg-subtle);
    }

    .goal-header.clickable:focus {
      outline: 2px solid var(--color-brand);
      outline-offset: -2px;
    }

    .goal-header.clickable .goal-title-group::after {
      content: '‚Üí';
      margin-left: var(--space-2);
      color: var(--color-text-muted);
      transition: transform 0.15s ease;
    }

    .goal-header.clickable:hover .goal-title-group::after,
    .goal-header.clickable:focus .goal-title-group::after {
      transform: translateX(4px);
      color: var(--color-brand);
    }

    /* Clickable funnel stages */
    .funnel-stage.clickable {
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .funnel-stage.clickable:hover,
    .funnel-stage.clickable:focus {
      background: var(--color-gray-100);
      transform: translateY(-2px);
    }

    .funnel-stage.clickable:focus {
      outline: 2px solid var(--color-brand);
      outline-offset: 2px;
    }

    /* Chart section */
    .chart-section {
      margin-top: var(--space-4);
      padding-top: var(--space-4);
      border-top: 1px solid var(--color-border);
    }

    .chart-title {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-3);
    }

    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: var(--space-2);
      height: 100px;
    }

    .bar-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-1);
    }

    .bar {
      width: 100%;
      max-width: 40px;
      background: var(--color-primary-200);
      border-radius: var(--radius-sm) var(--radius-sm) 0 0;
      transition: height 0.3s ease;
      min-height: 4px;
    }

    .bar-column:last-child .bar {
      background: var(--color-brand);
    }

    .bar-label {
      font-size: 10px;
      color: var(--color-text-muted);
      text-align: center;
    }

    .bar-value {
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      color: var(--color-text-secondary);
    }

    /* Funnel visualization */
    .funnel {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      justify-content: center;
      flex-wrap: wrap;
    }

    .funnel-stage {
      text-align: center;
      padding: var(--space-3) var(--space-4);
      background: var(--color-bg-subtle);
      border-radius: var(--radius-md);
      min-width: 100px;
    }

    .funnel-arrow {
      color: var(--color-text-muted);
      font-size: var(--text-lg);
    }

    .funnel-value {
      font-size: var(--text-xl);
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
    }

    .funnel-stage.active .funnel-value {
      color: var(--color-success-600);
    }

    .funnel-label {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      margin-top: var(--space-1);
    }

    /* Two column for charts */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
      margin-top: var(--space-4);
    }

    @media (max-width: 768px) {
      .two-col {
        grid-template-columns: 1fr;
      }
      .funnel {
        flex-direction: column;
      }
      .funnel-arrow {
        transform: rotate(90deg);
      }
    }

    .loading {
      text-align: center;
      padding: var(--space-12);
      color: var(--color-text-secondary);
    }

    /* Addie insight box */
    .insight-box {
      background: var(--color-primary-50);
      border: 1px solid var(--color-primary-200);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      margin-top: var(--space-4);
    }

    .insight-label {
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      color: var(--color-primary-700);
      margin-bottom: var(--space-1);
    }

    .insight-text {
      font-size: var(--text-sm);
      color: var(--color-primary-800);
    }

    .insight-box.clickable {
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .insight-box.clickable:hover,
    .insight-box.clickable:focus {
      background: var(--color-primary-100);
      border-color: var(--color-primary-300);
      transform: translateY(-1px);
    }

    .insight-box.clickable:focus {
      outline: 2px solid var(--color-brand);
      outline-offset: 2px;
    }

    /* My Prospects Section */
    .prospect-section {
      background: linear-gradient(135deg, var(--color-brand-50) 0%, var(--color-bg-card) 100%);
      border: 2px solid var(--color-brand-200);
    }

    .prospect-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      margin-top: var(--space-3);
    }

    .prospect-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-2) var(--space-3);
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .prospect-item:hover {
      border-color: var(--color-brand-300);
      transform: translateX(2px);
    }

    .prospect-item-name {
      font-weight: var(--font-medium);
      color: var(--color-text-heading);
    }

    .prospect-item-meta {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
    }

    .prospect-item-badge {
      font-size: var(--text-xs);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-full);
      font-weight: var(--font-medium);
    }

    .prospect-item-badge.hot {
      background: var(--color-error-100);
      color: var(--color-error-700);
    }

    .prospect-item-badge.overdue {
      background: var(--color-warning-100);
      color: var(--color-warning-700);
    }

    .prospect-item-badge.stale {
      background: var(--color-gray-100);
      color: var(--color-gray-600);
    }

    .empty-state {
      text-align: center;
      padding: var(--space-4);
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
    }

    .section-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
      margin-top: var(--space-4);
    }

    @media (max-width: 768px) {
      .section-columns {
        grid-template-columns: 1fr;
      }
    }

    .column-header {
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      margin-bottom: var(--space-2);
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }
  </style>
</head>
<body>
  <div id="adcp-nav"></div>

  <div id="loading" class="loading">
    Loading...
  </div>

  <div id="content" style="display: none;">
    <div class="container">
      <div class="page-header">
        <h1>Dashboard</h1>
        <p class="subtitle">Tracking engagement, funnel health, and revenue</p>
      </div>

      <!-- MY PROSPECTS - Personal pipeline overview -->
      <div class="goal-section prospect-section" id="myProspectsSection" style="display: none;">
        <div class="goal-header clickable" onclick="window.location.href='/admin/prospects?mine=true'">
          <div class="goal-title-group">
            <span class="goal-icon">üéØ</span>
            <div>
              <div class="goal-title">My Prospects</div>
              <div class="goal-subtitle">Your personal pipeline and action items</div>
            </div>
          </div>
        </div>

        <div class="metrics-grid">
          <div class="hero-metric clickable" onclick="window.location.href='/admin/prospects?mine=true'">
            <div class="metric-value" id="myTotalProspects">-</div>
            <div class="metric-label">Total Owned</div>
          </div>
          <div class="metric-card clickable" onclick="window.location.href='/admin/prospects?mine=true&status=hot'">
            <div class="metric-value" id="myHotProspects">-</div>
            <div class="metric-label">Hot Prospects</div>
          </div>
          <div class="metric-card clickable" onclick="window.location.href='/admin/prospects?mine=true&status=followup'">
            <div class="metric-value" id="myFollowups">-</div>
            <div class="metric-label">Need Follow-up</div>
          </div>
        </div>

        <div class="section-columns">
          <div>
            <div class="column-header">üî• Hot Prospects</div>
            <div class="prospect-list" id="hotProspectsList">
              <div class="empty-state">No hot prospects</div>
            </div>
          </div>
          <div>
            <div class="column-header">‚è∞ Needs Attention</div>
            <div class="prospect-list" id="followupsList">
              <div class="empty-state">All caught up!</div>
            </div>
          </div>
        </div>
      </div>

      <!-- GOAL 1: ENGAGEMENT -->
      <div class="goal-section">
        <div class="goal-header clickable" onclick="window.location.href='/admin/insights'">
          <div class="goal-title-group">
            <span class="goal-icon">üí¨</span>
            <div>
              <div class="goal-title">Engagement</div>
              <div class="goal-subtitle">Are people participating and staying engaged?</div>
            </div>
          </div>
          <div class="trend-badge" id="engagementTrend">
            <span class="trend-arrow">-</span>
            <span class="trend-text">-</span>
          </div>
        </div>

        <div class="metrics-grid">
          <div class="metric-card clickable" onclick="window.location.href='/admin/users'">
            <div class="metric-value" id="activeUsers30d">-</div>
            <div class="metric-label">Active Users (30d)</div>
            <div class="metric-trend" id="activeUsersTrend">-</div>
          </div>
          <div class="metric-card clickable" onclick="window.location.href='/admin/analytics'">
            <div class="metric-value" id="messages30d">-</div>
            <div class="metric-label">Messages (30d)</div>
            <div class="metric-trend" id="messagesTrend">-</div>
          </div>
          <div class="metric-card clickable" onclick="window.location.href='/admin/insights'">
            <div class="metric-value" id="avgEngagement">-</div>
            <div class="metric-label">Avg Engagement Score</div>
          </div>
          <div class="metric-card clickable" onclick="window.location.href='/admin/insights'">
            <div class="metric-value" id="champions">-</div>
            <div class="metric-label">Champions</div>
          </div>
        </div>

        <div class="chart-section">
          <div class="chart-title">Slack Activity by Week</div>
          <div class="bar-chart" id="slackChart"></div>
        </div>

        <div class="insight-box clickable" onclick="window.location.href='/admin/addie'">
          <div class="insight-label">Addie Impact</div>
          <div class="insight-text">
            <span id="addieThreads30d">-</span> conversations this month
            (<span id="addieTrend">-</span> vs last month) ¬∑
            <span id="addieRating">-</span> avg rating
          </div>
        </div>
      </div>

      <!-- GOAL 2: FUNNEL -->
      <div class="goal-section">
        <div class="goal-header clickable" onclick="window.location.href='/admin/accounts'">
          <div class="goal-title-group">
            <span class="goal-icon">üìä</span>
            <div>
              <div class="goal-title">Funnel</div>
              <div class="goal-subtitle">Are prospects converting? Pipeline health?</div>
            </div>
          </div>
        </div>

        <div class="funnel">
          <div class="funnel-stage clickable" onclick="window.location.href='/admin/accounts?view=all'">
            <div class="funnel-value" id="totalOrgs">-</div>
            <div class="funnel-label">Total Orgs</div>
          </div>
          <span class="funnel-arrow" aria-hidden="true">‚Üí</span>
          <div class="funnel-stage clickable" onclick="window.location.href='/admin/accounts?view=hot'">
            <div class="funnel-value" id="prospects">-</div>
            <div class="funnel-label">Hot Prospects</div>
          </div>
          <span class="funnel-arrow" aria-hidden="true">‚Üí</span>
          <div class="funnel-stage active clickable" onclick="window.location.href='/admin/accounts?view=members'">
            <div class="funnel-value" id="payingOrgs">-</div>
            <div class="funnel-label">Members</div>
          </div>
        </div>

        <div class="two-col" style="margin-top: var(--space-4);">
          <div class="metric-card clickable" onclick="window.location.href='/admin/users'">
            <div class="metric-value" id="totalUsers">-</div>
            <div class="metric-label">Total Users</div>
          </div>
          <div class="metric-card clickable" onclick="window.location.href='/admin/billing'">
            <div class="metric-value" id="activeSubscriptions">-</div>
            <div class="metric-label">Active Subscriptions</div>
          </div>
        </div>

        <div class="insight-box clickable" id="accountsAttentionBox" onclick="window.location.href='/admin/accounts?view=needs_attention'" style="display: none;">
          <div class="insight-label">üìã Accounts Needing Attention</div>
          <div class="insight-text">
            <span id="needsAttentionCount">-</span> need attention ¬∑
            <span id="newInsightsCount">-</span> with new insights ¬∑
            <span id="goingColdCount">-</span> going cold
          </div>
        </div>
      </div>

      <!-- GOAL 3: REVENUE -->
      <div class="goal-section">
        <div class="goal-header clickable" onclick="window.location.href='/admin/billing'">
          <div class="goal-title-group">
            <span class="goal-icon">üí∞</span>
            <div>
              <div class="goal-title">Revenue</div>
              <div class="goal-subtitle">Is the business growing?</div>
            </div>
          </div>
          <div class="trend-badge" id="revenueTrend">
            <span class="trend-arrow">-</span>
            <span class="trend-text">-</span>
          </div>
        </div>

        <div class="metrics-grid">
          <div class="hero-metric clickable" onclick="window.location.href='/admin/billing'">
            <div class="metric-value" id="arr">-</div>
            <div class="metric-label">Annual Recurring Revenue</div>
          </div>
          <div class="metric-card clickable" onclick="window.location.href='/admin/billing'">
            <div class="metric-value" id="mrr">-</div>
            <div class="metric-label">Monthly Recurring</div>
          </div>
          <div class="metric-card clickable" onclick="window.location.href='/admin/products'">
            <div class="metric-value" id="bookings30d">-</div>
            <div class="metric-label">Bookings (30d)</div>
            <div class="metric-trend" id="bookingsCount">-</div>
          </div>
          <div class="metric-card clickable" onclick="window.location.href='/admin/analytics'">
            <div class="metric-value" id="monthlyRevenue">-</div>
            <div class="metric-label">This Month</div>
            <div class="metric-trend" id="monthlyTrend">-</div>
          </div>
        </div>

        <div class="chart-section">
          <div class="chart-title">Bookings by Month</div>
          <div class="bar-chart" id="bookingsChart"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize keyboard accessibility for all clickable elements
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.clickable[onclick]').forEach(function(el) {
        el.setAttribute('tabindex', '0');
        el.setAttribute('role', 'link');
        el.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            el.click();
          }
        });
      });
    });

    function formatNumber(num) {
      if (!num && num !== 0) return '-';
      return num.toLocaleString();
    }

    function formatCurrency(num) {
      if (!num && num !== 0) return '$0';
      if (num >= 1000) {
        return '$' + (num / 1000).toFixed(1) + 'k';
      }
      return '$' + num.toLocaleString();
    }

    function calculateTrend(current, previous) {
      if (previous === null || previous === undefined || previous === 0) {
        if (current === 0) {
          return { direction: 'neutral', percent: 0, text: 'No activity' };
        }
        return { direction: 'up', percent: 100, text: 'New activity' };
      }
      const change = ((current - previous) / previous) * 100;
      if (Math.abs(change) < 1) {
        return { direction: 'neutral', percent: 0, text: 'Flat' };
      }
      return {
        direction: change > 0 ? 'up' : 'down',
        percent: Math.abs(Math.round(change)),
        text: `${change > 0 ? '+' : ''}${Math.round(change)}% vs prior period`
      };
    }

    function renderTrendBadge(elementId, trend) {
      const el = document.getElementById(elementId);
      if (!el) return;

      el.className = `trend-badge ${trend.direction}`;
      const arrow = trend.direction === 'up' ? '‚Üë' : trend.direction === 'down' ? '‚Üì' : '‚Üí';
      el.innerHTML = `<span class="trend-arrow">${arrow}</span><span class="trend-text">${trend.percent}%</span>`;
    }

    function renderTrendText(elementId, current, previous) {
      const el = document.getElementById(elementId);
      if (!el) return;

      const trend = calculateTrend(current, previous);
      el.className = `metric-trend ${trend.direction}`;
      el.textContent = trend.text;
    }

    function renderBarChart(containerId, data, valueKey, labelKey, formatFn = formatNumber) {
      const container = document.getElementById(containerId);
      if (!container) return;

      if (!data || data.length === 0) {
        container.innerHTML = '<p style="color: var(--color-text-muted); font-size: var(--text-sm); text-align: center;">No data available</p>';
        return;
      }

      const maxValue = Math.max(...data.map(d => d[valueKey])) || 1;

      container.innerHTML = data.map((d, i) => {
        const heightPercent = (d[valueKey] / maxValue) * 100;
        return `
          <div class="bar-column">
            <div class="bar-value">${formatFn(d[valueKey])}</div>
            <div class="bar" style="height: ${Math.max(heightPercent, 4)}%"></div>
            <div class="bar-label">${d[labelKey]}</div>
          </div>
        `;
      }).join('');
    }

    async function loadStats() {
      try {
        const response = await fetch('/api/admin/stats');
        if (!response.ok) {
          if (response.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          throw new Error('Failed to load stats');
        }

        const stats = await response.json();
        const trends = stats.trends || {};

        // ENGAGEMENT
        document.getElementById('activeUsers30d').textContent = formatNumber(stats.slack_active_users_30d);
        document.getElementById('messages30d').textContent = formatNumber(trends.messages?.current || stats.slack_messages_7d * 4);
        document.getElementById('avgEngagement').textContent = stats.avg_engagement_score || '-';
        document.getElementById('champions').textContent = formatNumber(stats.champion_users);

        // Engagement trends
        if (trends.active_users) {
          renderTrendText('activeUsersTrend', trends.active_users.current, trends.active_users.previous);
          const engTrend = calculateTrend(trends.active_users.current, trends.active_users.previous);
          renderTrendBadge('engagementTrend', engTrend);
        }
        if (trends.messages) {
          renderTrendText('messagesTrend', trends.messages.current, trends.messages.previous);
        }

        // Addie insight
        document.getElementById('addieThreads30d').textContent = formatNumber(stats.addie_threads_30d);
        document.getElementById('addieRating').textContent = stats.addie_avg_rating || '-';
        if (trends.addie_threads) {
          const addieTrend = calculateTrend(trends.addie_threads.current, trends.addie_threads.previous);
          document.getElementById('addieTrend').textContent = addieTrend.text;
        }

        // FUNNEL
        document.getElementById('totalOrgs').textContent = formatNumber(stats.total_orgs);
        document.getElementById('prospects').textContent = formatNumber(stats.prospects);
        document.getElementById('engagedProspects').textContent = formatNumber(stats.engaged_prospects);
        document.getElementById('trials').textContent = formatNumber(stats.trials);
        document.getElementById('payingOrgs').textContent = formatNumber(stats.paying_orgs);
        document.getElementById('totalUsers').textContent = formatNumber(stats.total_users);
        document.getElementById('activeSubscriptions').textContent = formatNumber(stats.active_subscriptions);

        // REVENUE
        document.getElementById('arr').textContent = stats.arr || '$0';
        document.getElementById('mrr').textContent = stats.mrr || '$0';
        document.getElementById('bookings30d').textContent = stats.bookings_30d_revenue || '$0';
        document.getElementById('bookingsCount').textContent = `${formatNumber(stats.bookings_30d_count)} transactions`;
        document.getElementById('monthlyRevenue').textContent = stats.monthly_revenue || '$0';

        // Revenue trends
        if (trends.revenue) {
          renderTrendText('monthlyTrend', trends.revenue.current, trends.revenue.previous);
          const revTrend = calculateTrend(trends.revenue.current, trends.revenue.previous);
          renderTrendBadge('revenueTrend', revTrend);
        }

        // Charts
        if (stats.slack_trend) {
          const slackData = stats.slack_trend.map(d => ({
            ...d,
            week_label: new Date(d.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
          }));
          renderBarChart('slackChart', slackData, 'messages', 'week_label');
        }

        if (stats.bookings_trend) {
          renderBarChart('bookingsChart', stats.bookings_trend, 'revenue', 'month', formatCurrency);
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch (error) {
        console.error('Error loading stats:', error);
        document.getElementById('loading').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load admin data. <a href="/auth/login">Try logging in again</a></p>';
      }
    }

    async function loadMyProspects() {
      try {
        const response = await fetch('/api/admin/my-prospects');
        if (!response.ok) {
          // Silently fail - user might not have any prospects
          return;
        }

        const data = await response.json();

        // Only show section if user has prospects
        if (data.counts.total > 0) {
          document.getElementById('myProspectsSection').style.display = 'block';

          // Update counts
          document.getElementById('myTotalProspects').textContent = formatNumber(data.counts.total);
          document.getElementById('myHotProspects').textContent = formatNumber(data.counts.hot);
          document.getElementById('myFollowups').textContent = formatNumber(data.counts.followup);

          // Render hot prospects list
          const hotList = document.getElementById('hotProspectsList');
          if (data.hot_prospects.length > 0) {
            hotList.innerHTML = data.hot_prospects.map(p => `
              <div class="prospect-item" onclick="window.location.href='/admin/prospects/${p.org_id}'">
                <div>
                  <div class="prospect-item-name">${escapeHtml(p.name)}</div>
                  <div class="prospect-item-meta">Score: ${p.engagement_score || 0}</div>
                </div>
                <span class="prospect-item-badge hot">üî• Hot</span>
              </div>
            `).join('');
          }

          // Render followups list
          const followupList = document.getElementById('followupsList');
          if (data.needs_followup.length > 0) {
            followupList.innerHTML = data.needs_followup.map(p => {
              const isOverdue = p.reason === 'overdue';
              const badgeClass = isOverdue ? 'overdue' : 'stale';
              const badgeText = isOverdue ? '‚ö†Ô∏è Overdue' : `‚è∞ ${Math.round(p.days_since_activity)}d`;
              return `
                <div class="prospect-item" onclick="window.location.href='/admin/prospects/${p.org_id}'">
                  <div>
                    <div class="prospect-item-name">${escapeHtml(p.name)}</div>
                    <div class="prospect-item-meta">${isOverdue ? p.next_step || 'Action needed' : 'Last activity: ' + (p.last_activity ? new Date(p.last_activity).toLocaleDateString() : 'Never')}</div>
                  </div>
                  <span class="prospect-item-badge ${badgeClass}">${badgeText}</span>
                </div>
              `;
            }).join('');
          }
        }
      } catch (error) {
        console.error('Error loading my prospects:', error);
        // Don't show error to user - section will just stay hidden
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function loadAccountViewCounts() {
      try {
        const response = await fetch('/api/admin/accounts/view-counts');
        if (!response.ok) return;

        const counts = await response.json();
        const hasAttention = counts.needs_attention > 0 || counts.new_insights > 0 || counts.going_cold > 0;

        if (hasAttention) {
          document.getElementById('accountsAttentionBox').style.display = 'block';
          document.getElementById('needsAttentionCount').textContent = formatNumber(counts.needs_attention);
          document.getElementById('newInsightsCount').textContent = formatNumber(counts.new_insights);
          document.getElementById('goingColdCount').textContent = formatNumber(counts.going_cold);
        }
      } catch (error) {
        console.error('Error loading account counts:', error);
      }
    }

    loadStats();
    loadMyProspects();
    loadAccountViewCounts();
  </script>
</body>
</html>
