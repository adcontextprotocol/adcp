<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Admin - Events - AAO</title>
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <link rel="stylesheet" href="/design-system.css">
  <style>
    /* =============================================================================
       Admin Events styles
       Uses design system variables - see /design-system.css for tokens
       ============================================================================= */

    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-lg);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }
    h1 { margin-bottom: var(--space-2.5); color: var(--color-text-heading); }
    h2 { margin-bottom: var(--space-4); color: var(--color-text-heading); font-size: var(--text-xl); }
    .events-list {
      display: grid;
      gap: var(--space-3);
    }
    .event-item {
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-4);
    }
    .event-item:hover {
      border-color: var(--color-brand);
    }
    .event-info h3 {
      font-size: var(--text-base);
      margin-bottom: var(--space-1);
      color: var(--color-text-heading);
    }
    .event-meta {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      display: flex;
      gap: var(--space-2.5);
      flex-wrap: wrap;
      align-items: center;
    }
    .event-actions {
      display: flex;
      gap: var(--space-2);
      flex-shrink: 0;
    }
    .badge {
      display: inline-block;
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .badge-draft { background: var(--color-warning-100); color: var(--color-warning-700); }
    .badge-published { background: var(--color-success-100); color: var(--color-success-700); }
    .badge-cancelled { background: var(--color-error-100); color: var(--color-error-700); }
    .badge-completed { background: var(--color-gray-200); color: var(--color-gray-700); }
    .badge-in_person { background: var(--color-info-100); color: var(--color-info-700); }
    .badge-virtual { background: var(--color-primary-100); color: var(--color-primary-700); }
    .badge-hybrid { background: var(--color-purple-100, var(--color-primary-100)); color: var(--color-purple-700, var(--color-primary-700)); }
    .badge-invite { background: #fef3c7; color: #92400e; }
    .btn {
      padding: var(--space-2) var(--space-4);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .btn-small { padding: var(--space-1.5) var(--space-3); font-size: var(--text-xs); }
    .btn-primary { background: var(--color-brand); color: white; }
    .btn-primary:hover { background: var(--color-primary-700); }
    .btn-primary:disabled { background: var(--color-gray-400); cursor: not-allowed; }
    .btn-secondary { background: var(--color-gray-200); color: var(--color-text-heading); }
    .btn-secondary:hover { background: var(--color-gray-300); }
    .btn-danger { background: var(--color-error-500); color: white; }
    .btn-danger:hover { background: var(--color-error-600); }
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--color-surface-overlay);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: var(--space-5);
    }
    .modal {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-8);
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .form-group {
      margin-bottom: var(--space-5);
    }
    .form-group label {
      display: block;
      margin-bottom: var(--space-1);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      font-size: var(--text-sm);
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: var(--space-2.5);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-family: inherit;
    }
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--color-brand);
    }
    .form-group textarea {
      min-height: 100px;
    }
    .form-group small {
      display: block;
      margin-top: var(--space-1);
      color: var(--color-text-secondary);
      font-size: var(--text-xs);
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-5);
    }
    .form-row-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: var(--space-5);
    }
    .modal-buttons {
      display: flex;
      gap: var(--space-2.5);
      justify-content: flex-end;
      margin-top: var(--space-6);
      padding-top: var(--space-5);
      border-top: var(--border-1) solid var(--color-gray-200);
    }
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-5);
    }
    .subtitle {
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
    }
    .filter-bar {
      display: flex;
      gap: var(--space-2.5);
      margin-bottom: var(--space-5);
    }
    .filter-bar select {
      padding: var(--space-2) var(--space-3);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }
    .empty-state {
      text-align: center;
      padding: var(--space-10);
      color: var(--color-text-secondary);
    }
    .section-divider {
      margin: var(--space-6) 0;
      padding-top: var(--space-4);
      border-top: var(--border-1) solid var(--color-gray-200);
    }
    .section-title {
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      margin-bottom: var(--space-4);
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .checkbox-group input[type="checkbox"] {
      width: auto;
    }
    .checkbox-group label {
      margin-bottom: 0;
      font-weight: var(--font-normal);
    }
    .sponsorship-tiers {
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-top: var(--space-2);
    }
    .tier-item {
      display: flex;
      gap: var(--space-3);
      align-items: flex-start;
      padding: var(--space-3);
      background: var(--color-gray-50);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-2);
    }
    .tier-item:last-child {
      margin-bottom: 0;
    }
    .tier-item input {
      flex: 1;
      padding: var(--space-2);
      font-size: var(--text-sm);
    }
    .tier-item .tier-price {
      width: 120px;
    }
    .tier-item .tier-max {
      width: 80px;
    }
    .tier-item button {
      flex-shrink: 0;
    }
    .stats-row {
      display: flex;
      gap: var(--space-4);
      margin-top: var(--space-2);
    }
    .stat-item {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }
    .stat-value {
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
    }
    .event-group-section {
      margin-top: var(--space-4);
      padding: var(--space-4);
      background: var(--color-bg-subtle);
      border-radius: var(--radius-md);
      border: var(--border-1) solid var(--color-gray-200);
    }
    .event-group-section h4 {
      margin: 0 0 var(--space-2) 0;
      font-size: var(--text-sm);
      color: var(--color-text-heading);
    }
    .event-group-info {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
    }
    .event-group-stat {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }
    .slack-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      color: var(--color-brand);
      text-decoration: none;
      font-size: var(--text-sm);
    }
    .slack-link:hover {
      text-decoration: underline;
    }
    .badge-event-group {
      display: inline-block;
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
  </style>
</head>
<body>
  <!-- AAO top navigation -->
  <div id="adcp-nav"></div>

  <div id="loading" style="text-align: center; padding: var(--space-12); color: var(--color-text-secondary);">
    Loading...
  </div>

  <div id="content" style="display: none;">
    <div class="container">
      <div class="card">
        <div class="header-bar">
          <div>
            <h1>Events</h1>
            <p class="subtitle">Manage summits, meetups, webinars, and other events</p>
          </div>
          <button class="btn btn-primary" onclick="showCreateModal()">+ Add Event</button>
        </div>

        <div class="filter-bar">
          <select id="statusFilter" onchange="renderEventsList()">
            <option value="">All Statuses</option>
            <option value="draft">Draft</option>
            <option value="published">Published</option>
            <option value="cancelled">Cancelled</option>
            <option value="completed">Completed</option>
          </select>
          <select id="typeFilter" onchange="renderEventsList()">
            <option value="">All Types</option>
            <option value="summit">Summit</option>
            <option value="meetup">Meetup</option>
            <option value="webinar">Webinar</option>
            <option value="workshop">Workshop</option>
            <option value="conference">Conference</option>
            <option value="other">Other</option>
          </select>
          <select id="formatFilter" onchange="renderEventsList()">
            <option value="">All Formats</option>
            <option value="in_person">In Person</option>
            <option value="virtual">Virtual</option>
            <option value="hybrid">Hybrid</option>
          </select>
        </div>

        <div id="eventsList" class="events-list">
          Loading events...
        </div>
      </div>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <div id="eventModal" class="modal-overlay">
    <div class="modal">
      <h2 id="modalTitle">Add Event</h2>

      <form id="eventForm" onsubmit="saveEvent(event)">
        <input type="hidden" id="eventId">

        <!-- Basic Info -->
        <div class="form-group">
          <label>Title *</label>
          <input type="text" id="title" required placeholder="e.g., Agentic Advertising Summit 2026">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Slug *</label>
            <input type="text" id="slug" required placeholder="e.g., summit-2026">
            <small>URL path: /events/{slug}</small>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="status">
              <option value="draft">Draft</option>
              <option value="published">Published</option>
              <option value="cancelled">Cancelled</option>
              <option value="completed">Completed</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Event Type</label>
            <select id="eventType">
              <option value="summit">Summit</option>
              <option value="meetup">Meetup</option>
              <option value="webinar">Webinar</option>
              <option value="workshop">Workshop</option>
              <option value="conference">Conference</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Event Format</label>
            <select id="eventFormat" onchange="toggleLocationFields()">
              <option value="in_person">In Person</option>
              <option value="virtual">Virtual</option>
              <option value="hybrid">Hybrid</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Short Description</label>
          <input type="text" id="shortDescription" placeholder="Brief description for event cards">
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea id="description" placeholder="Full event description (supports markdown)"></textarea>
        </div>

        <!-- Date/Time -->
        <div class="section-divider">
          <div class="section-title">Date & Time</div>
        </div>

        <div class="form-row-3">
          <div class="form-group">
            <label>Start Date/Time *</label>
            <input type="datetime-local" id="startTime" required>
          </div>
          <div class="form-group">
            <label>End Date/Time</label>
            <input type="datetime-local" id="endTime">
          </div>
          <div class="form-group">
            <label>Timezone</label>
            <select id="timezone">
              <option value="America/New_York">Eastern Time</option>
              <option value="America/Chicago">Central Time</option>
              <option value="America/Denver">Mountain Time</option>
              <option value="America/Los_Angeles">Pacific Time</option>
              <option value="Europe/London">London</option>
              <option value="Europe/Paris">Paris</option>
              <option value="Asia/Tokyo">Tokyo</option>
              <option value="UTC">UTC</option>
            </select>
          </div>
        </div>

        <!-- Location (for in-person/hybrid) -->
        <div id="locationFields">
          <div class="section-divider">
            <div class="section-title">Location</div>
          </div>

          <div class="form-group">
            <label>Venue Name</label>
            <input type="text" id="venueName" placeholder="e.g., Convene NYC">
          </div>

          <div class="form-group">
            <label>Address</label>
            <input type="text" id="venueAddress" placeholder="Street address">
          </div>

          <div class="form-row-3">
            <div class="form-group">
              <label>City</label>
              <input type="text" id="venueCity" placeholder="City">
            </div>
            <div class="form-group">
              <label>State/Region</label>
              <input type="text" id="venueState" placeholder="State">
            </div>
            <div class="form-group">
              <label>Country</label>
              <input type="text" id="venueCountry" placeholder="Country">
            </div>
          </div>
        </div>

        <!-- Virtual Event -->
        <div id="virtualFields">
          <div class="section-divider">
            <div class="section-title">Virtual Event</div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Virtual Platform</label>
              <select id="virtualPlatform">
                <option value="">None</option>
                <option value="zoom">Zoom</option>
                <option value="google_meet">Google Meet</option>
                <option value="youtube_live">YouTube Live</option>
                <option value="teams">Microsoft Teams</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Virtual URL</label>
              <input type="url" id="virtualUrl" placeholder="Meeting/streaming link">
              <small>Hidden until user registers</small>
            </div>
          </div>
        </div>

        <!-- External Integration -->
        <div class="section-divider">
          <div class="section-title">External Links</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Luma Event ID</label>
            <input type="text" id="lumaEventId" placeholder="Optional: Luma event ID for sync">
          </div>
          <div class="form-group">
            <label>Luma Registration URL</label>
            <input type="url" id="lumaUrl" placeholder="https://lu.ma/...">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Featured Image URL</label>
            <input type="url" id="featuredImageUrl" placeholder="Image URL for event cards">
          </div>
          <div class="form-group">
            <label>Max Attendees</label>
            <input type="number" id="maxAttendees" placeholder="Leave empty for unlimited">
          </div>
        </div>

        <!-- Sponsorship -->
        <div class="section-divider">
          <div class="section-title">Sponsorship</div>
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="sponsorshipEnabled" onchange="toggleSponsorshipTiers()">
            <label for="sponsorshipEnabled">Enable sponsorships for this event</label>
          </div>
        </div>

        <div id="sponsorshipTiersSection" style="display: none;">
          <div class="form-group">
            <label>Sponsorship Tiers</label>
            <small style="display: block; margin-bottom: var(--space-2); color: var(--color-text-secondary);">
              Add tiers with prices. A Stripe product will be automatically created when you save.
            </small>
            <div id="sponsorshipTiers" class="sponsorship-tiers">
              <!-- Tiers added dynamically -->
            </div>
            <button type="button" class="btn btn-secondary btn-small" onclick="addSponsorshipTier()" style="margin-top: var(--space-2);">
              + Add Tier
            </button>
          </div>

          <div id="stripeProductInfo" style="display: none; margin-top: var(--space-4); padding: var(--space-3); background: var(--color-success-50); border: 1px solid var(--color-success-200); border-radius: var(--radius-md);">
            <span style="color: var(--color-success-700); font-size: var(--text-sm);">
              ✓ Stripe product linked: <code id="stripeProductDisplay" style="font-size: var(--text-xs);"></code>
            </span>
          </div>
        </div>

        <!-- Access Control -->
        <div class="section-divider">
          <div class="section-title">Access control</div>
        </div>

        <div class="form-group">
          <label for="visibility">Visibility</label>
          <select id="visibility" onchange="toggleAccessSection()">
            <option value="public">Public — anyone can see and register</option>
            <option value="invite_listed">Invite only, listed — shown in listings; registration restricted</option>
            <option value="invite_unlisted">Invite only, unlisted — hidden from public listing</option>
          </select>
        </div>

        <div id="accessRulesSection" style="display: none;">
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="membershipRequired">
              <label for="membershipRequired">Require AgenticAdvertising.org membership to register</label>
            </div>
          </div>
        </div>

        <!-- Invite list (only shown when editing an existing event with invite visibility) -->
        <div id="inviteListSection" style="display: none;">
          <div class="form-group">
            <label>Invite list</label>
            <small style="display: block; margin-bottom: var(--space-2); color: var(--color-text-secondary);">
              Add email addresses, one per line or comma-separated. All emails are automatically lowercased.
            </small>
            <textarea id="inviteEmails" placeholder="name@company.com&#10;another@company.com" rows="4"
              style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: var(--text-sm); resize: vertical;"></textarea>
            <button type="button" class="btn btn-secondary btn-small" onclick="addInvites()" style="margin-top: var(--space-2);">
              Add to invite list
            </button>
          </div>
          <div id="currentInvitesList" style="margin-top: var(--space-3);"></div>
        </div>

        <!-- Attendee Group (only shown when editing existing event) -->
        <div id="eventGroupSection" style="display: none;">
          <div class="section-divider">
            <div class="section-title">Attendee Group</div>
          </div>
          <p style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4);">
            Create a Slack channel for attendees to connect before, during, and after the event.
            Anyone who joins the channel is automatically added to the attendee group.
          </p>

          <div id="eventGroupExists" style="display: none;" class="event-group-section">
            <h4>Attendee Group Active</h4>
            <div class="event-group-info">
              <span class="event-group-stat">
                <strong id="eventGroupMemberCount">0</strong> members
              </span>
              <a id="eventGroupSlackLink" href="#" target="_blank" class="slack-link">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z"/></svg>
                <span id="eventGroupChannelName">#event-channel</span>
              </a>
              <button class="btn btn-secondary btn-small" onclick="viewEventGroupMembers()">View Members</button>
            </div>
          </div>

          <div id="eventGroupNotExists" style="display: none;">
            <button type="button" class="btn btn-primary" onclick="createEventGroup()">
              Create Attendee Group + Slack Channel
            </button>
            <p style="font-size: var(--text-xs); color: var(--color-text-muted); margin-top: var(--space-2);">
              This will create a public Slack channel for attendees to join.
            </p>
          </div>

          <div id="eventGroupLoading" style="display: none; color: var(--color-text-secondary); font-size: var(--text-sm);">
            Loading attendee group info...
          </div>
        </div>

        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="saveBtn">Save Event</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal-overlay">
    <div class="modal" style="max-width: 450px;">
      <h2>Delete Event</h2>
      <p style="margin: var(--space-5) 0; color: var(--color-text-secondary);">
        Are you sure you want to delete "<span id="deleteEventTitle"></span>"? This action cannot be undone.
      </p>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <script>
    let events = [];
    let editingEventId = null;
    let deletingEventId = null;
    let sponsorshipTierCount = 0;

    // Initialize
    async function init() {
      await loadEvents();
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
    }

    // Load events from API
    async function loadEvents() {
      try {
        const res = await fetch('/api/admin/events');
        if (!res.ok) throw new Error('Failed to load events');
        const data = await res.json();
        events = data.events || [];
        renderEventsList();
      } catch (error) {
        console.error('Error loading events:', error);
        document.getElementById('eventsList').innerHTML =
          '<div class="empty-state">Error loading events. Please refresh the page.</div>';
      }
    }

    // Render events list
    function renderEventsList() {
      const statusFilter = document.getElementById('statusFilter').value;
      const typeFilter = document.getElementById('typeFilter').value;
      const formatFilter = document.getElementById('formatFilter').value;

      let filtered = events;
      if (statusFilter) filtered = filtered.filter(e => e.status === statusFilter);
      if (typeFilter) filtered = filtered.filter(e => e.event_type === typeFilter);
      if (formatFilter) filtered = filtered.filter(e => e.event_format === formatFilter);

      // Sort by start_time descending
      filtered.sort((a, b) => new Date(b.start_time) - new Date(a.start_time));

      if (filtered.length === 0) {
        document.getElementById('eventsList').innerHTML =
          '<div class="empty-state">No events found. Click "Add Event" to create one.</div>';
        return;
      }

      document.getElementById('eventsList').innerHTML = filtered.map(event => {
        const startDate = new Date(event.start_time);
        const eventTimezone = event.timezone || 'America/New_York';
        const dateStr = startDate.toLocaleDateString('en-US', {
          weekday: 'short',
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          timeZone: eventTimezone
        });
        const timeStr = startDate.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          timeZone: eventTimezone
        });

        return `
          <div class="event-item">
            <div class="event-info">
              <h3>${escapeHtml(event.title)}</h3>
              <div class="event-meta">
                <span class="badge badge-${event.status}">${event.status}</span>
                <span class="badge badge-${event.event_format}">${event.event_format.replace('_', ' ')}</span>
                ${event.visibility && event.visibility !== 'public' ? `<span class="badge badge-invite">${event.visibility === 'invite_listed' ? 'invite only' : 'unlisted'}</span>` : ''}
                <span>${dateStr} at ${timeStr}</span>
                ${event.venue_city ? `<span>${escapeHtml(event.venue_city)}</span>` : ''}
              </div>
            </div>
            <div class="event-actions">
              <button class="btn btn-secondary btn-small" onclick="editEvent('${event.id}')">Edit</button>
              ${event.status === 'draft' ? `
                <button class="btn btn-primary btn-small" onclick="publishEvent('${event.id}')">Publish</button>
              ` : ''}
              <button class="btn btn-secondary btn-small" onclick="viewRegistrations('${event.id}')">Registrations</button>
              <button class="btn btn-danger btn-small" onclick="showDeleteModal('${event.id}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Show create modal
    function showCreateModal() {
      editingEventId = null;
      document.getElementById('modalTitle').textContent = 'Add Event';
      document.getElementById('eventForm').reset();
      document.getElementById('sponsorshipTiers').innerHTML = '';
      document.getElementById('stripeProductInfo').style.display = 'none';
      document.getElementById('eventGroupSection').style.display = 'none';
      sponsorshipTierCount = 0;
      toggleLocationFields();
      toggleSponsorshipTiers();
      toggleAccessSection();
      document.getElementById('eventModal').style.display = 'flex';
    }

    // Edit event
    async function editEvent(id) {
      editingEventId = id;
      const event = events.find(e => e.id === id);
      if (!event) return;

      document.getElementById('modalTitle').textContent = 'Edit Event';
      document.getElementById('eventId').value = event.id;
      document.getElementById('title').value = event.title || '';
      document.getElementById('slug').value = event.slug || '';
      document.getElementById('status').value = event.status || 'draft';
      document.getElementById('eventType').value = event.event_type || 'meetup';
      document.getElementById('eventFormat').value = event.event_format || 'in_person';
      document.getElementById('shortDescription').value = event.short_description || '';
      document.getElementById('description').value = event.description || '';

      // Date/time
      if (event.start_time) {
        const start = new Date(event.start_time);
        document.getElementById('startTime').value = formatDateTimeLocal(start);
      }
      if (event.end_time) {
        const end = new Date(event.end_time);
        document.getElementById('endTime').value = formatDateTimeLocal(end);
      }
      document.getElementById('timezone').value = event.timezone || 'America/New_York';

      // Location
      document.getElementById('venueName').value = event.venue_name || '';
      document.getElementById('venueAddress').value = event.venue_address || '';
      document.getElementById('venueCity').value = event.venue_city || '';
      document.getElementById('venueState').value = event.venue_state || '';
      document.getElementById('venueCountry').value = event.venue_country || '';

      // Virtual
      document.getElementById('virtualPlatform').value = event.virtual_platform || '';
      document.getElementById('virtualUrl').value = event.virtual_url || '';

      // External
      document.getElementById('lumaEventId').value = event.luma_event_id || '';
      document.getElementById('lumaUrl').value = event.luma_url || '';
      document.getElementById('featuredImageUrl').value = event.featured_image_url || '';
      document.getElementById('maxAttendees').value = event.max_attendees || '';

      // Sponsorship
      document.getElementById('sponsorshipEnabled').checked = event.sponsorship_enabled || false;
      toggleSponsorshipTiers();

      // Access control
      document.getElementById('visibility').value = event.visibility || 'public';
      document.getElementById('membershipRequired').checked = event.access_rules?.membership_required || false;
      toggleAccessSection();
      loadInvites(id);

      // Show Stripe product info if linked
      if (event.stripe_product_id) {
        document.getElementById('stripeProductInfo').style.display = 'block';
        document.getElementById('stripeProductDisplay').textContent = event.stripe_product_id;
      } else {
        document.getElementById('stripeProductInfo').style.display = 'none';
      }

      // Render sponsorship tiers
      document.getElementById('sponsorshipTiers').innerHTML = '';
      sponsorshipTierCount = 0;
      if (event.sponsorship_tiers && event.sponsorship_tiers.length > 0) {
        event.sponsorship_tiers.forEach(tier => addSponsorshipTier(tier));
      }

      toggleLocationFields();

      // Show event group section for existing events
      document.getElementById('eventGroupSection').style.display = 'block';
      loadEventGroupInfo(id);

      document.getElementById('eventModal').style.display = 'flex';
    }

    // Load event group info
    async function loadEventGroupInfo(eventId) {
      const section = document.getElementById('eventGroupSection');
      const exists = document.getElementById('eventGroupExists');
      const notExists = document.getElementById('eventGroupNotExists');
      const loading = document.getElementById('eventGroupLoading');

      // Show loading
      exists.style.display = 'none';
      notExists.style.display = 'none';
      loading.style.display = 'block';

      try {
        const res = await fetch(`/api/admin/events/${eventId}/event-group`);
        if (!res.ok) throw new Error('Failed to load event group');

        const data = await res.json();
        loading.style.display = 'none';

        if (data.event_group) {
          // Event group exists
          exists.style.display = 'block';
          document.getElementById('eventGroupMemberCount').textContent = data.member_count || 0;

          if (data.event_group.slack_channel_url) {
            document.getElementById('eventGroupSlackLink').href = data.event_group.slack_channel_url;
            document.getElementById('eventGroupChannelName').textContent =
              data.event_group.slack_channel_id ? `#${data.event_group.slug}` : 'Slack Channel';
          }
        } else {
          // No event group yet
          notExists.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading event group:', error);
        loading.style.display = 'none';
        notExists.style.display = 'block';
      }
    }

    // Create event group
    async function createEventGroup() {
      if (!editingEventId) return;

      const btn = document.querySelector('#eventGroupNotExists button');
      btn.disabled = true;
      btn.textContent = 'Creating...';

      try {
        const res = await fetch(`/api/admin/events/${editingEventId}/event-group`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ create_slack_channel: true })
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.message || 'Failed to create event group');
        }

        const data = await res.json();

        // Refresh the event group info
        await loadEventGroupInfo(editingEventId);

        if (data.slack_channel_created) {
          alert('Attendee group and Slack channel created! Share the channel link with attendees.');
        } else {
          alert('Attendee group created. Note: Slack channel could not be created automatically - you may need to create it manually.');
        }
      } catch (error) {
        alert(error.message);
        btn.disabled = false;
        btn.textContent = 'Create Attendee Group + Slack Channel';
      }
    }

    // View event group members
    function viewEventGroupMembers() {
      // Navigate to working groups admin filtered by this event group
      if (editingEventId) {
        window.open('/admin/working-groups?type=event', '_blank');
      }
    }

    // Save event
    async function saveEvent(e) {
      e.preventDefault();

      const eventData = {
        title: document.getElementById('title').value,
        slug: document.getElementById('slug').value,
        status: document.getElementById('status').value,
        event_type: document.getElementById('eventType').value,
        event_format: document.getElementById('eventFormat').value,
        short_description: document.getElementById('shortDescription').value || null,
        description: document.getElementById('description').value || null,
        start_time: new Date(document.getElementById('startTime').value).toISOString(),
        end_time: document.getElementById('endTime').value
          ? new Date(document.getElementById('endTime').value).toISOString()
          : null,
        timezone: document.getElementById('timezone').value,
        venue_name: document.getElementById('venueName').value || null,
        venue_address: document.getElementById('venueAddress').value || null,
        venue_city: document.getElementById('venueCity').value || null,
        venue_state: document.getElementById('venueState').value || null,
        venue_country: document.getElementById('venueCountry').value || null,
        virtual_platform: document.getElementById('virtualPlatform').value || null,
        virtual_url: document.getElementById('virtualUrl').value || null,
        luma_event_id: document.getElementById('lumaEventId').value || null,
        luma_url: document.getElementById('lumaUrl').value || null,
        featured_image_url: document.getElementById('featuredImageUrl').value || null,
        max_attendees: document.getElementById('maxAttendees').value
          ? parseInt(document.getElementById('maxAttendees').value)
          : null,
        sponsorship_enabled: document.getElementById('sponsorshipEnabled').checked,
        sponsorship_tiers: getSponsorshipTiers(),
        // stripe_product_id is auto-managed by the server when sponsorship_tiers are set
        visibility: document.getElementById('visibility').value,
        access_rules: {
          membership_required: document.getElementById('membershipRequired').checked || undefined,
        },
      };

      try {
        const url = editingEventId
          ? `/api/admin/events/${editingEventId}`
          : '/api/admin/events';
        const method = editingEventId ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(eventData)
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.message || 'Failed to save event');
        }

        await loadEvents();
        closeModal();
      } catch (error) {
        alert(error.message);
      }
    }

    // Publish event
    async function publishEvent(id) {
      if (!confirm('Publish this event? It will be visible on the public events page.')) return;

      try {
        const res = await fetch(`/api/admin/events/${id}/publish`, { method: 'POST' });
        if (!res.ok) throw new Error('Failed to publish event');
        await loadEvents();
      } catch (error) {
        alert(error.message);
      }
    }

    // View registrations
    function viewRegistrations(id) {
      // TODO: Navigate to registrations view
      alert('Registrations view coming soon');
    }

    // Delete modal
    function showDeleteModal(id) {
      deletingEventId = id;
      const event = events.find(e => e.id === id);
      document.getElementById('deleteEventTitle').textContent = event?.title || '';
      document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeDeleteModal() {
      deletingEventId = null;
      document.getElementById('deleteModal').style.display = 'none';
    }

    async function confirmDelete() {
      if (!deletingEventId) return;

      try {
        const res = await fetch(`/api/admin/events/${deletingEventId}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Failed to delete event');
        await loadEvents();
        closeDeleteModal();
      } catch (error) {
        alert(error.message);
      }
    }

    // Close modal
    function closeModal() {
      editingEventId = null;
      document.getElementById('eventModal').style.display = 'none';
      // Reset event group section
      document.getElementById('eventGroupSection').style.display = 'none';
      document.getElementById('eventGroupExists').style.display = 'none';
      document.getElementById('eventGroupNotExists').style.display = 'none';
      document.getElementById('eventGroupLoading').style.display = 'none';
      // Reset access control section
      document.getElementById('accessRulesSection').style.display = 'none';
      document.getElementById('inviteListSection').style.display = 'none';
      document.getElementById('currentInvitesList').innerHTML = '';
      document.getElementById('inviteEmails').value = '';
    }

    // Toggle location fields based on event format
    function toggleLocationFields() {
      const format = document.getElementById('eventFormat').value;
      const locationFields = document.getElementById('locationFields');
      const virtualFields = document.getElementById('virtualFields');

      if (format === 'virtual') {
        locationFields.style.display = 'none';
        virtualFields.style.display = 'block';
      } else if (format === 'in_person') {
        locationFields.style.display = 'block';
        virtualFields.style.display = 'none';
      } else {
        locationFields.style.display = 'block';
        virtualFields.style.display = 'block';
      }
    }

    // Toggle sponsorship tiers section
    function toggleSponsorshipTiers() {
      const enabled = document.getElementById('sponsorshipEnabled').checked;
      document.getElementById('sponsorshipTiersSection').style.display = enabled ? 'block' : 'none';
    }

    // Toggle access rules and invite sections based on visibility
    function toggleAccessSection() {
      const visibility = document.getElementById('visibility').value;
      const isInviteOnly = visibility !== 'public';
      document.getElementById('accessRulesSection').style.display = isInviteOnly ? 'block' : 'none';
      // Invite list only shown when editing an existing event
      if (isInviteOnly && editingEventId) {
        document.getElementById('inviteListSection').style.display = 'block';
      } else {
        document.getElementById('inviteListSection').style.display = 'none';
      }
    }

    // Load existing invites for an event
    async function loadInvites(eventId) {
      const visibility = document.getElementById('visibility').value;
      if (visibility === 'public') return;

      document.getElementById('inviteListSection').style.display = 'block';
      document.getElementById('currentInvitesList').innerHTML = '<p style="font-size: var(--text-sm); color: var(--color-text-secondary);">Loading...</p>';

      try {
        const res = await fetch(`/api/admin/events/${eventId}/invites`);
        if (!res.ok) throw new Error('Failed to load invites');
        const data = await res.json();
        renderInviteList(data.invites || []);
      } catch (error) {
        document.getElementById('currentInvitesList').innerHTML = '';
      }
    }

    // Render invite list
    function renderInviteList(invites) {
      const container = document.getElementById('currentInvitesList');
      if (invites.length === 0) {
        container.innerHTML = '<p style="font-size: var(--text-sm); color: var(--color-text-secondary);">No invites yet.</p>';
        return;
      }
      container.innerHTML = `
        <label style="display: block; margin-bottom: var(--space-2); font-weight: 500;">Current invite list (${invites.length})</label>
        <div style="border: 1px solid var(--color-border); border-radius: var(--radius-md); overflow: hidden;">
          ${invites.map(invite => `
            <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-2) var(--space-3); border-bottom: 1px solid var(--color-border-subtle); font-size: var(--text-sm);">
              <span>${escapeHtml(invite.email)}</span>
              <button type="button" class="btn btn-secondary btn-small" data-email="${escapeHtml(invite.email)}" onclick="removeInvite(this.dataset.email)" style="font-size: var(--text-xs); padding: 2px 8px;">Remove</button>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Add invites from textarea
    async function addInvites() {
      if (!editingEventId) return;
      const raw = document.getElementById('inviteEmails').value.trim();
      if (!raw) return;

      // Support newline or comma-separated emails
      const emails = raw.split(/[\n,]+/).map(e => e.trim()).filter(e => e.includes('@'));
      if (emails.length === 0) {
        alert('No valid email addresses found.');
        return;
      }

      try {
        const res = await fetch(`/api/admin/events/${editingEventId}/invites`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ emails }),
        });
        if (!res.ok) throw new Error('Failed to add invites');
        const data = await res.json();
        document.getElementById('inviteEmails').value = '';
        await loadInvites(editingEventId);
      } catch (error) {
        alert(error.message);
      }
    }

    // Remove a single invite
    async function removeInvite(email) {
      if (!editingEventId) return;
      if (!confirm(`Remove ${email} from the invite list?`)) return;

      try {
        const res = await fetch(`/api/admin/events/${editingEventId}/invites/${encodeURIComponent(email)}`, {
          method: 'DELETE',
        });
        if (!res.ok) throw new Error('Failed to remove invite');
        await loadInvites(editingEventId);
      } catch (error) {
        alert(error.message);
      }
    }

    // Add sponsorship tier
    function addSponsorshipTier(tier = null) {
      sponsorshipTierCount++;
      const tierId = tier?.tier_id || `tier_${sponsorshipTierCount}`;
      const tierHtml = `
        <div class="tier-item" id="tier_${sponsorshipTierCount}">
          <input type="text" class="tier-name" placeholder="Tier name (e.g., Gold)" value="${escapeHtml(tier?.name || '')}">
          <input type="number" class="tier-price" placeholder="Price (cents)" value="${tier?.price_cents || ''}">
          <input type="number" class="tier-max" placeholder="Max" value="${tier?.max_sponsors || ''}" title="Max sponsors">
          <input type="hidden" class="tier-id" value="${tierId}">
          <button type="button" class="btn btn-danger btn-small" onclick="removeSponsorshipTier(${sponsorshipTierCount})">X</button>
        </div>
      `;
      document.getElementById('sponsorshipTiers').insertAdjacentHTML('beforeend', tierHtml);
    }

    // Remove sponsorship tier
    function removeSponsorshipTier(num) {
      document.getElementById(`tier_${num}`).remove();
    }

    // Get sponsorship tiers from form
    function getSponsorshipTiers() {
      const tiers = [];
      const tierItems = document.querySelectorAll('.tier-item');
      tierItems.forEach(item => {
        const name = item.querySelector('.tier-name').value;
        const price = item.querySelector('.tier-price').value;
        const tierId = item.querySelector('.tier-id').value;
        const maxSponsors = item.querySelector('.tier-max').value;
        if (name && price) {
          tiers.push({
            tier_id: tierId,
            name,
            price_cents: parseInt(price),
            max_sponsors: maxSponsors ? parseInt(maxSponsors) : null,
            benefits: []
          });
        }
      });
      return tiers;
    }

    // Format date for datetime-local input
    function formatDateTimeLocal(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // Escape HTML
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
