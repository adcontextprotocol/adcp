<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brand Registry - AdCP</title>
    <link rel="stylesheet" href="/design-system.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-sans);
            line-height: var(--leading-normal);
            color: var(--color-text-body);
            background: var(--color-bg-page);
            padding-top: var(--nav-height);
        }
        header {
            background: linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-primary-700) 100%);
            color: white;
            padding: var(--space-8) 0;
            text-align: center;
        }
        h1 { font-size: var(--text-4xl); margin-bottom: var(--space-2); }
        .subtitle { font-size: var(--text-lg); opacity: 0.9; }
        .container { max-width: var(--container-2xl); margin: var(--space-8) auto; padding: 0 var(--space-4); }

        /* MCP Banner */
        .mcp-banner {
            background: linear-gradient(135deg, var(--color-primary-50) 0%, var(--color-primary-100) 100%);
            border: 1px solid var(--color-primary-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4) var(--space-6);
            margin-bottom: var(--space-8);
            display: flex;
            align-items: center;
            gap: var(--space-4);
            flex-wrap: wrap;
        }
        .mcp-banner__badge {
            background: var(--gradient-primary-dark);
            color: white;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-md);
            font-size: var(--text-xs);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .mcp-banner__text {
            flex: 1;
            min-width: 200px;
        }
        .mcp-banner__title {
            font-weight: var(--font-semibold);
            color: var(--color-text-heading);
        }
        .mcp-banner__desc {
            font-size: var(--text-sm);
            color: var(--color-text-muted);
        }
        .mcp-banner__code {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-2) var(--space-3);
            font-family: var(--font-mono);
            font-size: var(--text-xs);
            color: var(--color-primary-700);
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: var(--space-8);
            background: var(--color-bg-card);
            padding: var(--space-5) var(--space-6);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-8);
            flex-wrap: wrap;
        }
        .stats-bar .stat {
            text-align: center;
        }
        .stats-bar .stat span {
            display: block;
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--color-text-heading);
            line-height: var(--leading-tight);
        }
        .stats-bar .stat-label {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Search and Filters */
        .search-filters {
            background: var(--color-bg-card);
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-8);
            box-shadow: var(--shadow-sm);
        }
        .search-box { margin-bottom: var(--space-4); }
        .search-box input {
            width: 100%;
            padding: var(--space-3);
            border: var(--border-2) solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--text-base);
        }
        .search-box input:focus { outline: none; border-color: var(--color-primary-500); }
        .filter-row { display: flex; gap: var(--space-4); flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; gap: var(--space-2); flex-wrap: wrap; align-items: center; }
        .filter-group label { font-weight: var(--font-semibold); font-size: var(--text-sm); color: var(--color-text-muted); }
        .filter-btn {
            padding: var(--space-2) var(--space-4);
            background: var(--color-gray-50);
            border: var(--border-2) solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--text-sm);
            transition: var(--transition-all);
        }
        .filter-btn:hover { border-color: var(--color-primary-500); color: var(--color-primary-500); }
        .filter-btn.active { background: var(--color-primary-500); border-color: var(--color-primary-500); color: white; }

        /* Brand Grid */
        .brand-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: var(--space-6); }
        .brand-card {
            background: var(--color-bg-card);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            box-shadow: var(--shadow-sm);
            transition: var(--transition-all);
            text-decoration: none;
            color: inherit;
            display: block;
            border: 1px solid var(--color-border);
            cursor: pointer;
            position: relative;
        }
        .brand-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); border-color: var(--color-primary-300); }

        /* Card header: logo + name/domain + source badge */
        .brand-card__header {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }

        /* Logo container */
        .brand-card__logo {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: var(--radius-md);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .brand-card__logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .brand-card__logo-letter {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-lg);
            font-weight: var(--font-bold);
            color: white;
            text-transform: uppercase;
            line-height: 1;
        }

        /* Identity block (name + domain) */
        .brand-card__identity {
            flex: 1;
            min-width: 0;
        }
        .brand-card__name {
            font-size: var(--text-base);
            font-weight: var(--font-semibold);
            color: var(--color-text-heading);
            line-height: var(--leading-tight);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .brand-card__domain {
            font-size: var(--text-sm);
            color: var(--color-text-muted);
            margin-top: var(--space-0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Source badge */
        .brand-card__source {
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: var(--font-semibold);
            white-space: nowrap;
            flex-shrink: 0;
        }
        .brand-card__source--valid { background: var(--color-success-100); color: var(--color-success-700); }
        .brand-card__source--neutral { background: var(--color-gray-100); color: var(--color-gray-600); }

        /* Details row: industry, keller type, color dot */
        .brand-card__details {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex-wrap: wrap;
            font-size: var(--text-sm);
            color: var(--color-text-muted);
        }
        .brand-card__detail-item {
            display: flex;
            align-items: center;
            gap: var(--space-1.5);
        }
        .brand-card__color-dot {
            width: 14px;
            height: 14px;
            min-width: 14px;
            border-radius: var(--radius-full);
            border: 1px solid var(--color-border-strong);
            display: inline-block;
        }
        .brand-card__tag {
            display: inline-block;
            padding: var(--space-0.5) var(--space-2);
            background: var(--color-primary-50);
            color: var(--color-primary-700);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
        }
        .brand-card__separator {
            color: var(--color-border-strong);
            font-size: var(--text-xs);
        }

        /* Meta row: manifest, verified, house domain */
        .brand-card__meta {
            display: flex;
            gap: var(--space-4);
            flex-wrap: wrap;
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 1px solid var(--color-border);
        }
        .brand-card__meta-item {
            display: flex;
            align-items: center;
            gap: var(--space-1.5);
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        .brand-card__meta-icon {
            font-size: var(--text-sm);
            line-height: 1;
        }

        /* Add Brand CTA */
        .add-brand-cta {
            text-align: center;
            margin-top: var(--space-6);
        }
        .add-brand-cta button {
            padding: var(--space-3) var(--space-6);
            background: var(--color-primary-500);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            cursor: pointer;
            transition: var(--transition-all);
        }
        .add-brand-cta button:hover { background: var(--color-primary-600); }

        .hidden { display: none; }

        .loading { text-align: center; padding: var(--space-12); color: var(--color-text-muted); }
        .empty-state { text-align: center; padding: var(--space-12); color: var(--color-text-muted); }
        .empty-state__title { font-size: var(--text-xl); font-weight: var(--font-semibold); margin-bottom: var(--space-2); }
        .empty-state__desc { font-size: var(--text-base); }

        /* Skeleton animation */
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .skeleton-bg { background: linear-gradient(90deg, var(--color-bg-subtle) 25%, var(--color-border) 50%, var(--color-bg-subtle) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }

        @media (max-width: 768px) {
            .brand-grid { grid-template-columns: 1fr; }
            .mcp-banner { flex-direction: column; text-align: center; }
            .stats-bar { gap: var(--space-4); padding: var(--space-4); }
        }
    </style>
</head>
<body>
    <!-- Navigation (loaded by nav.js) -->
    <div id="adcp-nav"></div>
    <script src="/nav.js"></script>

    <header>
        <h1>Brand registry</h1>
        <p class="subtitle">Discover brand identities and brand.json manifests</p>
    </header>

    <div class="container">
        <!-- MCP Banner -->
        <div class="mcp-banner">
            <span class="mcp-banner__badge">MCP</span>
            <div class="mcp-banner__text">
                <div class="mcp-banner__title">Access via MCP</div>
                <div class="mcp-banner__desc">Use <code>list_brands</code> tool or <code>brands://all</code> resource</div>
            </div>
            <code class="mcp-banner__code">https://agenticadvertising.org/mcp</code>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat"><span id="stat-total">0</span> <div class="stat-label">Total</div></div>
            <div class="stat"><span id="stat-houses">0</span> <div class="stat-label">Houses</div></div>
            <div class="stat"><span id="stat-sub-brands">0</span> <div class="stat-label">Sub-brands</div></div>
            <div class="stat"><span id="stat-manifest">0</span> <div class="stat-label">With manifest</div></div>
            <div class="stat"><span id="stat-brand-json">0</span> <div class="stat-label">brand.json</div></div>
        </div>

        <!-- Search and Filters -->
        <div class="search-filters">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search by brand name or domain..." oninput="onSearchInput()">
            </div>
            <div class="filter-row">
                <div class="filter-group">
                    <label>Type:</label>
                    <button class="filter-btn" data-filter="all" onclick="setFilter('all')">All</button>
                    <button class="filter-btn active" data-filter="house" onclick="setFilter('house')">Houses</button>
                    <button class="filter-btn" data-filter="sub_brand" onclick="setFilter('sub_brand')">Sub-brands</button>
                    <button class="filter-btn" data-filter="brand_json" onclick="setFilter('brand_json')">brand.json</button>
                </div>
            </div>
        </div>

        <!-- Brand Grid -->
        <div id="brands-grid" class="brand-grid">
            <div class="loading">Loading brands...</div>
        </div>

        <!-- Add Brand CTA (hidden by default, shown for members) -->
        <div id="add-brand-cta" class="add-brand-cta hidden">
            <button onclick="window.location.href='/brand/view/new?edit=true'">+ Add brand</button>
        </div>
    </div>

    <!-- Footer placeholder -->
    <div id="adcp-footer"></div>

    <script type="module">
        let brands = [];
        let filters = { type: 'house' };

        window.addEventListener('DOMContentLoaded', async () => {
            await loadBrands();
        });

        let activeController = null;
        async function loadBrands(search) {
            if (activeController) activeController.abort();
            activeController = new AbortController();

            const grid = document.getElementById('brands-grid');
            grid.innerHTML = renderLoadingSkeleton(6);

            try {
                const params = new URLSearchParams();
                if (search) params.set('search', search);
                const qs = params.toString();
                const response = await fetch(`/api/brands/registry${qs ? '?' + qs : ''}`, { signal: activeController.signal });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                brands = data.brands || [];

                // Update stats
                const stats = data.stats || {};
                document.getElementById('stat-total').textContent = stats.total || brands.length;
                document.getElementById('stat-houses').textContent = stats.houses || 0;
                document.getElementById('stat-sub-brands').textContent = stats.sub_brands || 0;
                document.getElementById('stat-manifest').textContent = stats.with_manifest || 0;
                document.getElementById('stat-brand-json').textContent = stats.brand_json || 0;

                renderBrands();
            } catch (error) {
                if (error.name === 'AbortError') return;
                console.error('Failed to load brands:', error);
                grid.innerHTML = '<div class="empty-state"><div class="empty-state__title">Failed to load brands</div></div>';
            }

            // Show add CTA for members
            const config = window.__APP_CONFIG__;
            if (config?.user?.isMember) {
                const cta = document.getElementById('add-brand-cta');
                if (cta) cta.classList.remove('hidden');
            }
        }

        function renderLoadingSkeleton(count = 6) {
            return Array(count).fill(0).map(() => `
                <div class="brand-card" style="pointer-events: none; opacity: 0.6;">
                    <div class="brand-card__header">
                        <div class="skeleton-bg" style="width: 40px; height: 40px; border-radius: var(--radius-md); flex-shrink: 0;"></div>
                        <div style="flex: 1; min-width: 0;">
                            <div class="skeleton-bg" style="height: 16px; border-radius: var(--radius-sm); width: 60%; margin-bottom: var(--space-2);"></div>
                            <div class="skeleton-bg" style="height: 12px; border-radius: var(--radius-sm); width: 40%;"></div>
                        </div>
                        <div class="skeleton-bg" style="height: 22px; width: 70px; border-radius: var(--radius-full);"></div>
                    </div>
                    <div class="brand-card__details" style="margin-top: var(--space-2);">
                        <div class="skeleton-bg" style="height: 14px; border-radius: var(--radius-sm); width: 80px;"></div>
                        <div class="skeleton-bg" style="height: 14px; border-radius: var(--radius-sm); width: 60px;"></div>
                    </div>
                </div>
            `).join('');
        }

        function safeHex(color) {
            if (!color) return null;
            return /^#[0-9A-Fa-f]{6}$/.test(color) ? color : null;
        }

        function renderBrands() {
            const grid = document.getElementById('brands-grid');
            const filtered = brands.filter(brand => {
                if (filters.type === 'house' && brand.keller_type !== 'master' && brand.keller_type !== 'independent') return false;
                if (filters.type === 'sub_brand' && brand.keller_type !== 'sub_brand' && brand.keller_type !== 'endorsed') return false;
                if (filters.type === 'brand_json' && brand.source !== 'brand_json' && brand.source !== 'hosted') return false;
                return true;
            });

            if (filtered.length === 0) {
                const msg = brands.length === 0 ? 'No brands registered yet.' : 'No brands found matching your filters.';
                grid.innerHTML = `<div class="empty-state"><div class="empty-state__title">${msg}</div></div>`;
                return;
            }

            grid.innerHTML = filtered.map(brand => {
                const sourceLabel = {
                    'brand_json': 'brand.json',
                    'hosted': 'brand.json',
                    'community': 'Community',
                    'enriched': 'Community',
                }[brand.source] || brand.source;

                const sourceClass = (brand.source === 'brand_json' || brand.source === 'hosted') ? 'brand-card__source--valid' : 'brand-card__source--neutral';
                const displayName = escapeHtml(brand.brand_name || brand.domain);
                const firstLetter = (brand.brand_name || brand.domain || '?').charAt(0);
                const validColor = safeHex(brand.primary_color);

                // Logo or letter fallback
                const logoHtml = brand.logo_url
                    ? `<div class="brand-card__logo"><img src="${escapeHtml(brand.logo_url)}" alt="" loading="lazy"></div>`
                    : `<div class="brand-card__logo-letter" style="background: ${validColor || 'var(--color-primary-500)'};">${escapeHtml(firstLetter)}</div>`;

                // Details: industry, keller type, color dot
                const detailParts = [];
                if (brand.industry) {
                    detailParts.push(`<span class="brand-card__detail-item">${escapeHtml(brand.industry)}</span>`);
                }
                if (brand.keller_type) {
                    detailParts.push(`<span class="brand-card__tag">${escapeHtml(brand.keller_type)}</span>`);
                }
                if (validColor) {
                    detailParts.push(`<span class="brand-card__detail-item"><span class="brand-card__color-dot" style="background: ${validColor};" title="${validColor}"></span></span>`);
                }

                const detailsHtml = detailParts.length > 0
                    ? `<div class="brand-card__details">${detailParts.join('<span class="brand-card__separator">&middot;</span>')}</div>`
                    : '';

                // Meta row: manifest, verified, house domain, sub-brands
                const metaParts = [];
                if (brand.has_manifest) {
                    metaParts.push('<span class="brand-card__meta-item"><span class="brand-card__meta-icon">&#x1F4CB;</span> Manifest</span>');
                }
                if (brand.verified) {
                    metaParts.push('<span class="brand-card__meta-item"><span class="brand-card__meta-icon">&#x2713;</span> Verified</span>');
                }
                if (brand.sub_brand_count > 0) {
                    metaParts.push(`<span class="brand-card__meta-item"><span class="brand-card__meta-icon">&#x1F517;</span> ${brand.sub_brand_count} sub-brand${brand.sub_brand_count === 1 ? '' : 's'}</span>`);
                }
                if (brand.house_domain) {
                    metaParts.push(`<span class="brand-card__meta-item"><span class="brand-card__meta-icon">&#x1F3E0;</span> ${escapeHtml(brand.house_domain)}</span>`);
                }

                const metaHtml = metaParts.length > 0
                    ? `<div class="brand-card__meta">${metaParts.join('')}</div>`
                    : '';

                return `
                    <div class="brand-card" onclick="window.location.href='/brand/view/${encodeURIComponent(brand.domain)}'">
                        <div class="brand-card__header">
                            ${logoHtml}
                            <div class="brand-card__identity">
                                <div class="brand-card__name">${displayName}</div>
                                <div class="brand-card__domain">${escapeHtml(brand.domain)}</div>
                            </div>
                            <span class="brand-card__source ${sourceClass}">
                                ${escapeHtml(sourceLabel)}
                            </span>
                        </div>
                        ${detailsHtml}
                        ${metaHtml}
                    </div>
                `;
            }).join('');
        }

        window.setFilter = function(type) {
            filters.type = type;
            document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === type);
            });
            renderBrands();
        };

        let searchTimeout = null;
        window.onSearchInput = function() {
            clearTimeout(searchTimeout);
            const value = document.getElementById('search-input').value.trim();
            searchTimeout = setTimeout(() => loadBrands(value || undefined), 300);
        };

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
    </script>
</body>
</html>
