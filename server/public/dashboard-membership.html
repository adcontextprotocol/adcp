<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Membership - Dashboard</title>
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <link rel="stylesheet" href="/design-system.css">
  <script src="/nav.js"></script>
  <script src="/dashboard-nav.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <style>
    body {
      margin: 0;
      background: var(--color-bg-page);
    }

    /* Profile collection modal */
    .profile-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--color-surface-overlay);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .profile-modal {
      background: var(--color-bg-card);
      border-radius: 12px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-xl);
    }

    .profile-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--color-border);
    }

    .profile-modal-header h2 {
      margin: 0;
      font-size: 18px;
      color: var(--color-text-heading);
    }

    .profile-modal-header p {
      margin: 8px 0 0 0;
      font-size: 14px;
      color: var(--color-text-secondary);
    }

    .profile-modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .profile-form-group {
      margin-bottom: 20px;
    }

    .profile-form-group:last-child {
      margin-bottom: 0;
    }

    .profile-form-group label {
      display: block;
      font-weight: 600;
      color: var(--color-text-heading);
      margin-bottom: 8px;
      font-size: 14px;
    }

    .profile-form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      font-size: 14px;
      color: var(--color-text-primary);
      background: var(--color-bg-card);
      cursor: pointer;
    }

    .profile-form-group select:focus {
      outline: none;
      border-color: var(--color-brand);
      box-shadow: 0 0 0 3px var(--color-primary-100);
    }

    .profile-modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--color-border);
      display: flex;
      justify-content: flex-end;
    }

    .radio-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .radio-option {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .radio-option:hover {
      border-color: var(--color-brand);
      background: var(--color-primary-50);
    }

    .radio-option.selected {
      border-color: var(--color-brand);
      background: var(--color-primary-100);
    }

    .radio-option input[type="radio"] {
      margin-top: 2px;
      cursor: pointer;
    }

    .radio-option-content {
      flex: 1;
    }

    .radio-option-title {
      font-weight: 500;
      color: var(--color-text-heading);
      font-size: 14px;
    }

    .radio-option-desc {
      font-size: 13px;
      color: var(--color-text-secondary);
      margin-top: 2px;
    }

    /* Mobile responsive styles for profile modal */
    @media (max-width: 480px) {
      .profile-modal-overlay {
        padding: 0;
        align-items: stretch;
      }

      .profile-modal {
        max-width: 100%;
        border-radius: 0;
        max-height: 100dvh;
        height: 100%;
        padding-top: env(safe-area-inset-top, 0);
        padding-bottom: env(safe-area-inset-bottom, 0);
      }

      .profile-modal-header {
        padding: 16px;
      }

      .profile-modal-header h2 {
        font-size: 16px;
      }

      .profile-modal-header p {
        font-size: 13px;
      }

      .profile-modal-body {
        padding: 16px;
      }

      .radio-option {
        padding: 10px;
        gap: 8px;
      }

      .radio-option-title {
        font-size: 13px;
      }

      .radio-option-desc {
        font-size: 12px;
      }

      .profile-modal-footer {
        padding: 12px 16px;
      }
    }

    .page-header {
      padding: 32px 40px 24px;
      border-bottom: 1px solid var(--color-border);
      background: var(--color-bg-card);
    }

    .page-header h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      color: var(--color-text-heading);
    }

    .page-header p {
      margin: 0;
      color: var(--color-text-secondary);
      font-size: 14px;
    }

    .page-content {
      padding: 32px 40px;
      max-width: 900px;
    }

    .billing-card {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      margin-bottom: 24px;
      overflow: hidden;
    }

    .billing-card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--color-border);
      background: var(--color-bg-subtle);
    }

    .billing-card-header h2 {
      margin: 0;
      font-size: 16px;
      color: var(--color-text-heading);
    }

    .billing-card-body {
      padding: 24px;
    }

    /* Subscription status */
    .subscription-status {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .subscription-status.active {
      background: var(--color-success-50);
      border: 1px solid var(--color-success-200);
    }

    .subscription-status.inactive {
      background: var(--color-gray-50);
      border: 1px solid var(--color-gray-200);
    }

    .subscription-status.past_due {
      background: var(--color-warning-50);
      border: 1px solid var(--color-warning-200);
    }

    .subscription-icon {
      font-size: 32px;
      flex-shrink: 0;
    }

    .subscription-info h3 {
      margin: 0 0 4px 0;
      font-size: 16px;
      font-weight: 600;
    }

    .subscription-info p {
      margin: 0;
      font-size: 14px;
      color: var(--color-text-secondary);
    }

    .subscription-status.active .subscription-info h3 {
      color: var(--color-success-700);
    }

    .subscription-status.past_due .subscription-info h3 {
      color: var(--color-warning-700);
    }

    /* Membership promo */
    .membership-promo {
      background: linear-gradient(135deg, var(--color-brand) 0%, var(--color-primary-600) 100%);
      border-radius: 12px;
      padding: 32px;
      color: white;
      margin-bottom: 24px;
    }

    .membership-promo h2 {
      margin: 0 0 12px 0;
      font-size: 24px;
      color: white;
    }

    .membership-promo p {
      margin: 0 0 20px 0;
      opacity: 0.9;
      font-size: 15px;
      line-height: 1.6;
    }

    .membership-promo a {
      color: white;
      text-decoration: underline;
    }

    /* Benefits list in promo */
    .membership-benefits {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .membership-benefits-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .membership-benefits-list li {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 6px 0;
      font-size: 14px;
      opacity: 0.95;
    }

    .membership-benefits-list li::before {
      content: '\2713';
      color: var(--color-success-500);
      font-weight: bold;
      flex-shrink: 0;
    }

    /* Member benefits card (for existing members) - matches public page style */
    .member-benefits-card {
      background: linear-gradient(135deg, var(--color-success-50) 0%, var(--color-success-100) 100%);
      border: 2px solid var(--color-success-500);
      border-radius: var(--radius-lg);
      padding: var(--space-8);
      margin-bottom: var(--space-6);
      text-align: center;
    }

    .member-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      background: var(--color-success-600);
      color: white;
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-full);
      font-size: var(--text-lg);
      font-weight: var(--font-bold);
      margin-bottom: var(--space-4);
    }

    .member-badge-checkmark {
      font-size: var(--text-xl);
    }

    .member-thanks {
      color: var(--color-success-700);
      font-size: var(--text-base);
      line-height: var(--leading-relaxed);
      margin-bottom: var(--space-6);
    }

    .member-benefits-inner {
      background: white;
      border-radius: var(--radius-md);
      padding: var(--space-5);
      text-align: left;
    }

    .member-benefits-inner h4 {
      color: var(--color-success-700);
      font-size: var(--text-base);
      font-weight: var(--font-semibold);
      margin: 0 0 var(--space-3) 0;
    }

    .member-benefits-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-3);
    }

    .member-benefits-grid ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .member-benefits-grid li {
      display: flex;
      align-items: flex-start;
      gap: var(--space-2);
      padding: var(--space-1) 0;
      font-size: var(--text-sm);
      color: var(--color-text);
    }

    .member-benefits-grid li::before {
      content: '\2713';
      color: var(--color-success-600);
      font-weight: var(--font-bold);
      flex-shrink: 0;
    }

    /* What's Next / Engagement section */
    .whats-next-card {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      margin-bottom: 24px;
      overflow: hidden;
    }

    .whats-next-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--color-border);
      background: var(--color-bg-subtle);
    }

    .whats-next-header h2 {
      margin: 0;
      font-size: 16px;
      color: var(--color-text-heading);
    }

    .whats-next-body {
      padding: 20px 24px;
    }

    .whats-next-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .whats-next-item {
      display: flex;
      gap: 16px;
      padding: 16px;
      background: var(--color-bg-subtle);
      border-radius: 8px;
      text-decoration: none;
      color: inherit;
      transition: all 0.2s;
    }

    .whats-next-item:hover {
      background: var(--color-primary-50);
      border-color: var(--color-brand);
      transform: translateY(-2px);
    }

    .whats-next-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: var(--color-brand);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .whats-next-content h4 {
      margin: 0 0 4px 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--color-text-heading);
    }

    .whats-next-content p {
      margin: 0;
      font-size: 13px;
      color: var(--color-text-secondary);
      line-height: 1.4;
    }

    /* Agreement section */
    .agreement-box {
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 20px;
      background: var(--color-bg-subtle);
      margin-bottom: 20px;
    }

    .agreement-box h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      color: var(--color-text-heading);
    }

    .agreement-content {
      max-height: 200px;
      overflow-y: auto;
      padding: 16px;
      background: white;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 13px;
      line-height: 1.6;
    }

    .agreement-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      cursor: pointer;
    }

    .agreement-checkbox input {
      margin-top: 3px;
      cursor: pointer;
    }

    .agreement-checkbox span {
      font-size: 14px;
    }

    .agreement-warning {
      text-align: center;
      color: var(--color-text-secondary);
      font-size: 14px;
      padding: 12px;
      background: var(--color-warning-50);
      border: 1px solid var(--color-warning-300);
      border-radius: 6px;
      margin-top: 16px;
    }

    /* Agreements list */
    .agreement-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid var(--color-border);
    }

    .agreement-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .agreement-item:first-child {
      padding-top: 0;
    }

    .agreement-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .agreement-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .agreement-status-dot.signed {
      background: var(--color-success-500);
    }

    .agreement-status-dot.outdated {
      background: var(--color-warning-500);
    }

    .agreement-status-dot.required {
      background: var(--color-error-500);
    }

    .agreement-name {
      font-weight: 500;
      color: var(--color-text-heading);
    }

    .agreement-meta {
      font-size: 13px;
      color: var(--color-text-secondary);
      margin-top: 2px;
    }

    .agreement-actions {
      display: flex;
      gap: 8px;
    }

    /* Product cards grid */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }

    .product-card {
      background: var(--color-bg-card);
      border: 2px solid var(--color-border);
      border-radius: 12px;
      padding: 24px;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
    }

    .product-card:hover {
      border-color: var(--color-brand);
      box-shadow: var(--shadow-md);
    }

    .product-card.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .product-card-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--color-text-heading);
      margin-bottom: 8px;
    }

    .product-card-description {
      font-size: 14px;
      color: var(--color-text-secondary);
      margin-bottom: 16px;
    }

    .product-card-price {
      font-size: 32px;
      font-weight: 700;
      color: var(--color-brand);
    }

    .product-card-price .period {
      font-size: 14px;
      font-weight: 400;
      color: var(--color-text-muted);
    }

    .product-card-tier {
      font-size: 12px;
      color: var(--color-text-muted);
      margin-top: 8px;
    }

    .product-card-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .product-card-actions .btn {
      flex: 1;
      padding: 10px 16px;
      font-size: 14px;
    }

    .products-loading {
      text-align: center;
      padding: 40px;
      color: var(--color-text-secondary);
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: var(--color-text-secondary);
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--color-success-600);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .toast.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <!-- AAO top navigation -->
  <div id="adcp-nav"></div>

  <div id="toast" class="toast"></div>

  <!-- Profile Collection Modal -->
  <div id="profileModal" class="profile-modal-overlay" style="display: none;">
    <div class="profile-modal">
      <div class="profile-modal-header">
        <h2>Tell Us About Your Organization</h2>
        <p>Help us show you the right membership options by providing a few details.</p>
      </div>
      <div class="profile-modal-body">
        <div class="profile-form-group">
          <label>What type of organization are you?</label>
          <div class="radio-options" id="companyTypeOptions">
            <label class="radio-option" onclick="selectRadioOption(this, 'companyType', 'brand')">
              <input type="radio" name="companyType" value="brand">
              <div class="radio-option-content">
                <div class="radio-option-title">Brand / Advertiser</div>
                <div class="radio-option-desc">Companies that advertise products or services</div>
              </div>
            </label>
            <label class="radio-option" onclick="selectRadioOption(this, 'companyType', 'publisher')">
              <input type="radio" name="companyType" value="publisher">
              <div class="radio-option-content">
                <div class="radio-option-title">Publisher / Media Network</div>
                <div class="radio-option-desc">Media owners and networks that sell advertising inventory</div>
              </div>
            </label>
            <label class="radio-option" onclick="selectRadioOption(this, 'companyType', 'agency')">
              <input type="radio" name="companyType" value="agency">
              <div class="radio-option-content">
                <div class="radio-option-title">Agency</div>
                <div class="radio-option-desc">Advertising, media, or creative agencies</div>
              </div>
            </label>
            <label class="radio-option" onclick="selectRadioOption(this, 'companyType', 'adtech')">
              <input type="radio" name="companyType" value="adtech">
              <div class="radio-option-content">
                <div class="radio-option-title">Ad Tech Provider</div>
                <div class="radio-option-desc">DSPs, SSPs, ad servers, measurement, identity, and data platforms</div>
              </div>
            </label>
            <label class="radio-option" onclick="selectRadioOption(this, 'companyType', 'data')">
              <input type="radio" name="companyType" value="data">
              <div class="radio-option-content">
                <div class="radio-option-title">Data & Measurement</div>
                <div class="radio-option-desc">Clean rooms, CDPs, identity, measurement, and analytics</div>
              </div>
            </label>
            <label class="radio-option" onclick="selectRadioOption(this, 'companyType', 'ai')">
              <input type="radio" name="companyType" value="ai">
              <div class="radio-option-content">
                <div class="radio-option-title">AI & Tech Platforms</div>
                <div class="radio-option-desc">LLM providers, agent builders, cloud AI, and ML platforms</div>
              </div>
            </label>
            <label class="radio-option" onclick="selectRadioOption(this, 'companyType', 'other')">
              <input type="radio" name="companyType" value="other">
              <div class="radio-option-content">
                <div class="radio-option-title">Other</div>
                <div class="radio-option-desc">Other industry participants</div>
              </div>
            </label>
          </div>
        </div>
        <div class="profile-form-group">
          <label>Annual Revenue</label>
          <div class="radio-options" id="revenueTierOptions">
            <label class="radio-option" onclick="selectRadioOption(this, 'revenueTier', 'under_1m')">
              <input type="radio" name="revenueTier" value="under_1m">
              <div class="radio-option-content">
                <div class="radio-option-title">Under $1M</div>
              </div>
            </label>
            <label class="radio-option" onclick="selectRadioOption(this, 'revenueTier', '1m_5m')">
              <input type="radio" name="revenueTier" value="1m_5m">
              <div class="radio-option-content">
                <div class="radio-option-title">$1M - $5M</div>
              </div>
            </label>
            <label class="radio-option" onclick="selectRadioOption(this, 'revenueTier', '5m_50m')">
              <input type="radio" name="revenueTier" value="5m_50m">
              <div class="radio-option-content">
                <div class="radio-option-title">$5M - $50M</div>
              </div>
            </label>
            <label class="radio-option" onclick="selectRadioOption(this, 'revenueTier', '50m_250m')">
              <input type="radio" name="revenueTier" value="50m_250m">
              <div class="radio-option-content">
                <div class="radio-option-title">$50M - $250M</div>
              </div>
            </label>
            <label class="radio-option" onclick="selectRadioOption(this, 'revenueTier', '250m_1b')">
              <input type="radio" name="revenueTier" value="250m_1b">
              <div class="radio-option-content">
                <div class="radio-option-title">$250M - $1B</div>
              </div>
            </label>
            <label class="radio-option" onclick="selectRadioOption(this, 'revenueTier', '1b_plus')">
              <input type="radio" name="revenueTier" value="1b_plus">
              <div class="radio-option-content">
                <div class="radio-option-title">$1B+</div>
              </div>
            </label>
          </div>
        </div>
      </div>
      <div class="profile-modal-footer">
        <button id="saveProfileBtn" class="btn btn-primary" onclick="saveOrgProfile()" disabled>
          Continue to Membership
        </button>
      </div>
    </div>
  </div>

  <div class="page-header">
    <h1>Membership</h1>
    <p>Manage your membership, billing, and agreements</p>
  </div>

  <div class="page-content">
    <div id="loading" class="loading">Loading membership information...</div>

    <div id="content" style="display: none;">
      <!-- Current subscription status (for subscribers) -->
      <div id="subscriptionCard" class="billing-card" style="display: none;">
        <div class="billing-card-header">
          <h2>Current Membership</h2>
        </div>
        <div class="billing-card-body">
          <div id="subscriptionStatus" class="subscription-status active">
            <!-- Filled by JS -->
          </div>
          <button id="manageBillingBtn" class="btn btn-primary" onclick="openBillingPortal()">
            Manage Billing
          </button>
        </div>
      </div>

      <!-- Member Benefits (for existing subscribers) -->
      <div id="memberBenefitsCard" class="member-benefits-card" style="display: none;">
        <div class="member-badge">
          <span class="member-badge-checkmark">&#10003;</span>
          <span>You're a Member!</span>
        </div>
        <p class="member-thanks">
          Thank you for being a founding member of AgenticAdvertising.org. Your support helps build the future of agentic advertising.
        </p>
        <div class="member-benefits-inner">
          <h4 id="memberBenefitsTitle">Your Member Benefits</h4>
          <div id="memberBenefitsGrid" class="member-benefits-grid">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>

      <!-- What's Next / Engagement (for existing subscribers) -->
      <div id="whatsNextCard" class="whats-next-card" style="display: none;">
        <div class="whats-next-header">
          <h2>Get the Most Out of Your Membership</h2>
        </div>
        <div class="whats-next-body">
          <div class="whats-next-grid">
            <a href="/dashboard/profile" class="whats-next-item">
              <div class="whats-next-icon">&#128100;</div>
              <div class="whats-next-content">
                <h4>Complete Your Profile</h4>
                <p>Add your logo and details to appear in the member directory</p>
              </div>
            </a>
            <a href="/dashboard/addie" class="whats-next-item">
              <div class="whats-next-icon">&#129302;</div>
              <div class="whats-next-content">
                <h4>Talk to Addie</h4>
                <p>Get answers about AdCP, membership, and agentic advertising</p>
              </div>
            </a>
            <a href="https://join.slack.com/t/agenticadvertising/shared_invite/zt-2vq5tqy3n-c2X3jroBr0Pn_z~9fG8V9Q" target="_blank" class="whats-next-item">
              <div class="whats-next-icon">&#128172;</div>
              <div class="whats-next-content">
                <h4>Join the Slack Community</h4>
                <p>Connect with other members and participate in discussions</p>
              </div>
            </a>
            <a href="/members" class="whats-next-item">
              <div class="whats-next-icon">&#127760;</div>
              <div class="whats-next-content">
                <h4>Browse the Directory</h4>
                <p>Discover other member organizations and potential partners</p>
              </div>
            </a>
          </div>
        </div>
      </div>

      <!-- Agreements section (for subscribers) -->
      <div id="agreementsCard" class="billing-card" style="display: none;">
        <div class="billing-card-header">
          <h2>Agreements</h2>
        </div>
        <div class="billing-card-body">
          <div id="agreementsList">
            Loading agreements...
          </div>
        </div>
      </div>

      <!-- Membership signup (for non-subscribers) -->
      <div id="membershipSection" style="display: none;">

        <!-- Referral discount countdown banner (shown when user has an accepted referral) -->
        <div id="referralBanner" style="display:none; margin-bottom: 20px;">
          <div id="referralBannerInner" style="
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            border-radius: 12px;
            border: 1px solid var(--color-success-500);
            background: var(--color-success-50);
          ">
            <div style="font-size: 1.5rem; flex-shrink: 0;">&#127881;</div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 14px; font-weight: 600; color: var(--color-success-700); margin-bottom: 4px;" id="referralBannerTitle">
                You have a pending discount
              </div>
              <div style="font-size: 13px; color: var(--color-success-700);" id="referralBannerMessage">
                Subscribe now to claim your discount.
              </div>
            </div>
          </div>
        </div>

        <div class="membership-promo">
          <h2>Become a Member</h2>
          <p>
            Unlock your public member profile, appear in the directory, and support the AdCP ecosystem.
            <a href="/membership">Learn more about founding membership benefits →</a>
          </p>
          <div class="membership-benefits" id="membershipBenefits">
            <!-- Benefits populated by JS based on org type -->
          </div>
        </div>

        <div class="billing-card">
          <div class="billing-card-header">
            <h2>Choose Your Membership</h2>
          </div>
          <div class="billing-card-body">
            <p style="margin: 0 0 16px; color: var(--color-text-secondary);">
              Select a membership tier to continue. You'll review the membership agreement before checkout.
            </p>
            <div id="productsContainer">
              <div class="products-loading">Loading membership options...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Request Modal -->
  <div id="invoiceRequestModal" class="profile-modal-overlay" style="display: none;">
    <div style="background: var(--color-bg-card); border-radius: 12px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-xl);">
      <div style="padding: 20px 24px; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; font-size: 18px; color: var(--color-text-heading);">Request an Invoice</h2>
        <button onclick="closeInvoiceRequestModal()" style="background: none; border: none; font-size: 24px; color: var(--color-text-muted); cursor: pointer; padding: 0; line-height: 1;">&times;</button>
      </div>
      <form id="invoiceRequestForm" onsubmit="submitInvoiceRequest(event)">
        <div style="padding: 24px;">
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 14px; font-weight: 500; color: var(--color-text); margin-bottom: 4px;">Company Name *</label>
            <input type="text" id="invoice-company" name="companyName" required placeholder="Acme Corporation" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 14px;">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <div>
              <label style="display: block; font-size: 14px; font-weight: 500; color: var(--color-text); margin-bottom: 4px;">Contact Name *</label>
              <input type="text" id="invoice-contact" name="contactName" required placeholder="John Smith" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 14px;">
            </div>
            <div>
              <label style="display: block; font-size: 14px; font-weight: 500; color: var(--color-text); margin-bottom: 4px;">Billing Email *</label>
              <input type="email" id="invoice-email" name="contactEmail" required placeholder="billing@acme.com" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 14px;">
            </div>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 14px; font-weight: 500; color: var(--color-text); margin-bottom: 4px;">Product *</label>
            <select id="invoice-product" name="lookupKey" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 14px; background: white;">
              <option value="">Select a product...</option>
            </select>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 14px; font-weight: 500; color: var(--color-text); margin-bottom: 4px;">Billing Address Line 1 *</label>
            <input type="text" id="invoice-address1" name="line1" required placeholder="123 Main Street" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 14px;">
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 14px; font-weight: 500; color: var(--color-text); margin-bottom: 4px;">Billing Address Line 2</label>
            <input type="text" id="invoice-address2" name="line2" placeholder="Suite 100" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 14px;">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <div>
              <label style="display: block; font-size: 14px; font-weight: 500; color: var(--color-text); margin-bottom: 4px;">City *</label>
              <input type="text" id="invoice-city" name="city" required placeholder="San Francisco" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 14px;">
            </div>
            <div>
              <label style="display: block; font-size: 14px; font-weight: 500; color: var(--color-text); margin-bottom: 4px;">State/Province *</label>
              <input type="text" id="invoice-state" name="state" required placeholder="CA" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 14px;">
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <div>
              <label style="display: block; font-size: 14px; font-weight: 500; color: var(--color-text); margin-bottom: 4px;">Postal Code *</label>
              <input type="text" id="invoice-postal" name="postal_code" required placeholder="94105" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 14px;">
            </div>
            <div>
              <label style="display: block; font-size: 14px; font-weight: 500; color: var(--color-text); margin-bottom: 4px;">Country *</label>
              <input type="text" id="invoice-country" name="country" required value="US" placeholder="US" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 14px;">
            </div>
          </div>

          <div id="invoiceFormError" style="display: none; color: var(--color-error-600); font-size: 14px; margin-bottom: 16px; padding: 12px; background: var(--color-error-50); border-radius: 8px;"></div>
        </div>
        <div style="padding: 16px 24px; border-top: 1px solid var(--color-border); display: flex; gap: 12px; justify-content: flex-end;">
          <button type="button" class="btn btn-secondary" onclick="closeInvoiceRequestModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="invoiceSubmitBtn">Send Invoice</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Agreement Modal -->
  <div id="agreementModal" class="profile-modal-overlay" style="display: none;">
    <div style="background: var(--color-bg-card); border-radius: 12px; max-width: 700px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; box-shadow: var(--shadow-xl);">
      <div style="padding: 20px 24px; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; font-size: 18px; color: var(--color-text-heading);">Membership Agreement</h2>
        <button onclick="closeAgreementModal()" style="background: none; border: none; font-size: 24px; color: var(--color-text-muted); cursor: pointer; padding: 0; line-height: 1;">&times;</button>
      </div>
      <div style="padding: 24px; flex: 1; overflow-y: auto;">
        <p style="margin: 0 0 16px; color: var(--color-text-secondary); font-size: 14px;">
          Please review and accept the membership agreement to continue with checkout.
        </p>
        <div id="modalAgreementContent" style="background: var(--color-bg-subtle); border: 1px solid var(--color-border); border-radius: 8px; padding: 20px; max-height: 300px; overflow-y: auto; font-size: 13px; line-height: 1.6; margin-bottom: 20px;">
          Loading agreement...
        </div>
        <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
          <input type="checkbox" id="modalAgreementCheckbox" style="margin-top: 3px; cursor: pointer;">
          <span style="font-size: 14px;">I have read and agree to the <strong>AgenticAdvertising.org Membership Agreement</strong></span>
        </label>
      </div>
      <div style="padding: 16px 24px; border-top: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;">
        <div id="selectedProductInfo" style="font-size: 14px; color: var(--color-text-secondary);"></div>
        <div style="display: flex; gap: 12px;">
          <button class="btn btn-secondary" onclick="closeAgreementModal()">Cancel</button>
          <button class="btn btn-primary" id="proceedToCheckoutBtn" onclick="proceedToCheckout()" disabled>Proceed to Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentOrg = null;
    let selectedProduct = null;
    let membershipProducts = [];
    let selectedCompanyType = null;
    let selectedRevenueTier = null;

    // Show toast
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.background = isError ? 'var(--color-error-600)' : 'var(--color-success-600)';
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Format currency
    function formatCurrency(amountCents) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(amountCents / 100);
    }

    // Load billing data
    async function loadBilling() {
      try {
        const response = await fetch('/api/me', { credentials: 'include' });
        if (!response.ok) {
          if (response.status === 401) {
            window.location.href = '/auth/login?return_to=' + encodeURIComponent(window.location.pathname);
            return;
          }
          throw new Error('Failed to load user data');
        }

        const data = await response.json();
        const { org, needsSelection } = DashboardNav.resolveOrg(data.organizations);

        if (needsSelection) {
          DashboardNav.init({ currentOrgName: 'Select organization' });
          DashboardNav.renderOrgPicker(data.organizations, document.getElementById('loading'));
          return;
        }

        if (!org) {
          document.getElementById('loading').innerHTML = 'No organization found';
          return;
        }

        currentOrg = org;

        // Fetch billing info to get company_type, revenue_tier, and subscription status
        try {
          const billingResponse = await fetch(`/api/organizations/${currentOrg.id}/billing`, { credentials: 'include' });
          if (billingResponse.ok) {
            const billingData = await billingResponse.json();
            currentOrg.billing = {
              ...billingData.subscription,
              company_type: billingData.company_type,
              revenue_tier: billingData.revenue_tier,
              is_personal: billingData.is_personal,
              suggested_company_type: billingData.suggested_company_type,
              suggested_revenue_tier: billingData.suggested_revenue_tier,
            };
          }
        } catch (billingError) {
          console.error('Error loading billing info:', billingError);
        }

        // Initialize sidebar
        DashboardNav.init({
          showOrgSwitcher: data.organizations?.length > 1,
          currentOrgName: currentOrg.name,
          showAdmin: data.isAdmin,
          orgId: currentOrg.id
        });

        if (data.organizations?.length > 1) {
          DashboardNav.setOrgOptions(data.organizations, currentOrg.id, (newOrgId) => {
            localStorage.setItem('selectedOrgId', newOrgId);
            window.location.href = '/dashboard/membership?org=' + newOrgId;
          });
        }

        // Check if we need to show the profile collection modal
        // Only for non-personal organizations that don't have company_type or revenue_tier
        const isPersonal = currentOrg.is_personal || currentOrg.billing?.is_personal;
        const needsProfile = !isPersonal && (!currentOrg.billing?.company_type || !currentOrg.billing?.revenue_tier);

        if (needsProfile) {
          showProfileModal();
        }

        renderBilling();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch (error) {
        console.error('Error loading billing:', error);
        document.getElementById('loading').innerHTML = 'Error loading billing information. Please refresh.';
      }
    }

    function renderBilling() {
      const hasSubscription = currentOrg.billing?.status === 'active';
      const subscriptionCard = document.getElementById('subscriptionCard');
      const membershipSection = document.getElementById('membershipSection');
      const agreementsCard = document.getElementById('agreementsCard');
      const memberBenefitsCard = document.getElementById('memberBenefitsCard');
      const whatsNextCard = document.getElementById('whatsNextCard');

      if (hasSubscription) {
        subscriptionCard.style.display = 'block';
        memberBenefitsCard.style.display = 'block';
        whatsNextCard.style.display = 'block';
        agreementsCard.style.display = 'block';
        membershipSection.style.display = 'none';
        renderSubscriptionStatus();
        renderMemberBenefitsForSubscriber();
        loadMyAgreements();
      } else {
        subscriptionCard.style.display = 'none';
        memberBenefitsCard.style.display = 'none';
        whatsNextCard.style.display = 'none';
        agreementsCard.style.display = 'none';
        membershipSection.style.display = 'block';
        renderMembershipBenefits();
        loadProducts();
        loadReferralBanner();
      }
    }

    // Render member benefits for existing subscribers
    function renderMemberBenefitsForSubscriber() {
      const container = document.getElementById('memberBenefitsGrid');
      const titleEl = document.getElementById('memberBenefitsTitle');
      if (!container) return;

      const isPersonal = currentOrg.is_personal || currentOrg.billing?.is_personal;

      const companyBenefits = [
        'Eligibility to serve on Board',
        'Right to vote for Board',
        'Help build standards, practices, protocols, and policies',
        'Right to vote on standards adoption',
        'Serve on interim Advisory Council',
        'Participate in working groups',
        'All team members can participate in association activities'
      ];

      const individualBenefits = [
        'Help build standards, practices, protocols, and policies',
        'Eligible for professional development and certification courses',
        'Personal listing in member directory',
        'Working group participation',
        'Community Slack access',
        'Event discounts and early access',
        'Newsletter and industry updates'
      ];

      const benefits = isPersonal ? individualBenefits : companyBenefits;
      const memberType = isPersonal ? 'Individual' : 'Company';

      // Update title
      if (titleEl) {
        titleEl.textContent = `Your ${memberType} Member Benefits`;
      }

      // Split benefits into two columns
      const midpoint = Math.ceil(benefits.length / 2);
      const leftBenefits = benefits.slice(0, midpoint);
      const rightBenefits = benefits.slice(midpoint);

      container.innerHTML = `
        <ul>
          ${leftBenefits.map(b => `<li>${escapeHtml(b)}</li>`).join('')}
        </ul>
        <ul>
          ${rightBenefits.map(b => `<li>${escapeHtml(b)}</li>`).join('')}
        </ul>
      `;
    }

    // Render membership benefits based on org type
    function renderMembershipBenefits() {
      const container = document.getElementById('membershipBenefits');
      if (!container) return;

      const isPersonal = currentOrg.is_personal || currentOrg.billing?.is_personal;

      const companyBenefits = [
        'Eligibility to serve on Board',
        'Right to vote for Board',
        'Help build standards, practices, protocols, and policies',
        'Right to vote on standards adoption',
        'Serve on interim Advisory Council',
        'Participate in working groups',
        'All team members can participate in association activities'
      ];

      const individualBenefits = [
        'Help build standards, practices, protocols, and policies',
        'Eligible for professional development and certification courses',
        'Personal listing in member directory',
        'Working group participation',
        'Community Slack access',
        'Event discounts and early access',
        'Newsletter and industry updates'
      ];

      const benefits = isPersonal ? individualBenefits : companyBenefits;

      // Split benefits into two columns
      const midpoint = Math.ceil(benefits.length / 2);
      const leftBenefits = benefits.slice(0, midpoint);
      const rightBenefits = benefits.slice(midpoint);

      container.innerHTML = `
        <ul class="membership-benefits-list">
          ${leftBenefits.map(b => `<li>${escapeHtml(b)}</li>`).join('')}
        </ul>
        <ul class="membership-benefits-list">
          ${rightBenefits.map(b => `<li>${escapeHtml(b)}</li>`).join('')}
        </ul>
      `;
    }

    function renderSubscriptionStatus() {
      const status = currentOrg.billing;
      const statusEl = document.getElementById('subscriptionStatus');

      let statusClass = 'active';
      let icon = '✓';
      let title = status.product_name || 'Active Membership';
      let description = '';

      if (status.status === 'past_due') {
        statusClass = 'past_due';
        icon = '⚠️';
        title = 'Payment Past Due';
        description = 'Please update your payment method to continue your membership.';
      } else if (status.status === 'active') {
        const renewalDate = status.current_period_end
          ? new Date(status.current_period_end * 1000).toLocaleDateString()
          : '';
        const memberSince = currentOrg.agreement_signed_at
          ? new Date(currentOrg.agreement_signed_at).toLocaleDateString()
          : '';

        description = `${memberSince ? 'Member since ' + memberSince + ' • ' : ''}Renews ${renewalDate}`;

        if (status.cancel_at_period_end) {
          description += ' (cancels at period end)';
        }
      }

      statusEl.className = 'subscription-status ' + statusClass;
      statusEl.innerHTML = `
        <div class="subscription-icon">${icon}</div>
        <div class="subscription-info">
          <h3>${title}</h3>
          <p>${description}</p>
        </div>
      `;
    }

    // Load referral banner — shows discount countdown for users who accepted a referral invitation
    async function loadReferralBanner() {
      try {
        const res = await fetch('/api/me/referral', { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();
        if (!data.referral || data.days_remaining === null) return;

        const days = data.days_remaining;
        const discount = data.discount_percent;
        const banner = document.getElementById('referralBanner');
        const inner = document.getElementById('referralBannerInner');
        const title = document.getElementById('referralBannerTitle');
        const message = document.getElementById('referralBannerMessage');

        if (!banner || !title || !message) return;

        const discountText = discount ? discount + '% off your first year' : 'a special discount';
        const urgency = days <= 7;

        title.textContent = urgency
          ? 'Your discount expires soon!'
          : 'You have a pending discount';

        message.textContent = days === 0
          ? 'Today is your last day to claim ' + discountText + '.'
          : 'Subscribe within ' + days + ' day' + (days === 1 ? '' : 's') + ' to claim ' + discountText + '.';

        if (urgency && inner) {
          inner.style.borderColor = 'var(--color-warning-500)';
          inner.style.background = 'var(--color-warning-50)';
          title.style.color = 'var(--color-warning-700)';
          message.style.color = 'var(--color-warning-700)';
        }

        banner.style.display = '';
      } catch {
        // Silently ignore — banner is non-critical
      }
    }

    // Load products from API
    async function loadProducts() {
      const container = document.getElementById('productsContainer');
      const isPersonal = currentOrg.is_personal || currentOrg.billing?.is_personal;
      const customerType = isPersonal ? 'individual' : 'company';
      const revenueTier = currentOrg.billing?.revenue_tier || '';

      try {
        const url = new URL('/api/billing-products', window.location.origin);
        url.searchParams.set('customer_type', customerType);
        url.searchParams.set('category', 'membership');
        if (revenueTier) {
          url.searchParams.set('revenue_tier', revenueTier);
        }

        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load products');

        const data = await response.json();
        membershipProducts = data.products || [];

        if (membershipProducts.length === 0) {
          container.innerHTML = '<p style="color: var(--color-text-secondary);">No membership products available. Please contact support.</p>';
          return;
        }

        renderProductCards();
      } catch (error) {
        console.error('Error loading products:', error);
        container.innerHTML = '<p style="color: var(--color-error-500);">Failed to load membership options. Please refresh.</p>';
      }
    }

    // Render product cards
    // Deduplicates products by amount_cents to avoid showing multiple cards with the same price
    function renderProductCards() {
      const container = document.getElementById('productsContainer');

      // Deduplicate products by price - keep only one product per unique price
      const seenPrices = new Set();
      const uniqueProducts = membershipProducts.filter(product => {
        if (seenPrices.has(product.amount_cents)) {
          return false;
        }
        seenPrices.add(product.amount_cents);
        return true;
      });

      const cardsHtml = uniqueProducts.map(product => {
        return `
          <div class="product-card" data-lookup-key="${product.lookup_key}">
            <div class="product-card-name">${escapeHtml(product.display_name)}</div>
            ${product.description ? `<div class="product-card-description">${escapeHtml(product.description)}</div>` : ''}
            <div class="product-card-price">
              ${formatCurrency(product.amount_cents)}
              <span class="period">/year</span>
            </div>
            <div class="product-card-actions">
              <button class="btn btn-primary" onclick="selectProduct('${product.lookup_key}')">Pay Now</button>
              <button class="btn btn-secondary" onclick="openInvoiceRequestForProduct('${product.lookup_key}')">Request Invoice</button>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = `<div class="products-grid">${cardsHtml}</div>`;
    }

    // Select a product and show agreement modal
    function selectProduct(lookupKey) {
      selectedProduct = membershipProducts.find(p => p.lookup_key === lookupKey);
      if (!selectedProduct) return;

      // Update modal info
      document.getElementById('selectedProductInfo').textContent =
        `${selectedProduct.display_name} - ${formatCurrency(selectedProduct.amount_cents)}/year`;

      // Reset checkbox
      document.getElementById('modalAgreementCheckbox').checked = false;
      document.getElementById('proceedToCheckoutBtn').disabled = true;

      // Load agreement content if not already loaded
      loadAgreementContent();

      // Show modal
      document.getElementById('agreementModal').style.display = 'flex';
    }

    // Load agreement content for modal
    async function loadAgreementContent() {
      const contentEl = document.getElementById('modalAgreementContent');

      try {
        const response = await fetch('/api/agreement/current?type=membership');
        if (!response.ok) throw new Error('Failed to load agreement');

        const data = await response.json();
        const content = data.text || 'Agreement not available.';

        // Render markdown
        const html = DOMPurify.sanitize(marked.parse(content));
        contentEl.innerHTML = html;
      } catch (error) {
        console.error('Error loading agreement:', error);
        contentEl.innerHTML = 'Unable to load agreement. Please refresh.';
      }
    }

    // Close agreement modal
    function closeAgreementModal() {
      document.getElementById('agreementModal').style.display = 'none';
      selectedProduct = null;
    }

    // Handle agreement checkbox change
    document.addEventListener('DOMContentLoaded', function() {
      const checkbox = document.getElementById('modalAgreementCheckbox');
      if (checkbox) {
        checkbox.addEventListener('change', function() {
          document.getElementById('proceedToCheckoutBtn').disabled = !this.checked;
        });
      }

      // Close modal on outside click
      const modal = document.getElementById('agreementModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            closeAgreementModal();
          }
        });
      }

      // Handle profile modal radio inputs (for when radio is clicked directly)
      document.querySelectorAll('#profileModal input[type="radio"]').forEach(input => {
        input.addEventListener('change', function() {
          const label = this.closest('.radio-option');
          const group = this.name;
          const value = this.value;
          if (label) {
            selectRadioOption(label, group, value);
          }
        });
      });
    });

    // Proceed to Stripe checkout
    async function proceedToCheckout() {
      if (!selectedProduct || !currentOrg) return;

      const btn = document.getElementById('proceedToCheckoutBtn');
      btn.disabled = true;
      btn.textContent = 'Redirecting...';

      try {
        const checkoutBody = {
          priceId: selectedProduct.price_id,
          orgId: currentOrg.id,
        };
        const storedReferralCode = localStorage.getItem('aao_referral_code');
        if (storedReferralCode) {
          checkoutBody.referral_code = storedReferralCode;
        }

        const response = await fetch('/api/checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(checkoutBody),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to create checkout session');
        }

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          throw new Error('No checkout URL returned');
        }
      } catch (error) {
        console.error('Checkout error:', error);
        showToast(error.message || 'Failed to start checkout', true);
        btn.disabled = false;
        btn.textContent = 'Proceed to Checkout';
      }
    }

    // Invoice Request Modal Functions
    function openInvoiceRequestForProduct(lookupKey) {
      // Open invoice modal with a specific product pre-selected
      openInvoiceRequestModal(lookupKey);
    }

    function openInvoiceRequestModal(preSelectedLookupKey = null) {
      const modal = document.getElementById('invoiceRequestModal');
      const productSelect = document.getElementById('invoice-product');

      // Populate product dropdown with subscription products only
      // (excludes legacy one-time invoice products)
      productSelect.innerHTML = '<option value="">Select a product...</option>';
      if (membershipProducts && membershipProducts.length > 0) {
        const subscriptionProducts = membershipProducts.filter(p => p.billing_type === 'subscription');
        subscriptionProducts.forEach(product => {
          const price = formatCurrency(product.amount_cents);
          productSelect.innerHTML += `<option value="${product.lookup_key}">${escapeHtml(product.display_name)} - ${price}/year</option>`;
        });
      }

      // Pre-select product if specified
      if (preSelectedLookupKey) {
        productSelect.value = preSelectedLookupKey;
      }

      // Pre-fill company name from org if available
      const companyInput = document.getElementById('invoice-company');
      if (currentOrg && currentOrg.name && !companyInput.value) {
        companyInput.value = currentOrg.name;
      }

      modal.style.display = 'flex';
      document.getElementById('invoice-company').focus();
    }

    function closeInvoiceRequestModal() {
      document.getElementById('invoiceRequestModal').style.display = 'none';
      document.getElementById('invoiceFormError').style.display = 'none';
      // Reset form and button state
      document.getElementById('invoiceRequestForm').reset();
      const submitBtn = document.getElementById('invoiceSubmitBtn');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Send Invoice';
    }

    async function submitInvoiceRequest(event) {
      event.preventDefault();

      const form = event.target;
      const submitBtn = document.getElementById('invoiceSubmitBtn');
      const errorDiv = document.getElementById('invoiceFormError');

      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';
      errorDiv.style.display = 'none';

      const formData = new FormData(form);

      const requestData = {
        companyName: formData.get('companyName'),
        contactName: formData.get('contactName'),
        contactEmail: formData.get('contactEmail'),
        lookupKey: formData.get('lookupKey'),
        billingAddress: {
          line1: formData.get('line1'),
          line2: formData.get('line2') || undefined,
          city: formData.get('city'),
          state: formData.get('state'),
          postal_code: formData.get('postal_code'),
          country: formData.get('country'),
        },
      };

      try {
        const response = await fetch('/api/invoice-request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(requestData),
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.message || 'Failed to send invoice');
        }

        // Show success state
        const modalBody = form.querySelector('div:first-child');
        const modalFooter = form.querySelector('div:last-child');

        modalBody.innerHTML = `
          <div style="text-align: center; padding: 24px;">
            <div style="font-size: 48px; margin-bottom: 16px;">✅</div>
            <h3 style="color: var(--color-success-600); margin-bottom: 8px;">Invoice Sent!</h3>
            <p style="color: var(--color-text-secondary); margin-bottom: 16px;">We've sent an invoice to <strong>${escapeHtml(requestData.contactEmail)}</strong>. Please check your email for payment instructions.</p>
            <p style="font-size: 14px; color: var(--color-text-muted);">The invoice is due within 30 days. You can pay online via the link in the email.</p>
          </div>
        `;

        modalFooter.innerHTML = `
          <button type="button" class="btn btn-primary" onclick="closeInvoiceRequestModal()">Done</button>
        `;

      } catch (error) {
        errorDiv.textContent = error.message || 'Something went wrong. Please try again or contact finance@agenticadvertising.org';
        errorDiv.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Invoice';
      }
    }

    async function openBillingPortal() {
      try {
        const response = await fetch(`/api/organizations/${currentOrg.id}/billing/portal`, {
          method: 'POST',
          credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to get billing portal');

        const data = await response.json();
        if (data.portal_url) {
          window.location.href = data.portal_url;
        }
      } catch (error) {
        console.error('Error opening billing portal:', error);
        showToast('Failed to open billing portal', true);
      }
    }

    // Format agreement type for display
    function formatAgreementType(type) {
      const map = {
        'membership_agreement': 'Membership Agreement',
        'terms_of_service': 'Terms of Use',
        'privacy_policy': 'Privacy Policy',
        'bylaws': 'Bylaws',
        'ip_policy': 'IP Policy',
        'antitrust_policy': 'Antitrust Policy'
      };
      return map[type] || type.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    // Escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Load and display user's agreements
    async function loadMyAgreements() {
      const listEl = document.getElementById('agreementsList');

      try {
        const response = await fetch('/api/me/agreements', { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to load agreements');

        const data = await response.json();
        const agreements = data.agreements || [];

        if (agreements.length === 0) {
          listEl.innerHTML = '<p style="color: var(--color-text-secondary);">No agreements to display.</p>';
          return;
        }

        listEl.innerHTML = agreements.map(agreement => {
          const isSigned = !!agreement.version;
          const isOutdated = agreement.is_outdated;

          let statusClass, statusLabel;
          if (!isSigned) {
            statusClass = 'required';
            statusLabel = 'Required';
          } else if (isOutdated) {
            statusClass = 'outdated';
            statusLabel = 'Update available';
          } else {
            statusClass = 'signed';
            statusLabel = 'Signed';
          }

          const signedDate = agreement.signed_at
            ? new Date(agreement.signed_at).toLocaleDateString()
            : null;

          const meta = signedDate
            ? `Signed on ${signedDate}${isOutdated ? ' • New version available' : ''}`
            : statusLabel;

          // Actions
          let actions = '';
          if (!isSigned) {
            actions = `<button class="btn btn-primary btn-sm" onclick="viewAgreement('${escapeHtml(agreement.type)}')">Review & Sign</button>`;
          } else {
            actions = `<button class="btn btn-secondary btn-sm" onclick="viewAgreement('${escapeHtml(agreement.type)}')">View</button>`;
          }

          return `
            <div class="agreement-item">
              <div class="agreement-info">
                <div class="agreement-status-dot ${statusClass}"></div>
                <div>
                  <div class="agreement-name">${escapeHtml(formatAgreementType(agreement.type))}</div>
                  <div class="agreement-meta">${escapeHtml(meta)}</div>
                </div>
              </div>
              <div class="agreement-actions">
                ${actions}
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading agreements:', error);
        listEl.innerHTML = '<p style="color: var(--color-error-500);">Failed to load agreements.</p>';
      }
    }

    // View an agreement
    function viewAgreement(type) {
      window.open(`/api/agreement?type=${encodeURIComponent(type)}`, '_blank');
    }

    // Profile modal functions
    const VALID_COMPANY_TYPES = ['brand', 'publisher', 'agency', 'adtech', 'data', 'ai', 'other'];
    const VALID_REVENUE_TIERS = ['under_1m', '1m_5m', '5m_50m', '50m_250m', '250m_1b', '1b_plus'];

    function showProfileModal() {
      // Prefill with enrichment-suggested values if available
      const suggestedCompanyType = currentOrg?.billing?.suggested_company_type;
      const suggestedRevenueTier = currentOrg?.billing?.suggested_revenue_tier;

      // Validate suggested values before using in selector to prevent injection
      if (suggestedCompanyType && VALID_COMPANY_TYPES.includes(suggestedCompanyType)) {
        const companyTypeOption = document.querySelector(
          `#companyTypeOptions .radio-option input[value="${suggestedCompanyType}"]`
        );
        if (companyTypeOption) {
          const label = companyTypeOption.closest('.radio-option');
          if (label) {
            selectRadioOption(label, 'companyType', suggestedCompanyType);
            companyTypeOption.checked = true;
          }
        }
      }

      // Validate suggested values before using in selector to prevent injection
      if (suggestedRevenueTier && VALID_REVENUE_TIERS.includes(suggestedRevenueTier)) {
        const revenueTierOption = document.querySelector(
          `#revenueTierOptions .radio-option input[value="${suggestedRevenueTier}"]`
        );
        if (revenueTierOption) {
          const label = revenueTierOption.closest('.radio-option');
          if (label) {
            selectRadioOption(label, 'revenueTier', suggestedRevenueTier);
            revenueTierOption.checked = true;
          }
        }
      }

      document.getElementById('profileModal').style.display = 'flex';
    }

    function hideProfileModal() {
      document.getElementById('profileModal').style.display = 'none';
    }

    function selectRadioOption(element, group, value) {
      // Update selected state for styling
      const container = element.closest('.radio-options');
      container.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
      element.classList.add('selected');

      // Store the selected value
      if (group === 'companyType') {
        selectedCompanyType = value;
      } else if (group === 'revenueTier') {
        selectedRevenueTier = value;
      }

      // Enable the save button if both fields are selected
      updateSaveProfileButton();
    }

    function updateSaveProfileButton() {
      const btn = document.getElementById('saveProfileBtn');
      btn.disabled = !(selectedCompanyType && selectedRevenueTier);
    }

    async function saveOrgProfile() {
      if (!selectedCompanyType || !selectedRevenueTier) return;

      const btn = document.getElementById('saveProfileBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const response = await fetch(`/api/organizations/${currentOrg.id}/billing-info`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            company_type: selectedCompanyType,
            revenue_tier: selectedRevenueTier
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to save organization info');
        }

        // Update local org data
        if (currentOrg.billing) {
          currentOrg.billing.company_type = selectedCompanyType;
          currentOrg.billing.revenue_tier = selectedRevenueTier;
        } else {
          currentOrg.billing = {
            company_type: selectedCompanyType,
            revenue_tier: selectedRevenueTier
          };
        }

        // Hide the modal and reload products with the new tier info
        hideProfileModal();
        showToast('Organization info saved');

        // Reload products now that we have revenue tier
        if (!currentOrg.billing?.status || currentOrg.billing.status !== 'active') {
          loadProducts();
        }

      } catch (error) {
        console.error('Error saving org profile:', error);
        showToast(error.message || 'Failed to save organization info', true);
        btn.disabled = false;
        btn.textContent = 'Continue to Membership';
      }
    }

    // Initialize
    loadBilling();
  </script>
</body>
</html>
