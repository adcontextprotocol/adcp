<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Admin - Addie - AdCP Registry</title>
  <link rel="stylesheet" href="/design-system.css">
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <style>
    /* =============================================================================
       Addie Admin Dashboard styles
       Uses design system variables - see /design-system.css for tokens
       ============================================================================= */

    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-lg);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }
    h1 { margin-bottom: var(--space-2.5); color: var(--color-text-heading); }
    h2 { margin-bottom: var(--space-4); color: var(--color-text-heading); font-size: var(--text-xl); }

    /* Stats row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }
    .stat-card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-5);
      box-shadow: var(--shadow-xs);
      text-align: center;
    }
    .stat-value {
      font-size: var(--text-3xl);
      font-weight: var(--font-bold);
      color: var(--color-brand);
    }
    .stat-label {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-1);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: var(--space-1);
      border-bottom: var(--border-1) solid var(--color-gray-200);
      margin-bottom: var(--space-5);
    }
    .tab {
      padding: var(--space-3) var(--space-5);
      background: transparent;
      border: none;
      border-bottom: var(--border-2) solid transparent;
      cursor: pointer;
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--color-text-secondary);
      transition: var(--transition-all);
    }
    .tab:hover {
      color: var(--color-text-heading);
    }
    .tab.active {
      color: var(--color-brand);
      border-bottom-color: var(--color-brand);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    /* Knowledge list */
    .knowledge-list {
      display: grid;
      gap: var(--space-3);
    }
    .knowledge-item {
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: var(--space-4);
    }
    .knowledge-item:hover {
      border-color: var(--color-brand);
    }
    .knowledge-info h3 {
      font-size: var(--text-base);
      margin-bottom: var(--space-1);
      color: var(--color-text-heading);
    }
    .knowledge-meta {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      display: flex;
      gap: var(--space-2.5);
      flex-wrap: wrap;
      align-items: center;
    }
    .knowledge-excerpt {
      font-size: var(--text-sm);
      color: var(--color-text-muted);
      margin-top: var(--space-2);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .knowledge-actions {
      display: flex;
      gap: var(--space-2);
      flex-shrink: 0;
    }

    /* Interactions list */
    .interactions-list {
      display: grid;
      gap: var(--space-3);
    }
    .interaction-item {
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-4);
    }
    .interaction-item.flagged {
      border-color: var(--color-warning-400);
      background: var(--color-warning-50);
    }
    .interaction-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-2);
    }
    .interaction-meta {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      display: flex;
      gap: var(--space-2.5);
      flex-wrap: wrap;
    }
    .interaction-content {
      margin-top: var(--space-3);
    }
    .interaction-input, .interaction-output {
      font-size: var(--text-sm);
      padding: var(--space-3);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-2);
    }
    .interaction-input {
      background: var(--color-gray-100);
    }
    .interaction-output {
      background: var(--color-primary-50);
    }
    .interaction-label {
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
    }

    /* Badges */
    .badge {
      display: inline-block;
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .badge-docs { background: var(--color-info-100); color: var(--color-info-700); }
    .badge-blog { background: var(--color-primary-100); color: var(--color-primary-700); }
    .badge-faq { background: var(--color-success-100); color: var(--color-success-700); }
    .badge-perspective { background: var(--color-warning-100); color: var(--color-warning-700); }
    .badge-guidelines { background: var(--color-gray-200); color: var(--color-gray-700); }
    .badge-active { background: var(--color-success-100); color: var(--color-success-700); }
    .badge-inactive { background: var(--color-gray-200); color: var(--color-gray-600); }
    .badge-flagged { background: var(--color-warning-100); color: var(--color-warning-700); }
    .badge-pending { background: var(--color-info-100); color: var(--color-info-700); }
    /* Channel badges */
    .badge-web { background: var(--color-primary-100); color: var(--color-primary-700); }
    .badge-slack { background: #4a154b20; color: #4a154b; }
    .badge-a2a { background: var(--color-success-100); color: var(--color-success-700); }
    .badge-email { background: var(--color-gray-200); color: var(--color-gray-700); }

    /* Buttons */
    .btn {
      padding: var(--space-2) var(--space-4);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .btn-small { padding: var(--space-1.5) var(--space-3); font-size: var(--text-xs); }
    .btn-primary { background: var(--color-brand); color: white; }
    .btn-primary:hover { background: var(--color-primary-700); }
    .btn-primary:disabled { background: var(--color-gray-400); cursor: not-allowed; }
    .btn-secondary { background: var(--color-gray-200); color: var(--color-text-heading); }
    .btn-secondary:hover { background: var(--color-gray-300); }
    .btn-danger { background: var(--color-error-500); color: white; }
    .btn-danger:hover { background: var(--color-error-600); }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--color-surface-overlay);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: var(--space-5);
    }
    .modal {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-8);
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .form-group {
      margin-bottom: var(--space-5);
    }
    .form-group label {
      display: block;
      margin-bottom: var(--space-1);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      font-size: var(--text-sm);
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: var(--space-2.5);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-family: inherit;
    }
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--color-brand);
    }
    .form-group textarea {
      min-height: 200px;
      font-family: var(--font-mono);
    }
    .form-group small {
      display: block;
      margin-top: var(--space-1);
      color: var(--color-text-secondary);
      font-size: var(--text-xs);
    }
    .modal-buttons {
      display: flex;
      gap: var(--space-2.5);
      justify-content: flex-end;
      margin-top: var(--space-6);
      padding-top: var(--space-5);
      border-top: var(--border-1) solid var(--color-gray-200);
    }

    /* Conversation Actions */
    .conversation-actions {
      margin-top: var(--space-4);
      padding: var(--space-4);
      background: var(--color-bg-subtle);
      border-radius: var(--radius-md);
    }
    .conversation-actions h4 {
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      margin-bottom: var(--space-3);
    }
    .action-buttons {
      display: flex;
      gap: var(--space-2);
      flex-wrap: wrap;
    }
    .extracted-links {
      margin-top: var(--space-3);
      padding-top: var(--space-3);
      border-top: 1px solid var(--color-border);
    }
    .extracted-links h5 {
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-2);
    }
    .extracted-links .link-item {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-1) 0;
      font-size: var(--text-sm);
    }
    .extracted-links .link-item a {
      color: var(--color-brand);
      text-decoration: none;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .extracted-links .link-item a:hover {
      text-decoration: underline;
    }
    .extracted-links .link-source {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      background: var(--color-gray-100);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
    }
    .action-form {
      margin-top: var(--space-4);
      padding: var(--space-4);
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
    }
    .action-form h4 {
      font-size: var(--text-base);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      margin-bottom: var(--space-4);
    }
    .action-form .form-group {
      margin-bottom: var(--space-3);
    }
    .action-form label {
      display: block;
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
    }
    .action-form .form-control {
      width: 100%;
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-family: inherit;
      background: var(--color-bg-card);
      color: var(--color-text);
    }
    .action-form textarea.form-control {
      resize: vertical;
      min-height: 80px;
    }
    .action-form .form-buttons {
      display: flex;
      gap: var(--space-2);
      justify-content: flex-end;
      margin-top: var(--space-4);
    }

    /* Header bar */
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-5);
    }
    .filter-row {
      display: flex;
      gap: var(--space-3);
      align-items: center;
    }
    .filter-row select, .filter-row input {
      padding: var(--space-2) var(--space-3);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: var(--space-10);
      color: var(--color-text-secondary);
    }
    .empty-state h3 {
      color: var(--color-text-heading);
      margin-bottom: var(--space-2);
    }

    /* Queue items */
    .queue-item {
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-3);
    }
    .queue-item-content {
      background: var(--color-bg-subtle);
      padding: var(--space-3);
      border-radius: var(--radius-sm);
      margin: var(--space-3) 0;
      font-size: var(--text-sm);
      white-space: pre-wrap;
    }
    .queue-item-actions {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-3);
    }

    /* Rules list */
    .rules-list {
      display: grid;
      gap: var(--space-3);
    }
    .rule-item {
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-4);
    }
    .rule-item:hover {
      border-color: var(--color-brand);
    }
    .rule-item.inactive {
      opacity: 0.6;
      background: var(--color-bg-subtle);
    }
    .rule-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-2);
    }
    .rule-info h3 {
      font-size: var(--text-base);
      margin-bottom: var(--space-1);
      color: var(--color-text-heading);
    }
    .rule-meta {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      display: flex;
      gap: var(--space-2.5);
      flex-wrap: wrap;
      align-items: center;
    }
    .rule-content-preview {
      font-size: var(--text-sm);
      color: var(--color-text-muted);
      margin-top: var(--space-2);
      padding: var(--space-2);
      background: var(--color-bg-subtle);
      border-radius: var(--radius-sm);
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      white-space: pre-wrap;
    }
    .rule-stats {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-2);
      display: flex;
      gap: var(--space-3);
    }
    .rule-actions {
      display: flex;
      gap: var(--space-2);
      flex-shrink: 0;
    }

    /* Rule type badges */
    .badge-system_prompt { background: var(--color-primary-100); color: var(--color-primary-700); }
    .badge-behavior { background: var(--color-info-100); color: var(--color-info-700); }
    .badge-knowledge { background: var(--color-success-100); color: var(--color-success-700); }
    .badge-constraint { background: var(--color-error-100); color: var(--color-error-700); }
    .badge-response_style { background: var(--color-warning-100); color: var(--color-warning-700); }
    /* Rule context badges */
    .badge-context-engagement { background: #fef3c7; color: #92400e; }
    .badge-context-admin { background: #fce7f3; color: #9d174d; }
    .badge-context-member { background: #dbeafe; color: #1e40af; }
    .badge-context-anonymous { background: #f3f4f6; color: #4b5563; }

    /* Suggestions list */
    .suggestions-list {
      display: grid;
      gap: var(--space-3);
    }
    .suggestion-item {
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .suggestion-item:hover {
      border-color: var(--color-brand);
      background: var(--color-bg-subtle);
    }
    .suggestion-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-2);
    }
    .suggestion-type {
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
    }
    .suggestion-confidence {
      font-size: var(--text-sm);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .suggestion-confidence.medium {
      background: var(--color-warning-100);
      color: var(--color-warning-700);
    }
    .suggestion-confidence.low {
      background: var(--color-gray-200);
      color: var(--color-gray-700);
    }
    .suggestion-reasoning {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-2);
    }
    .suggestion-preview {
      font-size: var(--text-sm);
      padding: var(--space-2);
      background: var(--color-bg-subtle);
      border-radius: var(--radius-sm);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .suggestions-stats {
      display: flex;
      gap: var(--space-4);
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }

    /* Badge for suggestion types */
    .badge-new_rule { background: var(--color-success-100); color: var(--color-success-700); }
    .badge-modify_rule { background: var(--color-info-100); color: var(--color-info-700); }
    .badge-disable_rule { background: var(--color-error-100); color: var(--color-error-700); }
    .badge-merge_rules { background: var(--color-warning-100); color: var(--color-warning-700); }
    .badge-experiment { background: var(--color-primary-100); color: var(--color-primary-700); }
    .badge-publish_content { background: var(--color-primary-100); color: var(--color-primary-700); }
    /* Content type badges */
    .badge-docs { background: var(--color-info-50); color: var(--color-info-600); }
    .badge-perspectives { background: var(--color-success-50); color: var(--color-success-600); }
    .badge-external_link { background: var(--color-gray-100); color: var(--color-gray-600); }

    /* Suggestion detail */
    .suggestion-detail-section {
      margin-bottom: var(--space-4);
    }
    .suggestion-detail-section h4 {
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-2);
    }
    .suggestion-detail-content {
      background: var(--color-bg-subtle);
      padding: var(--space-3);
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
      white-space: pre-wrap;
    }

    /* Rating stars */
    .rating-input {
      display: flex;
      gap: var(--space-1);
      margin: var(--space-2) 0;
    }
    .rating-input button {
      background: none;
      border: none;
      font-size: var(--text-xl);
      cursor: pointer;
      color: var(--color-gray-300);
      transition: var(--transition-all);
    }
    .rating-input button:hover,
    .rating-input button.active {
      color: var(--color-warning-500);
    }

    /* Conversations styles */
    .conversations-list {
      display: grid;
      gap: var(--space-3);
    }
    .conversation-item {
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .conversation-item:hover {
      border-color: var(--color-brand);
      background: var(--color-bg-subtle);
    }
    .conversation-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-2);
    }
    .conversation-preview {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .conversation-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--space-3);
      padding: var(--space-3);
      background: var(--color-bg-subtle);
      border-radius: var(--radius-md);
    }
    .conversation-stat {
      text-align: center;
    }
    .conversation-stat-value {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--color-brand);
    }
    .conversation-stat-label {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
    }

    /* Conversation detail modal */
    .message-thread {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
      max-height: 60vh;
      overflow-y: auto;
      padding-right: var(--space-2);
    }
    .message-item {
      padding: var(--space-3);
      border-radius: var(--radius-md);
    }
    .message-item.user {
      background: var(--color-gray-100);
      margin-right: var(--space-8);
    }
    .message-item.assistant {
      background: var(--color-primary-50);
      margin-left: var(--space-8);
    }
    .message-role {
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .message-latency {
      font-weight: var(--font-normal);
      color: var(--color-text-muted);
      background: var(--color-gray-100);
      padding: 1px 6px;
      border-radius: var(--radius-sm);
      font-size: 10px;
    }
    .message-content {
      font-size: var(--text-sm);
    }
    .message-content p {
      margin: 0 0 var(--space-2) 0;
    }
    .message-content p:last-child {
      margin-bottom: 0;
    }
    .message-content ul, .message-content ol {
      margin: 0 0 var(--space-2) 0;
      padding-left: var(--space-4);
    }
    .message-content code {
      background: var(--color-gray-100);
      padding: 1px 4px;
      border-radius: var(--radius-sm);
      font-family: monospace;
      font-size: 0.9em;
    }
    .message-content pre {
      background: var(--color-gray-900);
      color: var(--color-gray-100);
      padding: var(--space-3);
      border-radius: var(--radius-md);
      overflow-x: auto;
      margin: var(--space-2) 0;
    }
    .message-content pre code {
      background: none;
      padding: 0;
      color: inherit;
    }
    .message-content a {
      color: var(--color-brand);
      text-decoration: none;
    }
    .message-content a:hover {
      text-decoration: underline;
    }
    .message-content strong {
      font-weight: var(--font-semibold);
    }
    .execution-plan {
      margin-top: var(--space-3);
      padding: var(--space-3);
      background: var(--color-bg-card);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-sm);
    }
    .execution-plan-title {
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      color: var(--color-brand);
      margin-bottom: var(--space-2);
    }
    .tool-execution {
      font-size: var(--text-xs);
      padding: var(--space-2);
      background: var(--color-bg-subtle);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-2);
      font-family: var(--font-mono);
    }
    .tool-execution:last-child {
      margin-bottom: 0;
    }
    .tool-execution .tool-name {
      font-weight: var(--font-semibold);
      color: var(--color-info-600);
    }
    .tool-execution .tool-params {
      color: var(--color-text-secondary);
    }
    .tool-execution .tool-result {
      color: var(--color-success-600);
    }
    .tool-execution .tool-error {
      color: var(--color-error-600);
    }
    .tool-execution .tool-duration {
      color: var(--color-text-muted);
      font-size: var(--text-2xs);
    }

    /* Message feedback controls */
    .message-feedback {
      margin-top: var(--space-2);
      padding-top: var(--space-2);
      border-top: 1px solid var(--color-gray-200);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
    }
    .rating-buttons {
      display: flex;
      gap: var(--space-1);
    }
    .rating-btn {
      background: none;
      border: 1px solid var(--color-gray-300);
      border-radius: var(--radius-sm);
      padding: var(--space-1) var(--space-2);
      cursor: pointer;
      font-size: var(--text-sm);
      transition: var(--transition-all);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .rating-btn:hover {
      background: var(--color-gray-100);
      border-color: var(--color-gray-400);
    }
    .rating-btn.active, .rating-btn.selected {
      background: var(--color-brand);
      border-color: var(--color-brand);
      color: white;
    }
    .rating-btn.thumbs-up.selected {
      background: var(--color-success-500);
      border-color: var(--color-success-500);
    }
    .rating-btn.thumbs-down.selected {
      background: var(--color-error-500);
      border-color: var(--color-error-500);
    }
    .star-rating {
      display: flex;
      gap: 2px;
    }
    .star-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: var(--text-lg);
      color: var(--color-gray-300);
      padding: 0;
      transition: var(--transition-all);
    }
    .star-btn:hover, .star-btn.filled {
      color: var(--color-warning-500);
    }
    .feedback-expand-btn {
      background: none;
      border: none;
      color: var(--color-text-muted);
      font-size: var(--text-xs);
      cursor: pointer;
      padding: var(--space-1);
    }
    .feedback-expand-btn:hover {
      color: var(--color-text-secondary);
      text-decoration: underline;
    }
    .feedback-detail {
      width: 100%;
      margin-top: var(--space-2);
      padding: var(--space-3);
      background: var(--color-bg-subtle);
      border-radius: var(--radius-md);
      display: none;
    }
    .feedback-detail.expanded {
      display: block;
    }
    .feedback-tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
      margin-bottom: var(--space-2);
    }
    .feedback-tag {
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      border: 1px solid var(--color-gray-300);
      background: var(--color-bg-card);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .feedback-tag:hover {
      border-color: var(--color-brand);
    }
    .feedback-tag.selected {
      background: var(--color-brand);
      border-color: var(--color-brand);
      color: white;
    }
    .feedback-notes {
      width: 100%;
      padding: var(--space-2);
      border: 1px solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      resize: vertical;
      min-height: 60px;
      font-family: inherit;
    }
    .feedback-notes:focus {
      outline: none;
      border-color: var(--color-brand);
    }
    .feedback-actions {
      display: flex;
      justify-content: flex-end;
      gap: var(--space-2);
      margin-top: var(--space-2);
    }
    .existing-feedback {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-1) var(--space-2);
      background: var(--color-gray-100);
      border-radius: var(--radius-sm);
    }
    .existing-feedback .thumbs {
      font-size: var(--text-sm);
    }
    .existing-feedback .rating-source {
      font-size: var(--text-2xs);
      color: var(--color-text-muted);
      opacity: 0.7;
    }
    .thumbs-rating {
      display: flex;
      gap: var(--space-1);
    }

    /* Thread-level feedback panel */
    .thread-feedback-panel {
      margin-top: var(--space-4);
      padding: var(--space-4);
      background: var(--color-bg-subtle);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-gray-200);
    }
    .thread-feedback-panel h4 {
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      margin-bottom: var(--space-3);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .thread-overall-rating {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      margin-bottom: var(--space-3);
    }
    .thread-overall-rating label {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }
    .thread-feedback-textarea {
      width: 100%;
      padding: var(--space-3);
      border: 1px solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
      margin-bottom: var(--space-3);
    }
    .thread-feedback-textarea:focus {
      outline: none;
      border-color: var(--color-brand);
    }

    /* Execution diagnostics */
    .execution-diagnostics {
      margin-top: var(--space-2);
      padding-top: var(--space-2);
      border-top: 1px dashed var(--color-gray-200);
    }
    .diagnostics-toggle {
      background: none;
      border: none;
      color: var(--color-text-muted);
      font-size: var(--text-xs);
      cursor: pointer;
      padding: var(--space-1) 0;
      text-decoration: underline;
    }
    .diagnostics-toggle:hover {
      color: var(--color-brand);
    }
    .diagnostics-content {
      margin-top: var(--space-2);
      padding: var(--space-3);
      background: var(--color-bg-subtle);
      border-radius: var(--radius-md);
      font-size: var(--text-xs);
    }
    .diagnostics-section {
      margin-bottom: var(--space-3);
    }
    .diagnostics-section:last-child {
      margin-bottom: 0;
    }
    .diagnostics-section strong {
      display: block;
      color: var(--color-text-heading);
      margin-bottom: var(--space-1);
    }
    .timing-bars {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }
    .timing-row {
      display: flex;
      justify-content: space-between;
      padding: 2px var(--space-2);
      background: var(--color-bg-card);
      border-radius: var(--radius-sm);
    }
    .timing-row span:first-child {
      color: var(--color-text-secondary);
    }
    .timing-row span:last-child {
      font-family: var(--font-mono);
      color: var(--color-text-heading);
    }
    .rule-ids {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
    }
    .rule-id-badge {
      background: var(--color-info-100);
      color: var(--color-info-700);
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      font-size: 10px;
    }

    /* Router decision styling */
    .router-decision {
      margin-top: var(--space-2);
      padding-top: var(--space-2);
      border-top: 1px dashed var(--color-gray-200);
    }
    .router-decision-content {
      margin-top: var(--space-2);
      padding: var(--space-3);
      background: var(--color-bg-subtle);
      border-radius: var(--radius-md);
      font-size: var(--text-xs);
    }
    .router-action {
      font-weight: var(--font-semibold);
      padding: 1px 6px;
      border-radius: var(--radius-sm);
    }
    .router-action-respond {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .router-action-ignore {
      background: var(--color-gray-100);
      color: var(--color-gray-600);
    }
    .router-action-react {
      background: var(--color-warning-100);
      color: var(--color-warning-700);
    }
    .router-action-clarify {
      background: var(--color-info-100);
      color: var(--color-info-700);
    }
    .router-tools {
      color: var(--color-text-muted);
      font-family: var(--font-mono);
      font-size: 10px;
      margin-left: var(--space-2);
    }
    .router-reason {
      padding: var(--space-2);
      background: var(--color-bg-card);
      border-radius: var(--radius-sm);
      font-style: italic;
      color: var(--color-text-secondary);
    }

    /* Diagnosis panel */
    .diagnosis-content {
      background: var(--color-bg-subtle);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      line-height: 1.6;
      max-height: 400px;
      overflow-y: auto;
    }
    .diagnosis-content h1, .diagnosis-content h2, .diagnosis-content h3,
    .diagnosis-content h4, .diagnosis-content h5 {
      font-size: var(--text-sm);
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
      margin: var(--space-3) 0 var(--space-2) 0;
    }
    .diagnosis-content h1:first-child, .diagnosis-content h2:first-child {
      margin-top: 0;
    }
    .diagnosis-content ul, .diagnosis-content ol {
      margin: var(--space-2) 0;
      padding-left: var(--space-4);
    }
    .diagnosis-content li {
      margin-bottom: var(--space-1);
    }
    .diagnosis-content strong {
      color: var(--color-text-heading);
    }
    .diagnosis-loading {
      text-align: center;
      padding: var(--space-6);
      color: var(--color-text-muted);
    }

    /* Evaluation dashboard */
    .eval-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--space-3);
      margin-bottom: var(--space-4);
    }
    .eval-stat {
      background: var(--color-bg-card);
      border: 1px solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      text-align: center;
    }
    .eval-stat-value {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
    }
    .eval-stat-label {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }
    .eval-stat-value.positive { color: var(--color-success-600); }
    .eval-stat-value.negative { color: var(--color-error-600); }
    .eval-stat-value.warning { color: var(--color-warning-600); }
    .tags-distribution {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
    }
    .tag-stat {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2);
      background: var(--color-bg-subtle);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
    }
    .tag-stat-count {
      background: var(--color-brand);
      color: white;
      padding: 0 var(--space-1);
      border-radius: var(--radius-sm);
      font-weight: var(--font-semibold);
    }
    .low-rated-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    .low-rated-item {
      padding: var(--space-3);
      background: var(--color-error-50);
      border: 1px solid var(--color-error-200);
      border-radius: var(--radius-md);
      cursor: pointer;
    }
    .low-rated-item:hover {
      background: var(--color-error-100);
    }
    .low-rated-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-1);
    }
    .low-rated-rating {
      color: var(--color-error-600);
      font-weight: var(--font-bold);
    }
    .low-rated-content {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <!-- AAO top navigation -->
  <div id="adcp-nav"></div>

  <div class="container">
    <h1>Addie Dashboard</h1>
    <p style="color: var(--color-text-secondary); margin-bottom: var(--space-6);">
      Manage Addie's knowledge base, view interactions, and review pending actions.
    </p>

    <!-- Stats row -->
    <div class="stats-row" id="stats-row">
      <div class="stat-card">
        <div class="stat-value" id="stat-knowledge">-</div>
        <div class="stat-label">Knowledge Documents</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-threads">-</div>
        <div class="stat-label">Threads (30d)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-messages">-</div>
        <div class="stat-label">Messages (30d)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-flagged">-</div>
        <div class="stat-label">Flagged</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-pending">-</div>
        <div class="stat-label">Pending Approval</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="rules">Rules</button>
      <button class="tab" data-tab="suggestions">Suggestions</button>
      <button class="tab" data-tab="knowledge">Knowledge Base</button>
      <button class="tab" data-tab="threads">Threads</button>
      <button class="tab" data-tab="evaluation">Evaluation</button>
      <button class="tab" data-tab="performance">Performance</button>
      <button class="tab" data-tab="queue">Approval Queue</button>
    </div>

    <!-- Rules Tab -->
    <div class="tab-content active" id="tab-rules">
      <div class="card">
        <div class="header-bar">
          <div class="filter-row">
            <select id="rule-type-filter">
              <option value="">All Types</option>
              <option value="system_prompt">System Prompt</option>
              <option value="behavior">Behavior</option>
              <option value="knowledge">Knowledge</option>
              <option value="constraint">Constraint</option>
              <option value="response_style">Response Style</option>
            </select>
            <label><input type="checkbox" id="active-rules-only" checked> Active only</label>
          </div>
          <div style="display: flex; gap: var(--space-2);">
            <button class="btn btn-secondary" onclick="viewSystemPrompt()">View System Prompt</button>
            <button class="btn btn-primary" onclick="openRuleModal()">Add Rule</button>
          </div>
        </div>
        <div class="rules-list" id="rules-list">
          <div class="empty-state">
            <h3>Loading...</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Suggestions Tab -->
    <div class="tab-content" id="tab-suggestions">
      <div class="card">
        <div class="header-bar">
          <div>
            <h2 style="margin: 0;">Claude's Suggestions</h2>
            <p style="color: var(--color-text-secondary); font-size: var(--text-sm); margin-top: var(--space-1);">
              AI-generated recommendations to improve Addie's behavior
            </p>
          </div>
          <button class="btn btn-primary" onclick="runAnalysis()" id="run-analysis-btn">Run Analysis</button>
        </div>
        <div class="suggestions-stats" id="suggestions-stats" style="margin-bottom: var(--space-4);"></div>
        <div class="suggestions-list" id="suggestions-list">
          <div class="empty-state">
            <h3>Loading...</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Knowledge Base Tab -->
    <div class="tab-content" id="tab-knowledge">
      <div class="card">
        <div class="header-bar">
          <div class="filter-row">
            <select id="source-type-filter">
              <option value="">All Sources</option>
              <option value="docs">Documentation</option>
              <option value="curated">External Resources</option>
              <option value="slack">Slack Messages</option>
            </select>
            <select id="category-filter">
              <option value="">All Categories</option>
              <option value="docs">Documentation</option>
              <option value="blog">Blog Posts</option>
              <option value="faq">FAQ</option>
              <option value="perspective">Perspectives</option>
              <option value="guidelines">Guidelines</option>
              <option value="industry">Industry</option>
            </select>
            <select id="fetch-status-filter" style="display: none;">
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="success">Fetched</option>
              <option value="failed">Failed</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="openKnowledgeModal()">Add Knowledge</button>
        </div>
        <div class="knowledge-stats" id="knowledge-stats" style="margin-bottom: var(--space-4);"></div>
        <div class="knowledge-list" id="knowledge-list">
          <div class="empty-state">
            <h3>Loading...</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Resource Edit Modal -->
    <div class="modal-overlay" id="resource-modal">
      <div class="modal" style="max-width: 800px;">
        <h2 id="resource-modal-title">Edit Resource</h2>
        <div id="resource-detail">
          <div class="form-group">
            <label>Title</label>
            <div id="resource-title" style="padding: var(--space-2); background: var(--color-bg-subtle); border-radius: var(--radius);"></div>
          </div>
          <div class="form-group">
            <label>URL</label>
            <div id="resource-url" style="padding: var(--space-2); background: var(--color-bg-subtle); border-radius: var(--radius); word-break: break-all;"></div>
          </div>
          <div class="form-group">
            <label>Summary</label>
            <div id="resource-summary" style="padding: var(--space-2); background: var(--color-bg-subtle); border-radius: var(--radius); white-space: pre-wrap;"></div>
          </div>
          <div class="form-group">
            <label>Key Insights</label>
            <div id="resource-insights" style="padding: var(--space-2); background: var(--color-bg-subtle); border-radius: var(--radius);"></div>
          </div>
          <div class="form-group">
            <label for="resource-addie-notes">Addie's Take (editable)</label>
            <textarea id="resource-addie-notes" rows="4" placeholder="Why this matters for AdCP and what developers/marketers should learn from this..."></textarea>
          </div>
          <div class="form-group">
            <label for="resource-quality">Quality Score (1-5)</label>
            <select id="resource-quality">
              <option value="1">1 - Low quality or not relevant</option>
              <option value="2">2 - Limited relevance</option>
              <option value="3">3 - Useful context</option>
              <option value="4">4 - Good quality, relevant</option>
              <option value="5">5 - Authoritative, highly relevant</option>
            </select>
          </div>
          <div class="form-group">
            <label for="resource-tags">Relevance Tags (comma-separated)</label>
            <input type="text" id="resource-tags" placeholder="mcp, a2a, industry-trend, competitor">
          </div>
        </div>
        <input type="hidden" id="resource-edit-id">
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeResourceModal()">Cancel</button>
          <button type="button" class="btn btn-secondary" onclick="refetchResource()">Re-fetch</button>
          <button type="button" class="btn btn-primary" onclick="saveResource()">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Threads Tab (unified web + slack + a2a) -->
    <div class="tab-content" id="tab-threads">
      <div class="card">
        <div class="header-bar">
          <div>
            <h2 style="margin: 0;">Conversation Threads</h2>
            <p style="color: var(--color-text-secondary); font-size: var(--text-sm); margin-top: var(--space-1);">
              Browse conversations across all channels (Web, Slack, A2A)
            </p>
          </div>
          <div class="filter-row">
            <select id="stats-timeframe">
              <option value="7d" selected>This Week</option>
              <option value="24h">Last 24 Hours</option>
              <option value="30d">Last 30 Days</option>
              <option value="all">All Time</option>
            </select>
            <select id="channel-filter">
              <option value="">All Channels</option>
              <option value="web">Web</option>
              <option value="slack">Slack</option>
              <option value="a2a">A2A</option>
            </select>
            <label><input type="checkbox" id="threads-flagged-only"> Flagged only</label>
            <label><input type="checkbox" id="threads-unreviewed-only"> Unreviewed only</label>
            <label><input type="checkbox" id="threads-has-feedback"> Has user feedback</label>
            <button class="btn btn-secondary" onclick="loadThreads()">Refresh</button>
          </div>
        </div>
        <div class="threads-stats" id="threads-stats" style="margin-bottom: var(--space-4);"></div>
        <div class="threads-list" id="threads-list">
          <div class="empty-state">
            <h3>Loading...</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Evaluation Tab -->
    <div class="tab-content" id="tab-evaluation">
      <div class="card">
        <div class="header-bar">
          <div>
            <h2 style="margin: 0;">Evaluation Dashboard</h2>
            <p style="color: var(--color-text-secondary); font-size: var(--text-sm); margin-top: var(--space-1);">
              Training data and feedback metrics for evaluating rule changes
            </p>
          </div>
          <div class="filter-row">
            <select id="eval-days-filter" onchange="loadEvaluationData()">
              <option value="7">Last 7 days</option>
              <option value="30" selected>Last 30 days</option>
              <option value="90">Last 90 days</option>
            </select>
            <button class="btn btn-primary btn-small" onclick="loadEvaluationData()">Refresh</button>
          </div>
        </div>

        <!-- Summary Stats -->
        <div class="eval-stats-grid" id="eval-stats">
          <div class="eval-stat">
            <div class="eval-stat-value" id="eval-total">-</div>
            <div class="eval-stat-label">Total Responses</div>
          </div>
          <div class="eval-stat">
            <div class="eval-stat-value" id="eval-rated">-</div>
            <div class="eval-stat-label">Rated</div>
          </div>
          <div class="eval-stat">
            <div class="eval-stat-value" id="eval-avg-rating">-</div>
            <div class="eval-stat-label">Avg Rating</div>
          </div>
          <div class="eval-stat">
            <div class="eval-stat-value positive" id="eval-positive">-</div>
            <div class="eval-stat-label">Positive (4-5)</div>
          </div>
          <div class="eval-stat">
            <div class="eval-stat-value negative" id="eval-negative">-</div>
            <div class="eval-stat-label">Negative (1-2)</div>
          </div>
          <div class="eval-stat">
            <div class="eval-stat-value warning" id="eval-flagged">-</div>
            <div class="eval-stat-label">Flagged</div>
          </div>
        </div>

        <!-- Feedback Tags Distribution -->
        <h3 style="font-size: var(--text-base); margin: var(--space-4) 0 var(--space-2) 0;">Feedback Tags</h3>
        <div class="tags-distribution" id="eval-tags">
          <span style="color: var(--color-text-muted);">No feedback tags yet</span>
        </div>

        <!-- Low Rated Threads -->
        <h3 style="font-size: var(--text-base); margin: var(--space-4) 0 var(--space-2) 0;">Low-Rated Threads (for review)</h3>
        <div class="low-rated-list" id="eval-low-rated">
          <span style="color: var(--color-text-muted);">No low-rated threads</span>
        </div>
      </div>
    </div>

    <!-- Performance Tab -->
    <div class="tab-content" id="tab-performance">
      <div class="card">
        <div class="header-bar">
          <div>
            <h2 style="margin: 0;">Performance Metrics</h2>
            <p style="color: var(--color-text-secondary); font-size: var(--text-sm); margin-top: var(--space-1);">
              Latency, token usage, and tool performance analysis
            </p>
          </div>
          <div class="filter-row">
            <select id="perf-days-filter" onchange="loadPerformance()">
              <option value="1">Last 24 hours</option>
              <option value="7" selected>Last 7 days</option>
              <option value="30">Last 30 days</option>
            </select>
            <button class="btn btn-secondary" onclick="loadPerformance()">Refresh</button>
          </div>
        </div>

        <!-- Performance Summary Cards -->
        <div class="perf-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-3); margin-bottom: var(--space-5);">
          <div class="stat-card">
            <div class="stat-value" id="perf-total-messages">-</div>
            <div class="stat-label">Total Messages</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="perf-p50-latency">-</div>
            <div class="stat-label">P50 Latency</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="perf-p95-latency">-</div>
            <div class="stat-label">P95 Latency</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="perf-avg-tokens">-</div>
            <div class="stat-label">Avg Tokens/Msg</div>
          </div>
        </div>

        <!-- Latency Distribution -->
        <div style="margin-bottom: var(--space-5);">
          <h3 style="margin-bottom: var(--space-3);">Latency Distribution</h3>
          <div id="latency-chart" style="display: flex; gap: var(--space-2); align-items: flex-end; height: 150px;"></div>
        </div>

        <!-- Performance by Model -->
        <div style="margin-bottom: var(--space-5);">
          <h3 style="margin-bottom: var(--space-3);">By Model</h3>
          <table class="perf-table" style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: var(--border-1) solid var(--color-gray-200);">
                <th style="text-align: left; padding: var(--space-2);">Model</th>
                <th style="text-align: right; padding: var(--space-2);">Count</th>
                <th style="text-align: right; padding: var(--space-2);">Avg Latency</th>
                <th style="text-align: right; padding: var(--space-2);">P50 Latency</th>
                <th style="text-align: right; padding: var(--space-2);">Tokens (In/Out)</th>
              </tr>
            </thead>
            <tbody id="perf-by-model"></tbody>
          </table>
        </div>

        <!-- Performance by Tool -->
        <div style="margin-bottom: var(--space-5);">
          <h3 style="margin-bottom: var(--space-3);">By Tool</h3>
          <p style="color: var(--color-text-secondary); font-size: var(--text-sm); margin-bottom: var(--space-2);">
            Tool-level timing requires data collected after deployment. Historical data may show "-" for duration.
          </p>
          <table class="perf-table" style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: var(--border-1) solid var(--color-gray-200);">
                <th style="text-align: left; padding: var(--space-2);">Tool</th>
                <th style="text-align: right; padding: var(--space-2);">Calls</th>
                <th style="text-align: right; padding: var(--space-2);">Avg Duration</th>
                <th style="text-align: right; padding: var(--space-2);">P50 Duration</th>
                <th style="text-align: right; padding: var(--space-2);">P95 Duration</th>
                <th style="text-align: right; padding: var(--space-2);">Errors</th>
              </tr>
            </thead>
            <tbody id="perf-by-tool"></tbody>
          </table>
        </div>

        <!-- Performance by Channel -->
        <div>
          <h3 style="margin-bottom: var(--space-3);">By Channel</h3>
          <table class="perf-table" style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: var(--border-1) solid var(--color-gray-200);">
                <th style="text-align: left; padding: var(--space-2);">Channel</th>
                <th style="text-align: right; padding: var(--space-2);">Messages</th>
                <th style="text-align: right; padding: var(--space-2);">Avg Latency</th>
              </tr>
            </thead>
            <tbody id="perf-by-channel"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Conversation Detail Modal -->
    <div class="modal-overlay" id="conversation-modal">
      <div class="modal" style="max-width: 900px;">
        <h2 id="conversation-modal-title">Conversation</h2>
        <div id="conversation-detail"></div>
        <!-- Thread Feedback Panel -->
        <div id="thread-feedback-panel" class="thread-feedback-panel" style="display: none;">
          <h4>Your Feedback on This Thread</h4>
          <div class="thread-overall-rating">
            <label>Overall:</label>
            <div class="rating-buttons">
              <button class="rating-btn thumbs-down" onclick="setThreadRating('negative')" id="thread-thumbs-down" title="Thumbs down">
                <span></span>
              </button>
              <button class="rating-btn thumbs-up" onclick="setThreadRating('positive')" id="thread-thumbs-up" title="Thumbs up">
                <span></span>
              </button>
            </div>
          </div>
          <textarea
            id="thread-feedback-notes"
            class="thread-feedback-textarea"
            placeholder="What did you like? What could be better? Be specific about what Addie did well or poorly..."
          ></textarea>
          <div class="feedback-tags" id="thread-feedback-tags">
            <span class="feedback-tag" data-tag="accurate" onclick="toggleThreadTag(this)">Accurate</span>
            <span class="feedback-tag" data-tag="helpful" onclick="toggleThreadTag(this)">Helpful</span>
            <span class="feedback-tag" data-tag="well_cited" onclick="toggleThreadTag(this)">Well cited</span>
            <span class="feedback-tag" data-tag="good_tone" onclick="toggleThreadTag(this)">Good tone</span>
            <span class="feedback-tag" data-tag="inaccurate" onclick="toggleThreadTag(this)">Inaccurate</span>
            <span class="feedback-tag" data-tag="missing_info" onclick="toggleThreadTag(this)">Missing info</span>
            <span class="feedback-tag" data-tag="wrong_source" onclick="toggleThreadTag(this)">Wrong source</span>
            <span class="feedback-tag" data-tag="too_verbose" onclick="toggleThreadTag(this)">Too verbose</span>
            <span class="feedback-tag" data-tag="too_brief" onclick="toggleThreadTag(this)">Too brief</span>
            <span class="feedback-tag" data-tag="wrong_tone" onclick="toggleThreadTag(this)">Wrong tone</span>
          </div>
          <div class="feedback-actions">
            <button class="btn btn-secondary btn-small" onclick="clearThreadFeedback()">Clear</button>
            <button class="btn btn-primary btn-small" onclick="saveThreadFeedback()">Save Feedback</button>
          </div>
        </div>
        <!-- Claude Diagnosis Panel -->
        <div id="diagnosis-panel" class="action-form" style="display: none;">
          <h4>Claude's Analysis</h4>
          <div id="diagnosis-content" class="diagnosis-content"></div>
          <div class="form-buttons">
            <button class="btn btn-secondary" onclick="hideDiagnosisPanel()">Close</button>
          </div>
        </div>
        <!-- Conversation Actions -->
        <div id="conversation-actions" class="conversation-actions" style="display: none;">
          <h4>Actions</h4>
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="diagnoseThread()" id="btn-diagnose">
              Diagnose with Claude
            </button>
            <button class="btn btn-secondary" onclick="showPerspectivesForm()" id="btn-add-perspectives">
               Add to Perspectives
            </button>
            <button class="btn btn-secondary" onclick="showDocsIssueForm()" id="btn-docs-issue">
               Create Docs Issue
            </button>
            <button class="btn btn-secondary" onclick="showRuleSuggestionForm()" id="btn-rule-suggestion">
               Suggest Rule Change
            </button>
          </div>
          <!-- Extracted Links -->
          <div id="extracted-links" class="extracted-links" style="display: none;">
            <h5>Sources Found in Conversation</h5>
            <div id="links-list"></div>
          </div>
        </div>
        <!-- Action Forms (hidden by default) -->
        <div id="perspectives-form" class="action-form" style="display: none;">
          <h4>Add to Perspectives</h4>
          <div class="form-group">
            <label>Source URL</label>
            <select id="perspectives-url" class="form-control">
              <option value="">Select or enter URL...</option>
            </select>
            <input type="text" id="perspectives-url-custom" class="form-control" placeholder="Or enter custom URL" style="margin-top: var(--space-2);">
          </div>
          <div class="form-group">
            <label>Topic/Title</label>
            <input type="text" id="perspectives-topic" class="form-control" placeholder="e.g., Understanding DSP Architecture">
          </div>
          <div class="form-group">
            <label>Addie's Take (summary/interpretation)</label>
            <textarea id="perspectives-take" class="form-control" rows="4" placeholder="How this relates to AdCP and agentic advertising..."></textarea>
          </div>
          <div class="form-buttons">
            <button class="btn btn-secondary" onclick="hideActionForms()">Cancel</button>
            <button class="btn btn-primary" onclick="submitPerspectivesEntry()">Create Entry</button>
          </div>
        </div>
        <div id="docs-issue-form" class="action-form" style="display: none;">
          <h4>Create Documentation Issue</h4>
          <div class="form-group">
            <label>Issue Title</label>
            <input type="text" id="docs-issue-title" class="form-control" placeholder="e.g., Add section on RTB protocol comparison">
          </div>
          <div class="form-group">
            <label>What's Missing?</label>
            <textarea id="docs-issue-description" class="form-control" rows="4" placeholder="Describe what documentation should be added or improved..."></textarea>
          </div>
          <div class="form-group">
            <label>Suggested Location</label>
            <select id="docs-issue-location" class="form-control">
              <option value="">Select section...</option>
              <option value="intro">Introduction / Getting Started</option>
              <option value="media-buy">Media Buy</option>
              <option value="creative">Creative</option>
              <option value="signals">Signals</option>
              <option value="protocols">Protocols</option>
              <option value="reference">Reference</option>
            </select>
          </div>
          <div class="form-buttons">
            <button class="btn btn-secondary" onclick="hideActionForms()">Cancel</button>
            <button class="btn btn-primary" onclick="submitDocsIssue()">Create Suggestion</button>
          </div>
        </div>
        <div id="rule-suggestion-form" class="action-form" style="display: none;">
          <h4>Suggest Rule Change</h4>
          <div class="form-group">
            <label>Suggestion Type</label>
            <select id="rule-suggestion-type" class="form-control">
              <option value="new_rule">New Rule</option>
              <option value="modify_rule">Modify Existing Rule</option>
            </select>
          </div>
          <div class="form-group">
            <label>Rule Name</label>
            <input type="text" id="rule-suggestion-name" class="form-control" placeholder="e.g., Citation Format">
          </div>
          <div class="form-group">
            <label>Rule Type</label>
            <select id="rule-suggestion-rule-type" class="form-control">
              <option value="behavior">Behavior</option>
              <option value="response_style">Response Style</option>
              <option value="constraint">Constraint</option>
              <option value="knowledge">Knowledge</option>
            </select>
          </div>
          <div class="form-group">
            <label>Suggested Content</label>
            <textarea id="rule-suggestion-content" class="form-control" rows="4" placeholder="The rule content..."></textarea>
          </div>
          <div class="form-group">
            <label>Reasoning</label>
            <textarea id="rule-suggestion-reasoning" class="form-control" rows="2" placeholder="Why this change would help..."></textarea>
          </div>
          <div class="form-buttons">
            <button class="btn btn-secondary" onclick="hideActionForms()">Cancel</button>
            <button class="btn btn-primary" onclick="submitRuleSuggestion()">Create Suggestion</button>
          </div>
        </div>
        <div class="modal-buttons">
          <button class="btn btn-secondary" onclick="closeConversationModal()">Close</button>
        </div>
      </div>
    </div>

    <!-- Approval Queue Tab -->
    <div class="tab-content" id="tab-queue">
      <div class="card">
        <div id="queue-list">
          <div class="empty-state">
            <h3>Loading...</h3>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Rule Modal -->
  <div class="modal-overlay" id="rule-modal">
    <div class="modal">
      <h2 id="rule-modal-title">Add Rule</h2>
      <form id="rule-form">
        <input type="hidden" id="rule-id">
        <div class="form-group">
          <label for="rule-name">Name</label>
          <input type="text" id="rule-name" required placeholder="e.g., Knowledge Search First">
        </div>
        <div class="form-group">
          <label for="rule-type">Type</label>
          <select id="rule-type" required>
            <option value="system_prompt">System Prompt</option>
            <option value="behavior">Behavior</option>
            <option value="knowledge">Knowledge</option>
            <option value="constraint">Constraint</option>
            <option value="response_style">Response Style</option>
          </select>
          <small>
            <strong>System Prompt:</strong> Core identity and personality |
            <strong>Behavior:</strong> Specific actions to take |
            <strong>Knowledge:</strong> Domain facts |
            <strong>Constraint:</strong> Things NOT to do |
            <strong>Response Style:</strong> Formatting preferences
          </small>
        </div>
        <div class="form-group">
          <label for="rule-context">Context</label>
          <select id="rule-context">
            <option value="">Default (Main Prompt)</option>
            <option value="engagement">Engagement (Should Respond)</option>
            <option value="admin">Admin Users Only</option>
            <option value="member">Members Only</option>
            <option value="anonymous">Anonymous Users Only</option>
          </select>
          <small>
            <strong>Default:</strong> Always in main system prompt |
            <strong>Engagement:</strong> "Should I respond?" evaluation |
            <strong>Admin/Member/Anonymous:</strong> User type specific rules
          </small>
        </div>
        <div class="form-group">
          <label for="rule-description">Description (optional)</label>
          <input type="text" id="rule-description" placeholder="Brief description of what this rule does">
        </div>
        <div class="form-group">
          <label for="rule-priority">Priority</label>
          <input type="number" id="rule-priority" value="0" min="0" max="100">
          <small>Higher priority rules are applied first (0-100)</small>
        </div>
        <div class="form-group">
          <label for="rule-content">Content</label>
          <textarea id="rule-content" required placeholder="Enter the rule content here..."></textarea>
          <small>Use clear, direct language. This will be included in Addie's system prompt.</small>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeRuleModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- System Prompt Modal -->
  <div class="modal-overlay" id="system-prompt-modal">
    <div class="modal" style="max-width: 1000px;">
      <h2>Current System Prompt</h2>
      <p style="color: var(--color-text-secondary); margin-bottom: var(--space-4);">
        This is the compiled prompt sent to Claude, built from all active rules.
      </p>
      <div id="system-prompt-content" style="background: var(--color-bg-subtle); padding: var(--space-4); border-radius: var(--radius-md); white-space: pre-wrap; font-family: var(--font-mono); font-size: var(--text-sm); max-height: 60vh; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button type="button" class="btn btn-secondary" onclick="closeSystemPromptModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Suggestion Detail Modal -->
  <div class="modal-overlay" id="suggestion-modal">
    <div class="modal">
      <h2 id="suggestion-modal-title">Suggestion Details</h2>
      <div id="suggestion-detail-content"></div>
      <div class="modal-buttons" id="suggestion-modal-buttons"></div>
    </div>
  </div>

  <!-- Knowledge Modal -->
  <div class="modal-overlay" id="knowledge-modal">
    <div class="modal">
      <h2 id="knowledge-modal-title">Add Knowledge</h2>
      <form id="knowledge-form">
        <input type="hidden" id="knowledge-id">
        <div class="form-group">
          <label for="knowledge-title">Title</label>
          <input type="text" id="knowledge-title" required>
        </div>
        <div class="form-group">
          <label for="knowledge-category">Category</label>
          <select id="knowledge-category" required>
            <option value="docs">Documentation</option>
            <option value="blog">Blog Post</option>
            <option value="faq">FAQ</option>
            <option value="perspective">Perspective</option>
            <option value="guidelines">Guidelines</option>
          </select>
        </div>
        <div class="form-group">
          <label for="knowledge-source-url">Source URL (optional)</label>
          <input type="url" id="knowledge-source-url" placeholder="https://...">
        </div>
        <div class="form-group">
          <label for="knowledge-content">Content</label>
          <textarea id="knowledge-content" required placeholder="Enter the knowledge content here..."></textarea>
          <small>Use plain text. Markdown is not currently supported.</small>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeKnowledgeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Tab switching with lazy loading
    const loadedTabs = new Set(['rules']); // Track which tabs have been loaded
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');

        // Lazy load tab data
        const tabName = tab.dataset.tab;
        if (!loadedTabs.has(tabName)) {
          loadedTabs.add(tabName);
          if (tabName === 'performance') loadPerformance();
          if (tabName === 'threads') loadThreads();
          if (tabName === 'evaluation') loadEvaluationData();
          if (tabName === 'knowledge') loadKnowledge();
          if (tabName === 'queue') loadQueue();
          if (tabName === 'suggestions') loadSuggestions();
        }
      });
    });

    // Load stats
    async function loadStats() {
      try {
        const [knowledgeRes, threadsRes, queueRes] = await Promise.all([
          fetch('/api/admin/addie/knowledge/categories'),
          fetch('/api/admin/addie/threads/stats'),
          fetch('/api/admin/addie/queue/stats')
        ]);

        const knowledge = await knowledgeRes.json();
        const threads = await threadsRes.json();
        const queue = await queueRes.json();

        const totalKnowledge = knowledge.categories?.reduce((sum, c) => sum + c.count, 0) || 0;
        document.getElementById('stat-knowledge').textContent = totalKnowledge;
        document.getElementById('stat-threads').textContent = threads.threads_30d || 0;
        document.getElementById('stat-messages').textContent = threads.messages_30d || 0;
        document.getElementById('stat-flagged').textContent = threads.flagged_threads || 0;
        document.getElementById('stat-pending').textContent = queue.pending || 0;
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load unified knowledge list (docs, curated resources, slack messages)
    async function loadKnowledge() {
      const sourceType = document.getElementById('source-type-filter').value;
      const category = document.getElementById('category-filter').value;
      const fetchStatus = document.getElementById('fetch-status-filter').value;

      // Show/hide fetch status filter based on source type
      const fetchStatusFilter = document.getElementById('fetch-status-filter');
      fetchStatusFilter.style.display = sourceType === 'curated' ? 'block' : 'none';

      // Build URL with filters
      const params = new URLSearchParams();
      if (sourceType) params.append('source_type', sourceType);
      if (category) params.append('category', category);
      if (fetchStatus && sourceType === 'curated') params.append('status', fetchStatus);

      const url = '/api/admin/addie/knowledge' + (params.toString() ? '?' + params.toString() : '');

      try {
        // Load stats
        const statsRes = await fetch('/api/admin/addie/resources/stats');
        const stats = await statsRes.json();
        document.getElementById('knowledge-stats').innerHTML = `
          <div style="display: flex; gap: var(--space-4); flex-wrap: wrap;">
            <span class="badge badge-info">Total: ${stats.total}</span>
            ${sourceType === 'curated' || !sourceType ? `
              <span class="badge badge-warning">Pending: ${stats.pending}</span>
              <span class="badge badge-success">Fetched: ${stats.success}</span>
              <span class="badge badge-error">Failed: ${stats.failed}</span>
            ` : ''}
          </div>
        `;

        const response = await fetch(url);
        const data = await response.json();

        const list = document.getElementById('knowledge-list');
        const docs = data.documents || [];

        if (docs.length === 0) {
          list.innerHTML = '<div class="empty-state"><h3>No knowledge documents</h3><p>Add some knowledge to help Addie answer questions.</p></div>';
          return;
        }

        list.innerHTML = docs.map(doc => {
          const isCurated = doc.source_type === 'curated';
          const isSlack = doc.source_type === 'slack';

          // Quality stars for curated content
          const qualityStars = doc.quality_score
            ? ''.repeat(doc.quality_score) + ''.repeat(5 - doc.quality_score)
            : '';

          // Tags for curated content
          const tags = doc.relevance_tags?.length ? doc.relevance_tags.join(', ') : '';

          // Fetch status badge for curated content
          const statusBadge = isCurated && doc.fetch_status
            ? `<span class="badge ${doc.fetch_status === 'pending' ? 'badge-warning' : doc.fetch_status === 'success' ? 'badge-success' : 'badge-error'}">${doc.fetch_status}</span>`
            : '';

          // Source type badge
          const sourceTypeBadge = `<span class="badge badge-${doc.source_type || 'docs'}">${doc.source_type || 'docs'}</span>`;

          // Slack-specific info
          const slackInfo = isSlack && doc.slack_channel_name
            ? `<span class="badge badge-info">#${doc.slack_channel_name}</span><span style="color: var(--color-text-muted);">@${doc.slack_username || 'unknown'}</span>`
            : '';

          // URL link
          const urlLink = doc.source_url || doc.fetch_url || doc.slack_permalink;
          const urlHtml = urlLink
            ? `<a href="${escapeHtml(urlLink)}" target="_blank" onclick="event.stopPropagation();" style="color: var(--color-brand);">${isSlack ? 'View in Slack' : 'Source'}</a>`
            : '';

          // Content preview
          const contentPreview = doc.summary
            ? `<strong>Summary:</strong> ${escapeHtml(doc.summary)}`
            : doc.content
              ? escapeHtml(doc.content.substring(0, 200)) + '...'
              : '';

          // Addie's take for curated content
          const addieNotes = isCurated && doc.addie_notes
            ? `<div class="knowledge-excerpt" style="color: var(--color-primary-600);"><strong>Addie's Take:</strong> ${escapeHtml(doc.addie_notes)}</div>`
            : '';

          // Click handler and edit button depend on source type
          const clickHandler = isCurated ? `onclick="editResource(${doc.id})"` : '';
          const cursorStyle = isCurated ? 'cursor: pointer;' : '';

          // Actions based on source type
          let actions = '';
          if (isCurated) {
            const retryBtn = doc.fetch_status === 'failed' || doc.fetch_status === 'pending'
              ? `<button class="btn btn-small btn-primary" onclick="retryFetch(${doc.id})">${doc.fetch_status === 'failed' ? 'Retry' : 'Fetch Now'}</button>`
              : `<button class="btn btn-small btn-secondary" onclick="retryFetch(${doc.id})">Re-fetch</button>`;
            actions = `
              ${retryBtn}
              <button class="btn btn-small btn-secondary" onclick="editResource(${doc.id})">Edit</button>
              <button class="btn btn-small btn-danger" onclick="deleteResource(${doc.id})">Delete</button>
            `;
          } else if (!isSlack) {
            actions = `
              <button class="btn btn-small btn-secondary" onclick="editKnowledge(${doc.id})">Edit</button>
              <button class="btn btn-small ${doc.is_active ? 'btn-secondary' : 'btn-primary'}" onclick="toggleKnowledgeActive(${doc.id}, ${!doc.is_active})">
                ${doc.is_active ? 'Deactivate' : 'Activate'}
              </button>
              <button class="btn btn-small btn-danger" onclick="deleteKnowledge(${doc.id})">Delete</button>
            `;
          }

          return `
            <div class="knowledge-item" style="${cursorStyle}" ${clickHandler}>
              <div class="knowledge-info">
                <h3>${escapeHtml(doc.title)}</h3>
                <div class="knowledge-meta">
                  ${sourceTypeBadge}
                  <span class="badge badge-${doc.category}">${doc.category}</span>
                  ${statusBadge}
                  ${slackInfo}
                  ${qualityStars ? `<span title="Quality">${qualityStars}</span>` : ''}
                  ${urlHtml}
                </div>
                ${contentPreview ? `<div class="knowledge-excerpt">${contentPreview}</div>` : ''}
                ${addieNotes}
                ${tags ? `<div style="font-size: var(--text-xs); color: var(--color-text-muted); margin-top: var(--space-1);">Tags: ${tags}</div>` : ''}
              </div>
              ${actions ? `<div class="knowledge-actions" onclick="event.stopPropagation();">${actions}</div>` : ''}
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading knowledge:', error);
        document.getElementById('knowledge-list').innerHTML =
          '<div class="empty-state"><h3>Error loading knowledge</h3></div>';
      }
    }

    // Legacy alias for loadResources (no longer a separate function)
    function loadResources() {
      document.getElementById('source-type-filter').value = 'curated';
      loadKnowledge();
    }

    // Edit resource modal
    async function editResource(id) {
      try {
        const response = await fetch(`/api/admin/addie/resources/${id}`);
        const r = await response.json();

        document.getElementById('resource-edit-id').value = r.id;
        document.getElementById('resource-title').textContent = r.title;
        document.getElementById('resource-url').innerHTML = `<a href="${escapeHtml(r.source_url || r.fetch_url)}" target="_blank">${escapeHtml(r.source_url || r.fetch_url)}</a>`;
        document.getElementById('resource-summary').textContent = r.summary || 'Not yet fetched';

        // Display key insights
        const insightsEl = document.getElementById('resource-insights');
        if (r.key_insights && r.key_insights.length > 0) {
          insightsEl.innerHTML = r.key_insights.map(i =>
            `<div style="margin-bottom: var(--space-1);"><span class="badge badge-${i.importance === 'high' ? 'error' : i.importance === 'medium' ? 'warning' : 'info'}">${i.importance}</span> ${escapeHtml(i.insight)}</div>`
          ).join('');
        } else {
          insightsEl.textContent = 'No insights yet';
        }

        document.getElementById('resource-addie-notes').value = r.addie_notes || '';
        document.getElementById('resource-quality').value = r.quality_score || 3;
        document.getElementById('resource-tags').value = r.relevance_tags?.join(', ') || '';

        document.getElementById('resource-modal').style.display = 'flex';
      } catch (error) {
        console.error('Error loading resource:', error);
        alert('Error loading resource');
      }
    }

    function closeResourceModal() {
      document.getElementById('resource-modal').style.display = 'none';
    }

    async function saveResource() {
      const id = document.getElementById('resource-edit-id').value;
      const addie_notes = document.getElementById('resource-addie-notes').value;
      const quality_score = parseInt(document.getElementById('resource-quality').value, 10);
      const tagsInput = document.getElementById('resource-tags').value;
      const relevance_tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

      try {
        await fetch(`/api/admin/addie/resources/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ addie_notes, quality_score, relevance_tags })
        });
        closeResourceModal();
        loadKnowledge();
      } catch (error) {
        console.error('Error saving resource:', error);
        alert('Error saving resource');
      }
    }

    async function refetchResource() {
      const id = document.getElementById('resource-edit-id').value;
      if (!confirm('This will re-fetch the content and regenerate the summary. Continue?')) return;

      try {
        await fetch(`/api/admin/addie/resources/${id}/refetch`, { method: 'POST' });
        closeResourceModal();
        loadKnowledge();
        alert('Resource queued for refetch. Check back in a few minutes.');
      } catch (error) {
        console.error('Error refetching resource:', error);
        alert('Error queueing refetch');
      }
    }

    async function deleteResource(id) {
      if (!confirm('Are you sure you want to delete this resource?')) return;

      try {
        await fetch(`/api/admin/addie/resources/${id}`, { method: 'DELETE' });
        loadKnowledge();
      } catch (error) {
        console.error('Error deleting resource:', error);
        alert('Error deleting resource');
      }
    }

    // Retry/re-fetch a curated resource
    async function retryFetch(id) {
      try {
        const response = await fetch(`/api/admin/addie/resources/${id}/refetch`, { method: 'POST' });
        if (response.ok) {
          alert('Resource queued for fetch. It will be processed within 5 minutes.');
          loadKnowledge();
        } else {
          const data = await response.json();
          alert('Error: ' + (data.message || 'Failed to queue resource'));
        }
      } catch (error) {
        console.error('Error retrying fetch:', error);
        alert('Error queuing resource for fetch');
      }
    }

    // Load unified threads
    async function loadThreads() {
      const channel = document.getElementById('channel-filter').value;
      const flaggedOnly = document.getElementById('threads-flagged-only').checked;
      const unreviewedOnly = document.getElementById('threads-unreviewed-only').checked;
      const hasUserFeedback = document.getElementById('threads-has-feedback').checked;
      const timeframe = document.getElementById('stats-timeframe').value;

      const params = new URLSearchParams();
      params.append('limit', '50');
      if (channel) params.append('channel', channel);
      if (flaggedOnly) params.append('flagged_only', 'true');
      if (unreviewedOnly) params.append('unreviewed_only', 'true');
      if (hasUserFeedback) params.append('has_user_feedback', 'true');

      // Add timeframe filter to threads query
      if (timeframe !== 'all') {
        const now = new Date();
        let since;
        if (timeframe === '24h') {
          since = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        } else if (timeframe === '7d') {
          since = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        } else if (timeframe === '30d') {
          since = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        }
        if (since) {
          params.append('since', since.toISOString());
        }
      }

      try {
        const [threadsRes, statsRes] = await Promise.all([
          fetch(`/api/admin/addie/threads?${params.toString()}`),
          fetch(`/api/admin/addie/threads/stats?timeframe=${timeframe}`)
        ]);

        const data = await threadsRes.json();
        const stats = await statsRes.json();

        // Render channel stats
        const statsEl = document.getElementById('threads-stats');
        if (stats.by_channel) {
          // Format token counts for display
          const formatTokens = (n) => {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toString();
          };
          const totalTokens = (stats.total_input_tokens || 0) + (stats.total_output_tokens || 0);

          // Get thread count based on timeframe
          const getThreadCount = (ch) => {
            if (timeframe === '24h') return ch.threads_last_24h || 0;
            if (timeframe === '7d') return ch.threads_last_7d || 0;
            return ch.total_threads || 0;
          };

          // Get timeframe label
          const timeframeLabel = {
            '24h': '(24h)',
            '7d': '(7d)',
            '30d': '(30d)',
            'all': ''
          }[timeframe];

          statsEl.innerHTML = `
            <div class="conversation-stats">
              ${stats.by_channel.map(ch => `
                <div class="conversation-stat">
                  <div class="conversation-stat-value">${getThreadCount(ch)}</div>
                  <div class="conversation-stat-label">${ch.channel.charAt(0).toUpperCase() + ch.channel.slice(1)} Threads ${timeframeLabel}</div>
                </div>
              `).join('')}
              <div class="conversation-stat">
                <div class="conversation-stat-value">${stats.avg_latency_ms || 0}ms</div>
                <div class="conversation-stat-label">Avg Latency</div>
              </div>
              <div class="conversation-stat">
                <div class="conversation-stat-value">${formatTokens(totalTokens)}</div>
                <div class="conversation-stat-label">Total Tokens</div>
              </div>
              <div class="conversation-stat">
                <div class="conversation-stat-value">${formatTokens(stats.total_input_tokens || 0)} / ${formatTokens(stats.total_output_tokens || 0)}</div>
                <div class="conversation-stat-label">In / Out Tokens</div>
              </div>
            </div>
          `;
        }

        const list = document.getElementById('threads-list');
        if (!data.threads || data.threads.length === 0) {
          list.innerHTML = '<div class="empty-state"><h3>No threads found</h3><p>Threads will appear here once Addie starts chatting.</p></div>';
          return;
        }

        list.innerHTML = data.threads.map(thread => {
          // Build feedback indicator
          let feedbackIndicator = '';
          if (thread.user_feedback_count > 0) {
            // User gave feedback - show thumbs based on sentiment
            if (thread.negative_feedback_count > 0 && thread.positive_feedback_count === 0) {
              feedbackIndicator = `<span class="badge" style="background: var(--color-error-100); color: var(--color-error-700);"> User feedback</span>`;
            } else if (thread.positive_feedback_count > 0 && thread.negative_feedback_count === 0) {
              feedbackIndicator = `<span class="badge" style="background: var(--color-success-100); color: var(--color-success-700);"> User feedback</span>`;
            } else if (thread.positive_feedback_count > 0 && thread.negative_feedback_count > 0) {
              feedbackIndicator = `<span class="badge" style="background: var(--color-warning-100); color: var(--color-warning-700);"> Mixed feedback</span>`;
            } else {
              feedbackIndicator = `<span class="badge" style="background: var(--color-gray-100); color: var(--color-gray-700);"> User feedback</span>`;
            }
          }

          return `
          <div class="conversation-item ${thread.flagged ? 'flagged' : ''}" onclick="viewThread('${escapeHtml(thread.thread_id)}')">
            <div class="conversation-header">
              <div>
                <span class="badge badge-${thread.channel}">${thread.channel}</span>
                <strong style="margin-left: var(--space-2);">${escapeHtml(thread.user_display_name || thread.user_id || 'Anonymous')}</strong>
                <span style="color: var(--color-text-secondary); font-size: var(--text-sm);">
                   ${thread.message_count} message${thread.message_count === 1 ? '' : 's'}
                  ${thread.flagged ? ' <span class="badge badge-flagged">Flagged</span>' : ''}
                  ${!thread.reviewed ? ' <span class="badge badge-pending">Needs Review</span>' : ''}
                </span>
                ${feedbackIndicator ? `<span style="margin-left: var(--space-2);">${feedbackIndicator}</span>` : ''}
              </div>
              <span style="color: var(--color-text-muted); font-size: var(--text-sm);">
                ${new Date(thread.last_message_at).toLocaleString()}
              </span>
            </div>
            ${thread.first_user_message ? `<div class="conversation-preview">${escapeHtml(thread.first_user_message.substring(0, 150))}${thread.first_user_message.length > 150 ? '...' : ''}</div>` : ''}
          </div>
        `}).join('');
      } catch (error) {
        console.error('Error loading threads:', error);
        document.getElementById('threads-list').innerHTML =
          '<div class="empty-state"><h3>Error loading threads</h3></div>';
      }
    }

    // Load performance metrics
    async function loadPerformance() {
      try {
        const days = document.getElementById('perf-days-filter')?.value || '7';
        const response = await fetch(`/api/admin/addie/threads/performance?days=${days}`);
        const data = await response.json();

        // Update summary cards
        const s = data.summary;
        document.getElementById('perf-total-messages').textContent = s.total_assistant_messages || '0';
        document.getElementById('perf-p50-latency').textContent = s.p50_latency_ms ? `${(s.p50_latency_ms / 1000).toFixed(1)}s` : '-';
        document.getElementById('perf-p95-latency').textContent = s.p95_latency_ms ? `${(s.p95_latency_ms / 1000).toFixed(1)}s` : '-';
        const avgTokens = s.avg_input_tokens && s.avg_output_tokens ? s.avg_input_tokens + s.avg_output_tokens : null;
        document.getElementById('perf-avg-tokens').textContent = avgTokens ? avgTokens.toLocaleString() : '-';

        // Latency distribution chart (simple bar chart)
        const chartContainer = document.getElementById('latency-chart');
        const maxCount = Math.max(...data.latency_distribution.map(d => d.count), 1);
        chartContainer.innerHTML = data.latency_distribution.map(d => {
          const height = Math.max(5, (d.count / maxCount) * 100);
          return `
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
              <div style="width: 100%; max-width: 60px; background: var(--color-brand); border-radius: var(--radius-sm); height: ${height}%;"></div>
              <div style="font-size: var(--text-xs); margin-top: var(--space-1); color: var(--color-text-secondary);">${d.bucket}</div>
              <div style="font-size: var(--text-xs); color: var(--color-text-muted);">${d.count}</div>
            </div>
          `;
        }).join('');

        // By model table
        const modelBody = document.getElementById('perf-by-model');
        modelBody.innerHTML = data.by_model.map(m => `
          <tr style="border-bottom: var(--border-1) solid var(--color-gray-100);">
            <td style="padding: var(--space-2);"><code>${m.model}</code></td>
            <td style="text-align: right; padding: var(--space-2);">${m.count}</td>
            <td style="text-align: right; padding: var(--space-2);">${(m.avg_latency_ms / 1000).toFixed(1)}s</td>
            <td style="text-align: right; padding: var(--space-2);">${m.p50_latency_ms ? (m.p50_latency_ms / 1000).toFixed(1) + 's' : '-'}</td>
            <td style="text-align: right; padding: var(--space-2);">${m.total_input_tokens.toLocaleString()} / ${m.total_output_tokens.toLocaleString()}</td>
          </tr>
        `).join('') || '<tr><td colspan="5" style="text-align: center; padding: var(--space-4);">No data</td></tr>';

        // By tool table
        const toolBody = document.getElementById('perf-by-tool');
        toolBody.innerHTML = data.by_tool.map(t => `
          <tr style="border-bottom: var(--border-1) solid var(--color-gray-100);">
            <td style="padding: var(--space-2);"><code>${t.tool_name}</code></td>
            <td style="text-align: right; padding: var(--space-2);">${t.call_count}</td>
            <td style="text-align: right; padding: var(--space-2);">${t.avg_duration_ms ? (t.avg_duration_ms / 1000).toFixed(2) + 's' : '-'}</td>
            <td style="text-align: right; padding: var(--space-2);">${t.p50_duration_ms ? (t.p50_duration_ms / 1000).toFixed(2) + 's' : '-'}</td>
            <td style="text-align: right; padding: var(--space-2);">${t.p95_duration_ms ? (t.p95_duration_ms / 1000).toFixed(2) + 's' : '-'}</td>
            <td style="text-align: right; padding: var(--space-2);">${t.error_count > 0 ? `<span style="color: var(--color-error-500);">${t.error_count}</span>` : '0'}</td>
          </tr>
        `).join('') || '<tr><td colspan="6" style="text-align: center; padding: var(--space-4);">No tool data yet</td></tr>';

        // By channel table
        const channelBody = document.getElementById('perf-by-channel');
        channelBody.innerHTML = data.by_channel.map(c => `
          <tr style="border-bottom: var(--border-1) solid var(--color-gray-100);">
            <td style="padding: var(--space-2);"><span class="badge">${c.channel}</span></td>
            <td style="text-align: right; padding: var(--space-2);">${c.message_count}</td>
            <td style="text-align: right; padding: var(--space-2);">${c.avg_latency_ms ? (c.avg_latency_ms / 1000).toFixed(1) + 's' : '-'}</td>
          </tr>
        `).join('') || '<tr><td colspan="3" style="text-align: center; padding: var(--space-4);">No data</td></tr>';

      } catch (error) {
        console.error('Error loading performance:', error);
      }
    }

    // Load evaluation dashboard data
    async function loadEvaluationData() {
      try {
        const days = document.getElementById('eval-days-filter')?.value || '30';
        const response = await fetch(`/api/admin/addie/feedback/summary?days=${days}`);
        const data = await response.json();

        // Update summary stats
        const s = data.summary;
        document.getElementById('eval-total').textContent = s.total_responses || '0';
        document.getElementById('eval-rated').textContent = s.rated_responses || '0';
        document.getElementById('eval-avg-rating').textContent = s.avg_rating ? `${s.avg_rating}/5` : '-';
        document.getElementById('eval-positive').textContent = s.positive_count || '0';
        document.getElementById('eval-negative').textContent = s.negative_count || '0';
        document.getElementById('eval-flagged').textContent = s.flagged_count || '0';

        // Update feedback tags
        const tagsContainer = document.getElementById('eval-tags');
        if (data.tags && data.tags.length > 0) {
          tagsContainer.innerHTML = data.tags.map(t => `
            <div class="tag-stat">
              <span>${t.tag.replace('_', ' ')}</span>
              <span class="tag-stat-count">${t.count}</span>
            </div>
          `).join('');
        } else {
          tagsContainer.innerHTML = '<span style="color: var(--color-text-muted);">No feedback tags yet</span>';
        }

        // Update low-rated threads
        const lowRatedContainer = document.getElementById('eval-low-rated');
        if (data.low_rated && data.low_rated.length > 0) {
          lowRatedContainer.innerHTML = data.low_rated.map(lr => `
            <div class="low-rated-item" onclick="viewThread('${escapeHtml(lr.thread_id)}')">
              <div class="low-rated-header">
                <span class="badge badge-${lr.channel}">${lr.channel}</span>
                <span class="low-rated-rating">${lr.rating}/5</span>
              </div>
              <div class="low-rated-content">${escapeHtml(lr.content)}</div>
              ${lr.rating_notes ? `<div style="font-size: var(--text-xs); color: var(--color-text-muted); margin-top: var(--space-1);">"${escapeHtml(lr.rating_notes)}"</div>` : ''}
            </div>
          `).join('');
        } else {
          lowRatedContainer.innerHTML = '<span style="color: var(--color-text-muted);">No low-rated threads</span>';
        }
      } catch (error) {
        console.error('Error loading evaluation data:', error);
      }
    }

    // Load approval queue
    async function loadQueue() {
      try {
        const response = await fetch('/api/admin/addie/queue');
        const data = await response.json();

        const list = document.getElementById('queue-list');
        if (!data.items || data.items.length === 0) {
          list.innerHTML = '<div class="empty-state"><h3>No pending approvals</h3><p>Addie will queue proactive actions here for your review.</p></div>';
          return;
        }

        list.innerHTML = data.items.map(item => `
          <div class="queue-item">
            <div class="interaction-meta">
              <span class="badge badge-pending">${item.action_type}</span>
              <span>${item.trigger_type}</span>
              <span>${new Date(item.created_at).toLocaleString()}</span>
              ${item.expires_at ? `<span>Expires: ${new Date(item.expires_at).toLocaleString()}</span>` : ''}
            </div>
            <div class="queue-item-content">${escapeHtml(item.proposed_content)}</div>
            <div class="queue-item-actions">
              <button class="btn btn-small btn-primary" onclick="approveItem(${item.id})">Approve</button>
              <button class="btn btn-small btn-danger" onclick="rejectItem(${item.id})">Reject</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading queue:', error);
        document.getElementById('queue-list').innerHTML =
          '<div class="empty-state"><h3>Error loading queue</h3></div>';
      }
    }

    // Knowledge modal functions
    function openKnowledgeModal(doc = null) {
      document.getElementById('knowledge-modal-title').textContent = doc ? 'Edit Knowledge' : 'Add Knowledge';
      document.getElementById('knowledge-id').value = doc?.id || '';
      document.getElementById('knowledge-title').value = doc?.title || '';
      document.getElementById('knowledge-category').value = doc?.category || 'docs';
      document.getElementById('knowledge-source-url').value = doc?.source_url || '';
      document.getElementById('knowledge-content').value = doc?.content || '';
      document.getElementById('knowledge-modal').style.display = 'flex';
    }

    function closeKnowledgeModal() {
      document.getElementById('knowledge-modal').style.display = 'none';
      document.getElementById('knowledge-form').reset();
    }

    async function editKnowledge(id) {
      try {
        const response = await fetch(`/api/admin/addie/knowledge/${id}`);
        const doc = await response.json();
        openKnowledgeModal(doc);
      } catch (error) {
        console.error('Error loading knowledge:', error);
        alert('Error loading knowledge document');
      }
    }

    async function toggleKnowledgeActive(id, isActive) {
      try {
        await fetch(`/api/admin/addie/knowledge/${id}/active`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: isActive })
        });
        loadKnowledge();
        loadStats();
      } catch (error) {
        console.error('Error toggling knowledge:', error);
        alert('Error updating knowledge document');
      }
    }

    async function deleteKnowledge(id) {
      if (!confirm('Are you sure you want to delete this knowledge document?')) return;

      try {
        await fetch(`/api/admin/addie/knowledge/${id}`, { method: 'DELETE' });
        loadKnowledge();
        loadStats();
      } catch (error) {
        console.error('Error deleting knowledge:', error);
        alert('Error deleting knowledge document');
      }
    }

    // Form submission
    document.getElementById('knowledge-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('knowledge-id').value;
      const data = {
        title: document.getElementById('knowledge-title').value,
        category: document.getElementById('knowledge-category').value,
        source_url: document.getElementById('knowledge-source-url').value || null,
        content: document.getElementById('knowledge-content').value
      };

      try {
        const url = id ? `/api/admin/addie/knowledge/${id}` : '/api/admin/addie/knowledge';
        const method = id ? 'PUT' : 'POST';

        await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        closeKnowledgeModal();
        loadKnowledge();
        loadStats();
      } catch (error) {
        console.error('Error saving knowledge:', error);
        alert('Error saving knowledge document');
      }
    });

    // Mark thread as reviewed
    async function markThreadReviewed(threadId) {
      try {
        await fetch(`/api/admin/addie/threads/${threadId}/review`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes: '' })
        });
        loadThreads();
        loadStats();
      } catch (error) {
        console.error('Error marking reviewed:', error);
        alert('Error marking thread as reviewed');
      }
    }

    // Flag/unflag thread
    async function flagThread(threadId) {
      const reason = prompt('Reason for flagging (optional):');
      if (reason === null) return; // User cancelled
      try {
        await fetch(`/api/admin/addie/threads/${threadId}/flag`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });
        loadThreads();
        loadStats();
      } catch (error) {
        console.error('Error flagging thread:', error);
        alert('Error flagging thread');
      }
    }

    async function unflagThread(threadId) {
      try {
        await fetch(`/api/admin/addie/threads/${threadId}/unflag`, { method: 'PUT' });
        loadThreads();
        loadStats();
      } catch (error) {
        console.error('Error unflagging thread:', error);
        alert('Error unflagging thread');
      }
    }

    // Approve/reject queue items
    async function approveItem(id) {
      try {
        await fetch(`/api/admin/addie/queue/${id}/approve`, { method: 'PUT' });
        loadQueue();
        loadStats();
      } catch (error) {
        console.error('Error approving item:', error);
        alert('Error approving item');
      }
    }

    async function rejectItem(id) {
      const reason = prompt('Reason for rejection (optional):');
      try {
        await fetch(`/api/admin/addie/queue/${id}/reject`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });
        loadQueue();
        loadStats();
      } catch (error) {
        console.error('Error rejecting item:', error);
        alert('Error rejecting item');
      }
    }

    // Utility functions
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function copyThreadId(el) {
      const threadId = el.dataset.threadId;
      navigator.clipboard.writeText(threadId);
      const original = el.textContent;
      el.textContent = 'Copied!';
      setTimeout(() => el.textContent = original, 1500);
    }

    // Event listeners
    document.getElementById('source-type-filter').addEventListener('change', loadKnowledge);
    document.getElementById('category-filter').addEventListener('change', loadKnowledge);
    document.getElementById('fetch-status-filter').addEventListener('change', loadKnowledge);

    // Close modal on outside click
    document.getElementById('knowledge-modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeKnowledgeModal();
    });
    document.getElementById('resource-modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeResourceModal();
    });

    // =========================================================================
    // RULES FUNCTIONS
    // =========================================================================

    async function loadRules() {
      const activeOnly = document.getElementById('active-rules-only').checked;
      const url = activeOnly ? '/api/admin/addie/rules?active_only=true' : '/api/admin/addie/rules';

      try {
        const response = await fetch(url);
        const data = await response.json();

        const list = document.getElementById('rules-list');
        if (!data.rules || data.rules.length === 0) {
          list.innerHTML = '<div class="empty-state"><h3>No rules found</h3><p>Add rules to customize Addie\'s behavior.</p></div>';
          return;
        }

        list.innerHTML = data.rules.map(rule => `
          <div class="rule-item ${rule.is_active ? '' : 'inactive'}">
            <div class="rule-header">
              <div class="rule-info">
                <h3>${escapeHtml(rule.name)}</h3>
                <div class="rule-meta">
                  <span class="badge badge-${rule.rule_type}">${rule.rule_type.replace('_', ' ')}</span>
                  <span class="badge ${rule.is_active ? 'badge-active' : 'badge-inactive'}">${rule.is_active ? 'Active' : 'Inactive'}</span>
                  <span>Priority: ${rule.priority}</span>
                  <span>v${rule.version}</span>
                </div>
                ${rule.description ? `<div style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-top: var(--space-1);">${escapeHtml(rule.description)}</div>` : ''}
              </div>
              <div class="rule-actions">
                <button class="btn btn-small btn-secondary" onclick="editRule(${rule.id})">Edit</button>
                <button class="btn btn-small ${rule.is_active ? 'btn-secondary' : 'btn-primary'}" onclick="toggleRuleActive(${rule.id}, ${!rule.is_active})">
                  ${rule.is_active ? 'Deactivate' : 'Activate'}
                </button>
              </div>
            </div>
            <div class="rule-content-preview">${escapeHtml(rule.content)}</div>
            <div class="rule-stats">
              <span>Used ${rule.interactions_count} times</span>
              ${rule.avg_rating ? `<span>Avg rating: ${rule.avg_rating.toFixed(1)}/5</span>` : ''}
              <span>+${rule.positive_ratings || 0} / -${rule.negative_ratings || 0}</span>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading rules:', error);
        document.getElementById('rules-list').innerHTML =
          '<div class="empty-state"><h3>Error loading rules</h3></div>';
      }
    }

    function openRuleModal(rule = null) {
      document.getElementById('rule-modal-title').textContent = rule ? 'Edit Rule' : 'Add Rule';
      document.getElementById('rule-id').value = rule?.id || '';
      document.getElementById('rule-name').value = rule?.name || '';
      document.getElementById('rule-type').value = rule?.rule_type || 'behavior';
      document.getElementById('rule-description').value = rule?.description || '';
      document.getElementById('rule-priority').value = rule?.priority ?? 0;
      document.getElementById('rule-content').value = rule?.content || '';
      document.getElementById('rule-modal').style.display = 'flex';
    }

    function closeRuleModal() {
      document.getElementById('rule-modal').style.display = 'none';
      document.getElementById('rule-form').reset();
    }

    async function editRule(id) {
      try {
        const response = await fetch(`/api/admin/addie/rules/${id}`);
        const rule = await response.json();
        openRuleModal(rule);
      } catch (error) {
        console.error('Error loading rule:', error);
        alert('Error loading rule');
      }
    }

    async function toggleRuleActive(id, isActive) {
      try {
        await fetch(`/api/admin/addie/rules/${id}/active`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: isActive })
        });
        loadRules();
        loadStats();
      } catch (error) {
        console.error('Error toggling rule:', error);
        alert('Error updating rule');
      }
    }

    document.getElementById('rule-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('rule-id').value;
      const data = {
        rule_type: document.getElementById('rule-type').value,
        name: document.getElementById('rule-name').value,
        description: document.getElementById('rule-description').value || null,
        priority: parseInt(document.getElementById('rule-priority').value, 10),
        content: document.getElementById('rule-content').value
      };

      try {
        const url = id ? `/api/admin/addie/rules/${id}` : '/api/admin/addie/rules';
        const method = id ? 'PUT' : 'POST';

        await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        closeRuleModal();
        loadRules();
        loadStats();
      } catch (error) {
        console.error('Error saving rule:', error);
        alert('Error saving rule');
      }
    });

    async function viewSystemPrompt() {
      try {
        const response = await fetch('/api/admin/addie/rules/system-prompt');
        const data = await response.json();
        document.getElementById('system-prompt-content').textContent = data.system_prompt || '(No rules configured)';
        document.getElementById('system-prompt-modal').style.display = 'flex';
      } catch (error) {
        console.error('Error loading system prompt:', error);
        alert('Error loading system prompt');
      }
    }

    function closeSystemPromptModal() {
      document.getElementById('system-prompt-modal').style.display = 'none';
    }

    // =========================================================================
    // SUGGESTIONS FUNCTIONS
    // =========================================================================

    async function loadSuggestions() {
      try {
        const [suggestionsRes, statsRes] = await Promise.all([
          fetch('/api/admin/addie/suggestions'),
          fetch('/api/admin/addie/suggestions/stats')
        ]);

        const suggestions = await suggestionsRes.json();
        const stats = await statsRes.json();

        // Update stats
        document.getElementById('suggestions-stats').innerHTML = `
          <span><strong>${stats.pending}</strong> pending</span>
          <span><strong>${stats.approved}</strong> approved</span>
          <span><strong>${stats.applied}</strong> applied</span>
          <span><strong>${stats.rejected}</strong> rejected</span>
        `;

        const list = document.getElementById('suggestions-list');
        if (!suggestions.suggestions || suggestions.suggestions.length === 0) {
          list.innerHTML = '<div class="empty-state"><h3>No pending suggestions</h3><p>Run an analysis to generate suggestions for improving Addie\'s rules.</p></div>';
          return;
        }

        list.innerHTML = suggestions.suggestions.map(s => {
          const confidenceClass = s.confidence >= 0.7 ? '' : s.confidence >= 0.4 ? 'medium' : 'low';
          const typeLabels = {
            new_rule: 'New Rule',
            modify_rule: 'Modify Rule',
            disable_rule: 'Disable Rule',
            merge_rules: 'Merge Rules',
            experiment: 'Experiment',
            publish_content: 'Publish Content'
          };
          const contentTypeLabels = {
            docs: 'Protocol Docs',
            perspectives: 'Perspectives Article',
            external_link: 'External Link'
          };

          return `
            <div class="suggestion-item" onclick="viewSuggestion(${s.id})">
              <div class="suggestion-header">
                <div>
                  <span class="badge badge-${s.suggestion_type}">${typeLabels[s.suggestion_type] || s.suggestion_type}</span>
                  ${s.content_type ? `<span class="badge badge-${s.content_type}" style="margin-left: var(--space-1);">${contentTypeLabels[s.content_type] || s.content_type}</span>` : ''}
                  ${s.suggested_name || s.suggested_topic ? `<span class="suggestion-type" style="margin-left: var(--space-2);">${escapeHtml(s.suggested_name || s.suggested_topic)}</span>` : ''}
                </div>
                ${s.confidence ? `<span class="suggestion-confidence ${confidenceClass}">${Math.round(s.confidence * 100)}% confident</span>` : ''}
              </div>
              <div class="suggestion-reasoning">${escapeHtml(s.reasoning)}</div>
              <div class="suggestion-preview">${escapeHtml(s.suggested_content.substring(0, 200))}</div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading suggestions:', error);
        document.getElementById('suggestions-list').innerHTML =
          '<div class="empty-state"><h3>Error loading suggestions</h3></div>';
      }
    }

    async function viewSuggestion(id) {
      try {
        const response = await fetch(`/api/admin/addie/suggestions/${id}`);
        const s = await response.json();

        const typeLabels = {
          new_rule: 'New Rule',
          modify_rule: 'Modify Rule',
          disable_rule: 'Disable Rule',
          merge_rules: 'Merge Rules',
          experiment: 'Experiment',
          publish_content: 'Publish Content'
        };
        const contentTypeLabels = {
          docs: 'Protocol Docs',
          perspectives: 'Perspectives Article',
          external_link: 'External Link'
        };

        document.getElementById('suggestion-modal-title').textContent = typeLabels[s.suggestion_type] || s.suggestion_type;

        const isContentSuggestion = s.suggestion_type === 'publish_content';

        document.getElementById('suggestion-detail-content').innerHTML = `
          <div class="suggestion-detail-section">
            <h4>Suggestion Type</h4>
            <p><span class="badge badge-${s.suggestion_type}">${typeLabels[s.suggestion_type]}</span>
            ${s.content_type ? `<span class="badge badge-${s.content_type}" style="margin-left: var(--space-1);">${contentTypeLabels[s.content_type] || s.content_type}</span>` : ''}
            ${s.confidence ? `<span class="suggestion-confidence ${s.confidence >= 0.7 ? '' : s.confidence >= 0.4 ? 'medium' : 'low'}" style="margin-left: var(--space-2);">${Math.round(s.confidence * 100)}% confidence</span>` : ''}</p>
          </div>

          ${s.suggested_topic ? `
          <div class="suggestion-detail-section">
            <h4>Suggested Topic</h4>
            <p>${escapeHtml(s.suggested_topic)}</p>
          </div>
          ` : ''}

          ${s.suggested_name && !s.suggested_topic ? `
          <div class="suggestion-detail-section">
            <h4>Suggested Name</h4>
            <p>${escapeHtml(s.suggested_name)}</p>
          </div>
          ` : ''}

          ${s.suggested_rule_type ? `
          <div class="suggestion-detail-section">
            <h4>Rule Type</h4>
            <p><span class="badge badge-${s.suggested_rule_type}">${s.suggested_rule_type.replace('_', ' ')}</span></p>
          </div>
          ` : ''}

          <div class="suggestion-detail-section">
            <h4>Reasoning</h4>
            <div class="suggestion-detail-content">${escapeHtml(s.reasoning)}</div>
          </div>

          <div class="suggestion-detail-section">
            <h4>${isContentSuggestion ? 'Content Description' : 'Suggested Content'}</h4>
            <div class="suggestion-detail-content">${escapeHtml(s.suggested_content)}</div>
          </div>

          ${s.external_sources && s.external_sources.length > 0 ? `
          <div class="suggestion-detail-section">
            <h4>External Sources to Reference</h4>
            <div class="suggestion-detail-content">
              <ul style="margin: 0; padding-left: var(--space-4);">
                ${s.external_sources.map(url => `<li><a href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(url)}</a></li>`).join('')}
              </ul>
            </div>
          </div>
          ` : ''}

          ${s.expected_impact ? `
          <div class="suggestion-detail-section">
            <h4>Expected Impact</h4>
            <div class="suggestion-detail-content">${escapeHtml(s.expected_impact)}</div>
          </div>
          ` : ''}

          ${s.pattern_summary ? `
          <div class="suggestion-detail-section">
            <h4>Pattern Identified</h4>
            <div class="suggestion-detail-content">${escapeHtml(s.pattern_summary)}</div>
          </div>
          ` : ''}
        `;

        // Different buttons for content suggestions vs rule suggestions
        if (isContentSuggestion) {
          document.getElementById('suggestion-modal-buttons').innerHTML = `
            <button type="button" class="btn btn-secondary" onclick="closeSuggestionModal()">Close</button>
            <button type="button" class="btn btn-danger" onclick="rejectSuggestion(${s.id})">Dismiss</button>
            <button type="button" class="btn btn-primary" onclick="acknowledgeContentSuggestion(${s.id})">Acknowledge</button>
          `;
        } else {
          document.getElementById('suggestion-modal-buttons').innerHTML = `
            <button type="button" class="btn btn-secondary" onclick="closeSuggestionModal()">Close</button>
            <button type="button" class="btn btn-danger" onclick="rejectSuggestion(${s.id})">Reject</button>
            <button type="button" class="btn btn-primary" onclick="approveSuggestion(${s.id})">Approve</button>
          `;
        }

        document.getElementById('suggestion-modal').style.display = 'flex';
      } catch (error) {
        console.error('Error loading suggestion:', error);
        alert('Error loading suggestion details');
      }
    }

    async function acknowledgeContentSuggestion(id) {
      const notes = prompt('Notes (e.g., "Will create article" or "Added to docs backlog"):');
      try {
        await fetch(`/api/admin/addie/suggestions/${id}/approve`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes: notes || 'Acknowledged - content to be created' })
        });
        alert('Content suggestion acknowledged. Remember to publish the content!');
        closeSuggestionModal();
        loadSuggestions();
      } catch (error) {
        console.error('Error acknowledging suggestion:', error);
        alert('Error acknowledging suggestion');
      }
    }

    function closeSuggestionModal() {
      document.getElementById('suggestion-modal').style.display = 'none';
    }

    async function approveSuggestion(id) {
      const notes = prompt('Approval notes (optional):');
      try {
        await fetch(`/api/admin/addie/suggestions/${id}/approve`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes })
        });

        // Ask if they want to apply immediately
        if (confirm('Suggestion approved. Apply it now to create/update the rule?')) {
          await fetch(`/api/admin/addie/suggestions/${id}/apply`, { method: 'PUT' });
          alert('Suggestion applied! The rule has been updated.');
          loadRules();
        }

        closeSuggestionModal();
        loadSuggestions();
      } catch (error) {
        console.error('Error approving suggestion:', error);
        alert('Error approving suggestion');
      }
    }

    async function rejectSuggestion(id) {
      const notes = prompt('Rejection reason (optional):');
      try {
        await fetch(`/api/admin/addie/suggestions/${id}/reject`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes })
        });
        closeSuggestionModal();
        loadSuggestions();
      } catch (error) {
        console.error('Error rejecting suggestion:', error);
        alert('Error rejecting suggestion');
      }
    }

    async function runAnalysis() {
      const btn = document.getElementById('run-analysis-btn');
      btn.disabled = true;
      btn.textContent = 'Running Analysis...';

      try {
        const response = await fetch('/api/admin/addie/analysis/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            days: 7,
            max_interactions: 100
          })
        });

        const result = await response.json();

        if (result.success) {
          alert(`Analysis complete!\n\n${result.suggestions_generated} suggestions generated.\n\n${result.summary}`);
          loadSuggestions();
        } else {
          alert('Analysis failed: ' + (result.message || result.error));
        }
      } catch (error) {
        console.error('Error running analysis:', error);
        alert('Error running analysis');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Run Analysis';
      }
    }

    // Event listeners for rules and suggestions
    document.getElementById('active-rules-only').addEventListener('change', loadRules);
    document.getElementById('rule-type-filter').addEventListener('change', loadRules);

    // Close modals on outside click
    document.getElementById('rule-modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeRuleModal();
    });
    document.getElementById('system-prompt-modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeSystemPromptModal();
    });
    document.getElementById('suggestion-modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeSuggestionModal();
    });
    document.getElementById('conversation-modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeConversationModal();
    });

    // =========================================================================
    // THREAD FUNCTIONS (unified view for all channels)
    // =========================================================================

    // Current thread data for actions
    let currentThreadData = null;
    let currentConversationData = null;
    let extractedLinks = [];

    async function viewThread(threadId) {
      try {
        const response = await fetch(`/api/admin/addie/threads/${threadId}`);
        const data = await response.json();
        currentThreadData = data;
        currentConversationData = data;

        const channelLabel = data.channel.charAt(0).toUpperCase() + data.channel.slice(1);
        document.getElementById('conversation-modal-title').textContent =
          `${channelLabel} Thread with ${data.user_display_name || data.user_id || 'Anonymous'}`;

        const detailEl = document.getElementById('conversation-detail');

        // Thread info header
        const threadInfo = `
          <div class="thread-info" style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-bg-subtle); border-radius: var(--radius-md);">
            <div style="display: flex; gap: var(--space-3); flex-wrap: wrap; align-items: center;">
              <span class="badge badge-${data.channel}">${data.channel}</span>
              ${data.flagged ? `<span class="badge badge-flagged">Flagged: ${escapeHtml(data.flag_reason || 'No reason')}</span>` : ''}
              ${data.reviewed ? `<span class="badge badge-active">Reviewed by ${escapeHtml(data.reviewed_by || 'admin')}</span>` : '<span class="badge badge-pending">Needs Review</span>'}
              <span style="color: var(--color-text-muted); font-size: var(--text-sm);">
                ${data.message_count} messages  Started ${new Date(data.started_at).toLocaleString()}
              </span>
            </div>
            <div style="margin-top: var(--space-2); display: flex; gap: var(--space-2); align-items: center;">
              <code style="font-size: var(--text-xs); color: var(--color-text-muted); background: var(--color-bg-muted); padding: 2px 6px; border-radius: var(--radius-sm); cursor: pointer;" data-thread-id="${escapeHtml(data.thread_id)}" onclick="copyThreadId(this)" title="Click to copy thread ID">${escapeHtml(data.thread_id)}</code>
              ${!data.reviewed ? `<button class="btn btn-small btn-primary" onclick="markThreadReviewed('${data.thread_id}')">Mark Reviewed</button>` : ''}
              ${!data.flagged ? `<button class="btn btn-small btn-secondary" onclick="flagThread('${data.thread_id}')">Flag</button>` : `<button class="btn btn-small btn-secondary" onclick="unflagThread('${data.thread_id}')">Unflag</button>`}
            </div>
          </div>
        `;

        detailEl.innerHTML = threadInfo + `
          <div class="message-thread">
            ${data.messages.map(msg => renderThreadMessage(msg)).join('')}
          </div>
        `;

        // Extract links from thread
        extractedLinks = extractLinksFromThread(data);

        // Show feedback panel and reset state
        document.getElementById('thread-feedback-panel').style.display = 'block';
        clearThreadFeedback();

        // Load existing feedback from last assistant message if present
        const lastAssistantMsg = [...data.messages].reverse().find(m => m.role === 'assistant');
        if (lastAssistantMsg && lastAssistantMsg.rating) {
          loadExistingFeedback(lastAssistantMsg);
        }

        // Show actions panel
        const actionsEl = document.getElementById('conversation-actions');
        actionsEl.style.display = 'block';

        // Show extracted links if any
        const linksEl = document.getElementById('extracted-links');
        if (extractedLinks.length > 0) {
          linksEl.style.display = 'block';
          document.getElementById('links-list').innerHTML = extractedLinks.map(link => `
            <div class="link-item">
              <span class="link-source">${link.source}</span>
              <a href="${escapeHtml(link.url)}" target="_blank" rel="noopener">${escapeHtml(link.url)}</a>
            </div>
          `).join('');

          // Populate URL dropdown for perspectives form
          const urlSelect = document.getElementById('perspectives-url');
          urlSelect.innerHTML = '<option value="">Select or enter URL...</option>' +
            extractedLinks.map(link => `<option value="${escapeHtml(link.url)}">${escapeHtml(link.url)}</option>`).join('');
        } else {
          linksEl.style.display = 'none';
        }

        // Hide any open forms
        hideActionForms();

        document.getElementById('conversation-modal').style.display = 'flex';
      } catch (error) {
        console.error('Error loading thread:', error);
        alert('Error loading thread');
      }
    }

    function renderThreadMessage(msg) {
      const roleLabel = msg.role === 'user' ? 'User' : msg.role === 'assistant' ? 'Addie' : msg.role;
      const hasToolCalls = msg.tool_calls && msg.tool_calls.length > 0;
      const hasToolsUsed = msg.tools_used && msg.tools_used.length > 0;
      const latencyDisplay = msg.latency_ms ? `<span class="message-latency">${msg.latency_ms}ms</span>` : '';
      // Token display for assistant messages
      const tokensDisplay = (msg.role === 'assistant' && (msg.tokens_input || msg.tokens_output))
        ? `<span class="message-latency" title="Input / Output tokens">${msg.tokens_input || 0} / ${msg.tokens_output || 0} tok</span>`
        : '';

      // Router decision for user messages (from Haiku router)
      const routerDecision = (msg.role === 'user' && msg.router_decision) ? `
        <div class="router-decision">
          <button class="diagnostics-toggle" onclick="toggleRouterDecision('${msg.message_id}')">
            Router Decision: <span class="router-action router-action-${msg.router_decision.action}">${msg.router_decision.action}</span>
            ${msg.router_decision.tools && msg.router_decision.tools.length > 0 ? `<span class="router-tools">[${msg.router_decision.tools.join(', ')}]</span>` : ''}
          </button>
          <div class="router-decision-content" id="router-${msg.message_id}" style="display: none;">
            <div class="diagnostics-section">
              <strong>Decision Details</strong>
              <div class="timing-bars">
                <div class="timing-row"><span>Action:</span> <span class="router-action router-action-${msg.router_decision.action}">${msg.router_decision.action}</span></div>
                ${msg.router_decision.tools && msg.router_decision.tools.length > 0 ? `<div class="timing-row"><span>Tools:</span> <span>${msg.router_decision.tools.join(', ')}</span></div>` : ''}
                <div class="timing-row"><span>Method:</span> <span>${msg.router_decision.decision_method || 'llm'}</span></div>
                ${msg.router_decision.latency_ms ? `<div class="timing-row"><span>Latency:</span> <span>${msg.router_decision.latency_ms}ms</span></div>` : ''}
                ${msg.router_decision.model ? `<div class="timing-row"><span>Model:</span> <span>${msg.router_decision.model}</span></div>` : ''}
                ${msg.router_decision.tokens_input ? `<div class="timing-row"><span>Tokens:</span> <span>${msg.router_decision.tokens_input} in / ${msg.router_decision.tokens_output || 0} out</span></div>` : ''}
              </div>
            </div>
            ${msg.router_decision.reason ? `
              <div class="diagnostics-section">
                <strong>Reason</strong>
                <div class="router-reason">${escapeHtml(msg.router_decision.reason)}</div>
              </div>
            ` : ''}
          </div>
        </div>
      ` : '';

      // Execution diagnostics for assistant messages
      const hasTiming = msg.timing_system_prompt_ms || msg.timing_total_llm_ms || msg.timing_total_tool_ms;
      const executionDiagnostics = (msg.role === 'assistant' && (hasTiming || msg.processing_iterations || msg.active_rule_ids)) ? `
        <div class="execution-diagnostics">
          <button class="diagnostics-toggle" onclick="toggleDiagnostics('${msg.message_id}')">
            Execution Details
          </button>
          <div class="diagnostics-content" id="diagnostics-${msg.message_id}" style="display: none;">
            ${hasTiming ? `
              <div class="diagnostics-section">
                <strong>Timing Breakdown</strong>
                <div class="timing-bars">
                  ${msg.timing_system_prompt_ms ? `<div class="timing-row"><span>System prompt:</span> <span>${msg.timing_system_prompt_ms}ms</span></div>` : ''}
                  ${msg.timing_total_llm_ms ? `<div class="timing-row"><span>LLM processing:</span> <span>${msg.timing_total_llm_ms}ms</span></div>` : ''}
                  ${msg.timing_total_tool_ms ? `<div class="timing-row"><span>Tool execution:</span> <span>${msg.timing_total_tool_ms}ms</span></div>` : ''}
                  ${msg.processing_iterations ? `<div class="timing-row"><span>Iterations:</span> <span>${msg.processing_iterations}</span></div>` : ''}
                </div>
              </div>
            ` : ''}
            ${(msg.tokens_cache_creation || msg.tokens_cache_read) ? `
              <div class="diagnostics-section">
                <strong>Cache Performance</strong>
                <div class="timing-bars">
                  ${msg.tokens_cache_creation ? `<div class="timing-row"><span>Cache created:</span> <span>${msg.tokens_cache_creation} tokens</span></div>` : ''}
                  ${msg.tokens_cache_read ? `<div class="timing-row"><span>Cache read:</span> <span>${msg.tokens_cache_read} tokens</span></div>` : ''}
                </div>
              </div>
            ` : ''}
            ${msg.active_rule_ids && msg.active_rule_ids.length > 0 ? `
              <div class="diagnostics-section">
                <strong>Active Rules</strong>
                <div class="rule-ids">${msg.active_rule_ids.map(id => `<span class="rule-id-badge">#${id}</span>`).join(' ')}</div>
              </div>
            ` : ''}
          </div>
        </div>
      ` : '';

      // Show existing feedback if any
      const existingFeedback = msg.rating ? `
        <div class="existing-feedback">
          <span class="thumbs">${msg.rating >= 3 ? '' : ''}</span>
          <span class="rating-source">(${escapeHtml(msg.rating_source || 'unknown')})</span>
          ${msg.rating_notes ? `<span title="${escapeHtml(msg.rating_notes)}">"${escapeHtml(msg.rating_notes.substring(0, 30))}${msg.rating_notes.length > 30 ? '...' : ''}"</span>` : ''}
          ${msg.feedback_tags && msg.feedback_tags.length > 0 ? `<span>[${msg.feedback_tags.join(', ')}]</span>` : ''}
        </div>
      ` : '';

      // Only show rating controls for assistant messages
      const feedbackControls = msg.role === 'assistant' ? `
        <div class="message-feedback" data-message-id="${msg.message_id}">
          <div class="thumbs-rating" data-message-id="${msg.message_id}">
            <button class="rating-btn thumbs-up ${msg.rating >= 3 ? 'selected' : ''}" onclick="setMessageRating('${msg.message_id}', 5)" title="Good response"></button>
            <button class="rating-btn thumbs-down ${msg.rating && msg.rating < 3 ? 'selected' : ''}" onclick="setMessageRating('${msg.message_id}', 1)" title="Bad response"></button>
          </div>
          <button class="feedback-expand-btn" onclick="toggleMessageFeedback('${msg.message_id}')">
            ${msg.rating_notes || (msg.feedback_tags && msg.feedback_tags.length > 0) ? 'Edit notes' : 'Add notes'}
          </button>
          <div class="feedback-detail" id="feedback-detail-${msg.message_id}">
            <div class="feedback-tags">
              ${['accurate', 'helpful', 'well_cited', 'inaccurate', 'missing_info', 'wrong_source', 'too_verbose', 'too_brief'].map(tag =>
                `<span class="feedback-tag ${msg.feedback_tags && msg.feedback_tags.includes(tag) ? 'selected' : ''}"
                      data-tag="${tag}"
                      onclick="toggleMessageTag('${msg.message_id}', this)">${tag.replace('_', ' ')}</span>`
              ).join('')}
            </div>
            <textarea class="feedback-notes"
                      id="feedback-notes-${msg.message_id}"
                      placeholder="What's good or bad about this response?">${msg.rating_notes || ''}</textarea>
            <div class="feedback-actions">
              <button class="btn btn-small btn-primary" onclick="saveMessageFeedback('${msg.message_id}')">Save</button>
            </div>
          </div>
        </div>
      ` : '';

      return `
        <div class="message-item ${msg.role}">
          <div class="message-role">${roleLabel}${latencyDisplay}${tokensDisplay}${existingFeedback}</div>
          <div class="message-content">${renderMarkdown(msg.content)}</div>
          ${routerDecision}
          ${hasToolsUsed ? `<div class="tools-used" style="font-size: var(--text-xs); color: var(--color-text-muted); margin-top: var(--space-1);">Tools: ${msg.tools_used.join(', ')}</div>` : ''}
          ${hasToolCalls ? renderToolCalls(msg.tool_calls, msg.latency_ms) : ''}
          ${executionDiagnostics}
          ${msg.flagged ? `<div style="color: var(--color-warning-600); font-size: var(--text-sm); margin-top: var(--space-2);"><strong>Flagged:</strong> ${escapeHtml(msg.flag_reason || 'No reason')}</div>` : ''}
          ${feedbackControls}
        </div>
      `;
    }

    function toggleRouterDecision(messageId) {
      const el = document.getElementById(`router-${messageId}`);
      if (el) {
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
      }
    }

    function toggleDiagnostics(messageId) {
      const el = document.getElementById(`diagnostics-${messageId}`);
      if (el) {
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
      }
    }

    function renderToolCalls(toolCalls, totalLatency) {
      if (!toolCalls || toolCalls.length === 0) return '';

      const callsHtml = toolCalls.map((call, i) => {
        const params = typeof call.input === 'string' ? call.input : JSON.stringify(call.input, null, 2);
        const resultClass = call.is_error ? 'tool-error' : 'tool-result';
        const resultSummary = call.result_summary || (call.result?.substring ? call.result.substring(0, 100) + '...' : JSON.stringify(call.result).substring(0, 100));

        return `
          <div class="tool-execution">
            <div>
              <span class="tool-name">${i + 1}. ${call.name || call.tool_name}</span>
              ${call.duration_ms ? `<span class="tool-duration">(${call.duration_ms}ms)</span>` : ''}
            </div>
            <div class="tool-params"> ${escapeHtml(params)}</div>
            <div class="${resultClass}"> ${escapeHtml(resultSummary)}</div>
          </div>
        `;
      }).join('');

      return `
        <div class="execution-plan">
          <div class="execution-plan-header">Tool Calls</div>
          ${callsHtml}
        </div>
      `;
    }

    function extractLinksFromThread(data) {
      const links = [];
      const urlRegex = /https?:\/\/[^\s<>"{}|\\^`\[\]]+/g;
      const seen = new Set();

      // Extract from message content
      for (const msg of data.messages) {
        if (!msg.content) continue;
        const matches = msg.content.match(urlRegex) || [];
        for (const url of matches) {
          // Clean up URL (remove trailing punctuation)
          const cleanUrl = url.replace(/[.,;:!?)]+$/, '');
          if (!seen.has(cleanUrl)) {
            seen.add(cleanUrl);
            links.push({
              url: cleanUrl,
              source: msg.role === 'assistant' ? 'Addie response' : 'User message'
            });
          }
        }

        // Extract from tool calls (unified model)
        const toolCalls = msg.tool_calls || msg.tool_results || [];
        for (const call of toolCalls) {
          const result = call.result || '';
          if (typeof result === 'string') {
            const resultMatches = result.match(urlRegex) || [];
            for (const url of resultMatches) {
              const cleanUrl = url.replace(/[.,;:!?)]+$/, '');
              if (!seen.has(cleanUrl)) {
                seen.add(cleanUrl);
                const toolName = call.name || call.tool_name || 'tool';
                links.push({
                  url: cleanUrl,
                  source: toolName === 'search_docs' ? 'Docs' :
                          toolName === 'search_slack' ? 'Slack' :
                          toolName === 'web_search' ? 'Web search' : toolName
                });
              }
            }
          }
        }
      }

      // Filter out internal docs URLs (keep external sources)
      return links.filter(link => {
        // Keep external sources, filter out protocol docs
        return !link.url.includes('docs.adcontextprotocol.org') &&
               !link.url.includes('localhost');
      });
    }

    function renderMessage(msg) {
      const roleLabel = msg.role === 'user' ? 'User' : 'Addie';
      const hasExecutionPlan = msg.tool_results && msg.tool_results.length > 0;
      const latencyDisplay = msg.latency_ms ? `<span class="message-latency">${msg.latency_ms}ms</span>` : '';

      return `
        <div class="message-item ${msg.role}">
          <div class="message-role">${roleLabel}${latencyDisplay}</div>
          <div class="message-content">${renderMarkdown(msg.content)}</div>
          ${hasExecutionPlan ? renderExecutionPlan(msg.tool_results, msg.latency_ms) : ''}
        </div>
      `;
    }

    function renderMarkdown(text) {
      // Escape HTML first
      text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

      // Code blocks
      text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');

      // Inline code
      text = text.replace(/`([^`]+)`/g, '<code>$1</code>');

      // Bold
      text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

      // Italic
      text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');

      // Links - make them clickable
      text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');

      // Bare URLs (not already in markdown links)
      text = text.replace(/(?<!href="|>)(https?:\/\/[^\s<>"]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');

      // Line breaks to paragraphs
      const paragraphs = text.split(/\n\n+/);
      text = paragraphs.map(p => {
        // Check if it's a bullet list
        if (p.match(/^[-*]\s/m)) {
          const items = p.split(/\n/).filter(l => l.trim());
          return '<ul>' + items.map(i => '<li>' + i.replace(/^[-*]\s/, '') + '</li>').join('') + '</ul>';
        }
        // Check if it's a numbered list
        if (p.match(/^\d+\.\s/m)) {
          const items = p.split(/\n/).filter(l => l.trim());
          return '<ol>' + items.map(i => '<li>' + i.replace(/^\d+\.\s/, '') + '</li>').join('') + '</ol>';
        }
        // Regular paragraph
        return '<p>' + p.replace(/\n/g, '<br>') + '</p>';
      }).join('');

      return text;
    }

    function renderExecutionPlan(toolExecutions, totalLatency) {
      if (!toolExecutions || toolExecutions.length === 0) return '';

      const executionsHtml = toolExecutions.map((exec, i) => {
        const params = JSON.stringify(exec.parameters, null, 2);
        const resultClass = exec.is_error ? 'tool-error' : 'tool-result';
        const resultSummary = exec.result_summary || (exec.result?.substring(0, 100) + '...');

        return `
          <div class="tool-execution">
            <div>
              <span class="tool-name">${i + 1}. ${exec.tool_name}</span>
              <span class="tool-duration">(${exec.duration_ms}ms)</span>
            </div>
            <div class="tool-params"> ${escapeHtml(params)}</div>
            <div class="${resultClass}"> ${escapeHtml(resultSummary)}</div>
          </div>
        `;
      }).join('');

      return `
        <div class="execution-plan">
          <div class="execution-plan-title">Execution Plan (${toolExecutions.length} tool call${toolExecutions.length === 1 ? '' : 's'})</div>
          ${executionsHtml}
        </div>
      `;
    }

    function closeConversationModal() {
      document.getElementById('conversation-modal').style.display = 'none';
      document.getElementById('conversation-actions').style.display = 'none';
      document.getElementById('thread-feedback-panel').style.display = 'none';
      hideActionForms();
      currentConversationData = null;
      extractedLinks = [];
    }

    // =========================================================================
    // CONVERSATION ACTION HANDLERS
    // =========================================================================

    function hideActionForms() {
      document.getElementById('perspectives-form').style.display = 'none';
      document.getElementById('docs-issue-form').style.display = 'none';
      document.getElementById('rule-suggestion-form').style.display = 'none';
    }

    function showPerspectivesForm() {
      hideActionForms();
      document.getElementById('perspectives-form').style.display = 'block';
      // Pre-fill with first extracted link if available
      if (extractedLinks.length > 0) {
        document.getElementById('perspectives-url').value = extractedLinks[0].url;
      }
    }

    function showDocsIssueForm() {
      hideActionForms();
      document.getElementById('docs-issue-form').style.display = 'block';
      // Pre-fill description with user's question if available
      if (currentConversationData && currentConversationData.messages.length > 0) {
        const userMsg = currentConversationData.messages.find(m => m.role === 'user');
        if (userMsg) {
          document.getElementById('docs-issue-description').value =
            `User asked: "${userMsg.content.substring(0, 200)}${userMsg.content.length > 200 ? '...' : ''}"\\n\\nThis topic could use better documentation.`;
        }
      }
    }

    function showRuleSuggestionForm() {
      hideActionForms();
      document.getElementById('rule-suggestion-form').style.display = 'block';
    }

    // =========================================================================
    // MESSAGE FEEDBACK HANDLERS
    // =========================================================================

    // Track pending feedback changes per message
    const pendingMessageFeedback = {};

    function setMessageRating(messageId, rating) {
      // Update UI - toggle thumbs buttons
      const thumbsContainer = document.querySelector(`.thumbs-rating[data-message-id="${messageId}"]`);
      if (thumbsContainer) {
        const thumbsUp = thumbsContainer.querySelector('.thumbs-up');
        const thumbsDown = thumbsContainer.querySelector('.thumbs-down');
        if (thumbsUp) thumbsUp.classList.toggle('selected', rating >= 4);
        if (thumbsDown) thumbsDown.classList.toggle('selected', rating <= 2);
      }

      // Track pending feedback
      if (!pendingMessageFeedback[messageId]) {
        pendingMessageFeedback[messageId] = {};
      }
      pendingMessageFeedback[messageId].rating = rating;

      // Auto-save rating immediately
      saveMessageFeedback(messageId);
    }

    function toggleMessageFeedback(messageId) {
      const detail = document.getElementById(`feedback-detail-${messageId}`);
      if (detail) {
        detail.classList.toggle('expanded');
      }
    }

    function toggleMessageTag(messageId, element) {
      element.classList.toggle('selected');

      // Track pending feedback
      if (!pendingMessageFeedback[messageId]) {
        pendingMessageFeedback[messageId] = {};
      }
      const feedbackDetail = document.getElementById(`feedback-detail-${messageId}`);
      const selectedTags = Array.from(feedbackDetail.querySelectorAll('.feedback-tag.selected')).map(el => el.dataset.tag);
      pendingMessageFeedback[messageId].feedback_tags = selectedTags;
    }

    async function saveMessageFeedback(messageId) {
      const feedback = pendingMessageFeedback[messageId] || {};

      // Get rating from UI if not already set
      if (!feedback.rating) {
        const thumbsContainer = document.querySelector(`.thumbs-rating[data-message-id="${messageId}"]`);
        if (thumbsContainer) {
          const thumbsUp = thumbsContainer.querySelector('.thumbs-up.selected');
          const thumbsDown = thumbsContainer.querySelector('.thumbs-down.selected');
          if (thumbsUp) feedback.rating = 5;
          else if (thumbsDown) feedback.rating = 1;
        }
      }

      // Get notes from textarea
      const notesEl = document.getElementById(`feedback-notes-${messageId}`);
      if (notesEl) {
        feedback.rating_notes = notesEl.value;
      }

      // Get selected tags
      const feedbackDetail = document.getElementById(`feedback-detail-${messageId}`);
      if (feedbackDetail) {
        const selectedTags = Array.from(feedbackDetail.querySelectorAll('.feedback-tag.selected')).map(el => el.dataset.tag);
        if (selectedTags.length > 0) {
          feedback.feedback_tags = selectedTags;
        }
      }

      // Need at least a rating
      if (!feedback.rating) {
        alert('Please select thumbs up or thumbs down');
        return;
      }

      try {
        const response = await fetch(`/api/admin/addie/threads/messages/${messageId}/feedback`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(feedback)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Failed to save feedback (${response.status})`);
        }

        // Update the message in currentThreadData to reflect the change
        if (currentThreadData && currentThreadData.messages) {
          const msg = currentThreadData.messages.find(m => m.message_id === messageId);
          if (msg) {
            msg.rating = feedback.rating;
            msg.rating_notes = feedback.rating_notes;
            msg.feedback_tags = feedback.feedback_tags;
            msg.rating_source = 'admin';
          }
        }

        // Clear pending feedback for this message
        delete pendingMessageFeedback[messageId];

        // Re-render the message to show updated feedback state
        if (currentThreadData && currentThreadData.messages) {
          const msg = currentThreadData.messages.find(m => m.message_id === messageId);
          if (msg) {
            // Find the message element and replace it with re-rendered version
            const assistantMessages = document.querySelectorAll('.message-item.assistant');
            for (const el of assistantMessages) {
              const feedbackEl = el.querySelector(`.message-feedback[data-message-id="${messageId}"]`);
              if (feedbackEl) {
                // Re-render this message
                const newHtml = renderThreadMessage(msg);
                el.outerHTML = newHtml;
                break;
              }
            }
          }
        }
      } catch (error) {
        console.error('Error saving message feedback:', error);
        alert('Error saving feedback');
      }
    }

    // =========================================================================
    // THREAD-LEVEL FEEDBACK HANDLERS
    // =========================================================================

    let threadFeedbackState = {
      sentiment: null,
      tags: [],
      notes: ''
    };

    function setThreadRating(sentiment) {
      threadFeedbackState.sentiment = sentiment;

      // Update UI
      document.getElementById('thread-thumbs-up').classList.toggle('selected', sentiment === 'positive');
      document.getElementById('thread-thumbs-down').classList.toggle('selected', sentiment === 'negative');
    }

    function toggleThreadTag(element) {
      element.classList.toggle('selected');

      // Update state
      const tag = element.dataset.tag;
      if (element.classList.contains('selected')) {
        if (!threadFeedbackState.tags.includes(tag)) {
          threadFeedbackState.tags.push(tag);
        }
      } else {
        threadFeedbackState.tags = threadFeedbackState.tags.filter(t => t !== tag);
      }
    }

    function clearThreadFeedback() {
      threadFeedbackState = { sentiment: null, tags: [], notes: '' };

      // Reset UI
      document.getElementById('thread-thumbs-up').classList.remove('selected');
      document.getElementById('thread-thumbs-down').classList.remove('selected');
      document.querySelectorAll('#thread-feedback-tags .feedback-tag').forEach(tag => tag.classList.remove('selected'));
      document.getElementById('thread-feedback-notes').value = '';
    }

    function loadExistingFeedback(message) {
      // Set sentiment based on rating (5 = positive, 1 = negative)
      // Rating 3 is intentionally neutral and leaves sentiment unset
      if (message.rating >= 4) {
        setThreadRating('positive');
      } else if (message.rating <= 2) {
        setThreadRating('negative');
      }

      // Load feedback tags (validate against known tags for security)
      const validTags = ['accurate', 'helpful', 'well_cited', 'good_tone', 'inaccurate', 'missing_info', 'wrong_source', 'too_verbose', 'too_brief', 'wrong_tone'];
      if (message.feedback_tags && Array.isArray(message.feedback_tags)) {
        message.feedback_tags.forEach(tag => {
          if (validTags.includes(tag)) {
            const tagEl = document.querySelector(`#thread-feedback-tags .feedback-tag[data-tag="${tag}"]`);
            if (tagEl) {
              tagEl.classList.add('selected');
              threadFeedbackState.tags.push(tag);
            }
          }
        });
      }

      // Load notes (rating_notes contains the text feedback)
      if (message.rating_notes) {
        document.getElementById('thread-feedback-notes').value = message.rating_notes;
        threadFeedbackState.notes = message.rating_notes;
      }
    }

    async function saveThreadFeedback() {
      const notes = document.getElementById('thread-feedback-notes').value;
      threadFeedbackState.notes = notes;

      if (!currentThreadData) {
        alert('No thread selected');
        return;
      }

      // Find the last assistant message to attach feedback to
      const lastAssistantMsg = [...currentThreadData.messages].reverse().find(m => m.role === 'assistant');
      if (!lastAssistantMsg) {
        alert('No assistant message to rate');
        return;
      }

      // Derive rating from sentiment (thumbs)
      if (!threadFeedbackState.sentiment) {
        alert('Please select thumbs up or thumbs down');
        return;
      }
      const rating = threadFeedbackState.sentiment === 'positive' ? 5 : 1;

      try {
        const response = await fetch(`/api/admin/addie/threads/messages/${lastAssistantMsg.message_id}/feedback`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            rating: rating,
            rating_notes: notes,
            feedback_tags: threadFeedbackState.tags
          })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Failed to save feedback (${response.status})`);
        }

        alert('Thread feedback saved!');
        clearThreadFeedback();

        // Optionally mark as reviewed
        if (!currentThreadData.reviewed) {
          await markThreadReviewed(currentThreadData.thread_id);
        }
      } catch (error) {
        console.error('Error saving thread feedback:', error);
        alert('Error saving feedback');
      }
    }

    // =========================================================================
    // CLAUDE DIAGNOSIS
    // =========================================================================

    async function diagnoseThread() {
      if (!currentThreadData) {
        alert('No thread selected');
        return;
      }

      const diagnosisPanel = document.getElementById('diagnosis-panel');
      const diagnosisContent = document.getElementById('diagnosis-content');

      // Show loading state
      diagnosisPanel.style.display = 'block';
      diagnosisContent.innerHTML = '<div class="diagnosis-loading">Analyzing conversation with Claude...</div>';

      // Get any feedback notes as context
      const feedbackNotes = document.getElementById('thread-feedback-notes').value;

      try {
        const response = await fetch(`/api/admin/addie/threads/${currentThreadData.thread_id}/diagnose`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ feedback: feedbackNotes || undefined })
        });

        if (!response.ok) {
          throw new Error('Failed to get diagnosis');
        }

        const data = await response.json();
        diagnosisContent.innerHTML = renderMarkdown(data.analysis);
      } catch (error) {
        console.error('Error getting diagnosis:', error);
        diagnosisContent.innerHTML = '<div style="color: var(--color-error-600);">Error getting diagnosis. Please try again.</div>';
      }
    }

    function hideDiagnosisPanel() {
      document.getElementById('diagnosis-panel').style.display = 'none';
    }

    async function submitPerspectivesEntry() {
      const url = document.getElementById('perspectives-url').value ||
                  document.getElementById('perspectives-url-custom').value;
      const topic = document.getElementById('perspectives-topic').value;
      const take = document.getElementById('perspectives-take').value;

      if (!url || !topic) {
        alert('Please provide a URL and topic');
        return;
      }

      try {
        const response = await fetch('/api/admin/addie/suggestions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            suggestion_type: 'publish_content',
            content_type: 'external_link',
            suggested_name: topic,
            suggested_topic: topic,
            suggested_content: take || `Add Addie's take on this external resource.`,
            external_sources: [url],
            reasoning: `Discovered during thread ${currentConversationData?.thread_id || 'unknown'}. External source found useful for answering user questions.`,
            confidence: 0.7,
            expected_impact: 'Improves discoverability of useful external content for future queries.',
            supporting_interactions: currentConversationData?.thread_id ? [currentConversationData.thread_id] : []
          })
        });

        if (response.ok) {
          alert('Perspectives entry suggestion created! Review it in the Suggestions tab.');
          hideActionForms();
          loadSuggestions();
        } else {
          throw new Error('Failed to create suggestion');
        }
      } catch (error) {
        console.error('Error creating perspectives entry:', error);
        alert('Error creating entry');
      }
    }

    async function submitDocsIssue() {
      const title = document.getElementById('docs-issue-title').value;
      const description = document.getElementById('docs-issue-description').value;
      const location = document.getElementById('docs-issue-location').value;

      if (!title || !description) {
        alert('Please provide a title and description');
        return;
      }

      try {
        const response = await fetch('/api/admin/addie/suggestions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            suggestion_type: 'publish_content',
            content_type: 'docs',
            suggested_name: title,
            suggested_topic: title,
            suggested_content: description + (location ? `\\n\\nSuggested location: ${location}` : ''),
            reasoning: `Documentation gap identified from thread ${currentConversationData?.thread_id || 'unknown'}.`,
            confidence: 0.6,
            expected_impact: 'Improves documentation coverage for common questions.',
            supporting_interactions: currentConversationData?.thread_id ? [currentConversationData.thread_id] : []
          })
        });

        if (response.ok) {
          alert('Documentation issue suggestion created! Review it in the Suggestions tab.');
          hideActionForms();
          loadSuggestions();
        } else {
          throw new Error('Failed to create suggestion');
        }
      } catch (error) {
        console.error('Error creating docs issue:', error);
        alert('Error creating issue');
      }
    }

    async function submitRuleSuggestion() {
      const suggestionType = document.getElementById('rule-suggestion-type').value;
      const name = document.getElementById('rule-suggestion-name').value;
      const ruleType = document.getElementById('rule-suggestion-rule-type').value;
      const content = document.getElementById('rule-suggestion-content').value;
      const reasoning = document.getElementById('rule-suggestion-reasoning').value;

      if (!name || !content || !reasoning) {
        alert('Please fill in all required fields');
        return;
      }

      try {
        const response = await fetch('/api/admin/addie/suggestions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            suggestion_type: suggestionType,
            suggested_name: name,
            suggested_rule_type: ruleType,
            suggested_content: content,
            reasoning: reasoning,
            confidence: 0.5,
            expected_impact: 'Behavior change based on conversation review.',
            supporting_interactions: currentConversationData?.thread_id ? [currentConversationData.thread_id] : []
          })
        });

        if (response.ok) {
          alert('Rule suggestion created! Review it in the Suggestions tab.');
          hideActionForms();
          loadSuggestions();
        } else {
          throw new Error('Failed to create suggestion');
        }
      } catch (error) {
        console.error('Error creating rule suggestion:', error);
        alert('Error creating suggestion');
      }
    }

    // Initial load
    loadStats();
    loadRules();
    loadSuggestions();
    loadKnowledge();
    loadThreads();
    loadQueue();

    // Event listeners for thread filters
    document.getElementById('stats-timeframe').addEventListener('change', loadThreads);
    document.getElementById('channel-filter').addEventListener('change', loadThreads);
    document.getElementById('threads-flagged-only').addEventListener('change', loadThreads);
    document.getElementById('threads-unreviewed-only').addEventListener('change', loadThreads);
    document.getElementById('threads-has-feedback').addEventListener('change', loadThreads);
  </script>
</body>
</html>
