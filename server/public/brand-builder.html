<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>brand.json Builder - AdCP Brand Protocol</title>
    <link rel="icon" href="/AAo.svg" type="image/svg+xml">
    <link rel="stylesheet" href="/design-system.css">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <style>
      /* CSS Custom Properties for Theming - mapped to design system */
      :root {
        --primary-gradient: linear-gradient(135deg, var(--color-primary-700) 0%, var(--color-primary-600) 100%);
        --success-gradient: linear-gradient(135deg, var(--color-primary-700) 0%, var(--color-primary-500) 100%);
        --warning-gradient: linear-gradient(135deg, var(--color-warning-400) 0%, var(--color-error-400) 100%);

        --glass-bg: rgba(255, 255, 255, 0.1);
        --glass-border: rgba(255, 255, 255, 0.2);
        --glass-shadow: var(--shadow-lg);

        --surface-primary: var(--color-bg-card);
        --surface-secondary: var(--color-bg-subtle);
        --text-primary: var(--color-text-heading);
        --text-secondary: var(--color-text-secondary);
        --text-muted: var(--color-text-muted);

        --accent-blue: var(--color-primary-700);
        --accent-purple: var(--color-primary-600);
        --accent-green: var(--color-primary-700);
        --accent-orange: var(--color-warning-500);

        --timing-fast: 0.2s;
        --timing-normal: 0.4s;
        --easing: var(--ease-out);
      }

      body {
        font-family: var(--font-sans);
        font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
        line-height: var(--leading-normal);
        color: var(--text-primary);
        font-weight: var(--font-normal);
        margin: 0;
        padding: 60px 0 0 0;
        min-height: 100vh;
        background: linear-gradient(135deg, var(--color-primary-700) 0%, var(--color-primary-600) 100%);
        position: relative;
      }

      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background:
          radial-gradient(circle at 20% 50%, rgba(164, 194, 244, 0.3) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(164, 194, 244, 0.3) 0%, transparent 50%),
          radial-gradient(circle at 40% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
        pointer-events: none;
        z-index: 1;
      }

      .main-content {
        max-width: var(--container-wide);
        margin: 0 auto;
        padding: var(--space-10) var(--space-5);
        position: relative;
        z-index: 2;
      }

      .page-header {
        text-align: center;
        margin-bottom: var(--space-12);
      }

      .page-header h1 {
        color: white;
        font-size: var(--text-4xl);
        font-weight: var(--font-bold);
        margin: 0 0 var(--space-4) 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .page-header p {
        color: rgba(255, 255, 255, 0.9);
        font-size: var(--text-lg);
        margin: 0;
        max-width: 700px;
        margin: 0 auto;
      }

      .section {
        background: var(--surface-primary);
        backdrop-filter: blur(10px);
        border: var(--border-1) solid rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-xl);
        padding: var(--space-8);
        margin-bottom: var(--space-8);
        box-shadow: var(--shadow-lg);
        transition: var(--transition-all);
        position: relative;
        overflow: hidden;
      }

      .section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
        border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      }

      .section h3 {
        color: var(--text-primary);
        margin: 0 0 var(--space-5) 0;
        font-size: var(--text-2xl);
        font-weight: var(--font-semibold);
        display: flex;
        align-items: center;
        gap: var(--space-3);
      }

      .section h4 {
        color: var(--text-secondary);
        margin: 0 0 var(--space-4) 0;
        font-size: var(--text-xl);
        font-weight: var(--font-semibold);
      }

      .btn {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: var(--space-3) var(--space-6);
        border-radius: var(--radius-md);
        font-weight: var(--font-semibold);
        font-size: var(--text-sm);
        cursor: pointer;
        transition: var(--transition-all);
        text-decoration: none;
        display: inline-block;
        text-align: center;
        box-shadow: var(--shadow-primary-sm);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-primary-md);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-secondary {
        background: var(--color-gray-500);
        box-shadow: var(--shadow-sm);
      }

      .btn-secondary:hover {
        box-shadow: var(--shadow-md);
      }

      input[type='text'],
      input[type='url'],
      input[type='email'],
      input[type='number'],
      select,
      textarea {
        width: 100%;
        padding: var(--space-3) var(--space-4);
        border: var(--border-2) solid var(--color-border);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        transition: var(--transition-all);
        font-family: inherit;
        box-sizing: border-box;
      }

      input[type='text']:focus,
      input[type='url']:focus,
      input[type='email']:focus,
      input[type='number']:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px rgba(26, 54, 180, 0.15);
      }

      textarea {
        resize: vertical;
        min-height: 120px;
        font-family: var(--font-mono);
      }

      .form-group {
        margin-bottom: var(--space-5);
      }

      .form-group label {
        display: block;
        margin-bottom: var(--space-2);
        font-weight: var(--font-semibold);
        color: var(--text-primary);
      }

      .form-group .hint {
        font-size: var(--text-sm);
        color: var(--text-muted);
        margin-top: var(--space-1);
      }

      .variant-selector {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-4);
        margin-bottom: var(--space-6);
      }

      @media (max-width: 768px) {
        .variant-selector {
          grid-template-columns: 1fr;
        }
      }

      .variant-card {
        background: var(--color-bg-subtle);
        border: var(--border-2) solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        cursor: pointer;
        transition: var(--transition-all);
      }

      .variant-card:hover {
        border-color: var(--accent-blue);
        background: var(--color-primary-50);
      }

      .variant-card.selected {
        border-color: var(--accent-blue);
        background: var(--color-primary-50);
        box-shadow: var(--ring-primary);
      }

      .variant-card h4 {
        margin: 0 0 var(--space-2) 0;
        font-size: var(--text-lg);
        color: var(--text-primary);
      }

      .variant-card p {
        margin: 0;
        font-size: var(--text-sm);
        color: var(--text-secondary);
      }

      .variant-card .icon {
        font-size: 24px;
        margin-bottom: var(--space-2);
      }

      .property-entry {
        background: var(--color-bg-card);
        border: var(--border-1) solid var(--color-border);
        border-radius: var(--radius-md);
        padding: var(--space-3);
        margin-bottom: var(--space-2);
        display: flex;
        gap: var(--space-2);
        align-items: center;
      }

      .property-entry select,
      .property-entry input {
        margin: 0;
      }

      .property-entry select {
        width: auto;
        min-width: 120px;
      }

      .property-entry input {
        flex: 1;
      }

      .json-preview {
        background: var(--color-gray-900);
        color: var(--color-gray-100);
        padding: var(--space-5);
        border-radius: var(--radius-lg);
        overflow-x: auto;
        font-family: var(--font-mono);
        font-size: var(--text-sm);
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 400px;
        overflow-y: auto;
      }

      .validation-result {
        padding: var(--space-4);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-4);
      }

      .result-success {
        background: var(--color-primary-50);
        border: 1px solid var(--color-primary-200);
        color: var(--color-primary-800);
      }

      .result-warning {
        background: var(--color-warning-50);
        border: 1px solid var(--color-warning-200);
        color: var(--color-warning-800);
      }

      .result-error {
        background: var(--color-error-50);
        border: 1px solid var(--color-error-200);
        color: var(--color-error-800);
      }

      .result-info {
        background: var(--color-primary-50);
        border: 1px solid var(--color-primary-200);
        color: var(--color-primary-800);
      }

      .btn-disabled-hint {
        font-size: var(--text-xs);
        color: var(--text-muted);
        margin-top: var(--space-1);
        text-align: right;
      }

      .dashboard-header {
        background: var(--color-primary-50);
        border: 1px solid var(--color-primary-200);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        margin-bottom: var(--space-5);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: var(--space-3);
      }

      .dashboard-header h4 {
        margin: 0 0 var(--space-1) 0;
        color: var(--color-primary-800);
      }

      .dashboard-header p {
        margin: 0;
        font-size: var(--text-sm);
        color: var(--color-primary-800);
      }

      .dashboard-actions {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
      }

      .dashboard-actions .btn {
        padding: var(--space-2) var(--space-4);
        font-size: var(--text-sm);
      }

      .dashboard-actions .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .hidden {
        display: none !important;
      }

      .keller-badge {
        display: inline-block;
        font-size: var(--text-xs);
        padding: 1px 8px;
        border-radius: var(--radius-full);
        font-weight: var(--font-medium);
        margin-left: var(--space-2);
      }

      .keller-badge.master { background: var(--color-primary-100); color: var(--color-primary-800); }
      .keller-badge.sub_brand { background: var(--color-warning-100); color: var(--color-warning-700); }
      .keller-badge.endorsed { background: var(--color-primary-200); color: var(--color-primary-900); }
      .keller-badge.independent { background: var(--color-bg-subtle); color: var(--text-secondary); }

      /* Decision Tree Styles */
      .decision-step {
        margin-bottom: var(--space-6);
      }

      .decision-step h4 {
        margin: 0 0 var(--space-2) 0;
        font-size: var(--text-lg);
      }

      .step-hint {
        color: var(--text-secondary);
        font-size: var(--text-sm);
        margin: 0 0 var(--space-4) 0;
      }

      .decision-options {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
        margin-bottom: var(--space-4);
      }

      .decision-option {
        display: flex;
        align-items: center;
        gap: var(--space-4);
        padding: var(--space-4);
        border: 2px solid var(--color-border);
        border-radius: var(--radius-lg);
        background: var(--color-bg);
        cursor: pointer;
        text-align: left;
        transition: all 0.15s ease;
      }

      .decision-option:hover {
        border-color: var(--color-brand);
        background: var(--color-bg-subtle);
      }

      .decision-option.recommended {
        position: relative;
        border-color: var(--color-brand);
      }

      .option-badge {
        position: absolute;
        top: -10px;
        right: var(--space-4);
        background: var(--color-brand);
        color: white;
        font-size: var(--text-xs);
        padding: 2px 8px;
        border-radius: var(--radius-full);
        font-weight: var(--font-semibold);
      }

      .option-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--color-bg-subtle);
        border-radius: var(--radius-md);
        font-size: var(--text-xl);
        font-weight: var(--font-bold);
        color: var(--color-brand);
        flex-shrink: 0;
      }

      .option-content {
        flex: 1;
      }

      .option-content strong {
        display: block;
        margin-bottom: var(--space-1);
      }

      .option-content span {
        color: var(--text-secondary);
        font-size: var(--text-sm);
      }

      .examples-row {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        margin-bottom: var(--space-1);
      }

      .example-label {
        font-weight: var(--font-medium);
        color: var(--text-primary);
      }

      .back-link {
        background: none;
        border: none;
        color: var(--color-brand);
        cursor: pointer;
        padding: 0;
        font-size: var(--text-sm);
        margin-bottom: var(--space-4);
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
      }

      .back-link:hover {
        text-decoration: underline;
      }

      .info-callout {
        background: var(--color-bg-subtle);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        margin-top: var(--space-4);
        font-size: var(--text-sm);
      }

      .info-callout strong {
        display: block;
        margin-bottom: var(--space-2);
      }

      .info-callout ol {
        margin: 0;
        padding-left: var(--space-5);
      }

      .info-callout li {
        margin-bottom: var(--space-1);
      }

      /* Next Steps Styles */
      .next-steps {
        background: var(--color-success-50);
        border: 1px solid var(--color-success-100);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        margin-top: var(--space-6);
      }

      .next-steps h4 {
        margin: 0 0 var(--space-4) 0;
        color: var(--color-success-700);
        display: flex;
        align-items: center;
        gap: var(--space-2);
      }

      .next-steps ol {
        margin: 0;
        padding: 0;
        list-style: none;
        counter-reset: step-counter;
      }

      .next-steps li {
        counter-increment: step-counter;
        display: flex;
        gap: var(--space-3);
        margin-bottom: var(--space-4);
        align-items: flex-start;
      }

      .next-steps li:last-child {
        margin-bottom: 0;
      }

      .step-number {
        width: 28px;
        height: 28px;
        background: var(--color-success-700);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        flex-shrink: 0;
      }

      .step-content {
        flex: 1;
      }

      .step-content strong {
        display: block;
        margin-bottom: var(--space-1);
        color: var(--color-success-700);
      }

      .step-content p {
        margin: 0 0 var(--space-2) 0;
        font-size: var(--text-sm);
        color: var(--text-secondary);
      }

      .step-content code {
        background: white;
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-sm);
        font-size: var(--text-sm);
        border: 1px solid var(--color-success-100);
      }

      .verify-result {
        margin-top: var(--space-3);
        padding: var(--space-3);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
      }

      .verify-result.success {
        background: var(--color-success-50);
        border: 1px solid var(--color-success-100);
        color: var(--color-success-700);
      }

      .verify-result.error {
        background: var(--color-error-50);
        border: 1px solid var(--color-error-100);
        color: var(--color-error-700);
      }

      .verify-result.pending {
        background: var(--color-warning-50);
        border: 1px solid var(--color-warning-100);
        color: var(--color-warning-700);
      }

      /* Portfolio Two-Panel Layout */
      .portfolio-layout {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: var(--space-6);
        margin-bottom: var(--space-6);
      }

      @media (max-width: 1024px) {
        .portfolio-layout {
          grid-template-columns: 1fr;
        }
      }

      /* Brand Tree Navigator (Left Panel) */
      .brand-tree-panel {
        background: var(--color-bg-subtle);
        border: var(--border-1) solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        max-height: 600px;
        overflow-y: auto;
      }

      .brand-tree-panel h4 {
        margin: 0 0 var(--space-4) 0;
        font-size: var(--text-lg);
        color: var(--text-primary);
      }

      .brand-tree-list {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .brand-tree-item {
        margin-bottom: var(--space-1);
      }

      .brand-tree-node {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: var(--transition-all);
        font-size: var(--text-sm);
      }

      .brand-tree-node:hover {
        background: var(--color-bg-card);
      }

      .brand-tree-node.selected {
        background: var(--color-primary-100);
        color: var(--color-brand);
        font-weight: var(--font-semibold);
      }

      .brand-tree-node .expand-icon {
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: var(--text-muted);
      }

      .brand-tree-node .brand-name {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .brand-tree-node .add-child-btn {
        opacity: 0;
        background: var(--color-brand);
        color: white;
        border: none;
        width: 20px;
        height: 20px;
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        padding: 0;
      }

      .brand-tree-node:hover .add-child-btn {
        opacity: 1;
      }

      .brand-tree-children {
        margin-left: var(--space-6);
      }

      .add-root-brand-btn {
        margin-top: var(--space-3);
        width: 100%;
      }

      /* Brand Detail Editor (Right Panel) */
      .brand-detail-panel {
        background: var(--color-bg-card);
        border: var(--border-1) solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        max-height: 600px;
        overflow-y: auto;
      }

      .brand-detail-empty {
        text-align: center;
        color: var(--text-muted);
        padding: var(--space-12);
      }

      .brand-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-5);
        padding-bottom: var(--space-3);
        border-bottom: var(--border-2) solid var(--color-border);
      }

      .brand-detail-header h4 {
        margin: 0;
        font-size: var(--text-xl);
      }

      /* Brand Files Dashboard */
      .brand-files-dashboard {
        background: var(--color-bg-subtle);
        border: var(--border-1) solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        margin-top: var(--space-6);
      }

      .brand-files-dashboard h4 {
        margin: 0 0 var(--space-4) 0;
        font-size: var(--text-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .file-row {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-3);
        background: var(--color-bg-card);
        border: var(--border-1) solid var(--color-border);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-2);
      }

      .file-row:last-child {
        margin-bottom: 0;
      }

      .file-row .file-path {
        flex: 1;
        font-family: var(--font-mono);
        font-size: var(--text-sm);
        color: var(--text-primary);
      }

      .file-row .file-type {
        font-size: var(--text-xs);
        color: var(--text-muted);
        text-transform: uppercase;
        font-weight: var(--font-semibold);
      }

      .file-row .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: var(--radius-full);
        background: var(--color-gray-400);
      }

      .file-row .status-indicator.valid {
        background: var(--color-success-500);
      }

      .file-row .status-indicator.missing {
        background: var(--color-error-500);
      }

      .file-row .status-indicator.checking {
        background: var(--color-warning-500);
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      @media (max-width: 768px) {
        .page-header h1 {
          font-size: var(--text-3xl);
        }

        .section {
          padding: var(--space-5);
        }

        .portfolio-layout {
          grid-template-columns: 1fr;
        }

        .brand-tree-panel,
        .brand-detail-panel {
          max-height: none;
        }

        .contact-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Collapsible sections in brand forms */
      .brand-section-toggle {
        width: 100%;
        cursor: default;
        border: var(--border-1) solid var(--color-border);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-4);
        background: var(--color-bg-card);
      }

      .brand-section-toggle summary {
        list-style: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-3) var(--space-4);
        font-weight: var(--font-semibold);
        font-size: var(--text-base);
        color: var(--text-primary);
        cursor: pointer;
      }

      .brand-section-toggle summary::-webkit-details-marker {
        display: none;
      }

      .brand-section-toggle summary::after {
        content: '\25B6';
        font-size: var(--text-xs);
        transition: transform 0.2s;
        color: var(--text-muted);
      }

      .brand-section-toggle[open] summary::after {
        transform: rotate(90deg);
      }

      .brand-section-content {
        padding: 0 var(--space-4) var(--space-4);
      }

      /* Chip components (industry, tone attributes) */
      .chip-container {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        padding: var(--space-2);
        border: var(--border-2) solid var(--color-border);
        border-radius: var(--radius-md);
        min-height: 40px;
        background: var(--color-bg-card);
        cursor: text;
        align-items: center;
      }

      .chip-container:focus-within {
        border-color: var(--color-brand);
        box-shadow: 0 0 0 3px var(--color-primary-100);
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        padding: var(--space-1) var(--space-2);
        background: var(--color-primary-100);
        color: var(--color-brand);
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: var(--font-medium);
        white-space: nowrap;
      }

      .chip-remove {
        cursor: pointer;
        font-size: 10px;
        opacity: 0.7;
        background: none;
        border: none;
        padding: 0 0 0 2px;
        color: inherit;
        line-height: 1;
      }

      .chip-remove:hover {
        opacity: 1;
      }

      .chip-input {
        border: none !important;
        outline: none !important;
        flex: 1;
        min-width: 120px;
        padding: 0 !important;
        font-size: var(--text-sm) !important;
        box-shadow: none !important;
      }

      .chip-input:focus {
        box-shadow: none !important;
      }

      .dropdown-wrapper {
        position: relative;
      }

      .dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--color-bg-card);
        border: var(--border-1) solid var(--color-border);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        max-height: 200px;
        overflow-y: auto;
        z-index: 50;
        display: none;
        margin-top: var(--space-1);
      }

      .dropdown-list.open {
        display: block;
      }

      .dropdown-option {
        padding: var(--space-2) var(--space-3);
        font-size: var(--text-sm);
        cursor: pointer;
      }

      .dropdown-option:hover {
        background: var(--color-primary-50);
        color: var(--color-brand);
      }

      .dropdown-option.selected {
        background: var(--color-primary-100);
        color: var(--color-brand);
        font-weight: var(--font-medium);
      }

      /* Color picker row */
      .color-row {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        margin-bottom: var(--space-3);
      }

      .color-row:last-child {
        margin-bottom: 0;
      }

      .color-label {
        min-width: 80px;
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--text-secondary);
        text-transform: capitalize;
      }

      .color-picker-wrapper {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        flex: 1;
      }

      .color-picker-wrapper input[type="color"] {
        width: 36px;
        height: 36px;
        padding: 2px;
        border: var(--border-1) solid var(--color-border);
        border-radius: var(--radius-md);
        cursor: pointer;
        background: none;
      }

      .color-picker-wrapper input[type="text"] {
        flex: 1;
        font-family: var(--font-mono);
        font-size: var(--text-sm);
      }

      /* Logo entry */
      .logo-entry {
        background: var(--color-bg-subtle);
        border: var(--border-1) solid var(--color-border);
        border-radius: var(--radius-md);
        padding: var(--space-3);
        margin-bottom: var(--space-2);
      }

      .logo-entry:last-child {
        margin-bottom: 0;
      }

      .logo-entry-row {
        display: flex;
        gap: var(--space-2);
        align-items: center;
      }

      .logo-entry-row + .logo-entry-row {
        margin-top: var(--space-2);
      }

      .logo-entry-row input {
        flex: 1;
      }

      .logo-entry-row input[type="number"] {
        width: 80px;
        flex: none;
      }

      /* View brand link */
      .btn-view-brand {
        background: var(--color-primary-50);
        color: var(--color-brand);
        border: var(--border-1) solid var(--color-primary-200);
        text-decoration: none;
        display: inline-block;
      }

      .btn-view-brand:hover {
        background: var(--color-primary-100);
      }

      /* Contact grid */
      .contact-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: var(--space-3);
      }
    </style>
  </head>
  <body>
    <!-- Navigation (loaded by nav.js) -->
    <div id="adcp-nav"></div>
    <script src="/nav.js"></script>

    <div class="main-content">
      <!-- Page Header -->
      <div class="page-header">
        <h1>brand.json Builder</h1>
        <p>
          Make your brand discoverable by AI. When AI agents look up your domain,
          they'll find your official brand name and identity instead of guessing.
        </p>
        <p style="font-size: var(--text-sm); opacity: 0.9; margin-top: var(--space-2);">
          Similar to how robots.txt tells search engines how to crawl your site, brand.json tells AI agents who you are.
        </p>
      </div>

      <!-- Domain Input Section -->
      <div class="section">
        <h3>Build Your brand.json</h3>
        <p style="color: var(--text-secondary); margin-bottom: var(--space-5)">
          Enter your domain to validate an existing brand.json or create a new one.
        </p>

        <div style="display: flex; gap: var(--space-3); margin-bottom: var(--space-5)">
          <input
            type="text"
            id="domain-input"
            placeholder="example.com"
            style="flex: 1"
            onkeypress="if(event.key === 'Enter') startBuilding()"
          />
          <button class="btn" onclick="startBuilding()" id="start-btn">Get Started</button>
        </div>

        <!-- Validation Results -->
        <div id="validation-results" class="hidden"></div>

        <!-- Builder Form (hidden initially) -->
        <div id="builder-form" class="hidden">
          <!-- Dashboard Header -->
          <div class="dashboard-header">
            <div>
              <h4>brand.json for <span id="domain-display"></span></h4>
              <p id="file-status">Creating new brand.json</p>
            </div>
            <div class="dashboard-actions">
              <a id="view-brand-link" class="btn btn-view-brand" href="#" target="_blank" style="display:none;">View Brand</a>
              <button class="btn btn-secondary" onclick="copyJson()">Copy JSON</button>
              <button class="btn btn-secondary" onclick="downloadJson()">Download</button>
              <div style="display: flex; flex-direction: column; align-items: flex-end;">
                <button class="btn" id="save-registry-btn" onclick="saveToRegistry()" disabled title="Log in to save">Save to Registry</button>
                <span id="save-registry-hint" class="btn-disabled-hint">Log in as a member to save</span>
              </div>
            </div>
          </div>

          <!-- Decision Tree -->
          <div id="decision-tree">
            <!-- Step 1: Brand Count -->
            <div id="step-brand-count" class="decision-step">
              <h4>How many brands does your company have?</h4>
              <p class="step-hint">If you're unsure, you probably have just one brand.</p>

              <div class="decision-options">
                <button class="decision-option" onclick="selectBrandCount('single')">
                  <div class="option-icon">1</div>
                  <div class="option-content">
                    <strong>Just one brand</strong>
                    <span>My company name IS my brand name</span>
                  </div>
                </button>

                <button class="decision-option" onclick="selectBrandCount('multiple')">
                  <div class="option-icon">+</div>
                  <div class="option-content">
                    <strong>Multiple brands</strong>
                    <span>We own several distinct brand names</span>
                  </div>
                </button>
              </div>

              <div class="examples-row">
                <span class="example-label">Single brand:</span> Allbirds, Warby Parker, Stripe
              </div>
              <div class="examples-row">
                <span class="example-label">Multiple brands:</span> Nike Inc (Nike, Jordan, Converse), P&G (Tide, Pampers)
              </div>
            </div>

            <!-- Step 2a: Single Brand Hosting -->
            <div id="step-single-hosting" class="decision-step hidden">
              <button class="back-link" onclick="goBackTo('step-brand-count')">‚Üê Back</button>
              <h4>Where will you host your brand.json file?</h4>

              <div class="decision-options">
                <button class="decision-option recommended" onclick="selectVariant('single')">
                  <div class="option-badge">Recommended</div>
                  <div class="option-icon">üìÑ</div>
                  <div class="option-content">
                    <strong>On my website</strong>
                    <span>I'll put the file at <span id="single-domain-hint"></span>/.well-known/brand.json</span>
                  </div>
                </button>

                <button class="decision-option" onclick="selectVariant('agent')">
                  <div class="option-icon">ü§ñ</div>
                  <div class="option-content">
                    <strong>I have an MCP agent</strong>
                    <span>My brand info is served dynamically by an AI agent</span>
                  </div>
                </button>
              </div>
            </div>

            <!-- Step 2b: Multiple Brands - Which Domain -->
            <div id="step-multiple-domain" class="decision-step hidden">
              <button class="back-link" onclick="goBackTo('step-brand-count')">‚Üê Back</button>
              <h4>Which domain are you setting up?</h4>
              <p class="step-hint">Your domain: <strong id="multi-domain-hint"></strong></p>

              <div class="decision-options">
                <button class="decision-option" onclick="selectVariant('portfolio')">
                  <div class="option-icon">üè¢</div>
                  <div class="option-content">
                    <strong>This is the parent company domain</strong>
                    <span>All brand info lives here (e.g., nikeinc.com for Nike Inc)</span>
                  </div>
                </button>

                <button class="decision-option" onclick="selectVariant('redirect')">
                  <div class="option-icon">‚Ü™Ô∏è</div>
                  <div class="option-content">
                    <strong>This is one of our brand domains</strong>
                    <span>This brand is owned by a larger company</span>
                  </div>
                </button>
              </div>

              <div class="info-callout">
                <strong>How multi-brand setup works:</strong>
                <ol>
                  <li>Create the full portfolio on your parent company domain</li>
                  <li>Add a small redirect file on each brand domain</li>
                </ol>
              </div>
            </div>
          </div>

          <!-- Single Brand Form (simplest case) -->
          <div id="form-single">
            <button class="back-link" onclick="goBackTo('step-single-hosting')">‚Üê Back</button>
            <h4 style="margin-bottom: var(--space-4)">Brand information</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-5)">
              <div class="form-group" style="margin-bottom: 0">
                <label>Brand name</label>
                <input
                  type="text"
                  id="single-brand-name"
                  placeholder="Allbirds"
                  oninput="autoGenerateBrandId('single'); updatePreview()"
                />
              </div>
              <div class="form-group" style="margin-bottom: 0">
                <label>Brand ID</label>
                <input
                  type="text"
                  id="single-brand-id"
                  placeholder="allbirds"
                  oninput="updatePreview()"
                  onchange="markBrandIdManuallyEdited('single')"
                />
                <p class="hint">Auto-generated from name</p>
              </div>
            </div>
            <div>
              <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2); font-size: var(--text-sm); font-weight: var(--font-medium);">
                Properties (websites, apps) <span style="font-weight: var(--font-normal); color: var(--text-muted); font-size: var(--text-xs);">(optional)</span>
                <button class="btn" onclick="addSingleBrandProperty()" style="padding: var(--space-2) var(--space-4); font-size: var(--text-sm);">+ Add Property</button>
              </label>
              <div id="single-brand-properties">
                <div style="padding: var(--space-4); border: 1px dashed var(--color-border); border-radius: var(--radius-md); text-align: center;">
                  <p style="color: var(--text-muted); font-size: var(--text-sm); margin: 0;">Add your website, app, or other digital properties where your brand appears</p>
                </div>
              </div>
            </div>

            <details class="brand-section-toggle" style="margin-top: var(--space-5);">
              <summary>Brand identity</summary>
              <div class="brand-section-content">
                <div class="form-group">
                  <label>Brand description <span style="font-weight: var(--font-normal); color: var(--text-muted); font-size: var(--text-xs);">(optional)</span></label>
                  <textarea id="single-description" rows="2" placeholder="Describe your brand, e.g. A wholesome snack brand focused on fresh, natural ingredients" oninput="updateSingleIdentity('description', this.value); updateDescCharCount(this.value)"></textarea>
                  <p class="hint" id="single-desc-char-count">0 / 500 characters</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); margin-bottom: var(--space-4);">
                  <div class="form-group" style="margin-bottom: 0;">
                    <label>Brand tagline <span style="font-weight: var(--font-normal); color: var(--text-muted); font-size: var(--text-xs);">(optional)</span></label>
                    <input type="text" id="single-tagline" placeholder="Real food. Real Happiness." oninput="updateSingleIdentity('tagline', this.value)" />
                  </div>
                  <div class="form-group" style="margin-bottom: 0;">
                    <label>Brand voice <span style="font-weight: var(--font-normal); color: var(--text-muted); font-size: var(--text-xs);">(optional)</span></label>
                    <input type="text" id="single-tone-voice" placeholder="Describe your brand's overall personality and tone (e.g. Professional, Trustworthy, Friendly, Approachable)" oninput="updateSingleTone('voice', this.value)" />
                  </div>
                </div>
                <div class="form-group" style="margin-bottom: var(--space-4);">
                  <label>Voice characteristics <span style="font-weight: var(--font-normal); color: var(--text-muted); font-size: var(--text-xs);">(optional)</span></label>
                  <div class="chip-container" id="single-tone-attributes-container" onclick="document.getElementById('single-tone-attributes-input').focus()">
                    <span id="single-tone-attributes-chips"></span>
                    <input type="text" class="chip-input" id="single-tone-attributes-input"
                      placeholder="e.g. Confident, Innovative, Bold, Clear"
                      onkeydown="handleToneChipKeydown(event, 'single', 'attributes')" />
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); margin-bottom: var(--space-4);">
                  <div class="form-group" style="margin-bottom: 0;">
                    <label>On-brand communication <span style="font-weight: var(--font-normal); color: var(--text-muted); font-size: var(--text-xs);">(optional)</span></label>
                    <div class="chip-container" id="single-tone-dos-container" onclick="document.getElementById('single-tone-dos-input').focus()">
                      <span id="single-tone-dos-chips"></span>
                      <input type="text" class="chip-input" id="single-tone-dos-input"
                        placeholder="e.g. Made with real ingredients, Fresh from the farm, Snack happy"
                        onkeydown="handleToneChipKeydown(event, 'single', 'dos')" />
                    </div>
                  </div>
                  <div class="form-group" style="margin-bottom: 0;">
                    <label>Off-brand communication <span style="font-weight: var(--font-normal); color: var(--text-muted); font-size: var(--text-xs);">(optional)</span></label>
                    <div class="chip-container" id="single-tone-donts-container" onclick="document.getElementById('single-tone-donts-input').focus()">
                      <span id="single-tone-donts-chips"></span>
                      <input type="text" class="chip-input" id="single-tone-donts-input"
                        placeholder="e.g. Ultimate super-snack, Miracle ingredients, Peak vitality snack, Soul-nourishing"
                        onkeydown="handleToneChipKeydown(event, 'single', 'donts')" />
                    </div>
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); margin-bottom: var(--space-4);">
                  <div class="form-group" style="margin-bottom: 0;">
                    <label>Industry <span style="font-weight: var(--font-normal); color: var(--text-muted); font-size: var(--text-xs);">(optional)</span></label>
                    <div class="dropdown-wrapper" id="single-industry-wrapper">
                      <div class="chip-container" onclick="focusIndustryInput('single')">
                        <span id="single-industry-chips"></span>
                        <input type="text" class="chip-input" id="single-industry-input"
                          placeholder="e.g. Food &amp; Beverage, Beauty &amp; Cosmetics"
                          onfocus="showIndustryDropdown('single')"
                          oninput="filterIndustryDropdown('single', this.value)"
                          onkeydown="handleIndustryKeydown(event, 'single')" />
                      </div>
                      <div class="dropdown-list" id="single-industry-list"></div>
                    </div>
                  </div>
                  <div class="form-group" style="margin-bottom: 0;">
                    <label>Target audience <span style="font-weight: var(--font-normal); color: var(--text-muted); font-size: var(--text-xs);">(optional)</span></label>
                    <input type="text" id="single-target_audience" placeholder="e.g. Health-conscious parents, Young urban professionals, Skincare enthusiasts" oninput="updateSingleIdentity('target_audience', this.value)" />
                  </div>
                </div>
                <div class="form-group">
                  <label>Privacy policy URL <span style="font-weight: var(--font-normal); color: var(--text-muted); font-size: var(--text-xs);">(optional)</span></label>
                  <input type="url" id="single-privacy_policy_url" placeholder="e.g. https://example.com/privacy" oninput="updateSingleIdentity('privacy_policy_url', this.value)" />
                </div>
              </div>
            </details>

            <details class="brand-section-toggle">
              <summary>Creative assets</summary>
              <div class="brand-section-content">
                <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2); font-size: var(--text-sm); font-weight: var(--font-medium);">
                  Logos <span style="font-weight: var(--font-normal); color: var(--text-muted); font-size: var(--text-xs);">(optional)</span>
                  <button class="btn" onclick="addSingleLogo()" style="padding: var(--space-2) var(--space-3); font-size: var(--text-xs);">+ Add Logo</button>
                </label>
                <div id="single-logos-container">
                  <div style="padding: var(--space-3); border: 1px dashed var(--color-border); border-radius: var(--radius-md); text-align: center; margin-bottom: var(--space-4);">
                    <p style="color: var(--text-muted); font-size: var(--text-sm); margin: 0;">No logos yet. Add a URL to your brand logo.</p>
                  </div>
                </div>

                <label style="display: block; margin-bottom: var(--space-2); font-size: var(--text-sm); font-weight: var(--font-medium);">Colors <span style="font-weight: var(--font-normal); color: var(--text-muted); font-size: var(--text-xs);">(optional)</span></label>
                <p style="font-size: var(--text-xs); color: var(--text-muted); margin: 0 0 var(--space-2) 0;">Define your brand color palette. Each color name can have one or more hex values.</p>
                <div id="single-colors-container" style="margin-bottom: var(--space-4);"></div>

                <label style="display: block; margin-bottom: var(--space-2); font-size: var(--text-sm); font-weight: var(--font-medium);">Fonts <span style="font-weight: var(--font-normal); color: var(--text-muted); font-size: var(--text-xs);">(optional)</span></label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                  <div class="form-group" style="margin-bottom: 0;">
                    <input type="text" id="single-font-primary" placeholder="Primary font family" oninput="updateSingleFont('primary', this.value)" />
                    <p class="hint">Primary</p>
                  </div>
                  <div class="form-group" style="margin-bottom: 0;">
                    <input type="text" id="single-font-secondary" placeholder="Secondary font family" oninput="updateSingleFont('secondary', this.value)" />
                    <p class="hint">Secondary</p>
                  </div>
                </div>
              </div>
            </details>
          </div>

          <!-- Brand Portfolio Form (multi-brand) -->
          <div id="form-portfolio" class="hidden">
            <button class="back-link" onclick="goBackTo('step-multiple-domain')">‚Üê Back</button>
            <h4 style="margin-bottom: var(--space-4)">House information</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-5)">
              <div class="form-group" style="margin-bottom: 0">
                <label>House domain</label>
                <input
                  type="text"
                  id="portfolio-house-domain"
                  placeholder="nikeinc.com"
                  oninput="updatePreview()"
                />
                <p class="hint">Corporate/parent company domain</p>
              </div>
              <div class="form-group" style="margin-bottom: 0">
                <label>House name</label>
                <input
                  type="text"
                  id="portfolio-house-name"
                  placeholder="Nike, Inc."
                  oninput="updatePreview()"
                />
              </div>
            </div>

            <h4 style="margin: var(--space-6) 0 var(--space-4) 0;">Brand portfolio</h4>

            <!-- Two-Panel Layout -->
            <div class="portfolio-layout">
              <!-- Left Panel: Brand Tree Navigator -->
              <div class="brand-tree-panel">
                <h4>Brands</h4>
                <div id="brand-tree-container">
                  <p style="color: var(--text-muted); font-size: var(--text-sm); text-align: center;">No brands yet</p>
                </div>
                <button class="btn add-root-brand-btn" onclick="addBrand(null)">+ Add Brand</button>
              </div>

              <!-- Right Panel: Brand Detail Editor -->
              <div class="brand-detail-panel">
                <div id="brand-detail-content" class="brand-detail-empty">
                  <p>Select a brand from the tree to edit its details</p>
                </div>
              </div>
            </div>

            <!-- Brand Files Dashboard -->
            <div id="brand-files-dashboard" class="brand-files-dashboard hidden">
              <h4>
                <span>Brand files</span>
                <button class="btn" onclick="validateAllFiles()" style="padding: var(--space-2) var(--space-4); font-size: var(--text-xs);">Validate all</button>
              </h4>
              <div id="brand-files-list"></div>
            </div>
          </div>

          <!-- Brand Redirect Form -->
          <div id="form-redirect" class="hidden">
            <button class="back-link" onclick="goBackTo('step-multiple-domain')">‚Üê Back</button>
            <div class="form-group">
              <label>House domain</label>
              <input
                type="text"
                id="redirect-house-domain"
                placeholder="nikeinc.com"
                oninput="updatePreview()"
              />
              <p class="hint">The corporate/house domain that contains the full brand portfolio</p>
            </div>
          </div>

          <!-- Brand Agent Form -->
          <div id="form-agent" class="hidden">
            <button class="back-link" onclick="goBackTo('step-single-hosting')">‚Üê Back</button>
            <div class="form-group">
              <label>Agent URL</label>
              <input
                type="url"
                id="agent-url"
                placeholder="https://agent.example.com/mcp"
                oninput="updatePreview()"
              />
              <p class="hint">The MCP endpoint URL for the brand agent</p>
            </div>
            <div class="form-group">
              <label>Agent ID</label>
              <input
                type="text"
                id="agent-id"
                placeholder="my_brand_agent"
                oninput="updatePreview()"
              />
              <p class="hint">Unique identifier for the agent</p>
            </div>
          </div>

          <!-- Contact Information (root-level, shown for single + portfolio) -->
          <div id="contact-section" class="hidden" style="margin-top: var(--space-5);">
            <details class="brand-section-toggle">
              <summary>Contact information</summary>
              <div class="brand-section-content">
                <div class="contact-grid">
                  <div class="form-group" style="margin-bottom: 0;">
                    <label>Name <span style="font-weight: var(--font-normal); color: var(--text-muted); font-size: var(--text-xs);">(optional)</span></label>
                    <input type="text" id="contact-name" placeholder="Brand Team" oninput="updateContact('name', this.value)" />
                  </div>
                  <div class="form-group" style="margin-bottom: 0;">
                    <label>Email <span style="font-weight: var(--font-normal); color: var(--text-muted); font-size: var(--text-xs);">(optional)</span></label>
                    <input type="email" id="contact-email" placeholder="brands@example.com" oninput="updateContact('email', this.value)" />
                  </div>
                  <div class="form-group" style="margin-bottom: 0;">
                    <label>Domain <span style="font-weight: var(--font-normal); color: var(--text-muted); font-size: var(--text-xs);">(optional)</span></label>
                    <input type="text" id="contact-domain" placeholder="example.com" oninput="updateContact('domain', this.value)" />
                  </div>
                </div>
              </div>
            </details>
          </div>

          <!-- JSON Preview -->
          <details open style="margin-top: var(--space-6);">
            <summary style="cursor: pointer; font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--text-primary); margin-bottom: var(--space-2); list-style: none; display: flex; align-items: center; gap: var(--space-2);">
              <span>Live Preview</span>
              <span style="font-size: var(--text-xs); font-weight: var(--font-normal); color: var(--text-muted);">brand.json</span>
            </summary>
            <p style="font-size: var(--text-xs); color: var(--text-muted); margin: 0 0 var(--space-3) 0;">Updates automatically as you fill in fields above</p>
            <pre class="json-preview" id="json-preview">{}</pre>
          </details>

          <!-- Next Steps / Success State -->
          <div class="next-steps" id="next-steps">
            <h4>Next steps</h4>
            <ol>
              <li>
                <div class="step-number">1</div>
                <div class="step-content">
                  <strong>Download your file</strong>
                  <p>Save the generated brand.json to your computer.</p>
                  <button class="btn" onclick="downloadJson()" style="padding: var(--space-2) var(--space-4);">Download brand.json</button>
                </div>
              </li>
              <li>
                <div class="step-number">2</div>
                <div class="step-content">
                  <strong>Upload to your website</strong>
                  <p>Place the file at this exact location on your server:</p>
                  <code id="deploy-path">https://example.com/.well-known/brand.json</code>
                  <p style="margin-top: var(--space-2);">Create the <code>.well-known</code> folder if it doesn't exist.</p>
                </div>
              </li>
              <li>
                <div class="step-number">3</div>
                <div class="step-content">
                  <strong>Verify it works</strong>
                  <p>Test that your brand.json is accessible and valid.</p>
                  <button class="btn btn-secondary" onclick="verifyDeployment()" id="verify-btn" style="padding: var(--space-2) var(--space-4);">Test My Domain</button>
                  <div id="verify-result"></div>
                </div>
              </li>
              <li>
                <div class="step-number">4</div>
                <div class="step-content">
                  <strong>Preview your brand</strong>
                  <p>See how AI agents will view your brand identity.</p>
                  <a id="next-steps-view-link" class="btn btn-view-brand" href="#" target="_blank" style="padding: var(--space-2) var(--space-4);">Open Brand Viewer</a>
                </div>
              </li>
            </ol>
          </div>
        </div>
      </div>

      <!-- Help Section -->
      <div class="section">
        <h3>Need Help?</h3>
        <p style="color: var(--text-secondary); margin-bottom: var(--space-4)">
          Learn more about the Brand Protocol and brand.json format:
        </p>
        <div style="display: flex; gap: var(--space-3); flex-wrap: wrap">
          <a href="https://docs.adcontextprotocol.org/docs/brand-protocol" target="_blank" class="btn" style="text-decoration: none">
            Brand Protocol Docs
          </a>
          <a href="https://docs.adcontextprotocol.org/docs/brand-protocol/brand-json" target="_blank" class="btn btn-secondary" style="text-decoration: none">
            brand.json Spec
          </a>
        </div>
      </div>
    </div>

    <!-- Footer (loaded by nav.js) -->
    <div id="adcp-footer"></div>

    <script>
      // ============================================================================
      // State
      // ============================================================================

      let currentDomain = '';
      let currentVariant = 'single'; // single, portfolio, redirect, agent
      let brands = [];
      let brandIdCounter = 0;
      let singleBrandProperties = [];
      let selectedBrandId = null; // For portfolio mode
      let brandIdManuallyEdited = { single: false }; // Track if user manually edited brand ID
      let autoSaveTimer = null;

      // ============================================================================
      // localStorage Auto-Save
      // ============================================================================

      function scheduleAutoSave() {
        if (autoSaveTimer) clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(saveToLocalStorage, 500);
      }

      function saveToLocalStorage() {
        if (!currentDomain) return;
        try {
          const state = collectBuilderState();
          localStorage.setItem(`brand_builder_draft_${currentDomain}`, JSON.stringify(state));
        } catch (e) {
          // localStorage unavailable (private browsing, quota exceeded)
        }
      }

      function collectBuilderState() {
        return {
          version: 1,
          domain: currentDomain,
          variant: currentVariant,
          savedAt: new Date().toISOString(),
          singleBrand: {
            name: document.getElementById('single-brand-name')?.value || '',
            id: document.getElementById('single-brand-id')?.value || '',
            idManuallyEdited: brandIdManuallyEdited.single || false,
            properties: singleBrandProperties.map(p => ({ ...p }))
          },
          portfolio: {
            houseDomain: document.getElementById('portfolio-house-domain')?.value || '',
            houseName: document.getElementById('portfolio-house-name')?.value || '',
            brands: brands.map(b => ({ ...b, properties: (b.properties || []).map(p => ({ ...p })) })),
            brandIdCounter: brandIdCounter,
            selectedBrandId: selectedBrandId
          },
          redirect: {
            houseDomain: document.getElementById('redirect-house-domain')?.value || ''
          },
          agent: {
            url: document.getElementById('agent-url')?.value || '',
            id: document.getElementById('agent-id')?.value || ''
          }
        };
      }

      function loadFromLocalStorage(domain) {
        try {
          const saved = localStorage.getItem(`brand_builder_draft_${domain}`);
          if (!saved) return null;
          const state = JSON.parse(saved);
          if (state.version !== 1) return null;
          return state;
        } catch (e) {
          return null;
        }
      }

      function restoreBuilderState(state) {
        currentVariant = state.variant || 'single';

        // Restore single brand fields
        if (state.singleBrand) {
          document.getElementById('single-brand-name').value = state.singleBrand.name || '';
          document.getElementById('single-brand-id').value = state.singleBrand.id || '';
          brandIdManuallyEdited.single = state.singleBrand.idManuallyEdited || false;
          singleBrandProperties = (state.singleBrand.properties || []).map(p => ({ ...p }));
        }

        // Restore portfolio fields
        if (state.portfolio) {
          document.getElementById('portfolio-house-domain').value = state.portfolio.houseDomain || '';
          document.getElementById('portfolio-house-name').value = state.portfolio.houseName || '';
          brands = (state.portfolio.brands || []).map(b => ({ ...b, properties: (b.properties || []).map(p => ({ ...p })) }));
          brandIdCounter = state.portfolio.brandIdCounter || 0;
          selectedBrandId = state.portfolio.selectedBrandId || null;
        }

        // Restore other variant fields
        if (state.redirect) {
          document.getElementById('redirect-house-domain').value = state.redirect.houseDomain || '';
        }
        if (state.agent) {
          document.getElementById('agent-url').value = state.agent.url || '';
          document.getElementById('agent-id').value = state.agent.id || '';
        }
        // Show the correct form, hide decision tree
        document.getElementById('decision-tree').classList.add('hidden');
        document.getElementById('form-single').classList.toggle('hidden', currentVariant !== 'single');
        document.getElementById('form-portfolio').classList.toggle('hidden', currentVariant !== 'portfolio');
        document.getElementById('form-redirect').classList.toggle('hidden', currentVariant !== 'redirect');
        document.getElementById('form-agent').classList.toggle('hidden', currentVariant !== 'agent');

        // Re-render dynamic parts
        if (currentVariant === 'single') {
          renderSingleBrandProperties();
          renderIndustryChips('single', null);
          renderAllToneChips('single', null);
        }
        if (currentVariant === 'portfolio') {
          renderBrandTree();
          renderBrandDetail();
          updateBrandFilesDashboard();
        }

        updatePreview();
      }

      // Identity fields for single brand mode
      let singleBrandIdentity = {
        description: '', industry: '', target_audience: '',
        tagline: '', tone: { voice: '', attributes: [], dos: [], donts: [] }, privacy_policy_url: '',
        logos: [],
        colors: { primary: '', secondary: '', accent: '', background: '', text: '' },
        fonts: { primary: '', secondary: '' }
      };

      // Root-level contact info
      let contactInfo = { name: '', email: '', domain: '' };

      // ============================================================================
      // Main Functions
      // ============================================================================

      async function fetchBrandJson(domain) {
        try {
          const response = await fetch(`https://${domain}/.well-known/brand.json`);
          if (!response.ok) return null;
          return await response.json();
        } catch {
          return null;
        }
      }

      async function resolveAndLoadBrandJson(domain) {
        let data = await fetchBrandJson(domain);
        if (!data) return null;

        let houseDomain = domain;

        // Follow redirect: if house is a string, it points to the real house domain
        if (typeof data.house === 'string') {
          houseDomain = data.house;
          data = await fetchBrandJson(houseDomain);
          if (!data) return null;
        }

        return { data, houseDomain, enteredDomain: domain };
      }

      function populateFromBrandJson(data, houseDomain, enteredDomain) {
        // Reset state
        brands = [];
        brandIdCounter = 0;
        singleBrandProperties = [];
        selectedBrandId = null;
        brandIdManuallyEdited = { single: false };
        singleBrandIdentity = {
          description: '', industry: '', target_audience: '',
          tagline: '', tone: { voice: '', attributes: [], dos: [], donts: [] }, privacy_policy_url: '',
          logos: [],
          colors: { primary: '', secondary: '', accent: '', background: '', text: '' },
          fonts: { primary: '', secondary: '' }
        };
        contactInfo = { name: '', email: '', domain: '' };

        currentVariant = 'portfolio';

        // Populate house fields
        if (typeof data.house === 'object') {
          document.getElementById('portfolio-house-domain').value = data.house.domain || houseDomain;
          document.getElementById('portfolio-house-name').value = data.house.name || '';
        } else {
          document.getElementById('portfolio-house-domain').value = houseDomain;
        }

        // Populate contact info
        if (data.contact) {
          contactInfo.name = data.contact.name || '';
          contactInfo.email = data.contact.email || '';
          contactInfo.domain = data.contact.domain || '';
          document.getElementById('contact-name').value = contactInfo.name;
          document.getElementById('contact-email').value = contactInfo.email;
          document.getElementById('contact-domain').value = contactInfo.domain;
        }

        // Populate brands
        if (data.brands && data.brands.length > 0) {
          data.brands.forEach(b => {
            const id = ++brandIdCounter;
            const primaryWebsite = (b.properties || []).find(p => p.primary && p.type === 'website');
            const otherProps = (b.properties || []).filter(p => !(p.primary && p.type === 'website'));

            brands.push({
              id,
              brand_id: b.id || '',
              name: (b.names && b.names[0]) ? (b.names[0].en || '') : '',
              domain: primaryWebsite ? primaryWebsite.identifier : '',
              keller_type: b.keller_type || 'master',
              parent_brand: b.parent_brand || '',
              properties: otherProps.map(p => ({ type: p.type, identifier: p.identifier, primary: false })),
              brandIdManuallyEdited: true,
              description: b.description || '',
              industry: b.industry || '',
              target_audience: b.target_audience || '',
              tagline: b.tagline || '',
              tone: typeof b.tone === 'object' && b.tone !== null
                ? { voice: b.tone.voice || '', attributes: b.tone.attributes || [], dos: b.tone.dos || [], donts: b.tone.donts || [] }
                : { voice: typeof b.tone === 'string' ? b.tone : '', attributes: [], dos: [], donts: [] },
              privacy_policy_url: b.privacy_policy_url || '',
              logos: (b.logos || []).map(l => ({
                url: l.url || '',
                tags: l.tags || [],
                width: l.width || null,
                height: l.height || null
              })),
              colors: {
                primary: (b.colors && b.colors.primary) || '',
                secondary: (b.colors && b.colors.secondary) || '',
                accent: (b.colors && b.colors.accent) || '',
                background: (b.colors && b.colors.background) || '',
                text: (b.colors && b.colors.text) || ''
              },
              fonts: {
                primary: (b.fonts && b.fonts.primary) || '',
                secondary: (b.fonts && b.fonts.secondary) || ''
              }
            });
          });

          // Select the brand matching the entered domain, or first brand
          const matchingBrand = brands.find(b => b.domain === enteredDomain);
          selectedBrandId = matchingBrand ? matchingBrand.id : brands[0].id;
        }

        // Show portfolio form, hide decision tree
        document.getElementById('decision-tree').classList.add('hidden');
        document.getElementById('form-single').classList.add('hidden');
        document.getElementById('form-portfolio').classList.remove('hidden');
        document.getElementById('form-redirect').classList.add('hidden');
        document.getElementById('form-agent').classList.add('hidden');

        // Show contact section and viewer link
        document.getElementById('contact-section').classList.remove('hidden');
        const viewLink = document.getElementById('view-brand-link');
        viewLink.href = '/brand/view/' + encodeURIComponent(houseDomain);
        viewLink.style.display = '';
        document.getElementById('next-steps-view-link').href = '/brand/view/' + encodeURIComponent(houseDomain);

        // Update deploy path
        document.getElementById('deploy-path').textContent = `https://${houseDomain}/.well-known/brand.json`;

        renderBrandTree();
        renderBrandDetail();
        updateBrandFilesDashboard();
        updatePreview();
      }

      async function startBuilding() {
        const domain = document.getElementById('domain-input').value.trim().toLowerCase();
        if (!domain) {
          alert('Please enter a domain name');
          return;
        }

        currentDomain = domain;
        const url = new URL(window.location);
        url.searchParams.set('domain', domain);
        window.history.replaceState({}, '', url);
        document.getElementById('domain-display').textContent = domain;
        document.getElementById('portfolio-house-domain').value = domain;

        const btn = document.getElementById('start-btn');
        btn.disabled = true;
        btn.textContent = 'Checking...';

        const validationResults = document.getElementById('validation-results');

        // Try to fetch existing brand.json from the domain
        const resolved = await resolveAndLoadBrandJson(domain);

        if (resolved) {
          const { data, houseDomain, enteredDomain } = resolved;
          const isRedirect = houseDomain !== enteredDomain;
          const brandCount = (data.brands || []).length;

          validationResults.innerHTML = `
            <div class="validation-result result-success">
              <strong>Found existing brand.json</strong><br>
              ${isRedirect
                ? `${escapeHtml(enteredDomain)} redirects to <strong>${escapeHtml(houseDomain)}</strong>. Loaded portfolio with ${brandCount} brand${brandCount !== 1 ? 's' : ''}.`
                : `Loaded portfolio from ${escapeHtml(houseDomain)} with ${brandCount} brand${brandCount !== 1 ? 's' : ''}.`
              }
            </div>
          `;
          validationResults.classList.remove('hidden');
          document.getElementById('file-status').textContent = 'Editing existing brand.json';

          btn.disabled = false;
          btn.textContent = 'Get Started';

          // Show builder and populate from loaded data
          document.getElementById('builder-form').classList.remove('hidden');
          updateRegistryButton();
          populateFromBrandJson(data, houseDomain, enteredDomain);
          return;
        }

        // No live brand.json on domain - check registry
        const registryResult = await loadFromRegistry(domain);
        if (registryResult && registryResult.data) {
          validationResults.innerHTML = `
            <div class="validation-result result-success">
              <strong>Found in registry</strong><br>
              Loaded brand data for ${escapeHtml(domain)} from the AgenticAdvertising.org registry.
            </div>
          `;
          validationResults.classList.remove('hidden');
          document.getElementById('file-status').textContent = 'Editing from registry';

          btn.disabled = false;
          btn.textContent = 'Get Started';

          document.getElementById('builder-form').classList.remove('hidden');
          updateRegistryButton();
          populateFromBrandJson(registryResult.data, registryResult.domain || domain, domain);
          return;
        }

        // No live or registry brand.json - check for saved draft
        btn.disabled = false;
        btn.textContent = 'Get Started';
        document.getElementById('builder-form').classList.remove('hidden');
        updateRegistryButton();

        const savedDraft = loadFromLocalStorage(domain);
        if (savedDraft && savedDraft.variant) {
          try {
            const savedDate = new Date(savedDraft.savedAt).toLocaleString();
            validationResults.innerHTML = `
              <div class="validation-result result-warning">
                <strong>No brand.json found</strong><br>
                Restored your previous draft for ${escapeHtml(domain)} (saved ${escapeHtml(savedDate)})
              </div>
            `;
            validationResults.classList.remove('hidden');
            document.getElementById('file-status').textContent = 'Restored from draft';
            restoreBuilderState(savedDraft);
            return;
          } catch (e) {
            console.warn('Failed to restore draft, starting fresh:', e);
          }
        }

        validationResults.innerHTML = `
          <div class="validation-result result-info">
            <strong>No existing brand.json</strong><br>
            Let's create one for ${escapeHtml(domain)}
          </div>
        `;
        validationResults.classList.remove('hidden');
        document.getElementById('file-status').textContent = 'Creating new brand.json';

        // Reset state
        brands = [];
        brandIdCounter = 0;
        singleBrandProperties = [];
        selectedBrandId = null;
        brandIdManuallyEdited = { single: false };
        singleBrandIdentity = {
          description: '', industry: '', target_audience: '',
          tagline: '', tone: { voice: '', attributes: [], dos: [], donts: [] }, privacy_policy_url: '',
          logos: [],
          colors: { primary: '', secondary: '', accent: '', background: '', text: '' },
          fonts: { primary: '', secondary: '' }
        };
        contactInfo = { name: '', email: '', domain: '' };

        // Reset contact form inputs
        document.getElementById('contact-name').value = '';
        document.getElementById('contact-email').value = '';
        document.getElementById('contact-domain').value = '';

        // Hide view brand link (no existing brand.json)
        document.getElementById('view-brand-link').style.display = 'none';

        // Pre-fill brand ID from domain for single brand
        const brandId = generateBrandIdFromText(currentDomain.split('.')[0]);
        document.getElementById('single-brand-id').value = brandId;

        // Reset decision tree to step 1 and populate domain hints
        showDecisionStep('step-brand-count');
        document.getElementById('single-domain-hint').textContent = currentDomain;
        document.getElementById('multi-domain-hint').textContent = currentDomain;

        // Hide all forms initially
        document.getElementById('form-single').classList.add('hidden');
        document.getElementById('form-portfolio').classList.add('hidden');
        document.getElementById('form-redirect').classList.add('hidden');
        document.getElementById('form-agent').classList.add('hidden');

        updatePreview();
        updateRegistryButton();
      }

      // ============================================================================
      // Decision Tree Functions
      // ============================================================================

      function showDecisionStep(stepId) {
        // Hide all steps
        document.querySelectorAll('.decision-step').forEach(step => {
          step.classList.add('hidden');
        });
        // Show the requested step
        const step = document.getElementById(stepId);
        if (step) {
          step.classList.remove('hidden');
          step.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        // Show the decision tree container
        document.getElementById('decision-tree').classList.remove('hidden');
      }

      function selectBrandCount(count) {
        if (count === 'single') {
          showDecisionStep('step-single-hosting');
        } else {
          showDecisionStep('step-multiple-domain');
        }
      }

      function goBackTo(stepId) {
        showDecisionStep(stepId);
      }

      function selectVariant(variant) {
        currentVariant = variant;

        // Hide decision tree, show selected form
        document.getElementById('decision-tree').classList.add('hidden');

        // Show/hide forms based on variant
        document.getElementById('form-single').classList.toggle('hidden', variant !== 'single');
        document.getElementById('form-portfolio').classList.toggle('hidden', variant !== 'portfolio');
        document.getElementById('form-redirect').classList.toggle('hidden', variant !== 'redirect');
        document.getElementById('form-agent').classList.toggle('hidden', variant !== 'agent');

        // Show contact section for single/portfolio
        const showContact = variant === 'single' || variant === 'portfolio';
        document.getElementById('contact-section').classList.toggle('hidden', !showContact);

        // Update viewer link href but keep it hidden for new brands
        // (only shown after successful verification or when editing existing)
        if (showContact && currentDomain) {
          document.getElementById('next-steps-view-link').href = '/brand/view/' + encodeURIComponent(currentDomain);
        }

        // Initialize portfolio with one brand if empty
        if (variant === 'portfolio' && brands.length === 0) {
          document.getElementById('portfolio-house-domain').value = currentDomain;
          addBrand(null); // Add first root brand
        }

        // Initialize single brand pickers
        if (variant === 'single') {
          renderSingleColors();
          renderSingleLogos();
          renderIndustryChips('single', null);
          renderAllToneChips('single', null);
        }

        // Update deploy path in next steps
        document.getElementById('deploy-path').textContent = `https://${currentDomain}/.well-known/brand.json`;

        // Clear any previous verification result
        document.getElementById('verify-result').innerHTML = '';

        updatePreview();

        // Scroll to the form
        const formElement = document.getElementById(`form-${variant}`);
        if (formElement) {
          setTimeout(() => {
            formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100);
        }
      }

      async function verifyDeployment() {
        const btn = document.getElementById('verify-btn');
        const resultDiv = document.getElementById('verify-result');

        btn.disabled = true;
        btn.textContent = 'Testing...';
        resultDiv.innerHTML = '<div class="verify-result pending">üîç Checking your domain...</div>';

        try {
          const response = await fetch(`/api/brands/resolve?domain=${encodeURIComponent(currentDomain)}`);
          const result = await response.json();

          if (response.ok && result.canonical_domain) {
            const houseDomain = escapeHtml(result.house_domain || currentDomain);
            const brandName = result.brand_name ? escapeHtml(result.brand_name) : '';
            const viewUrl = '/brand/view/' + encodeURIComponent(result.house_domain || currentDomain);
            resultDiv.innerHTML = `
              <div class="verify-result success">
                ‚úÖ <strong>Success!</strong> Your brand.json is live and valid.<br>
                <span style="font-size: 12px; opacity: 0.8;">
                  House: ${houseDomain}
                  ${brandName ? ` ‚Ä¢ ${brandName}` : ''}
                </span><br>
                <a href="${escapeHtml(viewUrl)}" target="_blank" class="btn btn-view-brand" style="margin-top: var(--space-2); display: inline-block; padding: var(--space-1) var(--space-3); font-size: var(--text-sm);">View in Brand Viewer</a>
              </div>
            `;
            // Also show the header view link
            const viewLink = document.getElementById('view-brand-link');
            viewLink.href = viewUrl;
            viewLink.style.display = '';
          } else if (result.file_status === 200) {
            resultDiv.innerHTML = `
              <div class="verify-result error">
                ‚ö†Ô∏è <strong>Found a file, but it doesn't match the AdCP brand.json format.</strong><br>
                <span style="font-size: var(--text-sm); opacity: 0.8;">
                  Your domain has a brand.json file, but it doesn't use one of the recognized variants
                  (house portfolio, house redirect, brand agent, or authoritative location).
                </span><br>
                <span style="font-size: var(--text-sm); margin-top: var(--space-1); display: inline-block;">
                  Use the Brand Builder to generate a compatible file, then re-upload.
                </span>
              </div>
            `;
          } else {
            resultDiv.innerHTML = `
              <div class="verify-result error">
                ‚ùå <strong>Not found yet.</strong> Make sure you've uploaded the file to:<br>
                <code style="background: white; padding: 2px 6px; border-radius: 3px; margin-top: 4px; display: inline-block;">
                  https://${escapeHtml(currentDomain)}/.well-known/brand.json
                </code>
              </div>
            `;
          }
        } catch (error) {
          resultDiv.innerHTML = `
            <div class="verify-result error">
              ‚ùå <strong>Error checking domain.</strong> Please try again later.
            </div>
          `;
        }

        btn.disabled = false;
        btn.textContent = 'Test My Domain';
      }

      // ============================================================================
      // Brand ID Auto-generation
      // ============================================================================

      function generateBrandIdFromText(text) {
        if (!text) return '';
        return text
          .toLowerCase()
          .replace(/[^a-z0-9\s_-]/g, '')
          .replace(/[\s-]+/g, '_')
          .replace(/^_+|_+$/g, '');
      }

      function autoGenerateBrandId(context) {
        if (context === 'single') {
          if (brandIdManuallyEdited.single) return;
          const name = document.getElementById('single-brand-name').value;
          const generatedId = generateBrandIdFromText(name);
          document.getElementById('single-brand-id').value = generatedId;
        }
      }

      function markBrandIdManuallyEdited(context) {
        if (context === 'single') {
          brandIdManuallyEdited.single = true;
        }
      }

      function autoGenerateBrandIdForBrand(brandId) {
        const brand = brands.find(b => b.id === brandId);
        if (!brand || brand.brandIdManuallyEdited) return;

        brand.brand_id = generateBrandIdFromText(brand.name);

        // Update brand_id input in-place to avoid re-rendering the detail panel
        const brandIdInput = document.querySelector('#brand-detail-content input[data-field="brand_id"]');
        if (brandIdInput) brandIdInput.value = brand.brand_id;
      }

      // ============================================================================
      // Single Brand Property Functions
      // ============================================================================

      function addSingleBrandProperty() {
        singleBrandProperties.push({ type: 'website', identifier: '', primary: singleBrandProperties.length === 0 });
        renderSingleBrandProperties();
        updatePreview();
      }

      function removeSingleBrandProperty(index) {
        singleBrandProperties.splice(index, 1);
        renderSingleBrandProperties();
        updatePreview();
      }

      function updateSingleBrandProperty(index, field, value) {
        if (field === 'primary') {
          value = value === 'true' || value === true;
        }
        singleBrandProperties[index][field] = value;
        updatePreview();
      }

      function renderSingleBrandProperties() {
        const container = document.getElementById('single-brand-properties');
        if (singleBrandProperties.length === 0) {
          container.innerHTML = `<div style="padding: var(--space-4); border: 1px dashed var(--color-border); border-radius: var(--radius-md); text-align: center;"><p style="color: var(--text-muted); font-size: var(--text-sm); margin: 0;">Add your website, app, or other digital properties where your brand appears</p></div>`;
          return;
        }

        container.innerHTML = singleBrandProperties.map((prop, i) => `
          <div class="property-entry">
            <select onchange="updateSingleBrandProperty(${i}, 'type', this.value)">
              <option value="website" ${prop.type === 'website' ? 'selected' : ''}>Website</option>
              <option value="mobile_app" ${prop.type === 'mobile_app' ? 'selected' : ''}>Mobile App</option>
              <option value="ctv_app" ${prop.type === 'ctv_app' ? 'selected' : ''}>CTV App</option>
              <option value="desktop_app" ${prop.type === 'desktop_app' ? 'selected' : ''}>Desktop App</option>
              <option value="dooh" ${prop.type === 'dooh' ? 'selected' : ''}>DOOH</option>
              <option value="podcast" ${prop.type === 'podcast' ? 'selected' : ''}>Podcast</option>
              <option value="radio" ${prop.type === 'radio' ? 'selected' : ''}>Radio</option>
              <option value="streaming_audio" ${prop.type === 'streaming_audio' ? 'selected' : ''}>Streaming Audio</option>
            </select>
            <input type="text" value="${escapeHtml(prop.identifier)}" placeholder="${prop.type === 'website' ? 'example.com' : 'com.example.app'}" oninput="updateSingleBrandProperty(${i}, 'identifier', this.value)" />
            <label style="display: flex; align-items: center; gap: var(--space-1); white-space: nowrap; font-size: var(--text-sm);">
              <input type="checkbox" ${prop.primary ? 'checked' : ''} onchange="updateSingleBrandProperty(${i}, 'primary', this.checked)" />
              Primary
            </label>
            <button class="btn btn-secondary" onclick="removeSingleBrandProperty(${i})" style="padding: var(--space-2) var(--space-3); font-size: var(--text-sm); min-width: 28px; min-height: 28px;">√ó</button>
          </div>
        `).join('');
      }

      // ============================================================================
      // Industry Chip Functions
      // ============================================================================

      const INDUSTRY_OPTIONS = [
        'Automotive', 'Beauty & Personal Care', 'Consumer Packaged Goods',
        'Education', 'Energy & Utilities', 'Entertainment & Media',
        'Fashion & Apparel', 'Financial Services', 'Food & Beverage',
        'Gaming', 'Healthcare & Pharma', 'Home & Garden',
        'Hospitality & Travel', 'Real Estate', 'Retail & E-Commerce',
        'Sports & Fitness', 'Technology', 'Telecommunications'
      ];

      function focusIndustryInput(scope) {
        const input = document.getElementById(`${scope}-industry-input`);
        if (input) input.focus();
      }

      function getIndustryValues(scope, brandId) {
        let raw = '';
        if (scope === 'single') {
          raw = singleBrandIdentity.industry || '';
        } else if (brandId != null) {
          const brand = brands.find(b => b.id === brandId);
          raw = brand ? (brand.industry || '') : '';
        }
        return raw.split(',').map(s => s.trim()).filter(Boolean);
      }

      function setIndustryValues(scope, values, brandId) {
        const joined = values.join(', ');
        if (scope === 'single') {
          singleBrandIdentity.industry = joined;
        } else if (brandId != null) {
          const brand = brands.find(b => b.id === brandId);
          if (brand) brand.industry = joined;
        }
        updatePreview();
      }

      function renderIndustryChips(scope, brandId) {
        const container = document.getElementById(`${scope}-industry-chips`);
        if (!container) return;
        const values = getIndustryValues(scope, brandId);
        container.innerHTML = values.map(v => `
          <span class="chip">
            ${escapeHtml(v)}
            <button class="chip-remove" onclick="event.stopPropagation(); removeIndustry('${scope}', '${escapeAttr(v)}', ${brandId != null ? brandId : 'null'})">&times;</button>
          </span>
        `).join('');
      }

      function showIndustryDropdown(scope, brandId) {
        filterIndustryDropdown(scope, '', brandId);
        const list = document.getElementById(`${scope}-industry-list`);
        if (list) list.classList.add('open');
      }

      function filterIndustryDropdown(scope, query, brandId) {
        const list = document.getElementById(`${scope}-industry-list`);
        if (!list) return;
        const current = getIndustryValues(scope, brandId);
        const q = query.toLowerCase();
        const filtered = INDUSTRY_OPTIONS.filter(opt =>
          !current.includes(opt) && opt.toLowerCase().includes(q)
        );
        list.innerHTML = filtered.map(opt => `
          <div class="dropdown-option" onmousedown="event.preventDefault(); selectIndustry('${scope}', '${escapeAttr(opt)}', ${brandId != null ? brandId : 'null'})">${escapeHtml(opt)}</div>
        `).join('');
        if (filtered.length > 0 || query) {
          list.classList.add('open');
        } else {
          list.classList.remove('open');
        }
      }

      function selectIndustry(scope, value, brandId) {
        const values = getIndustryValues(scope, brandId);
        if (!values.includes(value)) {
          values.push(value);
          setIndustryValues(scope, values, brandId);
        }
        renderIndustryChips(scope, brandId);
        const input = document.getElementById(`${scope}-industry-input`);
        if (input) { input.value = ''; input.focus(); }
        const list = document.getElementById(`${scope}-industry-list`);
        if (list) list.classList.remove('open');
      }

      function removeIndustry(scope, value, brandId) {
        const values = getIndustryValues(scope, brandId);
        const idx = values.indexOf(value);
        if (idx >= 0) {
          values.splice(idx, 1);
          setIndustryValues(scope, values, brandId);
        }
        renderIndustryChips(scope, brandId);
      }

      function handleIndustryKeydown(event, scope, brandId) {
        if (event.key === 'Enter') {
          event.preventDefault();
          const input = document.getElementById(`${scope}-industry-input`);
          const val = input.value.trim();
          if (val) {
            selectIndustry(scope, val, brandId);
          }
        } else if (event.key === 'Backspace' && !event.target.value) {
          const values = getIndustryValues(scope, brandId);
          if (values.length > 0) {
            values.pop();
            setIndustryValues(scope, values, brandId);
            renderIndustryChips(scope, brandId);
          }
        }
      }

      // Close dropdowns on outside click
      document.addEventListener('click', function(e) {
        document.querySelectorAll('.dropdown-list.open').forEach(list => {
          if (!list.parentElement.contains(e.target)) {
            list.classList.remove('open');
          }
        });
      });

      // ============================================================================
      // Tone Chip Functions
      // ============================================================================

      function updateSingleTone(field, value) {
        singleBrandIdentity.tone[field] = value;
        updatePreview();
      }

      function updateBrandTone(brandId, field, value) {
        const brand = brands.find(b => b.id === brandId);
        if (brand) {
          if (!brand.tone || typeof brand.tone !== 'object') {
            brand.tone = { voice: '', attributes: [], dos: [], donts: [] };
          }
          brand.tone[field] = value;
          updatePreview();
        }
      }

      function getToneArray(scope, field, brandId) {
        if (scope === 'single') {
          return singleBrandIdentity.tone[field] || [];
        }
        if (brandId != null) {
          const brand = brands.find(b => b.id === brandId);
          return brand && brand.tone ? (brand.tone[field] || []) : [];
        }
        return [];
      }

      function setToneArray(scope, field, values, brandId) {
        if (scope === 'single') {
          singleBrandIdentity.tone[field] = values;
        } else if (brandId != null) {
          const brand = brands.find(b => b.id === brandId);
          if (brand) {
            if (!brand.tone || typeof brand.tone !== 'object') {
              brand.tone = { voice: '', attributes: [], dos: [], donts: [] };
            }
            brand.tone[field] = values;
          }
        }
        updatePreview();
      }

      function renderToneChips(scope, field, brandId) {
        const container = document.getElementById(`${scope}-tone-${field}-chips`);
        if (!container) return;
        const values = getToneArray(scope, field, brandId);
        container.innerHTML = values.map((v, i) => `
          <span class="chip">
            ${escapeHtml(v)}
            <button class="chip-remove" onclick="event.stopPropagation(); removeToneChip('${scope}', '${field}', ${i}, ${brandId != null ? brandId : 'null'})">&times;</button>
          </span>
        `).join('');
      }

      function handleToneChipKeydown(event, scope, field, brandId) {
        if (event.key === 'Enter') {
          event.preventDefault();
          const input = event.target;
          const val = input.value.trim();
          if (val) {
            const values = getToneArray(scope, field, brandId);
            values.push(val);
            setToneArray(scope, field, values, brandId);
            renderToneChips(scope, field, brandId);
            input.value = '';
          }
        } else if (event.key === 'Backspace' && !event.target.value) {
          const values = getToneArray(scope, field, brandId);
          if (values.length > 0) {
            values.pop();
            setToneArray(scope, field, values, brandId);
            renderToneChips(scope, field, brandId);
          }
        }
      }

      function removeToneChip(scope, field, index, brandId) {
        const values = getToneArray(scope, field, brandId);
        values.splice(index, 1);
        setToneArray(scope, field, values, brandId);
        renderToneChips(scope, field, brandId);
      }

      function renderAllToneChips(scope, brandId) {
        ['attributes', 'dos', 'donts'].forEach(field => {
          renderToneChips(scope, field, brandId);
        });
      }

      // ============================================================================
      // Single Brand Identity Functions
      // ============================================================================

      function updateSingleIdentity(field, value) {
        singleBrandIdentity[field] = value;
        updatePreview();
      }

      function updateDescCharCount(value) {
        const el = document.getElementById('single-desc-char-count');
        if (el) el.textContent = `${(value || '').length} / 500 characters`;
      }

      function addSingleLogo() {
        singleBrandIdentity.logos.push({ url: '', tags: [], width: null, height: null });
        renderSingleLogos();
        updatePreview();
      }

      function removeSingleLogo(index) {
        singleBrandIdentity.logos.splice(index, 1);
        renderSingleLogos();
        updatePreview();
      }

      function updateSingleLogo(index, field, value) {
        if (field === 'tags') {
          singleBrandIdentity.logos[index].tags = value.split(',').map(t => t.trim()).filter(Boolean);
        } else if (field === 'width' || field === 'height') {
          singleBrandIdentity.logos[index][field] = value ? parseInt(value) : null;
        } else {
          singleBrandIdentity.logos[index][field] = value;
        }
        updatePreview();
      }

      function renderSingleLogos() {
        const container = document.getElementById('single-logos-container');
        if (singleBrandIdentity.logos.length === 0) {
          container.innerHTML = '<div style="padding: var(--space-3); border: 1px dashed var(--color-border); border-radius: var(--radius-md); text-align: center; margin-bottom: var(--space-4);"><p style="color: var(--text-muted); font-size: var(--text-sm); margin: 0;">No logos yet. Add a URL to your brand logo.</p></div>';
          return;
        }
        container.innerHTML = singleBrandIdentity.logos.map((logo, i) => `
          <div class="logo-entry">
            <div class="logo-entry-row">
              ${logo.url ? `<img src="${escapeHtml(logo.url)}" style="width: 40px; height: 40px; object-fit: contain; border: 1px solid var(--color-border); border-radius: var(--radius-sm); background: var(--color-bg-subtle); flex-shrink: 0;" onerror="this.style.display='none'" />` : ''}
              <input type="url" value="${escapeHtml(logo.url)}" placeholder="https://example.com/logo.svg" oninput="updateSingleLogo(${i}, 'url', this.value)" onblur="renderSingleLogos()" />
              <button class="btn btn-secondary" onclick="removeSingleLogo(${i})" style="padding: var(--space-2) var(--space-3); font-size: var(--text-sm); min-width: 28px; min-height: 28px;">√ó</button>
            </div>
            <div class="logo-entry-row">
              <input type="text" value="${escapeHtml((logo.tags || []).join(', '))}" placeholder="Tags: icon, dark-bg, square" oninput="updateSingleLogo(${i}, 'tags', this.value)" style="flex: 1;" />
              <input type="number" value="${logo.width || ''}" placeholder="W" oninput="updateSingleLogo(${i}, 'width', this.value)" />
              <input type="number" value="${logo.height || ''}" placeholder="H" oninput="updateSingleLogo(${i}, 'height', this.value)" />
            </div>
          </div>
        `).join('') + '<div style="margin-bottom: var(--space-4);"></div>';
      }

      // Helper: normalize color value to array
      function colorToArray(val) {
        if (Array.isArray(val)) return val.length > 0 ? val : [''];
        if (val && typeof val === 'string') return [val];
        return [''];
      }

      function updateSingleColorAt(colorName, index, value, source) {
        const arr = colorToArray(singleBrandIdentity.colors[colorName]);
        arr[index] = value;
        singleBrandIdentity.colors[colorName] = arr.length === 1 ? arr[0] : arr;
        // Sync the other input
        if (source === 'picker') {
          const textInput = document.getElementById(`single-color-text-${colorName}-${index}`);
          if (textInput) textInput.value = value;
        } else if (source === 'text' && /^#[0-9A-Fa-f]{6}$/.test(value)) {
          const picker = document.getElementById(`single-color-picker-${colorName}-${index}`);
          if (picker) picker.value = value;
        }
        updatePreview();
      }

      function addSingleColor(colorName) {
        const arr = colorToArray(singleBrandIdentity.colors[colorName]);
        arr.push('');
        singleBrandIdentity.colors[colorName] = arr;
        renderSingleColors();
        updatePreview();
      }

      function removeSingleColorAt(colorName, index) {
        const arr = colorToArray(singleBrandIdentity.colors[colorName]);
        arr.splice(index, 1);
        singleBrandIdentity.colors[colorName] = arr.length === 1 ? arr[0] : arr;
        renderSingleColors();
        updatePreview();
      }

      function updateSingleFont(role, value) {
        singleBrandIdentity.fonts[role] = value;
        updatePreview();
      }

      function renderSingleColors() {
        const container = document.getElementById('single-colors-container');
        const colorNames = ['primary', 'secondary', 'accent', 'background', 'text'];
        container.innerHTML = colorNames.map(name => {
          const values = colorToArray(singleBrandIdentity.colors[name]);
          return `
            <div class="color-row">
              <span class="color-label">${name}</span>
              <div style="flex: 1;">
                ${values.map((hex, i) => `
                  <div class="color-picker-wrapper" style="${i > 0 ? 'margin-top: var(--space-1);' : ''}">
                    <input type="color" id="single-color-picker-${name}-${i}" value="${escapeAttr(hex || '#000000')}" oninput="updateSingleColorAt('${name}', ${i}, this.value, 'picker')" />
                    <input type="text" id="single-color-text-${name}-${i}" value="${escapeAttr(hex)}" placeholder="#000000" oninput="updateSingleColorAt('${name}', ${i}, this.value, 'text')" />
                    ${values.length > 1 ? `<button class="chip-remove" onclick="removeSingleColorAt('${name}', ${i})" style="font-size: 14px;">&times;</button>` : ''}
                  </div>
                `).join('')}
                <button class="btn btn-secondary" onclick="addSingleColor('${name}')" style="padding: 2px var(--space-2); font-size: var(--text-xs); margin-top: var(--space-1);">+</button>
              </div>
            </div>
          `;
        }).join('');
      }

      // Serialize colors for JSON output: single-element arrays ‚Üí string, multi ‚Üí array, empty ‚Üí omit
      function serializeColors(colors) {
        const result = {};
        for (const [key, val] of Object.entries(colors)) {
          if (Array.isArray(val)) {
            const filtered = val.filter(v => v && /^#[0-9A-Fa-f]{6}$/i.test(v));
            if (filtered.length === 1) result[key] = filtered[0];
            else if (filtered.length > 1) result[key] = filtered;
          } else if (val && /^#[0-9A-Fa-f]{6}$/i.test(val)) {
            result[key] = val;
          }
        }
        return Object.keys(result).length > 0 ? result : null;
      }

      // ============================================================================
      // Contact Functions
      // ============================================================================

      function updateContact(field, value) {
        contactInfo[field] = value;
        updatePreview();
      }

      // ============================================================================
      // Portfolio Brand Identity Functions
      // ============================================================================

      function updateBrandIdentity(brandId, field, value) {
        const brand = brands.find(b => b.id === brandId);
        if (brand) {
          brand[field] = value;
          updatePreview();
        }
      }

      function addBrandLogo(brandId) {
        const brand = brands.find(b => b.id === brandId);
        if (brand) {
          brand.logos.push({ url: '', tags: [], width: null, height: null });
          renderBrandDetail();
          updatePreview();
        }
      }

      function removeBrandLogo(brandId, index) {
        const brand = brands.find(b => b.id === brandId);
        if (brand) {
          brand.logos.splice(index, 1);
          renderBrandDetail();
          updatePreview();
        }
      }

      function updateBrandLogo(brandId, index, field, value) {
        const brand = brands.find(b => b.id === brandId);
        if (!brand || !brand.logos[index]) return;
        if (field === 'tags') {
          brand.logos[index].tags = value.split(',').map(t => t.trim()).filter(Boolean);
        } else if (field === 'width' || field === 'height') {
          brand.logos[index][field] = value ? parseInt(value) : null;
        } else {
          brand.logos[index][field] = value;
        }
        updatePreview();
      }

      function updateBrandColorAt(brandId, colorName, index, value, source) {
        const brand = brands.find(b => b.id === brandId);
        if (!brand) return;
        const arr = colorToArray(brand.colors[colorName]);
        arr[index] = value;
        brand.colors[colorName] = arr.length === 1 ? arr[0] : arr;
        if (source === 'picker') {
          const textInput = document.getElementById(`brand-color-text-${colorName}-${index}`);
          if (textInput) textInput.value = value;
        } else if (source === 'text' && /^#[0-9A-Fa-f]{6}$/.test(value)) {
          const picker = document.getElementById(`brand-color-picker-${colorName}-${index}`);
          if (picker) picker.value = value;
        }
        updatePreview();
      }

      function addBrandColor(brandId, colorName) {
        const brand = brands.find(b => b.id === brandId);
        if (!brand) return;
        const arr = colorToArray(brand.colors[colorName]);
        arr.push('');
        brand.colors[colorName] = arr;
        renderBrandDetail();
        updatePreview();
      }

      function removeBrandColorAt(brandId, colorName, index) {
        const brand = brands.find(b => b.id === brandId);
        if (!brand) return;
        const arr = colorToArray(brand.colors[colorName]);
        arr.splice(index, 1);
        brand.colors[colorName] = arr.length === 1 ? arr[0] : arr;
        renderBrandDetail();
        updatePreview();
      }

      function updateBrandFont(brandId, role, value) {
        const brand = brands.find(b => b.id === brandId);
        if (brand) {
          brand.fonts[role] = value;
          updatePreview();
        }
      }

      // ============================================================================
      // Portfolio Brand Management
      // ============================================================================

      function addBrand(parentBrandId) {
        const brandId = ++brandIdCounter;
        const newBrand = {
          id: brandId,
          brand_id: '',
          name: '',
          domain: '',
          keller_type: parentBrandId ? 'sub_brand' : 'master',
          parent_brand: parentBrandId || '',
          properties: [],
          brandIdManuallyEdited: false,
          description: '', industry: '', target_audience: '',
          tagline: '', tone: { voice: '', attributes: [], dos: [], donts: [] }, privacy_policy_url: '',
          logos: [],
          colors: { primary: '', secondary: '', accent: '', background: '', text: '' },
          fonts: { primary: '', secondary: '' }
        };
        brands.push(newBrand);

        // Auto-select the new brand
        selectedBrandId = brandId;

        renderBrandTree();
        renderBrandDetail();
        updateBrandFilesDashboard();
        updatePreview();
      }

      function removeBrand(brandId) {
        const brand = brands.find(b => b.id === brandId);
        if (!brand) return;

        // Find children BEFORE clearing references
        const childrenIds = brand.brand_id
          ? brands.filter(b => b.parent_brand === brand.brand_id).map(b => b.id)
          : [];

        // Remove all children recursively
        childrenIds.forEach(id => removeBrand(id));

        brands = brands.filter(b => b.id !== brandId);

        // Deselect if this was selected
        if (selectedBrandId === brandId) {
          selectedBrandId = null;
        }

        renderBrandTree();
        renderBrandDetail();
        updateBrandFilesDashboard();
        updatePreview();
      }

      function selectBrand(brandId) {
        selectedBrandId = brandId;
        renderBrandTree(); // Re-render to update selected state
        renderBrandDetail();
      }

      function updateBrand(brandId, field, value) {
        const brand = brands.find(b => b.id === brandId);
        if (!brand) return;

        brand[field] = value;

        // Auto-generate brand_id from name if not manually edited
        if (field === 'name') {
          autoGenerateBrandIdForBrand(brandId);
          renderBrandTree();
          // Update detail header in-place
          const header = document.querySelector('#brand-detail-content .brand-detail-header h4');
          if (header) header.textContent = brand.name || brand.brand_id || 'Untitled Brand';
        }

        if (field === 'brand_id') {
          brand.brandIdManuallyEdited = true;
          renderBrandTree();
          // Update detail header in-place
          const header = document.querySelector('#brand-detail-content .brand-detail-header h4');
          if (header) header.textContent = brand.name || brand.brand_id || 'Untitled Brand';
        }

        // Re-render full detail panel only for structural changes (dropdowns don't lose focus)
        if (field === 'keller_type' || field === 'parent_brand') {
          renderBrandTree();
          renderBrandDetail();
        }

        updateBrandFilesDashboard();
        updatePreview();
      }

      function addProperty(brandId) {
        const brand = brands.find(b => b.id === brandId);
        if (brand) {
          brand.properties.push({ type: 'website', identifier: '', primary: false });
          renderBrandDetail();
          updatePreview();
        }
      }

      function removeProperty(brandId, propIndex) {
        const brand = brands.find(b => b.id === brandId);
        if (brand) {
          brand.properties.splice(propIndex, 1);
          renderBrandDetail();
          updatePreview();
        }
      }

      function updateProperty(brandId, propIndex, field, value) {
        const brand = brands.find(b => b.id === brandId);
        if (brand && brand.properties[propIndex]) {
          if (field === 'primary') {
            value = value === 'true' || value === true;
          }
          brand.properties[propIndex][field] = value;
          updatePreview();
        }
      }

      // ============================================================================
      // Brand Tree Rendering
      // ============================================================================

      function buildBrandTree(brands) {
        const roots = brands.filter(b => !b.parent_brand);
        const childrenOf = (parentId) => brands.filter(b => b.parent_brand === parentId);
        const result = [];
        const visited = new Set();

        function walk(brand, depth) {
          if (visited.has(brand.id)) return; // Prevent circular references
          visited.add(brand.id);
          result.push({ brand, depth });
          if (brand.brand_id) {
            childrenOf(brand.brand_id).forEach(child => walk(child, depth + 1));
          }
        }

        roots.forEach(r => walk(r, 0));

        // Append orphans (parent_brand set but parent not found, or part of a cycle)
        brands.filter(b => !visited.has(b.id)).forEach(b => result.push({ brand: b, depth: 0 }));

        return result;
      }

      function renderBrandTree() {
        const container = document.getElementById('brand-tree-container');

        if (brands.length === 0) {
          container.innerHTML = '<p style="color: var(--text-muted); font-size: var(--text-sm); text-align: center;">No brands yet</p>';
          return;
        }

        const tree = buildBrandTree(brands);

        function renderNode(item) {
          const { brand, depth } = item;
          const isSelected = selectedBrandId === brand.id;
          const displayName = brand.name || brand.brand_id || 'Untitled';
          const kellerType = brand.keller_type || 'master';
          const kellerLabels = {
            master: 'Core',
            sub_brand: 'Sub',
            endorsed: 'Endorsed',
            independent: 'Independent'
          };

          return `
            <div class="brand-tree-node ${isSelected ? 'selected' : ''}" onclick="selectBrand(${brand.id})" style="margin-left: ${depth * 24}px;">
              <span class="expand-icon">${depth > 0 ? '‚îî' : ''}</span>
              <span class="brand-name">${escapeHtml(displayName)}</span>
              <span class="keller-badge ${kellerType}">${kellerLabels[kellerType]}</span>
              <button class="add-child-btn" onclick="event.stopPropagation(); addBrand('${escapeAttr(brand.brand_id)}')" ${!brand.brand_id ? 'disabled' : ''} title="Add child brand">+</button>
            </div>
          `;
        }

        container.innerHTML = tree.map(renderNode).join('');
      }

      // ============================================================================
      // Brand Detail Editor Rendering
      // ============================================================================

      function renderBrandDetail() {
        const container = document.getElementById('brand-detail-content');

        if (!selectedBrandId) {
          container.innerHTML = '<div class="brand-detail-empty"><p>Select a brand from the tree to edit its details</p></div>';
          container.className = 'brand-detail-empty';
          return;
        }

        const brand = brands.find(b => b.id === selectedBrandId);
        if (!brand) {
          container.innerHTML = '<div class="brand-detail-empty"><p>Brand not found</p></div>';
          container.className = 'brand-detail-empty';
          return;
        }

        const kellerType = brand.keller_type || 'master';
        const parentOptions = brands
          .filter(b => b.brand_id && b.brand_id !== brand.brand_id && b.id !== brand.id)
          .map(b => ({ id: b.brand_id, name: b.name || b.brand_id }));

        container.className = '';
        container.innerHTML = `
          <div class="brand-detail-header">
            <h4>${escapeHtml(brand.name || brand.brand_id || 'Untitled Brand')}</h4>
            <button class="btn btn-secondary" onclick="removeBrand(${brand.id})" style="padding: var(--space-2) var(--space-3); font-size: var(--text-xs);">Remove</button>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); margin-bottom: var(--space-4);">
            <div class="form-group" style="margin-bottom: 0;">
              <label>Brand name</label>
              <input type="text" data-field="name" value="${escapeHtml(brand.name)}" placeholder="Nike" oninput="updateBrand(${brand.id}, 'name', this.value)" />
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label>Brand ID</label>
              <input type="text" data-field="brand_id" value="${escapeHtml(brand.brand_id)}" placeholder="nike" oninput="updateBrand(${brand.id}, 'brand_id', this.value)" />
              <p class="hint">Auto-generated from name</p>
            </div>
          </div>

          <div class="form-group">
            <label>Primary website</label>
            <input type="text" value="${escapeHtml(brand.domain || '')}" placeholder="nike.com" oninput="updateBrand(${brand.id}, 'domain', this.value)" />
            <p class="hint">Added as primary property; a redirect file will be needed here</p>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); margin-bottom: var(--space-4);">
            <div class="form-group" style="margin-bottom: 0;">
              <label>Type</label>
              <select onchange="updateBrand(${brand.id}, 'keller_type', this.value)">
                <option value="master" ${kellerType === 'master' ? 'selected' : ''}>Core Brand</option>
                <option value="sub_brand" ${kellerType === 'sub_brand' ? 'selected' : ''}>Division / Sub-brand</option>
                <option value="endorsed" ${kellerType === 'endorsed' ? 'selected' : ''}>Standalone Brand</option>
                <option value="independent" ${kellerType === 'independent' ? 'selected' : ''}>Separate Brand</option>
              </select>
              <p class="hint">
                ${kellerType === 'master' ? 'The main brand of the company' : ''}
                ${kellerType === 'sub_brand' ? 'A division or product line' : ''}
                ${kellerType === 'endorsed' ? 'Its own brand backed by the parent' : ''}
                ${kellerType === 'independent' ? 'Operates independently' : ''}
              </p>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label>Parent brand</label>
              <select onchange="updateBrand(${brand.id}, 'parent_brand', this.value)">
                <option value="">None (root brand)</option>
                ${parentOptions.map(p => `<option value="${escapeAttr(p.id)}" ${brand.parent_brand === p.id ? 'selected' : ''}>${escapeHtml(p.name)}</option>`).join('')}
              </select>
            </div>
          </div>

          <div>
            <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2); font-size: var(--text-sm); font-weight: var(--font-medium);">
              Additional properties (apps, other sites)
              <button class="btn" onclick="addProperty(${brand.id})" style="padding: var(--space-1) var(--space-2); font-size: var(--text-xs);">+ Add</button>
            </label>
            <div>
              ${brand.properties.length === 0 ? `
                <p style="color: var(--text-muted); font-size: var(--text-sm); margin: 0;">No properties yet</p>
              ` : brand.properties.map((prop, i) => `
                <div class="property-entry">
                  <select onchange="updateProperty(${brand.id}, ${i}, 'type', this.value)">
                    <option value="website" ${prop.type === 'website' ? 'selected' : ''}>Website</option>
                    <option value="mobile_app" ${prop.type === 'mobile_app' ? 'selected' : ''}>Mobile App</option>
                    <option value="ctv_app" ${prop.type === 'ctv_app' ? 'selected' : ''}>CTV App</option>
                    <option value="desktop_app" ${prop.type === 'desktop_app' ? 'selected' : ''}>Desktop App</option>
                    <option value="dooh" ${prop.type === 'dooh' ? 'selected' : ''}>DOOH</option>
                    <option value="podcast" ${prop.type === 'podcast' ? 'selected' : ''}>Podcast</option>
                  </select>
                  <input type="text" value="${escapeHtml(prop.identifier)}" placeholder="${prop.type === 'website' ? 'example.com' : 'com.example.app'}" oninput="updateProperty(${brand.id}, ${i}, 'identifier', this.value)" />
                  <button class="btn btn-secondary" onclick="removeProperty(${brand.id}, ${i})" style="padding: var(--space-1) var(--space-2); font-size: var(--text-xs);">√ó</button>
                </div>
              `).join('')}
            </div>
          </div>

          <details class="brand-section-toggle" style="margin-top: var(--space-5);">
            <summary>Brand identity</summary>
            <div class="brand-section-content">
              <div class="form-group">
                <label>Brand description</label>
                <textarea rows="2" placeholder="Describe your brand, e.g. A wholesome snack brand focused on fresh, natural ingredients" oninput="updateBrandIdentity(${brand.id}, 'description', this.value)">${escapeHtml(brand.description || '')}</textarea>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); margin-bottom: var(--space-4);">
                <div class="form-group" style="margin-bottom: 0;">
                  <label>Brand tagline</label>
                  <input type="text" value="${escapeHtml(brand.tagline || '')}" placeholder="Real food. Real Happiness." oninput="updateBrandIdentity(${brand.id}, 'tagline', this.value)" />
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label>Brand voice</label>
                  <input type="text" value="${escapeHtml((brand.tone && brand.tone.voice) || '')}" placeholder="Describe your brand's overall personality and tone (e.g. Professional, Trustworthy, Friendly, Approachable)" oninput="updateBrandTone(${brand.id}, 'voice', this.value)" />
                </div>
              </div>
              <div class="form-group" style="margin-bottom: var(--space-4);">
                <label>Voice characteristics</label>
                <div class="chip-container" id="brand-${brand.id}-tone-attributes-container" onclick="document.getElementById('brand-${brand.id}-tone-attributes-input').focus()">
                  <span id="brand-${brand.id}-tone-attributes-chips"></span>
                  <input type="text" class="chip-input" id="brand-${brand.id}-tone-attributes-input"
                    placeholder="e.g. Confident, Innovative, Bold, Clear"
                    onkeydown="handleToneChipKeydown(event, 'brand-${brand.id}', 'attributes', ${brand.id})" />
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); margin-bottom: var(--space-4);">
                <div class="form-group" style="margin-bottom: 0;">
                  <label>On-brand communication</label>
                  <div class="chip-container" id="brand-${brand.id}-tone-dos-container" onclick="document.getElementById('brand-${brand.id}-tone-dos-input').focus()">
                    <span id="brand-${brand.id}-tone-dos-chips"></span>
                    <input type="text" class="chip-input" id="brand-${brand.id}-tone-dos-input"
                      placeholder="e.g. Made with real ingredients, Fresh from the farm, Snack happy"
                      onkeydown="handleToneChipKeydown(event, 'brand-${brand.id}', 'dos', ${brand.id})" />
                  </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label>Off-brand communication</label>
                  <div class="chip-container" id="brand-${brand.id}-tone-donts-container" onclick="document.getElementById('brand-${brand.id}-tone-donts-input').focus()">
                    <span id="brand-${brand.id}-tone-donts-chips"></span>
                    <input type="text" class="chip-input" id="brand-${brand.id}-tone-donts-input"
                      placeholder="e.g. Ultimate super-snack, Miracle ingredients, Peak vitality snack, Soul-nourishing"
                      onkeydown="handleToneChipKeydown(event, 'brand-${brand.id}', 'donts', ${brand.id})" />
                  </div>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); margin-bottom: var(--space-4);">
                <div class="form-group" style="margin-bottom: 0;">
                  <label>Industry</label>
                  <div class="dropdown-wrapper" id="brand-${brand.id}-industry-wrapper">
                    <div class="chip-container" onclick="focusIndustryInput('brand-${brand.id}')">
                      <span id="brand-${brand.id}-industry-chips"></span>
                      <input type="text" class="chip-input" id="brand-${brand.id}-industry-input"
                        placeholder="e.g. Food &amp; Beverage, Beauty &amp; Cosmetics"
                        onfocus="showIndustryDropdown('brand-${brand.id}', ${brand.id})"
                        oninput="filterIndustryDropdown('brand-${brand.id}', this.value, ${brand.id})"
                        onkeydown="handleIndustryKeydown(event, 'brand-${brand.id}', ${brand.id})" />
                    </div>
                    <div class="dropdown-list" id="brand-${brand.id}-industry-list"></div>
                  </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label>Target audience</label>
                  <input type="text" value="${escapeHtml(brand.target_audience || '')}" placeholder="e.g. Health-conscious parents, Young urban professionals, Skincare enthusiasts" oninput="updateBrandIdentity(${brand.id}, 'target_audience', this.value)" />
                </div>
              </div>
              <div class="form-group">
                <label>Privacy policy URL</label>
                <input type="url" value="${escapeHtml(brand.privacy_policy_url || '')}" placeholder="e.g. https://example.com/privacy" oninput="updateBrandIdentity(${brand.id}, 'privacy_policy_url', this.value)" />
              </div>
            </div>
          </details>

          <details class="brand-section-toggle">
            <summary>Creative assets</summary>
            <div class="brand-section-content">
              <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2); font-size: var(--text-sm); font-weight: var(--font-medium);">
                Logos
                <button class="btn" onclick="addBrandLogo(${brand.id})" style="padding: var(--space-1) var(--space-2); font-size: var(--text-xs);">+ Add</button>
              </label>
              <div style="margin-bottom: var(--space-4);">
                ${brand.logos.length === 0 ? `
                  <p style="color: var(--text-muted); font-size: var(--text-sm); margin: 0;">No logos yet</p>
                ` : brand.logos.map((logo, i) => `
                  <div class="logo-entry">
                    <div class="logo-entry-row">
                      <input type="url" value="${escapeHtml(logo.url)}" placeholder="https://example.com/logo.svg" oninput="updateBrandLogo(${brand.id}, ${i}, 'url', this.value)" />
                      <button class="btn btn-secondary" onclick="removeBrandLogo(${brand.id}, ${i})" style="padding: var(--space-1) var(--space-2); font-size: var(--text-xs);">√ó</button>
                    </div>
                    <div class="logo-entry-row">
                      <input type="text" value="${escapeHtml((logo.tags || []).join(', '))}" placeholder="Tags: icon, dark-bg, square" oninput="updateBrandLogo(${brand.id}, ${i}, 'tags', this.value)" style="flex: 1;" />
                      <input type="number" value="${logo.width || ''}" placeholder="W" oninput="updateBrandLogo(${brand.id}, ${i}, 'width', this.value)" />
                      <input type="number" value="${logo.height || ''}" placeholder="H" oninput="updateBrandLogo(${brand.id}, ${i}, 'height', this.value)" />
                    </div>
                  </div>
                `).join('')}
              </div>

              <label style="display: block; margin-bottom: var(--space-2); font-size: var(--text-sm); font-weight: var(--font-medium);">Colors</label>
              <div style="margin-bottom: var(--space-4);">
                ${['primary', 'secondary', 'accent', 'background', 'text'].map(name => {
                  const values = colorToArray(brand.colors[name]);
                  return `
                    <div class="color-row">
                      <span class="color-label">${name}</span>
                      <div style="flex: 1;">
                        ${values.map((hex, i) => `
                          <div class="color-picker-wrapper" style="${i > 0 ? 'margin-top: var(--space-1);' : ''}">
                            <input type="color" id="brand-color-picker-${name}-${i}" value="${escapeAttr(hex || '#000000')}" oninput="updateBrandColorAt(${brand.id}, '${name}', ${i}, this.value, 'picker')" />
                            <input type="text" id="brand-color-text-${name}-${i}" value="${escapeAttr(hex || '')}" placeholder="#000000" oninput="updateBrandColorAt(${brand.id}, '${name}', ${i}, this.value, 'text')" />
                            ${values.length > 1 ? `<button class="chip-remove" onclick="removeBrandColorAt(${brand.id}, '${name}', ${i})" style="font-size: 14px;">&times;</button>` : ''}
                          </div>
                        `).join('')}
                        <button class="btn btn-secondary" onclick="addBrandColor(${brand.id}, '${name}')" style="padding: 2px var(--space-2); font-size: var(--text-xs); margin-top: var(--space-1);">+</button>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>

              <label style="display: block; margin-bottom: var(--space-2); font-size: var(--text-sm); font-weight: var(--font-medium);">Fonts</label>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                <div class="form-group" style="margin-bottom: 0;">
                  <input type="text" value="${escapeHtml(brand.fonts.primary || '')}" placeholder="Primary font family" oninput="updateBrandFont(${brand.id}, 'primary', this.value)" />
                  <p class="hint">Primary</p>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <input type="text" value="${escapeHtml(brand.fonts.secondary || '')}" placeholder="Secondary font family" oninput="updateBrandFont(${brand.id}, 'secondary', this.value)" />
                  <p class="hint">Secondary</p>
                </div>
              </div>
            </div>
          </details>
        `;

        // Render chips after DOM update
        renderIndustryChips(`brand-${brand.id}`, brand.id);
        renderAllToneChips(`brand-${brand.id}`, brand.id);
      }

      // ============================================================================
      // Brand Files Dashboard
      // ============================================================================

      function updateBrandFilesDashboard() {
        const dashboard = document.getElementById('brand-files-dashboard');
        const list = document.getElementById('brand-files-list');
        const houseDomain = document.getElementById('portfolio-house-domain').value.trim();

        if (!houseDomain) {
          dashboard.classList.add('hidden');
          return;
        }

        // Get all brand domains that need redirects
        const brandDomains = brands
          .filter(b => b.domain && b.domain !== houseDomain)
          .map(b => b.domain);

        const files = [];

        // House domain file (always present)
        files.push({
          path: `${houseDomain}/.well-known/brand.json`,
          type: 'house',
          domain: houseDomain
        });

        // Brand redirect files
        brandDomains.forEach(domain => {
          files.push({
            path: `${domain}/.well-known/brand.json`,
            type: 'redirect',
            domain: domain
          });
        });

        if (files.length === 0) {
          dashboard.classList.add('hidden');
          return;
        }

        dashboard.classList.remove('hidden');
        list.innerHTML = files.map(file => `
          <div class="file-row">
            <span class="file-type">${file.type}</span>
            <span class="file-path">${file.path}</span>
            <span class="status-indicator" id="status-${escapeHtml(file.domain).replace(/\./g, '-')}"></span>
            <button class="btn btn-secondary" onclick="copyFileJson('${escapeAttr(file.type)}', '${escapeAttr(file.domain)}')" style="padding: var(--space-1) var(--space-3); font-size: var(--text-xs);">Copy JSON</button>
            <button class="btn" onclick="validateFile('${escapeAttr(file.domain)}')" style="padding: var(--space-1) var(--space-3); font-size: var(--text-xs);">Validate</button>
          </div>
        `).join('');
      }

      async function validateFile(domain) {
        const statusId = `status-${domain.replace(/\./g, '-')}`;
        const indicator = document.getElementById(statusId);

        if (!indicator) return;

        indicator.className = 'status-indicator checking';

        try {
          const response = await fetch(`/api/brands/resolve?domain=${encodeURIComponent(domain)}`);
          const result = await response.json();

          if (response.ok && result.canonical_domain) {
            indicator.className = 'status-indicator valid';
            indicator.title = 'File found and valid';
          } else {
            indicator.className = 'status-indicator missing';
            indicator.title = result.error || 'File not found or invalid';
          }
        } catch (error) {
          indicator.className = 'status-indicator missing';
          indicator.title = 'Error checking file';
        }
      }

      async function validateAllFiles() {
        const houseDomain = document.getElementById('portfolio-house-domain').value.trim();
        const brandDomains = brands
          .filter(b => b.domain && b.domain !== houseDomain)
          .map(b => b.domain);

        const allDomains = [houseDomain, ...brandDomains];

        for (const domain of allDomains) {
          await validateFile(domain);
        }
      }

      function copyFileJson(type, domain) {
        let json;

        if (type === 'house') {
          json = generateJson();
        } else {
          const houseDomain = document.getElementById('portfolio-house-domain').value.trim();
          json = {
            "$schema": "https://adcontextprotocol.org/schemas/latest/brand.json",
            "house": houseDomain
          };
        }

        navigator.clipboard.writeText(JSON.stringify(json, null, 2))
          .then(() => alert(`Copied JSON for ${domain}!`))
          .catch(() => alert('Failed to copy'));
      }

      // ============================================================================
      // JSON Generation
      // ============================================================================

      function generateJson() {
        const json = {
          "$schema": "https://adcontextprotocol.org/schemas/latest/brand.json"
        };

        switch (currentVariant) {
          case 'single':
            // Single brand - simplest case
            json.version = "1.0";

            const singleBrandId = document.getElementById('single-brand-id').value.trim();
            const singleBrandName = document.getElementById('single-brand-name').value.trim();

            json.house = {
              domain: currentDomain,
              name: singleBrandName || currentDomain,
              architecture: "branded_house"
            };

            const singleBrandObj = {
              id: singleBrandId || 'unnamed',
              names: singleBrandName ? [{ en: singleBrandName }] : [],
              keller_type: 'master'
            };

            // Add identity text fields
            const identityTextFields = ['description', 'industry', 'target_audience', 'tagline', 'privacy_policy_url'];
            identityTextFields.forEach(f => {
              if (singleBrandIdentity[f]) singleBrandObj[f] = singleBrandIdentity[f];
            });

            // Add structured tone
            const tone = singleBrandIdentity.tone;
            if (tone && (tone.voice || (tone.attributes && tone.attributes.length) || (tone.dos && tone.dos.length) || (tone.donts && tone.donts.length))) {
              const toneObj = {};
              if (tone.voice) toneObj.voice = tone.voice;
              if (tone.attributes && tone.attributes.length) toneObj.attributes = tone.attributes;
              if (tone.dos && tone.dos.length) toneObj.dos = tone.dos;
              if (tone.donts && tone.donts.length) toneObj.donts = tone.donts;
              singleBrandObj.tone = toneObj;
            }

            // Add logos (only those with URLs)
            const singleLogos = singleBrandIdentity.logos.filter(l => l.url);
            if (singleLogos.length > 0) {
              singleBrandObj.logos = singleLogos.map(l => {
                const logo = { url: l.url };
                if (l.tags && l.tags.length > 0) logo.tags = l.tags;
                if (l.width) logo.width = l.width;
                if (l.height) logo.height = l.height;
                return logo;
              });
            }

            // Add colors (only if any are set)
            const singleColorsSerialized = serializeColors(singleBrandIdentity.colors);
            if (singleColorsSerialized) {
              singleBrandObj.colors = singleColorsSerialized;
            }

            // Add fonts (only if any are set)
            const singleFonts = Object.entries(singleBrandIdentity.fonts).filter(([, v]) => v);
            if (singleFonts.length > 0) {
              singleBrandObj.fonts = Object.fromEntries(singleFonts);
            }

            // Add domain as primary property
            if (currentDomain) {
              singleBrandObj.properties = [{ type: 'website', identifier: currentDomain, primary: true }];
            }

            // Add additional properties
            if (singleBrandProperties.length > 0) {
              if (!singleBrandObj.properties) singleBrandObj.properties = [];
              singleBrandProperties
                .filter(p => p.identifier)
                .forEach(p => {
                  singleBrandObj.properties.push({ type: p.type, identifier: p.identifier });
                });
            }

            json.brands = [singleBrandObj];
            break;

          case 'portfolio':
            // Multi-brand portfolio
            json.version = "1.0";

            const portfolioDomain = document.getElementById('portfolio-house-domain').value.trim();
            const portfolioName = document.getElementById('portfolio-house-name').value.trim();

            json.house = {
              domain: portfolioDomain || currentDomain,
              name: portfolioName || portfolioDomain || currentDomain,
              architecture: "house_of_brands"
            };

            json.brands = brands
              .filter(b => b.brand_id || b.name)
              .map(brand => {
                const brandObj = {
                  id: brand.brand_id || 'unnamed',
                  names: brand.name ? [{ en: brand.name }] : []
                };

                if (brand.keller_type) {
                  brandObj.keller_type = brand.keller_type;
                }
                if (brand.parent_brand) {
                  brandObj.parent_brand = brand.parent_brand;
                }

                // Add identity text fields
                const identityFields = ['description', 'industry', 'target_audience', 'tagline', 'privacy_policy_url'];
                identityFields.forEach(f => {
                  if (brand[f]) brandObj[f] = brand[f];
                });

                // Add structured tone
                const brandTone = brand.tone;
                if (brandTone && typeof brandTone === 'object' && (brandTone.voice || (brandTone.attributes && brandTone.attributes.length) || (brandTone.dos && brandTone.dos.length) || (brandTone.donts && brandTone.donts.length))) {
                  const toneObj = {};
                  if (brandTone.voice) toneObj.voice = brandTone.voice;
                  if (brandTone.attributes && brandTone.attributes.length) toneObj.attributes = brandTone.attributes;
                  if (brandTone.dos && brandTone.dos.length) toneObj.dos = brandTone.dos;
                  if (brandTone.donts && brandTone.donts.length) toneObj.donts = brandTone.donts;
                  brandObj.tone = toneObj;
                }

                // Add logos (only those with URLs)
                const brandLogos = (brand.logos || []).filter(l => l.url);
                if (brandLogos.length > 0) {
                  brandObj.logos = brandLogos.map(l => {
                    const logo = { url: l.url };
                    if (l.tags && l.tags.length > 0) logo.tags = l.tags;
                    if (l.width) logo.width = l.width;
                    if (l.height) logo.height = l.height;
                    return logo;
                  });
                }

                // Add colors (only if any are set)
                const brandColorsSerialized = serializeColors(brand.colors || {});
                if (brandColorsSerialized) {
                  brandObj.colors = brandColorsSerialized;
                }

                // Add fonts (only if any are set)
                const brandFonts = Object.entries(brand.fonts || {}).filter(([, v]) => v);
                if (brandFonts.length > 0) {
                  brandObj.fonts = Object.fromEntries(brandFonts);
                }

                // Build properties array starting with domain
                const props = [];
                if (brand.domain) {
                  props.push({ type: 'website', identifier: brand.domain, primary: true });
                }
                if (brand.properties && brand.properties.length > 0) {
                  brand.properties
                    .filter(p => p.identifier)
                    .forEach(p => props.push({ type: p.type, identifier: p.identifier }));
                }
                if (props.length > 0) {
                  brandObj.properties = props;
                }

                return brandObj;
              });
            break;

          case 'redirect':
            // Simple redirect to house
            const redirectHouse = document.getElementById('redirect-house-domain').value.trim();
            if (redirectHouse) {
              json.house = redirectHouse;
            }
            break;

          case 'agent':
            // Brand agent reference - schema requires both url and id
            const agentUrl = document.getElementById('agent-url').value.trim();
            const agentId = document.getElementById('agent-id').value.trim();
            if (agentUrl && agentId) {
              json.version = "1.0";
              json.brand_agent = { url: agentUrl, id: agentId };
            }
            break;
        }

        // Add contact info for single/portfolio variants
        if ((currentVariant === 'single' || currentVariant === 'portfolio') &&
            (contactInfo.name || contactInfo.email || contactInfo.domain)) {
          json.contact = {};
          if (contactInfo.name) json.contact.name = contactInfo.name;
          if (contactInfo.email) json.contact.email = contactInfo.email;
          if (contactInfo.domain) json.contact.domain = contactInfo.domain;
        }

        return json;
      }

      function finalizeJson() {
        const json = generateJson();
        // Set last_updated at export time (not on every preview render)
        if (currentVariant === 'single' || currentVariant === 'portfolio') {
          json.last_updated = new Date().toISOString().replace(/\.\d{3}Z$/, 'Z');
        }

        return json;
      }

      function updatePreview() {
        const json = generateJson();
        document.getElementById('json-preview').textContent = JSON.stringify(json, null, 2);
        scheduleAutoSave();
      }

      // ============================================================================
      // Export Functions
      // ============================================================================

      function copyJson() {
        const json = finalizeJson();
        navigator.clipboard.writeText(JSON.stringify(json, null, 2))
          .then(() => alert('Copied to clipboard!'))
          .catch(() => alert('Failed to copy'));
      }

      function downloadJson() {
        const json = finalizeJson();
        const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'brand.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // ============================================================================
      // Registry Functions
      // ============================================================================

      function updateRegistryButton() {
        const btn = document.getElementById('save-registry-btn');
        const hint = document.getElementById('save-registry-hint');
        if (!btn) return;
        const config = window.__APP_CONFIG__;
        if (!config?.user) {
          btn.disabled = true;
          btn.title = 'Log in to save to registry';
          if (hint) { hint.textContent = 'Log in as a member to save'; hint.style.display = ''; }
        } else if (!config.user.isMember) {
          btn.disabled = true;
          btn.title = 'Members only';
          if (hint) { hint.textContent = 'Members only'; hint.style.display = ''; }
        } else {
          btn.disabled = false;
          btn.title = 'Save brand.json to the AgenticAdvertising.org registry';
          if (hint) { hint.style.display = 'none'; }
        }
      }

      async function saveToRegistry() {
        if (!currentDomain) return;
        const btn = document.getElementById('save-registry-btn');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        try {
          const json = generateJson();

          // Try to create first
          let response = await fetch('/api/brands/hosted', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ brand_domain: currentDomain, brand_json: json })
          });

          // If already exists, update instead
          if (response.status === 409) {
            response = await fetch(`/api/brands/hosted/${encodeURIComponent(currentDomain)}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ brand_json: json })
            });
          }

          if (!response.ok) {
            const data = await response.json().catch(() => ({}));
            throw new Error(data.error || 'Failed to save');
          }

          btn.textContent = 'Saved!';
          setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
          }, 2000);
        } catch (error) {
          alert(error.message || 'Failed to save to registry');
          btn.textContent = originalText;
          btn.disabled = false;
        }
      }

      async function loadFromRegistry(domain) {
        try {
          const response = await fetch(`/api/brands/hosted/${encodeURIComponent(domain)}`);
          if (!response.ok) return null;
          const result = await response.json();
          if (!result.data) return null;
          return result;
        } catch {
          return null;
        }
      }

      // ============================================================================
      // Utility Functions
      // ============================================================================

      function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      function escapeAttr(str) {
        if (!str) return '';
        return escapeHtml(str).replace(/'/g, '&#39;');
      }

      // ============================================================================
      // Initialize
      // ============================================================================

      document.addEventListener('DOMContentLoaded', () => {
        // Check for domain in URL params
        const params = new URLSearchParams(window.location.search);
        const domain = params.get('domain');
        if (domain) {
          document.getElementById('domain-input').value = domain;
          startBuilding();
        }
      });
    </script>
  </body>
</html>
