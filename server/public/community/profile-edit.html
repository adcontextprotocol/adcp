<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit profile - AgenticAdvertising.org</title>
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <link rel="stylesheet" href="/design-system.css">
  <style>
    body {
      background: var(--color-bg-page);
      padding-top: var(--nav-height);
    }

    .edit-container {
      max-width: 680px;
      margin: 0 auto;
      padding: var(--space-8) var(--space-4);
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
      color: var(--color-text-muted);
      text-decoration: none;
      margin-bottom: var(--space-6);
    }

    .back-link:hover {
      color: var(--color-brand);
    }

    .edit-title {
      font-size: var(--text-3xl);
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
      margin-bottom: var(--space-8);
    }

    .edit-section {
      background: var(--color-bg-card);
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--card-radius);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
    }

    .edit-section-title {
      font-size: var(--text-lg);
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
      margin-bottom: var(--space-5);
    }

    .form-group {
      margin-bottom: var(--space-5);
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      margin-bottom: var(--space-2);
    }

    .form-input {
      width: 100%;
      padding: var(--space-2) var(--space-3);
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-family: var(--font-sans);
      color: var(--color-text-body);
      background: var(--color-bg-card);
      transition: border-color var(--duration-normal) var(--ease-in-out);
      box-sizing: border-box;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--color-brand);
      box-shadow: 0 0 0 3px var(--color-primary-100);
    }

    .form-input:disabled {
      background: var(--color-bg-subtle);
      color: var(--color-text-muted);
      cursor: not-allowed;
    }

    textarea.form-input {
      min-height: 100px;
      resize: vertical;
    }

    .form-hint {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
      display: block;
    }

    .form-char-count {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      text-align: right;
      margin-top: var(--space-1);
    }

    .form-char-count--over {
      color: var(--color-error-600);
    }

    .slug-preview {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }

    /* Toggle switch */
    .toggle-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: var(--space-4);
    }

    .toggle-label {
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
    }

    .toggle-description {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      line-height: var(--leading-relaxed);
      margin-top: var(--space-1);
    }

    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
      margin-top: var(--space-0.5);
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    .toggle-track {
      position: absolute;
      inset: 0;
      background: var(--color-gray-300);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: background var(--duration-normal) var(--ease-in-out);
    }

    .toggle-track::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: var(--radius-full);
      box-shadow: var(--shadow-xs);
      transition: transform var(--duration-normal) var(--ease-in-out);
    }

    .toggle-switch input:checked + .toggle-track {
      background: var(--color-brand);
    }

    .toggle-switch input:checked + .toggle-track::after {
      transform: translateX(20px);
    }

    .toggle-switch input:focus-visible + .toggle-track {
      outline: 2px solid var(--color-brand);
      outline-offset: 2px;
    }

    /* Checkbox row */
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .checkbox-row + .checkbox-row {
      margin-top: var(--space-3);
    }

    .checkbox-input {
      width: 18px;
      height: 18px;
      accent-color: var(--color-brand);
      flex-shrink: 0;
      cursor: pointer;
    }

    .checkbox-label {
      font-size: var(--text-sm);
      color: var(--color-text-heading);
      cursor: pointer;
    }

    .checkbox-description {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
    }

    /* Tag input */
    .tag-input-container {
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-2) var(--space-3);
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      align-items: center;
      min-height: 42px;
      background: var(--color-bg-card);
      transition: border-color var(--duration-normal) var(--ease-in-out);
      cursor: text;
    }

    .tag-input-container:focus-within {
      border-color: var(--color-brand);
      box-shadow: 0 0 0 3px var(--color-primary-100);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-md);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      line-height: var(--leading-tight);
    }

    .tag--expertise {
      background: var(--color-primary-100);
      color: var(--color-primary-800);
    }

    .tag--interest {
      background: var(--color-gray-100);
      color: var(--color-text-body);
      border: var(--border-1) solid var(--color-border);
    }

    .tag-remove {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      border: none;
      background: none;
      cursor: pointer;
      padding: 0;
      color: inherit;
      opacity: 0.6;
      font-size: var(--text-sm);
      line-height: 1;
      border-radius: var(--radius-full);
      transition: opacity var(--duration-normal) var(--ease-in-out);
    }

    .tag-remove:hover {
      opacity: 1;
      background: rgba(0, 0, 0, 0.1);
    }

    .tag-text-input {
      border: none;
      outline: none;
      flex: 1;
      min-width: 80px;
      font-family: var(--font-sans);
      font-size: var(--text-sm);
      color: var(--color-text-body);
      background: transparent;
      padding: var(--space-1) 0;
    }

    .tag-text-input::placeholder {
      color: var(--color-text-muted);
    }

    /* Social links prefix */
    .input-with-prefix {
      display: flex;
      align-items: center;
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--radius-md);
      overflow: hidden;
      background: var(--color-bg-card);
      transition: border-color var(--duration-normal) var(--ease-in-out);
    }

    .input-with-prefix:focus-within {
      border-color: var(--color-brand);
      box-shadow: 0 0 0 3px var(--color-primary-100);
    }

    .input-prefix {
      padding: var(--space-2) var(--space-3);
      background: var(--color-bg-subtle);
      border-right: var(--border-1) solid var(--color-border);
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .input-with-prefix .form-input {
      border: none;
      border-radius: 0;
      box-shadow: none;
    }

    .input-with-prefix .form-input:focus {
      border: none;
      box-shadow: none;
    }

    /* Save bar */
    .save-bar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: var(--space-3);
      padding-top: var(--space-2);
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: var(--space-6);
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      box-shadow: var(--shadow-lg);
      z-index: var(--z-toast);
      opacity: 0;
      transition: transform var(--duration-slow) var(--ease-out),
                  opacity var(--duration-slow) var(--ease-out);
      pointer-events: none;
      max-width: 90vw;
      text-align: center;
    }

    .toast--visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast--success {
      background: var(--color-success-600);
      color: white;
    }

    .toast--error {
      background: var(--color-error-600);
      color: white;
    }

    /* Loading state */
    .edit-loading {
      text-align: center;
      padding: var(--space-16);
      color: var(--color-text-muted);
    }

    .edit-loading .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--color-border);
      border-top-color: var(--color-brand);
      border-radius: var(--radius-full);
      animation: spin 1s linear infinite;
      margin: 0 auto var(--space-4);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 640px) {
      .edit-container {
        padding: var(--space-4) var(--space-3);
      }

      .edit-title {
        font-size: var(--text-2xl);
      }

      .edit-section {
        padding: var(--space-4);
      }

      .toggle-row {
        gap: var(--space-3);
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <div id="adcp-nav"></div>
  <script src="/nav.js"></script>

  <div class="edit-container">
    <a href="/community" class="back-link">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
      Back to hub
    </a>

    <!-- Loading state -->
    <div id="edit-loading" class="edit-loading">
      <div class="spinner"></div>
      <p>Loading your profile...</p>
    </div>

    <!-- Form content -->
    <div id="edit-content" style="display: none;">
      <h1 class="edit-title">Edit profile</h1>

      <form id="profile-form" novalidate>
        <!-- Community visibility -->
        <div class="edit-section">
          <h2 class="edit-section-title">Community visibility</h2>
          <div class="toggle-row">
            <div class="toggle-content">
              <div class="toggle-label">Public profile</div>
              <div class="toggle-description">Make your profile visible in the <a href="/community/people" style="color: var(--color-brand);">community directory</a>. Only logged-in members can see it.</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="field-is-public" aria-label="Public profile">
              <span class="toggle-track"></span>
            </label>
          </div>
        </div>

        <!-- About you -->
        <div class="edit-section">
          <h2 class="edit-section-title">About you</h2>

          <div class="form-group">
            <label class="form-label" for="field-slug">Profile URL slug</label>
            <input type="text" id="field-slug" class="form-input" placeholder="e.g. jane-doe" autocomplete="off" spellcheck="false">
            <div class="slug-preview">agenticadvertising.org/community/people/<strong id="slug-preview-value">...</strong></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="field-headline">Headline</label>
            <input type="text" id="field-headline" class="form-input" placeholder="e.g. VP of Programmatic at Acme Corp" maxlength="255">
            <div class="form-char-count" id="headline-char-count">0 / 255</div>
          </div>

          <div class="form-group">
            <label class="form-label" for="field-bio">Bio</label>
            <textarea id="field-bio" class="form-input" placeholder="Tell the community about yourself..."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label" for="field-avatar-url">Avatar URL</label>
            <input type="url" id="field-avatar-url" class="form-input" placeholder="https://example.com/photo.jpg">
          </div>

          <div class="form-group">
            <label class="form-label">Expertise</label>
            <div class="tag-input-container" id="expertise-container">
              <input type="text" class="tag-text-input" id="expertise-input" placeholder="Type and press Enter to add">
            </div>
            <span class="form-hint">Press Enter or comma to add a tag</span>
          </div>

          <div class="form-group">
            <label class="form-label">Interests</label>
            <div class="tag-input-container" id="interests-container">
              <input type="text" class="tag-text-input" id="interests-input" placeholder="Type and press Enter to add">
            </div>
            <span class="form-hint">Press Enter or comma to add a tag</span>
          </div>

          <div class="form-group">
            <label class="form-label" for="field-city">City</label>
            <input type="text" id="field-city" class="form-input" placeholder="e.g. New York, London, Tokyo">
            <span class="form-hint">Helps others in your area find you</span>
          </div>
        </div>

        <!-- Social links -->
        <div class="edit-section">
          <h2 class="edit-section-title">Social links</h2>

          <div class="form-group">
            <label class="form-label" for="field-linkedin-url">LinkedIn</label>
            <input type="url" id="field-linkedin-url" class="form-input" placeholder="https://linkedin.com/in/your-profile">
          </div>

          <div class="form-group">
            <label class="form-label" for="field-twitter-url">X (Twitter)</label>
            <input type="url" id="field-twitter-url" class="form-input" placeholder="https://x.com/yourhandle">
          </div>

          <div class="form-group">
            <label class="form-label" for="field-github-username">GitHub username</label>
            <div class="input-with-prefix">
              <span class="input-prefix">github.com/</span>
              <input type="text" id="field-github-username" class="form-input" placeholder="yourname" autocomplete="off" spellcheck="false">
            </div>
          </div>
        </div>

        <!-- Preferences -->
        <div class="edit-section">
          <h2 class="edit-section-title">Preferences</h2>

          <div class="checkbox-row">
            <input type="checkbox" id="field-coffee-chat" class="checkbox-input">
            <div>
              <label class="checkbox-label" for="field-coffee-chat">Open to coffee chats</label>
              <div class="checkbox-description">Let others know you are available for informal conversations</div>
            </div>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="field-intros" class="checkbox-input">
            <div>
              <label class="checkbox-label" for="field-intros">Open to introductions</label>
              <div class="checkbox-description">Let others know they can introduce you to people in their network</div>
            </div>
          </div>
        </div>

        <!-- Member directory (individual accounts only) -->
        <div class="edit-section" id="member-directory-section" style="display: none;">
          <h2 class="edit-section-title">Member directory</h2>
          <p style="font-size: var(--text-sm); color: var(--color-text-muted); margin-bottom: var(--space-4);">
            Get listed in the <a href="/members" style="color: var(--color-brand);">member directory</a> so companies and peers can discover your expertise in agentic advertising.
          </p>

          <div id="member-directory-status" style="display: none; padding: var(--space-3) var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-4); font-size: var(--text-sm);"></div>

          <div class="form-group">
            <label class="form-label">What do you do?</label>
            <div class="checkbox-row">
              <input type="checkbox" id="offering-consulting" class="checkbox-input" value="consulting">
              <label class="checkbox-label" for="offering-consulting">Consulting</label>
            </div>
            <div class="checkbox-row">
              <input type="checkbox" id="offering-other" class="checkbox-input" value="other">
              <label class="checkbox-label" for="offering-other">Other</label>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="field-contact-email">Contact email</label>
            <input type="email" id="field-contact-email" class="form-input" placeholder="you@example.com">
          </div>

          <div class="form-group">
            <label class="form-label" for="field-contact-phone">Contact phone</label>
            <input type="tel" id="field-contact-phone" class="form-input" placeholder="+1 (555) 123-4567">
          </div>

          <div class="form-group">
            <label class="form-label" for="field-contact-website">Website</label>
            <input type="url" id="field-contact-website" class="form-input" placeholder="https://example.com">
          </div>
        </div>

        <!-- Save -->
        <div class="save-bar">
          <a href="/community" class="btn btn-ghost">Cancel</a>
          <button type="submit" class="btn btn-primary" id="save-btn">Save changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <div id="adcp-footer"></div>

  <script>
    // Auth check
    const config = window.__APP_CONFIG__ || {};
    if (!config.user) {
      window.location.href = '/auth/login?return_to=/community/profile/edit';
    }

    // State
    let profileData = null;
    let memberProfileData = null;
    let memberBillingData = null;
    let isPersonalAccount = false;
    let expertiseTags = [];
    let interestsTags = [];

    document.addEventListener('DOMContentLoaded', () => {
      loadProfile();
      document.getElementById('profile-form').addEventListener('submit', handleSubmit);
      document.getElementById('field-slug').addEventListener('input', updateSlugPreview);
      document.getElementById('field-headline').addEventListener('input', updateCharCount);
      setupTagInput('expertise');
      setupTagInput('interests');
    });

    // Data fetching
    async function loadProfile() {
      try {
        const [hubResponse, memberResponse] = await Promise.all([
          fetch('/api/me/community/hub'),
          fetch('/api/me/member-profile').catch(() => null),
        ]);

        if (!hubResponse.ok) {
          if (hubResponse.status === 401) {
            window.location.href = '/auth/login?return_to=/community/profile/edit';
            return;
          }
          throw new Error('Failed to load profile');
        }

        const data = await hubResponse.json();
        profileData = data.profile || {};

        // Detect individual account and load member profile data
        if (memberResponse && memberResponse.ok) {
          const memberData = await memberResponse.json();
          memberProfileData = memberData.profile || null;

          // Check if org is personal via billing endpoint
          if (memberData.organization_id) {
            try {
              const billingResp = await fetch(`/api/organizations/${memberData.organization_id}/billing`);
              if (billingResp.ok) {
                memberBillingData = await billingResp.json();
                isPersonalAccount = memberBillingData.is_personal || false;
              }
            } catch (e) {
              console.warn('Could not load billing info:', e);
            }
          }
        }

        populateForm(profileData);

        // Show member directory section for individual accounts
        if (isPersonalAccount) {
          document.getElementById('member-directory-section').style.display = 'block';
          populateMemberFields(memberProfileData, memberBillingData);
        }

        document.getElementById('edit-loading').style.display = 'none';
        document.getElementById('edit-content').style.display = 'block';
      } catch (error) {
        console.error('Load profile error:', error);
        document.getElementById('edit-loading').innerHTML =
          '<p>Failed to load profile. <a href="/community/profile/edit">Try again</a></p>';
      }
    }

    function populateMemberFields(memberProfile, billingData) {
      if (!memberProfile) {
        // No member profile yet â€” show informational status
        const statusEl = document.getElementById('member-directory-status');
        statusEl.style.display = 'block';
        statusEl.style.background = 'var(--color-gray-50)';
        statusEl.style.color = 'var(--color-text-secondary)';
        statusEl.style.border = 'var(--border-1) solid var(--color-gray-200)';
        statusEl.innerHTML = 'You don\'t have a member directory listing yet. <a href="/dashboard/settings" style="color: var(--color-brand); font-weight: var(--font-medium);">Subscribe</a> to create one and appear in the directory.';
        return;
      }
      const offerings = memberProfile.offerings || [];
      document.getElementById('offering-consulting').checked = offerings.includes('consulting');
      document.getElementById('offering-other').checked = offerings.includes('other');
      document.getElementById('field-contact-email').value = memberProfile.contact_email || '';
      document.getElementById('field-contact-phone').value = memberProfile.contact_phone || '';
      document.getElementById('field-contact-website').value = memberProfile.contact_website || '';

      // Show visibility status
      const statusEl = document.getElementById('member-directory-status');
      statusEl.style.display = 'block';
      const isSubscribed = billingData?.subscription?.status === 'active';
      if (memberProfile.is_public && isSubscribed) {
        statusEl.style.background = 'var(--color-success-50)';
        statusEl.style.color = 'var(--color-success-700)';
        statusEl.style.border = 'var(--border-1) solid var(--color-success-200)';
        statusEl.innerHTML = 'Your listing is live at <a href="/members/' + encodeURIComponent(memberProfile.slug) + '" style="color: var(--color-success-700); font-weight: var(--font-medium);">/members/' + escapeHtml(memberProfile.slug) + '</a>';
      } else {
        statusEl.style.background = 'var(--color-warning-50)';
        statusEl.style.color = 'var(--color-warning-700)';
        statusEl.style.border = 'var(--border-1) solid var(--color-warning-200)';
        statusEl.innerHTML = 'Your listing is not yet visible in the member directory. <a href="/dashboard/settings" style="color: var(--color-warning-700); font-weight: var(--font-medium);">Manage subscription</a>';
      }
    }

    // Form population
    function populateForm(profile) {
      document.getElementById('field-is-public').checked = !!profile.is_public;
      document.getElementById('field-slug').value = profile.slug || '';
      updateSlugPreview();
      document.getElementById('field-headline').value = profile.headline || '';
      updateCharCount();
      document.getElementById('field-bio').value = profile.bio || '';
      document.getElementById('field-avatar-url').value = profile.avatar_url || '';

      expertiseTags = (profile.expertise || []).slice();
      interestsTags = (profile.interests || []).slice();
      renderTags('expertise');
      renderTags('interests');

      document.getElementById('field-city').value = profile.city || '';
      document.getElementById('field-linkedin-url').value = profile.linkedin_url || '';
      document.getElementById('field-twitter-url').value = profile.twitter_url || '';
      document.getElementById('field-github-username').value = profile.github_username || '';
      document.getElementById('field-coffee-chat').checked = !!profile.open_to_coffee_chat;
      document.getElementById('field-intros').checked = !!profile.open_to_intros;
    }

    // Tag management
    function getTagState(type) {
      if (type === 'expertise') return { tags: expertiseTags, cssClass: 'tag--expertise' };
      return { tags: interestsTags, cssClass: 'tag--interest' };
    }

    function renderTags(type) {
      const { tags, cssClass } = getTagState(type);
      const container = document.getElementById(type + '-container');
      const input = document.getElementById(type + '-input');

      container.querySelectorAll('.tag').forEach(el => el.remove());

      tags.forEach((tag, index) => {
        const tagEl = document.createElement('span');
        tagEl.className = 'tag ' + cssClass;
        tagEl.innerHTML = escapeHtml(tag) +
          '<button type="button" class="tag-remove" aria-label="Remove ' + escapeHtml(tag) + '">&times;</button>';

        tagEl.querySelector('.tag-remove').addEventListener('click', () => {
          removeTag(type, index);
        });

        container.insertBefore(tagEl, input);
      });
    }

    function addTag(type, value) {
      const trimmed = value.trim().toLowerCase();
      if (!trimmed) return;

      const { tags } = getTagState(type);
      if (tags.includes(trimmed)) return;

      tags.push(trimmed);
      renderTags(type);
    }

    function removeTag(type, index) {
      const { tags } = getTagState(type);
      tags.splice(index, 1);
      renderTags(type);
    }

    function setupTagInput(type) {
      const input = document.getElementById(type + '-input');
      const container = document.getElementById(type + '-container');

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ',') {
          e.preventDefault();
          const val = input.value.replace(/,/g, '');
          addTag(type, val);
          input.value = '';
        }
        if (e.key === 'Backspace' && input.value === '') {
          const { tags } = getTagState(type);
          if (tags.length > 0) {
            removeTag(type, tags.length - 1);
          }
        }
      });

      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text');
        text.split(',').forEach(item => addTag(type, item));
      });

      container.addEventListener('click', () => input.focus());
    }

    // Slug preview
    function updateSlugPreview() {
      const value = document.getElementById('field-slug').value.trim();
      document.getElementById('slug-preview-value').textContent = value || '...';
    }

    // Character count
    function updateCharCount() {
      const input = document.getElementById('field-headline');
      const counter = document.getElementById('headline-char-count');
      const len = input.value.length;
      counter.textContent = len + ' / 255';
      counter.className = len > 255 ? 'form-char-count form-char-count--over' : 'form-char-count';
    }

    // Form submission
    async function handleSubmit(e) {
      e.preventDefault();

      const saveBtn = document.getElementById('save-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      const payload = {
        is_public: document.getElementById('field-is-public').checked,
        slug: document.getElementById('field-slug').value.trim() || undefined,
        headline: document.getElementById('field-headline').value.trim() || undefined,
        bio: document.getElementById('field-bio').value.trim() || undefined,
        avatar_url: document.getElementById('field-avatar-url').value.trim() || undefined,
        expertise: expertiseTags,
        interests: interestsTags,
        city: document.getElementById('field-city').value.trim() || undefined,
        linkedin_url: document.getElementById('field-linkedin-url').value.trim() || undefined,
        twitter_url: document.getElementById('field-twitter-url').value.trim() || undefined,
        github_username: document.getElementById('field-github-username').value.trim() || undefined,
        open_to_coffee_chat: document.getElementById('field-coffee-chat').checked,
        open_to_intros: document.getElementById('field-intros').checked,
      };

      // Include member directory fields for individual accounts
      if (isPersonalAccount) {
        const offerings = [];
        if (document.getElementById('offering-consulting').checked) offerings.push('consulting');
        if (document.getElementById('offering-other').checked) offerings.push('other');
        payload.offerings = offerings;
        payload.contact_email = document.getElementById('field-contact-email').value.trim() || undefined;
        payload.contact_phone = document.getElementById('field-contact-phone').value.trim() || undefined;
        payload.contact_website = document.getElementById('field-contact-website').value.trim() || undefined;
      }

      try {
        const response = await fetch('/api/me/community-profile', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => null);
          throw new Error(errorData?.error || 'Failed to save profile');
        }

        showToast('Profile saved', 'success');
      } catch (error) {
        console.error('Save error:', error);
        showToast(error.message, 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save changes';
      }
    }

    // Toast
    let toastTimeout = null;

    function showToast(message, type) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast toast--' + type;
      void toast.offsetWidth;
      toast.classList.add('toast--visible');

      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        toast.classList.remove('toast--visible');
      }, 3000);
    }

    // Helpers
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
