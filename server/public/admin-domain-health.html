<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Domain Health - Admin - AgenticAdvertising.org</title>
  <link rel="stylesheet" href="/design-system.css">
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <style>
    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-wide);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }
    h1 { margin-bottom: var(--space-2); color: var(--color-text-heading); }
    .subtitle { color: var(--color-text-secondary); margin-bottom: var(--space-5); }

    /* Summary Cards */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }
    .summary-card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-5);
      box-shadow: var(--shadow-xs);
      border-left: 4px solid var(--color-gray-300);
    }
    .summary-card.good { border-left-color: var(--color-success-500); }
    .summary-card.warning { border-left-color: var(--color-warning-500); }
    .summary-card.error { border-left-color: var(--color-error-500); }
    .summary-card .label {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
    }
    .summary-card .value {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
    }
    .summary-card .detail {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }

    /* Section Headers */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }
    .section-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .section-badge {
      background: var(--color-error-100);
      color: var(--color-error-700);
      padding: var(--space-0.5) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
    }
    .section-badge.success {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .section-description {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-4);
    }

    /* Issue Tables */
    .issue-table {
      width: 100%;
      border-collapse: collapse;
    }
    .issue-table th {
      text-align: left;
      padding: var(--space-3) var(--space-4);
      background: var(--color-gray-50);
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      color: var(--color-text-secondary);
      border-bottom: var(--border-1) solid var(--color-border);
    }
    .issue-table td {
      padding: var(--space-3) var(--space-4);
      border-bottom: var(--border-1) solid var(--color-border);
      font-size: var(--text-sm);
      vertical-align: top;
    }
    .issue-table tr:hover {
      background: var(--color-gray-50);
    }
    .domain-name {
      font-weight: var(--font-semibold);
      color: var(--color-brand);
    }
    .user-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .user-list li {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      padding: var(--space-0.5) 0;
    }
    .user-count {
      background: var(--color-gray-100);
      color: var(--color-text-secondary);
      padding: var(--space-0.5) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
    }

    /* Action Buttons */
    .btn {
      padding: var(--space-1.5) var(--space-3);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-xs);
      cursor: pointer;
      transition: var(--transition-all);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
    }
    .btn-primary {
      background: var(--color-brand);
      color: white;
    }
    .btn-primary:hover {
      background: var(--color-primary-700);
    }
    .btn-secondary {
      background: var(--color-gray-100);
      color: var(--color-text-heading);
    }
    .btn-secondary:hover {
      background: var(--color-gray-200);
    }
    .btn-sm {
      padding: var(--space-1) var(--space-2);
      font-size: var(--text-xs);
    }
    .btn-success {
      background: var(--color-success-500);
      color: white;
    }
    .btn-error {
      background: var(--color-error-500);
      color: white;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Organization Links */
    .org-link {
      color: var(--color-brand);
      text-decoration: none;
    }
    .org-link:hover {
      text-decoration: underline;
    }
    .org-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .org-list li {
      padding: var(--space-1) 0;
    }

    /* Status Badges */
    .status-badge {
      display: inline-block;
      padding: var(--space-0.5) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .status-active {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .status-prospect {
      background: var(--color-warning-100);
      color: var(--color-warning-700);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--space-8);
      color: var(--color-text-muted);
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: var(--space-3);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: var(--space-12);
      color: var(--color-text-muted);
    }
  </style>
</head>
<body>
  <div id="adcp-nav"></div>

  <div id="loading" class="loading">Loading domain health data...</div>

  <div id="content" style="display: none;">
    <div class="container">
      <div class="card">
        <h1>Domain Health</h1>
        <p class="subtitle">Monitor domain coverage and data quality across the membership system</p>

        <!-- Summary Stats -->
        <div class="summary-grid" id="summaryGrid">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Orphan Domains Section -->
      <div class="card" id="orphanDomainsSection">
        <div class="section-header">
          <div>
            <div class="section-title">
              Unlinked Corporate Domains
              <span class="section-badge" id="orphanBadge">0</span>
            </div>
            <p class="section-description">Corporate email domains not linked to any organization. Users may already be members of existing orgs - link the domain to consolidate.</p>
          </div>
        </div>
        <div id="orphanDomainsContent"></div>
      </div>

      <!-- Misaligned Users Section -->
      <div class="card" id="misalignedUsersSection">
        <div class="section-header">
          <div>
            <div class="section-title">
              Corporate Users in Personal Workspaces
              <span class="section-badge" id="misalignedBadge">0</span>
            </div>
            <p class="section-description">Users with company email addresses who are in personal workspaces instead of company organizations.</p>
          </div>
        </div>
        <div id="misalignedUsersContent"></div>
      </div>

      <!-- Unverified Orgs Section -->
      <div class="card" id="unverifiedOrgsSection">
        <div class="section-header">
          <div>
            <div class="section-title">
              Organizations Without Verified Domains
              <span class="section-badge" id="unverifiedBadge">0</span>
            </div>
            <p class="section-description">Organizations with members but no verified domain mapping. Verify domain ownership for these orgs.</p>
          </div>
        </div>
        <div id="unverifiedOrgsContent"></div>
      </div>

      <!-- Domain Conflicts Section -->
      <div class="card" id="domainConflictsSection">
        <div class="section-header">
          <div>
            <div class="section-title">
              Domain Conflicts
              <span class="section-badge" id="conflictsBadge">0</span>
            </div>
            <p class="section-description">Multiple organizations claiming the same email domain. Merge these duplicates.</p>
          </div>
        </div>
        <div id="domainConflictsContent"></div>
      </div>
    </div>
  </div>

  <script>
    let healthData = null;

    async function loadDomainHealth() {
      try {
        const response = await fetch('/api/admin/domain-health');
        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar?.redirectToLogin();
            return;
          }
          throw new Error('Failed to load domain health');
        }
        healthData = await response.json();
        renderDomainHealth();
      } catch (error) {
        console.error('Error loading domain health:', error);
        document.getElementById('loading').innerHTML = 'Error loading data. Please refresh.';
      }
    }

    // HTML escaping to prevent XSS
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Validate org ID format (alphanumeric, underscores, hyphens only)
    function isValidOrgId(id) {
      return /^[a-zA-Z0-9_-]+$/.test(id);
    }

    // Safe org ID for use in JS strings - validates and returns or throws
    function safeOrgId(id) {
      if (!isValidOrgId(id)) {
        throw new Error('Invalid org ID format');
      }
      return id;
    }

    function renderDomainHealth() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';

      renderSummary();
      renderOrphanDomains();
      renderMisalignedUsers();
      renderUnverifiedOrgs();
      renderDomainConflicts();

      // Set up event delegation for merge buttons (avoiding inline onclick for XSS safety)
      document.querySelectorAll('.merge-orgs-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const orgIds = btn.dataset.orgIds.split(',').map(decodeURIComponent);
          const domain = decodeURIComponent(btn.dataset.domain);
          showMergeModal(orgIds, domain);
        });
      });

      // Set up event handlers for link domain buttons
      document.querySelectorAll('.link-domain-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const orgId = btn.dataset.orgId;
          const orgName = btn.dataset.orgName;
          const domain = btn.dataset.domain;
          linkDomainToOrg(btn, orgId, orgName, domain);
        });
      });

      // Set up event handlers for link domain selects
      document.querySelectorAll('.link-domain-select').forEach(select => {
        select.addEventListener('change', () => {
          const orgId = select.value;
          if (!orgId) return;
          const option = select.options[select.selectedIndex];
          const orgName = option.dataset.orgName;
          const domain = select.dataset.domain;
          linkDomainToOrg(select, orgId, orgName, domain);
        });
      });
    }

    async function linkDomainToOrg(element, orgId, orgName, domain) {
      // Validate orgId format before using in URL
      if (!isValidOrgId(orgId)) {
        alert('Invalid organization ID format');
        return;
      }

      const originalText = element.tagName === 'BUTTON' ? element.textContent : null;
      const originalDisabled = element.disabled;

      // Disable and show loading state
      element.disabled = true;
      if (element.tagName === 'BUTTON') {
        element.textContent = 'Linking...';
      }

      try {
        const response = await fetch(`/api/admin/organizations/${encodeURIComponent(orgId)}/domains`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ domain: domain.toLowerCase(), is_primary: true })
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar?.redirectToLogin();
            return;
          }
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || errorData.error || 'Failed to link domain');
        }

        // Success - show success state briefly then reload data
        element.classList.remove('btn-primary');
        element.classList.add('btn-success');
        if (element.tagName === 'BUTTON') {
          element.textContent = 'Linked!';
        } else {
          // For select, reset and disable
          element.value = '';
          const firstOption = element.options[0];
          if (firstOption) firstOption.textContent = 'Linked!';
        }

        // Reload after brief delay to show success
        setTimeout(() => {
          loadDomainHealth();
        }, 1000);
      } catch (error) {
        // Show error state
        element.classList.remove('btn-primary');
        element.classList.add('btn-error');
        if (element.tagName === 'BUTTON') {
          element.textContent = 'Failed';
          element.title = error.message;
        } else {
          element.value = '';
          const firstOption = element.options[0];
          if (firstOption) firstOption.textContent = 'Failed: ' + error.message;
        }

        // Reset after delay
        setTimeout(() => {
          element.disabled = originalDisabled;
          element.classList.remove('btn-error');
          element.classList.add('btn-primary');
          if (element.tagName === 'BUTTON') {
            element.textContent = originalText;
            element.title = '';
          } else {
            const firstOption = element.options[0];
            if (firstOption) firstOption.textContent = 'Link to org...';
          }
        }, 3000);
      }
    }

    function renderSummary() {
      const { summary } = healthData;
      const totalIssues = summary.issues.orphan_domains + summary.issues.misaligned_users +
                          summary.issues.unverified_orgs + summary.issues.domain_conflicts;

      const grid = document.getElementById('summaryGrid');
      grid.innerHTML = `
        <div class="summary-card ${totalIssues === 0 ? 'good' : 'warning'}">
          <div class="label">Total Issues</div>
          <div class="value">${totalIssues}</div>
          <div class="detail">${totalIssues === 0 ? 'All domains healthy' : 'Needs attention'}</div>
        </div>
        <div class="summary-card">
          <div class="label">Organizations</div>
          <div class="value">${summary.total_organizations}</div>
          <div class="detail">Non-personal workspaces</div>
        </div>
        <div class="summary-card good">
          <div class="label">Verified Domains</div>
          <div class="value">${summary.verified_domains}</div>
          <div class="detail">Domains with verified ownership</div>
        </div>
        <div class="summary-card ${summary.unverified_domains > 0 ? 'warning' : 'good'}">
          <div class="label">Unverified Domains</div>
          <div class="value">${summary.unverified_domains}</div>
          <div class="detail">Domains pending verification</div>
        </div>
      `;
    }

    function renderOrphanDomains() {
      const { orphan_domains } = healthData;
      const badge = document.getElementById('orphanBadge');
      const content = document.getElementById('orphanDomainsContent');

      badge.textContent = orphan_domains.length;
      badge.className = orphan_domains.length === 0 ? 'section-badge success' : 'section-badge';

      if (orphan_domains.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#10003;</div>
            <p>No unlinked domains found. All corporate domains are properly linked to organizations.</p>
          </div>
        `;
        return;
      }

      content.innerHTML = `
        <table class="issue-table">
          <thead>
            <tr>
              <th>Domain</th>
              <th>Users</th>
              <th>Existing Organizations</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${orphan_domains.map(d => {
              // Filter to non-personal orgs first, then personal
              const nonPersonalOrgs = (d.existing_orgs || []).filter(o => !o.is_personal);
              const personalOrgs = (d.existing_orgs || []).filter(o => o.is_personal);
              const hasExistingOrgs = nonPersonalOrgs.length > 0;
              const hasMultipleOrgs = nonPersonalOrgs.length > 1;

              return `
              <tr>
                <td><span class="domain-name">${escapeHtml(d.domain)}</span></td>
                <td><span class="user-count">${d.user_count}</span></td>
                <td>
                  ${hasExistingOrgs ? `
                    <ul class="org-list">
                      ${nonPersonalOrgs.map(o => `
                        <li>
                          <a href="/admin/organizations/${o.org_id}" class="org-link">${escapeHtml(o.name)}</a>
                          <span class="user-count">${o.user_count} users</span>
                        </li>
                      `).join('')}
                    </ul>
                    ${personalOrgs.length > 0 ? `<div style="margin-top: var(--space-2); font-size: var(--text-xs); color: var(--color-text-muted);">+ ${personalOrgs.length} personal workspace${personalOrgs.length > 1 ? 's' : ''}</div>` : ''}
                  ` : `
                    <span style="color: var(--color-text-muted);">
                      ${personalOrgs.length > 0 ? `${personalOrgs.length} personal workspace${personalOrgs.length > 1 ? 's' : ''} only` : 'No existing orgs'}
                    </span>
                  `}
                </td>
                <td>
                  ${hasExistingOrgs ? `
                    <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                      ${nonPersonalOrgs.length === 1 ? `
                        <button class="btn btn-primary btn-sm link-domain-btn" data-org-id="${escapeHtml(nonPersonalOrgs[0].org_id)}" data-org-name="${escapeHtml(nonPersonalOrgs[0].name)}" data-domain="${escapeHtml(d.domain)}">Link to ${escapeHtml(nonPersonalOrgs[0].name)}</button>
                      ` : `
                        <select class="btn btn-sm link-domain-select" data-domain="${escapeHtml(d.domain)}" style="padding: var(--space-1) var(--space-2); cursor: pointer;">
                          <option value="">Link to org...</option>
                          ${nonPersonalOrgs.map(o => `
                            <option value="${escapeHtml(o.org_id)}" data-org-name="${escapeHtml(o.name)}">${escapeHtml(o.name)}</option>
                          `).join('')}
                        </select>
                      `}
                      ${hasMultipleOrgs ? `
                        <button class="btn btn-secondary btn-sm merge-orgs-btn" data-org-ids="${nonPersonalOrgs.map(o => encodeURIComponent(o.org_id)).join(',')}" data-domain="${encodeURIComponent(d.domain)}">Merge ${nonPersonalOrgs.length} orgs</button>
                      ` : ''}
                    </div>
                  ` : `
                    <a href="/admin/prospects?create=${encodeURIComponent(d.domain)}" class="btn btn-primary btn-sm">Create Prospect</a>
                  `}
                </td>
              </tr>
            `}).join('')}
          </tbody>
        </table>
      `;
    }

    function renderMisalignedUsers() {
      const { misaligned_users } = healthData;
      const badge = document.getElementById('misalignedBadge');
      const content = document.getElementById('misalignedUsersContent');

      const totalUsers = misaligned_users.reduce((sum, d) => sum + d.user_count, 0);
      badge.textContent = totalUsers;
      badge.className = totalUsers === 0 ? 'section-badge success' : 'section-badge';

      if (misaligned_users.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#10003;</div>
            <p>No misaligned users found. All corporate users are in proper company workspaces.</p>
          </div>
        `;
        return;
      }

      content.innerHTML = `
        <table class="issue-table">
          <thead>
            <tr>
              <th>Domain</th>
              <th>Users</th>
              <th>User Details</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${misaligned_users.map(d => `
              <tr>
                <td><span class="domain-name">${escapeHtml(d.domain)}</span></td>
                <td><span class="user-count">${d.user_count}</span></td>
                <td>
                  <ul class="user-list">
                    ${d.users.slice(0, 3).map(u => `
                      <li>${escapeHtml(u.email)} (${escapeHtml(u.first_name || '')} ${escapeHtml(u.last_name || '')})</li>
                    `).join('')}
                    ${d.user_count > 3 ? `<li>... and ${d.user_count - 3} more</li>` : ''}
                  </ul>
                </td>
                <td>
                  <a href="/admin/prospects?create=${encodeURIComponent(d.domain)}" class="btn btn-secondary btn-sm">Create Org</a>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderUnverifiedOrgs() {
      const { unverified_orgs } = healthData;
      const badge = document.getElementById('unverifiedBadge');
      const content = document.getElementById('unverifiedOrgsContent');

      badge.textContent = unverified_orgs.length;
      badge.className = unverified_orgs.length === 0 ? 'section-badge success' : 'section-badge';

      if (unverified_orgs.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#10003;</div>
            <p>All organizations with users have verified domains.</p>
          </div>
        `;
        return;
      }

      content.innerHTML = `
        <table class="issue-table">
          <thead>
            <tr>
              <th>Organization</th>
              <th>Users</th>
              <th>User Domains</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${unverified_orgs.map(o => `
              <tr>
                <td>
                  <a href="/admin/org/${encodeURIComponent(o.org_id)}" class="org-link">${escapeHtml(o.name)}</a>
                  ${o.email_domain ? `<br><small style="color: var(--color-text-muted);">${escapeHtml(o.email_domain)}</small>` : ''}
                </td>
                <td><span class="user-count">${o.user_count}</span></td>
                <td>
                  <ul class="user-list">
                    ${o.user_domains.slice(0, 3).map(d => `<li>${escapeHtml(d)}</li>`).join('')}
                  </ul>
                </td>
                <td>
                  <span class="status-badge ${o.subscription_status === 'active' ? 'status-active' : 'status-prospect'}">
                    ${escapeHtml(o.subscription_status || 'prospect')}
                  </span>
                </td>
                <td>
                  <a href="/admin/org/${encodeURIComponent(o.org_id)}" class="btn btn-secondary btn-sm">View Org</a>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderDomainConflicts() {
      const { domain_conflicts } = healthData;
      const badge = document.getElementById('conflictsBadge');
      const content = document.getElementById('domainConflictsContent');

      badge.textContent = domain_conflicts.length;
      badge.className = domain_conflicts.length === 0 ? 'section-badge success' : 'section-badge';

      if (domain_conflicts.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#10003;</div>
            <p>No domain conflicts found. Each domain maps to exactly one organization.</p>
          </div>
        `;
        return;
      }

      content.innerHTML = `
        <table class="issue-table">
          <thead>
            <tr>
              <th>Domain</th>
              <th>Organizations</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${domain_conflicts.map(c => `
              <tr>
                <td>
                  <span class="domain-name">${escapeHtml(c.domain)}</span>
                  <br><small style="color: var(--color-text-muted);">${c.org_count} organizations</small>
                </td>
                <td>
                  <ul class="org-list">
                    ${c.organizations.map(o => `
                      <li>
                        <a href="/admin/org/${encodeURIComponent(o.id)}" class="org-link">${escapeHtml(o.name)}</a>
                        <span class="status-badge ${o.subscription_status === 'active' ? 'status-active' : 'status-prospect'}">
                          ${escapeHtml(o.subscription_status || 'prospect')}
                        </span>
                      </li>
                    `).join('')}
                  </ul>
                </td>
                <td>
                  <button class="btn btn-primary btn-sm merge-orgs-btn" data-org-ids="${c.organizations.map(o => encodeURIComponent(o.id)).join(',')}" data-domain="${encodeURIComponent(c.domain)}">
                    Merge Orgs
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // Merge modal functionality
    let mergeModalElement = null;

    function showMergeModal(orgIds, domain) {
      // Create modal if doesn't exist
      if (!mergeModalElement) {
        mergeModalElement = document.createElement('div');
        mergeModalElement.id = 'mergeModal';
        document.body.appendChild(mergeModalElement);
      }

      mergeModalElement.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-surface-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000;">
          <div style="background: var(--color-bg-card); border-radius: var(--radius-lg); padding: var(--space-6); max-width: 700px; width: 95%; max-height: 85vh; overflow: auto; box-shadow: var(--shadow-lg);">
            <h3 style="margin-bottom: var(--space-4);">Loading organizations...</h3>
            <div style="color: var(--color-text-muted);">Fetching details for merge preview...</div>
          </div>
        </div>
      `;

      // Fetch org details
      loadMergePreview(orgIds, domain);
    }

    async function loadMergePreview(orgIds, domain) {
      try {
        // Fetch all org details in parallel
        const responses = await Promise.all(
          orgIds.map(id => fetch(`/api/admin/organizations/${id}`))
        );

        const orgs = await Promise.all(responses.map(async (r, i) => {
          if (!r.ok) return { id: orgIds[i], name: 'Unknown', error: true };
          return await r.json();
        }));

        // Sort by user count descending to suggest largest as primary
        orgs.sort((a, b) => (b.member_count || 0) - (a.member_count || 0));

        mergeModalElement.innerHTML = `
          <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-surface-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div style="background: var(--color-bg-card); border-radius: var(--radius-lg); padding: var(--space-6); max-width: 700px; width: 95%; max-height: 85vh; overflow: auto; box-shadow: var(--shadow-lg);">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-4);">
                <h3>Merge Organizations for ${escapeHtml(domain)}</h3>
                <button onclick="closeMergeModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--color-text-secondary);">&times;</button>
              </div>

              <p style="margin-bottom: var(--space-4); color: var(--color-text-secondary);">
                Select which organization should be the <strong>primary</strong> (kept). All others will be merged into it.
              </p>

              <div style="display: flex; flex-direction: column; gap: var(--space-3); margin-bottom: var(--space-4);">
                ${orgs.map((org, i) => {
                  const memberNames = (org.members || []).slice(0, 3).map(m => {
                    const name = m.firstName || m.lastName
                      ? `${m.firstName || ''} ${m.lastName || ''}`.trim()
                      : m.email;
                    return escapeHtml(name);
                  });
                  const remainingMembers = Math.max(0, (org.member_count || 0) - memberNames.length);

                  return `
                  <label style="display: flex; align-items: start; gap: var(--space-3); padding: var(--space-3); border: 2px solid var(--color-border); border-radius: var(--radius-md); cursor: pointer;" class="merge-org-option" data-org-id="${org.workos_organization_id || org.id}">
                    <input type="radio" name="primaryOrg" value="${org.workos_organization_id || org.id}" ${i === 0 ? 'checked' : ''} style="margin-top: 4px;">
                    <div style="flex: 1;">
                      <div style="font-weight: var(--font-semibold);">${escapeHtml(org.name)}</div>
                      <div style="font-size: var(--text-xs); color: var(--color-text-muted);">
                        ${org.member_count || 0} members
                        ${org.subscription_status ? ` • ${escapeHtml(org.subscription_status)}` : ''}
                        ${org.company_type ? ` • ${escapeHtml(org.company_type)}` : ''}
                      </div>
                      ${memberNames.length > 0 ? `
                        <div style="font-size: var(--text-xs); color: var(--color-text-secondary); margin-top: var(--space-1);">
                          ${memberNames.join(', ')}${remainingMembers > 0 ? `, +${remainingMembers} more` : ''}
                        </div>
                      ` : ''}
                    </div>
                    ${i === 0 ? '<span style="font-size: var(--text-xs); background: var(--color-success-100); color: var(--color-success-700); padding: 2px 8px; border-radius: var(--radius-full);">Recommended</span>' : ''}
                  </label>
                `}).join('')}
              </div>

              <div style="background: var(--color-warning-50); border: 1px solid var(--color-warning-200); border-radius: var(--radius-md); padding: var(--space-3); margin-bottom: var(--space-4);">
                <strong style="color: var(--color-warning-700);">Warning:</strong>
                <span style="color: var(--color-warning-800);">Merging cannot be undone. All data from secondary organizations will be moved to the primary.</span>
              </div>

              <div style="display: flex; justify-content: space-between;">
                <button class="btn btn-secondary" onclick="closeMergeModal()">Cancel</button>
                <button class="btn btn-primary" id="previewMergeBtn" data-org-ids="${orgs.map(o => encodeURIComponent(o.workos_organization_id || o.id)).join(',')}">
                  Preview Merge
                </button>
              </div>
            </div>
          </div>
        `;

        // Add click handler for preview merge button
        document.getElementById('previewMergeBtn').addEventListener('click', function() {
          const orgIds = this.dataset.orgIds.split(',').map(decodeURIComponent).join(',');
          executeMergeFromModal(orgIds);
        });

        // Add click handlers for radio buttons to update styling
        document.querySelectorAll('.merge-org-option').forEach(label => {
          label.addEventListener('click', () => {
            document.querySelectorAll('.merge-org-option').forEach(l => {
              l.style.borderColor = 'var(--color-border)';
            });
            label.style.borderColor = 'var(--color-brand)';
          });
        });

        // Initialize first option as selected
        const firstOption = document.querySelector('.merge-org-option');
        if (firstOption) firstOption.style.borderColor = 'var(--color-brand)';

      } catch (error) {
        console.error('Error loading merge preview:', error);
        mergeModalElement.innerHTML = `
          <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-surface-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div style="background: var(--color-bg-card); border-radius: var(--radius-lg); padding: var(--space-6); max-width: 500px; width: 95%;">
              <h3 style="color: var(--color-error-600);">Error</h3>
              <p>Failed to load organization details: ${escapeHtml(error.message)}</p>
              <button class="btn btn-secondary" onclick="closeMergeModal()">Close</button>
            </div>
          </div>
        `;
      }
    }

    async function executeMergeFromModal(allOrgIds) {
      const primaryOrgId = document.querySelector('input[name="primaryOrg"]:checked')?.value;
      if (!primaryOrgId) {
        alert('Please select a primary organization');
        return;
      }

      const orgIds = allOrgIds.split(',');
      const secondaryOrgIds = orgIds.filter(id => id !== primaryOrgId);

      if (secondaryOrgIds.length === 0) {
        alert('No organizations to merge');
        return;
      }

      // Preview the first merge
      const secondaryOrgId = secondaryOrgIds[0];

      try {
        const response = await fetch(`/api/admin/cleanup/preview-merge?primary=${primaryOrgId}&secondary=${secondaryOrgId}`);
        if (!response.ok) throw new Error('Failed to load preview');
        const preview = await response.json();

        const warningsHtml = preview.warnings.length > 0 ? `
          <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-warning-50); border: 1px solid var(--color-warning-200); border-radius: var(--radius-md);">
            <strong style="color: var(--color-warning-700);">Warnings:</strong>
            <ul style="margin: var(--space-2) 0 0 var(--space-4);">
              ${preview.warnings.map(w => `<li>${escapeHtml(w)}</li>`).join('')}
            </ul>
          </div>
        ` : '';

        const changesHtml = preview.estimated_changes.length > 0 ? `
          <div style="margin-bottom: var(--space-4);">
            <strong>Data to be moved:</strong>
            <table style="width: 100%; margin-top: var(--space-2); border-collapse: collapse;">
              <thead>
                <tr style="background: var(--color-bg-subtle);">
                  <th style="padding: var(--space-2); text-align: left; border-bottom: 1px solid var(--color-border);">Table</th>
                  <th style="padding: var(--space-2); text-align: right; border-bottom: 1px solid var(--color-border);">Rows</th>
                </tr>
              </thead>
              <tbody>
                ${preview.estimated_changes.map(c => `
                  <tr>
                    <td style="padding: var(--space-2); border-bottom: 1px solid var(--color-border);">${escapeHtml(c.table_name)}</td>
                    <td style="padding: var(--space-2); text-align: right; border-bottom: 1px solid var(--color-border);">${c.rows_to_move}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : '<p>No data to move - secondary organization appears empty.</p>';

        mergeModalElement.innerHTML = `
          <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-surface-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div style="background: var(--color-bg-card); border-radius: var(--radius-lg); padding: var(--space-6); max-width: 900px; width: 95%; max-height: 85vh; overflow: auto; box-shadow: var(--shadow-lg);">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-4);">
                <h3>Merge Preview${secondaryOrgIds.length > 1 ? ` (1 of ${secondaryOrgIds.length})` : ''}</h3>
                <button onclick="closeMergeModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--color-text-secondary);">&times;</button>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
                <div style="padding: var(--space-4); background: var(--color-success-50); border: 2px solid var(--color-success-300); border-radius: var(--radius-md);">
                  <div style="font-size: var(--text-xs); color: var(--color-success-700); font-weight: var(--font-semibold); margin-bottom: var(--space-1);">PRIMARY (keep)</div>
                  <div style="font-size: var(--text-lg); font-weight: var(--font-semibold);">${escapeHtml(preview.primary_org.name)}</div>
                  <div style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-top: var(--space-2);">
                    <div><strong>Members:</strong> ${preview.primary_org.member_count || 0}</div>
                    ${preview.primary_org.company_type ? `<div><strong>Type:</strong> ${escapeHtml(preview.primary_org.company_type)}</div>` : ''}
                    ${preview.primary_org.prospect_status ? `<div><strong>Status:</strong> ${escapeHtml(preview.primary_org.prospect_status)}</div>` : ''}
                    ${preview.primary_org.created_by ? `<div><strong>Created by:</strong> ${escapeHtml(preview.primary_org.created_by)}</div>` : ''}
                    ${preview.primary_org.has_enrichment ? `<div style="color: var(--color-success-600);">Has enrichment data</div>` : ''}
                    ${preview.primary_org.has_notes ? `<div style="color: var(--color-brand);">Has admin notes</div>` : ''}
                  </div>
                </div>

                <div style="padding: var(--space-4); background: var(--color-error-50); border: 2px solid var(--color-error-300); border-radius: var(--radius-md);">
                  <div style="font-size: var(--text-xs); color: var(--color-error-700); font-weight: var(--font-semibold); margin-bottom: var(--space-1);">SECONDARY (delete)</div>
                  <div style="font-size: var(--text-lg); font-weight: var(--font-semibold);">${escapeHtml(preview.secondary_org.name)}</div>
                  <div style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-top: var(--space-2);">
                    <div><strong>Members:</strong> ${preview.secondary_org.member_count || 0}</div>
                    ${preview.secondary_org.company_type ? `<div><strong>Type:</strong> ${escapeHtml(preview.secondary_org.company_type)}</div>` : ''}
                    ${preview.secondary_org.prospect_status ? `<div><strong>Status:</strong> ${escapeHtml(preview.secondary_org.prospect_status)}</div>` : ''}
                    ${preview.secondary_org.created_by ? `<div><strong>Created by:</strong> ${escapeHtml(preview.secondary_org.created_by)}</div>` : ''}
                    ${preview.secondary_org.has_enrichment ? `<div style="color: var(--color-success-600);">Has enrichment data</div>` : ''}
                    ${preview.secondary_org.has_notes ? `<div style="color: var(--color-brand);">Has admin notes</div>` : ''}
                  </div>
                </div>
              </div>

              ${warningsHtml}
              ${changesHtml}

              <div style="margin-top: var(--space-4); display: flex; justify-content: space-between;">
                <button class="btn btn-secondary" onclick="closeMergeModal()">Cancel</button>
                <button class="btn btn-primary" id="confirmMergeBtn" style="background: var(--color-error-600);"
                        data-primary-id="${encodeURIComponent(primaryOrgId)}"
                        data-secondary-id="${encodeURIComponent(secondaryOrgId)}"
                        data-remaining-ids="${secondaryOrgIds.slice(1).map(encodeURIComponent).join(',')}">
                  Confirm Merge
                </button>
              </div>
            </div>
          </div>
        `;

        // Add click handler for confirm merge button
        document.getElementById('confirmMergeBtn').addEventListener('click', function() {
          const primaryId = decodeURIComponent(this.dataset.primaryId);
          const secondaryId = decodeURIComponent(this.dataset.secondaryId);
          const remainingIds = this.dataset.remainingIds ? this.dataset.remainingIds.split(',').map(decodeURIComponent).join(',') : '';
          confirmMerge(primaryId, secondaryId, remainingIds);
        });
      } catch (error) {
        alert('Failed to load merge preview: ' + error.message);
      }
    }

    async function confirmMerge(primaryOrgId, secondaryOrgId, remainingOrgIds) {
      // Disable all buttons immediately to prevent double-clicks
      document.querySelectorAll('#mergeModal button, #confirmMergeBtn, #continueMergeBtn').forEach(btn => {
        btn.disabled = true;
      });

      if (!confirm('Are you sure you want to merge these organizations? This cannot be undone.')) {
        // Re-enable buttons if user cancels
        document.querySelectorAll('#mergeModal button, #confirmMergeBtn, #continueMergeBtn').forEach(btn => {
          btn.disabled = false;
        });
        return;
      }

      mergeModalElement.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-surface-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000;">
          <div style="background: var(--color-bg-card); border-radius: var(--radius-lg); padding: var(--space-6); max-width: 600px; width: 90%;">
            <h3 style="margin-bottom: var(--space-4);">Merging organizations...</h3>
            <div style="color: var(--color-text-muted);">Please wait...</div>
          </div>
        </div>
      `;

      try {
        const response = await fetch('/api/admin/cleanup/merge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ primary_org_id: primaryOrgId, secondary_org_id: secondaryOrgId })
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.message || 'Merge failed');
        }

        const result = await response.json();
        const totalMoved = result.tables_merged.reduce((sum, t) => sum + t.rows_moved, 0);

        // Check if there are more orgs to merge
        if (remainingOrgIds && remainingOrgIds.length > 0) {
          const remainingCount = remainingOrgIds.split(',').filter(Boolean).length;
          mergeModalElement.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-surface-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000;">
              <div style="background: var(--color-bg-card); border-radius: var(--radius-lg); padding: var(--space-6); max-width: 600px; width: 90%;">
                <h3 style="color: var(--color-success-600); margin-bottom: var(--space-4);">Merge Complete</h3>
                <p>Successfully merged. ${totalMoved} records moved.</p>
                <p style="margin-top: var(--space-3);">There are ${remainingCount} more organization(s) to merge.</p>
                <div style="margin-top: var(--space-4); display: flex; justify-content: space-between;">
                  <button class="btn btn-secondary" onclick="closeMergeModal(); loadDomainHealth();">Done for Now</button>
                  <button class="btn btn-primary" id="continueMergeBtn"
                          data-org-ids="${encodeURIComponent(primaryOrgId)},${remainingOrgIds.split(',').map(encodeURIComponent).join(',')}">
                    Continue Merging
                  </button>
                </div>
              </div>
            </div>
          `;

          // Add click handler for continue merge button
          document.getElementById('continueMergeBtn').addEventListener('click', function() {
            const orgIds = this.dataset.orgIds.split(',').map(decodeURIComponent).join(',');
            executeMergeFromModal(orgIds);
          });
        } else {
          mergeModalElement.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-surface-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000;">
              <div style="background: var(--color-bg-card); border-radius: var(--radius-lg); padding: var(--space-6); max-width: 600px; width: 90%;">
                <h3 style="color: var(--color-success-600); margin-bottom: var(--space-4);">All Merges Complete</h3>
                <p>Successfully merged all organizations. ${totalMoved} records moved in this merge.</p>
                <div style="margin-top: var(--space-4); text-align: right;">
                  <button class="btn btn-primary" onclick="closeMergeModal(); loadDomainHealth();">Done</button>
                </div>
              </div>
            </div>
          `;
        }
      } catch (error) {
        alert('Merge failed: ' + error.message);
        closeMergeModal();
        loadDomainHealth();
      }
    }

    function closeMergeModal() {
      if (mergeModalElement) {
        mergeModalElement.innerHTML = '';
      }
    }

    // Initialize
    loadDomainHealth();
  </script>
</body>
</html>
