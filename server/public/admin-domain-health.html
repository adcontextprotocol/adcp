<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Domain Health - Admin - AgenticAdvertising.org</title>
  <link rel="stylesheet" href="/design-system.css">
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <style>
    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-wide);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }
    h1 { margin-bottom: var(--space-2); color: var(--color-text-heading); }
    .subtitle { color: var(--color-text-secondary); margin-bottom: var(--space-5); }

    /* Summary Cards */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }
    .summary-card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-5);
      box-shadow: var(--shadow-xs);
      border-left: 4px solid var(--color-gray-300);
    }
    .summary-card.good { border-left-color: var(--color-success-500); }
    .summary-card.warning { border-left-color: var(--color-warning-500); }
    .summary-card.error { border-left-color: var(--color-error-500); }
    .summary-card .label {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
    }
    .summary-card .value {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
    }
    .summary-card .detail {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }

    /* Section Headers */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }
    .section-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .section-badge {
      background: var(--color-error-100);
      color: var(--color-error-700);
      padding: var(--space-0.5) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
    }
    .section-badge.success {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .section-description {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-4);
    }

    /* Issue Tables */
    .issue-table {
      width: 100%;
      border-collapse: collapse;
    }
    .issue-table th {
      text-align: left;
      padding: var(--space-3) var(--space-4);
      background: var(--color-gray-50);
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      color: var(--color-text-secondary);
      border-bottom: var(--border-1) solid var(--color-border);
    }
    .issue-table td {
      padding: var(--space-3) var(--space-4);
      border-bottom: var(--border-1) solid var(--color-border);
      font-size: var(--text-sm);
      vertical-align: top;
    }
    .issue-table tr:hover {
      background: var(--color-gray-50);
    }
    .domain-name {
      font-weight: var(--font-semibold);
      color: var(--color-brand);
    }
    .user-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .user-list li {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      padding: var(--space-0.5) 0;
    }
    .user-count {
      background: var(--color-gray-100);
      color: var(--color-text-secondary);
      padding: var(--space-0.5) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
    }

    /* Action Buttons */
    .btn {
      padding: var(--space-1.5) var(--space-3);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-xs);
      cursor: pointer;
      transition: var(--transition-all);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
    }
    .btn-primary {
      background: var(--color-brand);
      color: white;
    }
    .btn-primary:hover {
      background: var(--color-primary-700);
    }
    .btn-secondary {
      background: var(--color-gray-100);
      color: var(--color-text-heading);
    }
    .btn-secondary:hover {
      background: var(--color-gray-200);
    }
    .btn-sm {
      padding: var(--space-1) var(--space-2);
      font-size: var(--text-xs);
    }

    /* Organization Links */
    .org-link {
      color: var(--color-brand);
      text-decoration: none;
    }
    .org-link:hover {
      text-decoration: underline;
    }
    .org-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .org-list li {
      padding: var(--space-1) 0;
    }

    /* Status Badges */
    .status-badge {
      display: inline-block;
      padding: var(--space-0.5) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .status-active {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .status-prospect {
      background: var(--color-warning-100);
      color: var(--color-warning-700);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--space-8);
      color: var(--color-text-muted);
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: var(--space-3);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: var(--space-12);
      color: var(--color-text-muted);
    }
  </style>
</head>
<body>
  <div id="adcp-nav"></div>

  <div id="loading" class="loading">Loading domain health data...</div>

  <div id="content" style="display: none;">
    <div class="container">
      <div class="card">
        <h1>Domain Health</h1>
        <p class="subtitle">Monitor domain coverage and data quality across the membership system</p>

        <!-- Summary Stats -->
        <div class="summary-grid" id="summaryGrid">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Orphan Domains Section -->
      <div class="card" id="orphanDomainsSection">
        <div class="section-header">
          <div>
            <div class="section-title">
              Orphan Corporate Domains
              <span class="section-badge" id="orphanBadge">0</span>
            </div>
            <p class="section-description">Corporate email domains with users but no matching organization. Create prospects for these domains.</p>
          </div>
        </div>
        <div id="orphanDomainsContent"></div>
      </div>

      <!-- Misaligned Users Section -->
      <div class="card" id="misalignedUsersSection">
        <div class="section-header">
          <div>
            <div class="section-title">
              Corporate Users in Personal Workspaces
              <span class="section-badge" id="misalignedBadge">0</span>
            </div>
            <p class="section-description">Users with company email addresses who are in personal workspaces instead of company organizations.</p>
          </div>
        </div>
        <div id="misalignedUsersContent"></div>
      </div>

      <!-- Unverified Orgs Section -->
      <div class="card" id="unverifiedOrgsSection">
        <div class="section-header">
          <div>
            <div class="section-title">
              Organizations Without Verified Domains
              <span class="section-badge" id="unverifiedBadge">0</span>
            </div>
            <p class="section-description">Organizations with members but no verified domain mapping. Verify domain ownership for these orgs.</p>
          </div>
        </div>
        <div id="unverifiedOrgsContent"></div>
      </div>

      <!-- Domain Conflicts Section -->
      <div class="card" id="domainConflictsSection">
        <div class="section-header">
          <div>
            <div class="section-title">
              Domain Conflicts
              <span class="section-badge" id="conflictsBadge">0</span>
            </div>
            <p class="section-description">Multiple organizations claiming the same email domain. Merge these duplicates.</p>
          </div>
        </div>
        <div id="domainConflictsContent"></div>
      </div>
    </div>
  </div>

  <script>
    let healthData = null;

    async function loadDomainHealth() {
      try {
        const response = await fetch('/api/admin/domain-health');
        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar?.redirectToLogin();
            return;
          }
          throw new Error('Failed to load domain health');
        }
        healthData = await response.json();
        renderDomainHealth();
      } catch (error) {
        console.error('Error loading domain health:', error);
        document.getElementById('loading').innerHTML = 'Error loading data. Please refresh.';
      }
    }

    // HTML escaping to prevent XSS
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function renderDomainHealth() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';

      renderSummary();
      renderOrphanDomains();
      renderMisalignedUsers();
      renderUnverifiedOrgs();
      renderDomainConflicts();
    }

    function renderSummary() {
      const { summary } = healthData;
      const totalIssues = summary.issues.orphan_domains + summary.issues.misaligned_users +
                          summary.issues.unverified_orgs + summary.issues.domain_conflicts;

      const grid = document.getElementById('summaryGrid');
      grid.innerHTML = `
        <div class="summary-card ${totalIssues === 0 ? 'good' : 'warning'}">
          <div class="label">Total Issues</div>
          <div class="value">${totalIssues}</div>
          <div class="detail">${totalIssues === 0 ? 'All domains healthy' : 'Needs attention'}</div>
        </div>
        <div class="summary-card">
          <div class="label">Organizations</div>
          <div class="value">${summary.total_organizations}</div>
          <div class="detail">Non-personal workspaces</div>
        </div>
        <div class="summary-card good">
          <div class="label">Verified Domains</div>
          <div class="value">${summary.verified_domains}</div>
          <div class="detail">Domains with verified ownership</div>
        </div>
        <div class="summary-card ${summary.unverified_domains > 0 ? 'warning' : 'good'}">
          <div class="label">Unverified Domains</div>
          <div class="value">${summary.unverified_domains}</div>
          <div class="detail">Domains pending verification</div>
        </div>
      `;
    }

    function renderOrphanDomains() {
      const { orphan_domains } = healthData;
      const badge = document.getElementById('orphanBadge');
      const content = document.getElementById('orphanDomainsContent');

      badge.textContent = orphan_domains.length;
      badge.className = orphan_domains.length === 0 ? 'section-badge success' : 'section-badge';

      if (orphan_domains.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#10003;</div>
            <p>No orphan domains found. All corporate users are mapped to organizations.</p>
          </div>
        `;
        return;
      }

      content.innerHTML = `
        <table class="issue-table">
          <thead>
            <tr>
              <th>Domain</th>
              <th>Users</th>
              <th>Sample Users</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${orphan_domains.map(d => `
              <tr>
                <td><span class="domain-name">${escapeHtml(d.domain)}</span></td>
                <td><span class="user-count">${d.user_count}</span></td>
                <td>
                  <ul class="user-list">
                    ${d.users.slice(0, 3).map(u => `<li>${escapeHtml(u.email)}</li>`).join('')}
                    ${d.user_count > 3 ? `<li>... and ${d.user_count - 3} more</li>` : ''}
                  </ul>
                </td>
                <td>
                  <a href="/admin/prospects?create=${encodeURIComponent(d.domain)}" class="btn btn-primary btn-sm">Create Prospect</a>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderMisalignedUsers() {
      const { misaligned_users } = healthData;
      const badge = document.getElementById('misalignedBadge');
      const content = document.getElementById('misalignedUsersContent');

      const totalUsers = misaligned_users.reduce((sum, d) => sum + d.user_count, 0);
      badge.textContent = totalUsers;
      badge.className = totalUsers === 0 ? 'section-badge success' : 'section-badge';

      if (misaligned_users.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#10003;</div>
            <p>No misaligned users found. All corporate users are in proper company workspaces.</p>
          </div>
        `;
        return;
      }

      content.innerHTML = `
        <table class="issue-table">
          <thead>
            <tr>
              <th>Domain</th>
              <th>Users</th>
              <th>User Details</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${misaligned_users.map(d => `
              <tr>
                <td><span class="domain-name">${escapeHtml(d.domain)}</span></td>
                <td><span class="user-count">${d.user_count}</span></td>
                <td>
                  <ul class="user-list">
                    ${d.users.slice(0, 3).map(u => `
                      <li>${escapeHtml(u.email)} (${escapeHtml(u.first_name || '')} ${escapeHtml(u.last_name || '')})</li>
                    `).join('')}
                    ${d.user_count > 3 ? `<li>... and ${d.user_count - 3} more</li>` : ''}
                  </ul>
                </td>
                <td>
                  <a href="/admin/prospects?create=${encodeURIComponent(d.domain)}" class="btn btn-secondary btn-sm">Create Org</a>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderUnverifiedOrgs() {
      const { unverified_orgs } = healthData;
      const badge = document.getElementById('unverifiedBadge');
      const content = document.getElementById('unverifiedOrgsContent');

      badge.textContent = unverified_orgs.length;
      badge.className = unverified_orgs.length === 0 ? 'section-badge success' : 'section-badge';

      if (unverified_orgs.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#10003;</div>
            <p>All organizations with users have verified domains.</p>
          </div>
        `;
        return;
      }

      content.innerHTML = `
        <table class="issue-table">
          <thead>
            <tr>
              <th>Organization</th>
              <th>Users</th>
              <th>User Domains</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${unverified_orgs.map(o => `
              <tr>
                <td>
                  <a href="/admin/org/${encodeURIComponent(o.org_id)}" class="org-link">${escapeHtml(o.name)}</a>
                  ${o.email_domain ? `<br><small style="color: var(--color-text-muted);">${escapeHtml(o.email_domain)}</small>` : ''}
                </td>
                <td><span class="user-count">${o.user_count}</span></td>
                <td>
                  <ul class="user-list">
                    ${o.user_domains.slice(0, 3).map(d => `<li>${escapeHtml(d)}</li>`).join('')}
                  </ul>
                </td>
                <td>
                  <span class="status-badge ${o.subscription_status === 'active' ? 'status-active' : 'status-prospect'}">
                    ${escapeHtml(o.subscription_status || 'prospect')}
                  </span>
                </td>
                <td>
                  <a href="/admin/org/${encodeURIComponent(o.org_id)}" class="btn btn-secondary btn-sm">View Org</a>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderDomainConflicts() {
      const { domain_conflicts } = healthData;
      const badge = document.getElementById('conflictsBadge');
      const content = document.getElementById('domainConflictsContent');

      badge.textContent = domain_conflicts.length;
      badge.className = domain_conflicts.length === 0 ? 'section-badge success' : 'section-badge';

      if (domain_conflicts.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#10003;</div>
            <p>No domain conflicts found. Each domain maps to exactly one organization.</p>
          </div>
        `;
        return;
      }

      content.innerHTML = `
        <table class="issue-table">
          <thead>
            <tr>
              <th>Domain</th>
              <th>Organizations</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${domain_conflicts.map(c => `
              <tr>
                <td>
                  <span class="domain-name">${escapeHtml(c.domain)}</span>
                  <br><small style="color: var(--color-text-muted);">${c.org_count} organizations</small>
                </td>
                <td>
                  <ul class="org-list">
                    ${c.organizations.map(o => `
                      <li>
                        <a href="/admin/org/${encodeURIComponent(o.id)}" class="org-link">${escapeHtml(o.name)}</a>
                        <span class="status-badge ${o.subscription_status === 'active' ? 'status-active' : 'status-prospect'}">
                          ${escapeHtml(o.subscription_status || 'prospect')}
                        </span>
                      </li>
                    `).join('')}
                  </ul>
                </td>
                <td>
                  <button class="btn btn-primary btn-sm" onclick="alert('Use Addie to merge: merge_organizations')">
                    Merge Orgs
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // Initialize
    loadDomainHealth();
  </script>
</body>
</html>
