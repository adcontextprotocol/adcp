<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Domain Health - Admin - AgenticAdvertising.org</title>
  <link rel="stylesheet" href="/design-system.css">
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <style>
    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-wide);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }
    h1 { margin-bottom: var(--space-2); color: var(--color-text-heading); }
    .subtitle { color: var(--color-text-secondary); margin-bottom: var(--space-5); }

    /* Summary Cards */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }
    .summary-card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-5);
      box-shadow: var(--shadow-xs);
      border-left: 4px solid var(--color-gray-300);
    }
    .summary-card.good { border-left-color: var(--color-success-500); }
    .summary-card.warning { border-left-color: var(--color-warning-500); }
    .summary-card.error { border-left-color: var(--color-error-500); }
    .summary-card .label {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
    }
    .summary-card .value {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
    }
    .summary-card .detail {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }

    /* Section Headers */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }
    .section-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .section-badge {
      background: var(--color-error-100);
      color: var(--color-error-700);
      padding: var(--space-0.5) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
    }
    .section-badge.success {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .section-description {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-4);
    }

    /* Issue Tables */
    .issue-table {
      width: 100%;
      border-collapse: collapse;
    }
    .issue-table th {
      text-align: left;
      padding: var(--space-3) var(--space-4);
      background: var(--color-gray-50);
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      color: var(--color-text-secondary);
      border-bottom: var(--border-1) solid var(--color-border);
    }
    .issue-table td {
      padding: var(--space-3) var(--space-4);
      border-bottom: var(--border-1) solid var(--color-border);
      font-size: var(--text-sm);
      vertical-align: top;
    }
    .issue-table tr:hover {
      background: var(--color-gray-50);
    }
    .domain-name {
      font-weight: var(--font-semibold);
      color: var(--color-brand);
    }
    .user-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .user-list li {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      padding: var(--space-0.5) 0;
    }
    .claimed-tag {
      display: inline-block;
      margin-left: var(--space-1);
      padding: var(--space-0.5) var(--space-1);
      background: var(--color-warning-100);
      color: var(--color-warning-700);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
    }
    .claimed-tag:hover {
      background: var(--color-warning-50);
    }
    .personal-tag {
      display: inline-block;
      margin-left: var(--space-1);
      padding: var(--space-0.5) var(--space-1);
      background: var(--color-gray-100);
      color: var(--color-text-muted);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
    }
    .user-count {
      background: var(--color-gray-100);
      color: var(--color-text-secondary);
      padding: var(--space-0.5) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
    }

    /* Action Buttons */
    .btn {
      padding: var(--space-1.5) var(--space-3);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-xs);
      cursor: pointer;
      transition: var(--transition-all);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
    }
    .btn-primary {
      background: var(--color-brand);
      color: white;
    }
    .btn-primary:hover {
      background: var(--color-primary-700);
    }
    .btn-secondary {
      background: var(--color-gray-100);
      color: var(--color-text-heading);
    }
    .btn-secondary:hover {
      background: var(--color-gray-200);
    }
    .btn-sm {
      padding: var(--space-1) var(--space-2);
      font-size: var(--text-xs);
    }
    .btn-success {
      background: var(--color-success-500);
      color: white;
    }
    .btn-error {
      background: var(--color-error-500);
      color: white;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Organization Links */
    .org-link {
      color: var(--color-brand);
      text-decoration: none;
    }
    .org-link:hover {
      text-decoration: underline;
    }
    .org-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .org-list li {
      padding: var(--space-1) 0;
    }

    /* Status Badges */
    .status-badge {
      display: inline-block;
      padding: var(--space-0.5) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .status-active {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .status-prospect {
      background: var(--color-warning-100);
      color: var(--color-warning-700);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--space-8);
      color: var(--color-text-muted);
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: var(--space-3);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: var(--space-12);
      color: var(--color-text-muted);
    }
  </style>
</head>
<body>
  <div id="adcp-nav"></div>

  <div id="loading" class="loading">Loading domain health data...</div>

  <div id="content" style="display: none;">
    <div class="container">
      <div class="card">
        <h1>Domain Health</h1>
        <p class="subtitle">Monitor domain coverage and data quality across the membership system</p>

        <!-- Summary Stats -->
        <div class="summary-grid" id="summaryGrid">
          <!-- Populated by JS -->
        </div>

        <!-- Maintenance Actions -->
        <div style="margin-top: var(--space-5); padding-top: var(--space-5); border-top: 1px solid var(--color-border);">
          <div style="display: flex; align-items: center; gap: var(--space-4);">
            <div style="flex: 1;">
              <div style="font-weight: var(--font-semibold); color: var(--color-text-heading);">
                Backfill Slack User Links
                <span id="backfillCount" style="margin-left: var(--space-2); padding: var(--space-0.5) var(--space-2); background: var(--color-gray-100); color: var(--color-text-secondary); border-radius: var(--radius-full); font-size: var(--text-xs); font-weight: var(--font-normal);">loading...</span>
              </div>
              <div style="font-size: var(--text-sm); color: var(--color-text-secondary);">Link unmapped Slack users to existing organizations based on their email domain</div>
            </div>
            <button class="btn btn-secondary" id="backfillSlackBtn" disabled>Run Backfill</button>
          </div>
          <div id="backfillPreview" style="margin-top: var(--space-3); display: none;"></div>
          <div id="backfillResult" style="margin-top: var(--space-3); display: none;"></div>
        </div>

        <!-- Add Domain Users as Members -->
        <div style="margin-top: var(--space-5); padding-top: var(--space-5); border-top: 1px solid var(--color-border);">
          <div style="display: flex; align-items: center; gap: var(--space-4);">
            <div style="flex: 1;">
              <div style="font-weight: var(--font-semibold); color: var(--color-text-heading);">
                Auto-Add Domain Users as Members
                <span id="memberBackfillCount" style="margin-left: var(--space-2); padding: var(--space-0.5) var(--space-2); background: var(--color-gray-100); color: var(--color-text-secondary); border-radius: var(--radius-full); font-size: var(--text-xs); font-weight: var(--font-normal);">loading...</span>
              </div>
              <div style="font-size: var(--text-sm); color: var(--color-text-secondary);">Add users with verified domain emails directly as organization members (they have accounts but aren't members yet)</div>
            </div>
            <button class="btn btn-primary" id="memberBackfillBtn" disabled>Add All Members</button>
          </div>
          <div id="memberBackfillPreview" style="margin-top: var(--space-3); display: none;"></div>
          <div id="memberBackfillResult" style="margin-top: var(--space-3); display: none;"></div>
        </div>
      </div>

      <!-- Orphan Domains Section -->
      <div class="card" id="orphanDomainsSection">
        <div class="section-header">
          <div>
            <div class="section-title">
              Unlinked Corporate Domains
              <span class="section-badge" id="orphanBadge">0</span>
            </div>
            <p class="section-description">Corporate email domains not linked to any organization. Link these domains to consolidate users.</p>
          </div>
        </div>
        <div id="orphanDomainsContent"></div>
      </div>

      <!-- Misaligned Users Section -->
      <div class="card" id="misalignedUsersSection">
        <div class="section-header">
          <div>
            <div class="section-title">
              Users Who Should Join Their Company
              <span class="section-badge" id="misalignedBadge">0</span>
            </div>
            <p class="section-description">Users in personal workspaces whose company already has an organization. Consider inviting them to join.</p>
          </div>
          <button class="btn btn-primary" id="linkAllMisalignedBtn" style="display: none;">Link All</button>
        </div>
        <div id="misalignedUsersContent"></div>
      </div>

      <!-- Unverified Orgs Section -->
      <div class="card" id="unverifiedOrgsSection">
        <div class="section-header">
          <div>
            <div class="section-title">
              Organizations Without Verified Domains
              <span class="section-badge" id="unverifiedBadge">0</span>
            </div>
            <p class="section-description">Organizations with members but no verified domain mapping. Verify domain ownership for these orgs.</p>
          </div>
        </div>
        <div id="unverifiedOrgsContent"></div>
      </div>

      <!-- Domain Conflicts Section -->
      <div class="card" id="domainConflictsSection">
        <div class="section-header">
          <div>
            <div class="section-title">
              Domain Conflicts
              <span class="section-badge" id="conflictsBadge">0</span>
            </div>
            <p class="section-description">Multiple organizations claiming the same email domain. Merge these duplicates.</p>
          </div>
        </div>
        <div id="domainConflictsContent"></div>
      </div>

      <!-- Related Domains Section -->
      <div class="card" id="relatedDomainsSection">
        <div class="section-header">
          <div>
            <div class="section-title">
              Related Organizations (Potential Duplicates)
              <span class="section-badge" id="relatedBadge">0</span>
            </div>
            <p class="section-description">Organizations that may be related based on similar domain names (e.g., yahoo.com and yahooinc.com). Consider merging these.</p>
          </div>
        </div>
        <div id="relatedDomainsContent"></div>
      </div>

      <!-- Similar Names Section -->
      <div class="card" id="similarNamesSection">
        <div class="section-header">
          <div>
            <div class="section-title">
              Similar Organization Names
              <span class="section-badge" id="similarNamesBadge">0</span>
            </div>
            <p class="section-description">Organizations with similar names that may be duplicates. Review and merge if they represent the same company.</p>
          </div>
        </div>
        <div id="similarNamesContent"></div>
      </div>
    </div>
  </div>

  <script>
    let healthData = null;

    async function loadDomainHealth() {
      try {
        const response = await fetch('/api/admin/domain-health');
        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar?.redirectToLogin();
            return;
          }
          throw new Error('Failed to load domain health');
        }
        healthData = await response.json();
        renderDomainHealth();
      } catch (error) {
        console.error('Error loading domain health:', error);
        document.getElementById('loading').innerHTML = 'Error loading data. Please refresh.';
      }
    }

    // HTML escaping to prevent XSS
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Validate org ID format (alphanumeric, underscores, hyphens only)
    function isValidOrgId(id) {
      return /^[a-zA-Z0-9_-]+$/.test(id);
    }

    // Safe org ID for use in JS strings - validates and returns or throws
    function safeOrgId(id) {
      if (!isValidOrgId(id)) {
        throw new Error('Invalid org ID format');
      }
      return id;
    }

    function renderDomainHealth() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';

      renderSummary();
      renderOrphanDomains();
      renderMisalignedUsers();
      renderUnverifiedOrgs();
      renderDomainConflicts();
      renderRelatedDomains();
      renderSimilarNames();

      // Set up event delegation for merge buttons (avoiding inline onclick for XSS safety)
      document.querySelectorAll('.merge-orgs-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const orgIds = btn.dataset.orgIds.split(',').map(decodeURIComponent);
          const domain = decodeURIComponent(btn.dataset.domain || btn.dataset.baseName || '');
          showMergeModal(orgIds, domain);
        });
      });

      // Set up event handlers for link domain buttons
      document.querySelectorAll('.link-domain-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const orgId = btn.dataset.orgId;
          const orgName = btn.dataset.orgName;
          const domain = btn.dataset.domain;
          linkDomainToOrg(btn, orgId, orgName, domain);
        });
      });

      // Set up event handlers for link domain selects
      document.querySelectorAll('.link-domain-select').forEach(select => {
        select.addEventListener('change', () => {
          const orgId = select.value;
          if (!orgId) return;
          const option = select.options[select.selectedIndex];
          const orgName = option.dataset.orgName;
          const domain = select.dataset.domain;
          linkDomainToOrg(select, orgId, orgName, domain);
        });
      });

      // Set up event handlers for mark as personal buttons
      document.querySelectorAll('.mark-personal-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const domain = btn.dataset.domain;
          markDomainAsPersonal(btn, domain);
        });
      });

      // Set up event handlers for create prospect buttons
      document.querySelectorAll('.create-prospect-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const domain = btn.dataset.domain;
          createProspectFromDomain(btn, domain);
        });
      });
    }

    async function markDomainAsPersonal(button, domain) {
      const reason = prompt(`Mark "${domain}" as a personal domain?\n\nEnter a reason (e.g., "alumni email", "forwarding service"):`, 'personal email domain');
      if (reason === null) return; // User cancelled

      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'Saving...';

      try {
        const response = await fetch('/api/admin/personal-domains', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ domain, reason: reason || 'personal email domain' })
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar?.redirectToLogin();
            return;
          }
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Failed to mark domain as personal');
        }

        // Success
        button.classList.remove('btn-secondary');
        button.classList.add('btn-success');
        button.textContent = 'Marked!';

        // Reload after brief delay
        setTimeout(() => {
          loadDomainHealth();
        }, 1000);
      } catch (error) {
        button.classList.remove('btn-secondary');
        button.classList.add('btn-error');
        button.textContent = 'Failed';
        button.title = error.message;

        setTimeout(() => {
          button.disabled = false;
          button.classList.remove('btn-error');
          button.classList.add('btn-secondary');
          button.textContent = originalText;
          button.title = '';
        }, 3000);
      }
    }

    async function linkDomainToOrg(element, orgId, orgName, domain) {
      // Validate orgId format before using in URL
      if (!isValidOrgId(orgId)) {
        alert('Invalid organization ID format');
        return;
      }

      const originalText = element.tagName === 'BUTTON' ? element.textContent : null;
      const originalDisabled = element.disabled;

      // Disable and show loading state
      element.disabled = true;
      if (element.tagName === 'BUTTON') {
        element.textContent = 'Linking...';
      }

      try {
        const response = await fetch(`/api/admin/organizations/${encodeURIComponent(orgId)}/domains`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ domain: domain.toLowerCase(), is_primary: true })
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar?.redirectToLogin();
            return;
          }
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || errorData.error || 'Failed to link domain');
        }

        // Success - show success state briefly then reload data
        element.classList.remove('btn-primary');
        element.classList.add('btn-success');
        if (element.tagName === 'BUTTON') {
          element.textContent = 'Linked!';
        } else {
          // For select, reset and disable
          element.value = '';
          const firstOption = element.options[0];
          if (firstOption) firstOption.textContent = 'Linked!';
        }

        // Reload after brief delay to show success
        setTimeout(() => {
          loadDomainHealth();
        }, 1000);
      } catch (error) {
        // Show error state
        element.classList.remove('btn-primary');
        element.classList.add('btn-error');
        if (element.tagName === 'BUTTON') {
          element.textContent = 'Failed';
          element.title = error.message;
        } else {
          element.value = '';
          const firstOption = element.options[0];
          if (firstOption) firstOption.textContent = 'Failed: ' + error.message;
        }

        // Reset after delay
        setTimeout(() => {
          element.disabled = originalDisabled;
          element.classList.remove('btn-error');
          element.classList.add('btn-primary');
          if (element.tagName === 'BUTTON') {
            element.textContent = originalText;
            element.title = '';
          } else {
            const firstOption = element.options[0];
            if (firstOption) firstOption.textContent = 'Link to org...';
          }
        }, 3000);
      }
    }

    async function createProspectFromDomain(button, domain) {
      // Validate domain format
      if (!domain || !/^[a-z0-9][a-z0-9.-]*\.[a-z]{2,}$/i.test(domain)) {
        console.error('Invalid domain format:', domain);
        return;
      }

      const originalText = button.textContent;
      const wasPrimary = button.classList.contains('btn-primary');
      button.disabled = true;
      button.textContent = 'Creating...';

      // Generate org name from domain
      const parts = domain.split('.');
      let orgName = parts
        .slice(0, -1)  // Remove TLD
        .filter(part => part.length > 2 || parts.length <= 2)  // Filter short parts like 'co' unless simple domain
        .map(part => {
          // Handle hyphens and capitalize each word
          return part.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        })
        .join(' ')
        .trim();

      // Fallback if name generation produced empty result
      if (!orgName) {
        orgName = parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
      }

      try {
        const response = await fetch('/api/admin/prospects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: orgName,
            domain: domain.toLowerCase(),
            prospect_source: 'domain_health',
            prospect_notes: 'Auto-created from Domain Health page. Users with this domain are already in the system.'
          })
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar?.redirectToLogin();
            return;
          }
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || errorData.error || 'Failed to create prospect');
        }

        const org = await response.json();

        // Success - show success state and link to org
        button.classList.remove('btn-primary', 'btn-secondary');
        button.classList.add('btn-success');
        button.textContent = 'Created!';
        button.title = `Created ${org.name}. Enrichment running in background.`;

        // Reload after brief delay to show the domain is now linked
        setTimeout(() => {
          loadDomainHealth();
        }, 1500);
      } catch (error) {
        // Show error state
        button.classList.remove('btn-primary', 'btn-secondary');
        button.classList.add('btn-error');
        button.textContent = 'Failed';
        button.title = error.message;

        // Reset after delay
        setTimeout(() => {
          button.disabled = false;
          button.classList.remove('btn-error');
          button.classList.add(wasPrimary ? 'btn-primary' : 'btn-secondary');
          button.textContent = originalText;
          button.title = '';
        }, 3000);
      }
    }

    async function addUsersToOrg(button, orgId, orgName, userIds) {
      // Validate inputs
      if (!isValidOrgId(orgId)) {
        alert('Invalid organization ID format');
        return;
      }

      if (!confirm(`Add ${userIds.length} user(s) to "${orgName}"?\n\nThis will add them to the company organization. They will keep access to their personal workspace.`)) {
        return;
      }

      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'Adding...';

      try {
        const response = await fetch(`/api/admin/organizations/${encodeURIComponent(orgId)}/add-users`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_ids: userIds })
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar?.redirectToLogin();
            return;
          }
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || errorData.error || 'Failed to add users');
        }

        const result = await response.json();

        // Success
        button.classList.remove('btn-primary');
        button.classList.add('btn-success');
        button.textContent = `Added ${result.added_count || userIds.length}!`;

        // Reload after brief delay
        setTimeout(() => {
          loadDomainHealth();
        }, 1500);
      } catch (error) {
        button.classList.remove('btn-primary');
        button.classList.add('btn-error');
        button.textContent = 'Failed';
        button.title = error.message;

        setTimeout(() => {
          button.disabled = false;
          button.classList.remove('btn-error');
          button.classList.add('btn-primary');
          button.textContent = originalText;
          button.title = '';
        }, 3000);
      }
    }

    async function linkAllMisalignedUsers(entries) {
      const totalUsers = entries.reduce((sum, d) => sum + d.user_count, 0);
      const totalOrgs = entries.length;

      if (!confirm(`Add ${totalUsers} user(s) to their ${totalOrgs} respective company org(s)?\n\nThis will add all listed users to their company organizations. They will keep access to their personal workspaces.`)) {
        return;
      }

      const linkAllBtn = document.getElementById('linkAllMisalignedBtn');
      const originalText = linkAllBtn.textContent;
      linkAllBtn.disabled = true;
      linkAllBtn.textContent = 'Linking...';

      let successCount = 0;
      let errorCount = 0;
      const errors = [];

      // Group users by target org to minimize API calls
      const usersByOrg = {};
      for (const entry of entries) {
        if (!entry.target_org_id) continue;
        if (!usersByOrg[entry.target_org_id]) {
          usersByOrg[entry.target_org_id] = {
            orgId: entry.target_org_id,
            orgName: entry.target_org_name,
            userIds: []
          };
        }
        for (const user of entry.users) {
          if (user.user_id) {
            usersByOrg[entry.target_org_id].userIds.push(user.user_id);
          }
        }
      }

      // Process each org
      for (const orgData of Object.values(usersByOrg)) {
        if (!isValidOrgId(orgData.orgId)) {
          errors.push(`Invalid org ID: ${orgData.orgId}`);
          errorCount += orgData.userIds.length;
          continue;
        }

        try {
          const response = await fetch(`/api/admin/organizations/${encodeURIComponent(orgData.orgId)}/add-users`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_ids: orgData.userIds })
          });

          if (!response.ok) {
            if (response.status === 401) {
              window.AdminSidebar?.redirectToLogin();
              return;
            }
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || errorData.error || 'Failed');
          }

          const result = await response.json();
          successCount += result.added_count || orgData.userIds.length;
          if (Array.isArray(result.errors)) {
            errors.push(...result.errors);
            errorCount += result.errors.length;
          } else if (result.errors) {
            errors.push(String(result.errors));
            errorCount++;
          }
        } catch (error) {
          errors.push(`${orgData.orgName}: ${error.message}`);
          errorCount += orgData.userIds.length;
        }
      }

      // Show result
      if (errorCount === 0) {
        linkAllBtn.classList.remove('btn-primary');
        linkAllBtn.classList.add('btn-success');
        linkAllBtn.textContent = `Linked ${successCount} users!`;
      } else {
        linkAllBtn.classList.remove('btn-primary');
        linkAllBtn.classList.add('btn-error');
        linkAllBtn.textContent = `${successCount} linked, ${errorCount} failed`;
        linkAllBtn.title = errors.join('\n');
      }

      // Reload after brief delay
      setTimeout(() => {
        loadDomainHealth();
      }, 1500);
    }

    function renderSummary() {
      const { summary, orphan_domains } = healthData;
      // Count orphan domains that have non-personal orgs (filtered version)
      const filteredOrphanCount = (orphan_domains || []).filter(d => {
        const nonPersonalOrgs = (d.existing_orgs || []).filter(o => !o.is_personal);
        return nonPersonalOrgs.length > 0;
      }).length;

      const totalIssues = filteredOrphanCount +
                          (summary.issues.misaligned_users || 0) +
                          (summary.issues.unverified_orgs || 0) +
                          (summary.issues.domain_conflicts || 0) +
                          (summary.issues.related_domains || 0) +
                          (summary.issues.similar_names || 0);

      const grid = document.getElementById('summaryGrid');
      grid.innerHTML = `
        <div class="summary-card ${totalIssues === 0 ? 'good' : 'warning'}">
          <div class="label">Total Issues</div>
          <div class="value">${totalIssues}</div>
          <div class="detail">${totalIssues === 0 ? 'All domains healthy' : 'Needs attention'}</div>
        </div>
        <div class="summary-card">
          <div class="label">Organizations</div>
          <div class="value">${summary.total_organizations}</div>
          <div class="detail">Non-personal workspaces</div>
        </div>
        <div class="summary-card good">
          <div class="label">Verified Domains</div>
          <div class="value">${summary.verified_domains}</div>
          <div class="detail">Domains with verified ownership</div>
        </div>
        <div class="summary-card ${summary.unverified_domains > 0 ? 'warning' : 'good'}">
          <div class="label">Unverified Domains</div>
          <div class="value">${summary.unverified_domains}</div>
          <div class="detail">Domains pending verification</div>
        </div>
      `;
    }

    function renderOrphanDomains() {
      const { orphan_domains } = healthData;
      const badge = document.getElementById('orphanBadge');
      const content = document.getElementById('orphanDomainsContent');

      // Filter to only show domains where users are in NON-personal orgs
      // (i.e., exclude cases where users are only in personal workspaces)
      const domainsWithCorpOrgs = (orphan_domains || []).filter(d => {
        const nonPersonalOrgs = (d.existing_orgs || []).filter(o => !o.is_personal);
        return nonPersonalOrgs.length > 0;
      });

      badge.textContent = domainsWithCorpOrgs.length;
      badge.className = domainsWithCorpOrgs.length === 0 ? 'section-badge success' : 'section-badge';

      if (domainsWithCorpOrgs.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#10003;</div>
            <p>No unlinked corporate domains found. All corporate domains are properly linked to organizations.</p>
          </div>
        `;
        return;
      }

      content.innerHTML = `
        <table class="issue-table">
          <thead>
            <tr>
              <th>Domain</th>
              <th>Users</th>
              <th>Existing Organizations</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${domainsWithCorpOrgs.map(d => {
              // Filter to non-personal orgs first
              // Sort by value: Stripe customers first, then active subscriptions, then by user count
              const scoreOrg = (o) => {
                let score = 0;
                if (o.has_stripe) score += 100;
                if (o.subscription_status === 'active') score += 50;
                score += (o.user_count || 0) * 5;
                return score;
              };
              const nonPersonalOrgs = (d.existing_orgs || [])
                .filter(o => !o.is_personal)
                .sort((a, b) => scoreOrg(b) - scoreOrg(a));
              const hasMultipleOrgs = nonPersonalOrgs.length > 1;

              return `
              <tr>
                <td><span class="domain-name">${escapeHtml(d.domain)}</span></td>
                <td><span class="user-count">${d.user_count}</span></td>
                <td>
                  <ul class="org-list">
                    ${nonPersonalOrgs.map(o => `
                      <li>
                        <a href="/admin/accounts/${o.org_id}" class="org-link">${escapeHtml(o.name)}</a>
                        <span class="user-count">${o.user_count} users</span>
                      </li>
                    `).join('')}
                  </ul>
                </td>
                <td>
                  <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                    ${nonPersonalOrgs.length === 1 ? `
                      <button class="btn btn-primary btn-sm link-domain-btn" data-org-id="${escapeHtml(nonPersonalOrgs[0].org_id)}" data-org-name="${escapeHtml(nonPersonalOrgs[0].name)}" data-domain="${escapeHtml(d.domain)}">Link to ${escapeHtml(nonPersonalOrgs[0].name)}</button>
                    ` : `
                      <select class="btn btn-sm link-domain-select" data-domain="${escapeHtml(d.domain)}" style="padding: var(--space-1) var(--space-2); cursor: pointer;">
                        <option value="">Link to org...</option>
                        ${nonPersonalOrgs.map(o => `
                          <option value="${escapeHtml(o.org_id)}" data-org-name="${escapeHtml(o.name)}">${escapeHtml(o.name)}</option>
                        `).join('')}
                      </select>
                    `}
                    ${hasMultipleOrgs ? `
                      <button class="btn btn-secondary btn-sm merge-orgs-btn" data-org-ids="${nonPersonalOrgs.map(o => encodeURIComponent(o.org_id)).join(',')}" data-domain="${encodeURIComponent(d.domain)}">Merge ${nonPersonalOrgs.length} orgs</button>
                    ` : ''}
                  </div>
                </td>
              </tr>
            `}).join('')}
          </tbody>
        </table>
      `;
    }

    function renderMisalignedUsers() {
      const { misaligned_users } = healthData;
      const badge = document.getElementById('misalignedBadge');
      const content = document.getElementById('misalignedUsersContent');
      const linkAllBtn = document.getElementById('linkAllMisalignedBtn');

      const totalUsers = misaligned_users.reduce((sum, d) => sum + d.user_count, 0);
      badge.textContent = totalUsers;
      badge.className = totalUsers === 0 ? 'section-badge success' : 'section-badge';

      // Filter to only entries that have a target org (can be linked)
      const linkableEntries = misaligned_users.filter(d => d.target_org_id);
      const linkableUsers = linkableEntries.reduce((sum, d) => sum + d.user_count, 0);

      // Show/hide Link All button
      if (linkableUsers > 0) {
        linkAllBtn.style.display = 'block';
        linkAllBtn.textContent = `Link All (${linkableUsers} users)`;
        linkAllBtn.onclick = () => linkAllMisalignedUsers(linkableEntries);
      } else {
        linkAllBtn.style.display = 'none';
      }

      if (misaligned_users.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#10003;</div>
            <p>No users found who should join their company. Personal workspace users with corporate emails are only flagged when their company already has an organization.</p>
          </div>
        `;
        return;
      }

      content.innerHTML = `
        <table class="issue-table">
          <thead>
            <tr>
              <th>Domain</th>
              <th>Users</th>
              <th>User Details</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${misaligned_users.map(d => `
              <tr>
                <td>
                  <span class="domain-name">${escapeHtml(d.domain)}</span>
                  ${d.target_org_name ? `<br><small style="color: var(--color-text-muted);">→ <a href="/admin/accounts/${escapeHtml(d.target_org_id)}" class="org-link">${escapeHtml(d.target_org_name)}</a></small>` : ''}
                </td>
                <td><span class="user-count">${d.user_count}</span></td>
                <td>
                  <ul class="user-list">
                    ${d.users.slice(0, 3).map(u => `
                      <li>${escapeHtml(u.email)} (${escapeHtml(u.first_name || '')} ${escapeHtml(u.last_name || '')})</li>
                    `).join('')}
                    ${d.user_count > 3 ? `<li>... and ${d.user_count - 3} more</li>` : ''}
                  </ul>
                </td>
                <td>
                  <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                    ${d.target_org_id ? `
                      <button class="btn btn-primary btn-sm add-to-org-btn"
                              data-domain="${escapeHtml(d.domain)}"
                              data-org-id="${escapeHtml(d.target_org_id)}"
                              data-org-name="${escapeHtml(d.target_org_name)}"
                              data-user-ids="${d.users.map(u => escapeHtml(u.user_id)).join(',')}"
                              title="Add all ${d.user_count} user(s) to ${escapeHtml(d.target_org_name)}">
                        Add to ${escapeHtml(d.target_org_name)}
                      </button>
                    ` : `
                      <button class="btn btn-secondary btn-sm create-prospect-btn" data-domain="${escapeHtml(d.domain)}">Create Prospect</button>
                    `}
                    <button class="btn btn-secondary btn-sm mark-personal-btn" data-domain="${escapeHtml(d.domain)}" title="Mark this domain as a personal email domain (not corporate)">Mark as Personal</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      // Set up event handlers for add to org buttons
      document.querySelectorAll('.add-to-org-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const orgId = btn.dataset.orgId;
          const orgName = btn.dataset.orgName;
          const userIds = btn.dataset.userIds.split(',').filter(Boolean);
          addUsersToOrg(btn, orgId, orgName, userIds);
        });
      });
    }

    function renderUnverifiedOrgs() {
      const { unverified_orgs } = healthData;
      const badge = document.getElementById('unverifiedBadge');
      const content = document.getElementById('unverifiedOrgsContent');

      badge.textContent = unverified_orgs.length;
      badge.className = unverified_orgs.length === 0 ? 'section-badge success' : 'section-badge';

      if (unverified_orgs.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#10003;</div>
            <p>All organizations with users have verified domains.</p>
          </div>
        `;
        return;
      }

      // Common personal email domains to filter out
      const personalDomains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 'icloud.com', 'aol.com', 'protonmail.com', 'me.com', 'live.com', 'msn.com'];

      content.innerHTML = `
        <table class="issue-table">
          <thead>
            <tr>
              <th>Organization</th>
              <th>Users</th>
              <th>User Domains</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${unverified_orgs.map(o => {
              // Build a map of claimed domains to their claiming org info
              const claimedDomainsMap = new Map();
              (o.claimed_by_others || []).forEach(claim => {
                if (claim && claim.domain) {
                  claimedDomainsMap.set(claim.domain.toLowerCase(), claim);
                }
              });

              // Find the first corporate domain (not a personal email domain AND not claimed by another org)
              const corporateDomains = (o.user_domains || []).filter(d =>
                d && !personalDomains.includes(d.toLowerCase()) && !claimedDomainsMap.has(d.toLowerCase())
              );
              const suggestedDomain = corporateDomains[0] || null;

              return `
              <tr>
                <td>
                  <a href="/admin/org/${encodeURIComponent(o.org_id)}" class="org-link">${escapeHtml(o.name)}</a>
                  ${o.email_domain ? `<br><small style="color: var(--color-text-muted);">${escapeHtml(o.email_domain)}</small>` : ''}
                </td>
                <td><span class="user-count">${o.user_count}</span></td>
                <td>
                  <ul class="user-list">
                    ${o.user_domains.slice(0, 3).map(d => {
                      const claim = claimedDomainsMap.get(d.toLowerCase());
                      if (claim) {
                        return `<li>${escapeHtml(d)} <span class="claimed-tag" title="Claimed by ${escapeHtml(claim.org_name)}"><a href="/admin/accounts/${encodeURIComponent(claim.org_id)}" style="color: inherit; text-decoration: none;">→ ${escapeHtml(claim.org_name)}</a></span></li>`;
                      }
                      if (personalDomains.includes(d.toLowerCase())) {
                        return `<li>${escapeHtml(d)} <span class="personal-tag">personal</span></li>`;
                      }
                      return `<li>${escapeHtml(d)}</li>`;
                    }).join('')}
                  </ul>
                </td>
                <td>
                  <span class="status-badge ${o.subscription_status === 'active' ? 'status-active' : 'status-prospect'}">
                    ${escapeHtml(o.subscription_status || 'prospect')}
                  </span>
                </td>
                <td>
                  <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                    ${suggestedDomain ? `
                      <button class="btn btn-primary btn-sm link-domain-btn"
                              data-org-id="${escapeHtml(o.org_id)}"
                              data-org-name="${escapeHtml(o.name)}"
                              data-domain="${escapeHtml(suggestedDomain)}"
                              title="Link ${escapeHtml(suggestedDomain)} to ${escapeHtml(o.name)}">
                        Link ${escapeHtml(suggestedDomain)}
                      </button>
                    ` : ''}
                    <a href="/admin/accounts/${encodeURIComponent(o.org_id)}" class="btn btn-secondary btn-sm">View Org</a>
                  </div>
                </td>
              </tr>
            `}).join('')}
          </tbody>
        </table>
      `;
    }

    function renderDomainConflicts() {
      const { domain_conflicts } = healthData;
      const badge = document.getElementById('conflictsBadge');
      const content = document.getElementById('domainConflictsContent');

      badge.textContent = domain_conflicts.length;
      badge.className = domain_conflicts.length === 0 ? 'section-badge success' : 'section-badge';

      if (domain_conflicts.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#10003;</div>
            <p>No domain conflicts found. Each domain maps to exactly one organization.</p>
          </div>
        `;
        return;
      }

      content.innerHTML = `
        <table class="issue-table">
          <thead>
            <tr>
              <th>Domain</th>
              <th>Organizations</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${domain_conflicts.map(c => `
              <tr>
                <td>
                  <span class="domain-name">${escapeHtml(c.domain)}</span>
                  <br><small style="color: var(--color-text-muted);">${c.org_count} organizations</small>
                </td>
                <td>
                  <ul class="org-list">
                    ${c.organizations.map(o => `
                      <li>
                        <a href="/admin/org/${encodeURIComponent(o.id)}" class="org-link">${escapeHtml(o.name)}</a>
                        <span class="status-badge ${o.subscription_status === 'active' ? 'status-active' : 'status-prospect'}">
                          ${escapeHtml(o.subscription_status || 'prospect')}
                        </span>
                      </li>
                    `).join('')}
                  </ul>
                </td>
                <td>
                  <button class="btn btn-primary btn-sm merge-orgs-btn" data-org-ids="${c.organizations.map(o => encodeURIComponent(o.id)).join(',')}" data-domain="${encodeURIComponent(c.domain)}">
                    Merge Orgs
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderRelatedDomains() {
      const relatedDomains = healthData.related_domains || [];
      const badge = document.getElementById('relatedBadge');
      const content = document.getElementById('relatedDomainsContent');

      badge.textContent = relatedDomains.length;
      badge.className = relatedDomains.length === 0 ? 'section-badge success' : 'section-badge';

      if (relatedDomains.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#10003;</div>
            <p>No related organizations found based on domain similarity.</p>
          </div>
        `;
        return;
      }

      content.innerHTML = `
        <table class="issue-table">
          <thead>
            <tr>
              <th>Root Domain</th>
              <th>Related Organizations</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${relatedDomains.map(r => `
              <tr>
                <td>
                  <span class="domain-name">${escapeHtml(r.root_domain)}</span>
                  <br><small style="color: var(--color-text-muted);">${r.org_count} organizations</small>
                </td>
                <td>
                  <ul class="org-list">
                    ${r.organizations.map(o => `
                      <li>
                        <a href="/admin/org/${encodeURIComponent(o.org_id)}" class="org-link">${escapeHtml(o.name)}</a>
                        <span class="status-badge ${o.subscription_status === 'active' ? 'status-active' : 'status-prospect'}">
                          ${escapeHtml(o.subscription_status || 'prospect')}
                        </span>
                        ${o.domains && o.domains.length > 0 ? `<br><small style="color: var(--color-text-muted);">${o.domains.filter(Boolean).map(d => escapeHtml(d)).join(', ')}</small>` : ''}
                      </li>
                    `).join('')}
                  </ul>
                </td>
                <td>
                  <button class="btn btn-primary btn-sm merge-orgs-btn" data-org-ids="${r.organizations.map(o => encodeURIComponent(o.org_id)).join(',')}" data-domain="${encodeURIComponent(r.root_domain)}">
                    Review &amp; Merge
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderSimilarNames() {
      const similarNames = healthData.similar_names || [];
      const badge = document.getElementById('similarNamesBadge');
      const content = document.getElementById('similarNamesContent');

      badge.textContent = similarNames.length;
      badge.className = similarNames.length === 0 ? 'section-badge success' : 'section-badge';

      if (similarNames.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#10003;</div>
            <p>No organizations found with similar names.</p>
          </div>
        `;
        return;
      }

      content.innerHTML = `
        <table class="issue-table">
          <thead>
            <tr>
              <th>Name Pattern</th>
              <th>Similar Organizations</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${similarNames.map(s => `
              <tr>
                <td>
                  <span class="domain-name">${escapeHtml(s.base_name)}</span>
                  <br><small style="color: var(--color-text-muted);">${s.org_count} organizations</small>
                </td>
                <td>
                  <ul class="org-list">
                    ${s.organizations.map(o => `
                      <li>
                        <a href="/admin/accounts/${encodeURIComponent(o.org_id)}" class="org-link">${escapeHtml(o.name)}</a>
                        <span class="status-badge ${o.subscription_status === 'active' ? 'status-active' : 'status-prospect'}">
                          ${escapeHtml(o.subscription_status || 'prospect')}
                        </span>
                      </li>
                    `).join('')}
                  </ul>
                </td>
                <td>
                  <button class="btn btn-primary btn-sm merge-orgs-btn" data-org-ids="${s.organizations.map(o => encodeURIComponent(o.org_id)).join(',')}" data-base-name="${encodeURIComponent(s.base_name)}">
                    Review &amp; Merge
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // Merge modal functionality
    let mergeModalElement = null;

    function showMergeModal(orgIds, domain) {
      // Create modal if doesn't exist
      if (!mergeModalElement) {
        mergeModalElement = document.createElement('div');
        mergeModalElement.id = 'mergeModal';
        document.body.appendChild(mergeModalElement);
      }

      mergeModalElement.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-surface-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000;">
          <div style="background: var(--color-bg-card); border-radius: var(--radius-lg); padding: var(--space-6); max-width: 700px; width: 95%; max-height: 85vh; overflow: auto; box-shadow: var(--shadow-lg);">
            <h3 style="margin-bottom: var(--space-4);">Loading organizations...</h3>
            <div style="color: var(--color-text-muted);">Fetching details for merge preview...</div>
          </div>
        </div>
      `;

      // Fetch org details
      loadMergePreview(orgIds, domain);
    }

    async function loadMergePreview(orgIds, domain) {
      try {
        // Fetch all org details in parallel
        const responses = await Promise.all(
          orgIds.map(id => fetch(`/api/admin/organizations/${id}`))
        );

        const orgs = await Promise.all(responses.map(async (r, i) => {
          if (!r.ok) return { id: orgIds[i], name: 'Unknown', error: true };
          return await r.json();
        }));

        // Sort by user count descending to suggest largest as primary
        orgs.sort((a, b) => (b.member_count || 0) - (a.member_count || 0));

        mergeModalElement.innerHTML = `
          <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-surface-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div style="background: var(--color-bg-card); border-radius: var(--radius-lg); padding: var(--space-6); max-width: 700px; width: 95%; max-height: 85vh; overflow: auto; box-shadow: var(--shadow-lg);">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-4);">
                <h3>Merge Organizations for ${escapeHtml(domain)}</h3>
                <button onclick="closeMergeModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--color-text-secondary);">&times;</button>
              </div>

              <p style="margin-bottom: var(--space-4); color: var(--color-text-secondary);">
                Select which organization should be the <strong>primary</strong> (kept). All others will be merged into it.
              </p>

              <div style="display: flex; flex-direction: column; gap: var(--space-3); margin-bottom: var(--space-4);">
                ${orgs.map((org, i) => {
                  const memberNames = (org.members || []).slice(0, 3).map(m => {
                    const name = m.firstName || m.lastName
                      ? `${m.firstName || ''} ${m.lastName || ''}`.trim()
                      : m.email;
                    return escapeHtml(name);
                  });
                  const remainingMembers = Math.max(0, (org.member_count || 0) - memberNames.length);

                  return `
                  <label style="display: flex; align-items: start; gap: var(--space-3); padding: var(--space-3); border: 2px solid var(--color-border); border-radius: var(--radius-md); cursor: pointer;" class="merge-org-option" data-org-id="${org.workos_organization_id || org.id}">
                    <input type="radio" name="primaryOrg" value="${org.workos_organization_id || org.id}" ${i === 0 ? 'checked' : ''} style="margin-top: 4px;">
                    <div style="flex: 1;">
                      <div style="font-weight: var(--font-semibold);">${escapeHtml(org.name)}</div>
                      <div style="font-size: var(--text-xs); color: var(--color-text-muted);">
                        ${org.member_count || 0} members
                        ${org.subscription_status ? ` • ${escapeHtml(org.subscription_status)}` : ''}
                        ${org.company_type ? ` • ${escapeHtml(org.company_type)}` : ''}
                      </div>
                      ${memberNames.length > 0 ? `
                        <div style="font-size: var(--text-xs); color: var(--color-text-secondary); margin-top: var(--space-1);">
                          ${memberNames.join(', ')}${remainingMembers > 0 ? `, +${remainingMembers} more` : ''}
                        </div>
                      ` : ''}
                    </div>
                    ${i === 0 ? '<span style="font-size: var(--text-xs); background: var(--color-success-100); color: var(--color-success-700); padding: 2px 8px; border-radius: var(--radius-full);">Recommended</span>' : ''}
                  </label>
                `}).join('')}
              </div>

              <div style="background: var(--color-warning-50); border: 1px solid var(--color-warning-200); border-radius: var(--radius-md); padding: var(--space-3); margin-bottom: var(--space-4);">
                <strong style="color: var(--color-warning-700);">Warning:</strong>
                <span style="color: var(--color-warning-800);">Merging cannot be undone. All data from secondary organizations will be moved to the primary.</span>
              </div>

              <div style="display: flex; justify-content: space-between;">
                <button class="btn btn-secondary" onclick="closeMergeModal()">Cancel</button>
                <button class="btn btn-primary" id="previewMergeBtn" data-org-ids="${orgs.map(o => encodeURIComponent(o.workos_organization_id || o.id)).join(',')}">
                  Preview Merge
                </button>
              </div>
            </div>
          </div>
        `;

        // Add click handler for preview merge button
        document.getElementById('previewMergeBtn').addEventListener('click', function() {
          const orgIds = this.dataset.orgIds.split(',').map(decodeURIComponent).join(',');
          executeMergeFromModal(orgIds);
        });

        // Add click handlers for radio buttons to update styling
        document.querySelectorAll('.merge-org-option').forEach(label => {
          label.addEventListener('click', () => {
            document.querySelectorAll('.merge-org-option').forEach(l => {
              l.style.borderColor = 'var(--color-border)';
            });
            label.style.borderColor = 'var(--color-brand)';
          });
        });

        // Initialize first option as selected
        const firstOption = document.querySelector('.merge-org-option');
        if (firstOption) firstOption.style.borderColor = 'var(--color-brand)';

      } catch (error) {
        console.error('Error loading merge preview:', error);
        mergeModalElement.innerHTML = `
          <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-surface-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div style="background: var(--color-bg-card); border-radius: var(--radius-lg); padding: var(--space-6); max-width: 500px; width: 95%;">
              <h3 style="color: var(--color-error-600);">Error</h3>
              <p>Failed to load organization details: ${escapeHtml(error.message)}</p>
              <button class="btn btn-secondary" onclick="closeMergeModal()">Close</button>
            </div>
          </div>
        `;
      }
    }

    async function executeMergeFromModal(allOrgIds) {
      const primaryOrgId = document.querySelector('input[name="primaryOrg"]:checked')?.value;
      if (!primaryOrgId) {
        alert('Please select a primary organization');
        return;
      }

      const orgIds = allOrgIds.split(',');
      const secondaryOrgIds = orgIds.filter(id => id !== primaryOrgId);

      if (secondaryOrgIds.length === 0) {
        alert('No organizations to merge');
        return;
      }

      // Preview the first merge
      const secondaryOrgId = secondaryOrgIds[0];

      try {
        const response = await fetch(`/api/admin/cleanup/preview-merge?primary=${primaryOrgId}&secondary=${secondaryOrgId}`);
        if (!response.ok) throw new Error('Failed to load preview');
        const preview = await response.json();

        const warningsHtml = preview.warnings.length > 0 ? `
          <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-warning-50); border: 1px solid var(--color-warning-200); border-radius: var(--radius-md);">
            <strong style="color: var(--color-warning-700);">Warnings:</strong>
            <ul style="margin: var(--space-2) 0 0 var(--space-4);">
              ${preview.warnings.map(w => `<li>${escapeHtml(w)}</li>`).join('')}
            </ul>
          </div>
        ` : '';

        const changesHtml = preview.estimated_changes.length > 0 ? `
          <div style="margin-bottom: var(--space-4);">
            <strong>Data to be moved:</strong>
            <table style="width: 100%; margin-top: var(--space-2); border-collapse: collapse;">
              <thead>
                <tr style="background: var(--color-bg-subtle);">
                  <th style="padding: var(--space-2); text-align: left; border-bottom: 1px solid var(--color-border);">Table</th>
                  <th style="padding: var(--space-2); text-align: right; border-bottom: 1px solid var(--color-border);">Rows</th>
                </tr>
              </thead>
              <tbody>
                ${preview.estimated_changes.map(c => `
                  <tr>
                    <td style="padding: var(--space-2); border-bottom: 1px solid var(--color-border);">${escapeHtml(c.table_name)}</td>
                    <td style="padding: var(--space-2); text-align: right; border-bottom: 1px solid var(--color-border);">${c.rows_to_move}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : '<p>No data to move - secondary organization appears empty.</p>';

        mergeModalElement.innerHTML = `
          <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-surface-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div style="background: var(--color-bg-card); border-radius: var(--radius-lg); padding: var(--space-6); max-width: 900px; width: 95%; max-height: 85vh; overflow: auto; box-shadow: var(--shadow-lg);">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-4);">
                <h3>Merge Preview${secondaryOrgIds.length > 1 ? ` (1 of ${secondaryOrgIds.length})` : ''}</h3>
                <button onclick="closeMergeModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--color-text-secondary);">&times;</button>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
                <div style="padding: var(--space-4); background: var(--color-success-50); border: 2px solid var(--color-success-300); border-radius: var(--radius-md);">
                  <div style="font-size: var(--text-xs); color: var(--color-success-700); font-weight: var(--font-semibold); margin-bottom: var(--space-1);">PRIMARY (keep)</div>
                  <div style="font-size: var(--text-lg); font-weight: var(--font-semibold);">${escapeHtml(preview.primary_org.name)}</div>
                  <div style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-top: var(--space-2);">
                    <div><strong>Members:</strong> ${preview.primary_org.member_count || 0}</div>
                    ${preview.primary_org.company_type ? `<div><strong>Type:</strong> ${escapeHtml(preview.primary_org.company_type)}</div>` : ''}
                    ${preview.primary_org.prospect_status ? `<div><strong>Status:</strong> ${escapeHtml(preview.primary_org.prospect_status)}</div>` : ''}
                    ${preview.primary_org.created_by ? `<div><strong>Created by:</strong> ${escapeHtml(preview.primary_org.created_by)}</div>` : ''}
                    ${preview.primary_org.has_enrichment ? `<div style="color: var(--color-success-600);">Has enrichment data</div>` : ''}
                    ${preview.primary_org.has_notes ? `<div style="color: var(--color-brand);">Has admin notes</div>` : ''}
                  </div>
                </div>

                <div style="padding: var(--space-4); background: var(--color-error-50); border: 2px solid var(--color-error-300); border-radius: var(--radius-md);">
                  <div style="font-size: var(--text-xs); color: var(--color-error-700); font-weight: var(--font-semibold); margin-bottom: var(--space-1);">SECONDARY (delete)</div>
                  <div style="font-size: var(--text-lg); font-weight: var(--font-semibold);">${escapeHtml(preview.secondary_org.name)}</div>
                  <div style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-top: var(--space-2);">
                    <div><strong>Members:</strong> ${preview.secondary_org.member_count || 0}</div>
                    ${preview.secondary_org.company_type ? `<div><strong>Type:</strong> ${escapeHtml(preview.secondary_org.company_type)}</div>` : ''}
                    ${preview.secondary_org.prospect_status ? `<div><strong>Status:</strong> ${escapeHtml(preview.secondary_org.prospect_status)}</div>` : ''}
                    ${preview.secondary_org.created_by ? `<div><strong>Created by:</strong> ${escapeHtml(preview.secondary_org.created_by)}</div>` : ''}
                    ${preview.secondary_org.has_enrichment ? `<div style="color: var(--color-success-600);">Has enrichment data</div>` : ''}
                    ${preview.secondary_org.has_notes ? `<div style="color: var(--color-brand);">Has admin notes</div>` : ''}
                  </div>
                </div>
              </div>

              ${warningsHtml}
              ${changesHtml}

              <div style="margin-top: var(--space-4); display: flex; justify-content: space-between;">
                <button class="btn btn-secondary" onclick="closeMergeModal()">Cancel</button>
                <button class="btn btn-primary" id="confirmMergeBtn" style="background: var(--color-error-600);"
                        data-primary-id="${encodeURIComponent(primaryOrgId)}"
                        data-secondary-id="${encodeURIComponent(secondaryOrgId)}"
                        data-remaining-ids="${secondaryOrgIds.slice(1).map(encodeURIComponent).join(',')}">
                  Confirm Merge
                </button>
              </div>
            </div>
          </div>
        `;

        // Add click handler for confirm merge button
        document.getElementById('confirmMergeBtn').addEventListener('click', function() {
          const primaryId = decodeURIComponent(this.dataset.primaryId);
          const secondaryId = decodeURIComponent(this.dataset.secondaryId);
          const remainingIds = this.dataset.remainingIds ? this.dataset.remainingIds.split(',').map(decodeURIComponent).join(',') : '';
          confirmMerge(primaryId, secondaryId, remainingIds);
        });
      } catch (error) {
        alert('Failed to load merge preview: ' + error.message);
      }
    }

    async function confirmMerge(primaryOrgId, secondaryOrgId, remainingOrgIds) {
      // Disable all buttons immediately to prevent double-clicks
      document.querySelectorAll('#mergeModal button, #confirmMergeBtn, #continueMergeBtn').forEach(btn => {
        btn.disabled = true;
      });

      if (!confirm('Are you sure you want to merge these organizations? This cannot be undone.')) {
        // Re-enable buttons if user cancels
        document.querySelectorAll('#mergeModal button, #confirmMergeBtn, #continueMergeBtn').forEach(btn => {
          btn.disabled = false;
        });
        return;
      }

      mergeModalElement.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-surface-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000;">
          <div style="background: var(--color-bg-card); border-radius: var(--radius-lg); padding: var(--space-6); max-width: 600px; width: 90%;">
            <h3 style="margin-bottom: var(--space-4);">Merging organizations...</h3>
            <div style="color: var(--color-text-muted);">Please wait...</div>
          </div>
        </div>
      `;

      try {
        const response = await fetch('/api/admin/cleanup/merge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ primary_org_id: primaryOrgId, secondary_org_id: secondaryOrgId })
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.message || 'Merge failed');
        }

        const result = await response.json();
        const totalMoved = result.tables_merged.reduce((sum, t) => sum + t.rows_moved, 0);

        // Check if there are more orgs to merge
        if (remainingOrgIds && remainingOrgIds.length > 0) {
          const remainingCount = remainingOrgIds.split(',').filter(Boolean).length;
          mergeModalElement.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-surface-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000;">
              <div style="background: var(--color-bg-card); border-radius: var(--radius-lg); padding: var(--space-6); max-width: 600px; width: 90%;">
                <h3 style="color: var(--color-success-600); margin-bottom: var(--space-4);">Merge Complete</h3>
                <p>Successfully merged. ${totalMoved} records moved.</p>
                <p style="margin-top: var(--space-3);">There are ${remainingCount} more organization(s) to merge.</p>
                <div style="margin-top: var(--space-4); display: flex; justify-content: space-between;">
                  <button class="btn btn-secondary" onclick="closeMergeModal(); loadDomainHealth();">Done for Now</button>
                  <button class="btn btn-primary" id="continueMergeBtn"
                          data-org-ids="${encodeURIComponent(primaryOrgId)},${remainingOrgIds.split(',').map(encodeURIComponent).join(',')}">
                    Continue Merging
                  </button>
                </div>
              </div>
            </div>
          `;

          // Add click handler for continue merge button
          document.getElementById('continueMergeBtn').addEventListener('click', function() {
            const orgIds = this.dataset.orgIds.split(',').map(decodeURIComponent).join(',');
            executeMergeFromModal(orgIds);
          });
        } else {
          mergeModalElement.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-surface-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000;">
              <div style="background: var(--color-bg-card); border-radius: var(--radius-lg); padding: var(--space-6); max-width: 600px; width: 90%;">
                <h3 style="color: var(--color-success-600); margin-bottom: var(--space-4);">All Merges Complete</h3>
                <p>Successfully merged all organizations. ${totalMoved} records moved in this merge.</p>
                <div style="margin-top: var(--space-4); text-align: right;">
                  <button class="btn btn-primary" onclick="closeMergeModal(); loadDomainHealth();">Done</button>
                </div>
              </div>
            </div>
          `;
        }
      } catch (error) {
        alert('Merge failed: ' + error.message);
        closeMergeModal();
        loadDomainHealth();
      }
    }

    function closeMergeModal() {
      if (mergeModalElement) {
        mergeModalElement.innerHTML = '';
      }
    }

    // Load backfill status on page load
    async function loadBackfillStatus() {
      const countSpan = document.getElementById('backfillCount');
      const btn = document.getElementById('backfillSlackBtn');
      const previewDiv = document.getElementById('backfillPreview');

      try {
        const response = await fetch('/api/admin/slack/backfill-status');
        if (!response.ok) {
          throw new Error('Failed to load status');
        }
        const status = await response.json();

        if (status.totalUsers === 0) {
          countSpan.textContent = '0 users';
          countSpan.style.background = 'var(--color-success-100)';
          countSpan.style.color = 'var(--color-success-700)';
          btn.disabled = true;
          btn.textContent = 'No users to link';
        } else {
          countSpan.textContent = `${status.totalUsers} users`;
          countSpan.style.background = 'var(--color-warning-100)';
          countSpan.style.color = 'var(--color-warning-700)';
          btn.disabled = false;
          btn.textContent = `Link ${status.totalUsers} Users`;

          // Show preview of what will be linked
          if (status.byOrganization.length > 0) {
            previewDiv.innerHTML = `
              <div style="padding: var(--space-3); background: var(--color-gray-50); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                <div style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: var(--space-2);">Users to be linked:</div>
                <ul style="margin: 0; padding-left: var(--space-4); font-size: var(--text-sm); color: var(--color-text-secondary);">
                  ${status.byOrganization.slice(0, 5).map(o => `<li><strong>${escapeHtml(o.organizationName)}</strong> (${escapeHtml(o.domain)}): ${o.userCount} users</li>`).join('')}
                  ${status.byOrganization.length > 5 ? `<li>...and ${status.byOrganization.length - 5} more organizations</li>` : ''}
                </ul>
              </div>
            `;
            previewDiv.style.display = 'block';
          }
        }
      } catch (error) {
        countSpan.textContent = 'error';
        countSpan.style.background = 'var(--color-error-100)';
        countSpan.style.color = 'var(--color-error-700)';
        btn.disabled = true;
      }
    }

    // Backfill Slack user links
    async function runSlackBackfill() {
      const btn = document.getElementById('backfillSlackBtn');
      const resultDiv = document.getElementById('backfillResult');
      const previewDiv = document.getElementById('backfillPreview');

      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Running...';
      resultDiv.style.display = 'none';
      previewDiv.style.display = 'none';

      try {
        const response = await fetch('/api/admin/slack/backfill-pending-orgs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar?.redirectToLogin();
            return;
          }
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Backfill failed');
        }

        const result = await response.json();

        // Show success result
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-success');
        btn.textContent = 'Complete';

        if (result.usersLinked > 0) {
          resultDiv.innerHTML = `
            <div style="padding: var(--space-3); background: var(--color-success-50); border: 1px solid var(--color-success-200); border-radius: var(--radius-md);">
              <div style="font-weight: var(--font-semibold); color: var(--color-success-700);">
                Linked ${result.usersLinked} Slack users to ${result.details.length} organizations
              </div>
              <ul style="margin: var(--space-2) 0 0 var(--space-4); font-size: var(--text-sm); color: var(--color-text-secondary);">
                ${result.details.slice(0, 5).map(d => `<li>${escapeHtml(d.organizationName)} (${d.domain}): ${d.usersLinked} users</li>`).join('')}
                ${result.details.length > 5 ? `<li>...and ${result.details.length - 5} more</li>` : ''}
              </ul>
            </div>
          `;
        } else {
          resultDiv.innerHTML = `
            <div style="padding: var(--space-3); background: var(--color-gray-50); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
              <div style="color: var(--color-text-secondary);">No unmapped Slack users found to link. All users are already associated with their organizations.</div>
            </div>
          `;
        }
        resultDiv.style.display = 'block';

        // Refresh status after delay
        setTimeout(() => {
          loadBackfillStatus();
          btn.classList.remove('btn-success');
          btn.classList.add('btn-secondary');
        }, 3000);

      } catch (error) {
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-error');
        btn.textContent = 'Failed';

        resultDiv.innerHTML = `
          <div style="padding: var(--space-3); background: var(--color-error-50); border: 1px solid var(--color-error-200); border-radius: var(--radius-md);">
            <div style="color: var(--color-error-700);">Error: ${escapeHtml(error.message)}</div>
          </div>
        `;
        resultDiv.style.display = 'block';

        setTimeout(() => {
          btn.disabled = false;
          btn.classList.remove('btn-error');
          btn.classList.add('btn-secondary');
          btn.textContent = originalText;
        }, 3000);
      }
    }

    // Load member backfill status
    async function loadMemberBackfillStatus() {
      const countSpan = document.getElementById('memberBackfillCount');
      const btn = document.getElementById('memberBackfillBtn');
      const previewDiv = document.getElementById('memberBackfillPreview');

      try {
        const response = await fetch('/api/admin/domain-users/backfill-status');
        if (!response.ok) {
          throw new Error('Failed to load status');
        }
        const status = await response.json();

        if (status.total_users === 0) {
          countSpan.textContent = '0 users';
          countSpan.style.background = 'var(--color-success-100)';
          countSpan.style.color = 'var(--color-success-700)';
          btn.disabled = true;
          btn.textContent = 'No users to add';
        } else {
          countSpan.textContent = `${status.total_users} users`;
          countSpan.style.background = 'var(--color-warning-100)';
          countSpan.style.color = 'var(--color-warning-700)';
          btn.disabled = false;
          btn.textContent = `Add ${status.total_users} Members`;

          // Show preview of what will be added
          if (status.by_organization.length > 0) {
            previewDiv.innerHTML = `
              <div style="padding: var(--space-3); background: var(--color-gray-50); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                <div style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: var(--space-2);">Users to be added as members:</div>
                <ul style="margin: 0; padding-left: var(--space-4); font-size: var(--text-sm); color: var(--color-text-secondary);">
                  ${status.by_organization.slice(0, 5).map(o => `<li><strong>${escapeHtml(o.org_name)}</strong> (${escapeHtml(o.domain)}): ${o.users.length} users</li>`).join('')}
                  ${status.by_organization.length > 5 ? `<li>...and ${status.by_organization.length - 5} more organizations</li>` : ''}
                </ul>
              </div>
            `;
            previewDiv.style.display = 'block';
          }
        }
      } catch (error) {
        countSpan.textContent = 'error';
        countSpan.style.background = 'var(--color-error-100)';
        countSpan.style.color = 'var(--color-error-700)';
        btn.disabled = true;
      }
    }

    // Run member backfill
    async function runMemberBackfill() {
      const btn = document.getElementById('memberBackfillBtn');
      const resultDiv = document.getElementById('memberBackfillResult');
      const previewDiv = document.getElementById('memberBackfillPreview');

      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Adding members...';
      resultDiv.style.display = 'none';
      previewDiv.style.display = 'none';

      try {
        const response = await fetch('/api/admin/domain-users/backfill-members', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar?.redirectToLogin();
            return;
          }
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Backfill failed');
        }

        const result = await response.json();

        // Show success result
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        btn.textContent = 'Complete';

        if (result.total_added > 0) {
          resultDiv.innerHTML = `
            <div style="padding: var(--space-3); background: var(--color-success-50); border: 1px solid var(--color-success-200); border-radius: var(--radius-md);">
              <div style="font-weight: var(--font-semibold); color: var(--color-success-700);">
                Added ${result.total_added} members to ${result.orgs_processed} organizations
              </div>
              ${result.total_skipped > 0 ? `<div style="font-size: var(--text-sm); color: var(--color-text-secondary);">${result.total_skipped} already members (skipped)</div>` : ''}
              ${result.total_errors > 0 ? `<div style="font-size: var(--text-sm); color: var(--color-error-600);">${result.total_errors} errors</div>` : ''}
              <ul style="margin: var(--space-2) 0 0 var(--space-4); font-size: var(--text-sm); color: var(--color-text-secondary);">
                ${result.details.slice(0, 5).map(d => `<li>${escapeHtml(d.org_name)} (${d.domain}): ${d.added} added${d.skipped > 0 ? `, ${d.skipped} skipped` : ''}</li>`).join('')}
                ${result.details.length > 5 ? `<li>...and ${result.details.length - 5} more</li>` : ''}
              </ul>
            </div>
          `;
        } else {
          resultDiv.innerHTML = `
            <div style="padding: var(--space-3); background: var(--color-gray-50); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
              <div style="color: var(--color-text-secondary);">No users to add. All verified domain users are already members of their organizations.</div>
            </div>
          `;
        }
        resultDiv.style.display = 'block';

        // Refresh status after delay
        setTimeout(() => {
          loadMemberBackfillStatus();
          btn.classList.remove('btn-success');
          btn.classList.add('btn-primary');
        }, 3000);

      } catch (error) {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-error');
        btn.textContent = 'Failed';

        resultDiv.innerHTML = `
          <div style="padding: var(--space-3); background: var(--color-error-50); border: 1px solid var(--color-error-200); border-radius: var(--radius-md);">
            <div style="color: var(--color-error-700);">Error: ${escapeHtml(error.message)}</div>
          </div>
        `;
        resultDiv.style.display = 'block';

        setTimeout(() => {
          btn.disabled = false;
          btn.classList.remove('btn-error');
          btn.classList.add('btn-primary');
          btn.textContent = originalText;
        }, 3000);
      }
    }

    // Initialize
    document.getElementById('backfillSlackBtn').addEventListener('click', runSlackBackfill);
    document.getElementById('memberBackfillBtn').addEventListener('click', runMemberBackfill);
    loadDomainHealth();
    loadBackfillStatus();
    loadMemberBackfillStatus();
  </script>
</body>
</html>
