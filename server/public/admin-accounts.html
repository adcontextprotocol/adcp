<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Accounts - AgenticAdvertising.org</title>
  <link rel="stylesheet" href="/design-system.css">
  <script src="/js/company-types.js"></script>
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <style>
    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-wide);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    h1 {
      margin-bottom: var(--space-2);
      color: var(--color-text-heading);
    }
    .subtitle {
      color: var(--color-text-secondary);
      margin-bottom: var(--space-6);
    }

    /* View tabs */
    .view-tabs {
      display: flex;
      gap: var(--space-1);
      margin-bottom: var(--space-5);
      flex-wrap: wrap;
      border-bottom: var(--border-1) solid var(--color-gray-200);
      padding-bottom: var(--space-3);
    }
    .view-tab {
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
      background: transparent;
      border: none;
      color: var(--color-text-secondary);
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
    }
    .view-tab:hover {
      background: var(--color-gray-100);
      color: var(--color-text-heading);
    }
    .view-tab.active {
      background: var(--color-brand);
      color: white;
    }
    .view-tab .badge {
      font-size: var(--text-xs);
      padding: var(--space-0) var(--space-2);
      border-radius: var(--radius-full);
      background: rgba(255,255,255,0.2);
    }
    .view-tab:not(.active) .badge {
      background: var(--color-gray-200);
      color: var(--color-text-secondary);
    }

    /* Filters */
    .filters-bar {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
      flex-wrap: wrap;
      align-items: center;
    }
    .search-input {
      padding: var(--space-2) var(--space-3);
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      width: 250px;
    }
    .filter-select {
      padding: var(--space-2) var(--space-3);
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      background: white;
    }

    /* Table */
    .table-container {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-xs);
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th {
      text-align: left;
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: var(--border-1) solid var(--color-gray-200);
      background: var(--color-gray-50);
    }
    td {
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-sm);
      border-bottom: var(--border-1) solid var(--color-gray-100);
      vertical-align: middle;
    }
    tr:hover td {
      background: var(--color-gray-50);
    }
    tr:last-child td {
      border-bottom: none;
    }

    /* Account name link */
    .account-name {
      font-weight: var(--font-semibold);
      color: var(--color-brand);
      text-decoration: none;
    }
    .account-name:hover {
      text-decoration: underline;
    }
    .account-domain {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
    }

    /* Member status badges */
    .status-badge {
      display: inline-block;
      padding: var(--space-0) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
    }
    .status-member { background: var(--color-success-600); color: white; }
    .status-trial { background: var(--color-warning-500); color: white; }
    .status-lapsed { background: var(--color-info-500); color: white; }
    .status-prospect { background: var(--color-gray-200); color: var(--color-text-heading); }
    .status-disqualified { background: var(--color-gray-400); color: white; }

    /* Interest badges */
    .interest-badge {
      display: inline-block;
      padding: var(--space-0) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .interest-low { background: var(--color-gray-200); color: var(--color-text-secondary); }
    .interest-medium { background: var(--color-warning-100); color: var(--color-warning-700); }
    .interest-high { background: var(--color-success-100); color: var(--color-success-700); }
    .interest-very_high { background: var(--color-success-200); color: var(--color-success-800); }

    /* Engagement fires */
    .engagement-fires {
      /* No letter-spacing - breaks emoji rendering */
    }

    /* Owner */
    .owner-name {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }

    /* Attention reason badge */
    .attention-badge {
      display: inline-block;
      padding: var(--space-0) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
    }
    .attention-overdue { background: var(--color-error-100); color: var(--color-error-700); }
    .attention-due_soon { background: var(--color-warning-100); color: var(--color-warning-700); }
    .attention-open_invoice { background: var(--color-info-100); color: var(--color-info-700); }
    .attention-going_cold { background: var(--color-gray-200); color: var(--color-text-secondary); }
    .attention-recent_activity { background: var(--color-success-100); color: var(--color-success-700); }
    .attention-high_engagement_unowned { background: var(--color-warning-100); color: var(--color-warning-700); }
    .attention-needs_review { background: var(--color-gray-200); color: var(--color-text-secondary); }
    .attention-expiring_soon { background: var(--color-warning-100); color: var(--color-warning-700); }

    /* Activity date coloring */
    .activity-recent { color: var(--color-success-600); }
    .activity-stale { color: var(--color-warning-600); }
    .activity-cold { color: var(--color-error-600); }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: var(--space-10);
      color: var(--color-text-muted);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: var(--space-10);
      color: var(--color-text-secondary);
    }

    /* Search - Primary */
    .search-container {
      position: relative;
      margin-bottom: var(--space-5);
    }
    .search-input-primary {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      border: var(--border-2) solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--text-base);
      transition: var(--transition-all);
    }
    .search-input-primary:focus {
      outline: none;
      border-color: var(--color-brand);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--color-bg-card);
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      max-height: 400px;
      overflow-y: auto;
      z-index: 100;
      margin-top: var(--space-1);
    }
    .search-result-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-3) var(--space-4);
      cursor: pointer;
      border-bottom: var(--border-1) solid var(--color-gray-100);
      text-decoration: none;
      color: inherit;
    }
    .search-result-item:last-child {
      border-bottom: none;
    }
    .search-result-item:hover {
      background: var(--color-gray-50);
    }
    .search-result-name {
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
    }
    .search-result-domain {
      font-size: var(--text-sm);
      color: var(--color-text-muted);
    }
    .search-result-meta {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
    }
    .search-hint {
      padding: var(--space-3) var(--space-4);
      color: var(--color-text-muted);
      font-size: var(--text-sm);
      text-align: center;
    }

    /* Quick actions */
    .quick-actions {
      display: flex;
      gap: var(--space-2);
    }
    .btn {
      padding: var(--space-1) var(--space-2);
      border: none;
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .btn-secondary {
      background: var(--color-gray-100);
      color: var(--color-text-heading);
    }
    .btn-secondary:hover {
      background: var(--color-gray-200);
    }

    /* Activity Feed */
    .activity-feed {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-xs);
      overflow: hidden;
    }
    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
      padding: var(--space-4);
      border-bottom: var(--border-1) solid var(--color-gray-100);
      transition: var(--transition-all);
    }
    .activity-item:last-child {
      border-bottom: none;
    }
    .activity-item:hover {
      background: var(--color-gray-50);
    }
    .activity-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-lg);
      flex-shrink: 0;
    }
    .activity-icon.slack { background: var(--color-primary-100); }
    .activity-icon.email { background: var(--color-info-100); }
    .activity-icon.event { background: var(--color-warning-100); }
    .activity-icon.payment { background: var(--color-success-100); }
    .activity-icon.working_group { background: var(--color-primary-100); }
    .activity-content {
      flex: 1;
      min-width: 0;
    }
    .activity-header {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-1);
    }
    .activity-actor {
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
    }
    .activity-action {
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
    }
    .activity-org {
      color: var(--color-brand);
      text-decoration: none;
      font-size: var(--text-sm);
    }
    .activity-org:hover {
      text-decoration: underline;
    }
    .activity-description {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-1);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .activity-time {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      flex-shrink: 0;
    }
    .activity-filters {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
      flex-wrap: wrap;
    }
    .activity-filter {
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      cursor: pointer;
      background: var(--color-gray-100);
      border: none;
      color: var(--color-text-secondary);
      transition: var(--transition-all);
    }
    .activity-filter:hover {
      background: var(--color-gray-200);
    }
    .activity-filter.active {
      background: var(--color-brand);
      color: white;
    }
    .load-more {
      text-align: center;
      padding: var(--space-4);
    }
    .load-more-btn {
      padding: var(--space-2) var(--space-4);
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--radius-md);
      background: white;
      color: var(--color-text-secondary);
      cursor: pointer;
      font-size: var(--text-sm);
    }
    .load-more-btn:hover {
      background: var(--color-gray-50);
      border-color: var(--color-gray-300);
    }

    /* Enrichment Panel */
    .enrichment-panel {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-xs);
      padding: var(--space-5);
      margin-bottom: var(--space-5);
    }
    .enrichment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }
    .enrichment-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
    }
    .enrichment-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
    }
    .enrichment-stat-card {
      background: var(--color-gray-50);
      border-radius: var(--radius-sm);
      padding: var(--space-4);
    }
    .enrichment-stat-label {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
    }
    .enrichment-stat-value {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
    }
    .enrichment-stat-detail {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }
    .enrichment-actions {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-4);
      padding-top: var(--space-4);
      border-top: var(--border-1) solid var(--color-gray-200);
    }
    .btn-primary {
      background: var(--color-brand);
      color: white;
      padding: var(--space-2) var(--space-4);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .btn-primary:hover:not(:disabled) {
      background: var(--color-brand-hover);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .enrichment-result {
      margin-top: var(--space-3);
      padding: var(--space-3);
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
    }
    .enrichment-result.success {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .enrichment-result.error {
      background: var(--color-error-100);
      color: var(--color-error-700);
    }
    .enrichment-not-configured {
      color: var(--color-text-muted);
      font-style: italic;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      cursor: pointer;
    }
    .checkbox-label input {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <div id="adcp-nav"></div>

  <div class="container">
    <h1>Accounts</h1>

    <!-- Search - Primary Action -->
    <div class="search-container">
      <input type="text" class="search-input-primary" id="searchInput" placeholder="Search accounts by name or domain..." oninput="handleSearch()" autofocus>
      <div class="search-results" id="searchResults" style="display: none;"></div>
    </div>

    <p class="subtitle" id="viewDescription">Accounts needing action: overdue tasks, open invoices, high engagement unowned</p>

    <!-- Enrichment Panel (collapsed by default) -->
    <div class="enrichment-panel" id="enrichmentPanel" style="display: none;">
      <div class="enrichment-header">
        <span class="enrichment-title">Company Research (Lusha)</span>
        <button class="btn btn-secondary" onclick="toggleEnrichmentPanel()">Hide</button>
      </div>
      <div id="enrichmentContent">
        <div class="loading">Loading enrichment stats...</div>
      </div>
    </div>
    <div style="margin-bottom: var(--space-4);">
      <button class="btn btn-secondary" id="showEnrichmentBtn" onclick="toggleEnrichmentPanel()">Show Research Status</button>
    </div>

    <!-- View Tabs -->
    <div class="view-tabs">
      <button class="view-tab" data-view="activity">
        Activity
      </button>
      <button class="view-tab active" data-view="needs_attention">
        Needs Attention <span class="badge" id="count-needs_attention">-</span>
      </button>
      <button class="view-tab" data-view="new_insights">
        New Insights <span class="badge" id="count-new_insights">-</span>
      </button>
      <button class="view-tab" data-view="hot">
        Hot Prospects <span class="badge" id="count-hot">-</span>
      </button>
      <button class="view-tab" data-view="new_prospects">
        New Prospects <span class="badge" id="count-new_prospects">-</span>
      </button>
      <button class="view-tab" data-view="going_cold">
        Going Cold <span class="badge" id="count-going_cold">-</span>
      </button>
      <button class="view-tab" data-view="my_accounts">
        My Accounts <span class="badge" id="count-my_accounts">-</span>
      </button>
      <button class="view-tab" data-view="renewals">
        Renewals <span class="badge" id="count-renewals">-</span>
      </button>
      <button class="view-tab" data-view="members">
        Members <span class="badge" id="count-members">-</span>
      </button>
      <button class="view-tab" data-view="most_users">
        Most Users
      </button>
      <button class="view-tab" data-view="all">
        All
      </button>
      <button class="view-tab" data-view="disqualified">
        Disqualified <span class="badge" id="count-disqualified">-</span>
      </button>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
      <select class="filter-select" id="ownerFilter" onchange="loadAccounts()">
        <option value="">All Owners</option>
      </select>
    </div>

    <!-- Table (for account views) -->
    <div class="table-container" id="accountsContainer">
      <table>
        <thead>
          <tr>
            <th>Account</th>
            <th>Status</th>
            <th>Users</th>
            <th style="width: 60px;">ðŸ”¥</th>
            <th>Interest</th>
            <th>Last Activity</th>
            <th>Owner</th>
            <th id="extraColumnHeader" style="display: none;"></th>
          </tr>
        </thead>
        <tbody id="accountsTable">
          <tr><td colspan="8" class="loading">Loading accounts...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Activity Feed (for activity view) -->
    <div id="activityContainer" style="display: none;">
      <div class="activity-filters">
        <button class="activity-filter active" data-source="all">All</button>
        <button class="activity-filter" data-source="slack">Slack</button>
        <button class="activity-filter" data-source="email">Email</button>
        <button class="activity-filter" data-source="event">Events</button>
        <button class="activity-filter" data-source="payment">Payments</button>
        <button class="activity-filter" data-source="working_group">Groups</button>
      </div>
      <div class="activity-feed" id="activityFeed">
        <div class="loading" style="padding: var(--space-8);">Loading activity...</div>
      </div>
      <div class="load-more" id="loadMoreContainer" style="display: none;">
        <button class="load-more-btn" onclick="loadMoreActivity()">Load More</button>
      </div>
    </div>
  </div>

  <script>
    let accounts = [];
    let teamMembers = [];
    let currentView = 'needs_attention';
    let searchTimeout = null;
    let activityData = [];
    let activityOffset = 0;
    let activitySourceFilter = 'all';

    const viewDescriptions = {
      activity: 'Recent activity across the community: Slack, emails, events, payments',
      needs_attention: 'Accounts needing action: overdue tasks, open invoices, unowned hot prospects',
      new_insights: 'Prospects with recent Slack activity from their team',
      hot: 'High engagement prospects ready to convert',
      new_prospects: 'Recently created prospect accounts',
      going_cold: 'Prospects losing engagement (no activity in 30+ days)',
      my_accounts: 'Accounts you own or are watching',
      renewals: 'Members with subscriptions ending soon',
      members: 'All paying member organizations',
      all: 'All accounts',
      disqualified: 'Accounts marked as not viable'
    };

    async function init() {
      // Load team members for owner filter
      try {
        const teamResponse = await fetch('/api/admin/team');
        teamMembers = await teamResponse.json();
        populateOwnerFilter();
      } catch (e) {
        console.error('Error loading team:', e);
      }

      // Load view counts
      loadViewCounts();

      // Load default view
      loadAccounts();

      // Set up tab click handlers
      document.querySelectorAll('.view-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentView = tab.dataset.view;
          document.getElementById('viewDescription').textContent = viewDescriptions[currentView] || '';

          // Toggle between activity and accounts view
          if (currentView === 'activity') {
            document.getElementById('accountsContainer').style.display = 'none';
            document.getElementById('activityContainer').style.display = 'block';
            document.querySelector('.filters-bar').style.display = 'none';
            activityOffset = 0;
            loadActivityFeed();
          } else {
            document.getElementById('accountsContainer').style.display = 'block';
            document.getElementById('activityContainer').style.display = 'none';
            document.querySelector('.filters-bar').style.display = 'flex';
            loadAccounts();
          }
        });
      });

      // Set up activity filter handlers
      document.querySelectorAll('.activity-filter').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.activity-filter').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          activitySourceFilter = btn.dataset.source;
          activityOffset = 0;
          loadActivityFeed();
        });
      });
    }

    function populateOwnerFilter() {
      const select = document.getElementById('ownerFilter');
      let options = '<option value="">All Owners</option>';
      for (const member of teamMembers) {
        options += `<option value="${escapeHtml(member.workos_user_id)}">${escapeHtml(member.name || member.email)}</option>`;
      }
      select.innerHTML = options;
    }

    async function loadViewCounts() {
      try {
        const response = await fetch('/api/admin/accounts/view-counts');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const counts = await response.json();

        for (const [view, count] of Object.entries(counts)) {
          const badge = document.getElementById(`count-${view}`);
          if (badge) {
            badge.textContent = count;
          }
        }
      } catch (e) {
        console.error('Error loading view counts:', e);
      }
    }

    async function loadAccounts() {
      const searchValue = document.getElementById('searchInput').value.trim();
      const ownerValue = document.getElementById('ownerFilter').value;

      let url = `/api/admin/accounts?view=${currentView}`;
      if (searchValue) url += `&search=${encodeURIComponent(searchValue)}`;
      if (ownerValue) url += `&owner=${encodeURIComponent(ownerValue)}`;

      document.getElementById('accountsTable').innerHTML = '<tr><td colspan="7" class="loading">Loading...</td></tr>';

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        accounts = await response.json();
        renderAccounts();
      } catch (e) {
        console.error('Error loading accounts:', e);
        document.getElementById('accountsTable').innerHTML = '<tr><td colspan="8" class="empty-state">Error loading accounts</td></tr>';
      }
    }

    function renderAccounts() {
      if (accounts.length === 0) {
        document.getElementById('accountsTable').innerHTML = '<tr><td colspan="8" class="empty-state">No accounts found</td></tr>';
        return;
      }

      // Show extra column for needs_attention view
      const showExtraColumn = currentView === 'needs_attention';
      document.getElementById('extraColumnHeader').style.display = showExtraColumn ? '' : 'none';
      document.getElementById('extraColumnHeader').textContent = 'Reason';

      let html = '';
      for (const account of accounts) {
        const statusClass = account.is_disqualified ? 'disqualified' : account.member_status;
        const statusLabel = account.is_disqualified ? 'Disqualified' : capitalize(account.member_status);

        // Engagement fires
        const fires = account.engagement_fires || 0;
        const firesDisplay = fires > 0 ? 'ðŸ”¥'.repeat(fires) : '<span style="color: var(--color-text-muted);">â—‹</span>';

        // Interest badge
        let interestHtml = '';
        if (account.interest_level) {
          const interestLabels = { low: 'Low', medium: 'Med', high: 'High', very_high: 'V.High' };
          interestHtml = `<span class="interest-badge interest-${account.interest_level}">${interestLabels[account.interest_level]}</span>`;
        }

        // Last activity
        const activityHtml = formatActivityDate(account.last_activity_at);

        // Owner
        const ownerHtml = account.owner ? `<span class="owner-name">${escapeHtml(account.owner.user_name || 'Unknown')}</span>` : '-';

        // Extra column (attention reason)
        let extraColumnHtml = '';
        if (showExtraColumn && account.attention_reason) {
          const reasonLabels = {
            overdue: 'Overdue',
            due_soon: 'Due Soon',
            open_invoice: 'Invoice',
            going_cold: 'Going Cold',
            recent_activity: 'Active',
            high_engagement_unowned: 'Unowned',
            needs_review: 'Review',
            expiring_soon: 'Expiring'
          };
          extraColumnHtml = `<td><span class="attention-badge attention-${account.attention_reason}">${reasonLabels[account.attention_reason] || account.attention_reason}</span></td>`;
        } else if (showExtraColumn) {
          extraColumnHtml = '<td>-</td>';
        }

        // User count (members + slack-only users)
        const userCount = account.user_count || account.member_count || 0;
        const userCountHtml = userCount > 0 ? userCount : '<span style="color: var(--color-text-muted);">0</span>';

        html += `<tr>
          <td>
            <a href="/admin/accounts/${account.id}" class="account-name">${escapeHtml(account.name)}</a>
            ${account.domain ? `<div class="account-domain">${escapeHtml(account.domain)}</div>` : ''}
          </td>
          <td><span class="status-badge status-${statusClass}">${statusLabel}</span></td>
          <td>${userCountHtml}</td>
          <td class="engagement-fires">${firesDisplay}</td>
          <td>${interestHtml || '-'}</td>
          <td>${activityHtml}</td>
          <td>${ownerHtml}</td>
          ${extraColumnHtml}
        </tr>`;
      }

      document.getElementById('accountsTable').innerHTML = html;
    }

    function handleSearch() {
      if (searchTimeout) clearTimeout(searchTimeout);
      const searchValue = document.getElementById('searchInput').value.trim();

      if (searchValue.length === 0) {
        hideSearchResults();
        loadAccounts();
        return;
      }

      // Show typeahead after 2+ characters
      if (searchValue.length >= 2) {
        searchTimeout = setTimeout(() => {
          showSearchResults(searchValue);
        }, 150);
      } else {
        hideSearchResults();
      }
    }

    async function showSearchResults(query) {
      const resultsContainer = document.getElementById('searchResults');

      try {
        const response = await fetch(`/api/admin/accounts?view=all&search=${encodeURIComponent(query)}&limit=10`);
        if (!response.ok) throw new Error('Search failed');
        const results = await response.json();

        if (results.length === 0) {
          resultsContainer.innerHTML = '<div class="search-hint">No accounts found</div>';
        } else {
          let html = '';
          for (const account of results) {
            const statusClass = account.is_disqualified ? 'disqualified' : account.member_status;
            const fires = account.engagement_fires > 0 ? 'ðŸ”¥'.repeat(account.engagement_fires) : '';
            html += `
              <a href="/admin/accounts/${account.id}" class="search-result-item">
                <div>
                  <div class="search-result-name">${escapeHtml(account.name)}</div>
                  ${account.domain ? `<div class="search-result-domain">${escapeHtml(account.domain)}</div>` : ''}
                </div>
                <div class="search-result-meta">
                  ${fires ? `<span>${fires}</span>` : ''}
                  <span class="status-badge status-${statusClass}">${capitalize(account.member_status)}</span>
                </div>
              </a>
            `;
          }
          if (results.length === 10) {
            html += '<div class="search-hint">Press Enter to see all results</div>';
          }
          resultsContainer.innerHTML = html;
        }
        resultsContainer.style.display = 'block';
      } catch (e) {
        console.error('Search error:', e);
        resultsContainer.innerHTML = '<div class="search-hint">Error searching</div>';
        resultsContainer.style.display = 'block';
      }
    }

    function hideSearchResults() {
      document.getElementById('searchResults').style.display = 'none';
    }

    // Handle Enter key to load full results in table
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && document.activeElement.id === 'searchInput') {
        hideSearchResults();
        loadAccounts();
      }
      if (e.key === 'Escape') {
        hideSearchResults();
      }
    });

    // Hide search results when clicking outside
    document.addEventListener('click', (e) => {
      const searchContainer = document.querySelector('.search-container');
      if (!searchContainer.contains(e.target)) {
        hideSearchResults();
      }
    });

    function formatActivityDate(date) {
      if (!date) return '<span style="color: var(--color-text-muted);">Never</span>';

      const d = new Date(date);
      const now = new Date();
      const diffDays = Math.floor((now - d) / (1000 * 60 * 60 * 24));

      let className = '';
      if (diffDays <= 7) className = 'activity-recent';
      else if (diffDays <= 30) className = 'activity-stale';
      else className = 'activity-cold';

      let label;
      if (diffDays === 0) label = 'Today';
      else if (diffDays === 1) label = 'Yesterday';
      else if (diffDays < 7) label = `${diffDays}d ago`;
      else if (diffDays < 30) label = `${Math.floor(diffDays / 7)}w ago`;
      else label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

      return `<span class="${className}">${label}</span>`;
    }

    function capitalize(str) {
      if (!str) return '';
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Activity Feed Functions
    async function loadActivityFeed(append = false) {
      const feed = document.getElementById('activityFeed');
      const loadMoreContainer = document.getElementById('loadMoreContainer');

      if (!append) {
        feed.innerHTML = '<div class="loading" style="padding: var(--space-8);">Loading activity...</div>';
      }

      try {
        let url = `/api/admin/activity-feed?limit=50&offset=${activityOffset}`;
        if (activitySourceFilter && activitySourceFilter !== 'all') {
          url += `&source=${activitySourceFilter}`;
        }

        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load activity');

        const data = await response.json();
        activityData = append ? [...activityData, ...data.activities] : data.activities;

        renderActivityFeed(append);

        // Show/hide load more button
        loadMoreContainer.style.display = data.pagination.has_more ? 'block' : 'none';
      } catch (e) {
        console.error('Error loading activity feed:', e);
        if (!append) {
          feed.innerHTML = '<div class="empty-state">Error loading activity</div>';
        }
      }
    }

    function loadMoreActivity() {
      activityOffset += 50;
      loadActivityFeed(true);
    }

    function renderActivityFeed(append = false) {
      const feed = document.getElementById('activityFeed');

      if (activityData.length === 0) {
        feed.innerHTML = '<div class="empty-state">No recent activity</div>';
        return;
      }

      const sourceIcons = {
        slack: '#',
        email: '@',
        event: '*',
        payment: '$',
        working_group: '+'
      };

      const actionLabels = {
        message: 'posted a message',
        thread_reply: 'replied to a thread',
        channel_join: 'joined a channel',
        email_received: 'sent an email',
        registered: 'registered for',
        attended: 'attended',
        waitlisted: 'is waitlisted for',
        subscription_initial: 'started a subscription',
        subscription_recurring: 'renewed their subscription',
        one_time: 'made a payment',
        joined_group: 'joined'
      };

      let html = '';
      for (const activity of activityData) {
        const icon = sourceIcons[activity.source] || '?';
        const actionLabel = actionLabels[activity.action] || activity.action;
        const timeAgo = formatRelativeTime(activity.timestamp);

        // Build org link if available
        let orgHtml = '';
        if (activity.org_id) {
          orgHtml = `<a href="/admin/accounts/${activity.org_id}" class="activity-org">${escapeHtml(activity.org_name || 'Unknown')}</a>`;
        } else if (activity.org_name) {
          orgHtml = `<span class="activity-org" style="color: var(--color-text-secondary);">${escapeHtml(activity.org_name)}</span>`;
        }

        // Format payment amount if available
        let descriptionHtml = '';
        if (activity.description) {
          descriptionHtml = `<div class="activity-description">${escapeHtml(activity.description)}</div>`;
        }
        if (activity.metadata?.amount) {
          const amount = (activity.metadata.amount / 100).toLocaleString('en-US', { style: 'currency', currency: activity.metadata.currency || 'USD' });
          descriptionHtml = `<div class="activity-description">${amount}</div>`;
        }

        html += `
          <div class="activity-item">
            <div class="activity-icon ${activity.source}">${icon}</div>
            <div class="activity-content">
              <div class="activity-header">
                <span class="activity-actor">${escapeHtml(activity.actor_name || 'Unknown')}</span>
                <span class="activity-action">${actionLabel}</span>
                ${orgHtml}
              </div>
              ${descriptionHtml}
            </div>
            <span class="activity-time">${timeAgo}</span>
          </div>
        `;
      }

      if (append) {
        feed.innerHTML += html;
      } else {
        feed.innerHTML = html;
      }
    }

    function formatRelativeTime(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Enrichment Panel Functions
    let enrichmentPanelVisible = false;
    let enrichmentStats = null;

    function toggleEnrichmentPanel() {
      enrichmentPanelVisible = !enrichmentPanelVisible;
      document.getElementById('enrichmentPanel').style.display = enrichmentPanelVisible ? 'block' : 'none';
      document.getElementById('showEnrichmentBtn').style.display = enrichmentPanelVisible ? 'none' : 'inline-block';

      if (enrichmentPanelVisible && !enrichmentStats) {
        loadEnrichmentStats();
      }
    }

    async function loadEnrichmentStats() {
      const content = document.getElementById('enrichmentContent');
      content.innerHTML = '<div class="loading">Loading enrichment stats...</div>';

      try {
        const response = await fetch('/api/admin/enrichment/stats');
        if (!response.ok) throw new Error('Failed to load stats');
        enrichmentStats = await response.json();
        renderEnrichmentPanel();
      } catch (e) {
        console.error('Error loading enrichment stats:', e);
        content.innerHTML = '<div class="enrichment-not-configured">Unable to load enrichment statistics</div>';
      }
    }

    function renderEnrichmentPanel() {
      const content = document.getElementById('enrichmentContent');

      if (!enrichmentStats.configured) {
        content.innerHTML = '<div class="enrichment-not-configured">Lusha API not configured. Set LUSHA_API_KEY to enable company research.</div>';
        return;
      }

      const totalNeedsEnrichment = enrichmentStats.accounts_with_users.needs_enrichment + enrichmentStats.empty_prospects.needs_enrichment;

      content.innerHTML = `
        <div class="enrichment-stats">
          <div class="enrichment-stat-card">
            <div class="enrichment-stat-label">Accounts with Users</div>
            <div class="enrichment-stat-value">${enrichmentStats.accounts_with_users.enriched} / ${enrichmentStats.accounts_with_users.total}</div>
            <div class="enrichment-stat-detail">${enrichmentStats.accounts_with_users.needs_enrichment} need research</div>
          </div>
          <div class="enrichment-stat-card">
            <div class="enrichment-stat-label">Empty Prospects</div>
            <div class="enrichment-stat-value">${enrichmentStats.empty_prospects.enriched} / ${enrichmentStats.empty_prospects.total}</div>
            <div class="enrichment-stat-detail">${enrichmentStats.empty_prospects.needs_enrichment} need research</div>
          </div>
          <div class="enrichment-stat-card">
            <div class="enrichment-stat-label">Total Needing Research</div>
            <div class="enrichment-stat-value">${totalNeedsEnrichment}</div>
            <div class="enrichment-stat-detail">Accounts with users prioritized</div>
          </div>
        </div>
        <div class="enrichment-actions">
          <button class="btn-primary" id="runEnrichmentBtn" onclick="runEnrichment()" ${totalNeedsEnrichment === 0 ? 'disabled' : ''}>
            Run Research (up to 50)
          </button>
          <label class="checkbox-label">
            <input type="checkbox" id="includeProspectsCheckbox" checked>
            Include empty prospects
          </label>
        </div>
        <div id="enrichmentResult"></div>
      `;
    }

    async function runEnrichment() {
      const btn = document.getElementById('runEnrichmentBtn');
      const resultDiv = document.getElementById('enrichmentResult');
      const includeProspects = document.getElementById('includeProspectsCheckbox').checked;

      btn.disabled = true;
      btn.textContent = 'Running...';
      resultDiv.innerHTML = '';

      try {
        const response = await fetch('/api/admin/enrichment/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            limit: 50,
            includeEmptyProspects: includeProspects
          })
        });

        if (!response.ok) throw new Error('Failed to run enrichment');
        const result = await response.json();

        resultDiv.innerHTML = `
          <div class="enrichment-result success">
            Processed ${result.total} accounts: ${result.enriched} enriched, ${result.skipped} not found, ${result.failed} failed
          </div>
        `;

        // Reload stats after enrichment
        await loadEnrichmentStats();
      } catch (e) {
        console.error('Error running enrichment:', e);
        resultDiv.innerHTML = `
          <div class="enrichment-result error">
            Error running enrichment: ${e.message}
          </div>
        `;
        btn.disabled = false;
        btn.textContent = 'Run Research (up to 50)';
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
