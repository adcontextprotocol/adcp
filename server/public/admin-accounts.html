<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Accounts - AgenticAdvertising.org</title>
  <link rel="stylesheet" href="/design-system.css">
  <script src="/js/company-types.js"></script>
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <style>
    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-wide);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    h1 {
      margin-bottom: var(--space-2);
      color: var(--color-text-heading);
    }
    .subtitle {
      color: var(--color-text-secondary);
      margin-bottom: var(--space-6);
    }

    /* View tabs */
    .view-tabs {
      display: flex;
      gap: var(--space-1);
      margin-bottom: var(--space-5);
      flex-wrap: wrap;
      border-bottom: var(--border-1) solid var(--color-gray-200);
      padding-bottom: var(--space-3);
    }
    .view-tab {
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
      background: transparent;
      border: none;
      color: var(--color-text-secondary);
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
    }
    .view-tab:hover {
      background: var(--color-gray-100);
      color: var(--color-text-heading);
    }
    .view-tab.active {
      background: var(--color-brand);
      color: white;
    }
    .view-tab .badge {
      font-size: var(--text-xs);
      padding: var(--space-0) var(--space-2);
      border-radius: var(--radius-full);
      background: rgba(255,255,255,0.2);
    }
    .view-tab:not(.active) .badge {
      background: var(--color-gray-200);
      color: var(--color-text-secondary);
    }

    /* Filters */
    .filters-bar {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
      flex-wrap: wrap;
      align-items: center;
    }
    .search-input {
      padding: var(--space-2) var(--space-3);
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      width: 250px;
    }
    .filter-select {
      padding: var(--space-2) var(--space-3);
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      background: white;
    }

    /* Table */
    .table-container {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-xs);
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th {
      text-align: left;
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: var(--border-1) solid var(--color-gray-200);
      background: var(--color-gray-50);
    }
    td {
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-sm);
      border-bottom: var(--border-1) solid var(--color-gray-100);
      vertical-align: middle;
    }
    tr:hover td {
      background: var(--color-gray-50);
    }
    tr:last-child td {
      border-bottom: none;
    }

    /* Account name link */
    .account-name {
      font-weight: var(--font-semibold);
      color: var(--color-brand);
      text-decoration: none;
    }
    .account-name:hover {
      text-decoration: underline;
    }
    .account-domain {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
    }

    /* Member status badges */
    .status-badge {
      display: inline-block;
      padding: var(--space-0) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
    }
    .status-member { background: var(--color-success-600); color: white; }
    .status-trial { background: var(--color-warning-500); color: white; }
    .status-lapsed { background: var(--color-info-500); color: white; }
    .status-prospect { background: var(--color-gray-200); color: var(--color-text-heading); }
    .status-disqualified { background: var(--color-gray-400); color: white; }

    /* Interest badges */
    .interest-badge {
      display: inline-block;
      padding: var(--space-0) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .interest-low { background: var(--color-gray-200); color: var(--color-text-secondary); }
    .interest-medium { background: var(--color-warning-100); color: var(--color-warning-700); }
    .interest-high { background: var(--color-success-100); color: var(--color-success-700); }
    .interest-very_high { background: var(--color-success-200); color: var(--color-success-800); }

    /* Engagement fires */
    .engagement-fires {
      letter-spacing: 1px;
    }

    /* Owner */
    .owner-name {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }

    /* Attention reason badge */
    .attention-badge {
      display: inline-block;
      padding: var(--space-0) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
    }
    .attention-overdue { background: var(--color-error-100); color: var(--color-error-700); }
    .attention-due_soon { background: var(--color-warning-100); color: var(--color-warning-700); }
    .attention-open_invoice { background: var(--color-info-100); color: var(--color-info-700); }
    .attention-going_cold { background: var(--color-gray-200); color: var(--color-text-secondary); }
    .attention-recent_activity { background: var(--color-success-100); color: var(--color-success-700); }
    .attention-high_engagement_unowned { background: var(--color-warning-100); color: var(--color-warning-700); }
    .attention-needs_review { background: var(--color-gray-200); color: var(--color-text-secondary); }

    /* Activity date coloring */
    .activity-recent { color: var(--color-success-600); }
    .activity-stale { color: var(--color-warning-600); }
    .activity-cold { color: var(--color-error-600); }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: var(--space-10);
      color: var(--color-text-muted);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: var(--space-10);
      color: var(--color-text-secondary);
    }

    /* Search - Primary */
    .search-container {
      position: relative;
      margin-bottom: var(--space-5);
    }
    .search-input-primary {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      border: var(--border-2) solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--text-base);
      transition: var(--transition-all);
    }
    .search-input-primary:focus {
      outline: none;
      border-color: var(--color-brand);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--color-bg-card);
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      max-height: 400px;
      overflow-y: auto;
      z-index: 100;
      margin-top: var(--space-1);
    }
    .search-result-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-3) var(--space-4);
      cursor: pointer;
      border-bottom: var(--border-1) solid var(--color-gray-100);
      text-decoration: none;
      color: inherit;
    }
    .search-result-item:last-child {
      border-bottom: none;
    }
    .search-result-item:hover {
      background: var(--color-gray-50);
    }
    .search-result-name {
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
    }
    .search-result-domain {
      font-size: var(--text-sm);
      color: var(--color-text-muted);
    }
    .search-result-meta {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
    }
    .search-hint {
      padding: var(--space-3) var(--space-4);
      color: var(--color-text-muted);
      font-size: var(--text-sm);
      text-align: center;
    }

    /* Quick actions */
    .quick-actions {
      display: flex;
      gap: var(--space-2);
    }
    .btn {
      padding: var(--space-1) var(--space-2);
      border: none;
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .btn-secondary {
      background: var(--color-gray-100);
      color: var(--color-text-heading);
    }
    .btn-secondary:hover {
      background: var(--color-gray-200);
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <div id="adcp-nav"></div>

  <div class="container">
    <h1>Accounts</h1>

    <!-- Search - Primary Action -->
    <div class="search-container">
      <input type="text" class="search-input-primary" id="searchInput" placeholder="Search accounts by name or domain..." oninput="handleSearch()" autofocus>
      <div class="search-results" id="searchResults" style="display: none;"></div>
    </div>

    <p class="subtitle" id="viewDescription">Accounts needing action: overdue tasks, open invoices, high engagement unowned</p>

    <!-- View Tabs -->
    <div class="view-tabs">
      <button class="view-tab active" data-view="needs_attention">
        Needs Attention <span class="badge" id="count-needs_attention">-</span>
      </button>
      <button class="view-tab" data-view="new_insights">
        New Insights <span class="badge" id="count-new_insights">-</span>
      </button>
      <button class="view-tab" data-view="hot">
        Hot Prospects <span class="badge" id="count-hot">-</span>
      </button>
      <button class="view-tab" data-view="new_prospects">
        New Prospects <span class="badge" id="count-new_prospects">-</span>
      </button>
      <button class="view-tab" data-view="going_cold">
        Going Cold <span class="badge" id="count-going_cold">-</span>
      </button>
      <button class="view-tab" data-view="my_accounts">
        My Accounts <span class="badge" id="count-my_accounts">-</span>
      </button>
      <button class="view-tab" data-view="renewals">
        Renewals <span class="badge" id="count-renewals">-</span>
      </button>
      <button class="view-tab" data-view="members">
        Members <span class="badge" id="count-members">-</span>
      </button>
      <button class="view-tab" data-view="all">
        All
      </button>
      <button class="view-tab" data-view="disqualified">
        Disqualified <span class="badge" id="count-disqualified">-</span>
      </button>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
      <select class="filter-select" id="ownerFilter" onchange="loadAccounts()">
        <option value="">All Owners</option>
      </select>
    </div>

    <!-- Table -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Account</th>
            <th>Status</th>
            <th style="width: 60px;">ðŸ”¥</th>
            <th>Interest</th>
            <th>Last Activity</th>
            <th>Owner</th>
            <th id="extraColumnHeader" style="display: none;"></th>
          </tr>
        </thead>
        <tbody id="accountsTable">
          <tr><td colspan="7" class="loading">Loading accounts...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let accounts = [];
    let teamMembers = [];
    let currentView = 'needs_attention';
    let searchTimeout = null;

    const viewDescriptions = {
      needs_attention: 'Accounts needing action: overdue tasks, open invoices, unowned hot prospects',
      new_insights: 'Prospects with recent Slack activity from their team',
      hot: 'High engagement prospects ready to convert',
      new_prospects: 'Recently created prospect accounts',
      going_cold: 'Prospects losing engagement (no activity in 30+ days)',
      my_accounts: 'Accounts you own or are watching',
      renewals: 'Members with subscriptions ending soon',
      members: 'All paying member organizations',
      all: 'All accounts',
      disqualified: 'Accounts marked as not viable'
    };

    async function init() {
      // Load team members for owner filter
      try {
        const teamResponse = await fetch('/api/admin/team');
        teamMembers = await teamResponse.json();
        populateOwnerFilter();
      } catch (e) {
        console.error('Error loading team:', e);
      }

      // Load view counts
      loadViewCounts();

      // Load default view
      loadAccounts();

      // Set up tab click handlers
      document.querySelectorAll('.view-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentView = tab.dataset.view;
          document.getElementById('viewDescription').textContent = viewDescriptions[currentView] || '';
          loadAccounts();
        });
      });
    }

    function populateOwnerFilter() {
      const select = document.getElementById('ownerFilter');
      let options = '<option value="">All Owners</option>';
      for (const member of teamMembers) {
        options += `<option value="${escapeHtml(member.workos_user_id)}">${escapeHtml(member.name || member.email)}</option>`;
      }
      select.innerHTML = options;
    }

    async function loadViewCounts() {
      try {
        const response = await fetch('/api/admin/accounts/view-counts');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const counts = await response.json();

        for (const [view, count] of Object.entries(counts)) {
          const badge = document.getElementById(`count-${view}`);
          if (badge) {
            badge.textContent = count;
          }
        }
      } catch (e) {
        console.error('Error loading view counts:', e);
      }
    }

    async function loadAccounts() {
      const searchValue = document.getElementById('searchInput').value.trim();
      const ownerValue = document.getElementById('ownerFilter').value;

      let url = `/api/admin/accounts?view=${currentView}`;
      if (searchValue) url += `&search=${encodeURIComponent(searchValue)}`;
      if (ownerValue) url += `&owner=${encodeURIComponent(ownerValue)}`;

      document.getElementById('accountsTable').innerHTML = '<tr><td colspan="7" class="loading">Loading...</td></tr>';

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        accounts = await response.json();
        renderAccounts();
      } catch (e) {
        console.error('Error loading accounts:', e);
        document.getElementById('accountsTable').innerHTML = '<tr><td colspan="7" class="empty-state">Error loading accounts</td></tr>';
      }
    }

    function renderAccounts() {
      if (accounts.length === 0) {
        document.getElementById('accountsTable').innerHTML = '<tr><td colspan="7" class="empty-state">No accounts found</td></tr>';
        return;
      }

      // Show extra column for needs_attention view
      const showExtraColumn = currentView === 'needs_attention';
      document.getElementById('extraColumnHeader').style.display = showExtraColumn ? '' : 'none';
      document.getElementById('extraColumnHeader').textContent = 'Reason';

      let html = '';
      for (const account of accounts) {
        const statusClass = account.is_disqualified ? 'disqualified' : account.member_status;
        const statusLabel = account.is_disqualified ? 'Disqualified' : capitalize(account.member_status);

        // Engagement fires
        const fires = account.engagement_fires || 0;
        const firesDisplay = fires > 0 ? 'ðŸ”¥'.repeat(fires) : '<span style="color: var(--color-text-muted);">â—‹</span>';

        // Interest badge
        let interestHtml = '';
        if (account.interest_level) {
          const interestLabels = { low: 'Low', medium: 'Med', high: 'High', very_high: 'V.High' };
          interestHtml = `<span class="interest-badge interest-${account.interest_level}">${interestLabels[account.interest_level]}</span>`;
        }

        // Last activity
        const activityHtml = formatActivityDate(account.last_activity_at);

        // Owner
        const ownerHtml = account.owner ? `<span class="owner-name">${escapeHtml(account.owner.user_name || 'Unknown')}</span>` : '-';

        // Extra column (attention reason)
        let extraColumnHtml = '';
        if (showExtraColumn && account.attention_reason) {
          const reasonLabels = {
            overdue: 'Overdue',
            due_soon: 'Due Soon',
            open_invoice: 'Invoice',
            going_cold: 'Going Cold',
            recent_activity: 'Active',
            high_engagement_unowned: 'Unowned',
            needs_review: 'Review'
          };
          extraColumnHtml = `<td><span class="attention-badge attention-${account.attention_reason}">${reasonLabels[account.attention_reason] || account.attention_reason}</span></td>`;
        } else if (showExtraColumn) {
          extraColumnHtml = '<td>-</td>';
        }

        html += `<tr>
          <td>
            <a href="/admin/accounts/${account.id}" class="account-name">${escapeHtml(account.name)}</a>
            ${account.domain ? `<div class="account-domain">${escapeHtml(account.domain)}</div>` : ''}
          </td>
          <td><span class="status-badge status-${statusClass}">${statusLabel}</span></td>
          <td class="engagement-fires">${firesDisplay}</td>
          <td>${interestHtml || '-'}</td>
          <td>${activityHtml}</td>
          <td>${ownerHtml}</td>
          ${extraColumnHtml}
        </tr>`;
      }

      document.getElementById('accountsTable').innerHTML = html;
    }

    function handleSearch() {
      if (searchTimeout) clearTimeout(searchTimeout);
      const searchValue = document.getElementById('searchInput').value.trim();

      if (searchValue.length === 0) {
        hideSearchResults();
        loadAccounts();
        return;
      }

      // Show typeahead after 2+ characters
      if (searchValue.length >= 2) {
        searchTimeout = setTimeout(() => {
          showSearchResults(searchValue);
        }, 150);
      } else {
        hideSearchResults();
      }
    }

    async function showSearchResults(query) {
      const resultsContainer = document.getElementById('searchResults');

      try {
        const response = await fetch(`/api/admin/accounts?view=all&search=${encodeURIComponent(query)}&limit=10`);
        if (!response.ok) throw new Error('Search failed');
        const results = await response.json();

        if (results.length === 0) {
          resultsContainer.innerHTML = '<div class="search-hint">No accounts found</div>';
        } else {
          let html = '';
          for (const account of results) {
            const statusClass = account.is_disqualified ? 'disqualified' : account.member_status;
            const fires = account.engagement_fires > 0 ? 'ðŸ”¥'.repeat(account.engagement_fires) : '';
            html += `
              <a href="/admin/accounts/${account.id}" class="search-result-item">
                <div>
                  <div class="search-result-name">${escapeHtml(account.name)}</div>
                  ${account.domain ? `<div class="search-result-domain">${escapeHtml(account.domain)}</div>` : ''}
                </div>
                <div class="search-result-meta">
                  ${fires ? `<span>${fires}</span>` : ''}
                  <span class="status-badge status-${statusClass}">${capitalize(account.member_status)}</span>
                </div>
              </a>
            `;
          }
          if (results.length === 10) {
            html += '<div class="search-hint">Press Enter to see all results</div>';
          }
          resultsContainer.innerHTML = html;
        }
        resultsContainer.style.display = 'block';
      } catch (e) {
        console.error('Search error:', e);
        resultsContainer.innerHTML = '<div class="search-hint">Error searching</div>';
        resultsContainer.style.display = 'block';
      }
    }

    function hideSearchResults() {
      document.getElementById('searchResults').style.display = 'none';
    }

    // Handle Enter key to load full results in table
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && document.activeElement.id === 'searchInput') {
        hideSearchResults();
        loadAccounts();
      }
      if (e.key === 'Escape') {
        hideSearchResults();
      }
    });

    // Hide search results when clicking outside
    document.addEventListener('click', (e) => {
      const searchContainer = document.querySelector('.search-container');
      if (!searchContainer.contains(e.target)) {
        hideSearchResults();
      }
    });

    function formatActivityDate(date) {
      if (!date) return '<span style="color: var(--color-text-muted);">Never</span>';

      const d = new Date(date);
      const now = new Date();
      const diffDays = Math.floor((now - d) / (1000 * 60 * 60 * 24));

      let className = '';
      if (diffDays <= 7) className = 'activity-recent';
      else if (diffDays <= 30) className = 'activity-stale';
      else className = 'activity-cold';

      let label;
      if (diffDays === 0) label = 'Today';
      else if (diffDays === 1) label = 'Yesterday';
      else if (diffDays < 7) label = `${diffDays}d ago`;
      else if (diffDays < 30) label = `${Math.floor(diffDays / 7)}w ago`;
      else label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

      return `<span class="${className}">${label}</span>`;
    }

    function capitalize(str) {
      if (!str) return '';
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
