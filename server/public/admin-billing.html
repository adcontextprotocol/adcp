<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Billing - Admin</title>
  <link rel="stylesheet" href="/design-system.css">
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <style>
    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-wide);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    h1 { margin-bottom: var(--space-2); color: var(--color-text-heading); }
    .subtitle { color: var(--color-text-secondary); margin-bottom: var(--space-6); }

    .stats-row {
      display: flex;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }
    .stat-card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-5);
      flex: 1;
      box-shadow: var(--shadow-xs);
    }
    .stat-label {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
    }
    .stat-value {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
    }
    .stat-value.warning { color: var(--color-warning-600); }
    .stat-value.success { color: var(--color-success-600); }

    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      box-shadow: var(--shadow-xs);
      margin-bottom: var(--space-5);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-5);
    }
    .card-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
    }

    .customers-table {
      width: 100%;
      border-collapse: collapse;
    }
    .customers-table th {
      background: var(--color-gray-50);
      padding: var(--space-3) var(--space-4);
      text-align: left;
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      border-bottom: var(--border-1) solid var(--color-border);
    }
    .customers-table td {
      padding: var(--space-3) var(--space-4);
      border-bottom: var(--border-1) solid var(--color-border);
      font-size: var(--text-sm);
      color: var(--color-text-heading);
    }
    .customers-table tr:hover {
      background: var(--color-gray-50);
    }
    .customers-table tr.linked {
      opacity: 0.6;
    }
    .customers-table tr.unlinked-with-payments {
      background: var(--color-warning-50);
    }
    .customers-table tr.unlinked-with-payments:hover {
      background: var(--color-warning-100);
    }

    .badge {
      display: inline-block;
      padding: var(--space-0.5) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .badge-success {
      background: var(--color-success-100);
      color: var(--color-success-800);
    }
    .badge-warning {
      background: var(--color-warning-100);
      color: var(--color-warning-800);
    }
    .badge-gray {
      background: var(--color-gray-100);
      color: var(--color-gray-700);
    }

    .link-form {
      display: flex;
      gap: var(--space-2);
      align-items: center;
    }
    .link-form input {
      padding: var(--space-1.5) var(--space-2);
      border: var(--border-1) solid var(--color-gray-300);
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
      width: 200px;
    }
    .link-form input:focus {
      outline: none;
      border-color: var(--color-brand);
      box-shadow: 0 0 0 2px var(--color-primary-100);
    }

    .btn {
      padding: var(--space-1.5) var(--space-3);
      border: none;
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .btn-primary {
      background: var(--color-brand);
      color: white;
    }
    .btn-primary:hover {
      background: var(--color-primary-700);
    }
    .btn-primary:disabled {
      background: var(--color-gray-300);
      cursor: not-allowed;
    }
    .btn-secondary {
      background: var(--color-gray-200);
      color: var(--color-text-heading);
    }
    .btn-secondary:hover {
      background: var(--color-gray-300);
    }

    .search-dropdown {
      position: relative;
    }
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--color-bg-card);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-lg);
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    .search-results.show {
      display: block;
    }
    .search-result-item {
      padding: var(--space-2) var(--space-3);
      cursor: pointer;
      border-bottom: var(--border-1) solid var(--color-gray-100);
    }
    .search-result-item:hover {
      background: var(--color-gray-50);
    }
    .search-result-item:last-child {
      border-bottom: none;
    }
    .search-result-name {
      font-weight: var(--font-medium);
      color: var(--color-text-heading);
    }
    .search-result-domain {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
    }
    .search-result-linked {
      font-size: var(--text-xs);
      color: var(--color-warning-600);
    }

    .loading {
      text-align: center;
      padding: var(--space-10);
      color: var(--color-text-secondary);
    }
    .loading-spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid var(--color-gray-200);
      border-top-color: var(--color-brand);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: var(--color-error-50);
      color: var(--color-error-800);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-5);
    }
    .success-message {
      background: var(--color-success-50);
      color: var(--color-success-800);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-5);
    }

    .filter-toggle {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
    }
    .filter-btn {
      padding: var(--space-2) var(--space-4);
      border: var(--border-1) solid var(--color-gray-200);
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .filter-btn:hover {
      background: var(--color-gray-50);
    }
    .filter-btn.active {
      background: var(--color-brand);
      color: white;
      border-color: var(--color-brand);
    }
  </style>
</head>
<body>
  <div id="adcp-nav"></div>

  <div class="container">
    <h1>Stripe Customer Linking</h1>
    <p class="subtitle">Link Stripe customers to organizations for revenue tracking</p>

    <div id="error-message" class="error-message" style="display: none;"></div>
    <div id="success-message" class="success-message" style="display: none;"></div>

    <div class="stats-row" id="stats-row">
      <div class="stat-card">
        <div class="stat-label">Total Customers</div>
        <div class="stat-value" id="stat-total">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Linked</div>
        <div class="stat-value success" id="stat-linked">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Unlinked</div>
        <div class="stat-value" id="stat-unlinked">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Unlinked with Payments</div>
        <div class="stat-value warning" id="stat-unlinked-payments">-</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Stripe Customers</div>
        <button class="btn btn-secondary" onclick="loadCustomers()">Refresh</button>
      </div>

      <div class="filter-toggle">
        <button class="filter-btn active" data-filter="all" onclick="setFilter('all', this)">All</button>
        <button class="filter-btn" data-filter="unlinked" onclick="setFilter('unlinked', this)">Unlinked Only</button>
        <button class="filter-btn" data-filter="unlinked-payments" onclick="setFilter('unlinked-payments', this)">Unlinked with Payments</button>
      </div>

      <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p>Loading Stripe customers...</p>
      </div>

      <table class="customers-table" id="customers-table" style="display: none;">
        <thead>
          <tr>
            <th>Customer</th>
            <th>Email</th>
            <th>Total Paid</th>
            <th>Invoices</th>
            <th>Linked To</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="customers-body">
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let allCustomers = [];
    let currentFilter = 'all';

    const formatCurrency = (cents) => {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
      }).format(cents / 100);
    };

    const formatDate = (timestamp) => {
      return new Date(timestamp * 1000).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      });
    };

    function showError(message) {
      const el = document.getElementById('error-message');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }

    function showSuccess(message) {
      const el = document.getElementById('success-message');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }

    function setFilter(filter, btn) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderCustomers();
    }

    function getFilteredCustomers() {
      switch (currentFilter) {
        case 'unlinked':
          return allCustomers.filter(c => !c.linked_org);
        case 'unlinked-payments':
          return allCustomers.filter(c => !c.linked_org && c.total_paid > 0);
        default:
          return allCustomers;
      }
    }

    function renderCustomers() {
      const tbody = document.getElementById('customers-body');
      const customers = getFilteredCustomers();

      tbody.innerHTML = customers.map(customer => {
        const isLinked = !!customer.linked_org;
        const hasPayments = customer.total_paid > 0;
        const rowClass = isLinked ? 'linked' : (hasPayments ? 'unlinked-with-payments' : '');

        return `
          <tr class="${rowClass}" data-customer-id="${customer.id}">
            <td>
              <div><strong>${customer.name || 'No name'}</strong></div>
              <div style="font-size: 11px; color: var(--color-text-muted);">${customer.id}</div>
            </td>
            <td>${customer.email || '-'}</td>
            <td>${hasPayments ? formatCurrency(customer.total_paid) : '-'}</td>
            <td>${customer.invoice_count || '-'}</td>
            <td>
              ${isLinked
                ? `<span class="badge badge-success">${customer.linked_org.name}</span>`
                : '<span class="badge badge-warning">Not linked</span>'
              }
            </td>
            <td>
              ${isLinked
                ? '<span style="color: var(--color-text-muted);">Linked</span>'
                : `<div class="link-form">
                    <div class="search-dropdown">
                      <input type="text"
                             placeholder="Search org..."
                             id="search-${customer.id}"
                             oninput="searchOrgs('${customer.id}', this.value)"
                             onfocus="showSearchResults('${customer.id}')"
                      />
                      <div class="search-results" id="results-${customer.id}"></div>
                    </div>
                    <button class="btn btn-primary" id="link-btn-${customer.id}" disabled onclick="linkCustomer('${customer.id}')">Link</button>
                  </div>`
              }
            </td>
          </tr>
        `;
      }).join('');
    }

    let searchTimeout = null;
    let selectedOrgs = {};

    function showSearchResults(customerId) {
      // Close other dropdowns
      document.querySelectorAll('.search-results').forEach(el => el.classList.remove('show'));
    }

    async function searchOrgs(customerId, query) {
      const resultsEl = document.getElementById(`results-${customerId}`);

      if (query.length < 2) {
        resultsEl.classList.remove('show');
        return;
      }

      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`/api/admin/org-search?q=${encodeURIComponent(query)}`);
          const data = await response.json();

          if (data.organizations.length === 0) {
            resultsEl.innerHTML = '<div class="search-result-item" style="color: var(--color-text-muted);">No results</div>';
          } else {
            resultsEl.innerHTML = data.organizations.map(org => `
              <div class="search-result-item" onclick="selectOrg('${customerId}', '${org.workos_organization_id}', '${org.name.replace(/'/g, "\\'")}')">
                <div class="search-result-name">${org.name}</div>
                ${org.email_domain ? `<div class="search-result-domain">${org.email_domain}</div>` : ''}
                ${org.stripe_customer_id ? `<div class="search-result-linked">Already linked to another customer</div>` : ''}
              </div>
            `).join('');
          }
          resultsEl.classList.add('show');
        } catch (err) {
          console.error('Search error:', err);
        }
      }, 300);
    }

    function selectOrg(customerId, orgId, orgName) {
      selectedOrgs[customerId] = { id: orgId, name: orgName };
      document.getElementById(`search-${customerId}`).value = orgName;
      document.getElementById(`results-${customerId}`).classList.remove('show');
      document.getElementById(`link-btn-${customerId}`).disabled = false;
    }

    async function linkCustomer(customerId) {
      const selectedOrg = selectedOrgs[customerId];
      if (!selectedOrg) {
        showError('Please select an organization first');
        return;
      }

      const btn = document.getElementById(`link-btn-${customerId}`);
      btn.disabled = true;
      btn.textContent = 'Linking...';

      try {
        const response = await fetch(`/api/admin/stripe-customers/${customerId}/link`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ org_id: selectedOrg.id }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || data.error || 'Failed to link customer');
        }

        showSuccess(`Linked to "${selectedOrg.name}"`);
        delete selectedOrgs[customerId];

        // Update local data and re-render
        const customer = allCustomers.find(c => c.id === customerId);
        if (customer) {
          customer.linked_org = { id: selectedOrg.id, name: selectedOrg.name };
        }
        updateStats();
        renderCustomers();
      } catch (err) {
        showError(err.message);
        btn.disabled = false;
        btn.textContent = 'Link';
      }
    }

    function updateStats() {
      const total = allCustomers.length;
      const linked = allCustomers.filter(c => c.linked_org).length;
      const unlinked = total - linked;
      const unlinkedWithPayments = allCustomers.filter(c => !c.linked_org && c.total_paid > 0).length;

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-linked').textContent = linked;
      document.getElementById('stat-unlinked').textContent = unlinked;
      document.getElementById('stat-unlinked-payments').textContent = unlinkedWithPayments;
    }

    async function loadCustomers() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('customers-table').style.display = 'none';

      try {
        const response = await fetch('/api/admin/stripe-customers');
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || data.error || 'Failed to load customers');
        }

        allCustomers = data.customers;
        updateStats();
        renderCustomers();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('customers-table').style.display = 'table';
      } catch (err) {
        document.getElementById('loading').innerHTML = `<p style="color: var(--color-error-600);">Error: ${err.message}</p>`;
      }
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-dropdown')) {
        document.querySelectorAll('.search-results').forEach(el => el.classList.remove('show'));
      }
    });

    // Load on page load
    loadCustomers();
  </script>
</body>
</html>
