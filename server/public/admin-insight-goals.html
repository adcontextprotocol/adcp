<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Admin - Insight Goals - AgenticAdvertising.org</title>
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <link rel="stylesheet" href="/design-system.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 20px;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .page-header h1 {
      color: var(--color-text-heading);
      font-size: 24px;
    }
    .page-header p {
      color: var(--color-text-secondary);
      margin-top: 4px;
    }
    .card {
      background: var(--color-bg-card);
      border-radius: 8px;
      padding: 24px;
      box-shadow: var(--shadow-sm);
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary { background: var(--color-brand); color: white; }
    .btn-primary:hover { background: var(--color-brand-hover); }
    .btn-secondary { background: var(--color-gray-200); color: var(--color-text-heading); }
    .btn-secondary:hover { background: var(--color-gray-300); }
    .btn-small { padding: 6px 12px; font-size: 12px; }
    .btn-danger { background: var(--color-danger); color: white; }
    .btn-danger:hover { background: var(--color-danger-hover); }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid var(--color-border);
    }
    th {
      font-weight: 600;
      color: var(--color-text-secondary);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .goal-name {
      font-weight: 500;
      color: var(--color-text-heading);
    }
    .goal-question {
      color: var(--color-text-secondary);
      font-size: 13px;
      max-width: 300px;
    }
    .badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    .badge-success { background: var(--color-success-light); color: var(--color-success); }
    .badge-warning { background: var(--color-warning-light); color: var(--color-warning-dark); }
    .badge-info { background: var(--color-primary-50); color: var(--color-brand); }
    .badge-muted { background: var(--color-gray-100); color: var(--color-text-muted); }
    .progress-bar {
      width: 100px;
      height: 8px;
      background: var(--color-gray-200);
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: var(--color-brand);
      border-radius: 4px;
    }
    .progress-text {
      font-size: 12px;
      color: var(--color-text-secondary);
      margin-top: 4px;
    }
    .actions { display: flex; gap: 8px; }
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--color-surface-overlay);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .modal {
      background: var(--color-bg-card);
      border-radius: 8px;
      padding: 24px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h2 {
      margin-bottom: 20px;
      color: var(--color-text-heading);
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--color-text-heading);
    }
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    .form-group small {
      color: var(--color-text-muted);
      font-size: 12px;
      margin-top: 4px;
      display: block;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .form-group .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    .form-group .checkbox-label input { width: auto; }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 24px;
    }
    .empty-state, .loading {
      text-align: center;
      padding: 40px;
      color: var(--color-text-secondary);
    }
    .error-message {
      background: var(--color-danger-light);
      color: var(--color-danger);
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
    }
    .campaign-dates {
      display: none;
    }
    .campaign-dates.show {
      display: block;
    }
  </style>
</head>
<body>
  <div id="adcp-nav"></div>

  <div class="container">
    <div class="page-header">
      <div>
        <h1>Insight Goals</h1>
        <p>Define what questions Addie should explore with members</p>
      </div>
      <button class="btn btn-primary" onclick="openCreateModal()">+ New Goal</button>
    </div>

    <div class="card">
      <div id="loading" class="loading">Loading insight goals...</div>
      <div id="error" class="error-message" style="display: none;"></div>
      <table id="goals-table" style="display: none;">
        <thead>
          <tr>
            <th>Name</th>
            <th>Question</th>
            <th>Type</th>
            <th>Priority</th>
            <th>Progress</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="goals-body"></tbody>
      </table>
      <div id="empty" class="empty-state" style="display: none;">
        <p>No insight goals defined yet.</p>
        <p style="margin-top: 8px;">Create goals to guide what Addie asks members about.</p>
      </div>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <div id="modal" class="modal-overlay">
    <div class="modal">
      <h2 id="modal-title">New Insight Goal</h2>
      <div id="modal-error" class="error-message" style="display: none;"></div>
      <form id="goal-form" onsubmit="handleSubmit(event)">
        <input type="hidden" id="goal-id">

        <div class="form-group">
          <label for="name">Goal Name *</label>
          <input type="text" id="name" required placeholder="e.g., 2026 Priorities">
        </div>

        <div class="form-group">
          <label for="question">Question to Explore *</label>
          <textarea id="question" required placeholder="What would you like to see from AAO and AdCP in 2026?"></textarea>
          <small>The question Addie will try to get members to answer</small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="goal-type">Goal Type</label>
            <select id="goal-type" onchange="toggleCampaignDates()">
              <option value="persistent">Persistent (always active when enabled)</option>
              <option value="campaign">Campaign (time-bounded)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="priority">Priority (1-100)</label>
            <input type="number" id="priority" min="1" max="100" value="50">
            <small>Higher = more important</small>
          </div>
        </div>

        <div id="campaign-dates" class="campaign-dates">
          <div class="form-row">
            <div class="form-group">
              <label for="start-date">Start Date</label>
              <input type="date" id="start-date">
            </div>
            <div class="form-group">
              <label for="end-date">End Date</label>
              <input type="date" id="end-date">
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="insight-type">Map to Insight Type</label>
            <select id="insight-type">
              <option value="">— None (don't auto-categorize) —</option>
            </select>
            <small>If set, responses will be stored as this insight type</small>
          </div>
          <div class="form-group">
            <label for="target-count">Target Response Count</label>
            <input type="number" id="target-count" min="0" placeholder="Optional">
          </div>
        </div>

        <div class="form-group">
          <label>Targeting</label>
          <div style="display: flex; gap: 20px;">
            <label class="checkbox-label">
              <input type="checkbox" id="target-mapped-only">
              Mapped users only
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="target-unmapped-only">
              Unmapped users only
            </label>
          </div>
        </div>

        <div class="form-group">
          <label for="prompt-title">Suggested Prompt Title</label>
          <input type="text" id="prompt-title" placeholder="e.g., Share your 2026 priorities">
          <small>Shows as a clickable suggestion when users open Addie</small>
        </div>

        <div class="form-group">
          <label for="prompt-message">Suggested Prompt Message</label>
          <textarea id="prompt-message" placeholder="The message sent when user clicks the prompt"></textarea>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="is-enabled" checked>
            Enabled
          </label>
        </div>

        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submit-btn">Create</button>
        </div>
      </form>
    </div>
  </div>

  <div id="adcp-footer"></div>

  <script>
    let goals = [];
    let insightTypes = [];

    async function loadData() {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const table = document.getElementById('goals-table');
      const empty = document.getElementById('empty');

      loading.style.display = 'block';
      error.style.display = 'none';
      table.style.display = 'none';
      empty.style.display = 'none';

      try {
        const [goalsRes, typesRes] = await Promise.all([
          fetch('/api/admin/insight-goals'),
          fetch('/api/admin/insight-types?activeOnly=true'),
        ]);

        if (!goalsRes.ok || !typesRes.ok) {
          if (goalsRes.status === 401 || typesRes.status === 401) {
            AdminSidebar.redirectToLogin();
            return;
          }
          throw new Error('Failed to load data');
        }

        goals = await goalsRes.json();
        insightTypes = await typesRes.json();

        populateInsightTypeSelect();
        loading.style.display = 'none';

        if (goals.length === 0) {
          empty.style.display = 'block';
        } else {
          table.style.display = 'table';
          renderGoals();
        }
      } catch (err) {
        loading.style.display = 'none';
        error.textContent = err.message;
        error.style.display = 'block';
      }
    }

    function populateInsightTypeSelect() {
      const select = document.getElementById('insight-type');
      const options = insightTypes.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`);
      select.innerHTML = '<option value="">— None (don\'t auto-categorize) —</option>' + options.join('');
    }

    function renderGoals() {
      const tbody = document.getElementById('goals-body');
      tbody.innerHTML = goals.map(goal => {
        const status = getStatus(goal);
        const progressPct = goal.target_response_count
          ? Math.min(100, Math.round((goal.current_response_count / goal.target_response_count) * 100))
          : null;

        return `
          <tr>
            <td class="goal-name">${escapeHtml(goal.name)}</td>
            <td class="goal-question">${escapeHtml(goal.question.substring(0, 100))}${goal.question.length > 100 ? '...' : ''}</td>
            <td>
              <span class="badge ${goal.goal_type === 'campaign' ? 'badge-info' : 'badge-muted'}">
                ${goal.goal_type}
              </span>
              ${goal.goal_type === 'campaign' ? `<br><small>${formatDate(goal.start_date)} - ${formatDate(goal.end_date)}</small>` : ''}
            </td>
            <td>${goal.priority}</td>
            <td>
              ${goal.target_response_count ? `
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${progressPct}%"></div>
                </div>
                <div class="progress-text">${goal.current_response_count} / ${goal.target_response_count}</div>
              ` : `<span style="color: var(--color-text-muted);">${goal.current_response_count} responses</span>`}
            </td>
            <td>
              <span class="badge ${status === 'active' ? 'badge-success' : status === 'scheduled' ? 'badge-info' : 'badge-warning'}">
                ${status}
              </span>
            </td>
            <td class="actions">
              <button class="btn btn-secondary btn-small" onclick="openEditModal(${goal.id})">Edit</button>
              <button class="btn btn-danger btn-small" onclick="deleteGoal(${goal.id})">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function getStatus(goal) {
      const now = new Date();
      if (goal.goal_type === 'campaign') {
        const start = goal.start_date ? new Date(goal.start_date) : null;
        const end = goal.end_date ? new Date(goal.end_date) : null;
        if (end && end < now) return 'expired';
        if (start && start > now) return 'scheduled';
      }
      return goal.is_enabled ? 'active' : 'disabled';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '—';
      return new Date(dateStr).toLocaleDateString();
    }

    function toggleCampaignDates() {
      const type = document.getElementById('goal-type').value;
      const datesDiv = document.getElementById('campaign-dates');
      datesDiv.classList.toggle('show', type === 'campaign');
    }

    function openCreateModal() {
      document.getElementById('modal-title').textContent = 'New Insight Goal';
      document.getElementById('submit-btn').textContent = 'Create';
      document.getElementById('goal-form').reset();
      document.getElementById('goal-id').value = '';
      document.getElementById('is-enabled').checked = true;
      document.getElementById('priority').value = 50;
      document.getElementById('campaign-dates').classList.remove('show');
      document.getElementById('modal-error').style.display = 'none';
      document.getElementById('modal').style.display = 'flex';
    }

    function openEditModal(id) {
      const goal = goals.find(g => g.id === id);
      if (!goal) return;

      document.getElementById('modal-title').textContent = 'Edit Insight Goal';
      document.getElementById('submit-btn').textContent = 'Save';
      document.getElementById('goal-id').value = id;
      document.getElementById('name').value = goal.name;
      document.getElementById('question').value = goal.question;
      document.getElementById('goal-type').value = goal.goal_type;
      document.getElementById('priority').value = goal.priority;
      document.getElementById('start-date').value = goal.start_date ? goal.start_date.split('T')[0] : '';
      document.getElementById('end-date').value = goal.end_date ? goal.end_date.split('T')[0] : '';
      document.getElementById('insight-type').value = goal.insight_type_id || '';
      document.getElementById('target-count').value = goal.target_response_count || '';
      document.getElementById('target-mapped-only').checked = goal.target_mapped_only;
      document.getElementById('target-unmapped-only').checked = goal.target_unmapped_only;
      document.getElementById('prompt-title').value = goal.suggested_prompt_title || '';
      document.getElementById('prompt-message').value = goal.suggested_prompt_message || '';
      document.getElementById('is-enabled').checked = goal.is_enabled;

      toggleCampaignDates();
      document.getElementById('modal-error').style.display = 'none';
      document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    async function handleSubmit(event) {
      event.preventDefault();
      const modalError = document.getElementById('modal-error');
      modalError.style.display = 'none';

      const id = document.getElementById('goal-id').value;
      const goalType = document.getElementById('goal-type').value;

      const data = {
        name: document.getElementById('name').value.trim(),
        question: document.getElementById('question').value.trim(),
        goal_type: goalType,
        priority: parseInt(document.getElementById('priority').value) || 50,
        is_enabled: document.getElementById('is-enabled').checked,
        insight_type_id: document.getElementById('insight-type').value || null,
        target_response_count: parseInt(document.getElementById('target-count').value) || null,
        target_mapped_only: document.getElementById('target-mapped-only').checked,
        target_unmapped_only: document.getElementById('target-unmapped-only').checked,
        suggested_prompt_title: document.getElementById('prompt-title').value.trim() || null,
        suggested_prompt_message: document.getElementById('prompt-message').value.trim() || null,
      };

      if (goalType === 'campaign') {
        data.start_date = document.getElementById('start-date').value || null;
        data.end_date = document.getElementById('end-date').value || null;
      }

      try {
        const url = id ? `/api/admin/insight-goals/${id}` : '/api/admin/insight-goals';
        const method = id ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Failed to save goal');
        }

        closeModal();
        loadData();
      } catch (err) {
        modalError.textContent = err.message;
        modalError.style.display = 'block';
      }
    }

    async function deleteGoal(id) {
      const goal = goals.find(g => g.id === id);
      if (!goal) return;

      if (!confirm(`Are you sure you want to delete the goal "${goal.name}"?`)) return;

      try {
        const response = await fetch(`/api/admin/insight-goals/${id}`, { method: 'DELETE' });
        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Failed to delete goal');
        }
        loadData();
      } catch (err) {
        alert(err.message);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    loadData();
  </script>
</body>
</html>
