<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Admin - API Keys - AgenticAdvertising.org</title>
  <link rel="stylesheet" href="/design-system.css">
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <style>
    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-xl);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }
    h1 { margin-bottom: var(--space-2.5); color: var(--color-text-heading); }
    .subtitle {
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
      margin-bottom: var(--space-6);
    }
    .org-selector {
      margin-bottom: var(--space-6);
    }
    .org-selector label {
      display: block;
      margin-bottom: var(--space-2);
      font-weight: 500;
      color: var(--color-text-heading);
    }
    .org-selector select {
      width: 100%;
      max-width: 400px;
      padding: var(--space-2.5) var(--space-3);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      background: var(--color-bg-card);
    }
    .widget-container {
      min-height: 400px;
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-4);
    }
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--color-text-secondary);
    }
    .error-message {
      background: var(--color-error-50);
      border: var(--border-1) solid var(--color-error-200);
      color: var(--color-error-700);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-4);
    }
    .info-box {
      background: var(--color-primary-50);
      border: var(--border-1) solid var(--color-primary-200);
      color: var(--color-primary-700);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-4);
      font-size: var(--text-sm);
    }
    .info-box code {
      background: var(--color-primary-100);
      padding: var(--space-0.5) var(--space-1);
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
    }
    .permissions-list {
      margin-top: var(--space-4);
    }
    .permissions-list h3 {
      font-size: var(--text-sm);
      font-weight: 600;
      margin-bottom: var(--space-2);
      color: var(--color-text-heading);
    }
    .permissions-list ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .permissions-list li {
      padding: var(--space-1) 0;
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }
    .permissions-list li code {
      background: var(--color-gray-100);
      padding: var(--space-0.5) var(--space-1.5);
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      font-size: var(--text-xs);
    }
  </style>
</head>
<body>
  <div id="nav-container"></div>

  <div class="page-with-sidebar">
    <div id="admin-sidebar"></div>

    <main class="main-content">
      <div class="container">
        <div class="card">
          <h1>API Keys</h1>
          <p class="subtitle">Manage API keys for programmatic access to the admin API</p>

          <div class="info-box">
            <strong>How API Keys Work:</strong>
            <p style="margin: var(--space-2) 0 0 0;">
              API keys are organization-scoped and can be used to access the admin API without a browser session.
              Use them in the <code>Authorization: Bearer &lt;key&gt;</code> header.
            </p>
            <div class="permissions-list">
              <h3>Available Permissions</h3>
              <ul>
                <li><code>admin:*</code> - Full admin access (read and write)</li>
                <li><code>admin:read</code> - Read-only admin access</li>
              </ul>
            </div>
          </div>

          <div id="dev-mode-warning" class="error-message" style="display: none; background: var(--color-warning-50); border-color: var(--color-warning-200); color: var(--color-warning-700);">
            <strong>Dev Mode:</strong> API key management requires WorkOS authentication.
            In production, go to the <a href="https://dashboard.workos.com" target="_blank" style="color: var(--color-warning-700); font-weight: 600;">WorkOS Dashboard</a> â†’ Organizations â†’ API Keys to create keys.
          </div>

          <div class="org-selector">
            <label for="org-select">Select Organization</label>
            <select id="org-select">
              <option value="">Loading organizations...</option>
            </select>
          </div>

          <div id="widget-error" class="error-message" style="display: none;"></div>

          <div id="widget-container" class="widget-container">
            <div class="loading">Select an organization to manage API keys</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script type="module">

    let widgetToken = null;
    let currentOrgId = null;

    // Fetch organizations
    async function loadOrganizations() {
      try {
        const response = await fetch('/api/admin/organizations');
        if (!response.ok) throw new Error('Failed to load organizations');
        const organizations = await response.json();

        const select = document.getElementById('org-select');
        select.innerHTML = '<option value="">Select an organization...</option>';

        // API returns array directly
        const orgList = Array.isArray(organizations) ? organizations : (organizations.organizations || []);
        orgList.forEach(org => {
          const option = document.createElement('option');
          option.value = org.workos_organization_id;
          option.textContent = org.name;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading organizations:', error);
        document.getElementById('org-select').innerHTML =
          '<option value="">Error loading organizations</option>';
      }
    }

    // Get widget token for selected organization
    async function getWidgetToken(organizationId) {
      try {
        const response = await fetch('/api/admin/widgets/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            organizationId,
            scope: 'widgets:api-keys:manage'
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to get widget token');
        }

        const data = await response.json();
        return data.token;
      } catch (error) {
        console.error('Error getting widget token:', error);
        throw error;
      }
    }

    // Render the API Keys widget
    async function renderWidget(organizationId) {
      const container = document.getElementById('widget-container');
      const errorDiv = document.getElementById('widget-error');
      const devWarning = document.getElementById('dev-mode-warning');

      errorDiv.style.display = 'none';
      devWarning.style.display = 'none';
      container.innerHTML = '<div class="loading">Loading API Keys...</div>';

      try {
        widgetToken = await getWidgetToken(organizationId);
        currentOrgId = organizationId;

        // Show success with link to WorkOS dashboard
        container.innerHTML = `
          <div style="text-align: center; padding: var(--space-8);">
            <div style="font-size: 48px; margin-bottom: var(--space-4);">âœ…</div>
            <p style="color: var(--color-text-heading); font-weight: 500; margin-bottom: var(--space-4);">
              Widget token generated successfully!
            </p>
            <p style="color: var(--color-text-secondary); margin-bottom: var(--space-4);">
              To manage API keys for this organization:
            </p>
            <a href="https://dashboard.workos.com/organizations/${organizationId}/api-keys"
               target="_blank"
               style="display: inline-block; background: var(--color-brand); color: white; padding: var(--space-3) var(--space-5); border-radius: var(--radius-md); text-decoration: none; font-weight: 500;">
              Open WorkOS Dashboard â†’
            </a>
            <p style="color: var(--color-text-muted); margin-top: var(--space-6); font-size: var(--text-sm);">
              Organization ID: <code style="background: var(--color-gray-100); padding: 2px 6px; border-radius: 4px;">${organizationId}</code>
            </p>
          </div>
        `;
      } catch (error) {
        // Check if it's a dev mode / user membership error
        if (error.message.includes('UserOrganizationMembership') || error.message.includes('not found')) {
          devWarning.style.display = 'block';
          container.innerHTML = `
            <div style="text-align: center; padding: var(--space-8);">
              <div style="font-size: 48px; margin-bottom: var(--space-4);">ðŸ”‘</div>
              <p style="color: var(--color-text-heading); font-weight: 500; margin-bottom: var(--space-4);">
                Create API Keys in WorkOS Dashboard
              </p>
              <p style="color: var(--color-text-secondary); margin-bottom: var(--space-4); max-width: 500px; margin-left: auto; margin-right: auto;">
                API keys are managed through WorkOS. Click below to go to the organization's API keys page.
              </p>
              <a href="https://dashboard.workos.com/organizations/${organizationId}/api-keys"
                 target="_blank"
                 style="display: inline-block; background: var(--color-brand); color: white; padding: var(--space-3) var(--space-5); border-radius: var(--radius-md); text-decoration: none; font-weight: 500;">
                Open WorkOS Dashboard â†’
              </a>
              <div style="margin-top: var(--space-6); padding: var(--space-4); background: var(--color-gray-50); border-radius: var(--radius-md); text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
                <p style="font-size: var(--text-sm); color: var(--color-text-secondary); margin: 0 0 var(--space-2) 0;"><strong>When creating an API key, add these permissions:</strong></p>
                <ul style="margin: 0; padding-left: var(--space-5); font-size: var(--text-sm); color: var(--color-text-secondary);">
                  <li><code>admin:*</code> - Full admin API access</li>
                  <li><code>admin:read</code> - Read-only admin API access</li>
                </ul>
              </div>
            </div>
          `;
        } else {
          errorDiv.textContent = error.message;
          errorDiv.style.display = 'block';
          container.innerHTML = '<div class="loading">Failed to load widget</div>';
        }
      }
    }

    // Event listeners
    document.getElementById('org-select').addEventListener('change', (e) => {
      if (e.target.value) {
        renderWidget(e.target.value);
      } else {
        document.getElementById('widget-container').innerHTML =
          '<div class="loading">Select an organization to manage API keys</div>';
      }
    });

    // Initialize
    loadOrganizations();
  </script>
</body>
</html>
