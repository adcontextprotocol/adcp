<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>You're invited - AgenticAdvertising.org</title>
  <meta name="description" content="You've been personally invited to join AgenticAdvertising.org.">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <link rel="stylesheet" href="/design-system.css">
  <style>
    * { box-sizing: border-box; }

    body {
      background: var(--color-bg-page);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .join-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-8) var(--space-5);
    }

    .join-card {
      background: var(--color-bg-card);
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-lg);
      padding: var(--space-10) var(--space-12);
      max-width: 520px;
      width: 100%;
      text-align: center;
    }

    /* Referrer identity block */
    .referrer-block {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      background: var(--color-bg-subtle);
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--radius-xl);
      padding: var(--space-4) var(--space-5);
      margin-bottom: var(--space-8);
      text-align: left;
    }

    .referrer-logo {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-lg);
      object-fit: contain;
      flex-shrink: 0;
      background: var(--color-bg-card);
      border: var(--border-1) solid var(--color-border);
    }

    .referrer-logo-placeholder {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-lg);
      background: var(--color-primary-100);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: var(--text-xl);
      font-weight: var(--font-bold);
      color: var(--color-brand);
    }

    .referrer-info { flex: 1; min-width: 0; }

    .referrer-label {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: var(--font-semibold);
      margin-bottom: var(--space-1);
    }

    .referrer-name {
      font-size: var(--text-base);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .referrer-tagline {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-1);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* AAO logo */
    .aao-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-3);
      margin-bottom: var(--space-6);
    }

    .aao-logo img { height: 36px; }

    .aao-logo-text {
      font-size: var(--text-lg);
      font-weight: var(--font-bold);
      color: var(--color-brand);
    }

    /* Headline */
    .join-headline {
      font-size: var(--text-3xl);
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
      line-height: var(--leading-tight);
      margin-bottom: var(--space-4);
    }

    .join-subtext {
      font-size: var(--text-base);
      color: var(--color-text-secondary);
      line-height: var(--leading-relaxed);
      margin-bottom: var(--space-8);
    }

    /* Discount badge */
    .discount-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      background: var(--color-success-50);
      border: var(--border-1) solid var(--color-success-500);
      color: var(--color-success-700);
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-full);
      margin-bottom: var(--space-8);
    }

    .discount-badge svg { width: 16px; height: 16px; }

    /* Buttons */
    .btn-accept {
      display: block;
      width: 100%;
      padding: var(--space-4) var(--space-6);
      background: var(--color-brand);
      color: white;
      font-size: var(--text-base);
      font-weight: var(--font-semibold);
      border: none;
      border-radius: var(--radius-lg);
      cursor: pointer;
      text-decoration: none;
      transition: background 0.15s;
      text-align: center;
    }

    .btn-accept:hover { background: var(--color-brand-hover); }
    .btn-accept:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-signin {
      display: block;
      width: 100%;
      padding: var(--space-4) var(--space-6);
      background: var(--color-brand);
      color: white;
      font-size: var(--text-base);
      font-weight: var(--font-semibold);
      border-radius: var(--radius-lg);
      text-decoration: none;
      transition: background 0.15s;
      text-align: center;
    }

    .btn-signin:hover { background: var(--color-brand-hover); }

    .join-fine-print {
      margin-top: var(--space-4);
      font-size: var(--text-xs);
      color: var(--color-text-muted);
    }

    /* Auth notice */
    .auth-notice {
      background: var(--color-primary-50);
      border: var(--border-1) solid var(--color-primary-200);
      border-radius: var(--radius-lg);
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-5);
    }

    /* Already-accepted state */
    .already-accepted {
      background: var(--color-success-50);
      border: var(--border-1) solid var(--color-success-500);
      border-radius: var(--radius-lg);
      padding: var(--space-4) var(--space-5);
      margin-bottom: var(--space-6);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      text-align: left;
    }

    .already-accepted-icon { font-size: 1.5rem; flex-shrink: 0; }

    .already-accepted-text {
      font-size: var(--text-sm);
      color: var(--color-success-700);
      font-weight: var(--font-medium);
    }

    /* Error state */
    .join-error {
      text-align: center;
      padding: var(--space-8) 0;
    }

    .join-error-icon {
      font-size: 3rem;
      margin-bottom: var(--space-4);
    }

    .join-error h2 {
      font-size: var(--text-xl);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      margin-bottom: var(--space-3);
    }

    .join-error p {
      color: var(--color-text-secondary);
      margin-bottom: var(--space-6);
    }

    .btn-secondary {
      display: inline-block;
      padding: var(--space-3) var(--space-6);
      background: transparent;
      color: var(--color-brand);
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      border: var(--border-2) solid var(--color-brand);
      border-radius: var(--radius-lg);
      text-decoration: none;
      transition: background 0.15s;
    }

    .btn-secondary:hover { background: var(--color-brand-bg); }

    /* Loading skeleton */
    .skeleton {
      background: linear-gradient(90deg, var(--color-gray-100) 25%, var(--color-gray-50) 50%, var(--color-gray-100) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-md);
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .loading-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-8) 0;
    }

    .skeleton-line { height: 20px; }
    .skeleton-line.wide { width: 80%; }
    .skeleton-line.medium { width: 60%; }
    .skeleton-line.narrow { width: 40%; }

    @media (max-width: 480px) {
      .join-card { padding: var(--space-8) var(--space-6); }
      .join-headline { font-size: var(--text-2xl); }
    }
  </style>
</head>
<body>

  <div class="join-wrapper">
    <div class="join-card">

      <!-- Loading state -->
      <div id="loadingState" class="loading-placeholder">
        <div class="skeleton skeleton-line wide"></div>
        <div class="skeleton skeleton-line medium"></div>
        <div class="skeleton skeleton-line narrow"></div>
        <div class="skeleton skeleton-line wide" style="height:44px; margin-top: var(--space-4);"></div>
      </div>

      <!-- Error state -->
      <div id="errorState" class="join-error" style="display:none;">
        <div class="join-error-icon">&#x26A0;</div>
        <h2 id="errorTitle">This link is no longer valid</h2>
        <p id="errorMessage">This invitation link may have expired or been revoked.</p>
        <a href="/membership" class="btn-secondary">View membership options</a>
      </div>

      <!-- Success state -->
      <div id="successState" style="display:none;">

        <!-- AAO branding -->
        <div class="aao-logo">
          <img src="/AAo.svg" alt="AgenticAdvertising.org">
          <span class="aao-logo-text">AgenticAdvertising.org</span>
        </div>

        <!-- Referrer identity -->
        <div class="referrer-block">
          <div id="referrerLogoContainer">
            <div id="referrerLogoPlaceholder" class="referrer-logo-placeholder"></div>
          </div>
          <div class="referrer-info">
            <div class="referrer-label">Personal invitation from</div>
            <div id="referrerName" class="referrer-name"></div>
            <div id="referrerTagline" class="referrer-tagline" style="display:none;"></div>
          </div>
        </div>

        <!-- Headline -->
        <h1 id="joinHeadline" class="join-headline"></h1>
        <p id="joinSubtext" class="join-subtext"></p>

        <!-- Discount badge -->
        <div id="discountBadge" class="discount-badge" style="display:none;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
            <line x1="7" y1="7" x2="7.01" y2="7"/>
          </svg>
          <span id="discountText"></span>
        </div>

        <!-- Already-accepted notice (shown when user already has an active referral) -->
        <div id="alreadyAccepted" class="already-accepted" style="display:none;">
          <div class="already-accepted-icon">&#x2713;</div>
          <div class="already-accepted-text" id="alreadyAcceptedText">
            You've already accepted a referral invitation. Visit your dashboard to subscribe.
          </div>
        </div>

        <!-- Auth notice (shown when not logged in) -->
        <div id="authNotice" class="auth-notice" style="display:none;">
          Sign in or create a free account to accept this invitation and lock in your discount.
        </div>

        <!-- CTA — swapped between sign-in and accept based on auth state -->
        <a id="ctaSignIn" href="#" class="btn-signin" style="display:none;">
          Sign in to accept invitation
        </a>
        <button id="ctaAccept" class="btn-accept" style="display:none;" onclick="handleAccept()">
          Accept invitation
        </button>
        <a id="ctaDashboard" href="/dashboard/membership" class="btn-signin" style="display:none;">
          Go to your dashboard
        </a>

        <p id="finePrint" class="join-fine-print" style="display:none;">
          Your discount is locked in for 30 days once accepted. No code needed at checkout.
        </p>

      </div>
    </div>
  </div>

  <script>
    (function () {
      // Extract code from URL path: /join/:code
      var pathParts = window.location.pathname.split('/');
      var code = pathParts[pathParts.length - 1];

      if (!code) {
        showError('Invalid link', 'This invitation link is missing a referral code.');
        return;
      }

      // Keep code in localStorage as a fallback even if acceptance fails
      localStorage.setItem('aao_referral_code', code.toUpperCase());

      // Fetch referral info + auth state in parallel
      Promise.all([
        fetch('/api/referral/' + encodeURIComponent(code)).then(function (res) {
          if (res.status === 404) throw Object.assign(new Error('Referral code not found'), { status: 404 });
          if (res.status === 410) return res.json().then(function (b) { throw Object.assign(new Error(b.error || 'Expired'), { status: 410 }); });
          if (!res.ok) throw Object.assign(new Error('Error'), { status: res.status });
          return res.json();
        }),
        checkAuthAndReferral(),
      ])
        .then(function (results) {
          renderSuccess(results[0], results[1]);
        })
        .catch(function (err) {
          if (err.status === 404) {
            showError('Invitation not found', 'This referral code doesn\'t exist. Check the link and try again.');
          } else if (err.status === 410) {
            showError('Invitation no longer active', err.message || 'This invitation has expired or been fully used.');
          } else {
            showError('Something went wrong', 'We couldn\'t load this invitation. Please try again.');
          }
        });

      // Check whether the user is logged in and if they have an existing referral
      function checkAuthAndReferral() {
        var config = window.__APP_CONFIG__;
        if (!config || !config.user) {
          return Promise.resolve({ user: null, existingReferral: null });
        }
        return fetch('/api/me/referral', { credentials: 'include' })
          .then(function (res) { return res.ok ? res.json() : { referral: null }; })
          .then(function (data) { return { user: config.user, existingReferral: data.referral, daysRemaining: data.days_remaining }; })
          .catch(function () { return { user: config.user, existingReferral: null }; });
      }

      function renderSuccess(data, authState) {
        // Referrer logo
        if (data.referrer_logo_url) {
          var img = document.createElement('img');
          img.className = 'referrer-logo';
          img.src = data.referrer_logo_url;
          img.alt = data.referrer_org_name || data.referred_by || '';
          img.onerror = function () { showInitialPlaceholder(data); };
          document.getElementById('referrerLogoContainer').innerHTML = '';
          document.getElementById('referrerLogoContainer').appendChild(img);
        } else {
          showInitialPlaceholder(data);
        }

        // Referrer name and tagline
        var displayName = data.referrer_org_name || data.referred_by;
        document.getElementById('referrerName').textContent = displayName;
        if (data.referrer_tagline) {
          var tagEl = document.getElementById('referrerTagline');
          tagEl.textContent = data.referrer_tagline;
          tagEl.style.display = '';
        }

        // Brand color accent
        if (data.referrer_brand_color) {
          var placeholder = document.getElementById('referrerLogoPlaceholder');
          if (placeholder) {
            placeholder.style.background = data.referrer_brand_color + '1a';
            placeholder.style.color = data.referrer_brand_color;
          }
        }

        // Headline
        var headline = document.getElementById('joinHeadline');
        headline.textContent = data.target_company_name
          ? data.target_company_name + ', you\'re invited.'
          : 'You\'re personally invited.';

        // Subtext
        var subtext = document.getElementById('joinSubtext');
        var inviterName = data.referred_by;
        var orgPart = data.referrer_org_name ? ' at ' + data.referrer_org_name : '';
        if (data.target_company_name) {
          subtext.textContent = inviterName + orgPart + ' has invited ' + data.target_company_name + ' to join AgenticAdvertising.org — the community for teams building the future of AI-powered advertising.';
        } else {
          subtext.textContent = inviterName + orgPart + ' has personally invited you to join AgenticAdvertising.org — the community for teams building the future of AI-powered advertising.';
        }

        // Discount badge
        if (data.discount_percent) {
          document.getElementById('discountBadge').style.display = '';
          document.getElementById('discountText').textContent = data.discount_percent + '% off your first year included';
        }

        // CTA based on auth state
        var user = authState && authState.user;
        if (!user) {
          // Not logged in — prompt to sign in
          document.getElementById('authNotice').style.display = '';
          var signInBtn = document.getElementById('ctaSignIn');
          signInBtn.href = '/auth/login?return_to=' + encodeURIComponent(window.location.pathname);
          signInBtn.style.display = '';
        } else if (authState.existingReferral) {
          // Already accepted a referral
          document.getElementById('alreadyAccepted').style.display = '';
          if (authState.daysRemaining > 0) {
            document.getElementById('alreadyAcceptedText').textContent =
              'You\'ve already accepted a referral invitation. You have ' + authState.daysRemaining + ' day' + (authState.daysRemaining === 1 ? '' : 's') + ' to subscribe with your discount.';
          }
          document.getElementById('ctaDashboard').style.display = '';
        } else {
          // Logged in and no existing referral — show accept button
          document.getElementById('ctaAccept').style.display = '';
          document.getElementById('finePrint').style.display = '';
        }

        // Show the success state
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('successState').style.display = '';
      }

      function handleAccept() {
        var btn = document.getElementById('ctaAccept');
        btn.disabled = true;
        btn.textContent = 'Accepting...';

        fetch('/api/referral/' + encodeURIComponent(code) + '/accept', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
        })
          .then(function (res) { return res.json().then(function (body) { return { ok: res.ok, status: res.status, body: body }; }); })
          .then(function (r) {
            if (r.ok) {
              // Success — redirect to dashboard
              localStorage.removeItem('aao_referral_code');
              window.location.href = '/dashboard/membership';
            } else if (r.status === 409) {
              // Already accepted (concurrent tab, etc.)
              window.location.href = '/dashboard/membership';
            } else {
              btn.disabled = false;
              btn.textContent = 'Accept invitation';
              var msg = (r.body && r.body.error) ? r.body.error : 'Something went wrong. Please try again.';
              alert(msg);
            }
          })
          .catch(function () {
            btn.disabled = false;
            btn.textContent = 'Accept invitation';
            alert('Something went wrong. Please try again.');
          });
      }

      function showInitialPlaceholder(data) {
        var name = data.referrer_org_name || data.referred_by || '?';
        var placeholder = document.getElementById('referrerLogoPlaceholder');
        if (placeholder) placeholder.textContent = name.charAt(0).toUpperCase();
      }

      function showError(title, message) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorTitle').textContent = title;
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorState').style.display = '';
        localStorage.removeItem('aao_referral_code');
      }
    })();
  </script>

</body>
</html>
