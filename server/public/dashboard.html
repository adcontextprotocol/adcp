<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - AdCP Registry</title>
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <link rel="stylesheet" href="/design-system.css">
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <style>
    /* =============================================================================
       Dashboard-specific styles
       Uses design system variables - see /design-system.css for tokens
       ============================================================================= */

    body {
      background: var(--color-bg-page);
    }

    .dashboard-toolbar {
      background: var(--color-bg-subtle);
      border-bottom: var(--border-1) solid var(--color-border);
      padding: var(--space-2.5) var(--space-5);
    }

    .dashboard-toolbar-content {
      max-width: var(--container-xl);
      margin: 0 auto;
      display: flex;
      justify-content: flex-start;
      align-items: center;
    }

    .container {
      max-width: var(--container-xl);
      margin: var(--space-10) auto;
      padding: 0 var(--space-5);
    }

    .welcome {
      background: var(--color-bg-card);
      border-radius: var(--card-radius);
      padding: var(--space-10);
      margin-bottom: var(--space-8);
      box-shadow: var(--shadow-sm);
    }

    h1 {
      color: var(--color-text-heading);
      margin-bottom: var(--space-2.5);
      font-size: var(--text-4xl);
    }

    p {
      color: var(--color-text-secondary);
      line-height: var(--leading-relaxed);
      margin-bottom: var(--space-5);
    }

    .card {
      background: var(--color-bg-card);
      border-radius: var(--card-radius);
      padding: var(--space-8);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-sm);
    }

    .card h2 {
      color: var(--color-text-heading);
      margin-bottom: var(--space-4);
      font-size: var(--text-xl);
    }

    .info-box {
      background: var(--color-info-50);
      border-left: var(--border-4) solid var(--color-info-500);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-5);
    }

    .loading {
      text-align: center;
      padding: var(--space-10);
      color: var(--color-text-secondary);
    }

    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--modal-backdrop);
      z-index: var(--z-modal);
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: var(--color-bg-card);
      border-radius: var(--modal-radius);
      padding: var(--modal-padding);
      max-width: var(--modal-max-width);
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--modal-shadow);
    }

    .modal h2 {
      color: var(--color-warning-500);
      margin-bottom: var(--space-4);
    }

    .modal-buttons {
      display: flex;
      gap: var(--space-4);
      margin-top: var(--space-5);
      justify-content: flex-end;
    }

    /* Buttons now use design-system.css classes:
       - .btn .btn-primary = blue background
       - .btn .btn-secondary = gray background
       - .btn .btn-danger = red background
       - .btn .btn-sm = smaller size
    */

    /* Admin Link - uses brand color */
    .admin-link {
      margin-left: auto;
      padding: var(--space-2) var(--space-4);
      background: var(--color-brand);
      color: white;
      text-decoration: none;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      transition: var(--transition-colors);
    }

    .admin-link:hover {
      background: var(--color-brand-hover);
    }

    /* Org Switcher */
    .org-switcher {
      position: relative;
    }

    .org-switcher-btn {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--color-bg-page);
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: var(--text-sm);
      color: var(--color-text-heading);
      min-width: 180px;
      transition: var(--transition-colors);
    }

    .org-switcher-btn:hover {
      background: var(--color-gray-200);
    }

    .org-switcher-btn .org-name {
      flex: 1;
      text-align: left;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .org-switcher-btn .arrow {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
    }

    .org-switcher-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: var(--space-1);
      background: var(--color-bg-card);
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: var(--z-dropdown);
      max-height: 300px;
      overflow-y: auto;
    }

    .org-switcher-dropdown.show {
      display: block;
    }

    .org-switcher-item {
      padding: var(--space-2.5) var(--space-3);
      cursor: pointer;
      border-bottom: var(--border-1) solid var(--color-gray-100);
      transition: var(--transition-colors);
    }

    .org-switcher-item:last-child {
      border-bottom: none;
    }

    .org-switcher-item:hover {
      background: var(--color-bg-subtle);
    }

    .org-switcher-item.selected {
      background: var(--color-info-50);
    }

    .org-switcher-item .item-name {
      font-weight: var(--font-medium);
      color: var(--color-text-heading);
    }

    .org-switcher-item .item-badge {
      display: inline-block;
      padding: var(--space-0.5) var(--space-1.5);
      font-size: var(--text-xs);
      border-radius: var(--radius-full);
      margin-left: var(--space-1.5);
    }

    .org-switcher-item .item-badge.active {
      background: var(--color-primary-100);
      color: var(--color-success-700);
    }

    .org-switcher-item .item-badge.inactive {
      background: var(--color-gray-100);
      color: var(--color-text-secondary);
    }

    /* Responsive layout for dashboard */
    @media (max-width: 900px) {
      .dashboard-grid {
        grid-template-columns: 1fr !important;
      }
    }

    /* Delete workspace styles */
    .btn-danger {
      background: #dc2626;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-danger:hover {
      background: #b91c1c;
    }
    .delete-warning {
      background: #fef2f2;
      border-left: 4px solid #ef4444;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    .delete-warning p {
      margin: 0 0 10px 0;
      color: #991b1b;
    }
    .delete-warning ul {
      margin: 0;
      padding-left: 20px;
      color: #991b1b;
    }
    .delete-error {
      background: #fee;
      border-left: 4px solid #c33;
      padding: 10px;
      border-radius: 4px;
      margin-top: 15px;
      color: #c33;
    }
    .confirm-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      margin-top: 10px;
    }
    .workspace-name-highlight {
      background: #fee;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!-- Outdated Agreement Modal -->
  <div id="outdatedAgreementModal" class="modal-overlay">
    <div class="modal">
      <h2 id="outdatedAgreementModalTitle">‚ö†Ô∏è Agreement Update</h2>
      <div id="modalContent">
        <p id="outdatedAgreementModalMessage">One or more agreements have been updated.</p>
        <div id="outdatedAgreementsList" style="margin: 20px 0;"></div>
      </div>
      <div id="outdatedAgreementButtons" class="modal-buttons">
        <button class="btn btn-secondary" onclick="dismissAgreementModal()">Remind Me Later</button>
        <button class="btn btn-primary" onclick="viewOutdatedAgreements()">Review</button>
      </div>
    </div>
  </div>

  <!-- Agreement Viewer Modal -->
  <div id="agreementViewerModal" class="modal-overlay">
    <div class="modal" style="max-width: 700px; max-height: 85vh; display: flex; flex-direction: column; margin: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-shrink: 0;">
        <div>
          <h2 id="agreementViewerTitle" style="font-size: 18px;">Agreement</h2>
          <p id="agreementViewerMeta" style="color: var(--color-text-secondary); font-size: 13px; margin: 5px 0 0 0;"></p>
        </div>
        <button onclick="closeAgreementViewer()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-secondary); padding: 0; line-height: 1;">√ó</button>
      </div>
      <div id="agreementViewerContent" style="overflow-y: auto; flex: 1; min-height: 0; padding: 15px; background: var(--color-bg-subtle); border-radius: 6px; font-size: 13px; line-height: 1.6;">
        Loading...
      </div>
      <div id="agreementViewerButtons" class="modal-buttons" style="margin-top: 15px; flex-shrink: 0;">
        <button class="btn btn-primary" onclick="closeAgreementViewer()">Close</button>
      </div>
    </div>
  </div>

  <!-- Rename Organization Modal -->
  <div id="renameOrgModal" class="modal-overlay">
    <div class="modal" style="max-width: 400px;">
      <h2>Rename Organization</h2>
      <div style="margin: 20px 0;">
        <label for="newOrgName" style="display: block; margin-bottom: 8px; font-weight: 500;">Organization Name</label>
        <input type="text" id="newOrgName" style="width: 100%; padding: 10px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 14px;" placeholder="Enter new name">
        <p id="renameError" style="color: var(--color-error-600); font-size: 13px; margin: 8px 0 0 0; display: none;"></p>
      </div>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeRenameModal()">Cancel</button>
        <button class="btn btn-primary" id="confirmRenameBtn" onclick="confirmRenameOrg()">Rename</button>
      </div>
    </div>
  </div>

  <!-- Delete Workspace Modal -->
  <div id="deleteWorkspaceModal" class="modal-overlay">
    <div class="modal" style="max-width: 450px;">
      <h2 style="color: #dc2626;">‚ö†Ô∏è Delete Workspace</h2>
      <div class="delete-warning">
        <p><strong>This action cannot be undone.</strong></p>
        <p>Deleting this workspace will permanently remove:</p>
        <ul>
          <li>All team members and their access</li>
          <li>Your member profile</li>
          <li>All workspace settings</li>
        </ul>
      </div>
      <div id="deleteWorkspaceError" class="delete-error" style="display: none;"></div>
      <div style="margin: 20px 0;">
        <p>To confirm, type the workspace name: <span id="deleteWorkspaceName" class="workspace-name-highlight"></span></p>
        <input type="text" id="deleteConfirmInput" class="confirm-input" placeholder="Type workspace name to confirm" oninput="checkDeleteWorkspaceConfirmation()">
      </div>
      <div class="modal-buttons">
        <button class="btn-secondary" onclick="closeDeleteWorkspaceModal()">Cancel</button>
        <button class="btn-danger" id="confirmDeleteWorkspaceBtn" onclick="confirmDeleteWorkspace()" disabled style="opacity: 0.5;">Delete Workspace</button>
      </div>
    </div>
  </div>

  <!-- Shared Navigation -->
  <div id="adcp-nav"></div>
  <script src="/nav.js"></script>
  <script src="/member-card.js"></script>

  <!-- Dashboard Toolbar (org switcher only - login/logout moved to nav.js) -->
  <div class="dashboard-toolbar">
    <div class="dashboard-toolbar-content">
      <div class="org-switcher" id="orgSwitcher" style="display: none;">
        <button class="org-switcher-btn" onclick="toggleOrgDropdown()">
          <span class="org-name" id="selectedOrgName">Select Organization</span>
          <span class="arrow">‚ñº</span>
        </button>
        <div class="org-switcher-dropdown" id="orgDropdown"></div>
      </div>
      <a href="/admin" id="adminLink" class="admin-link" style="display: none;">Admin</a>
    </div>
  </div>

  <div class="container">
    <!-- Welcome Header with Org Info -->
    <div class="welcome" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px;">
      <div>
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
          <h1 id="orgName" style="margin: 0;">Dashboard</h1>
          <button id="editOrgNameBtn" onclick="openRenameModal()" style="display: none; background: none; border: none; cursor: pointer; padding: 4px; color: var(--color-text-secondary); opacity: 0.7; transition: opacity 0.2s;" title="Rename organization">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
          </button>
          <span id="orgBadge"></span>
        </div>
        <p id="orgRole" style="margin: 0; font-size: 14px; color: var(--color-text-secondary);"></p>
      </div>
    </div>

    <div id="loading" class="loading">
      Loading your information...
    </div>

    <div id="content" style="display:none;">
      <!-- Membership section - shown prominently at top for non-subscribers -->
      <div id="membershipSection" class="card" style="display:none; margin-bottom: 24px;">
        <div style="background: linear-gradient(135deg, var(--aao-primary) 0%, var(--aao-primary-light) 100%); padding: 20px; border-radius: 8px; color: white; margin-bottom: 20px;">
          <h3 style="margin: 0 0 8px 0; color: white;">Become a Member</h3>
          <p style="margin: 0; color: rgba(255,255,255,0.9); font-size: 14px;">Unlock your public member profile, appear in the directory, and support the AdCP ecosystem.</p>
        </div>

        <div style="border: 1px solid var(--color-border); border-radius: 8px; padding: 20px; background: var(--color-bg-subtle); margin-bottom: 20px;">
          <h4 style="margin: 0 0 10px 0; font-size: 16px;">Membership Agreement</h4>
          <div id="membershipAgreementContent" style="max-height: 200px; overflow-y: auto; padding: 15px; background: white; border: 1px solid var(--color-border); border-radius: 4px; margin-bottom: 15px; font-size: 14px; line-height: 1.6;">
            Loading agreement...
          </div>

          <label style="display: flex; align-items: start; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="membershipAgreementCheckbox" style="margin-top: 4px; cursor: pointer;" />
            <span style="font-size: 14px;">I have read and agree to the <strong>AgenticAdvertising.org Membership Agreement</strong></span>
          </label>
        </div>

        <div id="pricingTableWrapper" style="opacity: 0.5; pointer-events: none; transition: opacity 0.3s;">
          <script async src="https://js.stripe.com/v3/pricing-table.js"></script>
          <!-- Pricing table will be dynamically inserted here with customer session -->
          <div id="pricingTableContainer"></div>
        </div>

        <div id="agreementWarning" style="display: block; text-align: center; color: var(--color-text-secondary); font-size: 14px; margin-top: 10px; padding: 10px; background: var(--color-warning-50); border: 1px solid var(--color-warning-300); border-radius: 4px;">
          Please accept the membership agreement above to continue
        </div>
      </div>

      <!-- Main Layout: Member Profile (large) + Sidebar (Membership, Team, Agreements) -->
      <div class="dashboard-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; align-items: start;">

        <!-- LEFT COLUMN: Member Profile (prominent) -->
        <div class="card" id="memberProfileCard" style="padding: 0; overflow: hidden;">
          <div style="background: linear-gradient(135deg, var(--aao-primary) 0%, var(--aao-primary-light) 100%); padding: 20px 24px; color: white;">
            <h2 style="margin: 0; color: white; display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 24px;">üè¢</span> Member Profile
            </h2>
            <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Your public presence in the AdCP member directory</p>
          </div>
          <div id="memberProfileDetails" style="padding: 24px;"></div>
        </div>

        <!-- RIGHT COLUMN: Membership, Team, Agreements -->
        <div style="display: flex; flex-direction: column; gap: 20px;">

          <!-- Membership Card -->
          <div class="card">
            <h2 style="display: flex; align-items: center; gap: 8px; font-size: 16px;">
              <span style="font-size: 18px;">üí≥</span> Membership
            </h2>
            <div id="billingDetails"></div>
          </div>

          <!-- Team Card -->
          <div class="card">
            <h2 style="display: flex; align-items: center; gap: 8px; font-size: 16px;">
              <span style="font-size: 18px;">üë•</span> Team
            </h2>
            <div id="teamDetails"></div>
          </div>

          <!-- Agreements (compact) - only shown for subscribers -->
          <div id="agreementsCard" class="card" style="background: var(--color-bg-subtle); display: none;">
            <h2 style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--color-text-secondary); margin-bottom: 10px;">
              <span style="font-size: 16px;">üìã</span> Agreements
            </h2>
            <div id="agreementsSection" style="font-size: 13px;">
              <p style="color: var(--color-text-secondary);">Loading...</p>
            </div>
          </div>

          <!-- Danger Zone - only shown for owners -->
          <div id="dangerZoneCard" class="card" style="background: #fef2f2; border: 1px solid #fecaca; display: none;">
            <h2 style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: #dc2626; margin-bottom: 10px;">
              <span style="font-size: 16px;">‚ö†Ô∏è</span> Danger Zone
            </h2>
            <div style="font-size: 13px;">
              <p style="color: #991b1b; margin-bottom: 12px;">Permanently delete this workspace and all of its data.</p>
              <button onclick="openDeleteWorkspaceModal()" class="btn-danger" style="width: 100%; font-size: 13px; padding: 8px 16px;">
                Delete Workspace
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    let currentOrg = null;
    let selectedOrgId = null;
    let allOrganizations = [];
    let membershipAgreement = null;

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Helper to check if the CURRENT org (not any org) has active subscription
    function currentOrgHasActiveSubscription() {
      return currentOrg?.billing?.status === 'active';
    }

    // Get org ID from URL param or localStorage
    function getInitialOrgId() {
      const urlParams = new URLSearchParams(window.location.search);
      const urlOrgId = urlParams.get('org');
      if (urlOrgId) return urlOrgId;
      return localStorage.getItem('selectedOrgId');
    }

    // Toggle org dropdown
    function toggleOrgDropdown() {
      const dropdown = document.getElementById('orgDropdown');
      dropdown.classList.toggle('show');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const switcher = document.getElementById('orgSwitcher');
      if (switcher && !switcher.contains(e.target)) {
        document.getElementById('orgDropdown').classList.remove('show');
      }
    });

    // Select an organization
    function selectOrg(orgId) {
      selectedOrgId = orgId;
      localStorage.setItem('selectedOrgId', orgId);
      document.getElementById('orgDropdown').classList.remove('show');

      // Update URL without reload
      const url = new URL(window.location);
      url.searchParams.set('org', orgId);
      window.history.replaceState({}, '', url);

      // Re-render the selected org
      renderSelectedOrg();
    }

    // Update org switcher dropdown
    function updateOrgSwitcher() {
      const switcher = document.getElementById('orgSwitcher');
      const dropdown = document.getElementById('orgDropdown');
      const selectedName = document.getElementById('selectedOrgName');

      if (allOrganizations.length <= 1) {
        // Hide switcher if only one org
        switcher.style.display = 'none';
        return;
      }

      switcher.style.display = 'block';

      // Update dropdown items
      dropdown.innerHTML = allOrganizations.map(org => {
        const isSelected = org.id === selectedOrgId;
        const hasSubscription = org.billing?.status === 'active';
        const badgeClass = hasSubscription ? 'active' : 'inactive';
        const badgeText = hasSubscription ? 'Member' : 'Free';

        return `
          <div class="org-switcher-item ${isSelected ? 'selected' : ''}" onclick="selectOrg('${org.id}')">
            <span class="item-name">${org.name}</span>
            <span class="item-badge ${badgeClass}">${badgeText}</span>
          </div>
        `;
      }).join('');

      // Update selected name
      const selected = allOrganizations.find(o => o.id === selectedOrgId);
      if (selected) {
        selectedName.textContent = selected.name;
      }
    }

    // Render the currently selected organization
    function renderSelectedOrg() {
      const org = allOrganizations.find(o => o.id === selectedOrgId);
      if (!org) return;

      currentOrg = org;

      // Update org switcher display
      const selectedOrgNameEl = document.getElementById('selectedOrgName');
      if (selectedOrgNameEl) {
        selectedOrgNameEl.textContent = org.name;
      }

      // Build billing info display
      let billingInfo = '';

      if (org.billingError) {
        billingInfo = `
          <div style="margin-top: 8px; padding: 10px; background: var(--color-error-50); border-left: 3px solid var(--color-error-600); border-radius: 4px;">
            <div style="color: var(--color-error-600); font-weight: bold; margin-bottom: 4px;">‚ö† Error Loading Billing Info</div>
            <small style="color: var(--color-text-secondary);">${org.billingError}</small>
            <br>
            <small style="color: var(--color-text-secondary);">Please refresh the page or contact support if this persists.</small>
          </div>
        `;
      } else if (org.billing?.status === 'active') {
        const renewalDate = org.billing.current_period_end
          ? new Date(org.billing.current_period_end * 1000).toLocaleDateString()
          : '';
        const productName = org.billing.product_name || 'Subscription';
        const cancelNote = org.billing.cancel_at_period_end
          ? ' (cancels at period end)'
          : '';
        const memberSince = org.agreement_signed_at
          ? new Date(org.agreement_signed_at).toLocaleDateString()
          : '';

        billingInfo = `
          <div style="margin-top: 8px; padding: 10px; background: var(--color-info-50); border-left: 3px solid var(--color-success-600); border-radius: 4px;">
            <div style="color: var(--color-success-600); font-weight: bold; margin-bottom: 4px;">‚úì ${productName}</div>
            ${memberSince ? `<small style="color: var(--color-text-secondary); display: block;">Member since: ${memberSince}</small>` : ''}
            <small style="color: var(--color-text-secondary);">Renews: ${renewalDate}${cancelNote}</small>
          </div>
        `;
      } else if (org.billing?.status === 'past_due') {
        billingInfo = `
          <div style="margin-top: 8px; padding: 10px; background: var(--color-warning-50); border-left: 3px solid var(--color-warning-500); border-radius: 4px;">
            <div style="color: var(--color-warning-500); font-weight: bold;">‚ö† Payment Past Due</div>
            <small style="color: var(--color-text-secondary);">Please update your payment method</small>
          </div>
        `;
      } else if (org.billing?.status === 'none') {
        billingInfo = `
          <div style="margin-top: 8px; padding: 10px; background: var(--color-bg-subtle); border-left: 3px solid var(--color-gray-400); border-radius: 4px;">
            <div style="color: var(--color-text-secondary);">No Active Subscription</div>
          </div>
        `;
      } else {
        billingInfo = `
          <div style="margin-top: 8px; padding: 10px; background: var(--color-error-50); border-left: 3px solid var(--color-error-600); border-radius: 4px;">
            <div style="color: var(--color-error-600); font-weight: bold;">Unexpected billing status: ${org.billing?.status || 'unknown'}</div>
          </div>
        `;
      }

      // Show different UI for personal vs team workspaces
      const isPersonal = org.is_personal || false;
      const personalBadge = isPersonal
        ? `<span style="display: inline-block; padding: 2px 8px; background: var(--color-info-100); color: var(--color-info-700); border-radius: 10px; font-size: 11px;">Personal</span>`
        : `<span style="display: inline-block; padding: 2px 8px; background: var(--color-success-100); color: var(--color-success-700); border-radius: 10px; font-size: 11px;">Team</span>`;

      // Subscription badge - shows AdCP membership status
      const subscriptionBadge = org.billing?.status === 'active'
        ? `<span style="display: inline-block; padding: 2px 8px; background: var(--color-primary-100); color: var(--color-success-800); border-radius: 10px; font-size: 11px;">‚úì Subscribed</span>`
        : '';

      // Update welcome header with org info
      document.getElementById('orgName').textContent = org.name;
      document.getElementById('orgBadge').innerHTML = personalBadge + ' ' + subscriptionBadge;
      document.getElementById('orgRole').textContent = `Your role: ${org.role || 'member'}`;

      // Show edit button for owners and admins
      const editBtn = document.getElementById('editOrgNameBtn');
      if (org.role === 'owner' || org.role === 'admin') {
        editBtn.style.display = 'inline-flex';
      } else {
        editBtn.style.display = 'none';
      }

      // Show Danger Zone for owners only
      const dangerZoneCard = document.getElementById('dangerZoneCard');
      if (org.role === 'owner') {
        dangerZoneCard.style.display = 'block';
      } else {
        dangerZoneCard.style.display = 'none';
      }

      // Render Billing Card
      // Only show Manage Billing button if user has subscribed at least once (any status except 'none')
      const hasEverSubscribed = org.billing?.status && org.billing.status !== 'none';
      const billingDetailsDiv = document.getElementById('billingDetails');
      billingDetailsDiv.innerHTML = `
        ${billingInfo}
        ${hasEverSubscribed ? `
        <div style="margin-top: 15px;">
          <button
            onclick="openBillingPortal('${org.id}')"
            class="btn btn-primary btn-block"
          >
            Manage Billing
          </button>
        </div>
        ` : ''}
      `;

      // Render Team Card
      const teamDetailsDiv = document.getElementById('teamDetails');
      if (isPersonal) {
        teamDetailsDiv.innerHTML = `
          <div style="padding: 15px; background: var(--color-bg-subtle); border-radius: 8px; margin-bottom: 15px;">
            <p style="margin: 0; color: var(--color-text-secondary); font-size: 14px;">Personal workspace - upgrade to team to invite members.</p>
          </div>
          <button
            onclick="convertToTeam('${org.id}')"
            class="btn btn-primary btn-block"
            title="Convert to a team workspace to invite members"
          >
            Upgrade to Team
          </button>
        `;
      } else {
        // Load team members with avatars
        loadTeamPreview(org.id);
        teamDetailsDiv.innerHTML = `
          <div id="teamMembersPreview" style="margin-bottom: 12px;">
            <p style="color: var(--color-text-secondary); font-size: 13px;">Loading team...</p>
          </div>
          <div style="display: flex; gap: 8px;">
            <a
              href="/team?org=${org.id}&action=invite"
              class="btn btn-primary btn-sm"
              style="flex: 1;"
            >
              + Invite
            </a>
            <a
              href="/team?org=${org.id}"
              class="btn btn-ghost btn-sm"
              style="flex: 1;"
            >
              Manage
            </a>
          </div>
        `;
      }

      // Render Member Profile Card - always accessible for all users
      const memberProfileDetailsDiv = document.getElementById('memberProfileDetails');
      const memberProfileCard = document.getElementById('memberProfileCard');
      const hasSubscription = org.billing?.status === 'active';

      memberProfileCard.style.opacity = '1';
      // Load member profile preview for everyone
      loadMemberProfilePreview(org.id, hasSubscription);
      memberProfileDetailsDiv.innerHTML = `
        <div id="memberProfilePreview" style="min-height: 150px;">
          <p style="color: var(--color-text-secondary); font-size: 14px;">Loading profile...</p>
        </div>
        <div id="memberProfileActions" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--color-border);"></div>
      `;

      // Show/hide membership section based on this org's subscription status
      const membershipSection = document.getElementById('membershipSection');

      // Show membership section for any org without an active subscription
      if (org.billing?.status !== 'active') {
        membershipSection.style.display = 'block';

        // Create pricing table (includes customer session if available for payment method pre-fill)
        updatePricingTable(org);
      } else {
        membershipSection.style.display = 'none';
      }
    }

    // Update pricing table for current org
    // Dynamically creates the pricing table element to ensure customer session is included from the start
    // Shows different pricing tables for personal vs team workspaces
    function updatePricingTable(org) {
      const container = document.getElementById('pricingTableContainer');
      if (!container) return;

      // Clear any existing pricing table
      container.innerHTML = '';

      // Choose pricing table based on workspace type
      const pricingTableId = org.is_personal
        ? '{{STRIPE_PRICING_TABLE_ID_INDIVIDUAL}}'
        : '{{STRIPE_PRICING_TABLE_ID}}';

      // Create new pricing table element with all attributes set upfront
      const pricingTable = document.createElement('stripe-pricing-table');
      pricingTable.setAttribute('pricing-table-id', pricingTableId);
      pricingTable.setAttribute('publishable-key', '{{STRIPE_PUBLISHABLE_KEY}}');

      // Include customer session if available (enables payment method pre-fill)
      if (org.customerSessionSecret) {
        pricingTable.setAttribute('customer-session-client-secret', org.customerSessionSecret);
      }

      container.appendChild(pricingTable);
    }

    // Load team preview with member avatars
    async function loadTeamPreview(orgId) {
      try {
        const response = await fetch(`/api/organizations/${orgId}/members`);
        if (!response.ok) throw new Error('Failed to load team');

        const data = await response.json();
        const members = data.members || [];
        const previewEl = document.getElementById('teamMembersPreview');
        if (previewEl) {
          if (members.length === 0) {
            previewEl.innerHTML = `<p style="color: var(--color-text-secondary); font-size: 13px;">No team members yet</p>`;
            return;
          }

          // Show member avatars (max 5) with overflow indicator
          const maxAvatars = 5;
          const displayMembers = members.slice(0, maxAvatars);
          const overflow = members.length - maxAvatars;

          const avatars = displayMembers.map((m, i) => {
            // Get initials from first_name/last_name or fall back to email
            let initials = '';
            if (m.first_name && m.last_name) {
              initials = m.first_name[0] + m.last_name[0];
            } else if (m.first_name) {
              initials = m.first_name.substring(0, 2);
            } else if (m.email) {
              // Use first two chars of email username
              initials = m.email.split('@')[0].substring(0, 2);
            } else {
              initials = '?';
            }
            const colors = ['var(--color-brand)', 'var(--color-primary-500)', 'var(--color-warning-500)', 'var(--color-error-500)', 'var(--color-primary-400)'];
            const bgColor = colors[i % colors.length];
            return `
              <div style="width: 32px; height: 32px; border-radius: 50%; background: ${bgColor}; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600; border: 2px solid white; margin-left: ${i === 0 ? '0' : '-8px'};" title="${escapeHtml(m.email || 'Member')}">
                ${escapeHtml(initials.toUpperCase())}
              </div>
            `;
          }).join('');

          const overflowBadge = overflow > 0
            ? `<div style="width: 32px; height: 32px; border-radius: 50%; background: var(--color-gray-200); display: flex; align-items: center; justify-content: center; color: var(--color-text-muted); font-size: 10px; font-weight: 600; border: 2px solid white; margin-left: -8px;">+${overflow}</div>`
            : '';

          const memberText = members.length === 1 ? '1 member' : `${members.length} members`;

          previewEl.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="display: flex;">${avatars}${overflowBadge}</div>
              <span style="color: var(--color-text-secondary); font-size: 12px;">${memberText}</span>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading team preview:', error);
        const previewEl = document.getElementById('teamMembersPreview');
        if (previewEl) {
          previewEl.innerHTML = `<p style="color: var(--color-gray-400); font-size: 13px;">Unable to load team</p>`;
        }
      }
    }

    // Load member profile preview (full preview for prominent display)
    // Uses shared renderMemberCard function from member-card.js
    async function loadMemberProfilePreview(orgId, hasSubscription = false) {
      // Inject shared styles for member card
      injectMemberCardStyles();

      try {
        const response = await fetch(`/api/me/member-profile?org=${orgId}`);
        const previewEl = document.getElementById('memberProfilePreview');
        const actionsContainer = document.getElementById('memberProfileActions');

        if (!response.ok || response.status === 404) {
          if (previewEl) {
            previewEl.innerHTML = `
              <div style="text-align: center; padding: 30px 20px;">
                <div style="font-size: 48px; margin-bottom: 16px;">‚ú®</div>
                <h3 style="margin: 0 0 8px 0; color: var(--color-text-heading);">Create Your Profile</h3>
                <p style="margin: 0; color: var(--color-text-muted); font-size: 14px; max-width: 300px; margin: 0 auto;">
                  Set up your member profile to build your presence in the ecosystem. Your profile will be published to the member directory when you subscribe as a member.
                </p>
              </div>
            `;
          }
          if (actionsContainer) {
            actionsContainer.innerHTML = `
              <a
                href="/member-profile?org=${orgId}"
                style="display: block; text-align: center; padding: 12px 24px; background: var(--color-brand); color: white; border-radius: 6px; text-decoration: none; font-size: 14px; font-weight: 500;"
              >
                Create Profile
              </a>
            `;
          }
          return;
        }

        const data = await response.json();
        const profile = data.profile;

        if (previewEl && profile) {
          // Store profile data for use in action buttons
          window.currentMemberProfile = profile;

          // Use shared renderMemberCard function with preview mode and visibility badge
          // This creates a wrapper div, then extracts the inner content for our preview container
          const cardHtml = renderMemberCard(profile, { isPreview: true, showVisibilityBadge: true });

          // Render the card (skip outer div since our container provides that)
          previewEl.innerHTML = cardHtml;

          // Add "preview" class to prevent hover effects
          const card = previewEl.querySelector('.member-card');
          if (card) {
            card.classList.add('preview');
            // Remove box-shadow since we're inside a card already
            card.style.boxShadow = 'none';
          }

          // Update action buttons in footer section (separate from the card)
          // Note: Website/LinkedIn links are already shown in the member card footer, so we only show action buttons here
          if (actionsContainer) {
            actionsContainer.style.cssText = 'padding: 1rem 0 0 0; background: transparent; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--color-gray-100); margin-top: 0;';

            // Build visibility status/action on left
            let visibilitySection = '';
            if (profile.is_public) {
              visibilitySection = `
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: var(--color-primary-100); color: var(--color-brand); border-radius: 4px; font-size: 12px; font-weight: 500;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="16 12 12 8 8 12"/><line x1="12" y1="16" x2="12" y2="8"/></svg>
                    Public
                  </span>
                  <button
                    onclick="toggleProfileVisibility('${orgId}', false)"
                    class="btn btn-ghost btn-sm"
                  >
                    Unpublish
                  </button>
                </div>
              `;
            } else if (hasSubscription) {
              // Has subscription but not public - can make public
              visibilitySection = `
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: var(--color-gray-100); color: var(--color-text-muted); border-radius: 4px; font-size: 12px; font-weight: 500;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    Draft
                  </span>
                  <button
                    onclick="toggleProfileVisibility('${orgId}', true)"
                    class="btn btn-primary btn-sm"
                  >
                    Make Public
                  </button>
                </div>
              `;
            } else {
              // No subscription - show upgrade prompt
              visibilitySection = `
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: var(--color-gray-100); color: var(--color-text-muted); border-radius: 4px; font-size: 12px; font-weight: 500;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    Draft
                  </span>
                  <button
                    onclick="scrollToMembership()"
                    class="btn btn-primary btn-sm"
                    title="Membership required to publish"
                  >
                    üîí Publish
                  </button>
                </div>
              `;
            }

            // Build edit/view buttons on right
            let editButtons = '';
            if (profile.is_public && profile.slug) {
              editButtons = `
                <div style="display: flex; gap: 8px;">
                  <a
                    href="/members/${profile.slug}"
                    target="_blank"
                    style="padding: 8px 16px; background: white; color: var(--color-text-heading); border: 1px solid var(--color-border); border-radius: 6px; text-decoration: none; font-size: 14px;"
                  >
                    View Live
                  </a>
                  <a
                    href="/member-profile?org=${orgId}"
                    style="padding: 8px 16px; background: var(--color-brand); color: white; border-radius: 6px; text-decoration: none; font-size: 14px; font-weight: 500;"
                  >
                    Edit
                  </a>
                </div>
              `;
            } else {
              editButtons = `
                <a
                  href="/member-profile?org=${orgId}"
                  style="padding: 8px 16px; background: var(--color-brand); color: white; border-radius: 6px; text-decoration: none; font-size: 14px; font-weight: 500;"
                >
                  Edit
                </a>
              `;
            }

            actionsContainer.innerHTML = visibilitySection + editButtons;
          }
        } else if (previewEl) {
          // No profile exists - show "Create Your Profile" UI
          previewEl.innerHTML = `
            <div style="text-align: center; padding: 30px 20px;">
              <div style="font-size: 48px; margin-bottom: 16px;">‚ú®</div>
              <h3 style="margin: 0 0 8px 0; color: var(--color-text-heading);">Create Your Profile</h3>
              <p style="margin: 0; color: var(--color-text-muted); font-size: 14px; max-width: 300px; margin: 0 auto;">
                Set up your member profile to build your presence in the ecosystem. Your profile will be published to the member directory when you subscribe as a member.
              </p>
            </div>
          `;
          if (actionsContainer) {
            actionsContainer.innerHTML = `
              <a
                href="/member-profile?org=${orgId}"
                style="display: block; text-align: center; padding: 12px 24px; background: var(--color-brand); color: white; border-radius: 6px; text-decoration: none; font-size: 14px; font-weight: 500;"
              >
                Create Profile
              </a>
            `;
          }
        }
      } catch (error) {
        console.error('loadMemberProfilePreview: Error caught:', error);
        const previewEl = document.getElementById('memberProfilePreview');
        const actionsContainer = document.getElementById('memberProfileActions');
        if (previewEl) {
          previewEl.innerHTML = `
            <div style="text-align: center; padding: 30px 20px;">
              <div style="font-size: 48px; margin-bottom: 16px;">‚ú®</div>
              <h3 style="margin: 0 0 8px 0; color: var(--color-text-heading);">Create Your Profile</h3>
              <p style="margin: 0; color: var(--color-text-muted); font-size: 14px;">Set up your member profile. It will be published when you subscribe as a member.</p>
            </div>
          `;
        }
        if (actionsContainer) {
          actionsContainer.innerHTML = `
            <a
              href="/member-profile?org=${orgId}"
              style="display: block; text-align: center; padding: 12px 24px; background: var(--color-brand); color: white; border-radius: 6px; text-decoration: none; font-size: 14px; font-weight: 500;"
            >
              Create Profile
            </a>
          `;
        }
      }
    }

    // offeringLabels is now in member-card.js
    function formatOffering(offering) {
      return offeringLabels[offering] || offering;
    }

    // Scroll to membership section
    function scrollToMembership() {
      const membershipSection = document.getElementById('membershipSection');
      if (membershipSection) {
        membershipSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // Toggle profile visibility (make public or unpublish)
    async function toggleProfileVisibility(orgId, makePublic) {
      try {
        const response = await fetch(`/api/me/member-profile/visibility?org=${orgId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            is_public: makePublic,
            show_in_carousel: makePublic
          }),
          credentials: 'include'
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'Failed to update visibility');
        }

        // Reload the profile preview to show updated state
        const org = allOrganizations.find(o => o.id === orgId);
        const hasSubscription = org?.billing?.status === 'active';
        loadMemberProfilePreview(orgId, hasSubscription);
      } catch (error) {
        console.error('Error toggling visibility:', error);
        alert('Failed to update visibility: ' + error.message);
      }
    }

    // Load membership agreement
    async function loadMembershipAgreement() {
      try {
        const response = await fetch('/api/agreement/current?type=membership');
        if (!response.ok) throw new Error('Failed to load agreement');

        membershipAgreement = await response.json();

        // Render markdown to HTML using marked library
        const renderedHtml = marked.parse(membershipAgreement.text);
        document.getElementById('membershipAgreementContent').innerHTML = DOMPurify.sanitize(renderedHtml);
      } catch (error) {
        console.error('Error loading membership agreement:', error);
        document.getElementById('membershipAgreementContent').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load agreement. Please refresh.</p>';
      }
    }

    // Load and display user's agreements (compact view)
    // Only shown for subscribers - non-subscribers see inline agreement in membership section
    async function loadMyAgreements() {
      const section = document.getElementById('agreementsSection');
      const agreementsCard = document.getElementById('agreementsCard');

      // Only show agreements card for subscribers of the CURRENT org
      if (!currentOrgHasActiveSubscription()) {
        if (agreementsCard) agreementsCard.style.display = 'none';
        return;
      }

      // Show the card for subscribers
      if (agreementsCard) agreementsCard.style.display = 'block';

      try {
        const response = await fetch('/api/me/agreements');
        if (!response.ok) throw new Error('Failed to load agreements');

        const data = await response.json();
        const agreements = data.agreements || [];

        if (agreements.length === 0) {
          section.innerHTML = '<p style="color: var(--color-gray-400); font-size: 12px;">No agreements.</p>';
          return;
        }

        section.innerHTML = agreements.map(agreement => {
          const isSigned = !!agreement.version;
          const isOutdated = agreement.is_outdated;

          // Escape values that will be used in onclick handlers
          const escapedType = escapeHtml(agreement.type).replace(/'/g, '\\\'');
          const escapedCurrentVersion = escapeHtml(agreement.current_version || '').replace(/'/g, '\\\'');
          const escapedVersion = escapeHtml(agreement.version || '').replace(/'/g, '\\\'');

          // Missing/unsigned = red, outdated = orange, current = green
          let statusDot, statusText, actionButton;
          if (!isSigned) {
            statusDot = '<span style="width: 6px; height: 6px; background: var(--color-error-500); border-radius: 50%; display: inline-block;"></span>';
            statusText = '<span style="color: var(--color-error-500); font-size: 10px; font-weight: 500;">Required</span>';
            actionButton = `<button onclick="viewAgreementForAcceptance('${escapedType}', '${escapedCurrentVersion}')"
                      class="btn btn-danger btn-sm">
                Sign
              </button>`;
          } else if (isOutdated) {
            statusDot = '<span style="width: 6px; height: 6px; background: var(--color-warning-500); border-radius: 50%; display: inline-block;"></span>';
            statusText = '';
            actionButton = `
              <div style="display: flex; gap: 4px;">
                <button onclick="viewAgreement('${escapedType}', '${escapedVersion}')"
                        style="padding: 4px 8px; background: transparent; color: var(--color-brand); border: none; font-size: 12px; cursor: pointer; text-decoration: underline;">
                  View
                </button>
                <button onclick="copyAgreementLink('${escapedType}')" title="Copy link to share"
                        style="padding: 4px 6px; background: transparent; color: var(--color-text-muted); border: none; font-size: 12px; cursor: pointer;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg>
                </button>
              </div>`;
          } else {
            statusDot = '<span style="width: 6px; height: 6px; background: var(--color-brand); border-radius: 50%; display: inline-block;"></span>';
            statusText = '';
            actionButton = `
              <div style="display: flex; gap: 4px;">
                <button onclick="viewAgreement('${escapedType}', '${escapedVersion}')"
                        style="padding: 4px 8px; background: transparent; color: var(--color-brand); border: none; font-size: 12px; cursor: pointer; text-decoration: underline;">
                  View
                </button>
                <button onclick="copyAgreementLink('${escapedType}')" title="Copy link to share"
                        style="padding: 4px 6px; background: transparent; color: var(--color-text-muted); border: none; font-size: 12px; cursor: pointer;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg>
                </button>
              </div>`;
          }

          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--color-border);">
              <div style="display: flex; align-items: center; gap: 8px;">
                ${statusDot}
                <span style="color: var(--color-text-heading); font-size: 13px;">${escapeHtml(formatAgreementType(agreement.type))}</span>
                ${statusText}
              </div>
              ${actionButton}
            </div>
          `;
        }).join('');

        // Note: We don't auto-popup membership agreements anymore
        // Users accept them inline when choosing a plan, which is less intrusive
      } catch (error) {
        console.error('Error loading agreements:', error);
        section.innerHTML = '<p style="color: var(--color-error-500); font-size: 12px;">Failed to load.</p>';
      }
    }

    // Handle agreement checkbox change
    // Note: Agreement acceptance is recorded in Stripe webhook when subscription succeeds
    // This just enables/disables the pricing table UI
    function setupAgreementCheckbox() {
      const checkbox = document.getElementById('membershipAgreementCheckbox');
      const pricingWrapper = document.getElementById('pricingTableWrapper');
      const warning = document.getElementById('agreementWarning');

      if (!checkbox) return;

      checkbox.addEventListener('change', async (e) => {
        if (e.target.checked) {
          // Enable pricing table (agreement acceptance will be recorded on payment success)
          pricingWrapper.style.opacity = '1';
          pricingWrapper.style.pointerEvents = 'auto';
          warning.style.display = 'none';

          // Store agreement version in organization record for webhook to use
          // This is temporary storage - actual acceptance recorded on payment success
          if (membershipAgreement && currentOrg) {
            try {
              await fetch(`/api/organizations/${currentOrg.id}/pending-agreement`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                  agreement_version: membershipAgreement.version,
                  agreement_accepted_at: new Date().toISOString(),
                })
              });
            } catch (error) {
              console.error('Failed to store pending agreement:', error);
              // Continue anyway - webhook will use current version
            }
          }

          console.log('Agreement checkbox checked - pricing table enabled');
        } else {
          // Disable pricing table
          pricingWrapper.style.opacity = '0.5';
          pricingWrapper.style.pointerEvents = 'none';
          warning.style.display = 'block';
        }
      });
    }

    async function openBillingPortal(orgId) {
      try {
        const response = await fetch(`/api/organizations/${orgId}/billing/portal`, {
          method: 'POST',
          credentials: 'same-origin',
        });

        if (!response.ok) {
          throw new Error('Failed to open billing portal');
        }

        const data = await response.json();
        if (data.portal_url) {
          window.location.href = data.portal_url;
        }
      } catch (error) {
        console.error('Error opening billing portal:', error);
        alert('Failed to open billing portal. Please try again.');
      }
    }

    async function convertToTeam(orgId) {
      if (!confirm('Convert this personal workspace to a team workspace?\n\nThis will allow you to invite team members. This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`/api/organizations/${orgId}/convert-to-team`, {
          method: 'POST',
          credentials: 'same-origin',
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'Failed to convert workspace');
        }

        alert('Workspace converted to team! You can now invite team members.');
        window.location.reload();
      } catch (error) {
        console.error('Error converting to team:', error);
        alert('Failed to convert workspace: ' + error.message);
      }
    }

    async function loadUserData() {
      try {
        const response = await fetch('/api/me');
        if (!response.ok) {
          if (response.status === 401) {
            const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);
            window.location.href = `/auth/login?return_to=${returnUrl}`;
            return;
          }
          throw new Error('Failed to load user data');
        }

        const data = await response.json();

        // Show admin link if user is admin
        if (data.user?.isAdmin) {
          document.getElementById('adminLink').style.display = 'block';
        }

        if (data.organizations && data.organizations.length > 0) {
          // Load billing info for each organization
          const orgsWithBilling = await Promise.all(
            data.organizations.map(async (org) => {
              try {
                const billingResponse = await fetch(`/api/organizations/${org.id}/billing`);
                if (billingResponse.ok) {
                  const billingData = await billingResponse.json();
                  return {
                    ...org,
                    billing: billingData.subscription,
                    stripeCustomerId: billingData.stripe_customer_id,
                    customerSessionSecret: billingData.customer_session_secret,
                    billingError: null
                  };
                } else {
                  const errorData = await billingResponse.json().catch(() => ({ message: 'Unknown error' }));
                  return {
                    ...org,
                    billing: null,
                    billingError: errorData.message || 'Failed to load billing information'
                  };
                }
              } catch (error) {
                console.error('Error loading billing for org:', org.id, error);
                return {
                  ...org,
                  billing: null,
                  billingError: 'Network error - unable to load billing information'
                };
              }
            })
          );

          // Store organizations globally
          allOrganizations = orgsWithBilling;

          // Check if any org has active subscription (for global flag)
          const hasActiveSubscription = orgsWithBilling.some(org => org.billing?.status === 'active');
          window.hasActiveSubscription = hasActiveSubscription;

          // Determine which org to show
          const initialOrgId = getInitialOrgId();
          if (initialOrgId && orgsWithBilling.some(o => o.id === initialOrgId)) {
            selectedOrgId = initialOrgId;
          } else {
            // Default to first org
            selectedOrgId = orgsWithBilling[0].id;
          }

          // Update URL with selected org if not already there
          const url = new URL(window.location);
          if (!url.searchParams.get('org')) {
            url.searchParams.set('org', selectedOrgId);
            window.history.replaceState({}, '', url);
          }

          // Update org switcher dropdown
          updateOrgSwitcher();

          // Render the selected organization
          renderSelectedOrg();

          // Load membership agreement if needed for any org
          await loadMembershipAgreement();
          setupAgreementCheckbox();

          // Load user's signed agreements (only shown for subscribers)
          await loadMyAgreements();

          // Check if membership agreement already accepted - if so, enable pricing table
          await checkMembershipAgreementStatus();

          // Check for outdated agreements (only for subscribers)
          await checkOutdatedAgreements();

        } else {
          // No organizations - redirect to onboarding
          window.location.href = '/onboarding';
          return;
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

      } catch (error) {
        console.error('Error loading user data:', error);
        document.getElementById('loading').innerHTML = `
          <p style="color: var(--color-error-600);">Failed to load dashboard. <a href="/auth/login">Try logging in again</a></p>
        `;
      }
    }

    // Check if user has accepted membership agreement
    async function hasAcceptedMembershipAgreement() {
      try {
        const response = await fetch('/api/me/agreements');
        if (!response.ok) return false;

        const data = await response.json();
        // Check if membership agreement has a signed version (not just exists in the list)
        const membership = data.agreements.find(a => a.type === 'membership');
        return membership && membership.version; // version exists = signed
      } catch (error) {
        console.error('Error checking membership agreement:', error);
        return false;
      }
    }

    // Check membership agreement status and update UI accordingly
    async function checkMembershipAgreementStatus() {
      const hasAccepted = await hasAcceptedMembershipAgreement();

      if (hasAccepted) {
        // User has already accepted - hide the inline agreement section and enable pricing
        const checkbox = document.getElementById('membershipAgreementCheckbox');
        const pricingWrapper = document.getElementById('pricingTableWrapper');
        const warning = document.getElementById('agreementWarning');

        if (checkbox) {
          checkbox.checked = true;
        }
        if (pricingWrapper) {
          pricingWrapper.style.opacity = '1';
          pricingWrapper.style.pointerEvents = 'auto';
        }
        if (warning) {
          warning.style.display = 'none';
        }

        // Hide the agreement acceptance section since it's already done
        const agreementBox = document.querySelector('#membershipSection > div:nth-child(2)');
        if (agreementBox && agreementBox.querySelector('#membershipAgreementCheckbox')) {
          agreementBox.style.display = 'none';
        }
      }
    }

    // Format agreement type for display
    function formatAgreementType(type) {
      const types = {
        'terms_of_service': 'Terms of Service',
        'privacy_policy': 'Privacy Policy',
        'membership': 'Membership Agreement'
      };
      return types[type] || type;
    }

    // Copy agreement link to clipboard for sharing
    async function copyAgreementLink(type) {
      // Use production URL for shareable links
      const baseUrl = window.location.hostname === 'localhost'
        ? window.location.origin
        : 'https://agenticadvertising.org';
      const url = `${baseUrl}/api/agreement?type=${type}`;

      try {
        await navigator.clipboard.writeText(url);

        // Show brief success feedback
        const btn = event.target.closest('button');
        const originalColor = btn.style.color;
        btn.style.color = 'var(--color-success-500)';
        btn.title = 'Link copied!';

        setTimeout(() => {
          btn.style.color = originalColor;
          btn.title = 'Copy link to share';
        }, 2000);
      } catch (error) {
        console.error('Failed to copy link:', error);
        // Fallback: show alert with the URL
        alert(`Agreement link:\n${url}`);
      }
    }

    // Dismiss outdated agreement modal
    function dismissAgreementModal() {
      document.getElementById('outdatedAgreementModal').style.display = 'none';
    }

    // Acknowledge TOS/Privacy updates (no re-acceptance required, just dismiss)
    async function acknowledgeAgreementUpdates() {
      // Record acknowledgment in session so we don't show again this session
      sessionStorage.setItem('acknowledgedAgreementUpdates', 'true');
      dismissAgreementModal();
    }

    // View outdated agreements (only for membership that requires acceptance)
    async function viewOutdatedAgreements() {
      dismissAgreementModal();

      // Get membership agreement that needs acceptance
      try {
        const response = await fetch('/api/me/agreements');
        if (!response.ok) return;

        const data = await response.json();
        const membershipAgreement = data.agreements.find(a =>
          a.type === 'membership' && a.is_outdated && !a.version
        );

        if (membershipAgreement) {
          await viewAgreementForAcceptance('membership', membershipAgreement.current_version);
        }
      } catch (error) {
        console.error('Error loading membership agreement:', error);
      }
    }

    // View specific agreement version (read-only mode)
    async function viewAgreement(type, version) {
      try {
        document.getElementById('agreementViewerModal').style.display = 'flex';
        document.getElementById('agreementViewerContent').innerHTML = 'Loading...';

        // Reset buttons to Close-only for read-only view
        document.getElementById('agreementViewerButtons').innerHTML = `
          <button class="btn btn-primary" onclick="closeAgreementViewer()">Close</button>
        `;

        const response = await fetch(`/api/agreement?type=${type}&version=${version}&format=json`, {
          credentials: 'same-origin'
        });
        if (!response.ok) {
          throw new Error('Failed to load agreement');
        }

        const agreement = await response.json();

        // Update modal content
        document.getElementById('agreementViewerTitle').textContent = formatAgreementType(type);
        document.getElementById('agreementViewerMeta').textContent =
          `Version ${agreement.version} ‚Ä¢ Effective: ${new Date(agreement.effective_date).toLocaleDateString()}`;

        // Render markdown to HTML using marked library
        const renderedHtml = marked.parse(agreement.text);
        document.getElementById('agreementViewerContent').innerHTML = DOMPurify.sanitize(renderedHtml);
      } catch (error) {
        console.error('Error loading agreement:', error);
        document.getElementById('agreementViewerContent').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load agreement. Please try again.</p>';
      }
    }

    // Close agreement viewer modal
    function closeAgreementViewer() {
      document.getElementById('agreementViewerModal').style.display = 'none';
    }

    // Open rename organization modal
    function openRenameModal() {
      if (!currentOrg) return;
      document.getElementById('newOrgName').value = currentOrg.name;
      document.getElementById('renameError').style.display = 'none';
      document.getElementById('renameOrgModal').style.display = 'flex';
      document.getElementById('newOrgName').focus();
    }

    // Close rename organization modal
    function closeRenameModal() {
      document.getElementById('renameOrgModal').style.display = 'none';
      document.getElementById('renameError').style.display = 'none';
    }

    // Confirm rename organization
    async function confirmRenameOrg() {
      if (!currentOrg) return;

      const newName = document.getElementById('newOrgName').value.trim();
      const errorEl = document.getElementById('renameError');
      const confirmBtn = document.getElementById('confirmRenameBtn');

      // Validate
      if (!newName) {
        errorEl.textContent = 'Organization name is required';
        errorEl.style.display = 'block';
        return;
      }

      if (newName === currentOrg.name) {
        closeRenameModal();
        return;
      }

      // Disable button during request
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Renaming...';

      try {
        const response = await fetch(`/api/organizations/${currentOrg.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: newName }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to rename organization');
        }

        // Update the UI
        currentOrg.name = data.organization.name;
        document.getElementById('orgName').textContent = data.organization.name;

        closeRenameModal();
      } catch (error) {
        errorEl.textContent = error.message;
        errorEl.style.display = 'block';
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Rename';
      }
    }

    // Handle Enter key in rename input
    document.addEventListener('DOMContentLoaded', () => {
      const renameInput = document.getElementById('newOrgName');
      if (renameInput) {
        renameInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            confirmRenameOrg();
          }
        });
      }
    });

    // Dismiss required agreement for this session (will show again on next visit)
    // Use sessionStorage to prevent re-popup during current session
    function dismissAgreementForNow() {
      sessionStorage.setItem('dismissedAgreementModal', 'true');
      closeAgreementViewer();
    }

    // Check if we should auto-show agreement modals
    function shouldShowAgreementModal() {
      return !sessionStorage.getItem('dismissedAgreementModal');
    }

    // View agreement for acceptance (with Accept button)
    async function viewAgreementForAcceptance(type, version) {
      try {
        document.getElementById('agreementViewerModal').style.display = 'flex';
        document.getElementById('agreementViewerContent').innerHTML = 'Loading...';

        const response = await fetch(`/api/agreement?type=${type}&version=${version}&format=json`, {
          credentials: 'same-origin'
        });
        if (!response.ok) {
          throw new Error('Failed to load agreement');
        }

        const agreement = await response.json();

        // Update modal content
        document.getElementById('agreementViewerTitle').textContent = formatAgreementType(type);
        document.getElementById('agreementViewerMeta').textContent =
          `Version ${agreement.version} ‚Ä¢ Effective ${new Date(agreement.effective_date).toLocaleDateString()}`;

        // Render markdown to HTML using marked library
        const renderedHtml = marked.parse(agreement.text);
        document.getElementById('agreementViewerContent').innerHTML = DOMPurify.sanitize(renderedHtml);

        // Update buttons based on agreement type
        const buttonsDiv = document.getElementById('agreementViewerButtons');

        if (type === 'membership') {
          // Membership requires formal acceptance with checkbox
          buttonsDiv.innerHTML = `
            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
              <input type="checkbox" id="agreeCheckbox" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">I have read and agree to this ${formatAgreementType(type).toLowerCase()}</span>
            </label>
            <div style="display: flex; gap: 10px; width: 100%;">
              <button class="btn btn-secondary" onclick="dismissAgreementForNow()">Later</button>
              <button class="btn btn-primary" id="acceptButton" onclick="acceptAgreement('${type}', '${version}')" disabled style="opacity: 0.5;">Accept Agreement</button>
            </div>
            <p style="font-size: 11px; color: var(--color-gray-400); margin-top: 10px; text-align: center;">This agreement is required. You'll be reminded to accept it next time.</p>
          `;

          // Enable accept button when checkbox is checked
          document.getElementById('agreeCheckbox').addEventListener('change', (e) => {
            const acceptBtn = document.getElementById('acceptButton');
            if (e.target.checked) {
              acceptBtn.disabled = false;
              acceptBtn.style.opacity = '1';
            } else {
              acceptBtn.disabled = true;
              acceptBtn.style.opacity = '0.5';
            }
          });
        } else {
          // Terms of Service & Privacy Policy - just acknowledgment
          buttonsDiv.innerHTML = `
            <div style="display: flex; gap: 10px; width: 100%; justify-content: flex-end;">
              <button class="btn btn-primary" onclick="acceptAgreement('${type}', '${version}')">I Understand</button>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading agreement:', error);
        document.getElementById('agreementViewerContent').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load agreement. Please try again.</p>';
      }
    }

    // Accept an agreement
    async function acceptAgreement(type, version) {
      try {
        const response = await fetch('/api/me/agreements/accept', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ agreement_type: type, version })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to accept agreement');
        }

        // Close modal
        closeAgreementViewer();

        // If membership agreement was accepted, auto-enable the pricing table
        if (type === 'membership') {
          const checkbox = document.getElementById('membershipAgreementCheckbox');
          const pricingWrapper = document.getElementById('pricingTableWrapper');
          const warning = document.getElementById('agreementWarning');
          const agreementSection = document.querySelector('#membershipSection .agreements');

          if (checkbox) {
            checkbox.checked = true;
          }
          if (pricingWrapper) {
            pricingWrapper.style.opacity = '1';
            pricingWrapper.style.pointerEvents = 'auto';
          }
          if (warning) {
            warning.style.display = 'none';
          }
          // Hide the agreement acceptance section since it's already done
          const agreementBox = document.querySelector('#membershipSection > div:nth-child(2)');
          if (agreementBox && agreementBox.querySelector('#membershipAgreementCheckbox')) {
            agreementBox.style.display = 'none';
          }
        }

        // Reload agreements list to update UI
        await loadMyAgreements();
      } catch (error) {
        console.error('Error accepting agreement:', error);
        alert('Failed to accept agreement: ' + error.message);
      }
    }

    // Check for outdated agreements and show modal if needed
    // Only for subscribers - non-subscribers handle agreements inline when subscribing
    async function checkOutdatedAgreements() {
      // Skip for non-subscribers of the CURRENT org
      if (!currentOrgHasActiveSubscription()) return;

      try {
        const response = await fetch('/api/me/agreements');
        if (!response.ok) return;

        const data = await response.json();

        if (data.needs_reacceptance) {
          // Separate membership (requires acceptance) from TOS/Privacy (info only)
          const outdatedAgreements = data.agreements.filter(a => a.is_outdated);
          const membershipNeedsAcceptance = outdatedAgreements.find(a =>
            a.type === 'membership' && !a.version
          );

          // If only TOS/Privacy updated and already acknowledged this session, skip
          if (!membershipNeedsAcceptance && sessionStorage.getItem('acknowledgedAgreementUpdates')) {
            return;
          }

          // Build the list display
          const outdatedList = outdatedAgreements
            .map(a => {
              const isMembershipRequiringAcceptance = a.type === 'membership' && !a.version;
              return `
                <div style="padding: 10px; background: ${isMembershipRequiringAcceptance ? 'var(--color-error-50)' : 'var(--color-warning-50)'}; border-left: 3px solid ${isMembershipRequiringAcceptance ? 'var(--color-error-500)' : 'var(--color-warning-500)'}; border-radius: 4px; margin: 8px 0;">
                  <strong>${formatAgreementType(a.type)}</strong>
                  ${isMembershipRequiringAcceptance ? '<span style="color: var(--color-error-500); font-size: 11px; margin-left: 8px;">Acceptance Required</span>' : ''}
                  <br>
                  <small style="color: var(--color-text-secondary);">
                    ${a.version ? `Your version: ${a.version}` : 'Not yet accepted'} ‚Üí
                    Current version: ${a.current_version}
                  </small>
                  ${!isMembershipRequiringAcceptance ? `<br><a href="javascript:void(0)" onclick="dismissAgreementModal(); viewAgreement('${a.type}', '${a.current_version}')" style="color: var(--color-brand); font-size: 12px;">View changes</a>` : ''}
                </div>
              `;
            })
            .join('');

          if (!outdatedList) return;

          // Update modal content and buttons based on what needs attention
          document.getElementById('outdatedAgreementsList').innerHTML = outdatedList;

          const buttonsDiv = document.getElementById('outdatedAgreementButtons');
          if (membershipNeedsAcceptance) {
            // Membership needs acceptance - show Review button
            document.getElementById('outdatedAgreementModalMessage').textContent =
              'Your membership agreement requires acceptance to continue.';
            buttonsDiv.innerHTML = `
              <button class="btn btn-secondary" onclick="dismissAgreementModal()">Remind Me Later</button>
              <button class="btn btn-primary" onclick="viewOutdatedAgreements()">Review & Accept</button>
            `;
          } else {
            // Only TOS/Privacy updated - just informational
            document.getElementById('outdatedAgreementModalMessage').textContent =
              'The following agreements have been updated. Your continued use constitutes acceptance of the updated terms.';
            buttonsDiv.innerHTML = `
              <button class="btn btn-primary" onclick="acknowledgeAgreementUpdates()">Got It</button>
            `;
          }

          document.getElementById('outdatedAgreementModal').style.display = 'flex';
        }
      } catch (error) {
        console.error('Error checking outdated agreements:', error);
      }
    }

    // Load agreement history
    async function loadAgreementHistory() {
      try {
        const response = await fetch('/api/me/agreements');
        if (!response.ok) throw new Error('Failed to load agreement history');

        const data = await response.json();
        const historyDiv = document.getElementById('agreementHistory');

        if (data.agreements && data.agreements.length > 0) {
          // Build table with outdated status and clickable links
          historyDiv.innerHTML = `
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="border-bottom: 2px solid var(--color-border);">
                  <th style="text-align: left; padding: 10px; color: var(--color-text-secondary); font-weight: 600;">Agreement</th>
                  <th style="text-align: left; padding: 10px; color: var(--color-text-secondary); font-weight: 600;">Version</th>
                  <th style="text-align: left; padding: 10px; color: var(--color-text-secondary); font-weight: 600;">Accepted</th>
                  <th style="text-align: left; padding: 10px; color: var(--color-text-secondary); font-weight: 600;">Status</th>
                </tr>
              </thead>
              <tbody>
                ${data.agreements.map(acceptance => `
                  <tr style="border-bottom: 1px solid var(--color-gray-100);">
                    <td style="padding: 10px;">${formatAgreementType(acceptance.type)}</td>
                    <td style="padding: 10px;">
                      ${acceptance.version
                        ? `<a href="javascript:void(0)" onclick="viewAgreement('${acceptance.type}', '${acceptance.version}')" style="color: var(--color-brand); text-decoration: underline; cursor: pointer;">${acceptance.version}</a>`
                        : 'Not accepted'}
                      ${acceptance.is_outdated && acceptance.current_version
                        ? `<br><small style="color: var(--color-warning-500);">‚Üí <a href="javascript:void(0)" onclick="viewAgreement('${acceptance.type}', '${acceptance.current_version}')" style="color: var(--color-warning-500); text-decoration: underline; cursor: pointer;">${acceptance.current_version} available</a></small>`
                        : ''}
                    </td>
                    <td style="padding: 10px;">${acceptance.accepted_at ? new Date(acceptance.accepted_at).toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    }) : 'Not accepted'}</td>
                    <td style="padding: 10px;">
                      ${acceptance.is_outdated
                        ? '<span style="color: var(--color-warning-500); font-weight: bold;">‚ö† Update Required</span>'
                        : '<span style="color: var(--color-success-600);">‚úì Current</span>'}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          historyDiv.innerHTML = '<p style="color: var(--color-text-secondary);">No agreement acceptances recorded.</p>';
        }
      } catch (error) {
        console.error('Error loading agreement history:', error);
        document.getElementById('agreementHistory').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load agreement history.</p>';
      }
    }

    loadUserData();

    // Handle browser back/forward cache (bfcache) restoration
    // When user hits back from Stripe, reinitialize the pricing table
    window.addEventListener('pageshow', (event) => {
      if (event.persisted && currentOrg) {
        // Page was restored from bfcache
        console.log('Page restored from cache, reloading pricing table');

        // Recreate pricing table with current org's customer session
        updatePricingTable(currentOrg);
      }
    });

    // Delete workspace modal functions
    function openDeleteWorkspaceModal() {
      if (!currentOrg) return;
      document.getElementById('deleteWorkspaceName').textContent = currentOrg.name;
      document.getElementById('deleteConfirmInput').value = '';
      document.getElementById('deleteWorkspaceError').style.display = 'none';
      document.getElementById('confirmDeleteWorkspaceBtn').disabled = true;
      document.getElementById('confirmDeleteWorkspaceBtn').style.opacity = '0.5';
      document.getElementById('deleteWorkspaceModal').classList.add('show');
      document.getElementById('deleteConfirmInput').focus();
    }

    function closeDeleteWorkspaceModal() {
      document.getElementById('deleteWorkspaceModal').classList.remove('show');
      document.getElementById('deleteWorkspaceError').style.display = 'none';
    }

    function checkDeleteWorkspaceConfirmation() {
      if (!currentOrg) return;
      const input = document.getElementById('deleteConfirmInput').value;
      const btn = document.getElementById('confirmDeleteWorkspaceBtn');
      if (input === currentOrg.name) {
        btn.disabled = false;
        btn.style.opacity = '1';
      } else {
        btn.disabled = true;
        btn.style.opacity = '0.5';
      }
    }

    async function confirmDeleteWorkspace() {
      if (!currentOrg) return;

      const confirmation = document.getElementById('deleteConfirmInput').value;
      const errorEl = document.getElementById('deleteWorkspaceError');
      const btn = document.getElementById('confirmDeleteWorkspaceBtn');

      // Disable button during request
      btn.disabled = true;
      btn.textContent = 'Deleting...';
      errorEl.style.display = 'none';

      try {
        const response = await fetch(`/api/organizations/${currentOrg.id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ confirmation }),
          credentials: 'same-origin',
        });

        const data = await response.json();

        if (!response.ok) {
          // Use the API's message which is more specific about the issue
          throw new Error(data.message || data.error || 'Failed to delete workspace');
        }

        // Success - redirect to onboarding to show join/create options
        alert('Workspace deleted successfully.');
        localStorage.removeItem('selectedOrgId');
        window.location.href = '/onboarding';
      } catch (error) {
        errorEl.textContent = error.message;
        errorEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Delete Workspace';
      }
    }

    // Handle Enter key in delete confirmation input
    document.addEventListener('DOMContentLoaded', () => {
      const deleteInput = document.getElementById('deleteConfirmInput');
      if (deleteInput) {
        deleteInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !document.getElementById('confirmDeleteWorkspaceBtn').disabled) {
            confirmDeleteWorkspace();
          }
        });
      }
    });
  </script>
</body>
</html>
