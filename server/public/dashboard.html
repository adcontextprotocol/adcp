<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - AdCP Registry</title>
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <link rel="stylesheet" href="/design-system.css">
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <style>
    /* =============================================================================
       Dashboard-specific styles
       Uses design system variables - see /design-system.css for tokens
       ============================================================================= */

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--color-bg-page);
    }

    .container {
      max-width: var(--container-xl);
      margin: var(--space-10) auto;
      padding: 0 var(--space-5);
    }

    .welcome {
      background: var(--color-bg-card);
      border-radius: var(--card-radius);
      padding: var(--space-10);
      margin-bottom: var(--space-8);
      box-shadow: var(--shadow-sm);
    }

    h1 {
      color: var(--color-text-heading);
      margin-bottom: var(--space-2.5);
      font-size: var(--text-4xl);
    }

    p {
      color: var(--color-text-secondary);
      line-height: var(--leading-relaxed);
      margin-bottom: var(--space-5);
    }

    .card {
      background: var(--color-bg-card);
      border-radius: var(--card-radius);
      padding: var(--space-8);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-sm);
    }

    .card h2 {
      color: var(--color-text-heading);
      margin-bottom: var(--space-4);
      font-size: var(--text-xl);
    }

    .info-box {
      background: var(--color-info-50);
      border-left: var(--border-4) solid var(--color-info-500);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-5);
    }

    .loading {
      text-align: center;
      padding: var(--space-10);
      color: var(--color-text-secondary);
    }

    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--modal-backdrop);
      z-index: var(--z-modal);
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: var(--color-bg-card);
      border-radius: var(--modal-radius);
      padding: var(--modal-padding);
      max-width: var(--modal-max-width);
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--modal-shadow);
    }

    .modal h2 {
      color: var(--color-warning-500);
      margin-bottom: var(--space-4);
    }

    .modal-buttons {
      display: flex;
      gap: var(--space-4);
      margin-top: var(--space-5);
      justify-content: flex-end;
    }

    /* Buttons now use design-system.css classes:
       - .btn .btn-primary = blue background
       - .btn .btn-secondary = gray background
       - .btn .btn-danger = red background
       - .btn .btn-sm = smaller size
    */

    /* Responsive layout for dashboard */
    @media (max-width: 900px) {
      .dashboard-grid {
        grid-template-columns: 1fr !important;
      }
    }

    /* Toast notification */
    .toast {
      position: fixed;
      top: var(--space-5);
      left: 50%;
      transform: translateX(-50%);
      background: var(--color-success-600);
      color: white;
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      z-index: var(--z-toast);
      opacity: 0;
      transition: opacity 0.3s ease;
      font-weight: 500;
    }
    .toast.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <!-- Toast notification -->
  <div id="toast" class="toast"></div>
  <!-- Outdated Agreement Modal -->
  <div id="outdatedAgreementModal" class="modal-overlay">
    <div class="modal">
      <h2 id="outdatedAgreementModalTitle">‚ö†Ô∏è Agreement Update</h2>
      <div id="modalContent">
        <p id="outdatedAgreementModalMessage">One or more agreements have been updated.</p>
        <div id="outdatedAgreementsList" style="margin: 20px 0;"></div>
      </div>
      <div id="outdatedAgreementButtons" class="modal-buttons">
        <button class="btn btn-secondary" onclick="dismissAgreementModal()">Remind Me Later</button>
        <button class="btn btn-primary" onclick="viewOutdatedAgreements()">Review</button>
      </div>
    </div>
  </div>

  <!-- Agreement Viewer Modal -->
  <div id="agreementViewerModal" class="modal-overlay">
    <div class="modal" style="max-width: 700px; max-height: 85vh; display: flex; flex-direction: column; margin: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-shrink: 0;">
        <div>
          <h2 id="agreementViewerTitle" style="font-size: 18px;">Agreement</h2>
          <p id="agreementViewerMeta" style="color: var(--color-text-secondary); font-size: 13px; margin: 5px 0 0 0;"></p>
        </div>
        <button onclick="closeAgreementViewer()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-secondary); padding: 0; line-height: 1;">√ó</button>
      </div>
      <div id="agreementViewerContent" style="overflow-y: auto; flex: 1; min-height: 0; padding: 15px; background: var(--color-bg-subtle); border-radius: 6px; font-size: 13px; line-height: 1.6;">
        Loading...
      </div>
      <div id="agreementViewerButtons" class="modal-buttons" style="margin-top: 15px; flex-shrink: 0;">
        <button class="btn btn-primary" onclick="closeAgreementViewer()">Close</button>
      </div>
    </div>
  </div>

  <!-- Rename Organization Modal -->
  <div id="renameOrgModal" class="modal-overlay">
    <div class="modal" style="max-width: 400px;">
      <h2>Rename Organization</h2>
      <div style="margin: 20px 0;">
        <label for="newOrgName" style="display: block; margin-bottom: 8px; font-weight: 500;">Organization Name</label>
        <input type="text" id="newOrgName" style="width: 100%; padding: 10px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 14px;" placeholder="Enter new name">
        <p id="renameError" style="color: var(--color-error-600); font-size: 13px; margin: 8px 0 0 0; display: none;"></p>
      </div>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeRenameModal()">Cancel</button>
        <button class="btn btn-primary" id="confirmRenameBtn" onclick="confirmRenameOrg()">Rename</button>
      </div>
    </div>
  </div>

  <!-- AAO top navigation -->
  <div id="adcp-nav"></div>
  <script src="/nav.js"></script>

  <!-- Dashboard sidebar navigation -->
  <script src="/dashboard-nav.js"></script>
  <script src="/member-card.js"></script>
  <script src="/join-cta.js"></script>

  <div class="container">
    <!-- Hidden elements for backwards compatibility -->
    <span id="orgName" style="display: none;"></span>
    <span id="orgBadge" style="display: none;"></span>
    <span id="orgRole" style="display: none;"></span>
    <button id="editOrgNameBtn" style="display: none;"></button>

    <div id="loading" class="loading">
      Loading your information...
    </div>

    <div id="content" style="display:none;">

      <!-- Dashboard section styles -->
      <style>
        .dashboard-section {
          margin-bottom: 48px;
          scroll-margin-top: 80px; /* Account for fixed header when jumping to anchors */
        }
        .section-header {
          margin-bottom: 16px;
        }
        .section-header h2 {
          margin: 0 0 4px 0;
          font-size: 20px;
          color: var(--color-text-heading);
        }
        .section-header p {
          margin: 0;
          font-size: 14px;
          color: var(--color-text-secondary);
        }
        .action-bar {
          margin-top: 12px;
          padding: 16px;
          background: var(--color-bg-card);
          border: 1px solid var(--color-border);
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: space-between;
          flex-wrap: wrap;
          gap: 12px;
        }
        .action-bar-status {
          display: flex;
          align-items: center;
          gap: 8px;
        }
        .status-badge {
          padding: 4px 10px;
          border-radius: 4px;
          font-size: 12px;
          font-weight: 500;
        }
        .status-text {
          color: var(--color-text-secondary);
          font-size: 14px;
        }
        .action-bar-buttons {
          display: flex;
          gap: 8px;
        }
        .section-card {
          background: var(--color-bg-card);
          border: 1px solid var(--color-border);
          border-radius: 12px;
          overflow: hidden;
        }
        .section-card-body {
          padding: 20px;
        }

        /* Promo banner styles */
        .promo-banner {
          background: linear-gradient(135deg, var(--color-brand) 0%, var(--color-primary-600) 100%);
          border-radius: var(--card-radius);
          padding: var(--space-6);
          margin-bottom: var(--space-8);
          color: white;
          position: relative;
          overflow: hidden;
        }
        .promo-banner::before {
          content: '';
          position: absolute;
          top: -50%;
          right: -50%;
          width: 100%;
          height: 200%;
          background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 50%);
          pointer-events: none;
        }
        .promo-banner-content {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: var(--space-4);
          flex-wrap: wrap;
          position: relative;
          z-index: 1;
        }
        .promo-banner-text {
          flex: 1;
          min-width: 200px;
        }
        .promo-banner-badge {
          display: inline-block;
          background: rgba(255,255,255,0.2);
          padding: 4px 10px;
          border-radius: var(--radius-full);
          font-size: 11px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          margin-bottom: 8px;
        }
        .promo-banner h3 {
          margin: 0 0 4px 0;
          font-size: 20px;
          font-weight: 600;
        }
        .promo-banner p {
          margin: 0;
          font-size: 14px;
          color: rgba(255, 255, 255, 0.95);
        }
        .promo-banner-price {
          font-size: 28px;
          font-weight: 700;
          white-space: nowrap;
        }
        .promo-banner-subtext {
          font-size: 12px;
          color: rgba(255, 255, 255, 0.9);
          margin-top: 4px;
        }
        .promo-banner-action {
          display: flex;
          align-items: center;
          gap: var(--space-6);
        }
        .promo-banner .btn {
          background: white;
          color: var(--color-brand);
          font-weight: 600;
        }
        .promo-banner .btn:hover {
          background: var(--color-gray-100);
        }

        /* Org info card styles */
        .org-info-card {
          background: var(--color-warning-50);
          border: 1px solid var(--color-warning-300);
          border-radius: var(--card-radius);
          padding: var(--space-5);
          margin-bottom: var(--space-5);
        }
        .org-info-card h4 {
          margin: 0 0 8px 0;
          color: var(--color-warning-700);
          font-size: 16px;
          display: flex;
          align-items: center;
          gap: 8px;
        }
        .org-info-card p {
          margin: 0 0 16px 0;
          color: var(--color-text-secondary);
          font-size: 14px;
        }
        .org-info-form {
          display: flex;
          flex-direction: column;
          gap: 12px;
        }
        .org-info-form label {
          font-size: 13px;
          font-weight: 500;
          color: var(--color-text-heading);
          margin-bottom: 4px;
          display: block;
        }
        .org-info-form select {
          width: 100%;
          padding: 10px 12px;
          border: 1px solid var(--color-border);
          border-radius: var(--radius-md);
          font-size: 14px;
          background: white;
        }
        .org-info-form select:focus {
          outline: none;
          border-color: var(--color-brand);
          box-shadow: 0 0 0 2px var(--color-primary-100);
        }
      </style>

      <!-- ========== PROMO BANNER ========== -->
      <div id="promoBanner" style="display: none;"></div>

      <!-- ========== PROFILE SECTION ========== -->
      <section id="profile" class="dashboard-section">
        <div class="section-header">
          <h2>Member Profile</h2>
          <p>How your organization appears in the member directory</p>
        </div>
        <div id="profileCardContainer">
          <div class="section-card" style="padding: 40px; text-align: center; color: var(--color-text-secondary);">
            Loading profile...
          </div>
        </div>
        <div id="profileActionBar" class="action-bar" style="display: none;">
          <div class="action-bar-status">
            <span id="profileStatusBadge" class="status-badge"></span>
            <span id="profileStatusText" class="status-text"></span>
          </div>
          <div id="profileActionButtons" class="action-bar-buttons"></div>
        </div>
      </section>

      <!-- ========== TEAM SECTION ========== -->
      <section id="team" class="dashboard-section">
        <div class="section-header">
          <h2>Team</h2>
          <p>Manage your organization's members</p>
        </div>
        <div class="section-card" id="teamCard">
          <div id="teamCardContent" class="section-card-body">
            <div style="text-align: center; color: var(--color-text-secondary);">Loading team...</div>
          </div>
        </div>
      </section>

      <!-- ========== WORKING GROUPS SECTION ========== -->
      <section id="working-groups" class="dashboard-section">
        <div class="section-header">
          <h2>Working Groups</h2>
          <p>Collaborate with other members on shared interests</p>
        </div>
        <div class="section-card" id="workingGroupsCard">
          <div id="workingGroupsCardContent" class="section-card-body">
            <div style="text-align: center; color: var(--color-text-secondary);">Loading working groups...</div>
          </div>
        </div>
      </section>

      <!-- ========== MEMBERSHIP SECTION ========== -->
      <section id="membership" class="dashboard-section">
        <div class="section-header">
          <h2>Membership</h2>
          <p>Your subscription and billing</p>
        </div>

        <!-- Membership Card (for subscribers) -->
        <div class="section-card" id="membershipCard" style="display: none;">
          <div style="display: flex; align-items: start; gap: 16px; padding: 20px;">
            <div id="membershipIcon" style="width: 64px; height: 64px; border-radius: 12px; background: linear-gradient(135deg, var(--color-brand) 0%, var(--color-primary-400) 100%); display: flex; align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0; color: white;">
              ‚≠ê
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <h3 id="membershipTitle" style="margin: 0; font-size: 18px; color: var(--color-text-heading);">Membership</h3>
                <span id="membershipBadge" style="display: none; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;"></span>
              </div>
              <p id="membershipDescription" style="margin: 0 0 12px 0; color: var(--color-text-secondary); font-size: 14px;">Loading...</p>
              <div id="membershipActions"></div>
            </div>
          </div>
        </div>

        <!-- Pending Invoice Card (shown when there's an open invoice) -->
        <div class="section-card" id="pendingInvoiceCard" style="display: none;">
          <div style="display: flex; align-items: start; gap: 16px; padding: 20px; background: var(--color-warning-50); border-radius: 8px;">
            <div style="width: 64px; height: 64px; border-radius: 12px; background: linear-gradient(135deg, var(--color-warning-600) 0%, var(--color-warning-500) 100%); display: flex; align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0; color: white;">
              üìÑ
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <h3 style="margin: 0; font-size: 18px; color: var(--color-text-heading);">Invoice Pending</h3>
                <span style="padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; background: var(--color-warning-100); color: var(--color-warning-700);">Awaiting Payment</span>
              </div>
              <p id="pendingInvoiceDescription" style="margin: 0 0 12px 0; color: var(--color-text-secondary); font-size: 14px;">You have an invoice ready for payment.</p>
              <div id="pendingInvoiceActions"></div>
            </div>
          </div>
        </div>

        <!-- Pricing Section (for non-subscribers) -->
        <div id="inlinePricingSection" class="section-card" style="display: none;">
          <div style="display: flex; align-items: center; gap: 12px; padding: 20px; border-bottom: 1px solid var(--color-border);">
            <div style="width: 48px; height: 48px; border-radius: 10px; background: linear-gradient(135deg, var(--color-brand) 0%, var(--color-primary-400) 100%); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white;">
              ‚≠ê
            </div>
            <div>
              <h3 style="margin: 0; font-size: 18px; color: var(--color-text-heading);">Become a Member</h3>
              <p style="margin: 4px 0 0 0; color: var(--color-text-secondary); font-size: 14px;">Publish your profile, join the directory, and support the ecosystem.</p>
            </div>
          </div>
          <div class="section-card-body">
            <!-- Org info collection (shown if company_type or revenue_tier missing) -->
            <div id="orgInfoCard" class="org-info-card" style="display: none;">
              <h4>üìã Tell us about your organization</h4>
              <p>Help us show you the right membership options by providing some details about your organization.</p>
              <form class="org-info-form" id="orgInfoForm" onsubmit="saveOrgInfo(event)">
                <div>
                  <label for="companyTypeSelect">Organization type</label>
                  <select id="companyTypeSelect" required>
                    <option value="">Select type...</option>
                    <option value="brand">Brand / Advertiser</option>
                    <option value="agency">Agency</option>
                    <option value="publisher">Publisher</option>
                    <option value="tech_vendor">Technology Vendor</option>
                    <option value="consultant">Consultant</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div id="revenueTierContainer">
                  <label for="revenueTierSelect">Annual revenue</label>
                  <select id="revenueTierSelect" required>
                    <option value="">Select range...</option>
                    <option value="under_1m">Under $1M</option>
                    <option value="1m_5m">$1M - $5M</option>
                    <option value="5m_50m">$5M - $50M</option>
                    <option value="50m_250m">$50M - $250M</option>
                    <option value="250m_1b">$250M - $1B</option>
                    <option value="1b_plus">Over $1B</option>
                  </select>
                </div>
                <button type="submit" class="btn btn-primary" id="saveOrgInfoBtn">Continue to Pricing</button>
              </form>
            </div>

            <!-- Agreement checkbox -->
            <div id="agreementSection" style="border: 1px solid var(--color-border); border-radius: 8px; padding: 16px; background: var(--color-bg-subtle); margin-bottom: 16px;">
              <div id="inlineAgreementContent" style="max-height: 150px; overflow-y: auto; padding: 12px; background: white; border: 1px solid var(--color-border); border-radius: 4px; margin-bottom: 12px; font-size: 13px; line-height: 1.6;">
                Loading agreement...
              </div>
              <label style="display: flex; align-items: start; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="inlineAgreementCheckbox" style="margin-top: 3px; cursor: pointer;" />
                <span style="font-size: 13px;">I have read and agree to the <strong>AgenticAdvertising.org Membership Agreement</strong></span>
              </label>
            </div>

            <!-- Dynamic pricing from API (replaces Stripe pricing table) -->
            <div id="inlinePricingWrapper" style="opacity: 0.5; pointer-events: none; transition: opacity 0.3s;">
              <div id="inlinePricingContainer">
                <div style="text-align: center; padding: 40px; color: var(--color-text-secondary);">
                  Loading membership options...
                </div>
              </div>
            </div>
            <div id="inlineAgreementWarning" style="display: block; text-align: center; color: var(--color-text-secondary); font-size: 13px; margin-top: 12px; padding: 10px; background: var(--color-warning-50); border: 1px solid var(--color-warning-300); border-radius: 4px;">
              Please accept the membership agreement above to view pricing
            </div>

            <!-- Invoice request link -->
            <p style="text-align: center; margin-top: 16px; font-size: 14px; color: var(--color-text-secondary);">
              Need an invoice for a PO? <button type="button" onclick="openInvoiceRequestModal()" style="color: var(--color-brand); text-decoration: underline; background: none; border: none; padding: 0; font: inherit; cursor: pointer;">Request an invoice</button>
            </p>
          </div>
        </div>
      </section>

      <!-- Hidden legacy elements for JS compatibility -->
      <div id="memberProfileDetails" style="display: none;"></div>
      <div id="membershipCardContent" style="display: none;"></div>
      <div id="membershipCardHeader" style="display: none;"></div>

      <!-- Hidden elements for status card JS compatibility -->
      <span id="profileStatus" style="display: none;"></span>
      <span id="profileSubtext" style="display: none;"></span>
      <span id="teamStatus" style="display: none;"></span>
      <span id="teamSubtext" style="display: none;"></span>
      <span id="workingGroupStatus" style="display: none;"></span>
      <span id="workingGroupSubtext" style="display: none;"></span>
      <span id="membershipStatus" style="display: none;"></span>
      <span id="membershipSubtext" style="display: none;"></span>
      <span id="billingActionText" style="display: none;"></span>
      <a id="billingAction" href="/dashboard/membership" style="display: none;"></a>
      <a id="inviteTeamAction" href="/team" style="display: none;"></a>

      <!-- Hidden membership signup section - shown in modal or expanded view -->
      <div id="membershipSection" style="display:none;">
        <div style="border: 1px solid var(--color-border); border-radius: 8px; padding: 20px; background: var(--color-bg-subtle); margin-bottom: 20px;">
          <h4 style="margin: 0 0 10px 0; font-size: 16px;">Membership Agreement</h4>
          <div id="membershipAgreementContent" style="max-height: 200px; overflow-y: auto; padding: 15px; background: white; border: 1px solid var(--color-border); border-radius: 4px; margin-bottom: 15px; font-size: 14px; line-height: 1.6;">
            Loading agreement...
          </div>
          <label style="display: flex; align-items: start; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="membershipAgreementCheckbox" style="margin-top: 4px; cursor: pointer;" />
            <span style="font-size: 14px;">I have read and agree to the <strong>AgenticAdvertising.org Membership Agreement</strong></span>
          </label>
        </div>
        <div id="pricingTableWrapper" style="opacity: 0.5; pointer-events: none; transition: opacity 0.3s;">
          <!-- Product selection UI is dynamically rendered here -->
          <div id="pricingTableContainer"></div>
        </div>
        <div id="agreementWarning" style="display: block; text-align: center; color: var(--color-text-secondary); font-size: 14px; margin-top: 10px; padding: 10px; background: var(--color-warning-50); border: 1px solid var(--color-warning-300); border-radius: 4px;">
          Please accept the membership agreement above to continue
        </div>

        <p style="text-align: center; margin-top: 16px; font-size: 14px; color: var(--color-text-secondary);">
          Need an invoice for a PO? <button type="button" onclick="openInvoiceRequestModal()" style="color: var(--aao-primary); text-decoration: underline; background: none; border: none; padding: 0; font: inherit; cursor: pointer;">Request an invoice</button>
        </p>
      </div>

      <!-- Legacy elements for backwards compatibility -->
      <div id="billingDetails" style="display: none;"></div>
      <div id="teamDetails" style="display: none;"></div>
      <div id="workingGroupsDetails" style="display: none;"></div>

    </div>
  </div>

  <script>
    let currentOrg = null;
    let selectedOrgId = null;
    let allOrganizations = [];
    let membershipAgreement = null;

    // Dev mode helper: get current dev_user from URL
    function getDevUser() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('dev_user');
    }

    // Dev mode helper: add dev_user to API URL if present
    function apiUrl(path) {
      const devUser = getDevUser();
      if (devUser) {
        const separator = path.includes('?') ? '&' : '?';
        return `${path}${separator}dev_user=${devUser}`;
      }
      return path;
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Helper to check if the CURRENT org (not any org) has active subscription
    function currentOrgHasActiveSubscription() {
      return currentOrg?.billing?.status === 'active';
    }

    // Get org ID from URL param or localStorage
    function getInitialOrgId() {
      const urlParams = new URLSearchParams(window.location.search);
      const urlOrgId = urlParams.get('org');
      if (urlOrgId) return urlOrgId;
      return localStorage.getItem('selectedOrgId');
    }

    // Select an organization
    function selectOrg(orgId) {
      selectedOrgId = orgId;
      localStorage.setItem('selectedOrgId', orgId);

      // Update URL without reload
      const url = new URL(window.location);
      url.searchParams.set('org', orgId);
      window.history.replaceState({}, '', url);

      // Update sidebar org name and badges
      const selectedOrg = allOrganizations.find(o => o.id === orgId);
      if (selectedOrg) {
        DashboardNav.setOrgName(selectedOrg.name);
        DashboardNav.setOrgStatus({
          isPersonal: selectedOrg.billing?.is_personal || false,
          isSubscribed: selectedOrg.billing?.status === 'active'
        });
      }

      // Re-render the selected org
      renderSelectedOrg();
    }

    // Render the currently selected organization
    function renderSelectedOrg() {
      const org = allOrganizations.find(o => o.id === selectedOrgId);
      if (!org) return;

      currentOrg = org;

      const isPersonal = org.billing?.is_personal || org.is_personal || false;
      const hasSubscription = org.billing?.status === 'active';
      const hasEverSubscribed = org.billing?.status && org.billing.status !== 'none';

      // Update legacy hidden elements for backwards compatibility
      document.getElementById('orgName').textContent = org.name;
      document.getElementById('orgRole').textContent = `Your role: ${org.role || 'member'}`;

      // Update section descriptions based on account type
      const profileDesc = document.querySelector('#profile .section-header p');
      const teamDesc = document.querySelector('#team .section-header p');
      const teamHeading = document.querySelector('#team .section-header h2');
      if (profileDesc) {
        profileDesc.textContent = isPersonal
          ? 'How you appear in the member directory'
          : 'How your organization appears in the member directory';
      }
      if (teamHeading && teamDesc) {
        if (isPersonal) {
          teamHeading.textContent = 'Teammates';
          teamDesc.textContent = 'Invite others to collaborate on your workspace';
        } else {
          teamHeading.textContent = 'Team';
          teamDesc.textContent = "Manage your organization's members";
        }
      }

      // ===== PROFILE CARD =====
      renderProfileCard(org.id, hasSubscription);

      // ===== MEMBERSHIP CARD =====
      renderMembershipCard(org, hasSubscription);

      // ===== LOAD DATA =====
      loadTeamSection(org.id);
      loadWorkingGroupsSection();

      // ===== MEMBERSHIP SIGNUP SECTION (hidden, for modal use) =====
      const membershipSection = document.getElementById('membershipSection');
      if (!hasSubscription) {
        updatePricingTable(org);
      }
      membershipSection.style.display = 'none';
    }

    // Render the profile card using shared renderMemberCard component
    async function renderProfileCard(orgId, hasSubscription) {
      // Inject shared styles for member card
      injectMemberCardStyles();

      const container = document.getElementById('profileCardContainer');
      const actionBar = document.getElementById('profileActionBar');
      const statusBadge = document.getElementById('profileStatusBadge');
      const statusText = document.getElementById('profileStatusText');
      const actionButtons = document.getElementById('profileActionButtons');

      try {
        const response = await fetch(`/api/me/member-profile?org=${orgId}`);

        if (!response.ok) {
          throw new Error('Failed to load profile');
        }

        const data = await response.json();
        const profile = data.profile;

        if (!profile) {
          // No profile yet - show create profile prompt
          container.innerHTML = `
            <div class="card" style="padding: 40px; text-align: center;">
              <div style="font-size: 48px; margin-bottom: 16px;">‚ú®</div>
              <h3 style="margin: 0 0 8px 0; color: var(--color-text-heading);">Create Your Profile</h3>
              <p style="margin: 0 0 20px 0; color: var(--color-text-secondary);">Set up your presence in the member directory</p>
              <a href="/member-profile?org=${orgId}" class="btn btn-primary">Create Profile</a>
            </div>
          `;
          actionBar.style.display = 'none';
          return;
        }

        // Use the shared renderMemberCard function with isPreview=true (no click-to-view)
        container.innerHTML = renderMemberCard(profile, { isPreview: true, showVisibilityBadge: true });

        // Show action bar with status and buttons
        actionBar.style.display = 'block';

        // Status badge
        if (profile.is_public) {
          statusBadge.textContent = 'Public';
          statusBadge.style.background = 'var(--color-success-100)';
          statusBadge.style.color = 'var(--color-success-700)';
          statusText.textContent = 'Your profile is visible in the member directory';
        } else {
          statusBadge.textContent = 'Draft';
          statusBadge.style.background = 'var(--color-gray-100)';
          statusBadge.style.color = 'var(--color-text-muted)';
          statusText.textContent = 'Your profile is not yet published';
        }

        // Action buttons
        let buttonsHtml = '';
        if (profile.is_public && profile.slug) {
          buttonsHtml = `
            <a href="/members/${escapeHtml(profile.slug)}" target="_blank" class="btn btn-ghost btn-sm">View Live</a>
            <a href="/member-profile?org=${orgId}" class="btn btn-primary btn-sm">Edit Profile</a>
          `;
        } else if (hasSubscription) {
          buttonsHtml = `
            <button onclick="toggleProfileVisibility('${orgId}', true)" class="btn btn-primary btn-sm">Publish</button>
            <a href="/member-profile?org=${orgId}" class="btn btn-ghost btn-sm">Edit Profile</a>
          `;
        } else {
          buttonsHtml = `
            <a href="/membership#pricing" class="btn btn-primary btn-sm">Subscribe to Publish</a>
            <a href="/member-profile?org=${orgId}" class="btn btn-ghost btn-sm">Edit Profile</a>
          `;
        }
        actionButtons.innerHTML = buttonsHtml;

      } catch (error) {
        console.error('Error loading profile:', error);
        container.innerHTML = `
          <div class="card" style="padding: 40px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
            <h3 style="margin: 0 0 8px 0; color: var(--color-text-heading);">Unable to Load Profile</h3>
            <p style="margin: 0 0 20px 0; color: var(--color-text-secondary);">There was a problem loading your profile</p>
            <a href="/member-profile?org=${orgId}" class="btn btn-primary">Go to Profile</a>
          </div>
        `;
        actionBar.style.display = 'none';
      }
    }

    // Render the membership card
    function renderMembershipCard(org, hasSubscription) {
      const membershipCard = document.getElementById('membershipCard');
      const membershipIcon = document.getElementById('membershipIcon');
      const membershipTitle = document.getElementById('membershipTitle');
      const membershipDescription = document.getElementById('membershipDescription');
      const membershipBadge = document.getElementById('membershipBadge');
      const membershipActions = document.getElementById('membershipActions');
      const inlinePricingSection = document.getElementById('inlinePricingSection');
      const promoBanner = document.getElementById('promoBanner');
      const pendingInvoiceCard = document.getElementById('pendingInvoiceCard');

      // Check for pending invoices
      const pendingInvoices = org.pendingInvoices || [];
      const openInvoice = pendingInvoices.find(inv => inv.status === 'open');

      if (openInvoice) {
        // Show the pending invoice card
        pendingInvoiceCard.style.display = 'block';

        // Hide promo banner when there's a pending invoice
        promoBanner.style.display = 'none';

        // Format currency
        const formatCurrency = (amountCents, currency) => {
          return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: currency.toUpperCase()
          }).format(amountCents / 100);
        };

        const amount = formatCurrency(openInvoice.amount_due, openInvoice.currency);
        const dueDate = openInvoice.due_date ? new Date(openInvoice.due_date).toLocaleDateString() : 'N/A';
        const productName = openInvoice.product_name || 'Membership';

        document.getElementById('pendingInvoiceDescription').textContent =
          `${productName} - ${amount} due by ${dueDate}`;

        document.getElementById('pendingInvoiceActions').innerHTML = openInvoice.hosted_invoice_url
          ? `<a href="${openInvoice.hosted_invoice_url}" target="_blank" class="btn btn-primary btn-sm">Pay Invoice</a>`
          : '<span style="font-size: 13px; color: var(--color-text-muted);">Invoice link will be emailed to you</span>';

        // If there's a pending invoice and no subscription, hide pricing section
        if (!hasSubscription) {
          membershipCard.style.display = 'none';
          inlinePricingSection.style.display = 'none';
          return; // Don't show pricing options when invoice is pending
        }
      } else {
        // Hide pending invoice card if no pending invoices
        pendingInvoiceCard.style.display = 'none';
      }

      if (hasSubscription) {
        // Hide promo banner for subscribers
        promoBanner.style.display = 'none';

        // Show the membership card for subscribers (below profile card)
        membershipCard.style.display = 'block';
        inlinePricingSection.style.display = 'none';

        const productName = org.billing.product_name || 'Founding Member';
        const renewalDate = org.billing.current_period_end
          ? new Date(org.billing.current_period_end * 1000).toLocaleDateString()
          : '';
        const cancelNote = org.billing.cancel_at_period_end ? ' (cancels at period end)' : '';

        membershipIcon.innerHTML = '‚úì';
        membershipIcon.style.background = 'linear-gradient(135deg, var(--color-success-600) 0%, var(--color-success-500) 100%)';
        membershipTitle.textContent = productName;
        membershipDescription.textContent = renewalDate ? `Renews ${renewalDate}${cancelNote}` : 'Thank you for your support!';

        membershipBadge.textContent = 'Active';
        membershipBadge.style.display = 'inline-block';
        membershipBadge.style.background = 'var(--color-success-100)';
        membershipBadge.style.color = 'var(--color-success-700)';

        membershipActions.innerHTML = `
          <button onclick="openBillingPortal('${org.id}')" class="btn btn-secondary btn-sm">Manage Billing</button>
        `;

        // Show member promo banner (e.g., for upcoming events)
        renderMemberPromoBanner(org);
      } else {
        // Hide the small membership card and show inline pricing
        membershipCard.style.display = 'none';
        inlinePricingSection.style.display = 'block';

        // Show promo banner for non-subscribers
        renderJoinPromoBanner(org);

        // Check if we need org info before showing pricing
        const isPersonal = org.is_personal || org.billing?.is_personal;
        const needsOrgInfo = !isPersonal && (!org.billing?.company_type || !org.billing?.revenue_tier);

        const orgInfoCard = document.getElementById('orgInfoCard');
        const agreementSection = document.getElementById('agreementSection');
        const pricingWrapper = document.getElementById('inlinePricingWrapper');
        const agreementWarning = document.getElementById('inlineAgreementWarning');

        if (needsOrgInfo) {
          // Show org info card, hide pricing until info is provided
          orgInfoCard.style.display = 'block';
          agreementSection.style.display = 'none';
          pricingWrapper.style.display = 'none';
          agreementWarning.style.display = 'none';

          // Pre-fill if we have partial info
          if (org.billing?.company_type) {
            document.getElementById('companyTypeSelect').value = org.billing.company_type;
          }
          if (org.billing?.revenue_tier) {
            document.getElementById('revenueTierSelect').value = org.billing.revenue_tier;
          }
        } else {
          // Hide org info card, show pricing
          orgInfoCard.style.display = 'none';
          agreementSection.style.display = 'block';
          pricingWrapper.style.display = 'block';
          agreementWarning.style.display = 'block';

          // Load the membership agreement into inline section
          loadInlineMembershipAgreement();

          // Create dynamic pricing cards
          createDynamicPricingCards(org);

          // Set up the agreement checkbox handler
          setupInlineAgreementCheckbox();
        }
      }
    }

    // Render promo banner for non-members (founding member pricing)
    function renderJoinPromoBanner(org) {
      const promoBanner = document.getElementById('promoBanner');
      if (!promoBanner) return;

      // Determine pricing message based on org type
      const isPersonal = org.is_personal || org.billing?.is_personal;

      // Show the founding member pricing range:
      // - Companies: $2,500 - $10,000/year depending on revenue tier
      // - Individuals: $50 - $250/year ($50 discounted for students/academics/between jobs)
      const priceMessage = isPersonal
        ? '<span class="promo-banner-price">$50 - $250</span><span style="font-size: 14px; font-weight: normal;">/year</span>'
        : '<span class="promo-banner-price">$2,500 - $10,000</span><span style="font-size: 14px; font-weight: normal;">/year</span>';

      const subtext = isPersonal
        ? 'Standard or discounted rates available'
        : 'Based on company revenue tier';

      promoBanner.innerHTML = `
        <div class="promo-banner">
          <div class="promo-banner-content">
            <div class="promo-banner-text">
              <span class="promo-banner-badge">Founding Member Pricing</span>
              <h3>Join the Agentic Advertising Organization</h3>
              <p>Lock in founding member rates. Offer valid through March 31, 2026.</p>
            </div>
            <div class="promo-banner-action">
              <div>
                <div>${priceMessage}</div>
                <div class="promo-banner-subtext">${subtext}</div>
              </div>
              <a href="#membership" class="btn">Join Now</a>
            </div>
          </div>
        </div>
      `;
      promoBanner.style.display = 'block';
    }

    // Render promo banner for existing members (upcoming events, etc.)
    function renderMemberPromoBanner(org) {
      const promoBanner = document.getElementById('promoBanner');
      if (!promoBanner) return;

      // For now, don't show a member promo - can be enabled for events/sponsorships
      promoBanner.style.display = 'none';

      // Example member promo (uncomment when there's an event):
      // promoBanner.innerHTML = `
      //   <div class="promo-banner" style="background: linear-gradient(135deg, var(--color-success-600) 0%, var(--color-success-500) 100%);">
      //     <div class="promo-banner-content">
      //       <div class="promo-banner-text">
      //         <span class="promo-banner-badge">Member Exclusive</span>
      //         <h3>AdCP Summit 2026</h3>
      //         <p>Early bird registration now open for members. Save 50%!</p>
      //       </div>
      //       <div class="promo-banner-action">
      //         <a href="/events/summit-2026" class="btn">Register Now</a>
      //       </div>
      //     </div>
      //   </div>
      // `;
      // promoBanner.style.display = 'block';
    }

    // Save org info (company type and revenue tier)
    async function saveOrgInfo(event) {
      event.preventDefault();

      const companyType = document.getElementById('companyTypeSelect').value;
      const revenueTier = document.getElementById('revenueTierSelect').value;
      const saveBtn = document.getElementById('saveOrgInfoBtn');

      if (!companyType || !revenueTier) {
        return;
      }

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const response = await fetch(`/api/organizations/${currentOrg.id}/billing-info`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            company_type: companyType,
            revenue_tier: revenueTier
          })
        });

        if (!response.ok) {
          throw new Error('Failed to save organization info');
        }

        // Update the local org data
        if (currentOrg.billing) {
          currentOrg.billing.company_type = companyType;
          currentOrg.billing.revenue_tier = revenueTier;
        }

        // Update allOrganizations array too
        const orgIndex = allOrganizations.findIndex(o => o.id === currentOrg.id);
        if (orgIndex >= 0 && allOrganizations[orgIndex].billing) {
          allOrganizations[orgIndex].billing.company_type = companyType;
          allOrganizations[orgIndex].billing.revenue_tier = revenueTier;
        }

        // Re-render the membership card which will now show pricing
        renderMembershipCard(currentOrg, false);

        // Update the promo banner with the correct price
        renderJoinPromoBanner(currentOrg);

      } catch (error) {
        console.error('Error saving org info:', error);
        alert('Failed to save organization info. Please try again.');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Continue to Pricing';
      }
    }

    // Create dynamic pricing cards from API products (replaces Stripe pricing table)
    async function createDynamicPricingCards(org) {
      const container = document.getElementById('inlinePricingContainer');
      if (!container) return;

      // Show loading state
      container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <p style="color: var(--color-text-secondary);">Loading membership options...</p>
        </div>
      `;

      try {
        const isPersonal = org.is_personal || org.billing?.is_personal;
        const customerType = isPersonal ? 'individual' : 'company';
        const revenueTier = org.billing?.revenue_tier || '';

        const url = new URL('/api/billing-products', window.location.origin);
        url.searchParams.set('customer_type', customerType);
        url.searchParams.set('category', 'membership');
        if (revenueTier) {
          url.searchParams.set('revenue_tier', revenueTier);
        }

        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch products');

        const data = await response.json();
        const products = data.products || [];

        if (products.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; background: var(--color-bg-subtle); border-radius: 8px;">
              <p style="color: var(--color-text-secondary); margin-bottom: 16px;">No membership options available for your account type.</p>
              <p style="font-size: 14px; color: var(--color-text-muted);">Please contact <a href="mailto:membership@agenticadvertising.org">membership@agenticadvertising.org</a> for assistance.</p>
            </div>
          `;
          return;
        }

        // Render product cards
        const productCards = products.map(product => {
          const price = formatCurrency(product.amount_cents, product.currency);
          const interval = product.billing_interval === 'year' ? '/year' : product.billing_interval === 'month' ? '/month' : '';
          const isSubscription = product.billing_type === 'subscription';
          const description = product.description || '';

          return `
            <div class="product-card" style="border: 2px solid var(--color-border); border-radius: 12px; padding: 24px; text-align: center; transition: all 0.2s; cursor: pointer; background: white;"
                 onmouseover="this.style.borderColor='var(--color-brand)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.15)';"
                 onmouseout="this.style.borderColor='var(--color-border)'; this.style.boxShadow='none';">
              <h3 style="margin: 0 0 8px 0; font-size: 18px; color: var(--color-text-heading);">${escapeHtml(product.display_name || product.product_name)}</h3>
              ${description ? `<p style="margin: 0 0 16px 0; font-size: 14px; color: var(--color-text-secondary);">${escapeHtml(description)}</p>` : ''}
              <div style="margin: 16px 0;">
                <span style="font-size: 32px; font-weight: 700; color: var(--color-text-heading);">${price}</span>
                <span style="font-size: 14px; color: var(--color-text-secondary);">${interval}</span>
              </div>
              <button
                onclick="startCheckout('${product.price_id}', '${org.id}')"
                class="btn btn-primary"
                style="width: 100%; padding: 12px 24px; font-size: 16px;"
              >
                ${isSubscription ? 'Subscribe' : 'Purchase'}
              </button>
            </div>
          `;
        }).join('');

        container.innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            ${productCards}
          </div>
        `;
      } catch (error) {
        console.error('Error loading products:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; background: var(--color-error-50); border-radius: 8px;">
            <p style="color: var(--color-error-600); margin-bottom: 16px;">Unable to load membership options.</p>
            <button onclick="createDynamicPricingCards(currentOrg)" class="btn btn-secondary">Try Again</button>
          </div>
        `;
      }
    }

    // Load membership agreement into inline section
    async function loadInlineMembershipAgreement() {
      try {
        const response = await fetch('/api/agreement/current?type=membership');
        if (!response.ok) throw new Error('Failed to load agreement');
        const data = await response.json();
        const markdown = data.text || 'Agreement not available.';
        const renderedHtml = marked.parse(markdown);
        document.getElementById('inlineAgreementContent').innerHTML = DOMPurify.sanitize(renderedHtml);
      } catch (error) {
        console.error('Error loading membership agreement:', error);
        document.getElementById('inlineAgreementContent').innerHTML =
          '<p style="color: var(--color-error-500);">Unable to load membership agreement. Please try again later.</p>';
      }
    }

    // Set up agreement checkbox handler for inline pricing
    function setupInlineAgreementCheckbox() {
      const checkbox = document.getElementById('inlineAgreementCheckbox');
      const wrapper = document.getElementById('inlinePricingWrapper');
      const warning = document.getElementById('inlineAgreementWarning');

      if (!checkbox || !wrapper || !warning) return;

      checkbox.addEventListener('change', function() {
        if (this.checked) {
          wrapper.style.opacity = '1';
          wrapper.style.pointerEvents = 'auto';
          warning.style.display = 'none';
        } else {
          wrapper.style.opacity = '0.5';
          wrapper.style.pointerEvents = 'none';
          warning.style.display = 'block';
        }
      });
    }

    // Load team count for status card
    async function loadTeamCount(orgId) {
      try {
        const response = await fetch(`/api/organizations/${orgId}/members`);
        if (response.ok) {
          const members = await response.json();
          const count = members.length;
          document.getElementById('teamStatus').textContent = count.toString();
          document.getElementById('teamSubtext').textContent = count === 1 ? 'member' : 'members';
        }
      } catch (error) {
        console.error('Error loading team count:', error);
        document.getElementById('teamStatus').textContent = '--';
        document.getElementById('teamSubtext').textContent = 'Unable to load';
      }
    }

    // Update product selection UI for current org
    // Fetches available products and displays them based on customer type and revenue tier
    async function updatePricingTable(org) {
      const container = document.getElementById('pricingTableContainer');
      if (!container) return;

      // Show loading state
      container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <p style="color: var(--color-text-secondary);">Loading membership options...</p>
        </div>
      `;

      try {
        // Determine customer type based on workspace
        const customerType = org.is_personal ? 'individual' : 'company';
        const revenueTier = org.revenue_tier || '';

        // Fetch products filtered by customer type and revenue tier
        const url = new URL('/api/billing-products', window.location.origin);
        url.searchParams.set('customer_type', customerType);
        url.searchParams.set('category', 'membership');
        if (revenueTier) {
          url.searchParams.set('revenue_tier', revenueTier);
        }

        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch products');

        const data = await response.json();
        const products = data.products || [];

        if (products.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; background: var(--color-bg-subtle); border-radius: 8px;">
              <p style="color: var(--color-text-secondary); margin-bottom: 16px;">No membership options available for your account type.</p>
              <p style="font-size: 14px; color: var(--color-text-muted);">Please contact <a href="mailto:membership@agenticadvertising.org">membership@agenticadvertising.org</a> for assistance.</p>
            </div>
          `;
          return;
        }

        // Render product cards
        const productCards = products.map(product => {
          const price = formatCurrency(product.amount_cents, product.currency);
          const interval = product.billing_interval === 'year' ? '/year' : product.billing_interval === 'month' ? '/month' : '';
          const isSubscription = product.billing_type === 'subscription';

          return `
            <div class="product-card" style="border: 2px solid var(--color-border); border-radius: 12px; padding: 24px; text-align: center; transition: all 0.2s; cursor: pointer;"
                 onmouseover="this.style.borderColor='var(--aao-primary)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.15)';"
                 onmouseout="this.style.borderColor='var(--color-border)'; this.style.boxShadow='none';">
              <h3 style="margin: 0 0 8px 0; font-size: 18px; color: var(--color-text-heading);">${escapeHtml(product.display_name)}</h3>
              ${product.description ? `<p style="margin: 0 0 16px 0; font-size: 14px; color: var(--color-text-secondary);">${escapeHtml(product.description)}</p>` : ''}
              <div style="margin: 16px 0;">
                <span style="font-size: 32px; font-weight: 700; color: var(--color-text-heading);">${price}</span>
                <span style="font-size: 14px; color: var(--color-text-secondary);">${interval}</span>
              </div>
              <button
                onclick="startCheckout('${product.price_id}', '${org.id}')"
                class="btn btn-primary"
                style="width: 100%; padding: 12px 24px; font-size: 16px;"
              >
                ${isSubscription ? 'Subscribe' : 'Purchase'}
              </button>
            </div>
          `;
        }).join('');

        container.innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
            ${productCards}
          </div>
        `;
      } catch (error) {
        console.error('Error loading products:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; background: var(--color-error-50); border-radius: 8px;">
            <p style="color: var(--color-error-600); margin-bottom: 16px;">Unable to load membership options.</p>
            <button onclick="updatePricingTable(currentOrg)" class="btn btn-secondary">Try Again</button>
          </div>
        `;
      }
    }

    // Format currency for display
    function formatCurrency(amountCents, currency = 'usd') {
      const amount = amountCents / 100;
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currency.toUpperCase(),
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(amount);
    }

    // Start checkout process
    async function startCheckout(priceId, orgId) {
      try {
        // Show loading state on button
        const buttons = document.querySelectorAll('.product-card button');
        buttons.forEach(btn => {
          btn.disabled = true;
          btn.textContent = 'Processing...';
        });

        const response = await fetch('/api/checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ priceId, orgId }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to create checkout session');
        }

        const data = await response.json();

        if (data.url) {
          // Redirect to Stripe Checkout
          window.location.href = data.url;
        } else {
          throw new Error('No checkout URL returned');
        }
      } catch (error) {
        console.error('Checkout error:', error);
        alert('Unable to start checkout: ' + error.message);

        // Reset button states
        const buttons = document.querySelectorAll('.product-card button');
        buttons.forEach(btn => {
          btn.disabled = false;
          btn.textContent = 'Subscribe';
        });
      }
    }

    // Load team section content
    async function loadTeamSection(orgId) {
      const container = document.getElementById('teamCardContent');
      if (!container) return;

      try {
        const response = await fetch(`/api/organizations/${orgId}/members`);
        if (!response.ok) throw new Error('Failed to load team');

        const data = await response.json();
        const members = data.members || [];

        if (members.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 32px; margin-bottom: 12px;">üë•</div>
              <p style="margin: 0 0 16px 0; color: var(--color-text-secondary);">No team members yet</p>
              <a href="/team?org=${orgId}" class="btn btn-primary btn-sm">Invite Team Members</a>
            </div>
          `;
          return;
        }

        // Render member list
        const membersHtml = members.map((m, i) => {
          let initials = '';
          if (m.first_name && m.last_name) {
            initials = m.first_name[0] + m.last_name[0];
          } else if (m.first_name) {
            initials = m.first_name.substring(0, 2);
          } else if (m.email) {
            initials = m.email.split('@')[0].substring(0, 2);
          } else {
            initials = '?';
          }
          const colors = ['var(--color-brand)', 'var(--color-primary-500)', 'var(--color-warning-500)', 'var(--color-error-500)', 'var(--color-primary-400)'];
          const bgColor = colors[i % colors.length];
          const name = m.first_name && m.last_name ? `${m.first_name} ${m.last_name}` : m.email || 'Unknown';
          const role = m.role || 'Member';

          const email = m.email || '';

          return `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--color-border);">
              <div style="width: 40px; height: 40px; border-radius: 50%; background: ${bgColor}; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 600; flex-shrink: 0;">
                ${escapeHtml(initials.toUpperCase())}
              </div>
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 500; color: var(--color-text-heading); font-size: 14px;">${escapeHtml(name)}</div>
                <div style="color: var(--color-text-secondary); font-size: 12px;">${escapeHtml(role)}${email ? ` ¬∑ ${escapeHtml(email)}` : ''}</div>
              </div>
            </div>
          `;
        }).join('');

        // Fetch pending join request count (for admins/owners)
        let pendingCount = 0;
        try {
          const pendingResponse = await fetch(`/api/organizations/${orgId}/pending-count`);
          if (pendingResponse.ok) {
            const pendingData = await pendingResponse.json();
            pendingCount = pendingData.count || 0;
          }
        } catch (e) {
          // Ignore errors fetching pending count
        }

        // Ensure pendingCount is a safe integer to prevent XSS
        const safePendingCount = parseInt(pendingCount, 10) || 0;
        const pendingBadge = safePendingCount > 0
          ? `<span style="display: inline-flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; padding: 0 6px; background: var(--color-error-500); color: white; border-radius: 10px; font-size: 11px; font-weight: 600; margin-left: 8px;">${safePendingCount}</span>`
          : '';

        container.innerHTML = `
          <div style="margin-bottom: 16px;">
            ${membersHtml}
          </div>
          <a href="/team?org=${orgId}" class="btn btn-primary btn-sm" style="width: 100%; display: flex; align-items: center; justify-content: center;">
            Manage Team${pendingBadge}
          </a>
        `;

        // Remove border from last member item
        const lastItem = container.querySelector('div > div:last-of-type');
        if (lastItem) {
          lastItem.style.borderBottom = 'none';
        }

      } catch (error) {
        console.error('Error loading team section:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--color-text-secondary);">
            Unable to load team. <a href="/team?org=${orgId}" style="color: var(--color-brand);">Go to Team page</a>
          </div>
        `;
      }
    }

    // Load team preview with member avatars
    async function loadTeamPreview(orgId) {
      try {
        const response = await fetch(`/api/organizations/${orgId}/members`);
        if (!response.ok) throw new Error('Failed to load team');

        const data = await response.json();
        const members = data.members || [];
        const previewEl = document.getElementById('teamMembersPreview');
        if (previewEl) {
          if (members.length === 0) {
            previewEl.innerHTML = `<p style="color: var(--color-text-secondary); font-size: 13px;">No team members yet</p>`;
            return;
          }

          // Show member avatars (max 5) with overflow indicator
          const maxAvatars = 5;
          const displayMembers = members.slice(0, maxAvatars);
          const overflow = members.length - maxAvatars;

          const avatars = displayMembers.map((m, i) => {
            // Get initials from first_name/last_name or fall back to email
            let initials = '';
            if (m.first_name && m.last_name) {
              initials = m.first_name[0] + m.last_name[0];
            } else if (m.first_name) {
              initials = m.first_name.substring(0, 2);
            } else if (m.email) {
              // Use first two chars of email username
              initials = m.email.split('@')[0].substring(0, 2);
            } else {
              initials = '?';
            }
            const colors = ['var(--color-brand)', 'var(--color-primary-500)', 'var(--color-warning-500)', 'var(--color-error-500)', 'var(--color-primary-400)'];
            const bgColor = colors[i % colors.length];
            return `
              <div style="width: 32px; height: 32px; border-radius: 50%; background: ${bgColor}; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600; border: 2px solid white; margin-left: ${i === 0 ? '0' : '-8px'};" title="${escapeHtml(m.email || 'Member')}">
                ${escapeHtml(initials.toUpperCase())}
              </div>
            `;
          }).join('');

          const overflowBadge = overflow > 0
            ? `<div style="width: 32px; height: 32px; border-radius: 50%; background: var(--color-gray-200); display: flex; align-items: center; justify-content: center; color: var(--color-text-muted); font-size: 10px; font-weight: 600; border: 2px solid white; margin-left: -8px;">+${overflow}</div>`
            : '';

          const memberText = members.length === 1 ? '1 member' : `${members.length} members`;

          previewEl.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="display: flex;">${avatars}${overflowBadge}</div>
              <span style="color: var(--color-text-secondary); font-size: 12px;">${memberText}</span>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading team preview:', error);
        const previewEl = document.getElementById('teamMembersPreview');
        if (previewEl) {
          previewEl.innerHTML = `<p style="color: var(--color-gray-400); font-size: 13px;">Unable to load team</p>`;
        }
      }
    }

    // Load working groups section content
    async function loadWorkingGroupsSection() {
      const container = document.getElementById('workingGroupsCardContent');
      if (!container) return;

      try {
        const response = await fetch('/api/me/working-groups', { credentials: 'include' });

        if (!response.ok) {
          if (response.status === 401) {
            container.innerHTML = `
              <div style="text-align: center; padding: 20px;">
                <p style="color: var(--color-text-secondary); margin: 0 0 16px 0;">Log in to see your working groups.</p>
                <a href="/working-groups" class="btn btn-primary btn-sm">Browse Groups</a>
              </div>
            `;
            return;
          }
          throw new Error('Failed to load working groups');
        }

        const data = await response.json();
        const groups = data.working_groups || [];

        if (groups.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 32px; margin-bottom: 12px;">üèõÔ∏è</div>
              <p style="margin: 0 0 16px 0; color: var(--color-text-secondary);">You haven't joined any working groups yet.</p>
              <a href="/working-groups" class="btn btn-primary btn-sm">Browse Working Groups</a>
            </div>
          `;
          return;
        }

        // Render working groups list
        const groupsHtml = groups.map(g => `
          <a href="/working-groups/${escapeHtml(g.slug)}" style="display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--color-border); text-decoration: none; transition: opacity 0.15s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
            <div style="width: 40px; height: 40px; border-radius: 8px; background: ${g.is_private ? 'var(--color-warning-100)' : 'var(--color-primary-100)'}; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;">
              ${g.is_private ? 'üîí' : 'üèõÔ∏è'}
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 500; color: var(--color-text-heading); font-size: 14px;">${escapeHtml(g.name)}</div>
              <div style="color: var(--color-text-secondary); font-size: 12px;">${g.is_private ? 'Private' : 'Public'} group</div>
            </div>
          </a>
        `).join('');

        container.innerHTML = `
          <div style="margin-bottom: 16px;">
            ${groupsHtml}
          </div>
          <a href="/working-groups" class="btn btn-ghost btn-sm" style="width: 100%;">Browse All Groups</a>
        `;

        // Remove border from last group item
        const groupItems = container.querySelectorAll('a[href^="/working-groups/"]');
        if (groupItems.length > 0) {
          groupItems[groupItems.length - 1].style.borderBottom = 'none';
        }

      } catch (error) {
        console.error('Error loading working groups section:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--color-text-secondary);">
            Unable to load working groups. <a href="/working-groups" style="color: var(--color-brand);">Browse Groups</a>
          </div>
        `;
      }
    }

    // Load working groups for the current user (legacy - kept for compatibility)
    async function loadWorkingGroups() {
      const detailsEl = document.getElementById('workingGroupsDetails');

      // Update status card helpers
      function updateStatusCard(count, subtext) {
        const statusEl = document.getElementById('workingGroupStatus');
        const subtextEl = document.getElementById('workingGroupSubtext');
        if (statusEl) statusEl.textContent = count.toString();
        if (subtextEl) subtextEl.textContent = subtext;
      }

      try {
        const response = await fetch('/api/me/working-groups', { credentials: 'include' });

        if (!response.ok) {
          if (response.status === 401) {
            updateStatusCard('0', 'Log in to join');
            if (detailsEl) {
              detailsEl.innerHTML = `
                <p style="color: var(--color-text-secondary); font-size: 13px; margin-bottom: 12px;">
                  Log in to see your working groups.
                </p>
                <a href="/working-groups" class="btn btn-ghost btn-sm" style="width: 100%;">
                  Browse Groups
                </a>
              `;
            }
            return;
          }
          throw new Error('Failed to load working groups');
        }

        const data = await response.json();
        const groups = data.working_groups || [];

        // Update status card
        if (groups.length === 0) {
          updateStatusCard('0', 'Browse to join');
        } else {
          updateStatusCard(groups.length.toString(), groups.length === 1 ? 'group joined' : 'groups joined');
        }

        if (!detailsEl) return;

        if (groups.length === 0) {
          detailsEl.innerHTML = `
            <p style="color: var(--color-text-secondary); font-size: 13px; margin-bottom: 12px;">
              You haven't joined any working groups yet.
            </p>
            <a href="/working-groups" class="btn btn-primary btn-sm" style="width: 100%;">
              Browse Working Groups
            </a>
          `;
          return;
        }

        // Show the user's groups as badges/links
        const groupBadges = groups.map(g => `
          <a href="/working-groups/${escapeHtml(g.slug)}"
             style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: ${g.is_private ? 'var(--color-warning-100)' : 'var(--color-primary-100)'}; color: ${g.is_private ? 'var(--color-warning-700)' : 'var(--color-brand)'}; border-radius: var(--radius-md); font-size: 12px; font-weight: 500; text-decoration: none; transition: opacity 0.2s;"
             onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
            ${escapeHtml(g.name)}
            ${g.is_private ? '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>' : ''}
          </a>
        `).join('');

        detailsEl.innerHTML = `
          <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;">
            ${groupBadges}
          </div>
          <a href="/working-groups" class="btn btn-ghost btn-sm" style="width: 100%;">
            Browse All Groups
          </a>
        `;
      } catch (error) {
        console.error('Error loading working groups:', error);
        updateStatusCard('--', 'Unable to load');
        if (detailsEl) {
          detailsEl.innerHTML = `
            <p style="color: var(--color-text-secondary); font-size: 13px; margin-bottom: 12px;">
              Unable to load working groups.
            </p>
            <a href="/working-groups" class="btn btn-ghost btn-sm" style="width: 100%;">
              Browse Groups
            </a>
          `;
        }
      }
    }

    // Load member profile preview (full preview for prominent display)
    // Uses shared renderMemberCard function from member-card.js
    async function loadMemberProfilePreview(orgId, hasSubscription = false) {
      // Inject shared styles for member card
      injectMemberCardStyles();

      // Helper to update profile status card
      function updateProfileStatusCard(status, subtext) {
        const statusEl = document.getElementById('profileStatus');
        const subtextEl = document.getElementById('profileSubtext');
        if (statusEl) statusEl.innerHTML = status;
        if (subtextEl) subtextEl.textContent = subtext;
      }

      try {
        const response = await fetch(`/api/me/member-profile?org=${orgId}`);
        const previewEl = document.getElementById('memberProfilePreview');
        const actionsContainer = document.getElementById('memberProfileActions');

        if (!response.ok || response.status === 404) {
          // No profile - update status card
          updateProfileStatusCard('Not Set', 'Create your profile');

          if (previewEl) {
            previewEl.innerHTML = `
              <div style="text-align: center; padding: 20px 16px;">
                <div style="font-size: 32px; margin-bottom: 12px;">‚ú®</div>
                <h4 style="margin: 0 0 6px 0; color: var(--color-text-heading); font-size: 14px;">Create Your Profile</h4>
                <p style="margin: 0; color: var(--color-text-muted); font-size: 12px;">
                  Build your presence in the ecosystem
                </p>
              </div>
            `;
          }
          if (actionsContainer) {
            actionsContainer.innerHTML = `
              <a
                href="/member-profile?org=${orgId}"
                class="btn btn-primary btn-sm btn-block"
              >
                Create Profile
              </a>
            `;
          }
          return;
        }

        const data = await response.json();
        const profile = data.profile;

        // Update profile status card based on profile state
        if (profile) {
          if (profile.is_public) {
            updateProfileStatusCard('<span style="color: var(--color-success-600);">‚úì Public</span>', 'Live in directory');
          } else if (hasSubscription) {
            updateProfileStatusCard('Draft', 'Ready to publish');
          } else {
            updateProfileStatusCard('Draft', 'Subscribe to publish');
          }
        } else {
          updateProfileStatusCard('Not Set', 'Create your profile');
        }

        if (previewEl && profile) {
          // Store profile data for use in action buttons
          window.currentMemberProfile = profile;

          // Compact profile preview for sidebar card
          const logoHtml = profile.logo_url
            ? `<img src="${escapeHtml(profile.logo_url)}" alt="" style="width: 48px; height: 48px; border-radius: 8px; object-fit: cover;">`
            : `<div style="width: 48px; height: 48px; border-radius: 8px; background: var(--color-bg-subtle); display: flex; align-items: center; justify-content: center; font-size: 20px;">üè¢</div>`;

          const statusBadge = profile.is_public
            ? '<span style="display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: var(--color-success-100); color: var(--color-success-700); border-radius: 4px; font-size: 11px; font-weight: 500;">‚úì Public</span>'
            : '<span style="display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: var(--color-gray-100); color: var(--color-text-muted); border-radius: 4px; font-size: 11px; font-weight: 500;">Draft</span>';

          const tagline = profile.tagline
            ? `<p style="margin: 4px 0 0 0; color: var(--color-text-secondary); font-size: 12px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${escapeHtml(profile.tagline)}</p>`
            : '';

          previewEl.innerHTML = `
            <div style="display: flex; gap: 12px; align-items: start;">
              ${logoHtml}
              <div style="flex: 1; min-width: 0;">
                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                  <span style="font-weight: 600; font-size: 14px; color: var(--color-text-heading);">${escapeHtml(profile.name || 'Unnamed')}</span>
                  ${statusBadge}
                </div>
                ${tagline}
              </div>
            </div>
          `;

          // Compact action buttons
          if (actionsContainer) {
            let actionHtml = '';
            if (profile.is_public && profile.slug) {
              actionHtml = `
                <div style="display: flex; gap: 8px;">
                  <a href="/members/${escapeHtml(profile.slug)}" target="_blank" class="btn btn-ghost btn-sm" style="flex: 1;">View Live</a>
                  <a href="/member-profile?org=${orgId}" class="btn btn-primary btn-sm" style="flex: 1;">Edit</a>
                </div>
              `;
            } else if (hasSubscription) {
              actionHtml = `
                <div style="display: flex; gap: 8px;">
                  <button onclick="toggleProfileVisibility('${orgId}', true)" class="btn btn-primary btn-sm" style="flex: 1;">Publish</button>
                  <a href="/member-profile?org=${orgId}" class="btn btn-ghost btn-sm" style="flex: 1;">Edit</a>
                </div>
              `;
            } else {
              actionHtml = `
                <div style="display: flex; gap: 8px;">
                  <a href="/membership#pricing" class="btn btn-primary btn-sm" style="flex: 1;">üîí Publish</a>
                  <a href="/member-profile?org=${orgId}" class="btn btn-ghost btn-sm" style="flex: 1;">Edit</a>
                </div>
              `;
            }
            actionsContainer.innerHTML = actionHtml;
          }
        } else if (previewEl) {
          // No profile exists - show compact "Create Your Profile" UI
          previewEl.innerHTML = `
            <div style="text-align: center; padding: 16px;">
              <div style="font-size: 32px; margin-bottom: 8px;">‚ú®</div>
              <h4 style="margin: 0 0 4px 0; color: var(--color-text-heading); font-size: 14px;">Create Your Profile</h4>
              <p style="margin: 0; color: var(--color-text-muted); font-size: 12px;">Build your presence in the ecosystem</p>
            </div>
          `;
          if (actionsContainer) {
            actionsContainer.innerHTML = `
              <a
                href="/member-profile?org=${orgId}"
                style="display: block; text-align: center; padding: 12px 24px; background: var(--color-brand); color: white; border-radius: 6px; text-decoration: none; font-size: 14px; font-weight: 500;"
              >
                Create Profile
              </a>
            `;
          }
        }
      } catch (error) {
        console.error('loadMemberProfilePreview: Error caught:', error);
        const previewEl = document.getElementById('memberProfilePreview');
        const actionsContainer = document.getElementById('memberProfileActions');
        if (previewEl) {
          previewEl.innerHTML = `
            <div style="text-align: center; padding: 30px 20px;">
              <div style="font-size: 48px; margin-bottom: 16px;">‚ú®</div>
              <h3 style="margin: 0 0 8px 0; color: var(--color-text-heading);">Create Your Profile</h3>
              <p style="margin: 0; color: var(--color-text-muted); font-size: 14px;">Set up your member profile. It will be published when you subscribe as a member.</p>
            </div>
          `;
        }
        if (actionsContainer) {
          actionsContainer.innerHTML = `
            <a
              href="/member-profile?org=${orgId}"
              style="display: block; text-align: center; padding: 12px 24px; background: var(--color-brand); color: white; border-radius: 6px; text-decoration: none; font-size: 14px; font-weight: 500;"
            >
              Create Profile
            </a>
          `;
        }
      }
    }

    // offeringLabels is now in member-card.js
    function formatOffering(offering) {
      return offeringLabels[offering] || offering;
    }

    // Scroll to membership section
    function scrollToMembership() {
      const membershipSection = document.getElementById('membershipSection');
      if (membershipSection) {
        membershipSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // Toggle profile visibility (make public or unpublish)
    async function toggleProfileVisibility(orgId, makePublic) {
      try {
        const response = await fetch(`/api/me/member-profile/visibility?org=${orgId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            is_public: makePublic,
            show_in_carousel: makePublic
          }),
          credentials: 'include'
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'Failed to update visibility');
        }

        // Reload the profile preview to show updated state
        const org = allOrganizations.find(o => o.id === orgId);
        const hasSubscription = org?.billing?.status === 'active';
        loadMemberProfilePreview(orgId, hasSubscription);
      } catch (error) {
        console.error('Error toggling visibility:', error);
        alert('Failed to update visibility: ' + error.message);
      }
    }

    // Load membership agreement
    async function loadMembershipAgreement() {
      try {
        const response = await fetch('/api/agreement/current?type=membership');
        if (!response.ok) throw new Error('Failed to load agreement');

        membershipAgreement = await response.json();

        // Render markdown to HTML using marked library
        const renderedHtml = marked.parse(membershipAgreement.text);
        document.getElementById('membershipAgreementContent').innerHTML = DOMPurify.sanitize(renderedHtml);
      } catch (error) {
        console.error('Error loading membership agreement:', error);
        document.getElementById('membershipAgreementContent').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load agreement. Please refresh.</p>';
      }
    }

    // Handle agreement checkbox change
    // Note: Agreement acceptance is recorded in Stripe webhook when subscription succeeds
    // This just enables/disables the pricing table UI
    function setupAgreementCheckbox() {
      const checkbox = document.getElementById('membershipAgreementCheckbox');
      const pricingWrapper = document.getElementById('pricingTableWrapper');
      const warning = document.getElementById('agreementWarning');

      if (!checkbox) return;

      checkbox.addEventListener('change', async (e) => {
        if (e.target.checked) {
          // Enable pricing table (agreement acceptance will be recorded on payment success)
          pricingWrapper.style.opacity = '1';
          pricingWrapper.style.pointerEvents = 'auto';
          warning.style.display = 'none';

          // Store agreement version in organization record for webhook to use
          // This is temporary storage - actual acceptance recorded on payment success
          if (membershipAgreement && currentOrg) {
            try {
              await fetch(`/api/organizations/${currentOrg.id}/pending-agreement`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                  agreement_version: membershipAgreement.version,
                  agreement_accepted_at: new Date().toISOString(),
                })
              });
            } catch (error) {
              console.error('Failed to store pending agreement:', error);
              // Continue anyway - webhook will use current version
            }
          }

          console.log('Agreement checkbox checked - pricing table enabled');
        } else {
          // Disable pricing table
          pricingWrapper.style.opacity = '0.5';
          pricingWrapper.style.pointerEvents = 'none';
          warning.style.display = 'block';
        }
      });
    }

    async function openBillingPortal(orgId) {
      try {
        const response = await fetch(`/api/organizations/${orgId}/billing/portal`, {
          method: 'POST',
          credentials: 'same-origin',
        });

        if (!response.ok) {
          throw new Error('Failed to open billing portal');
        }

        const data = await response.json();
        if (data.portal_url) {
          window.location.href = data.portal_url;
        }
      } catch (error) {
        console.error('Error opening billing portal:', error);
        alert('Failed to open billing portal. Please try again.');
      }
    }

    async function convertToTeam(orgId) {
      if (!confirm('Convert this personal workspace to a team workspace?\n\nThis will allow you to invite team members. This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`/api/organizations/${orgId}/convert-to-team`, {
          method: 'POST',
          credentials: 'same-origin',
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'Failed to convert workspace');
        }

        alert('Workspace converted to team! You can now invite team members.');
        window.location.reload();
      } catch (error) {
        console.error('Error converting to team:', error);
        alert('Failed to convert workspace: ' + error.message);
      }
    }

    async function loadUserData() {
      try {
        const response = await fetch(apiUrl('/api/me'));
        if (!response.ok) {
          if (response.status === 401) {
            const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);
            window.location.href = `/auth/login?return_to=${returnUrl}`;
            return;
          }
          throw new Error('Failed to load user data');
        }

        const data = await response.json();

        // Initialize sidebar navigation
        const isAdmin = data.user?.isAdmin || false;
        const hasMultipleOrgs = data.organizations && data.organizations.length > 1;

        if (data.organizations && data.organizations.length > 0) {
          // Load billing info for each organization
          const orgsWithBilling = await Promise.all(
            data.organizations.map(async (org) => {
              try {
                const billingResponse = await fetch(apiUrl(`/api/organizations/${org.id}/billing`));
                if (billingResponse.ok) {
                  const billingData = await billingResponse.json();
                  return {
                    ...org,
                    billing: {
                      ...billingData.subscription,
                      company_type: billingData.company_type,
                      revenue_tier: billingData.revenue_tier,
                      is_personal: billingData.is_personal,
                    },
                    stripeCustomerId: billingData.stripe_customer_id,
                    customerSessionSecret: billingData.customer_session_secret,
                    pendingInvoices: billingData.pending_invoices || [],
                    billingError: null
                  };
                } else {
                  const errorData = await billingResponse.json().catch(() => ({ message: 'Unknown error' }));
                  return {
                    ...org,
                    billing: null,
                    billingError: errorData.message || 'Failed to load billing information'
                  };
                }
              } catch (error) {
                console.error('Error loading billing for org:', org.id, error);
                return {
                  ...org,
                  billing: null,
                  billingError: 'Network error - unable to load billing information'
                };
              }
            })
          );

          // Store organizations globally
          allOrganizations = orgsWithBilling;

          // Check if any org has active subscription (for global flag)
          const hasActiveSubscription = orgsWithBilling.some(org => org.billing?.status === 'active');
          window.hasActiveSubscription = hasActiveSubscription;

          // Determine which org to show
          const initialOrgId = getInitialOrgId();
          if (initialOrgId && orgsWithBilling.some(o => o.id === initialOrgId)) {
            selectedOrgId = initialOrgId;
          } else {
            // Default to first org
            selectedOrgId = orgsWithBilling[0].id;
          }

          // Update URL with selected org if not already there
          const url = new URL(window.location);
          if (!url.searchParams.get('org')) {
            url.searchParams.set('org', selectedOrgId);
            window.history.replaceState({}, '', url);
          }

          // Initialize sidebar with org switcher
          const selectedOrg = orgsWithBilling.find(o => o.id === selectedOrgId) || orgsWithBilling[0];
          DashboardNav.init({
            showOrgSwitcher: hasMultipleOrgs,
            currentOrgName: selectedOrg?.name || 'Organization',
            isPersonal: selectedOrg?.billing?.is_personal || false,
            isSubscribed: selectedOrg?.billing?.status === 'active',
            showAdmin: isAdmin
          });

          // Set up org switcher in sidebar if multiple orgs
          if (hasMultipleOrgs) {
            DashboardNav.setOrgOptions(orgsWithBilling, selectedOrgId, (newOrgId) => {
              selectOrg(newOrgId);
            });
          }

          // Render the selected organization
          renderSelectedOrg();

          // Load membership agreement if needed for any org
          await loadMembershipAgreement();
          setupAgreementCheckbox();

          // Check if membership agreement already accepted - if so, enable pricing table
          await checkMembershipAgreementStatus();

          // Check for outdated agreements (only for subscribers)
          await checkOutdatedAgreements();

        } else {
          // No organizations - redirect to onboarding
          window.location.href = '/onboarding';
          return;
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

      } catch (error) {
        console.error('Error loading user data:', error);
        document.getElementById('loading').innerHTML = `
          <p style="color: var(--color-error-600);">Failed to load dashboard. <a href="/auth/login">Try logging in again</a></p>
        `;
      }
    }

    // Check if user has accepted membership agreement
    async function hasAcceptedMembershipAgreement() {
      try {
        const response = await fetch('/api/me/agreements');
        if (!response.ok) return false;

        const data = await response.json();
        // Check if membership agreement has a signed version (not just exists in the list)
        const membership = data.agreements.find(a => a.type === 'membership');
        return membership && membership.version; // version exists = signed
      } catch (error) {
        console.error('Error checking membership agreement:', error);
        return false;
      }
    }

    // Check membership agreement status and update UI accordingly
    async function checkMembershipAgreementStatus() {
      const hasAccepted = await hasAcceptedMembershipAgreement();

      if (hasAccepted) {
        // User has already accepted - hide the inline agreement section and enable pricing
        const checkbox = document.getElementById('membershipAgreementCheckbox');
        const pricingWrapper = document.getElementById('pricingTableWrapper');
        const warning = document.getElementById('agreementWarning');

        if (checkbox) {
          checkbox.checked = true;
        }
        if (pricingWrapper) {
          pricingWrapper.style.opacity = '1';
          pricingWrapper.style.pointerEvents = 'auto';
        }
        if (warning) {
          warning.style.display = 'none';
        }

        // Hide the agreement acceptance section since it's already done
        const agreementBox = document.querySelector('#membershipSection > div:nth-child(2)');
        if (agreementBox && agreementBox.querySelector('#membershipAgreementCheckbox')) {
          agreementBox.style.display = 'none';
        }
      }
    }

    // Format agreement type for display
    function formatAgreementType(type) {
      const types = {
        'terms_of_service': 'Terms of Service',
        'privacy_policy': 'Privacy Policy',
        'membership': 'Membership Agreement'
      };
      return types[type] || type;
    }

    // Copy agreement link to clipboard for sharing
    async function copyAgreementLink(type) {
      // Use production URL for shareable links
      const baseUrl = window.location.hostname === 'localhost'
        ? window.location.origin
        : 'https://agenticadvertising.org';
      const url = `${baseUrl}/api/agreement?type=${type}`;

      try {
        await navigator.clipboard.writeText(url);

        // Show brief success feedback
        const btn = event.target.closest('button');
        const originalColor = btn.style.color;
        btn.style.color = 'var(--color-success-500)';
        btn.title = 'Link copied!';

        setTimeout(() => {
          btn.style.color = originalColor;
          btn.title = 'Copy link to share';
        }, 2000);
      } catch (error) {
        console.error('Failed to copy link:', error);
        // Fallback: show alert with the URL
        alert(`Agreement link:\n${url}`);
      }
    }

    // Dismiss outdated agreement modal
    function dismissAgreementModal() {
      document.getElementById('outdatedAgreementModal').style.display = 'none';
    }

    // Acknowledge TOS/Privacy updates (no re-acceptance required, just dismiss)
    async function acknowledgeAgreementUpdates() {
      // Record acknowledgment in session so we don't show again this session
      sessionStorage.setItem('acknowledgedAgreementUpdates', 'true');
      dismissAgreementModal();
    }

    // View outdated agreements (only for membership that requires acceptance)
    async function viewOutdatedAgreements() {
      dismissAgreementModal();

      // Get membership agreement that needs acceptance
      try {
        const response = await fetch('/api/me/agreements');
        if (!response.ok) return;

        const data = await response.json();
        const membershipAgreement = data.agreements.find(a =>
          a.type === 'membership' && a.is_outdated && !a.version
        );

        if (membershipAgreement) {
          await viewAgreementForAcceptance('membership', membershipAgreement.current_version);
        }
      } catch (error) {
        console.error('Error loading membership agreement:', error);
      }
    }

    // View specific agreement version (read-only mode)
    async function viewAgreement(type, version) {
      try {
        document.getElementById('agreementViewerModal').style.display = 'flex';
        document.getElementById('agreementViewerContent').innerHTML = 'Loading...';

        // Reset buttons to Close-only for read-only view
        document.getElementById('agreementViewerButtons').innerHTML = `
          <button class="btn btn-primary" onclick="closeAgreementViewer()">Close</button>
        `;

        const response = await fetch(`/api/agreement?type=${type}&version=${version}&format=json`, {
          credentials: 'same-origin'
        });
        if (!response.ok) {
          throw new Error('Failed to load agreement');
        }

        const agreement = await response.json();

        // Update modal content
        document.getElementById('agreementViewerTitle').textContent = formatAgreementType(type);
        document.getElementById('agreementViewerMeta').textContent =
          `Version ${agreement.version} ‚Ä¢ Effective: ${new Date(agreement.effective_date).toLocaleDateString()}`;

        // Render markdown to HTML using marked library
        const renderedHtml = marked.parse(agreement.text);
        document.getElementById('agreementViewerContent').innerHTML = DOMPurify.sanitize(renderedHtml);
      } catch (error) {
        console.error('Error loading agreement:', error);
        document.getElementById('agreementViewerContent').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load agreement. Please try again.</p>';
      }
    }

    // Close agreement viewer modal
    function closeAgreementViewer() {
      document.getElementById('agreementViewerModal').style.display = 'none';
    }

    // Open rename organization modal
    function openRenameModal() {
      if (!currentOrg) return;
      document.getElementById('newOrgName').value = currentOrg.name;
      document.getElementById('renameError').style.display = 'none';
      document.getElementById('renameOrgModal').style.display = 'flex';
      document.getElementById('newOrgName').focus();
    }

    // Close rename organization modal
    function closeRenameModal() {
      document.getElementById('renameOrgModal').style.display = 'none';
      document.getElementById('renameError').style.display = 'none';
    }

    // Confirm rename organization
    async function confirmRenameOrg() {
      if (!currentOrg) return;

      const newName = document.getElementById('newOrgName').value.trim();
      const errorEl = document.getElementById('renameError');
      const confirmBtn = document.getElementById('confirmRenameBtn');

      // Validate
      if (!newName) {
        errorEl.textContent = 'Organization name is required';
        errorEl.style.display = 'block';
        return;
      }

      if (newName === currentOrg.name) {
        closeRenameModal();
        return;
      }

      // Disable button during request
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Renaming...';

      try {
        const response = await fetch(`/api/organizations/${currentOrg.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: newName }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to rename organization');
        }

        // Update the UI
        currentOrg.name = data.organization.name;
        document.getElementById('orgName').textContent = data.organization.name;

        closeRenameModal();
      } catch (error) {
        errorEl.textContent = error.message;
        errorEl.style.display = 'block';
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Rename';
      }
    }

    // Handle Enter key in rename input
    document.addEventListener('DOMContentLoaded', () => {
      const renameInput = document.getElementById('newOrgName');
      if (renameInput) {
        renameInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            confirmRenameOrg();
          }
        });
      }
    });

    // Dismiss required agreement for this session (will show again on next visit)
    // Use sessionStorage to prevent re-popup during current session
    function dismissAgreementForNow() {
      sessionStorage.setItem('dismissedAgreementModal', 'true');
      closeAgreementViewer();
    }

    // Check if we should auto-show agreement modals
    function shouldShowAgreementModal() {
      return !sessionStorage.getItem('dismissedAgreementModal');
    }

    // View agreement for acceptance (with Accept button)
    async function viewAgreementForAcceptance(type, version) {
      try {
        document.getElementById('agreementViewerModal').style.display = 'flex';
        document.getElementById('agreementViewerContent').innerHTML = 'Loading...';

        const response = await fetch(`/api/agreement?type=${type}&version=${version}&format=json`, {
          credentials: 'same-origin'
        });
        if (!response.ok) {
          throw new Error('Failed to load agreement');
        }

        const agreement = await response.json();

        // Update modal content
        document.getElementById('agreementViewerTitle').textContent = formatAgreementType(type);
        document.getElementById('agreementViewerMeta').textContent =
          `Version ${agreement.version} ‚Ä¢ Effective ${new Date(agreement.effective_date).toLocaleDateString()}`;

        // Render markdown to HTML using marked library
        const renderedHtml = marked.parse(agreement.text);
        document.getElementById('agreementViewerContent').innerHTML = DOMPurify.sanitize(renderedHtml);

        // Update buttons based on agreement type
        const buttonsDiv = document.getElementById('agreementViewerButtons');

        if (type === 'membership') {
          // Membership requires formal acceptance with checkbox
          buttonsDiv.innerHTML = `
            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
              <input type="checkbox" id="agreeCheckbox" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">I have read and agree to this ${formatAgreementType(type).toLowerCase()}</span>
            </label>
            <div style="display: flex; gap: 10px; width: 100%;">
              <button class="btn btn-secondary" onclick="dismissAgreementForNow()">Later</button>
              <button class="btn btn-primary" id="acceptButton" onclick="acceptAgreement('${type}', '${version}')" disabled style="opacity: 0.5;">Accept Agreement</button>
            </div>
            <p style="font-size: 11px; color: var(--color-gray-400); margin-top: 10px; text-align: center;">This agreement is required. You'll be reminded to accept it next time.</p>
          `;

          // Enable accept button when checkbox is checked
          document.getElementById('agreeCheckbox').addEventListener('change', (e) => {
            const acceptBtn = document.getElementById('acceptButton');
            if (e.target.checked) {
              acceptBtn.disabled = false;
              acceptBtn.style.opacity = '1';
            } else {
              acceptBtn.disabled = true;
              acceptBtn.style.opacity = '0.5';
            }
          });
        } else {
          // Terms of Service & Privacy Policy - just acknowledgment
          buttonsDiv.innerHTML = `
            <div style="display: flex; gap: 10px; width: 100%; justify-content: flex-end;">
              <button class="btn btn-primary" onclick="acceptAgreement('${type}', '${version}')">I Understand</button>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading agreement:', error);
        document.getElementById('agreementViewerContent').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load agreement. Please try again.</p>';
      }
    }

    // Accept an agreement
    async function acceptAgreement(type, version) {
      try {
        const response = await fetch('/api/me/agreements/accept', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ agreement_type: type, version })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to accept agreement');
        }

        // Close modal
        closeAgreementViewer();

        // If membership agreement was accepted, auto-enable the pricing table
        if (type === 'membership') {
          const checkbox = document.getElementById('membershipAgreementCheckbox');
          const pricingWrapper = document.getElementById('pricingTableWrapper');
          const warning = document.getElementById('agreementWarning');
          const agreementSection = document.querySelector('#membershipSection .agreements');

          if (checkbox) {
            checkbox.checked = true;
          }
          if (pricingWrapper) {
            pricingWrapper.style.opacity = '1';
            pricingWrapper.style.pointerEvents = 'auto';
          }
          if (warning) {
            warning.style.display = 'none';
          }
          // Hide the agreement acceptance section since it's already done
          const agreementBox = document.querySelector('#membershipSection > div:nth-child(2)');
          if (agreementBox && agreementBox.querySelector('#membershipAgreementCheckbox')) {
            agreementBox.style.display = 'none';
          }
        }

      } catch (error) {
        console.error('Error accepting agreement:', error);
        alert('Failed to accept agreement: ' + error.message);
      }
    }

    // Check for outdated agreements and show modal if needed
    // Only for subscribers - non-subscribers handle agreements inline when subscribing
    async function checkOutdatedAgreements() {
      // Skip for non-subscribers of the CURRENT org
      if (!currentOrgHasActiveSubscription()) return;

      try {
        const response = await fetch('/api/me/agreements');
        if (!response.ok) return;

        const data = await response.json();

        if (data.needs_reacceptance) {
          // Separate membership (requires acceptance) from TOS/Privacy (info only)
          const outdatedAgreements = data.agreements.filter(a => a.is_outdated);
          const membershipNeedsAcceptance = outdatedAgreements.find(a =>
            a.type === 'membership' && !a.version
          );

          // If only TOS/Privacy updated and already acknowledged this session, skip
          if (!membershipNeedsAcceptance && sessionStorage.getItem('acknowledgedAgreementUpdates')) {
            return;
          }

          // Build the list display
          const outdatedList = outdatedAgreements
            .map(a => {
              const isMembershipRequiringAcceptance = a.type === 'membership' && !a.version;
              return `
                <div style="padding: 10px; background: ${isMembershipRequiringAcceptance ? 'var(--color-error-50)' : 'var(--color-warning-50)'}; border-left: 3px solid ${isMembershipRequiringAcceptance ? 'var(--color-error-500)' : 'var(--color-warning-500)'}; border-radius: 4px; margin: 8px 0;">
                  <strong>${formatAgreementType(a.type)}</strong>
                  ${isMembershipRequiringAcceptance ? '<span style="color: var(--color-error-500); font-size: 11px; margin-left: 8px;">Acceptance Required</span>' : ''}
                  <br>
                  <small style="color: var(--color-text-secondary);">
                    ${a.version ? `Your version: ${a.version}` : 'Not yet accepted'} ‚Üí
                    Current version: ${a.current_version}
                  </small>
                  ${!isMembershipRequiringAcceptance ? `<br><a href="javascript:void(0)" onclick="dismissAgreementModal(); viewAgreement('${a.type}', '${a.current_version}')" style="color: var(--color-brand); font-size: 12px;">View changes</a>` : ''}
                </div>
              `;
            })
            .join('');

          if (!outdatedList) return;

          // Update modal content and buttons based on what needs attention
          document.getElementById('outdatedAgreementsList').innerHTML = outdatedList;

          const buttonsDiv = document.getElementById('outdatedAgreementButtons');
          if (membershipNeedsAcceptance) {
            // Membership needs acceptance - show Review button
            document.getElementById('outdatedAgreementModalMessage').textContent =
              'Your membership agreement requires acceptance to continue.';
            buttonsDiv.innerHTML = `
              <button class="btn btn-secondary" onclick="dismissAgreementModal()">Remind Me Later</button>
              <button class="btn btn-primary" onclick="viewOutdatedAgreements()">Review & Accept</button>
            `;
          } else {
            // Only TOS/Privacy updated - just informational
            document.getElementById('outdatedAgreementModalMessage').textContent =
              'The following agreements have been updated. Your continued use constitutes acceptance of the updated terms.';
            buttonsDiv.innerHTML = `
              <button class="btn btn-primary" onclick="acknowledgeAgreementUpdates()">Got It</button>
            `;
          }

          document.getElementById('outdatedAgreementModal').style.display = 'flex';
        }
      } catch (error) {
        console.error('Error checking outdated agreements:', error);
      }
    }

    // Load agreement history
    async function loadAgreementHistory() {
      try {
        const response = await fetch('/api/me/agreements');
        if (!response.ok) throw new Error('Failed to load agreement history');

        const data = await response.json();
        const historyDiv = document.getElementById('agreementHistory');

        if (data.agreements && data.agreements.length > 0) {
          // Build table with outdated status and clickable links
          historyDiv.innerHTML = `
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="border-bottom: 2px solid var(--color-border);">
                  <th style="text-align: left; padding: 10px; color: var(--color-text-secondary); font-weight: 600;">Agreement</th>
                  <th style="text-align: left; padding: 10px; color: var(--color-text-secondary); font-weight: 600;">Version</th>
                  <th style="text-align: left; padding: 10px; color: var(--color-text-secondary); font-weight: 600;">Accepted</th>
                  <th style="text-align: left; padding: 10px; color: var(--color-text-secondary); font-weight: 600;">Status</th>
                </tr>
              </thead>
              <tbody>
                ${data.agreements.map(acceptance => `
                  <tr style="border-bottom: 1px solid var(--color-gray-100);">
                    <td style="padding: 10px;">${formatAgreementType(acceptance.type)}</td>
                    <td style="padding: 10px;">
                      ${acceptance.version
                        ? `<a href="javascript:void(0)" onclick="viewAgreement('${acceptance.type}', '${acceptance.version}')" style="color: var(--color-brand); text-decoration: underline; cursor: pointer;">${acceptance.version}</a>`
                        : 'Not accepted'}
                      ${acceptance.is_outdated && acceptance.current_version
                        ? `<br><small style="color: var(--color-warning-500);">‚Üí <a href="javascript:void(0)" onclick="viewAgreement('${acceptance.type}', '${acceptance.current_version}')" style="color: var(--color-warning-500); text-decoration: underline; cursor: pointer;">${acceptance.current_version} available</a></small>`
                        : ''}
                    </td>
                    <td style="padding: 10px;">${acceptance.accepted_at ? new Date(acceptance.accepted_at).toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    }) : 'Not accepted'}</td>
                    <td style="padding: 10px;">
                      ${acceptance.is_outdated
                        ? '<span style="color: var(--color-warning-500); font-weight: bold;">‚ö† Update Required</span>'
                        : '<span style="color: var(--color-success-600);">‚úì Current</span>'}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          historyDiv.innerHTML = '<p style="color: var(--color-text-secondary);">No agreement acceptances recorded.</p>';
        }
      } catch (error) {
        console.error('Error loading agreement history:', error);
        document.getElementById('agreementHistory').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load agreement history.</p>';
      }
    }

    loadUserData();

    // Handle browser back/forward cache (bfcache) restoration
    // When user hits back from Stripe, reinitialize the pricing table
    window.addEventListener('pageshow', (event) => {
      if (event.persisted && currentOrg) {
        // Page was restored from bfcache
        console.log('Page restored from cache, reloading pricing table');

        // Recreate pricing table with current org's customer session
        updatePricingTable(currentOrg);
      }
    });

    // Toast notification helper
    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    // Check for success messages from redirects
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      if (params.get('profile_created') === 'true') {
        showToast('Member profile created successfully!');
        // Clean up the URL without triggering a reload
        const newUrl = new URL(window.location);
        newUrl.searchParams.delete('profile_created');
        window.history.replaceState({}, '', newUrl);
      }
    });
  </script>
</body>
</html>
