<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Admin - Account Management - AdCP Registry</title>
  <link rel="stylesheet" href="/design-system.css">
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <style>
    /* =============================================================================
       Admin Prospects styles
       Uses design system variables - see /design-system.css for tokens
       ============================================================================= */

    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-wide);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }
    h1 { margin-bottom: var(--space-2.5); color: var(--color-text-heading); }
    .subtitle { color: var(--color-text-secondary); margin-bottom: var(--space-5); }

    /* View Tabs */
    .view-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      margin-bottom: var(--space-5);
      padding-bottom: var(--space-4);
      border-bottom: var(--border-1) solid var(--color-gray-200);
    }
    .view-tab {
      padding: var(--space-2) var(--space-4);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      background: var(--color-bg-card);
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .view-tab:hover {
      background: var(--color-gray-50);
      border-color: var(--color-gray-300);
    }
    .view-tab.active {
      background: var(--color-brand);
      color: white;
      border-color: var(--color-brand);
    }
    .view-tab .badge {
      background: var(--color-gray-200);
      color: var(--color-text-heading);
      padding: var(--space-0.5) var(--space-1.5);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
    }
    .view-tab.active .badge {
      background: var(--color-primary-200);
      color: var(--color-primary-900);
    }

    /* Section Headers */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }
    .section-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
    }
    .section-description {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-1);
    }

    /* Filters - simplified */
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
      padding: var(--space-3);
      background: var(--color-gray-50);
      border-radius: var(--radius-md);
    }
    .filter-group {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .filter-group label {
      font-weight: var(--font-medium);
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }
    .filter-group select,
    .filter-group input {
      padding: var(--space-1.5) var(--space-2.5);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      min-width: 120px;
    }
    .filter-group input[type="text"] {
      min-width: 180px;
    }

    /* Actions */
    .actions {
      display: flex;
      gap: var(--space-2.5);
    }
    .btn {
      padding: var(--space-2) var(--space-4);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .btn-primary {
      background: var(--color-brand);
      color: white;
    }
    .btn-primary:hover {
      background: var(--color-primary-700);
    }
    .btn-secondary {
      background: var(--color-gray-200);
      color: var(--color-text-heading);
    }
    .btn-secondary:hover {
      background: var(--color-gray-300);
    }
    .btn-sm {
      padding: var(--space-1.5) var(--space-3);
      font-size: var(--text-xs);
    }

    /* Table */
    .prospects-table {
      width: 100%;
      border-collapse: collapse;
    }
    .prospects-table th {
      background: var(--color-gray-50);
      padding: var(--space-3);
      text-align: left;
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      border-bottom: var(--border-2) solid var(--color-gray-200);
      font-size: var(--text-sm);
    }
    .prospects-table td {
      padding: var(--space-3);
      border-bottom: var(--border-1) solid var(--color-gray-200);
      font-size: var(--text-sm);
    }
    .prospects-table tr:hover {
      background: var(--color-gray-50);
    }

    /* Engagement fires */
    .engagement-fires {
      font-size: var(--text-sm);
      letter-spacing: 1px;
      cursor: help;
    }

    /* Company link */
    .company-link {
      color: var(--color-text-heading);
      text-decoration: none;
      font-weight: var(--font-medium);
    }
    .company-link:hover {
      color: var(--color-brand);
      text-decoration: underline;
    }

    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: var(--space-0.5) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .status-member { background: var(--color-success-100); color: var(--color-success-700); }
    .status-prospect { background: var(--color-warning-100); color: var(--color-warning-700); }
    .status-cold { background: var(--color-gray-200); color: var(--color-text-secondary); }

    /* Priority indicators */
    .priority-high {
      color: var(--color-error-600);
      font-weight: var(--font-semibold);
    }
    .priority-medium {
      color: var(--color-warning-600);
    }
    .priority-low {
      color: var(--color-text-muted);
    }

    /* Stakeholder badges */
    .stakeholder-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-0.5) var(--space-1.5);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      background: var(--color-primary-50);
      color: var(--color-primary-700);
    }
    .stakeholder-badge.owner {
      background: var(--color-success-50);
      color: var(--color-success-700);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: var(--space-12);
      color: var(--color-text-secondary);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: var(--space-12);
      color: var(--color-text-secondary);
    }
    .empty-state h3 {
      color: var(--color-text-heading);
      margin-bottom: var(--space-2);
    }

    /* Buttons */
    .btn-icon {
      padding: var(--space-1.5) var(--space-3);
      border: var(--border-1) solid var(--color-gray-200);
      background: var(--color-bg-card);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .btn-icon:hover {
      background: var(--color-gray-50);
      border-color: var(--color-brand);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: var(--color-surface-overlay);
    }
    .modal-content {
      background-color: var(--color-bg-card);
      margin: var(--space-8) auto;
      padding: var(--space-8);
      border-radius: var(--radius-md);
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-5);
      padding-bottom: var(--space-4);
      border-bottom: var(--border-2) solid var(--color-gray-200);
    }
    .modal-close {
      font-size: var(--text-3xl);
      font-weight: var(--font-bold);
      color: var(--color-text-secondary);
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      line-height: 1;
    }
    .modal-close:hover {
      color: var(--color-text-heading);
    }

    /* Form */
    .form-group {
      margin-bottom: var(--space-4);
    }
    .form-group label {
      display: block;
      margin-bottom: var(--space-1);
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      color: var(--color-text-heading);
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: var(--space-2.5);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
    }
    .form-hint {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }
    .modal-actions {
      display: flex;
      gap: var(--space-2.5);
      justify-content: flex-end;
      margin-top: var(--space-6);
      padding-top: var(--space-4);
      border-top: var(--border-1) solid var(--color-gray-200);
    }

    /* Bulk import */
    .bulk-textarea {
      width: 100%;
      min-height: 200px;
      font-family: monospace;
      font-size: var(--text-sm);
      padding: var(--space-3);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
    }
    .import-results {
      margin-top: var(--space-4);
      padding: var(--space-4);
      background: var(--color-gray-50);
      border-radius: var(--radius-md);
      max-height: 300px;
      overflow-y: auto;
    }
    .import-success { color: var(--color-success-600); }
    .import-error { color: var(--color-error-600); }

    /* Date badges */
    .date-overdue {
      color: var(--color-error-600);
      font-weight: var(--font-semibold);
    }
    .date-soon {
      color: var(--color-warning-600);
      font-weight: var(--font-medium);
    }
  </style>
</head>
<body>
  <!-- AAO top navigation -->
  <div id="adcp-nav"></div>

  <div id="loading" class="loading">
    Loading accounts...
  </div>

  <div id="content" style="display: none;">
    <div class="container">
      <div class="card">
        <div class="section-header">
          <div>
            <h1>Account Management</h1>
            <p class="subtitle">Track and manage organization relationships</p>
          </div>
          <div class="actions">
            <button class="btn btn-secondary btn-sm" onclick="openBulkImportModal()">Bulk Import</button>
            <button class="btn btn-primary btn-sm" onclick="openAddProspectModal()">+ Add Prospect</button>
          </div>
        </div>

        <!-- View Tabs -->
        <div class="view-tabs">
          <button class="view-tab" data-view="needs_followup" onclick="switchView('needs_followup')">
            Needs Follow-up
            <span class="badge" id="count-needs_followup">0</span>
          </button>
          <button class="view-tab" data-view="new_signups" onclick="switchView('new_signups')">
            New Signups
            <span class="badge" id="count-new_signups">0</span>
          </button>
          <button class="view-tab" data-view="hot_prospects" onclick="switchView('hot_prospects')">
            Hot Prospects
            <span class="badge" id="count-hot_prospects">0</span>
          </button>
          <button class="view-tab" data-view="going_cold" onclick="switchView('going_cold')">
            Going Cold
            <span class="badge" id="count-going_cold">0</span>
          </button>
          <button class="view-tab" data-view="renewals" onclick="switchView('renewals')">
            Renewals
            <span class="badge" id="count-renewals">0</span>
          </button>
          <button class="view-tab" data-view="low_engagement" onclick="switchView('low_engagement')">
            Low Engagement
            <span class="badge" id="count-low_engagement">0</span>
          </button>
          <button class="view-tab" data-view="my_accounts" onclick="switchView('my_accounts')">
            My Accounts
            <span class="badge" id="count-my_accounts">0</span>
          </button>
          <button class="view-tab active" data-view="all" onclick="switchView('all')">
            All
          </button>
        </div>

        <!-- View Description -->
        <div id="viewDescription" class="section-description" style="margin-bottom: var(--space-4);"></div>

        <!-- Filters -->
        <div class="filters">
          <div class="filter-group">
            <label>Search</label>
            <input type="text" id="filterSearch" placeholder="Company name..." oninput="applyFilters()">
          </div>
          <div class="filter-group">
            <label>Owner</label>
            <select id="filterOwner" onchange="applyFilters()">
              <option value="">All</option>
              <option value="Brian">Brian</option>
              <option value="Randy">Randy</option>
              <option value="Matt">Matt</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Account Type</label>
            <select id="filterAccountType" onchange="applyFilters()">
              <option value="company" selected>Companies Only</option>
              <option value="individual">Individuals Only</option>
              <option value="">All</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Company Type</label>
            <select id="filterType" onchange="applyFilters()">
              <option value="">All</option>
              <option value="adtech">Ad Tech</option>
              <option value="agency">Agency</option>
              <option value="brand">Brand</option>
              <option value="publisher">Publisher</option>
            </select>
          </div>
        </div>

        <div id="prospectsCount" style="color: var(--color-text-secondary); margin-bottom: var(--space-2.5); font-size: var(--text-sm);">
          Showing 0 accounts
        </div>

        <table class="prospects-table">
          <thead id="tableHeader">
            <tr>
              <th>Company</th>
              <th>Engagement</th>
              <th>Type</th>
              <th>Owner</th>
              <th>Action Needed</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="prospectsTableBody">
            <tr><td colspan="6" class="empty-state">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add/Edit Prospect Modal -->
  <div id="prospectModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="prospectModalTitle">Add Prospect</h2>
        <button class="modal-close" onclick="closeProspectModal()">&times;</button>
      </div>
      <form id="prospectForm" onsubmit="saveProspect(event)">
        <input type="hidden" id="editOrgId">

        <div class="form-row">
          <div class="form-group">
            <label>Company Name *</label>
            <input type="text" id="prospectName" required>
          </div>
          <div class="form-group">
            <label>Domain</label>
            <input type="text" id="prospectDomain" placeholder="example.com">
            <div class="form-hint">Email domain for auto-matching signups</div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Company Type</label>
            <select id="prospectCompanyType">
              <option value="">Not specified</option>
              <option value="adtech">Ad Tech</option>
              <option value="agency">Agency</option>
              <option value="brand">Brand</option>
              <option value="publisher">Publisher</option>
            </select>
          </div>
          <div class="form-group">
            <label>Owner</label>
            <select id="prospectOwner">
              <option value="">Not assigned</option>
              <option value="Brian">Brian</option>
              <option value="Randy">Randy</option>
              <option value="Matt">Matt</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Status</label>
            <select id="prospectStatus">
              <option value="signed_up">Signed Up</option>
              <option value="prospect">Prospect</option>
              <option value="contacted">Contacted</option>
              <option value="responded">Responded</option>
              <option value="interested">Interested</option>
              <option value="negotiating">Negotiating</option>
              <option value="converted">Converted</option>
              <option value="declined">Declined</option>
            </select>
          </div>
          <div class="form-group">
            <label>Source</label>
            <select id="prospectSource">
              <option value="aao_launch_list">AAO Launch List</option>
              <option value="slack">Slack</option>
              <option value="referral">Referral</option>
              <option value="inbound">Inbound</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Parent Company</label>
          <select id="prospectParent">
            <option value="">None (standalone company)</option>
          </select>
          <div class="form-hint">For subsidiaries, select the parent company</div>
        </div>

        <h3 style="margin-top: var(--space-6); margin-bottom: var(--space-4); font-size: var(--text-base);">Contact Info</h3>

        <div class="form-row">
          <div class="form-group">
            <label>Contact Name</label>
            <input type="text" id="prospectContactName">
          </div>
          <div class="form-group">
            <label>Contact Email</label>
            <input type="email" id="prospectContactEmail">
          </div>
        </div>

        <div class="form-group">
          <label>Contact Title</label>
          <input type="text" id="prospectContactTitle" placeholder="e.g., VP Engineering">
        </div>

        <h3 style="margin-top: var(--space-6); margin-bottom: var(--space-4); font-size: var(--text-base);">Follow-up</h3>

        <div class="form-row">
          <div class="form-group">
            <label>Next Action</label>
            <input type="text" id="prospectNextAction" placeholder="e.g., Send follow-up email">
          </div>
          <div class="form-group">
            <label>Next Action Date</label>
            <input type="date" id="prospectNextActionDate">
          </div>
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea id="prospectNotes" placeholder="Any relevant notes about this prospect..."></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeProspectModal()">Cancel</button>
          <button type="button" class="btn btn-secondary" id="generateInvoiceBtn" onclick="openInvoiceModal()" style="display: none;">Generate Invoice</button>
          <button type="button" class="btn btn-secondary" id="getPaymentLinkBtn" onclick="openPaymentLinkModal()" style="display: none;">Get Payment Link</button>
          <button type="submit" class="btn btn-primary" id="saveProspectBtn">Save Prospect</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Generate Invoice Modal -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>Generate Invoice</h2>
        <button class="modal-close" onclick="closeInvoiceModal()">&times;</button>
      </div>

      <p id="invoiceOrgName" style="margin-bottom: var(--space-4); color: var(--color-text-secondary);"></p>

      <form id="invoiceForm" onsubmit="submitInvoice(event)">
        <!-- Product Selection -->
        <div id="invoiceProductSection">
          <div class="form-group">
            <label>Select Product</label>
            <div id="invoiceProducts" style="margin-bottom: var(--space-4);">
              Loading products...
            </div>
          </div>
        </div>

        <!-- Billing Details (shown after product selection) -->
        <div id="invoiceBillingSection" style="display: none;">
          <div class="form-group">
            <label>Selected Product</label>
            <div id="selectedProductDisplay" style="padding: var(--space-2); background: var(--color-gray-50); border-radius: var(--radius-md); margin-bottom: var(--space-3);"></div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Contact Name *</label>
              <input type="text" id="invoiceContactName" required>
            </div>
            <div class="form-group">
              <label>Contact Email *</label>
              <input type="email" id="invoiceContactEmail" required>
            </div>
          </div>

          <div class="form-group">
            <label>Company Name *</label>
            <input type="text" id="invoiceCompanyName" required>
          </div>

          <h4 style="margin-top: var(--space-4); margin-bottom: var(--space-3); font-size: var(--text-sm); color: var(--color-text-heading);">Billing Address</h4>

          <div class="form-group">
            <label>Street Address *</label>
            <input type="text" id="invoiceAddressLine1" required>
          </div>

          <div class="form-group">
            <label>Address Line 2</label>
            <input type="text" id="invoiceAddressLine2">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>City *</label>
              <input type="text" id="invoiceCity" required>
            </div>
            <div class="form-group">
              <label>State/Province *</label>
              <input type="text" id="invoiceState" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Postal Code *</label>
              <input type="text" id="invoicePostalCode" required>
            </div>
            <div class="form-group">
              <label>Country *</label>
              <input type="text" id="invoiceCountry" value="US" required>
            </div>
          </div>
        </div>

        <!-- Success Message -->
        <div id="invoiceResult" style="display: none;">
          <div style="background: var(--color-success-50); border: 1px solid var(--color-success-200); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">
            <strong style="color: var(--color-success-700);">Invoice Sent!</strong>
            <p style="margin: var(--space-2) 0 0; font-size: var(--text-sm); color: var(--color-text-secondary);">
              The invoice has been emailed to the contact. You can also share this link:
            </p>
          </div>
          <div style="display: flex; gap: var(--space-2);">
            <input type="text" id="invoiceUrl" readonly style="flex: 1; padding: var(--space-2); font-size: var(--text-sm); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
            <button type="button" class="btn btn-primary btn-sm" onclick="copyInvoiceLink()">Copy</button>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeInvoiceModal()">Close</button>
          <button type="submit" class="btn btn-primary" id="sendInvoiceBtn" style="display: none;">Send Invoice</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Payment Link Modal -->
  <div id="paymentLinkModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2>Generate Payment Link</h2>
        <button class="modal-close" onclick="closePaymentLinkModal()">&times;</button>
      </div>

      <p id="paymentLinkOrgName" style="margin-bottom: var(--space-4); color: var(--color-text-secondary);"></p>

      <div id="paymentLinkProducts" style="margin-bottom: var(--space-4);">
        Loading products...
      </div>

      <div id="paymentLinkResult" style="display: none;">
        <div style="background: var(--color-success-50); border: 1px solid var(--color-success-200); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">
          <strong style="color: var(--color-success-700);">Payment Link Generated!</strong>
          <p style="margin: var(--space-2) 0 0; font-size: var(--text-sm); color: var(--color-text-secondary);">
            Copy this link and send it to the prospect:
          </p>
        </div>
        <div style="display: flex; gap: var(--space-2);">
          <input type="text" id="paymentLinkUrl" readonly style="flex: 1; padding: var(--space-2); font-size: var(--text-sm); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
          <button class="btn btn-primary btn-sm" onclick="copyPaymentLink()">Copy</button>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closePaymentLinkModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Bulk Import Modal -->
  <div id="bulkModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2>Bulk Import Prospects</h2>
        <button class="modal-close" onclick="closeBulkImportModal()">&times;</button>
      </div>

      <p style="margin-bottom: var(--space-4); color: var(--color-text-secondary);">
        Paste CSV data. If first row contains headers, they'll be auto-detected.
      </p>
      <p style="margin-bottom: var(--space-4); color: var(--color-text-muted); font-size: var(--text-sm);">
        Supported columns: <code>Company, Category, Who Owns Outreach, Steerco - names, Description</code><br>
        Or basic format: <code>name, domain, company_type, prospect_owner, prospect_contact_name, prospect_notes</code>
      </p>

      <textarea id="bulkCsvData" class="bulk-textarea" placeholder="Company,Category,Who Owns Outreach,Steerco - names,Description
Acme Corp,Ad Tech,Brian,John Smith,Leading SSP provider
Beta Inc,Publisher,Randy,Jane Doe,Major news network"></textarea>

      <div id="importResults" class="import-results" style="display: none;"></div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeBulkImportModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="runBulkImport()" id="runImportBtn">Import</button>
      </div>
    </div>
  </div>

  <script>
    let allProspects = [];
    let filteredProspects = [];
    let allOrganizations = [];
    let currentView = 'all';
    let viewCounts = {};

    const viewDescriptions = {
      needs_followup: 'Organizations with pending follow-up actions due within 7 days',
      new_signups: 'Organizations that signed up in the last 14 days with no logged activities',
      hot_prospects: 'Non-members with high engagement (3+ fires) - good candidates for conversion',
      going_cold: 'Organizations with no activity in the last 30 days - may need re-engagement',
      renewals: 'Active members with subscriptions ending in the next 60 days',
      low_engagement: 'Active members with low engagement (2 fires or less) - retention risk',
      my_accounts: 'Organizations where you are listed as owner or connected',
      all: 'All organizations in the system'
    };

    async function loadData() {
      try {
        // Load view counts first for badges
        const countsRes = await fetch('/api/admin/prospects/view-counts');
        if (countsRes.ok) {
          viewCounts = await countsRes.json();
          updateViewCounts();
        }

        // Load organizations for dropdown
        const orgsRes = await fetch('/api/admin/organizations');
        if (orgsRes.ok) {
          allOrganizations = await orgsRes.json();
          populateParentDropdown();
        }

        // Load current view
        await loadView(currentView);

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('loading').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load data. <a href="/auth/login">Try logging in again</a></p>';
      }
    }

    function updateViewCounts() {
      document.getElementById('count-needs_followup').textContent = viewCounts.needs_followup || 0;
      document.getElementById('count-new_signups').textContent = viewCounts.new_signups || 0;
      document.getElementById('count-going_cold').textContent = viewCounts.going_cold || 0;
      document.getElementById('count-renewals').textContent = viewCounts.renewals || 0;
      document.getElementById('count-my_accounts').textContent = viewCounts.my_accounts || 0;
      // hot_prospects and low_engagement are calculated client-side, so we don't show counts
    }

    async function loadView(view) {
      currentView = view;

      // Update active tab
      document.querySelectorAll('.view-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.view === view);
      });

      // Update description
      document.getElementById('viewDescription').textContent = viewDescriptions[view] || '';

      // Fetch data for view
      const viewParam = view === 'all' ? '' : `?view=${view}`;
      const response = await fetch(`/api/admin/prospects${viewParam}`);

      if (!response.ok) {
        if (response.status === 401) {
          window.AdminNav.redirectToLogin();
          return;
        }
        throw new Error('Failed to load prospects');
      }

      allProspects = await response.json();
      filteredProspects = allProspects;
      applyFilters();
    }

    function switchView(view) {
      loadView(view);
    }

    function populateParentDropdown() {
      const select = document.getElementById('prospectParent');
      select.innerHTML = '<option value="">None (standalone company)</option>';

      allOrganizations
        .filter(org => !org.prospect_status || org.prospect_status === 'joined')
        .forEach(org => {
          select.innerHTML += `<option value="${org.workos_organization_id}">${org.name}</option>`;
        });
    }

    function applyFilters() {
      const ownerFilter = document.getElementById('filterOwner').value;
      const typeFilter = document.getElementById('filterType').value;
      const searchFilter = document.getElementById('filterSearch').value.toLowerCase();
      const accountTypeFilter = document.getElementById('filterAccountType').value;

      filteredProspects = allProspects.filter(prospect => {
        // Account type filter (Individual vs Company)
        if (accountTypeFilter === 'company' && prospect.is_personal) return false;
        if (accountTypeFilter === 'individual' && !prospect.is_personal) return false;

        if (ownerFilter && prospect.prospect_owner !== ownerFilter) return false;
        if (typeFilter && prospect.company_type !== typeFilter) return false;
        if (searchFilter && !prospect.name.toLowerCase().includes(searchFilter)) return false;
        return true;
      });

      renderProspects();
    }

    function renderProspects() {
      const tbody = document.getElementById('prospectsTableBody');
      const countDiv = document.getElementById('prospectsCount');

      countDiv.textContent = `Showing ${filteredProspects.length} account${filteredProspects.length !== 1 ? 's' : ''}`;

      if (filteredProspects.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">
              <h3>No accounts found</h3>
              <p>No organizations match the current view and filters.</p>
            </td>
          </tr>
        `;
        return;
      }

      const typeLabels = {
        adtech: 'Ad Tech',
        agency: 'Agency',
        brand: 'Brand',
        publisher: 'Publisher'
      };

      tbody.innerHTML = filteredProspects.map(prospect => {
        // Company name with link
        let companyHtml = `<a href="/admin/organizations/${prospect.workos_organization_id}" class="company-link">${prospect.name}</a>`;

        // Add member status badge
        if (prospect.subscription_status === 'active') {
          companyHtml += `<br><span class="status-badge status-member">Member</span>`;
        }
        if (prospect.member_count > 0) {
          companyHtml += ` <small style="color: var(--color-text-muted);">${prospect.member_count} user${prospect.member_count !== 1 ? 's' : ''}</small>`;
        }

        // Engagement fires
        const fires = '\u{1F525}'.repeat(prospect.engagement_level || 1);
        const engagementTooltip = prospect.engagement_reasons?.join(', ') || 'Cold';
        const engagementHtml = `<span class="engagement-fires" title="${engagementTooltip}">${fires}</span>`;

        // Type
        const typeHtml = prospect.company_type ? typeLabels[prospect.company_type] || prospect.company_type : '<span style="color: var(--color-text-muted);">-</span>';

        // Owner
        const ownerHtml = prospect.prospect_owner || '<span style="color: var(--color-text-muted);">-</span>';

        // Action needed - context-dependent
        let actionHtml = '-';
        if (currentView === 'needs_followup' && prospect.followup_due) {
          const dueDate = new Date(prospect.followup_due);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const daysUntil = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
          const dateClass = daysUntil < 0 ? 'date-overdue' : (daysUntil <= 3 ? 'date-soon' : '');
          actionHtml = `<span class="${dateClass}">${prospect.followup_description || 'Follow up'}</span><br><small class="${dateClass}">${dueDate.toLocaleDateString()}</small>`;
        } else if (currentView === 'new_signups') {
          const signupDate = new Date(prospect.created_at);
          actionHtml = `Welcome outreach<br><small>Signed up ${signupDate.toLocaleDateString()}</small>`;
        } else if (currentView === 'going_cold') {
          const lastActivity = prospect.last_activity_at ? new Date(prospect.last_activity_at) : null;
          actionHtml = lastActivity ? `Re-engage<br><small>Last activity ${lastActivity.toLocaleDateString()}</small>` : 'Re-engage';
        } else if (currentView === 'renewals') {
          const renewalDate = prospect.subscription_current_period_end ? new Date(prospect.subscription_current_period_end) : null;
          actionHtml = renewalDate ? `Renewal check-in<br><small>Expires ${renewalDate.toLocaleDateString()}</small>` : 'Renewal check-in';
        } else if (currentView === 'hot_prospects') {
          actionHtml = 'Convert to member';
        } else if (currentView === 'low_engagement') {
          actionHtml = 'Increase engagement';
        } else if (prospect.prospect_next_action) {
          actionHtml = prospect.prospect_next_action;
          if (prospect.prospect_next_action_date) {
            const actionDate = new Date(prospect.prospect_next_action_date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const daysUntil = Math.floor((actionDate - today) / (1000 * 60 * 60 * 24));
            const dateClass = daysUntil < 0 ? 'date-overdue' : (daysUntil <= 3 ? 'date-soon' : '');
            actionHtml += `<br><small class="${dateClass}">${actionDate.toLocaleDateString()}</small>`;
          }
        }

        return `
          <tr>
            <td>${companyHtml}</td>
            <td>${engagementHtml}</td>
            <td>${typeHtml}</td>
            <td>${ownerHtml}</td>
            <td>${actionHtml}</td>
            <td>
              <button class="btn-icon" onclick="editProspect('${prospect.workos_organization_id}')" title="Edit">Edit</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Modal functions
    function openAddProspectModal() {
      document.getElementById('prospectModalTitle').textContent = 'Add Prospect';
      document.getElementById('prospectForm').reset();
      document.getElementById('editOrgId').value = '';
      document.getElementById('prospectCompanyType').value = '';
      document.getElementById('prospectOwner').value = '';
      document.getElementById('prospectStatus').value = 'prospect';
      document.getElementById('prospectSource').value = 'aao_launch_list';
      document.getElementById('prospectDomain').disabled = false;
      document.getElementById('prospectName').disabled = false;
      // Hide payment link button for new prospects
      document.getElementById('getPaymentLinkBtn').style.display = 'none';
      document.getElementById('prospectModal').style.display = 'block';
    }

    function editProspect(orgId) {
      const prospect = allProspects.find(p => p.workos_organization_id === orgId);
      if (!prospect) return;

      document.getElementById('prospectModalTitle').textContent = 'Edit Prospect';
      document.getElementById('editOrgId').value = orgId;
      document.getElementById('prospectName').value = prospect.name;
      document.getElementById('prospectName').disabled = true;
      document.getElementById('prospectDomain').value = '';
      document.getElementById('prospectDomain').disabled = true;
      document.getElementById('prospectCompanyType').value = prospect.company_type || '';
      document.getElementById('prospectOwner').value = prospect.prospect_owner || '';
      document.getElementById('prospectStatus').value = prospect.prospect_status || 'prospect';
      document.getElementById('prospectSource').value = prospect.prospect_source || 'aao_launch_list';
      document.getElementById('prospectParent').value = prospect.parent_organization_id || '';
      document.getElementById('prospectContactName').value = prospect.prospect_contact_name || '';
      document.getElementById('prospectContactEmail').value = prospect.prospect_contact_email || '';
      document.getElementById('prospectContactTitle').value = prospect.prospect_contact_title || '';
      document.getElementById('prospectNextAction').value = prospect.prospect_next_action || '';
      document.getElementById('prospectNextActionDate').value = prospect.prospect_next_action_date ? prospect.prospect_next_action_date.split('T')[0] : '';
      document.getElementById('prospectNotes').value = prospect.prospect_notes || '';

      // Show payment link and invoice buttons for non-members
      const paymentLinkBtn = document.getElementById('getPaymentLinkBtn');
      const invoiceBtn = document.getElementById('generateInvoiceBtn');
      const isNotMember = prospect.subscription_status !== 'active';
      paymentLinkBtn.style.display = isNotMember ? 'inline-block' : 'none';
      invoiceBtn.style.display = isNotMember ? 'inline-block' : 'none';

      document.getElementById('prospectModal').style.display = 'block';
    }

    function closeProspectModal() {
      document.getElementById('prospectModal').style.display = 'none';
    }

    async function saveProspect(event) {
      event.preventDefault();

      const orgId = document.getElementById('editOrgId').value;
      const isEdit = !!orgId;

      const data = {
        name: document.getElementById('prospectName').value,
        domain: document.getElementById('prospectDomain').value || null,
        company_type: document.getElementById('prospectCompanyType').value || null,
        prospect_owner: document.getElementById('prospectOwner').value || null,
        prospect_status: document.getElementById('prospectStatus').value,
        prospect_source: document.getElementById('prospectSource').value,
        parent_organization_id: document.getElementById('prospectParent').value || null,
        prospect_contact_name: document.getElementById('prospectContactName').value || null,
        prospect_contact_email: document.getElementById('prospectContactEmail').value || null,
        prospect_contact_title: document.getElementById('prospectContactTitle').value || null,
        prospect_next_action: document.getElementById('prospectNextAction').value || null,
        prospect_next_action_date: document.getElementById('prospectNextActionDate').value || null,
        prospect_notes: document.getElementById('prospectNotes').value || null
      };

      const btn = document.getElementById('saveProspectBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const url = isEdit ? `/api/admin/prospects/${orgId}` : '/api/admin/prospects';
        const method = isEdit ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          const error = await response.json();
          throw new Error(error.message || 'Failed to save prospect');
        }

        closeProspectModal();
        loadData();
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Prospect';
      }
    }

    // Bulk import
    function openBulkImportModal() {
      document.getElementById('bulkCsvData').value = '';
      document.getElementById('importResults').style.display = 'none';
      document.getElementById('bulkModal').style.display = 'block';
    }

    function closeBulkImportModal() {
      document.getElementById('bulkModal').style.display = 'none';
    }

    // Parse CSV line handling quoted fields
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    // Map category to company_type
    function mapCategoryToType(category) {
      if (!category) return null;
      const cat = category.toLowerCase();
      if (cat.includes('ad tech') || cat.includes('adtech')) return 'adtech';
      if (cat.includes('agency')) return 'agency';
      if (cat.includes('brand')) return 'brand';
      if (cat.includes('publisher')) return 'publisher';
      return null;
    }

    async function runBulkImport() {
      const csvData = document.getElementById('bulkCsvData').value.trim();
      if (!csvData) {
        alert('Please paste CSV data');
        return;
      }

      const lines = csvData.split('\n').filter(line => line.trim());
      if (lines.length === 0) {
        alert('No data to import');
        return;
      }

      // Check if first line is a header row
      const firstLine = lines[0].toLowerCase();
      const hasHeader = firstLine.includes('company') || firstLine.includes('name') || firstLine.includes('category');
      let headers = null;
      let dataLines = lines;

      if (hasHeader) {
        headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim());
        dataLines = lines.slice(1);
      }

      // Column mapping for your specific CSV format
      const columnMap = {
        'company': 'name',
        'name': 'name',
        'category': 'company_type',
        'company_type': 'company_type',
        'type': 'company_type',
        'who owns outreach': 'prospect_owner',
        'owner': 'prospect_owner',
        'prospect_owner': 'prospect_owner',
        'steerco - names': 'prospect_contact_name',
        'contact': 'prospect_contact_name',
        'prospect_contact_name': 'prospect_contact_name',
        'description': 'prospect_notes',
        'notes': 'prospect_notes',
        'prospect_notes': 'prospect_notes',
        'domain': 'domain',
        'source': 'prospect_source',
        'prospect_source': 'prospect_source'
      };

      const prospects = dataLines.map(line => {
        const parts = parseCSVLine(line);

        if (headers) {
          // Map by header names
          const prospect = {
            prospect_source: 'aao_launch_list'
          };
          headers.forEach((header, idx) => {
            const field = columnMap[header];
            if (field && parts[idx]) {
              if (field === 'company_type') {
                prospect[field] = mapCategoryToType(parts[idx]);
              } else {
                prospect[field] = parts[idx];
              }
            }
          });
          return prospect;
        } else {
          // Basic format: name, domain, company_type, prospect_owner, prospect_contact_name, prospect_notes
          return {
            name: parts[0],
            domain: parts[1] || null,
            company_type: mapCategoryToType(parts[2]),
            prospect_owner: parts[3] || null,
            prospect_contact_name: parts[4] || null,
            prospect_notes: parts[5] || null,
            prospect_source: 'aao_launch_list'
          };
        }
      }).filter(p => p.name); // Filter out rows without names

      const btn = document.getElementById('runImportBtn');
      btn.disabled = true;
      btn.textContent = 'Importing...';

      try {
        const response = await fetch('/api/admin/prospects/bulk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prospects })
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          throw new Error('Import failed');
        }

        const result = await response.json();

        // Show results
        const resultsDiv = document.getElementById('importResults');
        let html = `<strong>Imported: ${result.created}</strong> | Failed: ${result.failed}<br><br>`;

        if (result.results.success.length > 0) {
          html += '<div class="import-success">Success:<br>';
          result.results.success.forEach(s => {
            html += `&nbsp;&nbsp;${s.name}${s.domain ? ` (${s.domain})` : ''}<br>`;
          });
          html += '</div>';
        }

        if (result.results.errors.length > 0) {
          html += '<div class="import-error" style="margin-top: var(--space-2);">Errors:<br>';
          result.results.errors.forEach(e => {
            html += `&nbsp;&nbsp;${e.name}: ${e.error}<br>`;
          });
          html += '</div>';
        }

        resultsDiv.innerHTML = html;
        resultsDiv.style.display = 'block';

        // Refresh data
        loadData();
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Import';
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }

    // Payment link functionality
    let paymentLinkOrgId = null;

    function openPaymentLinkModal() {
      const orgId = document.getElementById('editOrgId').value;
      if (!orgId) return;

      paymentLinkOrgId = orgId;
      const prospect = allProspects.find(p => p.workos_organization_id === orgId);

      document.getElementById('paymentLinkOrgName').textContent = `For: ${prospect?.name || 'Unknown'}`;
      document.getElementById('paymentLinkProducts').innerHTML = 'Loading products...';
      document.getElementById('paymentLinkResult').style.display = 'none';
      document.getElementById('paymentLinkModal').style.display = 'block';

      loadPaymentLinkProducts(orgId);
    }

    async function loadPaymentLinkProducts(orgId) {
      try {
        const response = await fetch(`/api/admin/prospects/${orgId}/payment-link`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}) // No lookup_key = get product list
        });

        if (!response.ok) {
          throw new Error('Failed to load products');
        }

        const data = await response.json();

        if (data.needs_selection && data.products) {
          renderPaymentLinkProducts(data.products);
        }
      } catch (error) {
        console.error('Error loading products:', error);
        document.getElementById('paymentLinkProducts').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load products. Please try again.</p>';
      }
    }

    function renderPaymentLinkProducts(products) {
      const container = document.getElementById('paymentLinkProducts');

      if (products.length === 0) {
        container.innerHTML = '<p style="color: var(--color-text-secondary);">No products available for this account type.</p>';
        return;
      }

      container.innerHTML = products.map(product => {
        const price = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD'
        }).format(product.amount_cents / 100);

        const tiers = product.revenue_tiers?.length > 0
          ? `<span style="font-size: var(--text-xs); color: var(--color-text-muted);">(${product.revenue_tiers.join(', ')})</span>`
          : '';

        return `
          <button class="product-select-btn" onclick="generatePaymentLink('${product.lookup_key}')" style="
            display: block;
            width: 100%;
            text-align: left;
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-bg-card);
            cursor: pointer;
            transition: var(--transition-all);
          " onmouseover="this.style.borderColor='var(--color-brand)'" onmouseout="this.style.borderColor='var(--color-border)'">
            <strong>${product.display_name}</strong> ${tiers}
            <br>
            <span style="color: var(--color-brand); font-weight: var(--font-semibold);">${price}/year</span>
          </button>
        `;
      }).join('');
    }

    async function generatePaymentLink(lookupKey) {
      if (!paymentLinkOrgId) return;

      const container = document.getElementById('paymentLinkProducts');
      container.innerHTML = '<p>Generating payment link...</p>';

      try {
        const response = await fetch(`/api/admin/prospects/${paymentLinkOrgId}/payment-link`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lookup_key: lookupKey })
        });

        if (!response.ok) {
          throw new Error('Failed to generate payment link');
        }

        const data = await response.json();

        if (data.success && data.payment_url) {
          container.style.display = 'none';
          document.getElementById('paymentLinkUrl').value = data.payment_url;
          document.getElementById('paymentLinkResult').style.display = 'block';
        } else {
          throw new Error(data.message || 'Unknown error');
        }
      } catch (error) {
        console.error('Error generating payment link:', error);
        container.innerHTML = `<p style="color: var(--color-error-600);">Error: ${error.message}</p>`;
      }
    }

    function copyPaymentLink() {
      const input = document.getElementById('paymentLinkUrl');
      input.select();
      navigator.clipboard.writeText(input.value).then(() => {
        alert('Payment link copied to clipboard!');
      }).catch(() => {
        // Fallback for older browsers
        document.execCommand('copy');
        alert('Payment link copied to clipboard!');
      });
    }

    function closePaymentLinkModal() {
      document.getElementById('paymentLinkModal').style.display = 'none';
      paymentLinkOrgId = null;
    }

    // Invoice functionality
    let invoiceOrgId = null;
    let selectedInvoiceProduct = null;

    function openInvoiceModal() {
      const orgId = document.getElementById('editOrgId').value;
      if (!orgId) return;

      invoiceOrgId = orgId;
      selectedInvoiceProduct = null;
      const prospect = allProspects.find(p => p.workos_organization_id === orgId);

      document.getElementById('invoiceOrgName').textContent = `For: ${prospect?.name || 'Unknown'}`;
      document.getElementById('invoiceProducts').innerHTML = 'Loading products...';
      document.getElementById('invoiceProductSection').style.display = 'block';
      document.getElementById('invoiceBillingSection').style.display = 'none';
      document.getElementById('invoiceResult').style.display = 'none';
      document.getElementById('sendInvoiceBtn').style.display = 'none';
      document.getElementById('invoiceForm').reset();

      // Pre-fill from prospect data
      if (prospect) {
        document.getElementById('invoiceContactName').value = prospect.prospect_contact_name || '';
        document.getElementById('invoiceContactEmail').value = prospect.prospect_contact_email || '';
        document.getElementById('invoiceCompanyName').value = prospect.name || '';
      }

      document.getElementById('invoiceModal').style.display = 'block';

      loadInvoiceProducts();
    }

    async function loadInvoiceProducts() {
      try {
        const response = await fetch('/api/admin/products');
        if (!response.ok) throw new Error('Failed to load products');

        const data = await response.json();
        const invoiceableProducts = data.products.filter(p => p.is_invoiceable);

        renderInvoiceProducts(invoiceableProducts);
      } catch (error) {
        console.error('Error loading products:', error);
        document.getElementById('invoiceProducts').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load products. Please try again.</p>';
      }
    }

    function renderInvoiceProducts(products) {
      const container = document.getElementById('invoiceProducts');

      if (products.length === 0) {
        container.innerHTML = '<p style="color: var(--color-text-secondary);">No invoiceable products available.</p>';
        return;
      }

      container.innerHTML = products.map(product => {
        const price = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD'
        }).format(product.amount_cents / 100);

        const interval = product.billing_interval ? `/${product.billing_interval}` : '';

        return `
          <button type="button" class="product-select-btn" onclick="selectInvoiceProduct('${product.lookup_key}', '${product.display_name || product.product_name}', ${product.amount_cents})" style="
            display: block;
            width: 100%;
            text-align: left;
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-bg-card);
            cursor: pointer;
            transition: var(--transition-all);
          " onmouseover="this.style.borderColor='var(--color-brand)'" onmouseout="this.style.borderColor='var(--color-border)'">
            <strong>${product.display_name || product.product_name}</strong>
            <br>
            <span style="color: var(--color-brand); font-weight: var(--font-semibold);">${price}${interval}</span>
            ${product.description ? `<br><span style="font-size: var(--text-xs); color: var(--color-text-muted);">${product.description}</span>` : ''}
          </button>
        `;
      }).join('');
    }

    function selectInvoiceProduct(lookupKey, productName, amountCents) {
      selectedInvoiceProduct = { lookupKey, productName, amountCents };

      const price = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(amountCents / 100);

      document.getElementById('selectedProductDisplay').innerHTML = `
        <strong>${productName}</strong> - <span style="color: var(--color-brand);">${price}</span>
      `;

      document.getElementById('invoiceProductSection').style.display = 'none';
      document.getElementById('invoiceBillingSection').style.display = 'block';
      document.getElementById('sendInvoiceBtn').style.display = 'inline-block';
    }

    async function submitInvoice(event) {
      event.preventDefault();

      if (!selectedInvoiceProduct || !invoiceOrgId) {
        alert('Please select a product first');
        return;
      }

      const btn = document.getElementById('sendInvoiceBtn');
      btn.disabled = true;
      btn.textContent = 'Sending...';

      const data = {
        lookup_key: selectedInvoiceProduct.lookupKey,
        company_name: document.getElementById('invoiceCompanyName').value,
        contact_name: document.getElementById('invoiceContactName').value,
        contact_email: document.getElementById('invoiceContactEmail').value,
        billing_address: {
          line1: document.getElementById('invoiceAddressLine1').value,
          line2: document.getElementById('invoiceAddressLine2').value || undefined,
          city: document.getElementById('invoiceCity').value,
          state: document.getElementById('invoiceState').value,
          postal_code: document.getElementById('invoicePostalCode').value,
          country: document.getElementById('invoiceCountry').value,
        }
      };

      try {
        const response = await fetch(`/api/admin/prospects/${invoiceOrgId}/invoice`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to send invoice');
        }

        const result = await response.json();

        if (result.success && result.invoice_url) {
          document.getElementById('invoiceBillingSection').style.display = 'none';
          document.getElementById('sendInvoiceBtn').style.display = 'none';
          document.getElementById('invoiceUrl').value = result.invoice_url;
          document.getElementById('invoiceResult').style.display = 'block';
        } else {
          throw new Error(result.message || 'Unknown error');
        }
      } catch (error) {
        console.error('Error sending invoice:', error);
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Send Invoice';
      }
    }

    function copyInvoiceLink() {
      const input = document.getElementById('invoiceUrl');
      input.select();
      navigator.clipboard.writeText(input.value).then(() => {
        alert('Invoice link copied to clipboard!');
      }).catch(() => {
        document.execCommand('copy');
        alert('Invoice link copied to clipboard!');
      });
    }

    function closeInvoiceModal() {
      document.getElementById('invoiceModal').style.display = 'none';
      invoiceOrgId = null;
      selectedInvoiceProduct = null;
    }

    // Initialize
    loadData();
  </script>
</body>
</html>
