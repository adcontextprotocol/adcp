<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Admin - Prospects - AdCP Registry</title>
  <script src="/admin-nav.js"></script>
  <link rel="stylesheet" href="/design-system.css">
  <style>
    /* =============================================================================
       Admin Prospects styles
       Uses design system variables - see /design-system.css for tokens
       ============================================================================= */

    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-wide);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }
    h1 { margin-bottom: var(--space-2.5); color: var(--color-text-heading); }
    .subtitle { color: var(--color-text-secondary); margin-bottom: var(--space-5); }

    /* Pipeline Stats */
    .pipeline-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--space-3);
      margin-bottom: var(--space-5);
      padding: var(--space-4);
      background: var(--color-gray-50);
      border-radius: var(--radius-md);
    }
    .stat-item {
      text-align: center;
      padding: var(--space-3);
      border-radius: var(--radius-sm);
      background: var(--color-bg-card);
    }
    .stat-count {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
    }
    .stat-label {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      text-transform: capitalize;
    }

    /* Filters */
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-5);
      padding: var(--space-5);
      background: var(--color-gray-50);
      border-radius: var(--radius-md);
    }
    .filter-group label {
      display: block;
      margin-bottom: var(--space-1);
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      color: var(--color-text-heading);
    }
    .filter-group select,
    .filter-group input {
      width: 100%;
      padding: var(--space-2);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }

    /* Actions */
    .actions {
      display: flex;
      gap: var(--space-2.5);
      margin-bottom: var(--space-5);
    }
    .btn {
      padding: var(--space-2.5) var(--space-5);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .btn-primary {
      background: var(--color-brand);
      color: white;
    }
    .btn-primary:hover {
      background: var(--color-primary-700);
    }
    .btn-secondary {
      background: var(--color-gray-200);
      color: var(--color-text-heading);
    }
    .btn-secondary:hover {
      background: var(--color-gray-300);
    }

    /* Table */
    .prospects-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: var(--space-5);
    }
    .prospects-table th {
      background: var(--color-gray-50);
      padding: var(--space-3);
      text-align: left;
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      border-bottom: var(--border-2) solid var(--color-gray-200);
      font-size: var(--text-sm);
    }
    .prospects-table td {
      padding: var(--space-3);
      border-bottom: var(--border-1) solid var(--color-gray-200);
      font-size: var(--text-sm);
    }
    .prospects-table tr:hover {
      background: var(--color-gray-50);
    }
    .prospects-table tr.has-members {
      background: var(--color-success-50);
    }

    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
    }
    .status-prospect { background: var(--color-gray-200); color: var(--color-text-heading); }
    .status-contacted { background: var(--color-info-100); color: var(--color-info-700); }
    .status-responded { background: var(--color-warning-100); color: var(--color-warning-700); }
    .status-interested { background: var(--color-primary-100); color: var(--color-primary-700); }
    .status-negotiating { background: var(--color-primary-200); color: var(--color-primary-800); }
    .status-joined { background: var(--color-success-100); color: var(--color-success-700); }
    .status-declined { background: var(--color-error-100); color: var(--color-error-700); }

    .member-badge {
      background: var(--color-success-100);
      color: var(--color-success-700);
      padding: var(--space-0.5) var(--space-1.5);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      margin-left: var(--space-2);
    }

    .parent-badge {
      background: var(--color-primary-100);
      color: var(--color-primary-700);
      padding: var(--space-0.5) var(--space-1.5);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      margin-left: var(--space-2);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: var(--space-12);
      color: var(--color-text-secondary);
    }

    /* Buttons */
    .btn-icon {
      padding: var(--space-1.5) var(--space-3);
      border: var(--border-1) solid var(--color-gray-200);
      background: var(--color-bg-card);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .btn-icon:hover {
      background: var(--color-gray-50);
      border-color: var(--color-brand);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: var(--color-surface-overlay);
    }
    .modal-content {
      background-color: var(--color-bg-card);
      margin: var(--space-8) auto;
      padding: var(--space-8);
      border-radius: var(--radius-md);
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-5);
      padding-bottom: var(--space-4);
      border-bottom: var(--border-2) solid var(--color-gray-200);
    }
    .modal-close {
      font-size: var(--text-3xl);
      font-weight: var(--font-bold);
      color: var(--color-text-secondary);
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      line-height: 1;
    }
    .modal-close:hover {
      color: var(--color-text-heading);
    }

    /* Form */
    .form-group {
      margin-bottom: var(--space-4);
    }
    .form-group label {
      display: block;
      margin-bottom: var(--space-1);
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      color: var(--color-text-heading);
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: var(--space-2.5);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
    }
    .form-hint {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }
    .modal-actions {
      display: flex;
      gap: var(--space-2.5);
      justify-content: flex-end;
      margin-top: var(--space-6);
      padding-top: var(--space-4);
      border-top: var(--border-1) solid var(--color-gray-200);
    }

    /* Bulk import */
    .bulk-textarea {
      width: 100%;
      min-height: 200px;
      font-family: monospace;
      font-size: var(--text-sm);
      padding: var(--space-3);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
    }
    .import-results {
      margin-top: var(--space-4);
      padding: var(--space-4);
      background: var(--color-gray-50);
      border-radius: var(--radius-md);
      max-height: 300px;
      overflow-y: auto;
    }
    .import-success { color: var(--color-success-600); }
    .import-error { color: var(--color-error-600); }

    /* Next action highlight */
    .next-action-due {
      color: var(--color-warning-600);
      font-weight: var(--font-semibold);
    }
    .next-action-overdue {
      color: var(--color-error-600);
      font-weight: var(--font-semibold);
    }
  </style>
</head>
<body>
  <!-- Header injected by admin-nav.js -->

  <div id="loading" class="loading">
    Loading prospects...
  </div>

  <div id="content" style="display: none;">
    <div class="container">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <div>
            <h1>Prospect Pipeline</h1>
            <p class="subtitle">Track outreach for AAO membership</p>
          </div>
          <div class="actions">
            <button class="btn btn-secondary" onclick="openMarkExistingModal()">Mark Existing Org</button>
            <button class="btn btn-secondary" onclick="openBulkImportModal()">Bulk Import</button>
            <button class="btn btn-primary" onclick="openAddProspectModal()">+ Add Prospect</button>
          </div>
        </div>

        <!-- Pipeline Stats -->
        <div id="pipelineStats" class="pipeline-stats">
          <div class="stat-item">
            <div class="stat-count">-</div>
            <div class="stat-label">Total</div>
          </div>
        </div>

        <!-- Filters -->
        <div class="filters">
          <div class="filter-group">
            <label>Status</label>
            <select id="filterStatus" onchange="applyFilters()">
              <option value="">All Statuses</option>
              <option value="prospect">Prospect</option>
              <option value="contacted">Contacted</option>
              <option value="responded">Responded</option>
              <option value="interested">Interested</option>
              <option value="negotiating">Negotiating</option>
              <option value="joined">Joined</option>
              <option value="declined">Declined</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Owner</label>
            <select id="filterOwner" onchange="applyFilters()">
              <option value="">All Owners</option>
              <option value="Brian">Brian</option>
              <option value="Randy">Randy</option>
              <option value="Matt">Matt</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Type</label>
            <select id="filterType" onchange="applyFilters()">
              <option value="">All Types</option>
              <option value="adtech">Ad Tech</option>
              <option value="agency">Agency</option>
              <option value="brand">Brand</option>
              <option value="publisher">Publisher</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Source</label>
            <select id="filterSource" onchange="applyFilters()">
              <option value="">All Sources</option>
              <option value="aao_launch_list">AAO Launch List</option>
              <option value="slack">Slack</option>
              <option value="referral">Referral</option>
              <option value="inbound">Inbound</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Has Members</label>
            <select id="filterMembers" onchange="applyFilters()">
              <option value="">All</option>
              <option value="yes">Has Members</option>
              <option value="no">No Members Yet</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Search</label>
            <input type="text" id="filterSearch" placeholder="Company name..." oninput="applyFilters()">
          </div>
        </div>

        <div id="prospectsCount" style="color: var(--color-text-secondary); margin-bottom: var(--space-2.5);">
          Showing 0 prospects
        </div>

        <table class="prospects-table">
          <thead>
            <tr>
              <th>Company</th>
              <th>Type</th>
              <th>Status</th>
              <th>Owner</th>
              <th>Contact</th>
              <th>Next Action</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="prospectsTableBody">
            <tr><td colspan="7" style="text-align: center; padding: var(--space-10); color: var(--color-text-secondary);">No prospects found</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add/Edit Prospect Modal -->
  <div id="prospectModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="prospectModalTitle">Add Prospect</h2>
        <button class="modal-close" onclick="closeProspectModal()">&times;</button>
      </div>
      <form id="prospectForm" onsubmit="saveProspect(event)">
        <input type="hidden" id="editOrgId">

        <div class="form-row">
          <div class="form-group">
            <label>Company Name *</label>
            <input type="text" id="prospectName" required>
          </div>
          <div class="form-group">
            <label>Domain</label>
            <input type="text" id="prospectDomain" placeholder="example.com">
            <div class="form-hint">Email domain for auto-matching signups</div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Company Type</label>
            <select id="prospectCompanyType">
              <option value="">Not specified</option>
              <option value="adtech">Ad Tech</option>
              <option value="agency">Agency</option>
              <option value="brand">Brand</option>
              <option value="publisher">Publisher</option>
            </select>
          </div>
          <div class="form-group">
            <label>Owner</label>
            <select id="prospectOwner">
              <option value="">Not assigned</option>
              <option value="Brian">Brian</option>
              <option value="Randy">Randy</option>
              <option value="Matt">Matt</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Status</label>
            <select id="prospectStatus">
              <option value="prospect">Prospect</option>
              <option value="contacted">Contacted</option>
              <option value="responded">Responded</option>
              <option value="interested">Interested</option>
              <option value="negotiating">Negotiating</option>
              <option value="joined">Joined</option>
              <option value="declined">Declined</option>
            </select>
          </div>
          <div class="form-group">
            <label>Source</label>
            <select id="prospectSource">
              <option value="aao_launch_list">AAO Launch List</option>
              <option value="slack">Slack</option>
              <option value="referral">Referral</option>
              <option value="inbound">Inbound</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Parent Company</label>
          <select id="prospectParent">
            <option value="">None (standalone company)</option>
          </select>
          <div class="form-hint">For subsidiaries, select the parent company</div>
        </div>

        <h3 style="margin-top: var(--space-6); margin-bottom: var(--space-4); font-size: var(--text-base);">Contact Info</h3>

        <div class="form-row">
          <div class="form-group">
            <label>Contact Name</label>
            <input type="text" id="prospectContactName">
          </div>
          <div class="form-group">
            <label>Contact Email</label>
            <input type="email" id="prospectContactEmail">
          </div>
        </div>

        <div class="form-group">
          <label>Contact Title</label>
          <input type="text" id="prospectContactTitle" placeholder="e.g., VP Engineering">
        </div>

        <h3 style="margin-top: var(--space-6); margin-bottom: var(--space-4); font-size: var(--text-base);">Follow-up</h3>

        <div class="form-row">
          <div class="form-group">
            <label>Next Action</label>
            <input type="text" id="prospectNextAction" placeholder="e.g., Send follow-up email">
          </div>
          <div class="form-group">
            <label>Next Action Date</label>
            <input type="date" id="prospectNextActionDate">
          </div>
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea id="prospectNotes" placeholder="Any relevant notes about this prospect..."></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeProspectModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="saveProspectBtn">Save Prospect</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bulk Import Modal -->
  <div id="bulkModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2>Bulk Import Prospects</h2>
        <button class="modal-close" onclick="closeBulkImportModal()">&times;</button>
      </div>

      <p style="margin-bottom: var(--space-4); color: var(--color-text-secondary);">
        Paste CSV data. If first row contains headers, they'll be auto-detected.
      </p>
      <p style="margin-bottom: var(--space-4); color: var(--color-text-muted); font-size: var(--text-sm);">
        Supported columns: <code>Company, Category, Who Owns Outreach, Steerco - names, Description</code><br>
        Or basic format: <code>name, domain, company_type, prospect_owner, prospect_contact_name, prospect_notes</code>
      </p>

      <textarea id="bulkCsvData" class="bulk-textarea" placeholder="Company,Category,Who Owns Outreach,Steerco - names,Description
Acme Corp,Ad Tech,Brian,John Smith,Leading SSP provider
Beta Inc,Publisher,Randy,Jane Doe,Major news network"></textarea>

      <div id="importResults" class="import-results" style="display: none;"></div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeBulkImportModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="runBulkImport()" id="runImportBtn">Import</button>
      </div>
    </div>
  </div>

  <!-- Mark Existing Org Modal -->
  <div id="markExistingModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2>Track Existing Organization</h2>
        <button class="modal-close" onclick="closeMarkExistingModal()">&times;</button>
      </div>

      <p style="margin-bottom: var(--space-4); color: var(--color-text-secondary);">
        Add an existing organization (signed up but not subscribed) to your prospect pipeline.
      </p>

      <div class="form-group">
        <label>Organization</label>
        <select id="existingOrgSelect" style="width: 100%; padding: var(--space-2.5);">
          <option value="">Select an organization...</option>
        </select>
      </div>

      <div class="form-group">
        <label>Domain (optional)</label>
        <input type="text" id="existingOrgDomain" placeholder="example.com" style="width: 100%; padding: var(--space-2.5);">
        <div class="form-hint">Add email domain for auto-matching future signups</div>
      </div>

      <div class="form-group">
        <label>Status</label>
        <select id="existingOrgStatus" style="width: 100%; padding: var(--space-2.5);">
          <option value="interested" selected>Interested (they signed up)</option>
          <option value="negotiating">Negotiating</option>
          <option value="contacted">Contacted</option>
          <option value="responded">Responded</option>
          <option value="declined">Declined</option>
        </select>
      </div>

      <div class="form-group">
        <label>Source</label>
        <select id="existingOrgSource" style="width: 100%; padding: var(--space-2.5);">
          <option value="inbound" selected>Inbound (they found us)</option>
          <option value="aao_launch_list">AAO Launch List</option>
          <option value="slack">Slack</option>
          <option value="referral">Referral</option>
        </select>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeMarkExistingModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="markExistingAsProspect()" id="markExistingBtn">Add to Pipeline</button>
      </div>
    </div>
  </div>

  <script>
    let allProspects = [];
    let filteredProspects = [];
    let allOrganizations = [];

    async function loadProspects() {
      try {
        const [prospectsRes, orgsRes, statsRes] = await Promise.all([
          fetch('/api/admin/prospects'),
          fetch('/api/admin/organizations'),
          fetch('/api/admin/prospects/stats')
        ]);

        if (!prospectsRes.ok || !orgsRes.ok) {
          if (prospectsRes.status === 401 || orgsRes.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          throw new Error('Failed to load data');
        }

        allProspects = await prospectsRes.json();
        allOrganizations = await orgsRes.json();
        const stats = await statsRes.json();

        filteredProspects = allProspects;
        renderProspects();
        renderStats(stats);
        populateParentDropdown();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch (error) {
        console.error('Error loading prospects:', error);
        document.getElementById('loading').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load prospects. <a href="/auth/login">Try logging in again</a></p>';
      }
    }

    function renderStats(stats) {
      const container = document.getElementById('pipelineStats');

      const statusOrder = ['prospect', 'contacted', 'responded', 'interested', 'negotiating', 'joined', 'declined'];
      const statusLabels = {
        prospect: 'Prospect',
        contacted: 'Contacted',
        responded: 'Responded',
        interested: 'Interested',
        negotiating: 'Negotiating',
        joined: 'Joined',
        declined: 'Declined'
      };

      let html = `
        <div class="stat-item">
          <div class="stat-count">${stats.total}</div>
          <div class="stat-label">Total</div>
        </div>
      `;

      statusOrder.forEach(status => {
        const item = stats.by_status.find(s => s.prospect_status === status);
        const count = item ? item.count : 0;
        html += `
          <div class="stat-item">
            <div class="stat-count">${count}</div>
            <div class="stat-label">${statusLabels[status]}</div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function populateParentDropdown() {
      const select = document.getElementById('prospectParent');
      select.innerHTML = '<option value="">None (standalone company)</option>';

      allOrganizations
        .filter(org => !org.prospect_status || org.prospect_status === 'joined')
        .forEach(org => {
          select.innerHTML += `<option value="${org.workos_organization_id}">${org.name}</option>`;
        });
    }

    function applyFilters() {
      const statusFilter = document.getElementById('filterStatus').value;
      const ownerFilter = document.getElementById('filterOwner').value;
      const typeFilter = document.getElementById('filterType').value;
      const sourceFilter = document.getElementById('filterSource').value;
      const membersFilter = document.getElementById('filterMembers').value;
      const searchFilter = document.getElementById('filterSearch').value.toLowerCase();

      filteredProspects = allProspects.filter(prospect => {
        if (statusFilter && prospect.prospect_status !== statusFilter) return false;
        if (ownerFilter && prospect.prospect_owner !== ownerFilter) return false;
        if (typeFilter && prospect.company_type !== typeFilter) return false;
        if (sourceFilter && prospect.prospect_source !== sourceFilter) return false;
        if (membersFilter === 'yes' && !prospect.has_members) return false;
        if (membersFilter === 'no' && prospect.has_members) return false;
        if (searchFilter && !prospect.name.toLowerCase().includes(searchFilter)) return false;
        return true;
      });

      renderProspects();
    }

    function renderProspects() {
      const tbody = document.getElementById('prospectsTableBody');
      const countDiv = document.getElementById('prospectsCount');

      countDiv.textContent = `Showing ${filteredProspects.length} of ${allProspects.length} prospects`;

      if (filteredProspects.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: var(--space-10); color: var(--color-text-secondary);">No prospects found</td></tr>';
        return;
      }

      const typeLabels = {
        adtech: 'Ad Tech',
        agency: 'Agency',
        brand: 'Brand',
        publisher: 'Publisher'
      };

      tbody.innerHTML = filteredProspects.map(prospect => {
        const statusClass = `status-${prospect.prospect_status}`;

        // Company name with badges
        let companyHtml = `<strong>${prospect.name}</strong>`;
        if (prospect.has_members) {
          companyHtml += `<span class="member-badge">${prospect.member_count} member${prospect.member_count !== 1 ? 's' : ''}</span>`;
        }
        if (prospect.parent_name) {
          companyHtml += `<br><small style="color: var(--color-text-muted);">Subsidiary of ${prospect.parent_name}</small>`;
        }
        if (prospect.subsidiary_count > 0) {
          companyHtml += `<span class="parent-badge">${prospect.subsidiary_count} subsidiaries</span>`;
        }

        // Type
        const typeHtml = prospect.company_type ? typeLabels[prospect.company_type] || prospect.company_type : '<span style="color: var(--color-text-muted);">-</span>';

        // Owner
        const ownerHtml = prospect.prospect_owner || '<span style="color: var(--color-text-muted);">-</span>';

        // Contact info
        let contactHtml = '-';
        if (prospect.prospect_contact_name || prospect.prospect_contact_email) {
          contactHtml = '';
          if (prospect.prospect_contact_name) {
            contactHtml += prospect.prospect_contact_name;
            if (prospect.prospect_contact_title) {
              contactHtml += `<br><small style="color: var(--color-text-muted);">${prospect.prospect_contact_title}</small>`;
            }
          }
          if (prospect.prospect_contact_email) {
            contactHtml += `<br><a href="mailto:${prospect.prospect_contact_email}" style="font-size: var(--text-xs);">${prospect.prospect_contact_email}</a>`;
          }
        }

        // Next action with date styling
        let nextActionHtml = '-';
        if (prospect.prospect_next_action) {
          nextActionHtml = prospect.prospect_next_action;
          if (prospect.prospect_next_action_date) {
            const actionDate = new Date(prospect.prospect_next_action_date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const daysUntil = Math.floor((actionDate - today) / (1000 * 60 * 60 * 24));

            let dateClass = '';
            if (daysUntil < 0) dateClass = 'next-action-overdue';
            else if (daysUntil <= 3) dateClass = 'next-action-due';

            nextActionHtml += `<br><small class="${dateClass}">${actionDate.toLocaleDateString()}</small>`;
          }
        }

        return `
          <tr class="${prospect.has_members ? 'has-members' : ''}">
            <td>${companyHtml}</td>
            <td>${typeHtml}</td>
            <td><span class="status-badge ${statusClass}">${prospect.prospect_status}</span></td>
            <td>${ownerHtml}</td>
            <td>${contactHtml}</td>
            <td>${nextActionHtml}</td>
            <td>
              <button class="btn-icon" onclick="editProspect('${prospect.workos_organization_id}')" title="Edit">Edit</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Modal functions
    function openAddProspectModal() {
      document.getElementById('prospectModalTitle').textContent = 'Add Prospect';
      document.getElementById('prospectForm').reset();
      document.getElementById('editOrgId').value = '';
      document.getElementById('prospectCompanyType').value = '';
      document.getElementById('prospectOwner').value = '';
      document.getElementById('prospectStatus').value = 'prospect';
      document.getElementById('prospectSource').value = 'aao_launch_list';
      document.getElementById('prospectDomain').disabled = false;
      document.getElementById('prospectName').disabled = false;
      document.getElementById('prospectModal').style.display = 'block';
    }

    function editProspect(orgId) {
      const prospect = allProspects.find(p => p.workos_organization_id === orgId);
      if (!prospect) return;

      document.getElementById('prospectModalTitle').textContent = 'Edit Prospect';
      document.getElementById('editOrgId').value = orgId;
      document.getElementById('prospectName').value = prospect.name;
      document.getElementById('prospectName').disabled = true; // Can't rename WorkOS org easily
      document.getElementById('prospectDomain').value = ''; // Domain already set in WorkOS
      document.getElementById('prospectDomain').disabled = true;
      document.getElementById('prospectCompanyType').value = prospect.company_type || '';
      document.getElementById('prospectOwner').value = prospect.prospect_owner || '';
      document.getElementById('prospectStatus').value = prospect.prospect_status || 'prospect';
      document.getElementById('prospectSource').value = prospect.prospect_source || 'aao_launch_list';
      document.getElementById('prospectParent').value = prospect.parent_organization_id || '';
      document.getElementById('prospectContactName').value = prospect.prospect_contact_name || '';
      document.getElementById('prospectContactEmail').value = prospect.prospect_contact_email || '';
      document.getElementById('prospectContactTitle').value = prospect.prospect_contact_title || '';
      document.getElementById('prospectNextAction').value = prospect.prospect_next_action || '';
      document.getElementById('prospectNextActionDate').value = prospect.prospect_next_action_date ? prospect.prospect_next_action_date.split('T')[0] : '';
      document.getElementById('prospectNotes').value = prospect.prospect_notes || '';

      document.getElementById('prospectModal').style.display = 'block';
    }

    function closeProspectModal() {
      document.getElementById('prospectModal').style.display = 'none';
    }

    async function saveProspect(event) {
      event.preventDefault();

      const orgId = document.getElementById('editOrgId').value;
      const isEdit = !!orgId;

      const data = {
        name: document.getElementById('prospectName').value,
        domain: document.getElementById('prospectDomain').value || null,
        company_type: document.getElementById('prospectCompanyType').value || null,
        prospect_owner: document.getElementById('prospectOwner').value || null,
        prospect_status: document.getElementById('prospectStatus').value,
        prospect_source: document.getElementById('prospectSource').value,
        parent_organization_id: document.getElementById('prospectParent').value || null,
        prospect_contact_name: document.getElementById('prospectContactName').value || null,
        prospect_contact_email: document.getElementById('prospectContactEmail').value || null,
        prospect_contact_title: document.getElementById('prospectContactTitle').value || null,
        prospect_next_action: document.getElementById('prospectNextAction').value || null,
        prospect_next_action_date: document.getElementById('prospectNextActionDate').value || null,
        prospect_notes: document.getElementById('prospectNotes').value || null
      };

      const btn = document.getElementById('saveProspectBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const url = isEdit ? `/api/admin/prospects/${orgId}` : '/api/admin/prospects';
        const method = isEdit ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          const error = await response.json();
          throw new Error(error.message || 'Failed to save prospect');
        }

        closeProspectModal();
        loadProspects();
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Prospect';
      }
    }

    // Bulk import
    function openBulkImportModal() {
      document.getElementById('bulkCsvData').value = '';
      document.getElementById('importResults').style.display = 'none';
      document.getElementById('bulkModal').style.display = 'block';
    }

    function closeBulkImportModal() {
      document.getElementById('bulkModal').style.display = 'none';
    }

    // Parse CSV line handling quoted fields
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    // Map category to company_type
    function mapCategoryToType(category) {
      if (!category) return null;
      const cat = category.toLowerCase();
      if (cat.includes('ad tech') || cat.includes('adtech')) return 'adtech';
      if (cat.includes('agency')) return 'agency';
      if (cat.includes('brand')) return 'brand';
      if (cat.includes('publisher')) return 'publisher';
      return null;
    }

    async function runBulkImport() {
      const csvData = document.getElementById('bulkCsvData').value.trim();
      if (!csvData) {
        alert('Please paste CSV data');
        return;
      }

      const lines = csvData.split('\n').filter(line => line.trim());
      if (lines.length === 0) {
        alert('No data to import');
        return;
      }

      // Check if first line is a header row
      const firstLine = lines[0].toLowerCase();
      const hasHeader = firstLine.includes('company') || firstLine.includes('name') || firstLine.includes('category');
      let headers = null;
      let dataLines = lines;

      if (hasHeader) {
        headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim());
        dataLines = lines.slice(1);
      }

      // Column mapping for your specific CSV format
      const columnMap = {
        'company': 'name',
        'name': 'name',
        'category': 'company_type',
        'company_type': 'company_type',
        'type': 'company_type',
        'who owns outreach': 'prospect_owner',
        'owner': 'prospect_owner',
        'prospect_owner': 'prospect_owner',
        'steerco - names': 'prospect_contact_name',
        'contact': 'prospect_contact_name',
        'prospect_contact_name': 'prospect_contact_name',
        'description': 'prospect_notes',
        'notes': 'prospect_notes',
        'prospect_notes': 'prospect_notes',
        'domain': 'domain',
        'source': 'prospect_source',
        'prospect_source': 'prospect_source'
      };

      const prospects = dataLines.map(line => {
        const parts = parseCSVLine(line);

        if (headers) {
          // Map by header names
          const prospect = {
            prospect_source: 'aao_launch_list'
          };
          headers.forEach((header, idx) => {
            const field = columnMap[header];
            if (field && parts[idx]) {
              if (field === 'company_type') {
                prospect[field] = mapCategoryToType(parts[idx]);
              } else {
                prospect[field] = parts[idx];
              }
            }
          });
          return prospect;
        } else {
          // Basic format: name, domain, company_type, prospect_owner, prospect_contact_name, prospect_notes
          return {
            name: parts[0],
            domain: parts[1] || null,
            company_type: mapCategoryToType(parts[2]),
            prospect_owner: parts[3] || null,
            prospect_contact_name: parts[4] || null,
            prospect_notes: parts[5] || null,
            prospect_source: 'aao_launch_list'
          };
        }
      }).filter(p => p.name); // Filter out rows without names

      const btn = document.getElementById('runImportBtn');
      btn.disabled = true;
      btn.textContent = 'Importing...';

      try {
        const response = await fetch('/api/admin/prospects/bulk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prospects })
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          throw new Error('Import failed');
        }

        const result = await response.json();

        // Show results
        const resultsDiv = document.getElementById('importResults');
        let html = `<strong>Imported: ${result.imported}</strong> | Failed: ${result.failed}<br><br>`;

        if (result.results.success.length > 0) {
          html += '<div class="import-success">Success:<br>';
          result.results.success.forEach(s => {
            html += `&nbsp;&nbsp;${s.name}${s.domain ? ` (${s.domain})` : ''}<br>`;
          });
          html += '</div>';
        }

        if (result.results.errors.length > 0) {
          html += '<div class="import-error" style="margin-top: var(--space-2);">Errors:<br>';
          result.results.errors.forEach(e => {
            html += `&nbsp;&nbsp;${e.name}: ${e.error}<br>`;
          });
          html += '</div>';
        }

        resultsDiv.innerHTML = html;
        resultsDiv.style.display = 'block';

        // Refresh list
        loadProspects();
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Import';
      }
    }

    // Mark existing org as prospect
    function openMarkExistingModal() {
      const select = document.getElementById('existingOrgSelect');
      select.innerHTML = '<option value="">Select an organization...</option>';

      // Filter to orgs not already in prospect pipeline
      const prospectOrgIds = new Set(allProspects.map(p => p.workos_organization_id));
      const availableOrgs = allOrganizations.filter(org => !prospectOrgIds.has(org.workos_organization_id));

      if (availableOrgs.length === 0) {
        select.innerHTML = '<option value="">All organizations are already in the pipeline</option>';
      } else {
        availableOrgs.forEach(org => {
          select.innerHTML += `<option value="${org.workos_organization_id}">${org.name}</option>`;
        });
      }

      document.getElementById('existingOrgDomain').value = '';
      document.getElementById('existingOrgStatus').value = 'interested';
      document.getElementById('existingOrgSource').value = 'inbound';
      document.getElementById('markExistingModal').style.display = 'block';
    }

    function closeMarkExistingModal() {
      document.getElementById('markExistingModal').style.display = 'none';
    }

    async function markExistingAsProspect() {
      const orgId = document.getElementById('existingOrgSelect').value;
      if (!orgId) {
        alert('Please select an organization');
        return;
      }

      const domain = document.getElementById('existingOrgDomain').value.trim() || null;
      const status = document.getElementById('existingOrgStatus').value;
      const source = document.getElementById('existingOrgSource').value;

      const btn = document.getElementById('markExistingBtn');
      btn.disabled = true;
      btn.textContent = 'Adding...';

      try {
        const response = await fetch(`/api/admin/prospects/${orgId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prospect_status: status,
            prospect_source: source,
            domain: domain
          })
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          throw new Error('Failed to update organization');
        }

        closeMarkExistingModal();
        loadProspects();
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Add to Pipeline';
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }

    // Initialize
    loadProspects();
  </script>
</body>
</html>
