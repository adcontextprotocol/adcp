<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My organization - Dashboard</title>
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <link rel="stylesheet" href="/design-system.css">
  <script src="/nav.js"></script>
  <script src="/dashboard-nav.js"></script>
  <style>
    body {
      background: var(--color-bg-page);
    }

    .hub-container {
      max-width: var(--container-xl);
      margin: 0 auto;
      padding: var(--space-8) var(--space-4);
    }

    /* =========================================================================
       Header
       ========================================================================= */
    .hub-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-6);
      margin-bottom: var(--space-8);
      flex-wrap: wrap;
    }

    .hub-header-left { flex: 1; min-width: 0; }

    .hub-header h1 {
      font-size: var(--text-3xl);
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
      margin-bottom: var(--space-2);
    }

    .hub-header-meta {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    .level-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      background: var(--color-primary-100);
      color: var(--color-brand);
    }

    .level-badge-num {
      font-size: var(--text-xs);
      opacity: 0.7;
    }

    .stage-desc {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }

    /* Score ring */
    .score-ring {
      position: relative;
      width: 80px;
      height: 80px;
      flex-shrink: 0;
    }
    .score-ring svg { transform: rotate(-90deg); }
    .score-ring-bg { fill: none; stroke: var(--color-gray-200); stroke-width: 6; }
    .score-ring-fill { fill: none; stroke-width: 6; stroke-linecap: round; transition: stroke-dashoffset 0.8s var(--ease-out); }
    .score-ring-label {
      position: absolute; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    .score-ring-value { font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--color-text-heading); line-height: var(--leading-none); }
    .score-ring-caption { font-size: 10px; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: var(--tracking-wider); }

    /* =========================================================================
       Journey card with levels
       ========================================================================= */
    .journey-card {
      background: var(--color-bg-card);
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--card-radius);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
    }

    .journey-card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: var(--space-5);
    }

    .journey-card-title {
      font-size: var(--text-lg);
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
    }

    .next-level-hint {
      font-size: var(--text-sm);
      color: var(--color-brand);
    }

    /* Level stepper */
    .level-stepper {
      display: flex;
      align-items: flex-start;
      gap: 0;
      margin-bottom: var(--space-6);
      overflow-x: auto;
      padding-bottom: var(--space-2);
      -webkit-overflow-scrolling: touch;
    }

    .level-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      min-width: 72px;
      position: relative;
    }

    .level-step-dot {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      border: var(--border-2) solid var(--color-gray-300);
      background: var(--color-bg-card);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 1;
      font-size: var(--text-xs);
      font-weight: var(--font-bold);
      color: var(--color-text-muted);
      transition: var(--transition-all);
    }

    .level-step--completed .level-step-dot {
      background: var(--color-brand);
      border-color: var(--color-brand);
      color: white;
    }

    .level-step--current .level-step-dot {
      background: var(--color-brand);
      border-color: var(--color-brand);
      color: white;
      box-shadow: 0 0 0 4px var(--color-primary-100);
    }

    .level-step-label {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-2);
      text-align: center;
      text-transform: capitalize;
    }

    .level-step--completed .level-step-label,
    .level-step--current .level-step-label {
      color: var(--color-text-heading);
      font-weight: var(--font-medium);
    }

    .level-step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 16px;
      left: calc(50% + 16px);
      right: calc(-50% + 16px);
      height: 2px;
      background: var(--color-gray-200);
      z-index: 0;
    }

    .level-step--completed:not(:last-child)::after { background: var(--color-brand); }

    /* Achievements grid */
    .achievements-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-3);
    }

    .achievement {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-lg);
      transition: var(--transition-all);
    }

    .achievement--earned {
      background: var(--color-success-50);
      border: var(--border-1) solid var(--color-success-200);
    }

    .achievement--locked {
      background: var(--color-bg-subtle);
      border: var(--border-1) dashed var(--color-border);
    }

    .achievement-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-lg);
      flex-shrink: 0;
    }

    .achievement--earned .achievement-icon {
      background: var(--color-success-100);
    }

    .achievement--locked .achievement-icon {
      background: var(--color-gray-100);
      filter: grayscale(1);
      opacity: 0.5;
    }

    .achievement-body { flex: 1; min-width: 0; }

    .achievement-name {
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      margin-bottom: 2px;
    }

    .achievement--locked .achievement-name { color: var(--color-text-secondary); }

    .achievement-desc {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
    }

    .achievement-action {
      font-size: var(--text-xs);
      color: var(--color-brand);
      text-decoration: none;
      font-weight: var(--font-medium);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .achievement-action:hover { text-decoration: underline; }

    /* =========================================================================
       Grid
       ========================================================================= */
    .hub-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-6);
      margin-bottom: var(--space-6);
    }

    /* =========================================================================
       Cards
       ========================================================================= */
    .hub-card {
      background: var(--color-bg-card);
      border: var(--border-1) solid var(--color-border);
      border-radius: var(--card-radius);
      padding: var(--space-6);
    }

    .hub-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-5);
    }

    .hub-card-title {
      font-size: var(--text-lg);
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
    }

    .hub-card-link {
      font-size: var(--text-sm);
      color: var(--color-brand);
      text-decoration: none;
      font-weight: var(--font-medium);
    }

    .hub-card-link:hover { text-decoration: underline; }

    /* =========================================================================
       Persona
       ========================================================================= */
    .persona-display { text-align: center; padding: var(--space-4) 0; }

    .persona-icon {
      width: 56px; height: 56px;
      border-radius: var(--radius-xl);
      display: flex; align-items: center; justify-content: center;
      font-size: var(--text-2xl);
      margin: 0 auto var(--space-4);
    }

    .persona--molecule_builder  { --p-bg: var(--color-primary-100); --p-text: var(--color-primary-700); }
    .persona--data_decoder      { --p-bg: var(--color-success-100); --p-text: var(--color-success-700); }
    .persona--pureblood_protector { --p-bg: var(--color-error-100); --p-text: var(--color-error-700); }
    .persona--resops_integrator { --p-bg: var(--color-warning-100); --p-text: var(--color-warning-700); }
    .persona--ladder_climber    { --p-bg: var(--color-info-100); --p-text: var(--color-info-700); }
    .persona--simple_starter    { --p-bg: var(--color-gray-100); --p-text: var(--color-gray-600); }

    .persona-icon { background: var(--p-bg, var(--color-gray-100)); color: var(--p-text, var(--color-gray-600)); }

    .persona-name { font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--color-text-heading); margin-bottom: var(--space-1); }
    .persona-desc { font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: var(--space-3); }
    .persona-source { font-size: var(--text-xs); color: var(--color-text-muted); }
    .persona-aspiration { font-size: var(--text-xs); color: var(--color-brand); margin-top: var(--space-2); }

    .persona-cta { text-align: center; padding: var(--space-6) var(--space-4); }
    .persona-cta-icon {
      width: 56px; height: 56px;
      border-radius: var(--radius-xl);
      background: var(--color-gray-100);
      display: flex; align-items: center; justify-content: center;
      font-size: var(--text-2xl);
      margin: 0 auto var(--space-4);
      color: var(--color-text-muted);
    }
    .persona-cta p { font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4); }

    /* =========================================================================
       Group recommendations
       ========================================================================= */
    .group-rec-count { font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4); }

    .group-rec-item {
      display: flex; align-items: center; gap: var(--space-3);
      padding: var(--space-3) 0;
      border-bottom: var(--border-1) solid var(--color-border);
    }
    .group-rec-item:last-child { border-bottom: none; }

    .group-rec-info { flex: 1; min-width: 0; }
    .group-rec-name { font-size: var(--text-sm); font-weight: var(--font-semibold); color: var(--color-text-heading); margin-bottom: var(--space-0.5); }
    .group-rec-reason { font-size: var(--text-xs); color: var(--color-text-muted); }

    .group-rec-badge {
      display: inline-flex;
      padding: var(--space-0.5) var(--space-2);
      border-radius: var(--badge-radius);
      font-size: 10px; font-weight: var(--font-semibold);
      text-transform: uppercase; letter-spacing: var(--tracking-wide);
      background: var(--color-gray-100); color: var(--color-gray-600);
      flex-shrink: 0;
    }

    .group-rec-link { font-size: var(--text-xs); color: var(--color-brand); text-decoration: none; font-weight: var(--font-medium); white-space: nowrap; flex-shrink: 0; }
    .group-rec-link:hover { text-decoration: underline; }

    /* =========================================================================
       Public profile card
       ========================================================================= */
    .profile-card-body { display: flex; flex-direction: column; gap: var(--space-4); }

    .profile-completeness { margin-bottom: var(--space-2); }

    .profile-completeness-label {
      display: flex; justify-content: space-between;
      font-size: var(--text-xs); color: var(--color-text-secondary);
      margin-bottom: var(--space-2);
    }

    .profile-completeness-bar {
      height: 6px;
      border-radius: var(--radius-full);
      background: var(--color-gray-200);
      overflow: hidden;
    }

    .profile-completeness-fill {
      height: 100%;
      border-radius: var(--radius-full);
      background: var(--color-brand);
      transition: width 0.6s var(--ease-out);
    }

    .profile-completeness-fill--full { background: var(--color-success-500); }

    .profile-field {
      display: flex; gap: var(--space-3); align-items: flex-start;
    }

    .profile-field-label {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: var(--tracking-wide);
      min-width: 64px;
      flex-shrink: 0;
      padding-top: 2px;
    }

    .profile-field-value {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .profile-field-value--empty { color: var(--color-text-muted); font-style: italic; }

    .profile-logo-preview {
      display: flex; gap: var(--space-2); align-items: center;
    }

    .profile-logo-preview img {
      max-height: 28px;
      max-width: 80px;
      object-fit: contain;
    }

    .profile-logo-placeholder {
      width: 48px; height: 28px;
      background: var(--color-gray-100);
      border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      font-size: var(--text-xs); color: var(--color-text-muted);
    }

    .profile-offerings {
      display: flex; flex-wrap: wrap; gap: var(--space-1);
    }

    .profile-offering-tag {
      display: inline-flex;
      padding: 2px var(--space-2);
      border-radius: var(--badge-radius);
      font-size: 11px;
      background: var(--color-primary-100);
      color: var(--color-primary-700);
    }

    /* =========================================================================
       Activity
       ========================================================================= */
    .activity-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); }

    .activity-metric {
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      background: var(--color-bg-subtle);
    }

    .activity-metric:nth-child(1) { background: var(--color-primary-50); }
    .activity-metric:nth-child(2) { background: var(--color-success-50); }
    .activity-metric:nth-child(3) { background: var(--color-warning-50); }
    .activity-metric:nth-child(4) { background: var(--color-info-50); }

    .activity-value { font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--color-text-heading); line-height: var(--leading-tight); margin-bottom: var(--space-1); }
    .activity-label { font-size: var(--text-xs); color: var(--color-text-secondary); }

    /* =========================================================================
       Timeline
       ========================================================================= */
    .timeline { position: relative; padding-left: var(--space-6); }
    .timeline::before { content: ''; position: absolute; left: 8px; top: 4px; bottom: 4px; width: 2px; background: var(--color-gray-200); }

    .timeline-entry { position: relative; padding-bottom: var(--space-5); }
    .timeline-entry:last-child { padding-bottom: 0; }

    .timeline-dot {
      position: absolute;
      left: calc(-1 * var(--space-6) + 4px); top: 2px;
      width: 10px; height: 10px;
      border-radius: var(--radius-full);
      background: var(--color-brand);
      border: var(--border-2) solid var(--color-bg-card);
    }

    .timeline-date { font-size: var(--text-xs); color: var(--color-text-muted); margin-bottom: var(--space-1); }
    .timeline-transition { font-size: var(--text-sm); color: var(--color-text-heading); font-weight: var(--font-medium); margin-bottom: var(--space-0.5); }
    .timeline-trigger { font-size: var(--text-xs); color: var(--color-text-secondary); }
    .timeline-empty { font-size: var(--text-sm); color: var(--color-text-muted); text-align: center; padding: var(--space-6) 0; }

    .stage-badge {
      display: inline-flex;
      align-items: center;
      padding: 1px var(--space-2);
      border-radius: var(--badge-radius);
      font-size: 10px; font-weight: var(--font-semibold);
      text-transform: capitalize; letter-spacing: var(--tracking-wide);
      background: var(--color-primary-100); color: var(--color-brand);
    }

    /* =========================================================================
       Content contributions
       ========================================================================= */
    .content-table { width: 100%; border-collapse: collapse; }
    .content-table th {
      text-align: left; font-size: var(--text-xs); font-weight: var(--font-semibold);
      color: var(--color-text-muted); text-transform: uppercase; letter-spacing: var(--tracking-wide);
      padding: var(--space-2) var(--space-3); border-bottom: var(--border-2) solid var(--color-border);
    }
    .content-table td { font-size: var(--text-sm); color: var(--color-text-secondary); padding: var(--space-3); border-bottom: var(--border-1) solid var(--color-border); }
    .content-table tr:last-child td { border-bottom: none; }
    .content-title { font-weight: var(--font-medium); color: var(--color-text-heading); }

    .status-badge {
      display: inline-flex;
      padding: var(--space-0.5) var(--space-2);
      border-radius: var(--badge-radius);
      font-size: 10px; font-weight: var(--font-semibold);
      text-transform: uppercase; letter-spacing: var(--tracking-wide);
    }
    .status-badge--published { background: var(--color-success-100); color: var(--color-success-700); }
    .status-badge--pending_review { background: var(--color-warning-100); color: var(--color-warning-700); }
    .status-badge--draft { background: var(--color-gray-100); color: var(--color-gray-600); }

    /* =========================================================================
       Loading / empty
       ========================================================================= */
    .hub-loading {
      text-align: center; padding: var(--space-16); color: var(--color-text-muted);
    }
    .hub-loading .spinner {
      width: 32px; height: 32px;
      border: 3px solid var(--color-border); border-top-color: var(--color-brand);
      border-radius: var(--radius-full);
      animation: spin 1s linear infinite;
      margin: 0 auto var(--space-4);
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hub-empty { text-align: center; padding: var(--space-6); color: var(--color-text-muted); font-size: var(--text-sm); }
    .hub-empty a { color: var(--color-brand); text-decoration: none; font-weight: var(--font-medium); }
    .hub-empty a:hover { text-decoration: underline; }

    /* =========================================================================
       Responsive
       ========================================================================= */
    @media (max-width: 768px) {
      .hub-grid { grid-template-columns: 1fr; }
      .hub-header { flex-direction: column; align-items: flex-start; }
      .score-ring { align-self: flex-start; }
      .achievements-grid { grid-template-columns: 1fr; }
      .activity-grid { grid-template-columns: 1fr 1fr; }

      .content-table thead { display: none; }
      .content-table, .content-table tbody, .content-table tr, .content-table td { display: block; }
      .content-table tr { padding: var(--space-3) 0; border-bottom: var(--border-1) solid var(--color-border); }
      .content-table td { padding: var(--space-1) var(--space-3); border-bottom: none; }
      .content-table td::before { content: attr(data-label); font-size: var(--text-xs); color: var(--color-text-muted); text-transform: uppercase; letter-spacing: var(--tracking-wide); display: block; margin-bottom: var(--space-0.5); }
    }
  </style>
</head>
<body>
  <!-- AAO top navigation -->
  <div id="adcp-nav"></div>

  <div class="hub-container">
    <div id="hub-loading" class="hub-loading">
      <div class="spinner"></div>
      <p>Loading your member hub...</p>
    </div>

    <div id="hub-content" style="display: none;"></div>
  </div>

  <div id="adcp-footer"></div>

  <script>
    const config = window.__APP_CONFIG__ || {};
    if (!config.user) {
      window.location.href = '/auth/login?return_to=/dashboard/organization';
    }

    document.addEventListener('DOMContentLoaded', loadHub);

    async function loadHub() {
      try {
        const [meRes, engRes, profileRes] = await Promise.all([
          fetch('/api/me', { credentials: 'include' }),
          fetch('/api/me/engagement', { credentials: 'include' }),
          fetch('/api/me/member-profile', { credentials: 'include' }),
        ]);

        if (!engRes.ok) {
          if (engRes.status === 401) {
            window.location.href = '/auth/login?return_to=/dashboard/organization';
            return;
          }
          if (engRes.status === 404) {
            document.getElementById('hub-loading').innerHTML =
              '<p style="color:var(--color-text-secondary)">Your account is not yet associated with a member organization. ' +
              '<a href="/membership">Learn about membership</a>.</p>';
            return;
          }
          throw new Error('Failed to load engagement data');
        }

        const data = await engRes.json();
        const profileData = profileRes.ok ? await profileRes.json() : null;

        // Init dashboard sidebar
        const meData = meRes.ok ? await meRes.json() : null;
        const orgs = meData?.organizations || [];
        const { org: currentOrg } = DashboardNav.resolveOrg(orgs);
        DashboardNav.init({
          showOrgSwitcher: orgs.length > 1,
          currentOrgName: currentOrg?.name || data.organization_name || 'My organization',
          showAdmin: meData?.isAdmin || false,
          orgId: currentOrg?.id || null,
        });

        renderHub(data, profileData?.profile || null, currentOrg?.id || null);
      } catch (err) {
        console.error('Hub load error:', err);
        document.getElementById('hub-loading').innerHTML =
          '<p>Failed to load. <a href="/dashboard/organization">Try again</a></p>';
      }
    }

    // =========================================================================
    // Constants
    // =========================================================================

    const STAGES = [
      'aware', 'evaluating', 'joined', 'onboarding',
      'participating', 'contributing', 'leading', 'advocating',
    ];

    const STAGE_DESCS = {
      aware:         'Just getting started',
      evaluating:    'Exploring what\'s possible',
      joined:        'Welcome to AAO',
      onboarding:    'Getting oriented',
      participating: 'Active in working groups',
      contributing:  'Creating content and sharing expertise',
      leading:       'Taking on leadership',
      advocating:    'Championing the community externally',
    };

    // What earns you the NEXT stage transition
    const NEXT_LEVEL_REQUIREMENTS = {
      aware:         'Complete your member profile to get started',
      evaluating:    'Complete your member profile to get started',
      joined:        'Set up your member profile to begin onboarding',
      onboarding:    'Join a working group and complete your profile',
      participating: 'Publish content or take on a leadership role',
      contributing:  'Become a chair or vice-chair of a working group',
      leading:       'Recruit other members and represent AAO externally',
      advocating:    'You\'ve reached the highest level of engagement',
    };

    const PERSONA_CFG = {
      molecule_builder:     { label: 'Molecular Gastronomist', desc: 'Building and integrating ad tech components',              icon: 'âš™' },
      data_decoder:         { label: 'Data Denizen',            desc: 'Driven by data, measurement, and optimization',           icon: 'ðŸ“ˆ' },
      pureblood_protector:  { label: 'Mold Breaker',            desc: 'Champions brand safety, quality, and trust',              icon: 'ðŸ›¡' },
      resops_integrator:    { label: 'RevOps Integrator',       desc: 'Streamlines operations and revenue workflows',             icon: 'ðŸ”„' },
      ladder_climber:       { label: 'Positionless Marketer',   desc: 'Seeking strategic industry visibility and leadership',     icon: 'ðŸŽ¯' },
      simple_starter:       { label: 'Simple Simon',            desc: 'Getting started with agentic advertising',                icon: 'ðŸŒ±' },
    };

    const SOURCE_LABELS = {
      user_reported: 'Self-reported',
      admin_set:     'Set by admin',
      diagnostic:    'From diagnostic',
      enrichment:    'Based on your activity',
      addie_inferred:'Based on your activity',
    };

    const TRIGGER_LABELS = {
      milestone_achieved:   'Milestone achieved',
      milestone_lost:       'Milestone lost',
      admin_override:       'Updated by admin',
      recomputation:        'Periodic review',
      initial:              'Initial assessment',
      membership_change:    'Group membership changed',
      leadership_change:    'Leadership role changed',
      content_contribution: 'Content contribution',
    };

    // =========================================================================
    // Render
    // =========================================================================

    function renderHub(data, profile, orgId) {
      const {
        organization_name, journey_stage, engagement_score,
        persona, persona_source, persona_aspiration,
        milestones, recommended_groups, current_group_count,
        activity, journey_history, content_contributions,
      } = data;

      document.getElementById('hub-loading').style.display = 'none';
      const el = document.getElementById('hub-content');
      el.style.display = 'block';

      // Members with no computed stage default to 'joined' â€” aware/evaluating are pre-membership
      const stage     = (!journey_stage || journey_stage === 'aware' || journey_stage === 'evaluating')
                          ? 'joined'
                          : journey_stage;
      const score     = engagement_score || 0;
      const stageIdx  = STAGES.indexOf(stage);
      const levelNum  = stageIdx + 1;
      const stageDesc = STAGE_DESCS[stage] || '';
      const nextReq   = NEXT_LEVEL_REQUIREMENTS[stage] || '';

      let ringColor;
      if (score < 30)       ringColor = 'var(--color-gray-400)';
      else if (score < 60)  ringColor = 'var(--color-brand)';
      else                  ringColor = 'var(--color-success-500)';

      const r = 34;
      const circ = 2 * Math.PI * r;
      const offset = circ - (score / 100) * circ;

      el.innerHTML = `
        <!-- Header -->
        <div class="hub-header">
          <div class="hub-header-left">
            <h1>${escapeHtml(organization_name || 'Your organization')}</h1>
            <div class="hub-header-meta">
              <span class="level-badge">
                <span class="level-badge-num">Lvl ${levelNum}</span>&nbsp;${escapeHtml(stage)}
              </span>
              <span class="stage-desc">${escapeHtml(stageDesc)}</span>
            </div>
          </div>
          <div class="score-ring" title="Engagement score: ${score}/100">
            <svg width="80" height="80" viewBox="0 0 80 80">
              <circle class="score-ring-bg" cx="40" cy="40" r="${r}" />
              <circle class="score-ring-fill" cx="40" cy="40" r="${r}"
                stroke="${ringColor}"
                stroke-dasharray="${circ}"
                stroke-dashoffset="${offset}" />
            </svg>
            <div class="score-ring-label">
              <span class="score-ring-value">${score}</span>
              <span class="score-ring-caption">Score</span>
            </div>
          </div>
        </div>

        <!-- Level progress -->
        ${renderLevelProgress(stage, stageIdx, levelNum, nextReq, milestones)}

        <!-- Grid row 1: Persona + Groups -->
        <div class="hub-grid">
          <div class="hub-card">${renderPersona(persona, persona_source, persona_aspiration)}</div>
          <div class="hub-card">${renderGroups(recommended_groups, current_group_count)}</div>
        </div>

        <!-- Grid row 2: Profile + Activity -->
        <div class="hub-grid">
          <div class="hub-card">${renderProfileCard(profile, orgId)}</div>
          <div class="hub-card">${renderActivity(activity)}</div>
        </div>

        <!-- Full-width: Timeline + Content -->
        <div class="hub-grid">
          <div class="hub-card">${renderTimeline(journey_history)}</div>
          <div class="hub-card">${renderContent(content_contributions)}</div>
        </div>
      `;
    }

    // -------------------------------------------------------------------------

    function renderLevelProgress(stage, stageIdx, levelNum, nextReq, milestones) {
      const steps = STAGES.map((s, i) => {
        let cls = 'level-step';
        if (i < stageIdx) cls += ' level-step--completed';
        else if (i === stageIdx) cls += ' level-step--current';
        const icon = i < stageIdx ? 'âœ“' : (i === stageIdx ? levelNum : i + 1);
        return `
          <div class="${cls}">
            <div class="level-step-dot">${icon}</div>
            <span class="level-step-label">${escapeHtml(s)}</span>
          </div>`;
      }).join('');

      const ms = milestones || {};
      const achievements = [
        { key: 'has_working_groups',      icon: 'ðŸ‘¥', label: 'Working group member',    desc: 'Joined at least one working group',     href: '/committees?type=working_group', action: 'Browse groups' },
        { key: 'has_content_proposals',   icon: 'âœ',  label: 'Content contributor',     desc: 'Proposed or published an article',      href: '/my-content',              action: 'Propose content' },
        { key: 'has_leadership',          icon: 'â­',  label: 'Group leader',            desc: 'Chair or vice-chair of a working group', href: '/committees?type=working_group', action: 'View openings' },
        { key: 'has_recruiting_activity', icon: 'ðŸ“£',  label: 'Community advocate',      desc: 'Invited a colleague to join AAO',       href: '/community/people',             action: 'Invite a colleague' },
      ];

      const achHtml = achievements.map(a => {
        const earned = !!ms[a.key];
        return `
          <div class="achievement achievement--${earned ? 'earned' : 'locked'}">
            <div class="achievement-icon">${a.icon}</div>
            <div class="achievement-body">
              <div class="achievement-name">${a.label}</div>
              <div class="achievement-desc">${a.desc}</div>
            </div>
            ${!earned ? `<a href="${a.href}" class="achievement-action">${a.action} â†’</a>` : ''}
          </div>`;
      }).join('');

      return `
        <div class="journey-card">
          <div class="journey-card-header">
            <span class="journey-card-title">Membership journey</span>
            ${nextReq ? `<span class="next-level-hint">${escapeHtml(nextReq)}</span>` : ''}
          </div>
          <div class="level-stepper">${steps}</div>
          <div class="achievements-grid">${achHtml}</div>
        </div>`;
    }

    // -------------------------------------------------------------------------

    function renderPersona(persona, source, aspiration) {
      const hdr = `<div class="hub-card-header"><span class="hub-card-title">Organization type</span></div>`;
      if (!persona) {
        return `${hdr}
          <div class="persona-cta">
            <div class="persona-cta-icon">?</div>
            <p>Discover your organization's type to unlock tailored group recommendations.</p>
            <a href="/persona-assessment" class="btn btn-ghost btn-sm">Take the assessment â†’</a>
          </div>`;
      }
      const cfg = PERSONA_CFG[persona] || { label: persona, desc: '', icon: '?' };
      const srcLabel = SOURCE_LABELS[source] || '';
      const aspCfg = aspiration && aspiration !== persona ? PERSONA_CFG[aspiration] : null;
      return `
        ${hdr}
        <div class="persona-display persona--${escapeHtml(persona)}">
          <div class="persona-icon">${cfg.icon}</div>
          <div class="persona-name">${escapeHtml(cfg.label)}</div>
          <div class="persona-desc">${escapeHtml(cfg.desc)}</div>
          ${srcLabel ? `<div class="persona-source">${escapeHtml(srcLabel)}</div>` : ''}
          ${aspCfg ? `<div class="persona-aspiration">Aspiring toward: ${escapeHtml(aspCfg.label)}</div>` : ''}
        </div>`;
    }

    // -------------------------------------------------------------------------

    function renderGroups(groups, currentCount) {
      const hdr = `
        <div class="hub-card-header">
          <span class="hub-card-title">Recommended groups</span>
          <a href="/committees?type=working_group" class="hub-card-link">View all â†’</a>
        </div>`;
      const countLine = currentCount > 0
        ? `<div class="group-rec-count">You're in ${currentCount} working group${currentCount !== 1 ? 's' : ''}</div>`
        : '';

      if (!groups || groups.length === 0) {
        return `${hdr}${countLine}
          <div class="hub-empty">
            <p>No recommendations right now.</p>
            <a href="/committees?type=working_group">Browse all working groups â†’</a>
          </div>`;
      }

      const items = groups.slice(0, 5).map(g => `
        <div class="group-rec-item">
          <div class="group-rec-info">
            <div class="group-rec-name">${escapeHtml(g.name)}</div>
            <div class="group-rec-reason">${escapeHtml(g.reason || '')}</div>
          </div>
          ${g.committee_type ? `<span class="group-rec-badge">${escapeHtml(g.committee_type)}</span>` : ''}
          <a href="/working-groups/${encodeURIComponent(g.slug)}" class="group-rec-link">Learn more â†’</a>
        </div>`).join('');

      return `${hdr}${countLine}${items}`;
    }

    // -------------------------------------------------------------------------

    function renderProfileCard(profile, orgId) {
      const profileUrl = orgId ? `/member-profile?org=${orgId}` : '/member-profile';
      const hdr = `
        <div class="hub-card-header">
          <span class="hub-card-title">Public profile</span>
          <a href="${profileUrl}" class="hub-card-link">Edit profile â†’</a>
        </div>`;

      if (!profile) {
        return `${hdr}
          <div class="hub-empty">
            <p>Your public profile isn't set up yet.</p>
            <a href="${profileUrl}">Create your profile â†’</a>
          </div>`;
      }

      // Calculate completeness
      let pts = 0;
      if (profile.display_name)  pts += 15;
      if (profile.description)   pts += 20;
      if (profile.logo_light_url || profile.logo_url) pts += 15;
      if (profile.offerings?.length > 0) pts += 15;
      if (profile.contact_email) pts += 10;
      if (profile.contact_website) pts += 10;
      if (profile.linkedin_url)  pts += 10;
      if (profile.tags?.length > 0) pts += 5;

      const pct = Math.min(pts, 100);
      const fillClass = pct === 100 ? 'profile-completeness-fill--full' : '';

      const logoUrl = profile.logo_light_url || profile.logo_url || null;
      const logoHtml = logoUrl
        ? `<img src="${escapeHtml(logoUrl)}" alt="Logo">`
        : `<div class="profile-logo-placeholder">No logo</div>`;

      const desc = profile.description
        ? profile.description.substring(0, 80) + (profile.description.length > 80 ? 'â€¦' : '')
        : null;

      const offeringsHtml = profile.offerings?.length > 0
        ? `<div class="profile-offerings">${profile.offerings.slice(0, 4).map(o =>
            `<span class="profile-offering-tag">${escapeHtml(o)}</span>`
          ).join('')}${profile.offerings.length > 4 ? `<span class="profile-offering-tag">+${profile.offerings.length - 4}</span>` : ''}</div>`
        : `<span class="profile-field-value profile-field-value--empty">None added</span>`;

      return `
        ${hdr}
        <div class="profile-card-body">
          <div class="profile-completeness">
            <div class="profile-completeness-label">
              <span>Profile completeness</span>
              <span>${pct}%</span>
            </div>
            <div class="profile-completeness-bar">
              <div class="profile-completeness-fill ${fillClass}" style="width: ${pct}%"></div>
            </div>
          </div>

          <div class="profile-field">
            <span class="profile-field-label">Logo</span>
            <div class="profile-logo-preview">${logoHtml}</div>
          </div>

          <div class="profile-field">
            <span class="profile-field-label">Name</span>
            <span class="profile-field-value">${escapeHtml(profile.display_name || '')}</span>
          </div>

          <div class="profile-field">
            <span class="profile-field-label">About</span>
            <span class="profile-field-value ${desc ? '' : 'profile-field-value--empty'}">
              ${desc ? escapeHtml(desc) : 'No description yet'}
            </span>
          </div>

          <div class="profile-field">
            <span class="profile-field-label">Offers</span>
            ${offeringsHtml}
          </div>
        </div>`;
    }

    // -------------------------------------------------------------------------

    function renderActivity(activity) {
      const a = activity || {};
      const hdr = `<div class="hub-card-header"><span class="hub-card-title">Activity</span></div>`;
      return `
        ${hdr}
        <div class="activity-grid">
          <div class="activity-metric">
            <div class="activity-value">${a.dashboard_logins_30d != null ? a.dashboard_logins_30d : 'â€”'}</div>
            <div class="activity-label">Logins (30d)</div>
          </div>
          <div class="activity-metric">
            <div class="activity-value">${a.working_group_count != null ? a.working_group_count : 'â€”'}</div>
            <div class="activity-label">Working groups</div>
          </div>
          <div class="activity-metric">
            <div class="activity-value">${a.email_clicks_30d != null ? a.email_clicks_30d : 'â€”'}</div>
            <div class="activity-label">Email clicks (30d)</div>
          </div>
          <div class="activity-metric">
            <div class="activity-value">${a.last_active ? relDate(a.last_active) : 'â€”'}</div>
            <div class="activity-label">Last active</div>
          </div>
        </div>`;
    }

    // -------------------------------------------------------------------------

    function renderTimeline(history) {
      const hdr = `<div class="hub-card-header"><span class="hub-card-title">Journey history</span></div>`;
      if (!history || history.length === 0) {
        return `${hdr}<div class="timeline-empty">Your journey starts here</div>`;
      }
      const entries = history.slice(0, 6).map(e => {
        const fromBadge = e.from_stage
          ? `<span class="stage-badge">${escapeHtml(e.from_stage)}</span>`
          : `<span class="stage-badge" style="background:var(--color-gray-100);color:var(--color-gray-500)">start</span>`;
        return `
          <div class="timeline-entry">
            <div class="timeline-dot"></div>
            <div class="timeline-date">${e.transitioned_at ? fmtDate(e.transitioned_at) : ''}</div>
            <div class="timeline-transition">${fromBadge} â†’ <span class="stage-badge">${escapeHtml(e.to_stage)}</span></div>
            <div class="timeline-trigger">${escapeHtml(TRIGGER_LABELS[e.trigger_type] || e.trigger_type)}</div>
          </div>`;
      }).join('');
      return `${hdr}<div class="timeline">${entries}</div>`;
    }

    // -------------------------------------------------------------------------

    function renderContent(contributions) {
      const hdr = `
        <div class="hub-card-header">
          <span class="hub-card-title">Content from your org</span>
          <a href="/my-content" class="hub-card-link">Manage â†’</a>
        </div>`;

      if (!contributions || contributions.length === 0) {
        return `${hdr}
          <div class="hub-empty">
            <p>No content yet.</p>
            <a href="/my-content">Propose content â†’</a>
          </div>`;
      }

      const statusCls = s => s === 'published' ? 'status-badge--published' : s === 'pending_review' ? 'status-badge--pending_review' : 'status-badge--draft';
      const statusLbl = s => s === 'published' ? 'Published' : s === 'pending_review' ? 'In review' : 'Draft';
      const typeLbl = t => t === 'link' ? 'Link' : 'Article';

      const rows = contributions.map(c => `
        <tr>
          <td data-label="Title">
            <span class="content-title">${escapeHtml(c.title)}</span>
            <span class="group-rec-badge" style="margin-left:var(--space-2)">${typeLbl(c.content_type)}</span>
          </td>
          <td data-label="Author">${escapeHtml(c.author || '')}</td>
          <td data-label="Date">${c.date ? fmtDate(c.date) : ''}</td>
          <td data-label="Status"><span class="status-badge ${statusCls(c.status)}">${statusLbl(c.status)}</span></td>
        </tr>`).join('');

      return `
        ${hdr}
        <table class="content-table">
          <thead><tr><th>Title</th><th>Author</th><th>Date</th><th>Status</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    // =========================================================================
    // Utilities
    // =========================================================================

    function escapeHtml(str) {
      if (!str) return '';
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    function fmtDate(s) {
      try { return new Date(s).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
      catch { return String(s); }
    }

    function relDate(s) {
      try {
        const d = Math.floor((Date.now() - new Date(s)) / 86400000);
        if (d === 0) return 'Today';
        if (d === 1) return '1 day ago';
        if (d < 7)  return d + ' days ago';
        if (d < 30) return Math.floor(d / 7) + 'w ago';
        if (d < 365) return Math.floor(d / 30) + 'mo ago';
        return fmtDate(s);
      } catch { return String(s); }
    }
  </script>
</body>
</html>
