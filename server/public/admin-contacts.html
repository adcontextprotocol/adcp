<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Admin - Contacts - AgenticAdvertising.org</title>
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <link rel="stylesheet" href="/design-system.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: 1600px;
      margin: 30px auto;
      padding: 0 20px;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .page-header h1 {
      color: var(--color-text-heading);
      font-size: 24px;
    }
    .page-header p {
      color: var(--color-text-secondary);
      margin-top: 4px;
    }
    .header-actions {
      display: flex;
      gap: 12px;
    }
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--color-bg-card);
      border-radius: 8px;
      padding: 20px;
      box-shadow: var(--shadow-sm);
    }
    .stat-card .label {
      font-size: 12px;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .stat-card .value {
      font-size: 28px;
      font-weight: 600;
      color: var(--color-text-heading);
      margin-top: 4px;
    }
    .stat-card .subtext {
      font-size: 12px;
      color: var(--color-text-muted);
      margin-top: 4px;
    }
    .card {
      background: var(--color-bg-card);
      border-radius: 8px;
      padding: 24px;
      box-shadow: var(--shadow-sm);
    }
    .filters {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }
    .search-box {
      flex: 1;
      min-width: 200px;
    }
    .search-box input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      font-size: 14px;
    }
    .filter-select {
      padding: 10px 14px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary {
      background: var(--color-brand);
      color: white;
    }
    .btn-primary:hover {
      background: var(--color-brand-hover);
    }
    .btn-secondary {
      background: var(--color-gray-200);
      color: var(--color-text-heading);
    }
    .btn-secondary:hover {
      background: var(--color-gray-300);
    }
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      text-align: left;
      padding: 12px 10px;
      border-bottom: 1px solid var(--color-border);
    }
    th {
      font-weight: 600;
      color: var(--color-text-secondary);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    td {
      color: var(--color-text-primary);
      font-size: 13px;
    }
    .member-name {
      font-weight: 500;
      color: var(--color-text-heading);
    }
    .member-email {
      font-size: 12px;
      color: var(--color-text-secondary);
    }
    .clickable-row {
      cursor: pointer;
    }
    .clickable-row:hover {
      background: var(--color-gray-50);
    }
    .badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    .badge-success {
      background: var(--color-success-light);
      color: var(--color-success);
    }
    .badge-warning {
      background: var(--color-warning-light);
      color: var(--color-warning-dark);
    }
    .badge-info {
      background: var(--color-info-light);
      color: var(--color-info);
    }
    .badge-danger {
      background: var(--color-danger-light);
      color: var(--color-danger);
    }
    .badge-secondary {
      background: var(--color-gray-200);
      color: var(--color-text-secondary);
    }
    .identity-badges {
      display: flex;
      gap: 4px;
    }
    .identity-badge {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
    }
    .identity-badge.slack {
      background: #4A154B20;
      color: #4A154B;
    }
    .identity-badge.email {
      background: #1a73e820;
      color: #1a73e8;
    }
    .identity-badge.aao {
      background: var(--color-brand-light);
      color: var(--color-brand);
    }
    .identity-badge.inactive {
      background: var(--color-gray-200);
      color: var(--color-text-muted);
    }
    .score-bar {
      width: 60px;
      height: 6px;
      background: var(--color-gray-200);
      border-radius: 3px;
      overflow: hidden;
      display: inline-block;
      margin-right: 6px;
      vertical-align: middle;
    }
    .score-fill {
      height: 100%;
      border-radius: 3px;
    }
    .score-fill.low { background: var(--color-gray-400); }
    .score-fill.medium { background: var(--color-warning); }
    .score-fill.high { background: var(--color-success); }
    .score-value {
      font-weight: 500;
      color: var(--color-text-heading);
    }
    .goal-tag {
      background: var(--color-brand-light);
      color: var(--color-brand);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
    }
    .goal-tag.link_account { background: #4A154B20; color: #4A154B; }
    .goal-tag.membership_pitch { background: var(--color-success-light); color: var(--color-success); }
    .goal-tag.drive_engagement { background: var(--color-warning-light); color: var(--color-warning-dark); }
    .goal-tag.drive_value { background: var(--color-info-light); color: var(--color-info); }
    .goal-tag.learn_interests { background: #9c27b020; color: #9c27b0; }
    .goal-tag.deepen_relationship { background: #00968820; color: #009688; }
    .goal-tag.initial_contact { background: var(--color-gray-200); color: var(--color-text-secondary); }
    .lifecycle-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      text-transform: capitalize;
    }
    .lifecycle-new { background: var(--color-gray-200); color: var(--color-text-secondary); }
    .lifecycle-active { background: var(--color-info-light); color: var(--color-info); }
    .lifecycle-engaged { background: var(--color-success-light); color: var(--color-success); }
    .lifecycle-champion { background: #9c27b020; color: #9c27b0; }
    .lifecycle-at_risk { background: var(--color-danger-light); color: var(--color-danger); }
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--color-surface-overlay);
      z-index: 1000;
      justify-content: center;
      align-items: flex-start;
      padding: 40px 20px;
      overflow-y: auto;
    }
    .modal {
      background: var(--color-bg-card);
      border-radius: 8px;
      padding: 24px;
      max-width: 900px;
      width: 100%;
      max-height: calc(100vh - 80px);
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }
    .modal h2 {
      color: var(--color-text-heading);
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--color-text-secondary);
    }
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }
    .detail-section {
      background: var(--color-gray-50);
      border-radius: 8px;
      padding: 16px;
    }
    .detail-section h3 {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--color-text-secondary);
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--color-border);
    }
    .detail-row:last-child {
      border-bottom: none;
    }
    .detail-label {
      font-size: 13px;
      color: var(--color-text-secondary);
    }
    .detail-value {
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text-heading);
    }
    .score-breakdown {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .score-item {
      text-align: center;
      padding: 12px;
      background: var(--color-bg-card);
      border-radius: 6px;
    }
    .score-item-value {
      font-size: 24px;
      font-weight: 600;
      color: var(--color-text-heading);
    }
    .score-item-label {
      font-size: 11px;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      margin-top: 4px;
    }
    .activity-list {
      max-height: 200px;
      overflow-y: auto;
    }
    .activity-item {
      padding: 10px 0;
      border-bottom: 1px solid var(--color-border);
      font-size: 13px;
    }
    .activity-item:last-child {
      border-bottom: none;
    }
    .activity-meta {
      font-size: 11px;
      color: var(--color-text-muted);
      margin-top: 4px;
    }
    .insights-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .insight-item {
      background: var(--color-gray-50);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
    }
    .insight-type {
      font-weight: 600;
      font-size: 12px;
      color: var(--color-text-heading);
      margin-bottom: 4px;
    }
    .insight-value {
      font-size: 13px;
      color: var(--color-text-primary);
    }
    .insight-meta {
      font-size: 11px;
      color: var(--color-text-muted);
      margin-top: 6px;
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--color-text-secondary);
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--color-text-muted);
    }
    .error-message {
      background: var(--color-danger-light);
      color: var(--color-danger);
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
    }
    .success-message {
      background: var(--color-success-light);
      color: var(--color-success);
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div id="adcp-nav"></div>

  <div class="container">
    <div class="page-header">
      <div>
        <h1>Contacts</h1>
        <p>Unified view of all contacts with engagement scores and goal selection</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="recomputeAllScores()" id="recompute-btn">Recompute Scores</button>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card">
        <div class="label">Total Contacts</div>
        <div class="value" id="stat-total">—</div>
      </div>
      <div class="stat-card">
        <div class="label">AAO Members</div>
        <div class="value" id="stat-linked">—</div>
        <div class="subtext" id="stat-linked-pct"></div>
      </div>
      <div class="stat-card">
        <div class="label">Slack Only</div>
        <div class="value" id="stat-slack-only">—</div>
      </div>
      <div class="stat-card">
        <div class="label">Email Only</div>
        <div class="value" id="stat-email-only">—</div>
      </div>
      <div class="stat-card">
        <div class="label">Ready for Pitch</div>
        <div class="value" id="stat-pitch">—</div>
        <div class="subtext">membership_pitch goal</div>
      </div>
    </div>

    <div class="card">
      <div class="filters">
        <div class="search-box">
          <input type="text" id="search" placeholder="Search by name or email..." oninput="debounceSearch()">
        </div>
        <select class="filter-select" id="filter-contact-type" onchange="loadContacts()">
          <option value="">All Contact Types</option>
          <option value="linked">AAO Members</option>
          <option value="slack_only">Slack Only</option>
          <option value="email_only">Email Only</option>
        </select>
        <select class="filter-select" id="filter-goal" onchange="loadContacts()">
          <option value="">All Goals</option>
          <!-- Populated by JavaScript -->
        </select>
        <select class="filter-select" id="filter-lifecycle" onchange="loadContacts()">
          <option value="">All Lifecycle Stages</option>
          <option value="new">New</option>
          <option value="active">Active</option>
          <option value="engaged">Engaged</option>
          <option value="champion">Champion</option>
          <option value="at_risk">At Risk</option>
        </select>
      </div>

      <div id="loading" class="loading">Loading contacts...</div>
      <div id="error" class="error-message" style="display: none;"></div>
      <table id="contacts-table" style="display: none;">
        <thead>
          <tr>
            <th>Contact</th>
            <th>Identity</th>
            <th>Engagement</th>
            <th>Excitement</th>
            <th>Lifecycle</th>
            <th>Goal</th>
            <th>Last Activity</th>
          </tr>
        </thead>
        <tbody id="contacts-body"></tbody>
      </table>
      <div id="empty" class="empty-state" style="display: none;">
        <p>No contacts found matching your criteria.</p>
      </div>
    </div>
  </div>

  <!-- Contact Detail Modal -->
  <div id="detail-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <div>
          <h2 id="detail-modal-title">Contact Details</h2>
          <p id="detail-modal-subtitle" style="color: var(--color-text-secondary); margin-top: 4px;"></p>
        </div>
        <button class="close-btn" onclick="closeDetailModal()">&times;</button>
      </div>

      <div id="detail-loading" class="loading">Loading contact details...</div>
      <div id="detail-content" style="display: none;">
        <div class="detail-grid">
          <!-- Identity Section -->
          <div class="detail-section">
            <h3>Identity</h3>
            <div id="detail-identity"></div>
          </div>

          <!-- Goal Section -->
          <div class="detail-section">
            <h3>Addie's Goal</h3>
            <div id="detail-goal"></div>
          </div>
        </div>

        <div class="detail-grid">
          <!-- Engagement Scores -->
          <div class="detail-section">
            <h3>Engagement Breakdown</h3>
            <div id="detail-engagement" class="score-breakdown"></div>
          </div>

          <!-- Activity Summary -->
          <div class="detail-section">
            <h3>Activity Summary</h3>
            <div id="detail-activity"></div>
          </div>
        </div>

        <!-- Insights Section -->
        <div class="detail-section" style="margin-bottom: 24px;">
          <h3>Insights</h3>
          <div id="detail-insights" class="insights-list"></div>
        </div>

        <!-- Conversations Section -->
        <div class="detail-section">
          <h3>Recent Conversations</h3>
          <div id="detail-conversations" class="activity-list"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="adcp-footer"></div>

  <script>
    let contacts = [];
    let goalTypes = [];
    let searchTimeout = null;

    // Initialize
    async function init() {
      await Promise.all([
        loadGoalTypes(),
        loadStats(),
        loadContacts(),
      ]);
    }

    async function loadGoalTypes() {
      try {
        const response = await fetch('/api/admin/goal-types');
        if (response.ok) {
          goalTypes = await response.json();
          populateGoalFilter();
        }
      } catch (err) {
        console.error('Failed to load goal types:', err);
      }
    }

    function populateGoalFilter() {
      const select = document.getElementById('filter-goal');
      select.innerHTML = '<option value="">All Goals</option>' +
        goalTypes.map(g => `<option value="${g.name}">${escapeHtml(g.display_name)}</option>`).join('');
    }

    async function loadStats() {
      try {
        const response = await fetch('/api/admin/contacts/stats');
        if (!response.ok) return;

        const stats = await response.json();
        document.getElementById('stat-total').textContent = stats.total_contacts || 0;
        document.getElementById('stat-linked').textContent = stats.linked_contacts || 0;
        const linkedPct = stats.total_contacts > 0
          ? Math.round(100 * stats.linked_contacts / stats.total_contacts)
          : 0;
        document.getElementById('stat-linked-pct').textContent = `${linkedPct}% of total`;
        document.getElementById('stat-slack-only').textContent = stats.slack_only_contacts || 0;
        document.getElementById('stat-email-only').textContent = stats.email_only_contacts || 0;
        document.getElementById('stat-pitch').textContent = stats.ready_for_pitch || 0;
      } catch (err) {
        console.error('Failed to load stats:', err);
      }
    }

    async function loadContacts() {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const table = document.getElementById('contacts-table');
      const empty = document.getElementById('empty');

      loading.style.display = 'block';
      error.style.display = 'none';
      table.style.display = 'none';
      empty.style.display = 'none';

      try {
        const search = document.getElementById('search').value.trim();
        const contactType = document.getElementById('filter-contact-type').value;
        const goal = document.getElementById('filter-goal').value;
        const lifecycle = document.getElementById('filter-lifecycle').value;

        const params = new URLSearchParams();
        if (search) params.set('search', search);
        if (contactType) params.set('contact_type', contactType);
        if (goal) params.set('goal', goal);
        if (lifecycle) params.set('lifecycle_stage', lifecycle);
        params.set('limit', '100');

        const response = await fetch(`/api/admin/contacts?${params}`);
        if (!response.ok) {
          if (response.status === 401) {
            AdminSidebar.redirectToLogin();
            return;
          }
          throw new Error('Failed to load contacts');
        }

        const data = await response.json();
        contacts = data.contacts || [];
        loading.style.display = 'none';

        if (contacts.length === 0) {
          empty.style.display = 'block';
        } else {
          table.style.display = 'table';
          renderContacts();
        }
      } catch (err) {
        loading.style.display = 'none';
        error.textContent = err.message;
        error.style.display = 'block';
      }
    }

    function renderContacts() {
      const tbody = document.getElementById('contacts-body');
      tbody.innerHTML = contacts.map(contact => {
        const identifier = contact.workos_user_id || contact.slack_user_id || contact.email_contact_id;
        const identifierType = contact.workos_user_id ? 'workos' : (contact.slack_user_id ? 'slack' : 'email');

        return `
          <tr class="clickable-row" onclick="openDetailModal('${escapeHtml(identifier)}', '${identifierType}')">
            <td>
              <div class="member-name">${escapeHtml(contact.display_name || 'Unknown')}</div>
              <div class="member-email">${escapeHtml(contact.email || '—')}</div>
            </td>
            <td>
              <div class="identity-badges">
                <span class="identity-badge ${contact.workos_user_id ? 'aao' : 'inactive'}" title="AAO Account">A</span>
                <span class="identity-badge ${contact.slack_user_id ? 'slack' : 'inactive'}" title="Slack">S</span>
                <span class="identity-badge ${contact.email_contact_id ? 'email' : 'inactive'}" title="Email">E</span>
              </div>
            </td>
            <td>
              ${renderScore(contact.engagement_score || 0)}
            </td>
            <td>
              ${renderScore(contact.excitement_score || 0)}
            </td>
            <td>
              <span class="lifecycle-badge lifecycle-${contact.lifecycle_stage || 'new'}">
                ${(contact.lifecycle_stage || 'new').replace('_', ' ')}
              </span>
            </td>
            <td>
              ${contact.selected_goal ? `
                <span class="goal-tag ${contact.selected_goal}">${formatGoalName(contact.selected_goal)}</span>
              ` : '—'}
            </td>
            <td>${contact.last_activity_at ? formatDate(contact.last_activity_at) : '—'}</td>
          </tr>
        `;
      }).join('');
    }

    function renderScore(score) {
      const level = score >= 50 ? 'high' : (score >= 20 ? 'medium' : 'low');
      return `
        <span class="score-bar"><span class="score-fill ${level}" style="width: ${score}%"></span></span>
        <span class="score-value">${score}</span>
      `;
    }

    function formatGoalName(goal) {
      const goalType = goalTypes.find(g => g.name === goal);
      return goalType ? goalType.display_name : goal.replace(/_/g, ' ');
    }

    async function openDetailModal(identifier, type) {
      const modal = document.getElementById('detail-modal');
      const loading = document.getElementById('detail-loading');
      const content = document.getElementById('detail-content');

      modal.style.display = 'flex';
      loading.style.display = 'block';
      content.style.display = 'none';

      try {
        const response = await fetch(`/api/admin/contacts/${type}:${identifier}`);
        if (!response.ok) throw new Error('Failed to load contact details');

        const data = await response.json();
        loading.style.display = 'none';
        content.style.display = 'block';

        renderContactDetail(data);
      } catch (err) {
        loading.style.display = 'none';
        content.innerHTML = `<div class="error-message">${err.message}</div>`;
        content.style.display = 'block';
      }
    }

    function renderContactDetail(data) {
      const contact = data.contact;

      // Title
      document.getElementById('detail-modal-title').textContent = contact.display_name || 'Unknown Contact';
      document.getElementById('detail-modal-subtitle').textContent = contact.email || '';

      // Identity
      const identityHtml = `
        <div class="detail-row">
          <span class="detail-label">AAO Account</span>
          <span class="detail-value">${contact.workos_user_id ?
            `<span class="badge badge-success">Linked</span>` :
            `<span class="badge badge-warning">Not Linked</span>`}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Slack</span>
          <span class="detail-value">${contact.slack_user_id || '—'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Email Contact</span>
          <span class="detail-value">${contact.email_contact_id ? 'Yes' : 'No'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Organization</span>
          <span class="detail-value">${escapeHtml(contact.organization_name) || '—'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">First Seen</span>
          <span class="detail-value">${contact.first_seen_at ? formatDate(contact.first_seen_at) : '—'}</span>
        </div>
      `;
      document.getElementById('detail-identity').innerHTML = identityHtml;

      // Goal
      const goalType = goalTypes.find(g => g.name === contact.selected_goal);
      const goalHtml = `
        <div style="margin-bottom: 12px;">
          <span class="goal-tag ${contact.selected_goal || ''}" style="font-size: 14px; padding: 8px 16px;">
            ${goalType ? goalType.display_name : (contact.selected_goal || 'None').replace(/_/g, ' ')}
          </span>
        </div>
        ${goalType ? `
          <p style="font-size: 13px; color: var(--color-text-secondary); margin-bottom: 12px;">
            ${escapeHtml(goalType.description || '')}
          </p>
          ${goalType.example_prompt ? `
            <div style="background: var(--color-bg-card); padding: 12px; border-radius: 6px; font-size: 12px;">
              <strong>Example approach:</strong><br>
              <em style="color: var(--color-text-secondary);">${escapeHtml(goalType.example_prompt)}</em>
            </div>
          ` : ''}
        ` : ''}
      `;
      document.getElementById('detail-goal').innerHTML = goalHtml;

      // Engagement breakdown
      const engagementHtml = `
        <div class="score-item">
          <div class="score-item-value">${contact.engagement_score || 0}</div>
          <div class="score-item-label">Total Engagement</div>
        </div>
        <div class="score-item">
          <div class="score-item-value">${contact.excitement_score || 0}</div>
          <div class="score-item-label">Excitement</div>
        </div>
        <div class="score-item">
          <div class="score-item-value">${contact.slack_activity_score || 0}</div>
          <div class="score-item-label">Slack Activity</div>
        </div>
        <div class="score-item">
          <div class="score-item-value">${contact.email_engagement_score || 0}</div>
          <div class="score-item-label">Email</div>
        </div>
        <div class="score-item">
          <div class="score-item-value">${contact.conversation_score || 0}</div>
          <div class="score-item-label">Conversations</div>
        </div>
        <div class="score-item">
          <div class="score-item-value">${contact.community_score || 0}</div>
          <div class="score-item-label">Community</div>
        </div>
      `;
      document.getElementById('detail-engagement').innerHTML = engagementHtml;

      // Activity summary
      const activity = data.activity || {};
      const activityHtml = `
        <div class="detail-row">
          <span class="detail-label">Slack Messages (30d)</span>
          <span class="detail-value">${activity.slack_message_count || 0}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Slack Reactions (30d)</span>
          <span class="detail-value">${activity.slack_reaction_count || 0}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Email Opens (30d)</span>
          <span class="detail-value">${activity.email_open_count || 0}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Email Clicks (30d)</span>
          <span class="detail-value">${activity.email_click_count || 0}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Last Activity</span>
          <span class="detail-value">${contact.last_activity_at ? formatDate(contact.last_activity_at) : '—'}</span>
        </div>
      `;
      document.getElementById('detail-activity').innerHTML = activityHtml;

      // Insights
      const insights = data.insights || [];
      if (insights.length === 0) {
        document.getElementById('detail-insights').innerHTML =
          '<p style="color: var(--color-text-muted); font-size: 13px;">No insights collected yet.</p>';
      } else {
        document.getElementById('detail-insights').innerHTML = insights.map(i => `
          <div class="insight-item">
            <div class="insight-type">${escapeHtml(i.insight_type_name || 'Unknown')}</div>
            <div class="insight-value">${escapeHtml(i.value)}</div>
            <div class="insight-meta">
              <span class="badge ${i.confidence === 'high' ? 'badge-success' : (i.confidence === 'medium' ? 'badge-warning' : 'badge-info')}">${i.confidence}</span>
              &middot; ${formatDate(i.created_at)}
            </div>
          </div>
        `).join('');
      }

      // Conversations
      const conversations = data.conversations || [];
      if (conversations.length === 0) {
        document.getElementById('detail-conversations').innerHTML =
          '<p style="color: var(--color-text-muted); font-size: 13px;">No conversations recorded.</p>';
      } else {
        document.getElementById('detail-conversations').innerHTML = conversations.map(c => `
          <div class="activity-item">
            <div>${escapeHtml(c.thread_title || 'Conversation')}</div>
            <div class="activity-meta">
              ${c.channel_name ? `#${escapeHtml(c.channel_name)} &middot; ` : ''}
              ${c.message_count || 0} messages &middot; ${formatDate(c.created_at)}
            </div>
          </div>
        `).join('');
      }
    }

    function closeDetailModal() {
      document.getElementById('detail-modal').style.display = 'none';
    }

    async function recomputeAllScores() {
      const btn = document.getElementById('recompute-btn');
      btn.disabled = true;
      btn.textContent = 'Computing...';

      try {
        const response = await fetch('/api/admin/contacts/recompute-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Failed to recompute scores');
        }

        const result = await response.json();
        alert(`Recomputed scores for ${result.users_updated} users and ${result.orgs_updated} organizations`);

        // Refresh data
        loadStats();
        loadContacts();
      } catch (err) {
        alert(err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Recompute Scores';
      }
    }

    function debounceSearch() {
      if (searchTimeout) clearTimeout(searchTimeout);
      searchTimeout = setTimeout(loadContacts, 300);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '—';
      const date = new Date(dateStr);
      const now = new Date();
      const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays}d ago`;

      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
      });
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Close modal on escape or overlay click
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeDetailModal();
    });
    document.getElementById('detail-modal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeDetailModal();
    });

    // Initialize
    init();
  </script>
</body>
</html>
