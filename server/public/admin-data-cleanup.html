<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Data Cleanup - Admin Tools - AdCP Registry</title>
  <link rel="stylesheet" href="/design-system.css">
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <style>
    /* =============================================================================
       Data Cleanup Tool styles
       Uses design system variables - see /design-system.css for tokens
       ============================================================================= */

    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-wide);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }
    h1 { margin-bottom: var(--space-2.5); color: var(--color-text-heading); }
    .subtitle { color: var(--color-text-secondary); margin-bottom: var(--space-5); }

    /* Breadcrumb */
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }
    .breadcrumb a {
      color: var(--color-brand);
      text-decoration: none;
    }
    .breadcrumb a:hover {
      text-decoration: underline;
    }

    /* Summary bar */
    .summary-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-3);
      padding: var(--space-4);
      background: var(--color-bg-subtle);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-5);
    }
    .summary-stats {
      font-size: var(--text-sm);
    }
    .summary-actions {
      display: flex;
      gap: var(--space-2);
    }

    /* Buttons */
    .btn {
      padding: var(--space-2) var(--space-4);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .btn-primary {
      background: var(--color-brand);
      color: white;
    }
    .btn-primary:hover {
      background: var(--color-primary-700);
    }
    .btn-secondary {
      background: var(--color-gray-200);
      color: var(--color-text-heading);
    }
    .btn-secondary:hover {
      background: var(--color-gray-300);
    }
    .btn-danger {
      background: var(--color-error-500);
      color: white;
    }
    .btn-danger:hover {
      background: var(--color-error-600);
    }
    .btn-sm {
      padding: var(--space-1.5) var(--space-3);
      font-size: var(--text-xs);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Table */
    .cleanup-table {
      width: 100%;
      border-collapse: collapse;
    }
    .cleanup-table th {
      background: var(--color-gray-50);
      padding: var(--space-3);
      text-align: left;
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      border-bottom: var(--border-2) solid var(--color-gray-200);
      font-size: var(--text-sm);
    }
    .cleanup-table td {
      padding: var(--space-3);
      border-bottom: var(--border-1) solid var(--color-gray-200);
      font-size: var(--text-sm);
      vertical-align: top;
    }
    .cleanup-table tr:hover {
      background: var(--color-gray-50);
    }

    /* Issue styling */
    .issue-item {
      margin: var(--space-1) 0;
      padding: var(--space-1) var(--space-2);
      background: var(--color-bg-card);
      border-radius: var(--radius-sm);
    }
    .issue-high {
      border-left: 3px solid var(--color-error-500);
    }
    .issue-medium {
      border-left: 3px solid var(--color-warning-500);
    }
    .issue-low {
      border-left: 3px solid var(--color-gray-400);
    }
    .issue-suggestion {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-0.5);
    }

    /* Empty/loading states */
    .empty-state {
      text-align: center;
      padding: var(--space-10) var(--space-5);
      color: var(--color-text-secondary);
    }
    .empty-state h3 {
      color: var(--color-text-heading);
      margin-bottom: var(--space-2);
    }
    .loading {
      text-align: center;
      padding: var(--space-8);
      color: var(--color-text-secondary);
    }
    .loading-dots::after {
      content: '';
      animation: dots 1.5s steps(4, end) infinite;
    }
    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--color-surface-overlay);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: var(--color-bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      max-width: 800px;
      width: 90%;
      max-height: 80vh;
      overflow: auto;
      box-shadow: var(--shadow-lg);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: var(--space-4);
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: var(--color-text-secondary);
    }

    /* Markdown content */
    .markdown-content h2 { font-size: var(--text-lg); font-weight: var(--font-semibold); margin: var(--space-4) 0 var(--space-2); color: var(--color-text-heading); }
    .markdown-content h3 { font-size: var(--text-base); font-weight: var(--font-semibold); margin: var(--space-3) 0 var(--space-2); color: var(--color-text-heading); }
    .markdown-content p { margin-bottom: var(--space-3); }
    .markdown-content ul, .markdown-content ol { margin: var(--space-2) 0; padding-left: var(--space-5); }
    .markdown-content li { margin-bottom: var(--space-1); }
    .markdown-content strong { font-weight: var(--font-semibold); }
    .markdown-content code { background: var(--color-bg-subtle); padding: var(--space-0.5) var(--space-1); border-radius: var(--radius-sm); font-size: 0.9em; }

    /* Action panels */
    .action-panel {
      margin-top: var(--space-4);
      padding: var(--space-3);
      border-radius: var(--radius-md);
    }
    .action-panel-warning {
      background: var(--color-warning-50);
      border: 1px solid var(--color-warning-200);
    }
    .action-panel-info {
      background: var(--color-info-50);
      border: 1px solid var(--color-info-200);
    }
    .action-panel-success {
      background: var(--color-success-50);
      border: 1px solid var(--color-success-200);
    }
    .action-panel-title {
      font-weight: var(--font-semibold);
      margin-bottom: var(--space-2);
    }
    .action-panel-warning .action-panel-title { color: var(--color-warning-700); }
    .action-panel-info .action-panel-title { color: var(--color-info-700); }
    .action-panel-success .action-panel-title { color: var(--color-success-700); }
  </style>
</head>
<body>
  <!-- Navigation -->
  <div id="nav-placeholder"></div>
  <script>window.Nav.init('nav-placeholder');</script>

  <div style="display: flex;">
    <!-- Sidebar -->
    <div id="sidebar-placeholder"></div>
    <script>window.AdminSidebar.init('sidebar-placeholder', 'tools');</script>

    <!-- Main Content -->
    <main style="flex: 1; min-width: 0;">
      <div class="container">
        <div class="breadcrumb">
          <a href="/admin/accounts">Accounts</a>
          <span>/</span>
          <span>Data Cleanup</span>
        </div>

        <div class="card">
          <h1>Data Cleanup</h1>
          <p class="subtitle">AI-powered data quality analysis - find missing info, duplicates, and issues.</p>

          <!-- Summary Bar -->
          <div class="summary-bar" id="summaryBar" style="display: none;">
            <div class="summary-stats" id="summaryStats"></div>
            <div class="summary-actions" id="summaryActions"></div>
          </div>

          <!-- Cleanup Table -->
          <table class="cleanup-table">
            <thead>
              <tr>
                <th style="min-width: 180px;">Organization</th>
                <th style="min-width: 350px;">Issues</th>
                <th style="min-width: 250px;">Suggested Actions</th>
              </tr>
            </thead>
            <tbody id="cleanupTableBody">
              <tr>
                <td colspan="3" class="loading">
                  <span class="loading-dots">Loading cleanup analysis</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    // State
    let cleanupConfigured = false;
    let cleanupReport = null;
    let cleanupInProgress = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Check if cleanup is configured
      try {
        const statusRes = await fetch('/api/admin/cleanup/status');
        if (statusRes.ok) {
          const status = await statusRes.json();
          cleanupConfigured = status.configured;
        }
      } catch (e) {
        console.log('Could not check cleanup config');
      }

      await loadDataCleanup();
    });

    async function loadDataCleanup() {
      const tbody = document.getElementById('cleanupTableBody');
      tbody.innerHTML = `
        <tr>
          <td colspan="3" class="loading">
            <span class="loading-dots">Loading cleanup analysis</span>
          </td>
        </tr>
      `;

      if (!cleanupConfigured) {
        renderCleanupNotConfigured();
        return;
      }

      try {
        const response = await fetch('/api/admin/cleanup/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ limit: 100, onlyProblematic: true })
        });

        if (!response.ok) {
          throw new Error('Failed to analyze accounts');
        }

        cleanupReport = await response.json();
        renderDataCleanup();
      } catch (error) {
        console.error('Error loading cleanup:', error);
        tbody.innerHTML = `
          <tr>
            <td colspan="3" class="empty-state">
              <h3>Error loading cleanup analysis</h3>
              <p>${escapeHtml(error.message)}</p>
            </td>
          </tr>
        `;
      }
    }

    function renderCleanupNotConfigured() {
      document.getElementById('summaryBar').style.display = 'none';
      document.getElementById('cleanupTableBody').innerHTML = `
        <tr>
          <td colspan="3" class="empty-state">
            <h3>Data Cleanup Not Configured</h3>
            <p>ANTHROPIC_API_KEY is required for intelligent cleanup analysis.</p>
            <p style="margin-top: var(--space-2); color: var(--color-text-muted);">
              Add ANTHROPIC_API_KEY to your environment to enable AI-powered data cleanup.
            </p>
          </td>
        </tr>
      `;
    }

    function renderDataCleanup() {
      const summaryBar = document.getElementById('summaryBar');
      const tbody = document.getElementById('cleanupTableBody');

      if (!cleanupReport || cleanupReport.analyses.length === 0) {
        summaryBar.style.display = 'none';
        tbody.innerHTML = `
          <tr>
            <td colspan="3" class="empty-state">
              <h3>No Issues Found</h3>
              <p>All accounts have complete data. Great job!</p>
            </td>
          </tr>
        `;
        return;
      }

      // Show summary
      summaryBar.style.display = 'flex';
      document.getElementById('summaryStats').innerHTML = `
        <strong>${cleanupReport.total_analyzed}</strong> accounts analyzed,
        <strong style="color: var(--color-warning-600);">${cleanupReport.issues_found}</strong> issues found,
        <strong style="color: var(--color-success-600);">${cleanupReport.auto_fixable}</strong> auto-fixable
      `;
      document.getElementById('summaryActions').innerHTML = `
        ${cleanupReport.auto_fixable > 0 ? `
          <button class="btn btn-primary btn-sm" onclick="autoFixAll()" ${cleanupInProgress ? 'disabled' : ''}>
            Auto-Fix All (${cleanupReport.auto_fixable})
          </button>
        ` : ''}
        <button class="btn btn-secondary btn-sm" onclick="loadDataCleanup()" ${cleanupInProgress ? 'disabled' : ''}>
          Refresh Analysis
        </button>
      `;

      // Render rows
      tbody.innerHTML = cleanupReport.analyses.map(analysis => {
        const issuesHtml = analysis.issues.map(issue => {
          const icon = issue.auto_fixable ? '&#128295;' : '&#9888;&#65039;';
          const severityClass = `issue-${issue.severity}`;
          return `
            <div class="issue-item ${severityClass}">
              <span title="${issue.severity} severity">${icon}</span>
              <strong>${escapeHtml(issue.type.replace(/_/g, ' '))}</strong>: ${escapeHtml(issue.description)}
              ${issue.suggestion ? `<div class="issue-suggestion">&rarr; ${escapeHtml(issue.suggestion)}</div>` : ''}
            </div>
          `;
        }).join('');

        const actionsHtml = analysis.suggested_actions.map(action =>
          `<li style="margin-left: var(--space-4);">${escapeHtml(action)}</li>`
        ).join('');

        return `
          <tr>
            <td>
              <a href="/admin/accounts/${escapeHtml(analysis.org_id)}" target="_blank">
                <strong>${escapeHtml(analysis.org_name)}</strong>
              </a>
              <div style="margin-top: var(--space-2); display: flex; gap: var(--space-1); flex-wrap: wrap;">
                ${analysis.can_auto_fix ? `
                  <button class="btn btn-primary btn-sm" data-org-id="${escapeHtml(analysis.org_id)}" onclick="autoFixSingle(this.dataset.orgId)" ${cleanupInProgress ? 'disabled' : ''}>
                    Auto-Fix
                  </button>
                ` : ''}
                <button class="btn btn-secondary btn-sm" data-org-id="${escapeHtml(analysis.org_id)}" onclick="analyzeWithAI(this.dataset.orgId)" ${cleanupInProgress ? 'disabled' : ''}>
                  AI Analyze
                </button>
              </div>
            </td>
            <td style="white-space: normal;">${issuesHtml}</td>
            <td style="white-space: normal;">
              ${actionsHtml ? `<ul style="margin: 0; padding: 0; list-style: disc;">${actionsHtml}</ul>` : '-'}
            </td>
          </tr>
        `;
      }).join('');
    }

    async function autoFixAll() {
      if (!cleanupReport || cleanupReport.auto_fixable === 0) return;
      if (!confirm(`Auto-fix ${cleanupReport.auto_fixable} issues across ${cleanupReport.analyses.filter(a => a.can_auto_fix).length} organizations?`)) {
        return;
      }

      cleanupInProgress = true;
      renderDataCleanup();

      try {
        const analysesToFix = cleanupReport.analyses.filter(a => a.can_auto_fix);
        const response = await fetch('/api/admin/cleanup/auto-fix', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ analyses: analysesToFix })
        });

        if (!response.ok) {
          throw new Error('Auto-fix failed');
        }

        const result = await response.json();
        alert(`Fixed ${result.successful} of ${result.total} issues.`);

        await loadDataCleanup();
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        cleanupInProgress = false;
        renderDataCleanup();
      }
    }

    async function autoFixSingle(orgId) {
      const analysis = cleanupReport?.analyses.find(a => a.org_id === orgId);
      if (!analysis || !analysis.can_auto_fix) return;

      cleanupInProgress = true;
      renderDataCleanup();

      try {
        const response = await fetch('/api/admin/cleanup/auto-fix', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ analyses: [analysis] })
        });

        if (!response.ok) {
          throw new Error('Auto-fix failed');
        }

        const result = await response.json();
        await loadDataCleanup();

        if (result.successful > 0) {
          alert(`Fixed ${result.successful} issue(s) for ${analysis.org_name}.`);
        } else {
          alert('No issues were fixed. They may require manual attention.');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        cleanupInProgress = false;
      }
    }

    async function analyzeWithAI(orgId) {
      const analysis = cleanupReport?.analyses.find(a => a.org_id === orgId);
      const orgName = analysis?.org_name || orgId;

      // Show loading modal
      const modal = document.createElement('div');
      modal.id = 'aiAnalysisModal';
      modal.innerHTML = `
        <div class="modal-overlay">
          <div class="modal-content">
            <h3 style="margin-bottom: var(--space-4);">AI Analysis: ${escapeHtml(orgName)}</h3>
            <div class="loading-dots">Analyzing with Claude... (may take 30-60 seconds)</div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      try {
        const response = await fetch(`/api/admin/cleanup/analyze-with-ai/${orgId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          throw new Error('AI analysis failed');
        }

        const result = await response.json();
        const renderedAnalysis = DOMPurify.sanitize(marked.parse(result.analysis));

        // Build action panels
        const mergeActions = result.suggested_actions.filter(a => a.action === 'merge');
        const updateActions = result.suggested_actions.filter(a => a.action === 'update_type' || a.action === 'add_domain');
        const enrichActions = result.suggested_actions.filter(a => a.action === 'enrich');

        let actionsHtml = '';

        if (mergeActions.length > 0) {
          actionsHtml += `
            <div class="action-panel action-panel-warning">
              <div class="action-panel-title">Duplicate Organizations Found</div>
              ${mergeActions.map(a => `
                <div style="margin-top: var(--space-3); padding: var(--space-3); background: var(--color-bg-card); border-radius: var(--radius-sm);">
                  <div style="margin-bottom: var(--space-2);">
                    <strong>Primary:</strong> ${escapeHtml(a.details.primary_name || a.details.primary_org_id)}<br>
                    <strong>Duplicate:</strong> ${escapeHtml(a.details.duplicate_name || a.details.duplicate_org_id)}
                  </div>
                  <div style="display: flex; gap: var(--space-2);">
                    <button class="btn btn-secondary btn-sm" onclick="previewMerge('${a.details.primary_org_id}', '${a.details.duplicate_org_id}')">
                      Preview Merge
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="executeMerge('${a.details.primary_org_id}', '${a.details.duplicate_org_id}')">
                      Merge Organizations
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        }

        if (updateActions.length > 0) {
          actionsHtml += `
            <div class="action-panel action-panel-info">
              <div class="action-panel-title">Recommended Updates</div>
              <ul style="margin: var(--space-2) 0 0 var(--space-4); list-style: none; padding: 0;">
                ${updateActions.map(a => {
                  if (a.action === 'add_domain') {
                    return `<li style="margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                      <span>Add domain: <strong>${escapeHtml(a.details.domain)}</strong></span>
                      <button class="btn btn-primary btn-sm" onclick="quickAddDomain('${escapeHtml(a.org_id)}', '${escapeHtml(a.details.domain)}')">Add</button>
                    </li>`;
                  } else if (a.action === 'update_type') {
                    return `<li style="margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                      <span>Set company type to: <strong>${escapeHtml(a.details.company_type)}</strong></span>
                      <button class="btn btn-primary btn-sm" onclick="quickUpdateType('${escapeHtml(a.org_id)}', '${escapeHtml(a.details.company_type)}')">Update</button>
                    </li>`;
                  }
                  return '';
                }).join('')}
              </ul>
            </div>
          `;
        }

        if (enrichActions.length > 0) {
          actionsHtml += `
            <div class="action-panel action-panel-success">
              <div class="action-panel-title">Enrichment Available</div>
              <div style="margin-top: var(--space-2);">
                <button class="btn btn-primary btn-sm" onclick="enrichAccount('${orgId}')">Enrich with Lusha</button>
              </div>
            </div>
          `;
        }

        const toolCallsHtml = result.tool_calls.length > 0 ? `
          <details style="margin-top: var(--space-4);">
            <summary style="cursor: pointer; color: var(--color-text-secondary);">Tool calls (${result.tool_calls.length})</summary>
            <div style="margin-top: var(--space-2); font-size: 0.85em; background: var(--color-bg-subtle); padding: var(--space-2); border-radius: var(--radius-sm); max-height: 200px; overflow: auto;">
              ${result.tool_calls.map(tc => `
                <div style="margin-bottom: var(--space-2); padding-bottom: var(--space-2); border-bottom: 1px solid var(--color-border);">
                  <strong>${escapeHtml(tc.tool)}</strong>
                  <pre style="margin: var(--space-1) 0; white-space: pre-wrap; font-size: 0.9em;">${escapeHtml(JSON.stringify(tc.input, null, 2))}</pre>
                </div>
              `).join('')}
            </div>
          </details>
        ` : '';

        modal.innerHTML = `
          <div class="modal-overlay">
            <div class="modal-content">
              <div class="modal-header">
                <h3>AI Analysis: ${escapeHtml(orgName)}</h3>
                <button class="modal-close" onclick="document.getElementById('aiAnalysisModal').remove()">&times;</button>
              </div>
              <div class="markdown-content" style="line-height: 1.6;">${renderedAnalysis}</div>
              ${actionsHtml}
              ${toolCallsHtml}
              <div style="margin-top: var(--space-4); text-align: right;">
                <button class="btn btn-primary" onclick="document.getElementById('aiAnalysisModal').remove(); loadDataCleanup();">Done</button>
              </div>
            </div>
          </div>
        `;
      } catch (error) {
        modal.innerHTML = `
          <div class="modal-overlay">
            <div class="modal-content">
              <h3 style="color: var(--color-error-600); margin-bottom: var(--space-4);">Analysis Failed</h3>
              <p>${escapeHtml(error.message)}</p>
              <div style="margin-top: var(--space-4); text-align: right;">
                <button class="btn btn-primary" onclick="document.getElementById('aiAnalysisModal').remove();">Close</button>
              </div>
            </div>
          </div>
        `;
      }
    }

    async function previewMerge(primaryOrgId, secondaryOrgId) {
      const modal = document.getElementById('aiAnalysisModal');
      if (!modal) return;

      modal.innerHTML = `
        <div class="modal-overlay">
          <div class="modal-content" style="max-width: 900px;">
            <h3 style="margin-bottom: var(--space-4);">Loading merge preview...</h3>
            <div class="loading-dots">Fetching organization details</div>
          </div>
        </div>
      `;

      try {
        const response = await fetch(`/api/admin/cleanup/preview-merge?primary=${primaryOrgId}&secondary=${secondaryOrgId}`);
        if (!response.ok) throw new Error('Failed to load preview');
        const preview = await response.json();

        const warningsHtml = preview.warnings.length > 0 ? `
          <div class="action-panel action-panel-warning" style="margin-bottom: var(--space-4);">
            <strong>Warnings:</strong>
            <ul style="margin: var(--space-2) 0 0 var(--space-4);">
              ${preview.warnings.map(w => `<li>${escapeHtml(w)}</li>`).join('')}
            </ul>
          </div>
        ` : '';

        // Stripe customer conflict handling
        const stripeConflict = preview.stripe_customer_conflict || {};
        const stripeConflictHtml = stripeConflict.has_conflict ? `
          <div class="action-panel" style="margin-bottom: var(--space-4); background: var(--color-error-50); border: 2px solid var(--color-error-300);">
            <strong style="color: var(--color-error-700);">ðŸ”´ Stripe Customer Conflict</strong>
            <p style="margin: var(--space-2) 0;">Both organizations have Stripe customers. Choose which to keep:</p>
            <ul style="margin: var(--space-2) 0 var(--space-2) var(--space-4); font-size: var(--text-sm);">
              <li><strong>Primary:</strong> ${escapeHtml(stripeConflict.primary_customer_id || 'None')}</li>
              <li><strong>Secondary:</strong> ${escapeHtml(stripeConflict.secondary_customer_id || 'None')}</li>
            </ul>
            <div style="margin-top: var(--space-3);">
              <label style="display: block; margin-bottom: var(--space-2);">
                <input type="radio" name="stripe_resolution" value="keep_primary" checked>
                <strong>Keep Primary</strong> - Keep primary's Stripe customer, orphan secondary's
              </label>
              <label style="display: block; margin-bottom: var(--space-2);">
                <input type="radio" name="stripe_resolution" value="use_secondary">
                <strong>Use Secondary</strong> - Replace primary's with secondary's Stripe customer
              </label>
              <label style="display: block;">
                <input type="radio" name="stripe_resolution" value="keep_both_unlinked">
                <strong>Unlink Both</strong> - Unlink both for manual resolution later
              </label>
            </div>
          </div>
        ` : '';

        const changesHtml = preview.estimated_changes.length > 0 ? `
          <div style="margin-bottom: var(--space-4);">
            <strong>Data to be moved:</strong>
            <table style="width: 100%; margin-top: var(--space-2); border-collapse: collapse;">
              <thead>
                <tr style="background: var(--color-bg-subtle);">
                  <th style="padding: var(--space-2); text-align: left; border-bottom: 1px solid var(--color-border);">Table</th>
                  <th style="padding: var(--space-2); text-align: right; border-bottom: 1px solid var(--color-border);">Rows</th>
                </tr>
              </thead>
              <tbody>
                ${preview.estimated_changes.map(c => `
                  <tr>
                    <td style="padding: var(--space-2); border-bottom: 1px solid var(--color-border);">${escapeHtml(c.table_name)}</td>
                    <td style="padding: var(--space-2); text-align: right; border-bottom: 1px solid var(--color-border);">${c.rows_to_move}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : '<p>No data to move - secondary organization appears empty.</p>';

        modal.innerHTML = `
          <div class="modal-overlay">
            <div class="modal-content" style="max-width: 900px;">
              <div class="modal-header">
                <h3>Merge Preview</h3>
                <button class="modal-close" onclick="document.getElementById('aiAnalysisModal').remove()">&times;</button>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
                <div style="padding: var(--space-4); background: var(--color-success-50); border: 2px solid var(--color-success-300); border-radius: var(--radius-md);">
                  <div style="font-size: var(--text-xs); color: var(--color-success-700); font-weight: var(--font-semibold); margin-bottom: var(--space-1);">PRIMARY (keep)</div>
                  <div style="font-size: var(--text-lg); font-weight: var(--font-semibold);">${escapeHtml(preview.primary_org.name)}</div>
                  <div style="font-size: var(--text-xs); color: var(--color-text-secondary); margin-top: var(--space-1);">${escapeHtml(preview.primary_org.id)}</div>
                  ${preview.primary_org.email_domain ? `<div style="margin-top: var(--space-2);"><strong>Domain:</strong> ${escapeHtml(preview.primary_org.email_domain)}</div>` : ''}
                  ${preview.primary_org.company_type ? `<div><strong>Type:</strong> ${escapeHtml(preview.primary_org.company_type)}</div>` : ''}
                </div>

                <div style="padding: var(--space-4); background: var(--color-error-50); border: 2px solid var(--color-error-300); border-radius: var(--radius-md);">
                  <div style="font-size: var(--text-xs); color: var(--color-error-700); font-weight: var(--font-semibold); margin-bottom: var(--space-1);">DUPLICATE (delete)</div>
                  <div style="font-size: var(--text-lg); font-weight: var(--font-semibold);">${escapeHtml(preview.secondary_org.name)}</div>
                  <div style="font-size: var(--text-xs); color: var(--color-text-secondary); margin-top: var(--space-1);">${escapeHtml(preview.secondary_org.id)}</div>
                  ${preview.secondary_org.email_domain ? `<div style="margin-top: var(--space-2);"><strong>Domain:</strong> ${escapeHtml(preview.secondary_org.email_domain)}</div>` : ''}
                  ${preview.secondary_org.company_type ? `<div><strong>Type:</strong> ${escapeHtml(preview.secondary_org.company_type)}</div>` : ''}
                </div>
              </div>

              ${stripeConflictHtml}
              ${warningsHtml}
              ${changesHtml}

              <div style="margin-top: var(--space-4); display: flex; justify-content: space-between;">
                <button class="btn btn-secondary" onclick="document.getElementById('aiAnalysisModal').remove(); loadDataCleanup();">Cancel</button>
                <button class="btn btn-danger" onclick="executeMerge('${primaryOrgId}', '${secondaryOrgId}', ${stripeConflict.has_conflict || false})">
                  Confirm Merge
                </button>
              </div>
            </div>
          </div>
        `;
      } catch (error) {
        alert('Failed to load merge preview: ' + error.message);
      }
    }

    async function executeMerge(primaryOrgId, secondaryOrgId, hasStripeConflict = false) {
      if (!confirm('Are you sure you want to merge these organizations? This action cannot be undone.')) {
        return;
      }

      // Get Stripe customer resolution if there's a conflict
      let stripeCustomerResolution = null;
      if (hasStripeConflict) {
        const selected = document.querySelector('input[name="stripe_resolution"]:checked');
        stripeCustomerResolution = selected ? selected.value : 'keep_primary';
      }

      const modal = document.getElementById('aiAnalysisModal');
      if (modal) {
        modal.innerHTML = `
          <div class="modal-overlay">
            <div class="modal-content" style="max-width: 600px;">
              <h3 style="margin-bottom: var(--space-4);">Merging organizations...</h3>
              <div class="loading-dots">Please wait</div>
            </div>
          </div>
        `;
      }

      try {
        const body = { primary_org_id: primaryOrgId, secondary_org_id: secondaryOrgId };
        if (stripeCustomerResolution) {
          body.stripe_customer_resolution = stripeCustomerResolution;
        }
        const response = await fetch('/api/admin/cleanup/merge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.message || 'Merge failed');
        }

        const result = await response.json();
        const totalMoved = result.tables_merged.reduce((sum, t) => sum + t.rows_moved, 0);

        if (modal) {
          modal.innerHTML = `
            <div class="modal-overlay">
              <div class="modal-content" style="max-width: 600px;">
                <h3 style="color: var(--color-success-600); margin-bottom: var(--space-4);">Merge Complete</h3>
                <p>Successfully merged organizations. ${totalMoved} records were moved.</p>
                ${result.warnings.length > 0 ? `
                  <div class="action-panel action-panel-warning" style="margin-top: var(--space-3);">
                    <strong>Notes:</strong>
                    <ul style="margin: var(--space-1) 0 0 var(--space-4);">
                      ${result.warnings.map(w => `<li>${escapeHtml(w)}</li>`).join('')}
                    </ul>
                  </div>
                ` : ''}
                <div style="margin-top: var(--space-4); text-align: right;">
                  <button class="btn btn-primary" onclick="document.getElementById('aiAnalysisModal').remove(); loadDataCleanup();">Done</button>
                </div>
              </div>
            </div>
          `;
        }
      } catch (error) {
        if (modal) {
          modal.innerHTML = `
            <div class="modal-overlay">
              <div class="modal-content" style="max-width: 600px;">
                <h3 style="color: var(--color-error-600); margin-bottom: var(--space-4);">Merge Failed</h3>
                <p>${escapeHtml(error.message)}</p>
                <div style="margin-top: var(--space-4); text-align: right;">
                  <button class="btn btn-primary" onclick="document.getElementById('aiAnalysisModal').remove();">Close</button>
                </div>
              </div>
            </div>
          `;
        }
      }
    }

    async function quickAddDomain(orgId, domain) {
      if (!confirm(`Add domain "${domain}" to this organization?`)) return;
      try {
        const response = await fetch(`/api/admin/prospects/${orgId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email_domain: domain })
        });
        if (!response.ok) throw new Error('Failed to update');
        alert(`Domain "${domain}" added successfully.`);
        document.getElementById('aiAnalysisModal')?.remove();
        loadDataCleanup();
      } catch (error) {
        alert('Failed to add domain: ' + error.message);
      }
    }

    async function quickUpdateType(orgId, companyType) {
      if (!confirm(`Set company type to "${companyType}"?`)) return;
      try {
        const response = await fetch(`/api/admin/prospects/${orgId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ company_type: companyType })
        });
        if (!response.ok) throw new Error('Failed to update');
        alert(`Company type updated to "${companyType}".`);
        document.getElementById('aiAnalysisModal')?.remove();
        loadDataCleanup();
      } catch (error) {
        alert('Failed to update company type: ' + error.message);
      }
    }

    async function enrichAccount(orgId) {
      try {
        const response = await fetch(`/api/admin/enrichment/organization/${orgId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        if (!response.ok) throw new Error('Enrichment failed');
        const result = await response.json();
        alert('Enrichment complete!');
        document.getElementById('aiAnalysisModal')?.remove();
        loadDataCleanup();
      } catch (error) {
        alert('Enrichment failed: ' + error.message);
      }
    }

    // Utility function
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
