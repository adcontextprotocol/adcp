<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat with Addie - Agentic Advertising</title>
  <link rel="icon" type="image/svg+xml" href="/AAo.svg">
  <link rel="stylesheet" href="/design-system.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family-sans);
      background: var(--color-bg-page);
      color: var(--color-text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      padding: 0 16px;
    }

    .chat-header {
      text-align: center;
      padding: 32px 16px;
      border-bottom: 1px solid var(--color-border);
      background: var(--color-bg-card);
      margin: 0 -16px;
      padding-left: 32px;
      padding-right: 32px;
    }

    .chat-header h1 {
      font-size: 24px;
      font-weight: 600;
      color: var(--color-text-heading);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .chat-header h1 .addie-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--color-brand) 0%, var(--color-primary-600) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .chat-header p {
      color: var(--color-text-secondary);
      font-size: 14px;
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message {
      display: flex;
      gap: 12px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message--user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .message--assistant .message-avatar {
      background: linear-gradient(135deg, var(--color-brand) 0%, var(--color-primary-600) 100%);
    }

    .message--user .message-avatar {
      background: var(--color-gray-200);
    }

    .message-content {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 16px;
      line-height: 1.5;
      font-size: 14px;
    }

    .message--assistant .message-content {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: 16px 16px 16px 4px;
    }

    .message--user .message-content {
      background: var(--color-brand);
      color: white;
      border-radius: 16px 16px 4px 16px;
    }

    .message-content p {
      margin-bottom: 8px;
    }

    .message-content p:last-child {
      margin-bottom: 0;
    }

    .message-content code {
      background: var(--color-bg-subtle);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: var(--font-family-mono);
      font-size: 13px;
    }

    .message--user .message-content code {
      background: rgba(255, 255, 255, 0.2);
    }

    .message-content pre {
      background: var(--color-gray-900);
      color: var(--color-gray-100);
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 8px 0;
    }

    .message-content pre code {
      background: none;
      padding: 0;
      color: inherit;
    }

    .message-content a {
      color: var(--color-brand);
      text-decoration: underline;
    }

    .message--user .message-content a {
      color: white;
    }

    .message-content ul, .message-content ol {
      margin: 8px 0;
      padding-left: 20px;
    }

    .message-content li {
      margin-bottom: 4px;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 8px 0;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: var(--color-text-muted);
      border-radius: 50%;
      animation: bounce 1.4s ease-in-out infinite;
    }

    .typing-indicator span:nth-child(1) { animation-delay: 0s; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-4px); }
    }

    /* Streaming cursor animation */
    .streaming-cursor {
      display: inline-block;
      animation: blink 0.7s infinite;
      color: var(--color-brand);
      font-weight: bold;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    .chat-input-container {
      padding: 16px 0 24px;
      border-top: 1px solid var(--color-border);
      background: var(--color-bg-page);
    }

    .chat-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--color-border);
      border-radius: 24px;
      font-size: 14px;
      font-family: inherit;
      background: var(--color-bg-card);
      color: var(--color-text);
      resize: none;
      min-height: 48px;
      max-height: 200px;
      line-height: 1.5;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--color-brand);
      box-shadow: 0 0 0 3px var(--color-primary-100);
    }

    .chat-input::placeholder {
      color: var(--color-text-muted);
    }

    .send-button {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: var(--color-brand);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, transform 0.1s;
      flex-shrink: 0;
    }

    .send-button:hover:not(:disabled) {
      background: var(--color-brand-hover);
    }

    .send-button:active:not(:disabled) {
      transform: scale(0.95);
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .send-button svg {
      width: 20px;
      height: 20px;
    }

    .suggested-prompts {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .suggested-prompt {
      padding: 8px 16px;
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: 20px;
      font-size: 13px;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .suggested-prompt:hover {
      background: var(--color-bg-subtle);
      border-color: var(--color-brand);
      color: var(--color-brand);
    }

    .welcome-message {
      text-align: center;
      padding: 48px 24px;
      color: var(--color-text-secondary);
    }

    .welcome-message h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--color-text-heading);
      margin-bottom: 8px;
    }

    .welcome-message p {
      margin-bottom: 24px;
    }

    /* Addie Home Section */
    .addie-home-container {
      display: none;
      padding: 16px 0;
    }

    .addie-home-container.visible {
      display: block;
    }

    .addie-home-loading {
      text-align: center;
      padding: 24px;
      color: var(--color-text-muted);
    }

    .addie-home-error {
      text-align: center;
      padding: 16px;
      color: var(--color-error-600);
      background: var(--color-error-50);
      border-radius: var(--radius-lg);
      margin-bottom: 16px;
    }

    .error-toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--color-error-600);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    /* Impersonation banner */
    .impersonation-banner {
      background: var(--color-warning-100);
      border-bottom: 2px solid var(--color-warning-500);
      padding: 12px 16px;
      text-align: center;
      font-size: 14px;
      color: var(--color-warning-800);
      display: none;
    }

    .impersonation-banner.active {
      display: block;
    }

    .impersonation-banner strong {
      font-weight: 600;
    }

    .impersonation-banner .reason {
      font-style: italic;
      color: var(--color-warning-700);
    }

    /* Status indicator */
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--color-text-muted);
      margin-top: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--color-success-500);
    }

    .status-dot--offline {
      background: var(--color-error-500);
    }

    /* Feedback controls */
    .message-feedback {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--color-border);
      font-size: 12px;
    }

    .feedback-label {
      color: var(--color-text-muted);
    }

    .feedback-buttons {
      display: flex;
      gap: 4px;
    }

    .feedback-btn {
      background: none;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
      color: var(--color-text-secondary);
      transition: all 0.2s;
    }

    .feedback-btn:hover {
      background: var(--color-bg-subtle);
      border-color: var(--color-brand);
    }

    .feedback-btn.active {
      background: var(--color-brand);
      border-color: var(--color-brand);
      color: white;
    }

    .feedback-btn.positive:hover,
    .feedback-btn.positive.active {
      background: var(--color-success-500);
      border-color: var(--color-success-500);
      color: white;
    }

    .feedback-btn.negative:hover,
    .feedback-btn.negative.active {
      background: var(--color-error-500);
      border-color: var(--color-error-500);
      color: white;
    }

    .feedback-expand {
      background: none;
      border: none;
      color: var(--color-text-muted);
      cursor: pointer;
      font-size: 12px;
      padding: 4px;
    }

    .feedback-expand:hover {
      color: var(--color-brand);
    }

    .feedback-form {
      display: none;
      margin-top: 8px;
      padding: 12px;
      background: var(--color-bg-subtle);
      border-radius: 8px;
    }

    .feedback-form.visible {
      display: block;
    }

    .feedback-form label {
      display: block;
      font-size: 12px;
      color: var(--color-text-secondary);
      margin-bottom: 4px;
    }

    .feedback-form select,
    .feedback-form textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      background: var(--color-bg-card);
      color: var(--color-text);
      margin-bottom: 8px;
    }

    .feedback-form textarea {
      resize: vertical;
      min-height: 60px;
    }

    .feedback-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 8px;
    }

    .feedback-tag {
      font-size: 11px;
      padding: 4px 8px;
      border: 1px solid var(--color-border);
      border-radius: 12px;
      cursor: pointer;
      background: var(--color-bg-card);
      color: var(--color-text-secondary);
      transition: all 0.2s;
    }

    .feedback-tag:hover {
      border-color: var(--color-brand);
    }

    .feedback-tag.selected {
      background: var(--color-primary-100);
      border-color: var(--color-brand);
      color: var(--color-brand);
    }

    .feedback-submit {
      background: var(--color-brand);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .feedback-submit:hover {
      background: var(--color-brand-hover);
    }

    .feedback-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .feedback-success {
      color: var(--color-success-600);
      font-size: 12px;
      padding: 4px 0;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .message-content {
        max-width: 85%;
      }

      .chat-header h1 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div id="impersonation-banner" class="impersonation-banner"></div>
  <div id="adcp-nav"></div>

  <div class="chat-container">
    <div class="chat-header">
      <h1>
        <span class="addie-avatar">A</span>
        Chat with Addie
      </h1>
      <p>Your AI assistant for AdCP and Agentic Advertising</p>
    </div>

    <div class="messages-container" id="messagesContainer">
      <!-- Addie Home (shown for authenticated users) -->
      <div class="addie-home-container" id="addieHomeContainer">
        <div class="addie-home-loading" id="addieHomeLoading">Loading your dashboard...</div>
        <div id="addieHomeContent"></div>
        <style id="addieHomeStyles"></style>
      </div>

      <div class="welcome-message" id="welcomeMessage">
        <h2>Hi! I'm Addie</h2>
        <p>I'm here to help you learn about AdCP, the Advertising Context Protocol, and agentic advertising. Ask me anything!</p>
        <div class="suggested-prompts" id="suggestedPrompts">
          <button class="suggested-prompt" data-prompt="What is AdCP?">What is AdCP?</button>
          <button class="suggested-prompt" data-prompt="How do I get started with AdCP?">How do I get started?</button>
          <button class="suggested-prompt" data-prompt="What is agentic advertising?">What is agentic advertising?</button>
          <button class="suggested-prompt" data-prompt="How do I become an AAO member?">Become a member</button>
        </div>
      </div>
    </div>

    <div class="chat-input-container">
      <div class="chat-input-wrapper">
        <textarea
          class="chat-input"
          id="chatInput"
          placeholder="Ask Addie anything..."
          rows="1"
        ></textarea>
        <button class="send-button" id="sendButton" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
      <div class="status-indicator" id="statusIndicator">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">Connecting...</span>
      </div>
    </div>
  </div>

  <script src="/nav.js"></script>
  <script>
    (function() {
      'use strict';

      // Elements
      const messagesContainer = document.getElementById('messagesContainer');
      const welcomeMessage = document.getElementById('welcomeMessage');
      const chatInput = document.getElementById('chatInput');
      const sendButton = document.getElementById('sendButton');
      const suggestedPrompts = document.getElementById('suggestedPrompts');
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      const addieHomeContainer = document.getElementById('addieHomeContainer');
      const addieHomeContent = document.getElementById('addieHomeContent');
      const addieHomeLoading = document.getElementById('addieHomeLoading');
      const addieHomeStyles = document.getElementById('addieHomeStyles');

      // State
      let conversationId = null;
      let isLoading = false;
      let isReady = false;
      let impersonationInfo = null;
      let isAuthenticated = false;

      // Check for impersonation and authentication
      async function checkImpersonation() {
        try {
          const response = await fetch('/api/me');
          if (!response.ok) return; // Not authenticated

          const data = await response.json();
          isAuthenticated = true;

          if (data.impersonation && data.impersonation.active) {
            impersonationInfo = data.impersonation;
            const banner = document.getElementById('impersonation-banner');
            const reason = impersonationInfo.reason
              ? ` <span class="reason">"${impersonationInfo.reason}"</span>`
              : '';
            banner.innerHTML = `
              <strong>Impersonation Active</strong> -
              Viewing as <strong>${data.user.email}</strong>
              (impersonated by ${impersonationInfo.impersonator_email})${reason}
            `;
            banner.classList.add('active');
          }

          // Load Addie Home for authenticated users
          loadAddieHome();
        } catch (error) {
          // Silently ignore - user may not be authenticated
        }
      }

      // Load Addie Home content
      async function loadAddieHome() {
        if (!isAuthenticated) return;

        addieHomeContainer.classList.add('visible');
        addieHomeLoading.style.display = 'block';
        addieHomeContent.innerHTML = '';

        try {
          const response = await fetch('/api/me/addie-home?format=html');
          if (!response.ok) {
            throw new Error('Failed to load home content');
          }

          const data = await response.json();

          // Inject CSS
          addieHomeStyles.textContent = data.css;

          // Inject HTML
          addieHomeContent.innerHTML = data.html;
          addieHomeLoading.style.display = 'none';

          // Hide the generic welcome message since we have personalized content
          welcomeMessage.style.display = 'none';

          // Wire up action buttons
          setupHomeActions();
        } catch (error) {
          console.error('Failed to load Addie Home:', error);
          addieHomeLoading.style.display = 'none';
          addieHomeContent.innerHTML = '<div class="addie-home-error">Failed to load your dashboard</div>';
        }
      }

      // Setup click handlers for Addie Home action buttons
      function setupHomeActions() {
        // Handle quick action buttons
        addieHomeContent.querySelectorAll('.addie-home-action').forEach(button => {
          button.addEventListener('click', () => {
            const actionId = button.dataset.action;
            handleHomeAction(actionId);
          });
        });

        // Handle alert action buttons
        addieHomeContent.querySelectorAll('.addie-home-alert-action[data-action]').forEach(button => {
          button.addEventListener('click', () => {
            const actionId = button.dataset.action;
            handleHomeAction(actionId);
          });
        });
      }

      // Valid action IDs to prevent injection
      const VALID_HOME_ACTIONS = new Set([
        'addie_home_ask_addie',
        'addie_home_update_profile',
        'addie_home_browse_groups',
        'addie_home_view_flagged',
        'addie_home_pay_invoice',
        'addie_home_complete_profile',
        'addie_home_link_account',
      ]);

      // Handle Addie Home actions by starting a conversation
      function handleHomeAction(actionId) {
        // Validate action ID against whitelist
        if (!VALID_HOME_ACTIONS.has(actionId)) {
          console.warn('Invalid action ID:', actionId);
          return;
        }

        let prompt = '';

        switch (actionId) {
          case 'addie_home_ask_addie':
            // Just focus the input
            chatInput.focus();
            return;
          case 'addie_home_update_profile':
            prompt = 'Help me update my profile';
            break;
          case 'addie_home_browse_groups':
            prompt = 'Show me working groups I can join';
            break;
          case 'addie_home_view_flagged':
            prompt = 'Show me flagged conversations';
            break;
          case 'addie_home_pay_invoice':
            prompt = 'Help me pay my pending invoice';
            break;
          case 'addie_home_complete_profile':
            prompt = 'Help me complete my profile';
            break;
          case 'addie_home_link_account':
            prompt = 'Help me link my Slack account';
            break;
        }

        // Send the prompt as a message
        chatInput.value = prompt;
        autoResize();
        updateSendButton();
        sendMessage();
      }

      // Check Addie status
      async function checkStatus() {
        try {
          const response = await fetch('/api/addie/chat/status');
          const data = await response.json();
          isReady = data.ready;
          updateStatusIndicator();
        } catch (error) {
          isReady = false;
          updateStatusIndicator();
        }
      }

      function updateStatusIndicator() {
        if (isReady) {
          statusDot.classList.remove('status-dot--offline');
          statusText.textContent = 'Addie is online';
        } else {
          statusDot.classList.add('status-dot--offline');
          statusText.textContent = 'Addie is offline';
        }
        updateSendButton();
      }

      // Auto-resize textarea
      function autoResize() {
        chatInput.style.height = 'auto';
        chatInput.style.height = Math.min(chatInput.scrollHeight, 200) + 'px';
      }

      // Update send button state
      function updateSendButton() {
        const hasText = chatInput.value.trim().length > 0;
        sendButton.disabled = !hasText || isLoading || !isReady;
      }

      // Render markdown using marked library
      function renderMessage(text) {
        // Configure marked for security and compatibility
        marked.setOptions({
          breaks: true, // Convert \n to <br>
          gfm: true, // GitHub flavored markdown
        });

        // Helper to escape HTML attribute values
        const escapeAttr = (str) => str
          .replace(/&/g, '&amp;')
          .replace(/"/g, '&quot;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');

        // Use marked's built-in renderer with custom link handling
        const renderer = new marked.Renderer();
        renderer.link = function(href, title, text) {
          // Handle marked v17+ which passes an object
          if (typeof href === 'object') {
            const link = href;
            href = link.href;
            title = link.title;
            text = link.text;
          }
          // Validate URL scheme - only allow safe protocols
          const safeHref = /^(https?:\/\/|mailto:|#)/i.test(href) ? href : '#';
          const titleAttr = title ? ` title="${escapeAttr(title)}"` : '';
          return `<a href="${escapeAttr(safeHref)}"${titleAttr} target="_blank" rel="noopener noreferrer">${text}</a>`;
        };

        return marked.parse(text, { renderer });
      }

      // Add message to chat
      function addMessage(content, role, messageId = null) {
        // Hide welcome message
        if (welcomeMessage) {
          welcomeMessage.style.display = 'none';
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message message--${role}`;

        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        avatarDiv.textContent = role === 'assistant' ? 'A' : '';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.innerHTML = renderMessage(content);

        // Add feedback controls for assistant messages
        if (role === 'assistant' && messageId) {
          const feedbackDiv = createFeedbackUI(messageId);
          contentDiv.appendChild(feedbackDiv);
        }

        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        messagesContainer.appendChild(messageDiv);

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        return messageDiv;
      }

      // Create feedback UI for a message
      function createFeedbackUI(messageId) {
        const container = document.createElement('div');
        container.className = 'message-feedback';
        container.innerHTML = `
          <span class="feedback-label">Was this helpful?</span>
          <div class="feedback-buttons">
            <button class="feedback-btn positive" data-rating="5" title="Helpful">&#128077;</button>
            <button class="feedback-btn negative" data-rating="1" title="Not helpful">&#128078;</button>
          </div>
          <button class="feedback-expand" title="Add more feedback">More...</button>
          <div class="feedback-form">
            <label>What could be better?</label>
            <select class="feedback-category">
              <option value="">Select category</option>
              <option value="accuracy">Accuracy - Information was wrong</option>
              <option value="completeness">Completeness - Missing important info</option>
              <option value="helpfulness">Helpfulness - Didn't solve my problem</option>
              <option value="clarity">Clarity - Hard to understand</option>
              <option value="tone">Tone - Response style</option>
            </select>
            <label>Tags (click to select)</label>
            <div class="feedback-tags">
              <span class="feedback-tag" data-tag="wrong_answer">Wrong answer</span>
              <span class="feedback-tag" data-tag="missing_info">Missing info</span>
              <span class="feedback-tag" data-tag="too_long">Too long</span>
              <span class="feedback-tag" data-tag="too_short">Too short</span>
              <span class="feedback-tag" data-tag="outdated">Outdated</span>
              <span class="feedback-tag" data-tag="off_topic">Off topic</span>
            </div>
            <label>How could we improve? (optional)</label>
            <textarea class="feedback-suggestion" placeholder="Tell us what would make this answer better..."></textarea>
            <button class="feedback-submit" disabled>Submit Feedback</button>
            <div class="feedback-success" style="display:none;">Thank you for your feedback!</div>
          </div>
        `;

        let selectedRating = null;
        const selectedTags = new Set();

        // Quick rating buttons
        container.querySelectorAll('.feedback-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            selectedRating = parseInt(btn.dataset.rating);
            container.querySelectorAll('.feedback-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            container.querySelector('.feedback-submit').disabled = false;

            // Auto-submit simple thumbs up/down
            if (selectedRating === 5) {
              await submitFeedback(messageId, selectedRating, null, [], null);
              showFeedbackSuccess(container);
            }
          });
        });

        // Expand to show full form
        container.querySelector('.feedback-expand').addEventListener('click', () => {
          container.querySelector('.feedback-form').classList.toggle('visible');
        });

        // Tag selection
        container.querySelectorAll('.feedback-tag').forEach(tag => {
          tag.addEventListener('click', () => {
            const tagValue = tag.dataset.tag;
            if (selectedTags.has(tagValue)) {
              selectedTags.delete(tagValue);
              tag.classList.remove('selected');
            } else {
              selectedTags.add(tagValue);
              tag.classList.add('selected');
            }
          });
        });

        // Submit full feedback
        container.querySelector('.feedback-submit').addEventListener('click', async () => {
          const category = container.querySelector('.feedback-category').value || null;
          const suggestion = container.querySelector('.feedback-suggestion').value.trim() || null;

          await submitFeedback(messageId, selectedRating || 3, category, Array.from(selectedTags), suggestion);
          showFeedbackSuccess(container);
        });

        return container;
      }

      function showFeedbackSuccess(container) {
        container.querySelector('.feedback-form').classList.remove('visible');
        container.querySelector('.feedback-buttons').style.display = 'none';
        container.querySelector('.feedback-expand').style.display = 'none';
        container.querySelector('.feedback-label').textContent = 'Thanks for your feedback!';
        container.querySelector('.feedback-label').style.color = 'var(--color-success-600)';
      }

      async function submitFeedback(messageId, rating, category, tags, suggestion) {
        try {
          await fetch(`/api/addie/chat/${conversationId}/feedback`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message_id: messageId,
              rating: rating,
              rating_category: category,
              feedback_tags: tags.length > 0 ? tags : null,
              improvement_suggestion: suggestion
            })
          });
        } catch (error) {
          console.error('Failed to submit feedback:', error);
        }
      }

      // Add typing indicator
      function addTypingIndicator() {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message message--assistant';
        messageDiv.id = 'typingIndicator';

        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        avatarDiv.textContent = 'A';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';

        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        messagesContainer.appendChild(messageDiv);

        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Remove typing indicator
      function removeTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) {
          indicator.remove();
        }
      }

      // Create a streaming message element that can be updated
      function createStreamingMessage() {
        // Hide welcome message
        if (welcomeMessage) {
          welcomeMessage.style.display = 'none';
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message message--assistant';
        messageDiv.id = 'streamingMessage';

        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        avatarDiv.textContent = 'A';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.innerHTML = '<span class="streaming-cursor">|</span>';

        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        messagesContainer.appendChild(messageDiv);

        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        return { messageDiv, contentDiv };
      }

      // Check if text has balanced markdown markers
      // Uses arithmetic instead of lookbehind regex for Safari compatibility
      function hasBalancedMarkdown(text) {
        // Count bold markers (**)
        const boldCount = (text.match(/\*\*/g) || []).length;
        // Calculate italic: total asterisks minus those used in bold
        const allAsterisks = (text.match(/\*/g) || []).length;
        const italicCount = allAsterisks - (boldCount * 2);

        // Count code block markers (```) first, then calculate inline code
        const codeBlockCount = (text.match(/```/g) || []).length;
        const allBackticks = (text.match(/`/g) || []).length;
        const inlineCodeCount = allBackticks - (codeBlockCount * 3);

        // Count link brackets - check for unmatched link syntax
        const openBrackets = (text.match(/\[/g) || []).length;
        const closeBrackets = (text.match(/\]/g) || []).length;
        // Count ]( which indicates a complete link opening
        const linkOpens = (text.match(/\]\(/g) || []).length;

        return boldCount % 2 === 0 &&
               italicCount % 2 === 0 &&
               inlineCodeCount % 2 === 0 &&
               codeBlockCount % 2 === 0 &&
               openBrackets === closeBrackets;
      }

      // Strip markdown markers for plain text display during streaming
      function stripMarkdownMarkers(text) {
        return text
          .replace(/\*\*/g, '')      // Bold **
          .replace(/\*/g, '')        // Italic *
          .replace(/`{3}[^\n]*\n?/g, '') // Code blocks ```
          .replace(/`/g, '')         // Inline code `
          .replace(/^#{1,6}\s*/gm, '') // Headers #
          .replace(/^\s*[-*+]\s+/gm, '• ') // List items
          .replace(/^\s*\d+\.\s+/gm, '• ') // Numbered lists
          .replace(/~~([^~]+)~~/g, '$1') // Strikethrough
          .replace(/^\s*>\s*/gm, '')  // Blockquotes
          .replace(/!?\[([^\]]*)\]\([^)]*\)/g, '$1') // Links and images - keep text
          .replace(/^[-*_]{3,}\s*$/gm, ''); // Horizontal rules
      }

      // Append text to streaming message
      // Strategy: Split into paragraphs, render complete ones with balanced markdown,
      // show the incomplete trailing paragraph as plain text (with markers stripped)
      function appendToStreamingMessage(contentDiv, text, fullContent) {
        // Split on paragraph breaks (double newline)
        const paragraphs = fullContent.split(/\n\n/);

        if (paragraphs.length === 1) {
          // No complete paragraphs yet - show as plain text with markers stripped
          const stripped = stripMarkdownMarkers(fullContent);
          const escaped = stripped
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\n/g, '<br>');
          contentDiv.innerHTML = escaped + '<span class="streaming-cursor">|</span>';
        } else {
          // Process each paragraph individually
          const completeParagraphs = paragraphs.slice(0, -1);
          const remainder = paragraphs[paragraphs.length - 1];

          // Render each complete paragraph - if it has balanced markdown, render it;
          // otherwise show as plain text with markers stripped
          const renderedParagraphs = completeParagraphs.map(para => {
            if (hasBalancedMarkdown(para)) {
              return renderMessage(para);
            } else {
              // Unbalanced - strip markers and escape
              const stripped = stripMarkdownMarkers(para);
              const escaped = stripped
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>');
              return '<p>' + escaped + '</p>';
            }
          });

          // Strip markers from remainder (incomplete paragraph)
          const strippedRemainder = stripMarkdownMarkers(remainder);
          const escapedRemainder = strippedRemainder
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\n/g, '<br>');

          contentDiv.innerHTML = renderedParagraphs.join('') +
            (escapedRemainder ? '<p>' + escapedRemainder + '<span class="streaming-cursor">|</span></p>' : '<span class="streaming-cursor">|</span>');
        }
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Finalize streaming message with feedback UI
      function finalizeStreamingMessage(messageDiv, contentDiv, fullContent, messageId) {
        // Remove cursor and render final content
        contentDiv.innerHTML = renderMessage(fullContent);

        // Add feedback controls
        if (messageId) {
          const feedbackDiv = createFeedbackUI(messageId);
          contentDiv.appendChild(feedbackDiv);
        }

        // Remove streaming ID
        messageDiv.removeAttribute('id');
      }

      // Show error toast
      function showError(message) {
        const toast = document.createElement('div');
        toast.className = 'error-toast';
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, 5000);
      }

      // Send message with streaming
      async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message || isLoading || !isReady) return;

        isLoading = true;
        updateSendButton();

        // Add user message
        addMessage(message, 'user');

        // Clear input
        chatInput.value = '';
        autoResize();

        // Create streaming message element
        const { messageDiv, contentDiv } = createStreamingMessage();
        let fullContent = '';
        let messageId = null;

        try {
          const response = await fetch('/api/addie/chat/stream', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              message,
              conversation_id: conversationId,
            }),
          });

          if (!response.ok) {
            throw new Error('Failed to send message');
          }

          // Read the SSE stream
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let currentEventType = '';

          // Helper to process SSE lines (uses closure for currentEventType)
          const processLines = (lines) => {
            for (const line of lines) {
              if (line.startsWith('event: ')) {
                currentEventType = line.slice(7);
              } else if (line.startsWith('data: ') && currentEventType) {
                try {
                  const data = JSON.parse(line.slice(6));

                  if (currentEventType === 'text') {
                    fullContent += data.text;
                    appendToStreamingMessage(contentDiv, data.text, fullContent);
                  } else if (currentEventType === 'meta') {
                    conversationId = data.conversation_id;
                  } else if (currentEventType === 'done') {
                    messageId = data.message_id;
                    conversationId = data.conversation_id;
                  } else if (currentEventType === 'error') {
                    throw new Error(data.error || 'Unknown error');
                  }
                  // tool_start and tool_end events are informational, could show status
                } catch (parseError) {
                  console.warn('Failed to parse SSE data:', parseError);
                }
                currentEventType = '';
              }
            }
          };

          while (true) {
            const { done, value } = await reader.read();

            if (done) {
              // Flush the decoder to handle any remaining multi-byte characters
              buffer += decoder.decode();
              // Process any remaining complete events
              if (buffer.trim()) {
                const lines = buffer.split('\n');
                processLines(lines);
              }
              break;
            }

            buffer += decoder.decode(value, { stream: true });

            // Process complete events in the buffer
            const lines = buffer.split('\n');
            buffer = lines.pop() || ''; // Keep incomplete line in buffer

            processLines(lines);
          }

          // Finalize the message with feedback UI
          finalizeStreamingMessage(messageDiv, contentDiv, fullContent, messageId);

        } catch (error) {
          console.error('Error sending message:', error);
          // Remove the streaming message and show error
          if (messageDiv.parentNode) {
            messageDiv.remove();
          }
          showError('Failed to send message. Please try again.');
        } finally {
          isLoading = false;
          updateSendButton();
        }
      }

      // Event listeners
      chatInput.addEventListener('input', () => {
        autoResize();
        updateSendButton();
      });

      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      sendButton.addEventListener('click', sendMessage);

      // Suggested prompts
      suggestedPrompts.addEventListener('click', (e) => {
        if (e.target.classList.contains('suggested-prompt')) {
          const prompt = e.target.dataset.prompt;
          chatInput.value = prompt;
          autoResize();
          updateSendButton();
          sendMessage();
        }
      });

      // Initialize
      checkStatus();
      checkImpersonation();
      // Check status periodically
      setInterval(checkStatus, 30000);

    })();
  </script>
</body>
</html>
