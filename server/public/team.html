<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Team Management - AdCP Registry</title>
  <link rel="stylesheet" href="/design-system.css">
  <style>
    /* =============================================================================
       Team Management styles
       Uses design system variables - see /design-system.css for tokens
       ============================================================================= */

    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-lg);
      margin: var(--space-10) auto;
      padding: 0 var(--space-5);
    }
    .breadcrumb {
      margin-bottom: var(--space-5);
    }
    .breadcrumb a {
      color: var(--color-brand);
      text-decoration: none;
    }
    .breadcrumb a:hover {
      text-decoration: underline;
    }
    .breadcrumb span {
      color: var(--color-text-secondary);
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-8);
    }
    h1 {
      color: var(--color-text-heading);
      font-size: var(--text-3xl);
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-8);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-sm);
    }
    .card h2 {
      color: var(--color-text-heading);
      margin-bottom: var(--space-4);
      font-size: var(--text-xl);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    /* Buttons now use design-system.css classes:
       .btn .btn-primary = blue background
       .btn .btn-secondary = gray background
       .btn .btn-danger = red background
       .btn .btn-sm = smaller size for table actions
    */
    .members-table {
      width: 100%;
      border-collapse: collapse;
    }
    .members-table th,
    .members-table td {
      padding: var(--space-3);
      text-align: left;
      border-bottom: var(--border-1) solid var(--color-gray-100);
    }
    .members-table th {
      color: var(--color-text-secondary);
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      text-transform: uppercase;
    }
    .members-table tbody tr:hover {
      background: var(--color-gray-50);
    }
    .member-email {
      font-weight: var(--font-medium);
    }
    .member-name {
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
    }
    .role-badge {
      display: inline-block;
      padding: var(--space-1) var(--space-2.5);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .role-owner {
      background: var(--color-info-100);
      color: var(--color-info-700);
    }
    .role-admin {
      background: var(--color-primary-100);
      color: var(--color-primary-700);
    }
    .role-member {
      background: var(--color-gray-100);
      color: var(--color-text-secondary);
    }
    .status-badge {
      display: inline-block;
      padding: var(--space-1) var(--space-2.5);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .status-active {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .status-pending {
      background: var(--color-warning-100);
      color: var(--color-warning-700);
    }
    .action-buttons {
      display: flex;
      gap: var(--space-2);
    }
    .loading {
      text-align: center;
      padding: var(--space-10);
      color: var(--color-text-secondary);
    }
    .empty-state {
      text-align: center;
      padding: var(--space-10);
      color: var(--color-text-secondary);
    }
    .empty-state p {
      margin-bottom: var(--space-5);
    }
    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--color-surface-overlay);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.show {
      display: flex;
    }
    .modal {
      background: var(--color-bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-8);
      max-width: var(--container-sm);
      width: 90%;
      box-shadow: var(--shadow-xl);
    }
    .modal h2 {
      margin-bottom: var(--space-5);
      display: block;
    }
    .modal-buttons {
      display: flex;
      gap: var(--space-2.5);
      margin-top: var(--space-5);
      justify-content: flex-end;
    }
    .form-group {
      margin-bottom: var(--space-5);
    }
    .form-group label {
      display: block;
      margin-bottom: var(--space-2);
      color: var(--color-text-heading);
      font-weight: var(--font-medium);
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: var(--space-2.5) var(--space-3);
      border: var(--border-1) solid var(--color-gray-300);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--color-brand);
      box-shadow: 0 0 0 3px var(--color-primary-100);
    }
    .form-help {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      margin-top: var(--space-1);
    }
    .error-message {
      background: var(--color-error-50);
      color: var(--color-error-600);
      padding: var(--space-2.5) var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-4);
      font-size: var(--text-sm);
    }
    .success-message {
      background: var(--color-success-100);
      color: var(--color-success-700);
      padding: var(--space-2.5) var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-4);
      font-size: var(--text-sm);
    }
    .info-box {
      background: var(--color-info-50);
      border-left: var(--border-4) solid var(--color-info-500);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-5);
    }
    .info-box p {
      color: var(--color-info-700);
      margin: 0;
    }
    .permission-warning {
      background: var(--color-warning-50);
      border-left: var(--border-4) solid var(--color-warning-500);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-5);
    }
    .permission-warning p {
      color: var(--color-warning-700);
      margin: 0;
    }
    /* Override dashboard-nav's container reset to keep content properly sized */
    .dashboard-main .container {
      max-width: var(--container-lg) !important;
      margin: var(--space-6) auto !important;
    }
    /* Domain verification section */
    .domain-section {
      margin-top: var(--space-4);
      padding-top: var(--space-4);
      border-top: var(--border-1) solid var(--color-gray-100);
    }
    .domain-section h3 {
      font-size: var(--text-base);
      margin-bottom: var(--space-2.5);
      color: var(--color-text-heading);
    }
    .domain-section p {
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
      margin-bottom: var(--space-2.5);
    }
  </style>
</head>
<body>
  <!-- Shared Navigation -->
  <div id="adcp-nav"></div>
  <script src="/nav.js"></script>
  <script src="/dashboard-nav.js"></script>

  <!-- Invite Modal -->
  <div id="inviteModal" class="modal-overlay">
    <div class="modal">
      <h2>Invite Team Member</h2>
      <div id="inviteError" class="error-message" style="display: none;"></div>
      <form id="inviteForm">
        <div class="form-group">
          <label for="inviteEmail">Email Address</label>
          <input type="email" id="inviteEmail" placeholder="colleague@company.com" required>
          <p class="form-help">An invitation email will be sent to this address</p>
        </div>
        <div class="form-group">
          <label for="inviteRole">Role</label>
          <select id="inviteRole">
            <option value="member">Member - Standard access</option>
            <option value="admin">Admin - Can manage members</option>
          </select>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeInviteModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Send Invitation</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Role Modal -->
  <div id="editRoleModal" class="modal-overlay">
    <div class="modal">
      <h2>Change Member Role</h2>
      <div id="editRoleError" class="error-message" style="display: none;"></div>
      <form id="editRoleForm">
        <input type="hidden" id="editMembershipId">
        <div class="form-group">
          <label>Member</label>
          <p id="editMemberEmail" style="font-weight: 500; padding: 10px 0;"></p>
        </div>
        <div class="form-group">
          <label for="editRole">New Role</label>
          <select id="editRole">
            <option value="member">Member - Standard access</option>
            <option value="admin">Admin - Can manage members</option>
            <option value="owner">Owner - Full access</option>
          </select>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeEditRoleModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Role</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Remove Member Modal -->
  <div id="removeModal" class="modal-overlay">
    <div class="modal">
      <h2>Remove Member</h2>
      <input type="hidden" id="removeMembershipId">
      <p style="margin-bottom: var(--space-4);">Are you sure you want to remove <strong id="removeMemberEmail"></strong> from this organization?</p>
      <p style="color: var(--color-text-secondary); font-size: var(--text-sm); margin-bottom: var(--space-5);">This action cannot be undone. The member will lose access to the organization immediately.</p>
      <div class="modal-buttons">
        <button type="button" class="btn btn-secondary" onclick="closeRemoveModal()">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="confirmRemoveMember()">Remove Member</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="breadcrumb">
      <a href="/dashboard">Dashboard</a> <span>&nbsp;/&nbsp; Team Management</span>
    </div>

    <div class="page-header">
      <h1>Team Management</h1>
    </div>

    <div id="loading" class="loading">
      Loading...
    </div>

    <div id="permissionWarning" class="permission-warning" style="display: none;">
      <p>You have view-only access to this organization. Contact an admin or owner to manage team members.</p>
    </div>

    <!-- Personal workspace notice -->
    <div id="personalWorkspaceNotice" class="info-box" style="display: none;">
      <p><strong>Personal workspaces don't support team features.</strong></p>
      <p style="margin-top: 8px;">Personal workspaces are for individual use only. To invite team members and claim a corporate domain, you'll need to convert this to a team workspace.</p>
      <div style="margin-top: 16px;">
        <a href="/dashboard/settings" class="btn btn-primary">Go to Settings to Upgrade</a>
      </div>
    </div>

    <div id="content" style="display: none;">
      <div class="card">
        <h2>
          <span>Team Members</span>
          <button id="inviteBtn" class="btn btn-primary" onclick="openInviteModal()">+ Invite Member</button>
        </h2>

        <div id="membersLoading" class="loading">
          Loading team members...
        </div>

        <div id="membersContent" style="display: none;">
          <table class="members-table">
            <thead>
              <tr>
                <th>Member</th>
                <th>Role</th>
                <th>Status</th>
                <th>Joined</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="membersTableBody">
            </tbody>
          </table>
        </div>

        <div id="noMembers" class="empty-state" style="display: none;">
          <p>No team members yet. Invite your first team member!</p>
        </div>
      </div>

      <div id="invitationsCard" class="card" style="display: none;">
        <h2>Pending Invitations</h2>
        <table class="members-table">
          <thead>
            <tr>
              <th>Email</th>
              <th>Status</th>
              <th>Expires</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="invitationsTableBody">
          </tbody>
        </table>
      </div>

      <div id="joinRequestsCard" class="card" style="display: none;">
        <h2>Join Requests</h2>
        <p style="color: var(--color-text-secondary); font-size: var(--text-sm); margin-bottom: var(--space-4);">
          People who have requested to join your organization.
        </p>
        <table class="members-table">
          <thead>
            <tr>
              <th>Email</th>
              <th>Requested</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="joinRequestsTableBody">
          </tbody>
        </table>
      </div>

      <div class="card" id="domainsCard">
        <h2>Verified Domains</h2>
        <div id="domainsContent">
          <div style="text-align: center; padding: 20px; color: var(--color-text-secondary);">Loading domains...</div>
        </div>
        <div style="margin-top: 16px;">
          <button class="btn btn-secondary" onclick="openDomainVerification()">Manage Domains</button>
        </div>
      </div>

      <div class="card" id="domainUsersCard" style="display: none;">
        <h2>Potential Members</h2>
        <div class="info-box">
          <p>These people are in the AgenticAdvertising.org Slack workspace with your verified domain but haven't joined your organization yet.</p>
        </div>
        <div id="domainUsersContent">
          <div style="text-align: center; padding: 20px; color: var(--color-text-secondary);">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let currentOrg = null;
    let currentOrgIsPersonal = false;
    let currentUserRole = null;
    let availableRoles = [];
    let userOrganizations = [];

    async function loadUserData() {
      try {
        const response = await fetch('/api/me');
        if (!response.ok) {
          if (response.status === 401) {
            window.location.href = '/auth/login?return_to=/team';
            return;
          }
          throw new Error('Failed to load user data');
        }

        const data = await response.json();
        currentUser = data.user;
        const isAdmin = currentUser?.isAdmin || false;

        if (data.organizations && data.organizations.length > 0) {
          userOrganizations = data.organizations;

          // Determine which org to use: URL param or first org
          const urlParams = new URLSearchParams(window.location.search);
          const orgIdParam = urlParams.get('org');

          let selectedOrg;
          if (orgIdParam && data.organizations.some(o => o.id === orgIdParam)) {
            selectedOrg = data.organizations.find(o => o.id === orgIdParam);
          } else {
            selectedOrg = data.organizations[0];
          }

          currentOrg = selectedOrg.id;
          currentUserRole = selectedOrg.role || 'member';
          currentOrgIsPersonal = selectedOrg.is_personal || false;

          document.getElementById('loading').style.display = 'none';

          // If personal workspace, show notice and hide team features
          if (currentOrgIsPersonal) {
            document.getElementById('personalWorkspaceNotice').style.display = 'block';
            document.getElementById('content').style.display = 'none';
            // Still initialize sidebar
            if (typeof DashboardNav !== 'undefined') {
              DashboardNav.init({
                showOrgSwitcher: false,
                currentOrgName: selectedOrg.name || 'Organization',
                isPersonal: true,
                isSubscribed: false,
                showAdmin: isAdmin
              });
            }
            return;
          }

          let isSubscribed = false;

          // Fetch billing info for subscription status
          try {
            const billingResponse = await fetch(`/api/billing?org=${selectedOrg.id}`, { credentials: 'include' });
            if (billingResponse.ok) {
              const billingData = await billingResponse.json();
              isSubscribed = billingData.subscription?.status === 'active' ||
                            billingData.subscription?.status === 'trialing';
            }
          } catch (e) {
            console.error('Failed to fetch billing info:', e);
          }

          // Initialize dashboard sidebar
          if (typeof DashboardNav !== 'undefined') {
            DashboardNav.init({
              showOrgSwitcher: false,
              currentOrgName: selectedOrg.name || 'Organization',
              isPersonal: currentOrgIsPersonal,
              isSubscribed: isSubscribed,
              showAdmin: isAdmin
            });
          }

          loadTeamMembers();
        } else {
          document.getElementById('loading').innerHTML = `
            <p>You don't belong to any organizations yet.</p>
            <p><a href="/onboarding" style="color: var(--color-brand);">Create your first organization</a></p>
          `;
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        document.getElementById('loading').innerHTML = `
          <p style="color: var(--color-error-600);">Failed to load user data. <a href="/auth/login">Try logging in again</a></p>
        `;
      }
    }

    async function loadTeamMembers() {
      const orgId = currentOrg;

      if (!orgId) {
        document.getElementById('content').style.display = 'none';
        return;
      }

      // Update URL with org param
      const url = new URL(window.location);
      url.searchParams.set('org', orgId);
      window.history.replaceState({}, '', url);

      document.getElementById('content').style.display = 'block';
      document.getElementById('membersLoading').style.display = 'block';
      document.getElementById('membersContent').style.display = 'none';
      document.getElementById('noMembers').style.display = 'none';

      // Show/hide permission warning and invite button based on role
      const canManage = currentUserRole === 'owner' || currentUserRole === 'admin';
      document.getElementById('permissionWarning').style.display = canManage ? 'none' : 'block';
      document.getElementById('inviteBtn').style.display = canManage ? 'inline-block' : 'none';

      try {
        // Load roles
        const rolesResponse = await fetch(`/api/organizations/${orgId}/roles`);
        if (rolesResponse.ok) {
          const rolesData = await rolesResponse.json();
          availableRoles = rolesData.roles || [];
        }

        // Load members
        const response = await fetch(`/api/organizations/${orgId}/members`);
        if (!response.ok) {
          throw new Error('Failed to load team members');
        }

        const data = await response.json();

        document.getElementById('membersLoading').style.display = 'none';

        if (data.members && data.members.length > 0) {
          document.getElementById('membersContent').style.display = 'block';
          renderMembers(data.members, canManage);
        } else {
          document.getElementById('noMembers').style.display = 'block';
        }

        // Render pending invitations
        if (data.pending_invitations && data.pending_invitations.length > 0) {
          document.getElementById('invitationsCard').style.display = 'block';
          renderInvitations(data.pending_invitations, canManage);
        } else {
          document.getElementById('invitationsCard').style.display = 'none';
        }

        // Load join requests (only for admins/owners)
        if (canManage) {
          await loadJoinRequests(orgId);
        } else {
          document.getElementById('joinRequestsCard').style.display = 'none';
        }

        // Load verified domains
        await loadDomains(orgId);

        // Load domain users (only for admins/owners)
        if (canManage) {
          await loadDomainUsers(orgId);
        } else {
          document.getElementById('domainUsersCard').style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading team members:', error);
        document.getElementById('membersLoading').innerHTML = `
          <p style="color: var(--color-error-600);">Failed to load team members. Please try again.</p>
        `;
      }
    }

    async function loadJoinRequests(orgId) {
      try {
        const response = await fetch(`/api/organizations/${orgId}/join-requests`);
        if (!response.ok) {
          throw new Error('Failed to load join requests');
        }

        const data = await response.json();

        if (data.requests && data.requests.length > 0) {
          document.getElementById('joinRequestsCard').style.display = 'block';
          renderJoinRequests(data.requests);
        } else {
          document.getElementById('joinRequestsCard').style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading join requests:', error);
        document.getElementById('joinRequestsCard').style.display = 'none';
      }
    }

    function renderJoinRequests(requests) {
      const tbody = document.getElementById('joinRequestsTableBody');
      tbody.innerHTML = requests.map(req => {
        const requestedDate = new Date(req.created_at).toLocaleDateString();
        const hasName = req.first_name && req.last_name;
        const displayName = hasName ? `${req.first_name} ${req.last_name}` : null;

        return `
          <tr id="join-request-${req.id}">
            <td>
              ${displayName ? `<div class="member-name" style="font-weight: 500; color: var(--color-text-heading);">${escapeHtml(displayName)}</div>` : ''}
              <div class="member-email" style="${displayName ? 'font-size: 12px; color: var(--color-text-secondary);' : ''}">${escapeHtml(req.user_email)}</div>
            </td>
            <td>${requestedDate}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-primary btn-sm" onclick="approveJoinRequest('${req.id}')">
                  Approve
                </button>
                <button class="btn btn-danger btn-sm" onclick="rejectJoinRequest('${req.id}')">
                  Reject
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function approveJoinRequest(requestId) {
      try {
        const response = await fetch(`/api/organizations/${currentOrg}/join-requests/${requestId}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role: 'member' }),
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'Failed to approve request');
        }

        // Remove the row from the table
        const row = document.getElementById(`join-request-${requestId}`);
        if (row) {
          row.remove();
        }

        // Check if table is now empty
        const tbody = document.getElementById('joinRequestsTableBody');
        if (tbody.children.length === 0) {
          document.getElementById('joinRequestsCard').style.display = 'none';
        }

        // Show success message
        alert('Join request approved! An invitation has been sent to the user.');
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function rejectJoinRequest(requestId) {
      const reason = prompt('Optional: Enter a reason for rejection (or leave blank):');

      try {
        const response = await fetch(`/api/organizations/${currentOrg}/join-requests/${requestId}/reject`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason: reason || undefined }),
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'Failed to reject request');
        }

        // Remove the row from the table
        const row = document.getElementById(`join-request-${requestId}`);
        if (row) {
          row.remove();
        }

        // Check if table is now empty
        const tbody = document.getElementById('joinRequestsTableBody');
        if (tbody.children.length === 0) {
          document.getElementById('joinRequestsCard').style.display = 'none';
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function renderMembers(members, canManage) {
      const tbody = document.getElementById('membersTableBody');
      tbody.innerHTML = members.map(member => {
        const isCurrentUser = member.user_id === currentUser.id;
        const displayName = member.first_name || member.last_name
          ? `${member.first_name || ''} ${member.last_name || ''}`.trim()
          : '';

        const roleClass = `role-${member.role}`;
        const roleName = member.role.charAt(0).toUpperCase() + member.role.slice(1);

        const statusClass = `status-${member.status}`;
        const statusName = member.status.charAt(0).toUpperCase() + member.status.slice(1);

        const joinedDate = new Date(member.created_at).toLocaleDateString();

        const slackIcon = member.slack_linked
          ? '<span title="Linked to Slack" style="margin-left: 6px; display: inline-flex; align-items: center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z" fill="#611f69"/></svg></span>'
          : '';

        let actions = '';
        if (canManage && !isCurrentUser) {
          actions = `
            <button class="btn btn-secondary" onclick="openEditRoleModal('${member.id}', '${member.email}', '${member.role}')">
              Change Role
            </button>
            <button class="btn btn-danger" onclick="openRemoveModal('${member.id}', '${member.email}')">
              Remove
            </button>
          `;
        } else if (isCurrentUser) {
          actions = '<span style="color: var(--color-text-secondary); font-size: var(--text-sm);">You</span>';
        }

        return `
          <tr>
            <td>
              <div class="member-email" style="display: flex; align-items: center;">${escapeHtml(member.email)}${slackIcon}</div>
              ${displayName ? `<div class="member-name">${escapeHtml(displayName)}</div>` : ''}
            </td>
            <td><span class="role-badge ${roleClass}">${roleName}</span></td>
            <td><span class="status-badge ${statusClass}">${statusName}</span></td>
            <td>${joinedDate}</td>
            <td>
              <div class="action-buttons">
                ${actions}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderInvitations(invitations, canManage) {
      const tbody = document.getElementById('invitationsTableBody');
      tbody.innerHTML = invitations.map(inv => {
        const expiresDate = new Date(inv.expires_at).toLocaleDateString();

        let actions = '';
        if (canManage) {
          actions = `
            <button class="btn btn-secondary" onclick="resendInvitation('${inv.id}')">
              Resend
            </button>
            <button class="btn btn-danger" onclick="revokeInvitation('${inv.id}')">
              Revoke
            </button>
          `;
        }

        return `
          <tr>
            <td><div class="member-email">${inv.email}</div></td>
            <td><span class="status-badge status-pending">Pending</span></td>
            <td>${expiresDate}</td>
            <td>
              <div class="action-buttons">
                ${actions}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Invite Modal
    function openInviteModal() {
      document.getElementById('inviteModal').classList.add('show');
      document.getElementById('inviteEmail').value = '';
      document.getElementById('inviteRole').value = 'member';
      document.getElementById('inviteError').style.display = 'none';
      document.getElementById('inviteEmail').focus();
    }

    function closeInviteModal() {
      document.getElementById('inviteModal').classList.remove('show');
    }

    document.getElementById('inviteForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('inviteEmail').value;
      const role = document.getElementById('inviteRole').value;

      try {
        const response = await fetch(`/api/organizations/${currentOrg}/invitations`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, role }),
        });

        const data = await response.json();

        if (!response.ok) {
          document.getElementById('inviteError').textContent = data.message || 'Failed to send invitation';
          document.getElementById('inviteError').style.display = 'block';
          return;
        }

        closeInviteModal();
        loadTeamMembers();
      } catch (error) {
        console.error('Error sending invitation:', error);
        document.getElementById('inviteError').textContent = 'Failed to send invitation. Please try again.';
        document.getElementById('inviteError').style.display = 'block';
      }
    });

    // Edit Role Modal
    function openEditRoleModal(membershipId, email, currentRole) {
      document.getElementById('editRoleModal').classList.add('show');
      document.getElementById('editMembershipId').value = membershipId;
      document.getElementById('editMemberEmail').textContent = email;
      document.getElementById('editRole').value = currentRole;
      document.getElementById('editRoleError').style.display = 'none';
    }

    function closeEditRoleModal() {
      document.getElementById('editRoleModal').classList.remove('show');
    }

    document.getElementById('editRoleForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const membershipId = document.getElementById('editMembershipId').value;
      const role = document.getElementById('editRole').value;

      try {
        const response = await fetch(`/api/organizations/${currentOrg}/members/${membershipId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role }),
        });

        const data = await response.json();

        if (!response.ok) {
          document.getElementById('editRoleError').textContent = data.message || 'Failed to update role';
          document.getElementById('editRoleError').style.display = 'block';
          return;
        }

        closeEditRoleModal();
        loadTeamMembers();
      } catch (error) {
        console.error('Error updating role:', error);
        document.getElementById('editRoleError').textContent = 'Failed to update role. Please try again.';
        document.getElementById('editRoleError').style.display = 'block';
      }
    });

    // Remove Member Modal
    function openRemoveModal(membershipId, email) {
      document.getElementById('removeModal').classList.add('show');
      document.getElementById('removeMembershipId').value = membershipId;
      document.getElementById('removeMemberEmail').textContent = email;
    }

    function closeRemoveModal() {
      document.getElementById('removeModal').classList.remove('show');
    }

    async function confirmRemoveMember() {
      const membershipId = document.getElementById('removeMembershipId').value;

      try {
        const response = await fetch(`/api/organizations/${currentOrg}/members/${membershipId}`, {
          method: 'DELETE',
        });

        if (!response.ok) {
          const data = await response.json();
          alert(data.message || 'Failed to remove member');
          return;
        }

        closeRemoveModal();
        loadTeamMembers();
      } catch (error) {
        console.error('Error removing member:', error);
        alert('Failed to remove member. Please try again.');
      }
    }

    // Invitation actions
    async function resendInvitation(invitationId) {
      try {
        const response = await fetch(`/api/organizations/${currentOrg}/invitations/${invitationId}/resend`, {
          method: 'POST',
        });

        if (!response.ok) {
          const data = await response.json();
          alert(data.message || 'Failed to resend invitation');
          return;
        }

        alert('Invitation resent successfully!');
        loadTeamMembers();
      } catch (error) {
        console.error('Error resending invitation:', error);
        alert('Failed to resend invitation. Please try again.');
      }
    }

    async function revokeInvitation(invitationId) {
      if (!confirm('Are you sure you want to revoke this invitation?')) {
        return;
      }

      try {
        const response = await fetch(`/api/organizations/${currentOrg}/invitations/${invitationId}`, {
          method: 'DELETE',
        });

        if (!response.ok) {
          const data = await response.json();
          alert(data.message || 'Failed to revoke invitation');
          return;
        }

        loadTeamMembers();
      } catch (error) {
        console.error('Error revoking invitation:', error);
        alert('Failed to revoke invitation. Please try again.');
      }
    }

    // Helper to escape HTML
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Load verified domains
    async function loadDomains(orgId) {
      const domainsContent = document.getElementById('domainsContent');

      try {
        const response = await fetch(`/api/organizations/${orgId}/domains`, { credentials: 'include' });
        if (!response.ok) {
          throw new Error('Failed to load domains');
        }

        const data = await response.json();

        if (data.domains && data.domains.length > 0) {
          const verifiedDomains = data.domains.filter(d => d.verified);
          const pendingDomains = data.domains.filter(d => !d.verified);

          let html = '';

          if (verifiedDomains.length > 0) {
            html += '<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">';
            verifiedDomains.forEach(domain => {
              html += `
                <span style="
                  display: inline-flex;
                  align-items: center;
                  gap: 6px;
                  padding: 6px 12px;
                  background: var(--color-success-100);
                  color: var(--color-success-700);
                  border-radius: var(--radius-full);
                  font-size: var(--text-sm);
                  font-weight: 500;
                ">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 12l2 2 4-4"/>
                    <circle cx="12" cy="12" r="10"/>
                  </svg>
                  ${escapeHtml(domain.domain)}
                </span>
              `;
            });
            html += '</div>';
          }

          if (pendingDomains.length > 0) {
            html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
            pendingDomains.forEach(domain => {
              html += `
                <span style="
                  display: inline-flex;
                  align-items: center;
                  gap: 6px;
                  padding: 6px 12px;
                  background: var(--color-warning-100);
                  color: var(--color-warning-700);
                  border-radius: var(--radius-full);
                  font-size: var(--text-sm);
                  font-weight: 500;
                ">
                  ${escapeHtml(domain.domain)} (pending)
                </span>
              `;
            });
            html += '</div>';
          }

          domainsContent.innerHTML = html;
        } else {
          domainsContent.innerHTML = `
            <p style="color: var(--color-text-secondary); font-size: var(--text-sm);">
              No domains verified yet. Add a domain to enable automatic team member discovery.
            </p>
          `;
        }
      } catch (error) {
        console.error('Error loading domains:', error);
        domainsContent.innerHTML = `
          <p style="color: var(--color-text-secondary); font-size: var(--text-sm);">
            No domains verified yet.
          </p>
        `;
      }
    }

    // Load domain users not in team (potential members)
    async function loadDomainUsers(orgId) {
      const card = document.getElementById('domainUsersCard');
      const content = document.getElementById('domainUsersContent');

      try {
        const response = await fetch(`/api/organizations/${orgId}/domain-users`, { credentials: 'include' });
        if (!response.ok) {
          card.style.display = 'none';
          return;
        }

        const data = await response.json();

        if (data.users && data.users.length > 0) {
          card.style.display = 'block';

          let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
          data.users.forEach(user => {
            const displayName = user.slack_real_name || user.slack_display_name || user.slack_email || 'Unknown User';
            html += `
              <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px;
                background: var(--color-gray-50);
                border-radius: var(--radius-md);
              ">
                <div>
                  <div style="font-weight: 500; color: var(--color-text-heading);">
                    ${escapeHtml(displayName)}
                  </div>
                  <div style="font-size: var(--text-sm); color: var(--color-text-secondary);">
                    ${escapeHtml(user.slack_email)}
                  </div>
                </div>
                <button class="btn btn-secondary btn-sm" data-invite-email="${escapeHtml(user.slack_email || '')}">
                  Invite
                </button>
              </div>
            `;
          });
          html += '</div>';
          content.innerHTML = html;

          // Add event delegation for invite buttons
          content.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-invite-email]');
            if (btn) {
              openInviteModal();
              document.getElementById('inviteEmail').value = btn.dataset.inviteEmail;
            }
          });
        } else {
          card.style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading domain users:', error);
        card.style.display = 'none';
      }
    }

    // Domain Verification
    async function openDomainVerification() {
      if (!currentOrg) {
        alert('Please select an organization first');
        return;
      }

      try {
        const response = await fetch(`/api/organizations/${currentOrg}/domain-verification-link`, {
          method: 'POST',
        });

        if (!response.ok) {
          const data = await response.json();
          alert(data.message || 'Failed to open domain verification');
          return;
        }

        const data = await response.json();
        if (data.link) {
          window.open(data.link, '_blank');
        }
      } catch (error) {
        console.error('Error opening domain verification:', error);
        alert('Failed to open domain verification. Please try again.');
      }
    }

    // Close modals when clicking outside
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('show');
        }
      });
    });

    // Close modals with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.show').forEach(modal => {
          modal.classList.remove('show');
        });
      }
    });

    // Initialize
    loadUserData();
  </script>
</body>
</html>
