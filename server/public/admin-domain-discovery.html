<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Domain Discovery - Admin Tools - AdCP Registry</title>
  <link rel="stylesheet" href="/design-system.css">
  <script src="/js/company-types.js"></script>
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <style>
    /* =============================================================================
       Domain Discovery Tool styles
       Uses design system variables - see /design-system.css for tokens
       ============================================================================= */

    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-wide);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }
    h1 { margin-bottom: var(--space-2.5); color: var(--color-text-heading); }
    .subtitle { color: var(--color-text-secondary); margin-bottom: var(--space-5); }

    /* Breadcrumb */
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }
    .breadcrumb a {
      color: var(--color-brand);
      text-decoration: none;
    }
    .breadcrumb a:hover {
      text-decoration: underline;
    }

    /* Source Filters */
    .source-filters {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-5);
      padding-bottom: var(--space-4);
      border-bottom: var(--border-1) solid var(--color-gray-200);
    }
    .source-filter-btn {
      padding: var(--space-2) var(--space-4);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      background: var(--color-bg-card);
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .source-filter-btn:hover {
      background: var(--color-gray-50);
      border-color: var(--color-gray-300);
    }
    .source-filter-btn.active {
      background: var(--color-brand);
      color: white;
      border-color: var(--color-brand);
    }

    /* Count and Actions Bar */
    .count-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-4);
      margin-bottom: var(--space-4);
      flex-wrap: wrap;
    }
    .count-info {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }

    /* Buttons */
    .btn {
      padding: var(--space-2) var(--space-4);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .btn-primary {
      background: var(--color-brand);
      color: white;
    }
    .btn-primary:hover {
      background: var(--color-primary-700);
    }
    .btn-secondary {
      background: var(--color-gray-200);
      color: var(--color-text-heading);
    }
    .btn-secondary:hover {
      background: var(--color-gray-300);
    }
    .btn-sm {
      padding: var(--space-1.5) var(--space-3);
      font-size: var(--text-xs);
    }

    /* Table */
    .domains-table {
      width: 100%;
      border-collapse: collapse;
    }
    .domains-table th {
      background: var(--color-gray-50);
      padding: var(--space-3);
      text-align: left;
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      border-bottom: var(--border-2) solid var(--color-gray-200);
      font-size: var(--text-sm);
    }
    .domains-table td {
      padding: var(--space-3);
      border-bottom: var(--border-1) solid var(--color-gray-200);
      font-size: var(--text-sm);
    }
    .domains-table tr:hover {
      background: var(--color-gray-50);
    }

    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      text-decoration: none;
    }
    .status-prospect {
      background: var(--color-info-100);
      color: var(--color-info-700);
    }
    .status-member {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }

    /* Source badges */
    .source-badge {
      display: inline-block;
      padding: var(--space-0.5) var(--space-1.5);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .source-slack {
      background: #4a154b;
      color: white;
    }
    .source-email {
      background: var(--color-info-100);
      color: var(--color-info-700);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: var(--space-10) var(--space-5);
      color: var(--color-text-secondary);
    }
    .empty-state h3 {
      color: var(--color-text-heading);
      margin-bottom: var(--space-2);
    }

    /* Loading state */
    .loading {
      text-align: center;
      padding: var(--space-8);
      color: var(--color-text-secondary);
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <div id="nav-placeholder"></div>
  <script>window.Nav.init('nav-placeholder');</script>

  <div style="display: flex;">
    <!-- Sidebar -->
    <div id="sidebar-placeholder"></div>
    <script>window.AdminSidebar.init('sidebar-placeholder', 'tools');</script>

    <!-- Main Content -->
    <main style="flex: 1; min-width: 0;">
      <div class="container">
        <div class="breadcrumb">
          <a href="/admin/accounts">Accounts</a>
          <span>/</span>
          <span>Domain Discovery</span>
        </div>

        <div class="card">
          <h1>Domain Discovery</h1>
          <p class="subtitle">Find new prospects from Slack and email contacts that haven't been mapped to organizations.</p>

          <!-- Source Filters -->
          <div class="source-filters">
            <button class="source-filter-btn active" data-source="all" onclick="filterDomainsBySource('all')">
              All Sources
            </button>
            <button class="source-filter-btn" data-source="slack" onclick="filterDomainsBySource('slack')">
              Slack (<span id="count-slack">0</span>)
            </button>
            <button class="source-filter-btn" data-source="email" onclick="filterDomainsBySource('email')">
              Email (<span id="count-email">0</span>)
            </button>
          </div>

          <!-- Count and Actions -->
          <div class="count-bar">
            <span class="count-info" id="domainsCount">Loading...</span>
            <button class="btn btn-secondary btn-sm" onclick="enrichAllNewDomains()" id="enrichAllBtn" style="display: none;">
              Research All (<span id="enrichCount">0</span>)
            </button>
          </div>

          <!-- Domains Table -->
          <table class="domains-table">
            <thead>
              <tr>
                <th>Domain</th>
                <th>Source</th>
                <th>Users</th>
                <th>Company Info</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="domainsTableBody">
              <tr>
                <td colspan="6" class="loading">Loading domains...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    // State
    let discoveredDomains = [];
    let slackDomains = [];
    let emailDomains = [];
    let currentSource = 'all';
    let enrichmentCache = {};
    let enrichmentConfigured = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Check if enrichment is configured
      try {
        const configRes = await fetch('/api/admin/enrichment/config');
        if (configRes.ok) {
          const config = await configRes.json();
          enrichmentConfigured = config.configured;
        }
      } catch (e) {
        console.log('Could not check enrichment config');
      }

      await loadDomainDiscovery();
    });

    async function loadDomainDiscovery() {
      try {
        // Load both Slack and Email domains in parallel
        const [slackRes, emailRes] = await Promise.all([
          fetch('/api/admin/slack/domains?min_users=1&limit=100').catch(() => null),
          fetch('/api/admin/email/domains?min_users=1&limit=100').catch(() => null)
        ]);

        slackDomains = [];
        emailDomains = [];

        if (slackRes && slackRes.ok) {
          const data = await slackRes.json();
          const domains = Array.isArray(data) ? data : data.domains || [];
          slackDomains = domains.map(d => ({ ...d, source: 'slack' }));
        }

        if (emailRes && emailRes.ok) {
          const data = await emailRes.json();
          const domains = Array.isArray(data) ? data : data.domains || [];
          emailDomains = domains.map(d => ({ ...d, source: 'email' }));
        }

        // Merge domains, combining those that appear in both sources
        const domainMap = new Map();

        slackDomains.forEach(d => {
          domainMap.set(d.domain, {
            ...d,
            sources: ['slack'],
            slack_users: d.users,
            email_contacts: [],
            total_users: d.user_count
          });
        });

        emailDomains.forEach(d => {
          if (domainMap.has(d.domain)) {
            const existing = domainMap.get(d.domain);
            existing.sources.push('email');
            existing.email_contacts = d.users;
            existing.total_users += d.user_count;
            if (d.existing_org && !existing.existing_org) {
              existing.existing_org = d.existing_org;
              existing.is_new_prospect = false;
            }
          } else {
            domainMap.set(d.domain, {
              ...d,
              sources: ['email'],
              slack_users: [],
              email_contacts: d.users,
              total_users: d.user_count
            });
          }
        });

        discoveredDomains = Array.from(domainMap.values());

        // Update source filter counts
        const slackNewCount = discoveredDomains.filter(d => d.sources.includes('slack') && d.is_new_prospect).length;
        const emailNewCount = discoveredDomains.filter(d => d.sources.includes('email') && d.is_new_prospect).length;
        document.getElementById('count-slack').textContent = slackNewCount;
        document.getElementById('count-email').textContent = emailNewCount;

        renderDomains();

        // Auto-enrich new prospect domains in the background
        if (enrichmentConfigured) {
          autoEnrichDiscoveredDomains();
        }
      } catch (error) {
        console.error('Error loading domain discovery:', error);
        document.getElementById('domainsTableBody').innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">
              <h3>Error loading domain data</h3>
              <p>${error.message}</p>
            </td>
          </tr>
        `;
      }
    }

    function filterDomainsBySource(source) {
      currentSource = source;
      document.querySelectorAll('.source-filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.source === source);
      });
      renderDomains();
    }

    function renderDomains() {
      const tbody = document.getElementById('domainsTableBody');
      const countDiv = document.getElementById('domainsCount');
      const enrichAllBtn = document.getElementById('enrichAllBtn');

      // Filter by source if needed
      let domainsToShow = discoveredDomains;
      if (currentSource === 'slack') {
        domainsToShow = discoveredDomains.filter(d => d.sources.includes('slack'));
      } else if (currentSource === 'email') {
        domainsToShow = discoveredDomains.filter(d => d.sources.includes('email'));
      }

      const newProspects = domainsToShow.filter(d => d.is_new_prospect);
      const unenrichedCount = discoveredDomains.filter(d => d.is_new_prospect && !enrichmentCache[d.domain]).length;

      countDiv.textContent = `Showing ${domainsToShow.length} domains (${newProspects.length} new prospects)`;

      // Show/hide enrich all button
      if (enrichmentConfigured && unenrichedCount > 0) {
        document.getElementById('enrichCount').textContent = Math.min(unenrichedCount, 25);
        enrichAllBtn.style.display = 'block';
      } else {
        enrichAllBtn.style.display = 'none';
      }

      if (domainsToShow.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">
              <h3>No unmapped domains found</h3>
              <p>No contacts from this source need organization mapping.</p>
            </td>
          </tr>
        `;
        return;
      }

      // Sort: new prospects first, then by total user count descending
      const sortedDomains = [...domainsToShow].sort((a, b) => {
        if (a.is_new_prospect !== b.is_new_prospect) {
          return a.is_new_prospect ? -1 : 1;
        }
        return b.total_users - a.total_users;
      });

      tbody.innerHTML = sortedDomains.map(domain => {
        // Source badges
        const sourceBadges = domain.sources.map(s => {
          if (s === 'slack') {
            return `<span class="source-badge source-slack" title="Found in Slack">Slack</span>`;
          } else {
            return `<span class="source-badge source-email" title="Found via Email">Email</span>`;
          }
        }).join(' ');

        // Company info - show enrichment data if available
        const enrichment = enrichmentCache[domain.domain];
        let companyInfoHtml;
        if (enrichment && enrichment.success) {
          const e = enrichment.enrichment;
          const parts = [];
          if (e.companyName) parts.push(`<strong>${e.companyName}</strong>`);
          if (e.industry) parts.push(`<span class="source-badge" style="background: var(--color-gray-100); color: var(--color-text-secondary);">${e.industry}</span>`);
          if (e.employeeCountRange || e.employeeCount) parts.push(`${e.employeeCountRange || e.employeeCount + ' employees'}`);
          if (e.revenueRange) parts.push(`${e.revenueRange}`);
          if (enrichment.suggested?.companyType) {
            parts.push(`<span class="source-badge" style="background: var(--color-success-100); color: var(--color-success-700);">${getCompanyTypeLabel(enrichment.suggested.companyType)}</span>`);
          }
          companyInfoHtml = parts.join('<br>') || '<span style="color: var(--color-text-muted);">No data</span>';
        } else if (enrichment && enrichment.error) {
          companyInfoHtml = `<span style="color: var(--color-text-muted);">${enrichment.error}</span>`;
        } else if (enrichmentConfigured && domain.is_new_prospect) {
          const safeDomainId = domain.domain.replace(/[^a-zA-Z0-9-]/g, '-');
          companyInfoHtml = `<button class="btn btn-secondary btn-sm" data-domain="${escapeHtml(domain.domain)}" onclick="enrichDomain(this.dataset.domain)" id="enrich-btn-${safeDomainId}">Research</button>`;
        } else {
          companyInfoHtml = '<span style="color: var(--color-text-muted);">-</span>';
        }

        // Status badge
        let statusHtml;
        if (domain.existing_org) {
          statusHtml = `<a href="/admin/accounts/${domain.existing_org.id}" class="status-badge status-member">${domain.existing_org.name}</a>`;
        } else {
          statusHtml = '<span class="status-badge status-prospect">New Prospect</span>';
        }

        // Action button
        const primarySource = domain.sources.includes('slack') ? 'slack' : 'email';
        let actionHtml;
        if (domain.is_new_prospect) {
          actionHtml = `<button class="btn btn-primary btn-sm" data-domain="${escapeHtml(domain.domain)}" data-source="${primarySource}" onclick="createProspectFromDomain(this.dataset.domain, this.dataset.source)">Create Prospect</button>`;
        } else {
          actionHtml = `<a href="/admin/accounts/${domain.existing_org.id}" class="btn btn-secondary btn-sm">View Account</a>`;
        }

        return `
          <tr${domain.is_new_prospect ? '' : ' style="opacity: 0.6;"'}>
            <td><strong>${domain.domain}</strong></td>
            <td>${sourceBadges}</td>
            <td><span title="${domain.total_users} total users">${domain.total_users}</span></td>
            <td style="max-width: 250px; font-size: var(--text-sm);">${companyInfoHtml}</td>
            <td>${statusHtml}</td>
            <td>${actionHtml}</td>
          </tr>
        `;
      }).join('');
    }

    async function enrichDomain(domain) {
      const btnId = `enrich-btn-${domain.replace(/[^a-zA-Z0-9-]/g, '-')}`;
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Loading...';
      }

      try {
        const response = await fetch(`/api/admin/enrichment/domain/${encodeURIComponent(domain)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          const error = await response.json();
          enrichmentCache[domain] = { success: false, error: error.error || 'Failed' };
        } else {
          const result = await response.json();
          enrichmentCache[domain] = result;
        }

        renderDomains();
      } catch (error) {
        enrichmentCache[domain] = { success: false, error: 'Network error' };
        renderDomains();
      }
    }

    async function enrichAllNewDomains() {
      const newDomains = discoveredDomains
        .filter(d => d.is_new_prospect && !enrichmentCache[d.domain])
        .map(d => d.domain)
        .slice(0, 25);

      if (newDomains.length === 0) {
        alert('No new domains to enrich');
        return;
      }

      if (!confirm(`Enrich ${newDomains.length} domains? This will use Lusha API credits.`)) {
        return;
      }

      try {
        const response = await fetch('/api/admin/enrichment/bulk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ domains: newDomains })
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          throw new Error('Bulk enrichment failed');
        }

        const result = await response.json();

        result.results.forEach(r => {
          enrichmentCache[r.domain] = r.success
            ? { success: true, enrichment: r.enrichment, suggested: { companyType: r.suggestedCompanyType } }
            : { success: false, error: r.error };
        });

        alert(`Enriched ${result.successful} of ${result.total} domains`);
        renderDomains();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function autoEnrichDiscoveredDomains() {
      const domainsToEnrich = discoveredDomains
        .filter(d => d.is_new_prospect && !enrichmentCache[d.domain])
        .map(d => d.domain)
        .slice(0, 20);

      if (domainsToEnrich.length === 0) return;

      console.log(`Auto-enriching ${domainsToEnrich.length} domains in background...`);

      try {
        const response = await fetch('/api/admin/enrichment/auto-enrich-domains', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ domains: domainsToEnrich })
        });

        if (!response.ok) {
          console.log('Auto-enrichment failed:', response.status);
          return;
        }

        const result = await response.json();

        result.results.forEach(r => {
          if (r.success && r.data) {
            enrichmentCache[r.domain] = {
              success: true,
              enrichment: r.data,
              suggested: { companyType: r.data.suggestedCompanyType }
            };
          } else {
            enrichmentCache[r.domain] = { success: false, error: r.error || 'No data' };
          }
        });

        console.log(`Auto-enriched ${result.successful} of ${result.total} domains`);
        renderDomains();
      } catch (error) {
        console.log('Auto-enrichment error:', error);
      }
    }

    async function createProspectFromDomain(domain, source = 'slack') {
      if (!confirm(`Create prospect for domain "${domain}"?`)) return;

      try {
        const endpoint = source === 'email'
          ? `/api/admin/email/domains/${domain}/create-prospect`
          : `/api/admin/slack/domains/${domain}/create-prospect`;

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          const error = await response.json();
          throw new Error(error.message || 'Failed to create prospect');
        }

        const result = await response.json();
        alert(`Created prospect: ${result.name}`);

        // Refresh domain discovery
        await loadDomainDiscovery();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Helper for company type labels
    function getCompanyTypeLabel(type) {
      if (typeof window.getCompanyTypeLabel === 'function') {
        return window.getCompanyTypeLabel(type);
      }
      return type;
    }
  </script>
</body>
</html>
