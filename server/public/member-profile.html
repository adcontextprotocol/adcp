<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Member Profile - AdCP</title>
  <link rel="stylesheet" href="/design-system.css">
  <style>
    /* =============================================================================
       Member Profile styles
       Uses design system variables - see /design-system.css for tokens
       ============================================================================= */

    body {
      background: var(--color-bg-page);
      min-height: 100vh;
      padding-top: 60px;
    }
    .container {
      max-width: var(--container-md);
      margin: var(--space-10) auto;
      padding: 0 var(--space-5);
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-8);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-sm);
    }
    h1 {
      color: var(--color-text-heading);
      margin-bottom: var(--space-2.5);
      font-size: var(--text-3xl);
    }
    h2 {
      color: var(--color-text-heading);
      margin-bottom: var(--space-4);
      font-size: var(--text-xl);
      border-bottom: var(--border-2) solid var(--color-success-500);
      padding-bottom: var(--space-2.5);
    }
    .subtitle {
      color: var(--color-text-secondary);
      margin-bottom: var(--space-8);
    }
    .form-group {
      margin-bottom: var(--space-5);
    }
    .form-group label {
      display: block;
      color: var(--color-text-heading);
      font-weight: var(--font-semibold);
      margin-bottom: var(--space-1.5);
    }
    .form-group .hint {
      font-size: var(--text-sm);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }
    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="url"],
    .form-group input[type="tel"],
    .form-group textarea {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      border: var(--border-1) solid var(--color-gray-300);
      border-radius: var(--radius-md);
      font-size: var(--text-base);
      background-color: var(--color-bg-card);
      color: var(--color-text);
      transition: var(--transition-colors);
    }
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--color-success-500);
    }
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-5);
    }
    @media (max-width: 600px) {
      .form-row { grid-template-columns: 1fr; }
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-3);
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3.5);
      background: var(--color-gray-50);
      border: var(--border-2) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .checkbox-item:hover {
      border-color: var(--color-success-500);
    }
    .checkbox-item.selected {
      background: var(--color-success-50);
      border-color: var(--color-success-500);
    }
    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--color-success-500);
      cursor: pointer;
    }
    .toggle-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
      margin-top: var(--space-2.5);
    }
    .toggle-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    .toggle-item .toggle-label {
      font-size: var(--text-base);
      color: var(--color-text-heading);
      cursor: pointer;
    }
    .toggle {
      position: relative;
      width: 50px;
      height: 26px;
      flex-shrink: 0;
    }
    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--color-gray-300);
      transition: var(--transition-colors);
      border-radius: 26px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: var(--transition-transform);
      border-radius: var(--radius-full);
    }
    .toggle input:checked + .toggle-slider {
      background-color: var(--color-success-500);
    }
    .toggle input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }
    .preview-section {
      background: var(--color-gray-50);
      border-radius: var(--radius-md);
      padding: var(--space-5);
      margin-top: var(--space-5);
    }
    .preview-section h3 {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-4);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .logo-preview {
      display: flex;
      gap: var(--space-5);
      align-items: stretch;
      flex-wrap: wrap;
    }
    .logo-preview-box {
      padding: var(--space-4);
      border-radius: var(--radius-md);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-2);
      min-width: 150px;
    }
    .logo-preview-box.light {
      background: var(--color-bg-card);
      border: var(--border-1) solid var(--color-gray-200);
    }
    .logo-preview-box.dark {
      background: var(--color-gray-800);
    }
    .logo-preview-box .label {
      font-size: var(--text-xs);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .logo-preview-box.light .label { color: var(--color-text-secondary); }
    .logo-preview-box.dark .label { color: var(--color-gray-400); }
    .logo-preview img {
      max-width: 120px;
      max-height: 60px;
      object-fit: contain;
    }
    .logo-preview .placeholder {
      width: 120px;
      height: 60px;
      background: var(--color-gray-200);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-muted);
      font-size: var(--text-xs);
    }
    .logo-preview-box.dark .placeholder {
      background: var(--color-gray-700);
      color: var(--color-gray-400);
    }
    .gravatar-note {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      margin-top: var(--space-2.5);
      padding: var(--space-2.5);
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--color-success-500);
    }
    .logo-input-group {
      display: flex;
      gap: var(--space-2);
      align-items: center;
      flex-wrap: wrap;
    }
    .logo-input-group input[type="text"] {
      display: none;
    }
    .logo-input-group .upload-filename {
      flex: 1;
      min-width: 100px;
      padding: var(--space-2.5) var(--space-3.5);
      border: var(--border-2) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      color: var(--color-gray-700);
      background: var(--color-gray-50);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .logo-input-group .upload-filename:empty::before {
      content: 'No file selected';
      color: var(--color-gray-400);
    }
    .logo-input-group .upload-filename.has-file {
      background: var(--color-success-50);
      border-color: var(--color-success-500);
      color: var(--color-success-700);
    }
    .logo-input-group .btn-upload {
      padding: var(--space-2.5) var(--space-4);
      background: var(--color-gray-100);
      border: var(--border-2) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: var(--text-sm);
      color: var(--color-gray-700);
      white-space: nowrap;
      transition: var(--transition-all);
    }
    .logo-input-group .btn-upload:hover {
      background: var(--color-gray-200);
      border-color: var(--color-success-500);
    }
    .logo-input-group .btn-clear {
      padding: var(--space-2.5) var(--space-3);
      background: var(--color-error-50);
      border: var(--border-2) solid var(--color-error-200);
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: var(--text-sm);
      color: var(--color-error-600);
      white-space: nowrap;
      transition: var(--transition-all);
    }
    .logo-input-group .btn-clear:hover {
      background: var(--color-error-200);
      border-color: var(--color-error-600);
    }
    .logo-input-group input[type="file"] {
      display: none;
    }
    .btn-group {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-8);
    }
    .btn {
      padding: var(--space-3) var(--space-6);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-base);
      font-weight: var(--font-semibold);
      cursor: pointer;
      transition: var(--transition-all);
    }
    .btn-primary {
      background: var(--color-success-500);
      color: white;
    }
    .btn-primary:hover {
      background: var(--color-success-600);
    }
    .btn-primary:disabled {
      background: var(--color-gray-400);
      cursor: not-allowed;
    }
    .btn-secondary {
      background: var(--color-gray-100);
      color: var(--color-gray-700);
    }
    .btn-secondary:hover {
      background: var(--color-gray-200);
    }
    .btn-danger {
      background: var(--color-error-50);
      color: var(--color-error-600);
    }
    .btn-danger:hover {
      background: var(--color-error-200);
    }
    .alert {
      padding: var(--space-4) var(--space-5);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-5);
    }
    .alert-success {
      background: var(--color-success-50);
      color: var(--color-success-700);
      border-left: 4px solid var(--color-success-500);
    }
    .alert-error {
      background: var(--color-error-50);
      color: var(--color-error-700);
      border-left: 4px solid var(--color-error-600);
    }
    .alert-info {
      background: var(--color-info-50);
      color: var(--color-info-700);
      border-left: 4px solid var(--color-info-500);
    }
    .loading {
      text-align: center;
      padding: var(--space-16);
      color: var(--color-text-secondary);
    }
    .slug-input-wrapper {
      display: flex;
      align-items: center;
      gap: 0;
    }
    .slug-prefix {
      padding: var(--space-2.5) var(--space-3.5);
      background: var(--color-gray-100);
      border: var(--border-2) solid var(--color-gray-200);
      border-right: none;
      border-radius: var(--radius-md) 0 0 var(--radius-md);
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
    }
    .slug-input-wrapper input {
      border-radius: 0 var(--radius-md) var(--radius-md) 0 !important;
    }
    .slug-status {
      margin-left: var(--space-2.5);
      font-size: var(--text-sm);
    }
    .slug-status.available { color: var(--color-success-500); }
    .slug-status.taken { color: var(--color-error-600); }
    .tags-input {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      padding: var(--space-2);
      border: var(--border-2) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      min-height: 44px;
      cursor: text;
    }
    .tags-input:focus-within {
      border-color: var(--color-success-500);
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2.5);
      background: var(--color-info-100);
      color: var(--color-info-700);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }
    .tag-remove {
      cursor: pointer;
      opacity: 0.7;
    }
    .tag-remove:hover {
      opacity: 1;
    }
    .tags-input input {
      flex: 1;
      min-width: 100px;
      border: none;
      outline: none;
      padding: var(--space-1);
      font-size: var(--text-sm);
    }
    .no-profile {
      text-align: center;
      padding: var(--space-16) var(--space-5);
    }
    .no-profile h2 {
      border: none;
      margin-bottom: var(--space-5);
    }
    /* Status badge styles */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1.5);
      padding: var(--space-2) var(--space-3.5);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
    }
    .status-badge.draft {
      background: var(--color-gray-100);
      color: var(--color-gray-500);
      border: var(--border-1) solid var(--color-gray-200);
    }
    .status-badge.published {
      background: var(--color-info-100);
      color: var(--color-info-700);
      border: var(--border-1) solid var(--color-info-200);
    }
    .status-badge svg {
      width: 16px;
      height: 16px;
    }
    /* Agent URLs section */
    .agent-urls-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    .agent-url-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      background: var(--color-gray-50);
      border: var(--border-2) solid var(--color-gray-200);
      border-radius: var(--radius-md);
    }
    .agent-url-item.checking {
      border-color: var(--color-warning-400);
      background: var(--color-warning-50);
    }
    .agent-url-item.success {
      border-color: var(--color-success-500);
      background: var(--color-success-50);
    }
    .agent-url-item.error {
      border-color: var(--color-error-600);
      background: var(--color-error-50);
    }
    .agent-url-info {
      flex: 1;
      min-width: 0;
    }
    .agent-url-info .url {
      font-family: var(--font-mono);
      font-size: var(--text-sm);
      color: var(--color-gray-700);
      word-break: break-all;
    }
    .agent-url-info .agent-name {
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      margin-bottom: 2px;
    }
    .agent-url-info .agent-meta {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      display: flex;
      align-items: center;
      gap: var(--space-1.5);
      flex-wrap: wrap;
    }
    .agent-type-badge {
      display: inline-block;
      padding: 2px var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .agent-type-badge.creative {
      background: var(--color-info-100);
      color: var(--color-info-700);
    }
    .agent-type-badge.sales {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .agent-type-badge.signals {
      background: var(--color-warning-100);
      color: var(--color-warning-700);
    }
    .agent-type-badge.unknown {
      background: var(--color-gray-100);
      color: var(--color-gray-500);
    }
    .protocol-badge {
      display: inline-block;
      padding: 2px var(--space-1.5);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: var(--font-semibold);
      background: var(--color-gray-200);
      color: var(--color-gray-700);
    }
    .agent-url-status {
      display: flex;
      align-items: center;
      gap: var(--space-1.5);
      font-size: var(--text-xs);
      white-space: nowrap;
    }
    .agent-url-status .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--color-warning-400);
      border-top-color: transparent;
      border-radius: var(--radius-full);
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .agent-url-actions {
      display: flex;
      gap: var(--space-2);
    }
    .agent-url-actions button {
      padding: var(--space-1.5) var(--space-2.5);
      border: none;
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      cursor: pointer;
    }
    .agent-url-actions .btn-remove {
      background: var(--color-error-50);
      color: var(--color-error-600);
    }
    .agent-url-actions .btn-remove:hover {
      background: var(--color-error-200);
    }
    /* Agent visibility toggle */
    .agent-visibility {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-1.5) 0;
    }
    .agent-visibility label {
      display: flex;
      align-items: center;
      gap: var(--space-1.5);
      cursor: pointer;
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
    }
    .agent-visibility .toggle {
      position: relative;
      width: 36px;
      height: 20px;
      background: var(--color-gray-200);
      border-radius: var(--radius-full);
      transition: var(--transition-colors);
    }
    .agent-visibility input:checked + .toggle {
      background: var(--color-success-500);
    }
    .agent-visibility .toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: var(--radius-full);
      transition: var(--transition-transform);
    }
    .agent-visibility input:checked + .toggle::after {
      transform: translateX(16px);
    }
    .agent-visibility input {
      display: none;
    }
    .visibility-badge-small {
      padding: 2px var(--space-1.5);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: var(--font-medium);
    }
    .visibility-badge-small.public {
      background: var(--color-success-50);
      color: var(--color-success-700);
    }
    .visibility-badge-small.private {
      background: var(--color-gray-100);
      color: var(--color-gray-500);
    }
    .add-agent-row {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-3);
    }
    .add-agent-row input {
      flex: 1;
    }
    /* Publisher section styles */
    .publisher-urls-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    .add-publisher-row {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-3);
    }
    .add-publisher-row input {
      flex: 1;
    }
    /* Member card styles are now loaded from member-card.js */
  </style>
</head>
<body>
  <!-- Navigation -->
  <div id="adcp-nav"></div>
  <script src="/nav.js"></script>
  <script src="/member-card.js"></script>

  <div class="container">
    <div id="loading" class="loading">Loading your profile...</div>

    <div id="error-container" style="display: none;"></div>

    <div id="no-profile" class="card no-profile" style="display: none;">
      <h2>Create Your Member Profile</h2>
      <p>You don't have a member profile yet. Create one to appear in the member directory and have your logo shown on the homepage.</p>
      <button class="btn btn-primary" onclick="showCreateForm()">Create Profile</button>
    </div>

    <div id="profile-form" style="display: none;">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px; margin-bottom: 10px;">
          <div>
            <h1 id="form-title" style="margin-bottom: 5px;">Member Profile</h1>
            <p class="subtitle" style="margin-bottom: 0;">Customize how your organization appears in the AdCP member directory</p>
          </div>
          <!-- Status indicator - only shown for existing profiles -->
          <div id="profile-status-indicator" style="display: none;">
            <div id="status-badge" class="status-badge"></div>
          </div>
        </div>

        <div id="success-message" class="alert alert-success" style="display: none;"></div>
        <div id="error-message" class="alert alert-error" style="display: none;"></div>

        <form id="memberProfileForm" onsubmit="saveProfile(event)">
          <!-- Basic Information -->
          <h2>Basic Information</h2>

          <div class="form-group">
            <label for="display_name">Display Name *</label>
            <input type="text" id="display_name" name="display_name" required placeholder="Your company name">
          </div>

          <div class="form-group" id="slug-group">
            <label for="slug">Profile URL *</label>
            <div class="slug-input-wrapper">
              <span class="slug-prefix">adcontextprotocol.org/members/</span>
              <input type="text" id="slug" name="slug" required placeholder="your-company" pattern="[a-z0-9-]+" title="Only lowercase letters, numbers, and hyphens">
              <span id="slug-status" class="slug-status"></span>
            </div>
            <div class="hint">Choose a unique URL for your profile page</div>
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" placeholder="Tell people about your company and what you offer..."></textarea>
            <div class="hint">The first 200 characters will appear in the directory card</div>
          </div>

          <!-- Offerings -->
          <h2>What Do You Offer?</h2>
          <div class="form-group">
            <label>Select all that apply:</label>
            <div class="checkbox-group" id="offerings-group">
              <label class="checkbox-item" data-value="buyer_agent">
                <input type="checkbox" name="offerings" value="buyer_agent">
                <span>Buyer Agent</span>
              </label>
              <label class="checkbox-item" data-value="sales_agent">
                <input type="checkbox" name="offerings" value="sales_agent">
                <span>Sales Agent</span>
              </label>
              <label class="checkbox-item" data-value="creative_agent">
                <input type="checkbox" name="offerings" value="creative_agent">
                <span>Creative Agent</span>
              </label>
              <label class="checkbox-item" data-value="signals_agent">
                <input type="checkbox" name="offerings" value="signals_agent">
                <span>Signals Agent</span>
              </label>
              <label class="checkbox-item" data-value="publisher">
                <input type="checkbox" name="offerings" value="publisher">
                <span>Publisher</span>
              </label>
              <label class="checkbox-item" data-value="consulting">
                <input type="checkbox" name="offerings" value="consulting">
                <span>Consulting</span>
              </label>
              <label class="checkbox-item" data-value="other">
                <input type="checkbox" name="offerings" value="other">
                <span>Other</span>
              </label>
            </div>
          </div>

          <!-- Branding -->
          <h2>Logos</h2>

          <div class="form-row">
            <div class="form-group">
              <label for="logo_light_url">Logo for Light Backgrounds</label>
              <div class="logo-input-group">
                <input type="text" id="logo_light_url" name="logo_light_url" placeholder="https://example.com/logo-dark.png" readonly>
                <span class="upload-filename" id="logo_light_filename"></span>
                <label class="btn-upload">
                  Upload
                  <input type="file" id="logo_light_upload" accept="image/*" onchange="handleLogoUpload(this, 'logo_light_url', 'logo_light_filename')">
                </label>
                <button type="button" class="btn-clear" id="logo_light_clear" onclick="clearLogo('logo_light_url', 'logo_light_filename')" style="display: none;">Clear</button>
              </div>
              <div class="hint">Dark-colored logo that looks good on white/light pages</div>
            </div>
            <div class="form-group">
              <label for="logo_dark_url">Logo for Dark Backgrounds</label>
              <div class="logo-input-group">
                <input type="text" id="logo_dark_url" name="logo_dark_url" placeholder="https://example.com/logo-light.png" readonly>
                <span class="upload-filename" id="logo_dark_filename"></span>
                <label class="btn-upload">
                  Upload
                  <input type="file" id="logo_dark_upload" accept="image/*" onchange="handleLogoUpload(this, 'logo_dark_url', 'logo_dark_filename')">
                </label>
                <button type="button" class="btn-clear" id="logo_dark_clear" onclick="clearLogo('logo_dark_url', 'logo_dark_filename')" style="display: none;">Clear</button>
              </div>
              <div class="hint">Light-colored logo that looks good on dark pages</div>
            </div>
          </div>
          <div class="hint" style="margin-top: calc(-1 * var(--space-2.5)); margin-bottom: var(--space-4);">If you only upload one logo, we'll use it for both backgrounds.</div>

          <!-- Hidden field to store primary logo for backwards compatibility -->
          <input type="hidden" id="logo_url" name="logo_url">

          <div class="preview-section">
            <h3>Logo Preview</h3>
            <div class="logo-preview" id="logo-preview-container">
              <div class="logo-preview-box light">
                <span class="label">Light Background</span>
                <div id="logo-light-preview" class="placeholder">No logo</div>
              </div>
              <div class="logo-preview-box dark">
                <span class="label">Dark Background</span>
                <div id="logo-dark-preview" class="placeholder">No logo</div>
              </div>
            </div>
            <div class="gravatar-note" id="gravatar-note" style="display: none;">
              <strong>Tip:</strong> No logo? We'll use your <a href="https://gravatar.com" target="_blank">Gravatar</a> based on your contact email as a fallback.
            </div>
          </div>

          <div class="preview-section" style="margin-top: var(--space-8);">
            <h3>Member Card Preview</h3>
            <p style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4);">This is how your organization will appear in the member directory:</p>
            <div id="member-card-preview">
              <!-- Initial placeholder - will be replaced by updateMemberCardPreview() -->
              <div class="member-card">
                <div class="member-card-header">
                  <div class="member-logo-placeholder">Y</div>
                  <div class="member-info">
                    <div class="member-name">Your Company</div>
                  </div>
                </div>
                <div class="member-card-body">
                  <div class="member-description" style="color: var(--color-gray-400);">Add a description to tell people about your company...</div>
                  <div class="member-offerings"></div>
                </div>
                <div class="member-card-footer">
                  <div class="member-contact"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Contact Information -->
          <h2>Contact Information</h2>

          <div class="form-row">
            <div class="form-group">
              <label for="contact_email">Contact Email</label>
              <input type="email" id="contact_email" name="contact_email" placeholder="contact@example.com">
            </div>
            <div class="form-group">
              <label for="contact_phone">Contact Phone</label>
              <input type="tel" id="contact_phone" name="contact_phone" placeholder="+1 (555) 123-4567">
            </div>
          </div>

          <div class="form-group">
            <label for="contact_website">Website</label>
            <input type="url" id="contact_website" name="contact_website" placeholder="https://example.com">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="linkedin_url">LinkedIn URL</label>
              <input type="url" id="linkedin_url" name="linkedin_url" placeholder="https://linkedin.com/company/...">
            </div>
            <div class="form-group">
              <label for="twitter_url">Twitter/X URL</label>
              <input type="url" id="twitter_url" name="twitter_url" placeholder="https://twitter.com/...">
            </div>
          </div>

          <!-- Markets -->
          <h2>Markets</h2>

          <div class="form-group">
            <label>Markets Served</label>
            <div class="checkbox-group" id="markets-group">
              <label class="checkbox-item" data-value="North America">
                <input type="checkbox" name="markets" value="North America">
                <span>North America</span>
              </label>
              <label class="checkbox-item" data-value="EMEA">
                <input type="checkbox" name="markets" value="EMEA">
                <span>EMEA</span>
              </label>
              <label class="checkbox-item" data-value="APAC">
                <input type="checkbox" name="markets" value="APAC">
                <span>APAC</span>
              </label>
              <label class="checkbox-item" data-value="LATAM">
                <input type="checkbox" name="markets" value="LATAM">
                <span>LATAM</span>
              </label>
              <label class="checkbox-item" data-value="Global">
                <input type="checkbox" name="markets" value="Global">
                <span>Global</span>
              </label>
            </div>
            <div class="hint">Select the regions where you provide services</div>
          </div>

          <!-- Agent URLs -->
          <h2>Your Agents</h2>
          <div class="form-group">
            <label>Register your AdCP agents (MCP or A2A endpoints):</label>
            <div id="agent-urls-container" class="agent-urls-list">
              <!-- Agent URLs will be rendered here -->
            </div>
            <div class="add-agent-row">
              <input type="url" id="new-agent-url" placeholder="https://your-agent.example.com" onkeydown="if(event.key === 'Enter') { event.preventDefault(); addAgentUrl(); }">
              <button type="button" class="btn btn-secondary" onclick="addAgentUrl()">Add Agent</button>
            </div>
            <div class="hint">Enter your agent's base URL. We'll automatically detect the protocol and fetch agent info.</div>
          </div>

          <!-- Publisher Domains -->
          <h2>Your Publishers</h2>
          <div class="form-group">
            <label>Register publisher domains where you host adagents.json:</label>
            <div id="publisher-urls-container" class="publisher-urls-list">
              <!-- Publisher URLs will be rendered here -->
            </div>
            <div class="add-publisher-row">
              <input type="text" id="new-publisher-domain" placeholder="example.com" onkeydown="if(event.key === 'Enter') { event.preventDefault(); addPublisherDomain(); }">
              <button type="button" class="btn btn-secondary" onclick="addPublisherDomain()">Add Publisher</button>
            </div>
            <div class="hint">Enter a domain name. We'll check for a valid /.well-known/adagents.json file.</div>
          </div>

          <!-- Tags -->
          <h2>Tags</h2>
          <div class="form-group">
            <label>Add searchable tags:</label>
            <div class="tags-input" id="tags-container" onclick="document.getElementById('tag-input').focus()">
              <input type="text" id="tag-input" placeholder="Type and press Enter to add tags">
            </div>
            <div class="hint">Press Enter or comma to add a tag</div>
            <input type="hidden" id="tags" name="tags">
          </div>

          <!-- Actions -->
          <div class="btn-group">
            <button type="submit" class="btn btn-primary" id="save-btn">Save Profile</button>
            <a href="#" class="btn btn-secondary" id="preview-btn" style="display: none;" target="_blank">View Live Profile</a>
            <button type="button" class="btn btn-secondary" id="back-btn" onclick="goToDashboard()">Back to Dashboard</button>
            <button type="button" class="btn btn-danger" id="delete-btn" style="display: none;" onclick="deleteProfile()">Delete Profile</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    let isNewProfile = true;
    let currentProfile = null;
    let tags = [];
    let agents = []; // Array of {url: string, is_public: boolean}
    let agentInfo = {}; // Cache of discovered agent info by URL
    let publishers = []; // Array of {domain: string, is_public: boolean}
    let publisherInfo = {}; // Cache of validated publisher info by domain
    let slugCheckTimeout = null;
    let currentOrgId = null;
    let currentOrgName = null;

    // Get org ID from query parameter
    function getOrgIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('org');
    }

    // Build API URL with org parameter
    function buildApiUrl(base) {
      const orgId = getOrgIdFromUrl();
      if (orgId) {
        return `${base}?org=${encodeURIComponent(orgId)}`;
      }
      return base;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Setup event listeners first
      setupOfferingsToggle();
      setupTagsInput();
      setupSlugCheck();
      setupLogoPreview();
      setupMemberCardPreview();
      setupPhoneFormatting();
      setupMarketsAutoSelect();
      // Load profile data after listeners are ready
      loadProfile();
    });

    function setupMemberCardPreview() {
      // Update preview when key fields change
      const fields = ['display_name', 'description', 'contact_email', 'contact_website'];
      fields.forEach(fieldId => {
        const el = document.getElementById(fieldId);
        if (el) {
          el.addEventListener('input', updateMemberCardPreview);
        }
      });

      // Also update when offerings change
      document.querySelectorAll('input[name="offerings"]').forEach(cb => {
        cb.addEventListener('change', updateMemberCardPreview);
      });
    }

    async function loadProfile() {
      try {
        const response = await fetch(buildApiUrl('/api/me/member-profile'), {
          credentials: 'include'
        });

        if (response.status === 401) {
          // Redirect to login
          const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);
          window.location.href = `/auth/login?redirect=${returnUrl}`;
          return;
        }

        if (!response.ok) {
          // Try to get error message from JSON response
          let errorMessage = 'Failed to load profile';
          try {
            const errorData = await response.json();
            errorMessage = errorData.message || errorMessage;
          } catch {
            // Response wasn't JSON (e.g., HTML error page from proxy)
            errorMessage = `Server error (${response.status}). Please try again.`;
          }
          throw new Error(errorMessage);
        }

        let data;
        try {
          data = await response.json();
        } catch {
          throw new Error('Invalid response from server. Please try again.');
        }

        // Store org info
        currentOrgId = data.organization_id;
        currentOrgName = data.organization_name;
        hasActiveSubscription = data.has_active_subscription || false;

        document.getElementById('loading').style.display = 'none';

        // Update page title/subtitle with org name
        if (currentOrgName) {
          document.querySelector('.subtitle').textContent = `Customize how ${currentOrgName} appears in the AdCP member directory`;
        }

        if (data.profile) {
          currentProfile = data.profile;
          isNewProfile = false;
          populateForm(data.profile);
          document.getElementById('profile-form').style.display = 'block';
          document.getElementById('form-title').textContent = currentOrgName ? `Edit ${currentOrgName} Profile` : 'Edit Member Profile';
          document.getElementById('delete-btn').style.display = 'block';
          document.getElementById('slug-group').style.display = 'none'; // Can't change slug after creation
          // Show preview button with link to public profile
          if (data.profile.slug) {
            const previewBtn = document.getElementById('preview-btn');
            previewBtn.href = `/members/${data.profile.slug}`;
            previewBtn.style.display = 'inline-block';
          }
        } else {
          // No profile exists - show the create form directly instead of an intermediate step
          // This avoids the "duplicate Create Profile button" issue
          showCreateForm();
        }

      } catch (error) {
        console.error('Load profile error:', error);
        document.getElementById('loading').style.display = 'none';
        showError('Failed to load your profile. Please try again.');
      }
    }

    function showCreateForm() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('no-profile').style.display = 'none';
      document.getElementById('profile-form').style.display = 'block';
      document.getElementById('form-title').textContent = currentOrgName ? `Create ${currentOrgName} Profile` : 'Create Member Profile';
      document.getElementById('slug-group').style.display = 'block';
      // Hide status indicator for new profiles
      document.getElementById('profile-status-indicator').style.display = 'none';
    }

    function populateForm(profile) {
      document.getElementById('display_name').value = profile.display_name || '';
      document.getElementById('slug').value = profile.slug || '';
      document.getElementById('description').value = profile.description || '';
      document.getElementById('logo_url').value = profile.logo_url || '';
      document.getElementById('logo_light_url').value = profile.logo_light_url || '';
      document.getElementById('logo_dark_url').value = profile.logo_dark_url || '';
      document.getElementById('contact_email').value = profile.contact_email || '';
      // Set phone and trigger formatting
      const phoneInput = document.getElementById('contact_phone');
      phoneInput.value = profile.contact_phone || '';
      if (phoneInput.value) {
        phoneInput.dispatchEvent(new Event('input'));
      }
      document.getElementById('contact_website').value = profile.contact_website || '';
      document.getElementById('linkedin_url').value = profile.linkedin_url || '';
      document.getElementById('twitter_url').value = profile.twitter_url || '';

      // Set markets
      if (profile.markets) {
        profile.markets.forEach(market => {
          const checkbox = document.querySelector(`input[name="markets"][value="${market}"]`);
          if (checkbox) {
            checkbox.checked = true;
            checkbox.closest('.checkbox-item').classList.add('selected');
          }
        });
      }

      // Set offerings
      if (profile.offerings) {
        profile.offerings.forEach(offering => {
          const checkbox = document.querySelector(`input[value="${offering}"]`);
          if (checkbox) {
            checkbox.checked = true;
            checkbox.closest('.checkbox-item').classList.add('selected');
          }
        });
      }

      // Set tags
      if (profile.tags) {
        tags = [...profile.tags];
        renderTags();
      }

      // Set agents
      agents = profile.agents ? [...profile.agents] : [];
      renderAgents();
      // Discover info for each agent
      agents.forEach(agent => discoverAgentInfo(agent.url));

      // Set publishers
      publishers = profile.publishers ? [...profile.publishers] : [];
      renderPublishers();
      // Validate info for each publisher
      publishers.forEach(pub => validatePublisherDomain(pub.domain));

      // Update filename displays for logos
      updateFilenameDisplay('logo_light_url', 'logo_light_filename');
      updateFilenameDisplay('logo_dark_url', 'logo_dark_filename');

      // Update logo preview
      updateLogoPreview();

      // Update status badge
      updateStatusBadge(profile);
    }

    function updateStatusBadge(profile) {
      const indicator = document.getElementById('profile-status-indicator');
      const badge = document.getElementById('status-badge');

      if (!indicator || !badge || !profile) {
        if (indicator) indicator.style.display = 'none';
        return;
      }

      indicator.style.display = 'block';

      if (profile.is_public) {
        badge.className = 'status-badge published';
        badge.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="16 12 12 8 8 12"/>
            <line x1="12" y1="16" x2="12" y2="8"/>
          </svg>
          Published
        `;
      } else {
        badge.className = 'status-badge draft';
        badge.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          Draft
        `;
      }
    }

    function setupOfferingsToggle() {
      document.querySelectorAll('.checkbox-item').forEach(item => {
        // The <label> element natively toggles the checkbox when clicked
        // We just need to update the visual state on change
        const checkbox = item.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', () => {
          item.classList.toggle('selected', checkbox.checked);
        });
      });
    }

    function setupTagsInput() {
      const input = document.getElementById('tag-input');
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ',') {
          e.preventDefault();
          addTag(input.value.trim());
          input.value = '';
        }
        // Note: Removed backspace-to-delete-tag behavior
        // Users should use the X button on tags to delete them
        // Backspace now only edits text in the input field as expected
      });
    }

    function setupPhoneFormatting() {
      const phoneInput = document.getElementById('contact_phone');
      if (!phoneInput) return;

      phoneInput.addEventListener('input', (e) => {
        let value = e.target.value;

        // Store cursor position
        const cursorPos = e.target.selectionStart;
        const oldLength = value.length;

        // Remove all non-digit characters except + at the start
        const startsWithPlus = value.startsWith('+');
        const digits = value.replace(/\D/g, '');

        // Format based on number of digits
        let formatted = '';
        if (startsWithPlus && digits.length > 0) {
          // International format: +1 (555) 123-4567
          if (digits.length <= 1) {
            formatted = '+' + digits;
          } else if (digits.length <= 4) {
            formatted = '+' + digits.slice(0, 1) + ' (' + digits.slice(1);
          } else if (digits.length <= 7) {
            formatted = '+' + digits.slice(0, 1) + ' (' + digits.slice(1, 4) + ') ' + digits.slice(4);
          } else {
            formatted = '+' + digits.slice(0, 1) + ' (' + digits.slice(1, 4) + ') ' + digits.slice(4, 7) + '-' + digits.slice(7, 11);
          }
        } else if (digits.length > 0) {
          // Check if this looks like a US number with country code (11 digits starting with 1)
          if (digits.length === 11 && digits.startsWith('1')) {
            // Format as +1 (XXX) XXX-XXXX
            formatted = '+1 (' + digits.slice(1, 4) + ') ' + digits.slice(4, 7) + '-' + digits.slice(7, 11);
          } else if (digits.length <= 3) {
            // US format: (555) 123-4567
            formatted = '(' + digits;
          } else if (digits.length <= 6) {
            formatted = '(' + digits.slice(0, 3) + ') ' + digits.slice(3);
          } else {
            formatted = '(' + digits.slice(0, 3) + ') ' + digits.slice(3, 6) + '-' + digits.slice(6, 10);
          }
        }

        e.target.value = formatted;

        // Adjust cursor position
        const newLength = formatted.length;
        const diff = newLength - oldLength;
        const newCursorPos = Math.max(0, cursorPos + diff);
        e.target.setSelectionRange(newCursorPos, newCursorPos);
      });
    }

    function setupMarketsAutoSelect() {
      const marketCheckboxes = document.querySelectorAll('input[name="markets"]');
      const globalCheckbox = document.querySelector('input[name="markets"][value="Global"]');
      const regionCheckboxes = Array.from(marketCheckboxes).filter(cb => cb.value !== 'Global');

      if (!globalCheckbox || regionCheckboxes.length === 0) return;

      // When individual regions change, check if all are selected
      regionCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allRegionsSelected = regionCheckboxes.every(cb => cb.checked);

          if (allRegionsSelected && !globalCheckbox.checked) {
            // Auto-select Global when all regions are selected
            globalCheckbox.checked = true;
            globalCheckbox.closest('.checkbox-item').classList.add('selected');
          }
        });
      });

      // When Global is selected, select all regions
      globalCheckbox.addEventListener('change', () => {
        if (globalCheckbox.checked) {
          regionCheckboxes.forEach(cb => {
            cb.checked = true;
            cb.closest('.checkbox-item').classList.add('selected');
          });
        }
      });
    }

    function addTag(tag) {
      tag = tag.replace(/,/g, '').trim().toLowerCase();
      if (tag && !tags.includes(tag)) {
        tags.push(tag);
        renderTags();
      }
    }

    function removeTag(index) {
      tags.splice(index, 1);
      renderTags();
    }

    function renderTags() {
      const container = document.getElementById('tags-container');
      const input = document.getElementById('tag-input');

      // Remove existing tags
      container.querySelectorAll('.tag').forEach(t => t.remove());

      // Add tags
      tags.forEach((tag, index) => {
        const tagEl = document.createElement('span');
        tagEl.className = 'tag';
        tagEl.innerHTML = `${escapeHtml(tag)} <span class="tag-remove" onclick="removeTag(${index})">x</span>`;
        container.insertBefore(tagEl, input);
      });

      // Update hidden input
      document.getElementById('tags').value = JSON.stringify(tags);
    }

    function setupSlugCheck() {
      const slugInput = document.getElementById('slug');
      slugInput.addEventListener('input', () => {
        // Convert to lowercase and replace spaces/invalid chars
        slugInput.value = slugInput.value.toLowerCase().replace(/[^a-z0-9-]/g, '-').replace(/-+/g, '-');

        clearTimeout(slugCheckTimeout);
        slugCheckTimeout = setTimeout(() => checkSlugAvailability(slugInput.value), 300);
      });
    }

    async function checkSlugAvailability(slug) {
      const statusEl = document.getElementById('slug-status');

      if (!slug || slug.length < 2) {
        statusEl.textContent = '';
        return;
      }

      try {
        const response = await fetch(`/api/members/check-slug/${slug}`);
        const data = await response.json();

        if (data.available) {
          statusEl.textContent = 'Available';
          statusEl.className = 'slug-status available';
        } else {
          statusEl.textContent = 'Already taken';
          statusEl.className = 'slug-status taken';
        }
      } catch (error) {
        statusEl.textContent = '';
      }
    }

    function setupLogoPreview() {
      document.getElementById('logo_light_url').addEventListener('input', updateLogoPreview);
      document.getElementById('logo_dark_url').addEventListener('input', updateLogoPreview);
      document.getElementById('contact_email').addEventListener('input', updateLogoPreview);
    }

    function getGravatarUrl(email, size = 120) {
      if (!email) return null;
      // Simple hash function for Gravatar (MD5 would be ideal but this works for demo)
      const hash = email.trim().toLowerCase();
      // Use identicon as default if no Gravatar exists
      return `https://www.gravatar.com/avatar/${btoa(hash).substring(0, 32)}?s=${size}&d=identicon`;
    }

    function updateLogoPreview() {
      const logoLightUrl = document.getElementById('logo_light_url').value;
      const logoDarkUrl = document.getElementById('logo_dark_url').value;
      const contactEmail = document.getElementById('contact_email').value;

      const lightPreview = document.getElementById('logo-light-preview');
      const darkPreview = document.getElementById('logo-dark-preview');
      const gravatarNote = document.getElementById('gravatar-note');

      // If only one logo provided, use it for both
      const lightLogo = logoLightUrl || logoDarkUrl;
      const darkLogo = logoDarkUrl || logoLightUrl;

      // Also set the hidden logo_url field to the light logo for backwards compatibility
      document.getElementById('logo_url').value = logoLightUrl || logoDarkUrl || '';

      const hasAnyLogo = logoLightUrl || logoDarkUrl;
      const gravatarUrl = getGravatarUrl(contactEmail);

      // Show gravatar note if no logos but has email
      gravatarNote.style.display = (!hasAnyLogo && contactEmail) ? 'block' : 'none';

      // Update light background preview
      if (lightLogo) {
        const lightImg = document.createElement('img');
        lightImg.id = 'logo-light-preview';
        lightImg.src = lightLogo;
        lightImg.alt = 'Logo on light';
        lightImg.onerror = function() {
          this.outerHTML = '<div id="logo-light-preview" class="placeholder">Invalid URL</div>';
        };
        lightPreview.replaceWith(lightImg);
      } else if (gravatarUrl) {
        const lightImg = document.createElement('img');
        lightImg.id = 'logo-light-preview';
        lightImg.src = gravatarUrl;
        lightImg.alt = 'Gravatar fallback';
        lightImg.style.borderRadius = '50%';
        lightPreview.replaceWith(lightImg);
      } else {
        if (lightPreview.tagName === 'IMG') {
          lightPreview.outerHTML = '<div id="logo-light-preview" class="placeholder">No logo</div>';
        }
      }

      // Update dark background preview
      if (darkLogo) {
        const darkImg = document.createElement('img');
        darkImg.id = 'logo-dark-preview';
        darkImg.src = darkLogo;
        darkImg.alt = 'Logo on dark';
        darkImg.onerror = function() {
          this.outerHTML = '<div id="logo-dark-preview" class="placeholder">Invalid URL</div>';
        };
        darkPreview.replaceWith(darkImg);
      } else if (gravatarUrl) {
        const darkImg = document.createElement('img');
        darkImg.id = 'logo-dark-preview';
        darkImg.src = gravatarUrl;
        darkImg.alt = 'Gravatar fallback';
        darkImg.style.borderRadius = '50%';
        darkPreview.replaceWith(darkImg);
      } else {
        if (darkPreview.tagName === 'IMG') {
          darkPreview.outerHTML = '<div id="logo-dark-preview" class="placeholder">No logo</div>';
        }
      }

      // Update member card preview
      updateMemberCardPreview();
    }

    async function handleLogoUpload(input, targetFieldId, filenameId) {
      const file = input.files[0];
      if (!file) return;

      // Check file size (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        alert('File too large. Maximum size is 2MB.');
        input.value = '';
        return;
      }

      // Check file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file.');
        input.value = '';
        return;
      }

      // Update filename display
      const filenameEl = document.getElementById(filenameId);
      filenameEl.textContent = file.name;
      filenameEl.classList.add('has-file');

      // Show clear button
      const clearBtn = document.getElementById(targetFieldId.replace('_url', '_clear'));
      if (clearBtn) clearBtn.style.display = 'block';

      // Convert to data URL
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById(targetFieldId).value = e.target.result;
        updateLogoPreview();
      };
      reader.readAsDataURL(file);

      // Clear file input for potential re-upload
      input.value = '';
    }

    function clearLogo(fieldId, filenameId) {
      document.getElementById(fieldId).value = '';
      const filenameEl = document.getElementById(filenameId);
      filenameEl.textContent = '';
      filenameEl.classList.remove('has-file');
      document.getElementById(fieldId.replace('_url', '_clear')).style.display = 'none';
      updateLogoPreview();
    }

    function updateFilenameDisplay(fieldId, filenameId) {
      const value = document.getElementById(fieldId).value;
      const filenameEl = document.getElementById(filenameId);
      const clearBtn = document.getElementById(fieldId.replace('_url', '_clear'));

      if (value) {
        // Check if it's a data URL or regular URL
        if (value.startsWith('data:')) {
          filenameEl.textContent = 'Uploaded image';
        } else {
          // Extract filename from URL
          try {
            const url = new URL(value);
            filenameEl.textContent = url.pathname.split('/').pop() || value;
          } catch {
            filenameEl.textContent = value.substring(0, 30) + (value.length > 30 ? '...' : '');
          }
        }
        filenameEl.classList.add('has-file');
        if (clearBtn) clearBtn.style.display = 'block';
      } else {
        filenameEl.textContent = '';
        filenameEl.classList.remove('has-file');
        if (clearBtn) clearBtn.style.display = 'none';
      }
    }

    // offeringLabels and renderMemberCard are now in member-card.js

    function updateMemberCardPreview() {
      // Inject member card styles from shared module
      injectMemberCardStyles();
      const previewEl = document.getElementById('member-card-preview');
      if (!previewEl) return;

      // Build member object from form values
      const member = {
        display_name: document.getElementById('display_name').value || 'Your Company',
        description: document.getElementById('description').value || '',
        logo_url: document.getElementById('logo_light_url').value || document.getElementById('logo_dark_url').value || null,
        contact_website: document.getElementById('contact_website').value || null,
        linkedin_url: document.getElementById('linkedin_url').value || null,
        offerings: Array.from(document.querySelectorAll('input[name="offerings"]:checked')).map(cb => cb.value)
      };

      // Use shared renderMemberCard with preview mode (no click handlers)
      previewEl.innerHTML = renderMemberCard(member, { isPreview: true });
    }

    async function saveProfile(event) {
      event.preventDefault();

      const saveBtn = document.getElementById('save-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      hideMessages();

      // Gather form data
      const logoLightUrl = document.getElementById('logo_light_url').value || null;
      const logoDarkUrl = document.getElementById('logo_dark_url').value || null;
      const description = document.getElementById('description').value || null;

      const formData = {
        display_name: document.getElementById('display_name').value,
        tagline: null, // No longer using separate tagline - description is truncated where needed
        description,
        logo_url: logoLightUrl || logoDarkUrl, // Use first available for backwards compat
        logo_light_url: logoLightUrl,
        logo_dark_url: logoDarkUrl,
        contact_email: document.getElementById('contact_email').value || null,
        contact_phone: document.getElementById('contact_phone').value || null,
        contact_website: document.getElementById('contact_website').value || null,
        linkedin_url: document.getElementById('linkedin_url').value || null,
        twitter_url: document.getElementById('twitter_url').value || null,
        markets: Array.from(document.querySelectorAll('input[name="markets"]:checked')).map(cb => cb.value),
        offerings: Array.from(document.querySelectorAll('input[name="offerings"]:checked')).map(cb => cb.value),
        agents: agents,
        publishers: publishers,
        tags: tags,
        // Note: is_public and show_in_carousel are managed from the dashboard, not here
      };

      // Add slug only for new profiles
      if (isNewProfile) {
        formData.slug = document.getElementById('slug').value;
      }

      try {
        const method = isNewProfile ? 'POST' : 'PUT';
        const response = await fetch(buildApiUrl('/api/me/member-profile'), {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData),
          credentials: 'include'
        });

        // Check response status before parsing JSON
        if (!response.ok) {
          // Try to get error message from JSON response, fallback to status text
          let errorMessage = 'Failed to save profile';
          try {
            const errorData = await response.json();
            errorMessage = errorData.message || errorMessage;
          } catch {
            // Response wasn't JSON (e.g., HTML error page from proxy)
            errorMessage = `Server error (${response.status}). Please try again.`;
          }
          throw new Error(errorMessage);
        }

        const data = await response.json();

        currentProfile = data.profile;
        const wasNewProfile = isNewProfile;
        isNewProfile = false;

        // If this was a new profile creation, redirect to dashboard with success message
        if (wasNewProfile) {
          const orgParam = currentOrgId ? `&org=${currentOrgId}` : '';
          window.location.href = `/dashboard?profile_created=true${orgParam}`;
          return;
        }

        // For updates, show success message and stay on page
        showSuccess('Profile saved successfully!');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Profile';

        // Update status badge with new profile data
        updateStatusBadge(data.profile);
      } catch (error) {
        console.error('Save error:', error);
        showError(error.message || 'Failed to save profile. Please try again.');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Profile';
      }
    }

    function goToDashboard() {
      const orgParam = currentOrgId ? `?org=${currentOrgId}` : '';
      window.location.href = `/dashboard${orgParam}`;
    }

    async function deleteProfile() {
      const confirmMsg = currentOrgName
        ? `Are you sure you want to delete the member profile for ${currentOrgName}? This action cannot be undone.`
        : 'Are you sure you want to delete your member profile? This action cannot be undone.';

      if (!confirm(confirmMsg)) {
        return;
      }

      try {
        const response = await fetch(buildApiUrl('/api/me/member-profile'), {
          method: 'DELETE',
          credentials: 'include'
        });

        if (!response.ok) {
          // Try to get error message from JSON response
          let errorMessage = 'Failed to delete profile';
          try {
            const errorData = await response.json();
            errorMessage = errorData.message || errorMessage;
          } catch {
            // Response wasn't JSON (e.g., HTML error page from proxy)
            errorMessage = `Server error (${response.status}). Please try again.`;
          }
          throw new Error(errorMessage);
        }

        window.location.href = '/dashboard';
      } catch (error) {
        console.error('Delete error:', error);
        showError(error.message || 'Failed to delete profile. Please try again.');
      }
    }

    function showSuccess(message) {
      const el = document.getElementById('success-message');
      el.textContent = message;
      el.style.display = 'block';
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function showError(message) {
      const el = document.getElementById('error-message');
      el.textContent = message;
      el.style.display = 'block';
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function hideMessages() {
      document.getElementById('success-message').style.display = 'none';
      document.getElementById('error-message').style.display = 'none';
    }

    // Agent management
    function addAgentUrl() {
      const input = document.getElementById('new-agent-url');
      let url = input.value.trim();

      if (!url) return;

      // Normalize URL
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
      }

      // Remove trailing slash
      url = url.replace(/\/$/, '');

      // Check if already added
      if (agents.some(a => a.url === url)) {
        alert('This agent URL is already added.');
        return;
      }

      // Validate URL format
      try {
        new URL(url);
      } catch {
        alert('Please enter a valid URL.');
        return;
      }

      // Add agent with default public visibility
      agents.push({ url, is_public: true });
      input.value = '';
      renderAgents();
      discoverAgentInfo(url);
    }

    function removeAgent(index) {
      const agent = agents[index];
      if (agent) {
        delete agentInfo[agent.url];
        agents.splice(index, 1);
        renderAgents();
      }
    }

    function renderAgents() {
      const container = document.getElementById('agent-urls-container');

      // Inject shared agent card styles
      injectAgentCardStyles();

      if (agents.length === 0) {
        container.innerHTML = '<div style="color: var(--color-text-secondary); font-size: var(--text-sm); padding: var(--space-2.5);">No agents registered yet.</div>';
        return;
      }

      // Use shared renderAgentCard from member-card.js
      container.innerHTML = agents.map((agent, index) => {
        const info = agentInfo[agent.url];
        return renderAgentCard(info, agent.url, {
          showVisibilityToggle: true,
          isPublic: agent.is_public,
          index: index,
          showRemoveButton: true,
          showStatus: true
        });
      }).join('');
    }

    function toggleAgentVisibility(index, isPublic) {
      if (agents[index]) {
        agents[index].is_public = isPublic;
        renderAgents();
      }
    }

    async function discoverAgentInfo(url) {
      try {
        const response = await fetch(`/api/discover-agent?url=${encodeURIComponent(url)}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          const data = await response.json();
          agentInfo[url] = { error: data.message || 'Failed to connect' };
        } else {
          const data = await response.json();
          agentInfo[url] = data;
        }
      } catch (error) {
        agentInfo[url] = { error: 'Failed to connect to agent' };
      }

      renderAgents();
    }

    // Publisher management
    function addPublisherDomain() {
      const input = document.getElementById('new-publisher-domain');
      let domain = input.value.trim();

      if (!domain) return;

      // Normalize domain - remove protocol and trailing slash
      domain = domain.replace(/^https?:\/\//, '').replace(/\/$/, '');

      // Remove any path components - just keep the domain
      domain = domain.split('/')[0];

      // Check if already added
      if (publishers.some(p => p.domain === domain)) {
        alert('This publisher domain is already added.');
        return;
      }

      // Basic domain validation
      if (!/^[a-zA-Z0-9][a-zA-Z0-9-]*\.[a-zA-Z]{2,}$/.test(domain) && !/^[a-zA-Z0-9][a-zA-Z0-9-.]*\.[a-zA-Z]{2,}$/.test(domain)) {
        alert('Please enter a valid domain name (e.g., example.com).');
        return;
      }

      // Add publisher with default public visibility
      publishers.push({ domain, is_public: true });
      input.value = '';
      renderPublishers();
      validatePublisherDomain(domain);
    }

    function removePublisher(index) {
      const publisher = publishers[index];
      if (publisher) {
        delete publisherInfo[publisher.domain];
        publishers.splice(index, 1);
        renderPublishers();
      }
    }

    function renderPublishers() {
      const container = document.getElementById('publisher-urls-container');

      // Inject shared publisher card styles
      injectPublisherCardStyles();

      if (publishers.length === 0) {
        container.innerHTML = '<div style="color: var(--color-text-secondary); font-size: var(--text-sm); padding: var(--space-2.5);">No publishers registered yet.</div>';
        return;
      }

      // Use shared renderPublisherCard from member-card.js
      container.innerHTML = publishers.map((publisher, index) => {
        const info = publisherInfo[publisher.domain];
        return renderPublisherCard(info, publisher.domain, {
          showVisibilityToggle: true,
          isPublic: publisher.is_public,
          index: index,
          showRemoveButton: true,
          showStatus: true
        });
      }).join('');
    }

    function togglePublisherVisibility(index, isPublic) {
      if (publishers[index]) {
        publishers[index].is_public = isPublic;
        renderPublishers();
      }
    }

    async function validatePublisherDomain(domain) {
      try {
        const response = await fetch(`/api/validate-publisher?domain=${encodeURIComponent(domain)}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          const data = await response.json();
          publisherInfo[domain] = { error: data.message || 'Validation failed' };
        } else {
          const data = await response.json();
          publisherInfo[domain] = data;
        }
      } catch (error) {
        publisherInfo[domain] = { error: 'Failed to validate publisher' };
      }

      renderPublishers();
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
