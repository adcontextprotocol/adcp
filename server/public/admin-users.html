<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Admin - Users & Actions - AgenticAdvertising.org</title>
  <link rel="stylesheet" href="/design-system.css">
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <style>
    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-xl);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }
    h1 { margin-bottom: var(--space-2.5); color: var(--color-text-heading); }
    .subtitle {
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
    }
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-5);
      flex-wrap: wrap;
      gap: var(--space-4);
    }
    .filter-bar {
      display: flex;
      gap: var(--space-2.5);
      margin-bottom: var(--space-5);
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-bar input,
    .filter-bar select {
      padding: var(--space-2) var(--space-3);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }
    .filter-bar input {
      min-width: 200px;
    }
    .btn {
      padding: var(--space-2) var(--space-4);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
    }
    .btn-small { padding: var(--space-1.5) var(--space-3); font-size: var(--text-xs); }
    .btn-primary { background: var(--color-brand); color: white; }
    .btn-primary:hover { background: var(--color-primary-700); }
    .btn-secondary { background: var(--color-gray-200); color: var(--color-text-heading); }
    .btn-secondary:hover { background: var(--color-gray-300); }
    .btn-outline {
      background: transparent;
      color: var(--color-brand);
      border: var(--border-1) solid var(--color-brand);
    }
    .btn-outline:hover {
      background: var(--color-primary-50);
    }
    .btn-success { background: var(--color-success-600); color: white; }
    .btn-success:hover { background: var(--color-success-700); }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Stats Cards */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }
    .stat-card {
      background: var(--color-gray-50);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      text-align: center;
    }
    .stat-card.clickable {
      cursor: pointer;
      transition: var(--transition-all);
    }
    .stat-card.clickable:hover {
      background: var(--color-primary-50);
    }
    .stat-card.active {
      background: var(--color-primary-100);
      border: 2px solid var(--color-brand);
    }
    .stat-value {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--color-brand);
    }
    .stat-label {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }

    /* Users Table */
    .users-table {
      width: 100%;
      border-collapse: collapse;
    }
    .users-table th,
    .users-table td {
      padding: var(--space-3);
      text-align: left;
      border-bottom: var(--border-1) solid var(--color-gray-200);
    }
    .users-table th {
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      background: var(--color-gray-50);
      font-size: var(--text-sm);
    }
    .users-table tr:hover {
      background: var(--color-gray-50);
    }
    .user-name {
      font-weight: var(--font-medium);
      color: var(--color-text-heading);
    }
    .user-name-link {
      color: var(--color-brand);
      text-decoration: none;
      cursor: pointer;
    }
    .user-name-link:hover {
      text-decoration: underline;
    }
    .user-email {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }
    .user-org {
      font-size: var(--text-sm);
      color: var(--color-text-muted);
    }
    a.user-org {
      color: var(--color-brand);
      text-decoration: none;
    }
    a.user-org:hover {
      text-decoration: underline;
    }
    .group-badges {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
    }
    .group-badge {
      display: inline-block;
      padding: 2px var(--space-2);
      background: var(--color-primary-100);
      color: var(--color-brand);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      text-decoration: none;
      transition: var(--transition-colors);
    }
    .group-badge:hover {
      background: var(--color-primary-200);
    }
    .group-badge.private {
      background: var(--color-warning-100);
      color: var(--color-warning-700);
    }
    .no-groups {
      color: var(--color-text-muted);
      font-size: var(--text-sm);
      font-style: italic;
    }
    .empty-state {
      text-align: center;
      padding: var(--space-10);
      color: var(--color-text-secondary);
    }

    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .status-mapped {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .status-unmapped {
      background: var(--color-gray-100);
      color: var(--color-gray-600);
    }
    .status-suggested {
      background: var(--color-warning-100);
      color: var(--color-warning-700);
    }
    .status-aao-only {
      background: var(--color-info-100);
      color: var(--color-info-700);
    }
    .status-slack-only {
      background: var(--color-primary-100);
      color: var(--color-primary-700);
    }

    /* Engagement score display */
    .score-bar {
      width: 50px;
      height: 6px;
      background: var(--color-gray-200);
      border-radius: 3px;
      overflow: hidden;
      display: inline-block;
      margin-right: var(--space-1);
      vertical-align: middle;
    }
    .score-fill {
      height: 100%;
      border-radius: 3px;
    }
    .score-fill.low { background: var(--color-gray-400); }
    .score-fill.medium { background: var(--color-warning-500); }
    .score-fill.high { background: var(--color-success-500); }
    .score-value {
      font-weight: var(--font-medium);
      font-size: var(--text-sm);
      color: var(--color-text-heading);
    }
    .score-na {
      color: var(--color-text-muted);
      font-size: var(--text-sm);
      font-style: italic;
    }

    /* Goal badges */
    .goal-badge {
      display: inline-block;
      padding: 3px var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      white-space: nowrap;
    }
    .goal-link_account {
      background: #4A154B20;
      color: #4A154B;
    }
    .goal-membership_pitch {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .goal-drive_engagement {
      background: var(--color-warning-100);
      color: var(--color-warning-700);
    }
    .goal-drive_value {
      background: var(--color-info-100);
      color: var(--color-info-700);
    }
    .goal-learn_interests {
      background: #9c27b020;
      color: #9c27b0;
    }
    .goal-deepen_relationship {
      background: #00968820;
      color: #009688;
    }
    .goal-initial_contact {
      background: var(--color-gray-200);
      color: var(--color-text-secondary);
    }

    /* Source indicator */
    .source-icon {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      font-size: var(--text-xs);
      color: var(--color-text-muted);
    }
    .source-icon svg {
      width: 14px;
      height: 14px;
    }

    /* Actions */
    .action-cell {
      display: flex;
      gap: var(--space-2);
    }
    .btn-info {
      background: var(--color-info-500);
      color: white;
    }
    .btn-info:hover {
      background: var(--color-info-600);
    }

    /* Context Modal */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--color-surface-overlay);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: var(--space-8);
      z-index: 1000;
      overflow-y: auto;
    }
    .modal-backdrop.hidden {
      display: none;
    }
    .modal-content {
      background: var(--color-bg-card);
      border-radius: var(--radius-lg);
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4) var(--space-5);
      border-bottom: var(--border-1) solid var(--color-border);
      position: sticky;
      top: 0;
      background: var(--color-bg-card);
      z-index: 1;
    }
    .modal-header h2 {
      margin: 0;
      font-size: var(--text-lg);
      color: var(--color-text-heading);
    }
    .modal-close {
      background: none;
      border: none;
      font-size: var(--text-2xl);
      cursor: pointer;
      color: var(--color-text-muted);
      padding: 0;
      line-height: 1;
    }
    .modal-close:hover {
      color: var(--color-text-heading);
    }
    .modal-body {
      padding: var(--space-5);
    }

    /* Context display */
    .context-section {
      margin-bottom: var(--space-5);
    }
    .context-section h3 {
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      margin-bottom: var(--space-2);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .context-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-3);
    }
    .context-item {
      background: var(--color-bg-subtle);
      padding: var(--space-3);
      border-radius: var(--radius-md);
    }
    .context-item-label {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-bottom: var(--space-1);
    }
    .context-item-value {
      font-size: var(--text-sm);
      color: var(--color-text-heading);
      font-weight: var(--font-medium);
    }
    .context-item-value.success {
      color: var(--color-success-600);
    }
    .context-item-value.warning {
      color: var(--color-warning-600);
    }
    .context-item-value.muted {
      color: var(--color-text-muted);
      font-style: italic;
    }
    .context-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .context-list li {
      padding: var(--space-2) var(--space-3);
      background: var(--color-bg-subtle);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-1);
      font-size: var(--text-sm);
    }
    .context-badges {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
    }
    .context-badge {
      display: inline-block;
      padding: 2px var(--space-2);
      background: var(--color-primary-100);
      color: var(--color-primary-700);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .context-badge.leader {
      background: var(--color-warning-100);
      color: var(--color-warning-700);
    }
    .impersonation-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      background: var(--color-warning-100);
      color: var(--color-warning-700);
      border: var(--border-1) solid var(--color-warning-300);
      border-radius: var(--radius-md);
      text-decoration: none;
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      margin-top: var(--space-4);
    }
    .impersonation-link:hover {
      background: var(--color-warning-200);
    }
    .impersonation-link svg {
      width: 16px;
      height: 16px;
    }

    /* Sync banner */
    .sync-banner {
      background: var(--color-info-50);
      border: 1px solid var(--color-info-200);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-5);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-3);
    }
    .sync-info {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }
    .sync-info strong {
      color: var(--color-text-heading);
    }

    /* Action Items Panel */
    .action-items-panel {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-5);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }
    .action-items-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }
    .action-items-header h2 {
      margin: 0;
      font-size: var(--text-lg);
      color: var(--color-text-heading);
    }
    .action-items-stats {
      display: flex;
      gap: var(--space-4);
      font-size: var(--text-sm);
    }
    .action-stat {
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }
    .action-stat-count {
      font-weight: var(--font-bold);
      color: var(--color-text-heading);
    }
    .action-stat-label {
      color: var(--color-text-secondary);
    }
    .action-stat-high .action-stat-count { color: var(--color-error-600); }
    .action-stat-medium .action-stat-count { color: var(--color-warning-600); }
    .action-stat-low .action-stat-count { color: var(--color-success-600); }
    .action-items-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    .action-item-card {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: var(--space-4);
      background: var(--color-gray-50);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--color-gray-400);
    }
    .action-item-card.priority-high { border-left-color: var(--color-error-500); }
    .action-item-card.priority-medium { border-left-color: var(--color-warning-500); }
    .action-item-card.priority-low { border-left-color: var(--color-success-500); }
    .action-item-content {
      flex: 1;
      min-width: 0;
    }
    .action-item-title {
      font-weight: var(--font-medium);
      color: var(--color-text-heading);
      margin-bottom: var(--space-1);
    }
    .action-item-meta {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      display: flex;
      gap: var(--space-3);
      flex-wrap: wrap;
    }
    .action-item-user {
      color: var(--color-brand);
      font-weight: var(--font-medium);
    }
    .action-type-badge {
      display: inline-block;
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .action-type-nudge { background: var(--color-warning-100); color: var(--color-warning-700); }
    .action-type-warm_lead { background: var(--color-info-100); color: var(--color-info-700); }
    .action-type-momentum { background: var(--color-success-100); color: var(--color-success-700); }
    .action-type-feedback { background: var(--color-primary-100); color: var(--color-primary-700); }
    .action-type-alert { background: var(--color-error-100); color: var(--color-error-700); }
    .action-type-follow_up { background: #9c27b020; color: #9c27b0; }
    .action-type-celebration { background: #f3e8ff; color: #7c3aed; }
    .action-item-actions {
      display: flex;
      gap: var(--space-2);
      flex-shrink: 0;
    }
    .empty-actions {
      text-align: center;
      padding: var(--space-6);
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      gap: var(--space-1);
      border-bottom: var(--border-1) solid var(--color-gray-200);
      margin-bottom: var(--space-5);
    }
    .tab-btn {
      padding: var(--space-3) var(--space-4);
      border: none;
      background: none;
      cursor: pointer;
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: var(--transition-all);
    }
    .tab-btn:hover {
      color: var(--color-text-heading);
    }
    .tab-btn.active {
      color: var(--color-brand);
      border-bottom-color: var(--color-brand);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    /* My Accounts View */
    .accounts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: var(--space-4);
    }
    .account-card {
      background: var(--color-gray-50);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      position: relative;
    }
    .account-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-3);
    }
    .account-name {
      font-weight: var(--font-medium);
      color: var(--color-text-heading);
    }
    .account-email {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }
    .account-role-badge {
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .role-owner { background: var(--color-primary-100); color: var(--color-primary-700); }
    .role-interested { background: var(--color-info-100); color: var(--color-info-700); }
    .role-connected { background: var(--color-gray-200); color: var(--color-gray-600); }
    .account-stats {
      display: flex;
      gap: var(--space-4);
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-3);
    }
    .account-actions-count {
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }
    .account-actions-count.has-items {
      color: var(--color-warning-600);
      font-weight: var(--font-medium);
    }

    /* Responsive table */
    @media (max-width: 768px) {
      .users-table thead { display: none; }
      .users-table tr {
        display: block;
        margin-bottom: var(--space-4);
        border: var(--border-1) solid var(--color-gray-200);
        border-radius: var(--radius-md);
      }
      .users-table td {
        display: block;
        border: none;
        padding: var(--space-2) var(--space-3);
      }
      .users-table td:first-child {
        padding-top: var(--space-3);
      }
      .users-table td:last-child {
        padding-bottom: var(--space-3);
      }
    }
  </style>
</head>
<body>
  <!-- AAO top navigation -->
  <div id="adcp-nav"></div>

  <div id="loading" style="text-align: center; padding: var(--space-12); color: var(--color-text-secondary);">
    Loading...
  </div>

  <div id="content" style="display: none;">
    <div class="container">
      <!-- Action Items Panel -->
      <div id="actionItemsPanel" class="action-items-panel" style="display: none;">
        <div class="action-items-header">
          <h2>Action Items</h2>
          <div class="action-items-stats">
            <div class="action-stat action-stat-high">
              <span id="actionHighCount" class="action-stat-count">0</span>
              <span class="action-stat-label">High</span>
            </div>
            <div class="action-stat action-stat-medium">
              <span id="actionMediumCount" class="action-stat-count">0</span>
              <span class="action-stat-label">Medium</span>
            </div>
            <div class="action-stat action-stat-low">
              <span id="actionLowCount" class="action-stat-count">0</span>
              <span class="action-stat-label">Low</span>
            </div>
          </div>
        </div>
        <div id="actionItemsList" class="action-items-list">
          <!-- Populated by JS -->
        </div>
      </div>

      <div class="card">
        <div class="header-bar">
          <div>
            <h1>Users & Actions</h1>
            <p class="subtitle">Account management, action items, and engagement tracking</p>
          </div>
          <div style="display: flex; gap: var(--space-2);">
            <button id="syncWorkosBtn" class="btn btn-outline" onclick="syncWorkosUsers()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
              </svg>
              Sync WorkOS
            </button>
            <button id="syncBtn" class="btn btn-outline" onclick="syncSlackUsers()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 11-9-9"/>
                <polyline points="21 3 21 9 15 9"/>
              </svg>
              Sync Slack
            </button>
            <a href="/api/admin/users/memberships?format=csv" class="btn btn-outline" download>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Export CSV
            </a>
          </div>
        </div>

        <!-- Sync Status Banner -->
        <div id="syncBanner" class="sync-banner" style="display: none;">
          <div class="sync-info">
            <strong id="syncStatus">Slack not synced</strong>
            <span id="lastSyncTime"></span>
          </div>
          <div style="display: flex; gap: var(--space-2);">
            <span id="suggestedCount" style="font-size: var(--text-sm);"></span>
            <button id="autoLinkBtn" class="btn btn-success btn-small" onclick="autoLinkSuggested()" style="display: none;">
              Auto-link matches
            </button>
          </div>
        </div>

        <!-- Tabs -->
        <div class="tab-nav">
          <button class="tab-btn active" onclick="switchTab('all-users')">All Users</button>
          <button class="tab-btn" onclick="switchTab('my-accounts')">My Accounts</button>
        </div>

        <!-- All Users Tab -->
        <div id="tab-all-users" class="tab-content active">
        <!-- Stats -->
        <div class="stats-row">
          <div class="stat-card clickable" onclick="filterByStatus('')" id="stat-all">
            <div id="totalUsers" class="stat-value">-</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-card clickable" onclick="filterByStatus('mapped')" id="stat-mapped">
            <div id="mappedUsers" class="stat-value">-</div>
            <div class="stat-label">Both</div>
          </div>
          <div class="stat-card clickable" onclick="filterByStatus('suggested_match')" id="stat-suggested">
            <div id="suggestedUsers" class="stat-value">-</div>
            <div class="stat-label">Can Link</div>
          </div>
          <div class="stat-card clickable" onclick="filterByStatus('aao_only')" id="stat-aao">
            <div id="aaoOnlyUsers" class="stat-value">-</div>
            <div class="stat-label">Website Only</div>
          </div>
          <div class="stat-card clickable" onclick="filterByStatus('slack_only')" id="stat-slack">
            <div id="slackOnlyUsers" class="stat-value">-</div>
            <div class="stat-label">Slack Only</div>
          </div>
        </div>

        <!-- Filters -->
        <div class="filter-bar">
          <input type="text" id="searchInput" placeholder="Search users, orgs, emails..." oninput="debounceSearch()">
          <select id="statusFilter" onchange="loadUsers()">
            <option value="">All Statuses</option>
            <option value="mapped">Mapped</option>
            <option value="suggested_match">Suggested Match</option>
            <option value="aao_only">AAO Only</option>
            <option value="slack_only">Slack Only (Unmapped)</option>
          </select>
          <select id="goalFilter" onchange="loadUsers()">
            <option value="">All Goals</option>
          </select>
          <select id="groupFilter" onchange="loadUsers()">
            <option value="">All Working Groups</option>
          </select>
          <button class="btn btn-secondary btn-small" onclick="clearFilters()">Clear Filters</button>
        </div>

        <!-- Users Table -->
        <div id="usersTableContainer">
          <table class="users-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Organization</th>
                <th>Engagement</th>
                <th>Goal</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- Populated dynamically -->
            </tbody>
          </table>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
          No users found matching your filters.
        </div>
        </div><!-- End All Users Tab -->

        <!-- My Accounts Tab -->
        <div id="tab-my-accounts" class="tab-content">
          <div id="myAccountsContainer">
            <div id="myAccountsGrid" class="accounts-grid">
              <!-- Populated by JS -->
            </div>
            <div id="emptyAccountsState" class="empty-state" style="display: none;">
              <p>No accounts assigned to you yet.</p>
              <p style="font-size: var(--text-sm); margin-top: var(--space-2);">
                Accounts are auto-assigned when you send outreach or have conversations.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Context Modal -->
  <div id="contextModal" class="modal-backdrop hidden" onclick="closeContextModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 id="contextModalTitle">Member Context</h2>
        <button class="modal-close" onclick="closeContextModal()">&times;</button>
      </div>
      <div class="modal-body" id="contextModalBody">
        <!-- Content populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Add Insight Modal -->
  <div id="addInsightModal" class="modal-backdrop hidden" onclick="closeAddInsightModal(event)">
    <div class="modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>Add Insight</h2>
        <button class="modal-close" onclick="closeAddInsightModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="addInsightForm" onsubmit="submitInsight(event)">
          <input type="hidden" id="insightSlackUserId" />

          <div class="form-group" style="margin-bottom: var(--space-4);">
            <label for="insightType" style="display: block; font-weight: var(--font-medium); margin-bottom: var(--space-2);">Insight Type</label>
            <select id="insightType" required style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-gray-300); border-radius: var(--radius-sm);">
              <option value="">Select type...</option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom: var(--space-4);">
            <label for="insightValue" style="display: block; font-weight: var(--font-medium); margin-bottom: var(--space-2);">Value</label>
            <textarea id="insightValue" required rows="3" placeholder="What do you know about this person?" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-gray-300); border-radius: var(--radius-sm); resize: vertical;"></textarea>
          </div>

          <div class="form-group" style="margin-bottom: var(--space-4);">
            <label for="insightConfidence" style="display: block; font-weight: var(--font-medium); margin-bottom: var(--space-2);">Confidence</label>
            <select id="insightConfidence" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-gray-300); border-radius: var(--radius-sm);">
              <option value="high">High - Directly told to me</option>
              <option value="medium" selected>Medium - Inferred from context</option>
              <option value="low">Low - Guess/assumption</option>
            </select>
          </div>

          <div style="display: flex; gap: var(--space-2); justify-content: flex-end;">
            <button type="button" onclick="closeAddInsightModal()" class="btn btn-secondary">Cancel</button>
            <button type="submit" class="btn btn-primary" id="submitInsightBtn">Add Insight</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Nudge/Override Modal -->
  <div id="nudgeModal" class="modal-backdrop hidden" onclick="closeNudgeModal(event)">
    <div class="modal-content" style="max-width: 550px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>Different Approach</h2>
        <button class="modal-close" onclick="closeNudgeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="nudgeSlackUserId" />
        <input type="hidden" id="nudgeGoalId" />

        <div id="nudgeGoalInfo" style="background: var(--color-primary-50); border-radius: var(--radius-sm); padding: var(--space-3); margin-bottom: var(--space-4);">
          <div style="font-weight: var(--font-medium); margin-bottom: var(--space-1);" id="nudgeGoalName">Loading...</div>
          <div style="font-size: var(--text-sm); color: var(--color-text-secondary);" id="nudgeGoalDescription"></div>
        </div>

        <div class="form-group" style="margin-bottom: var(--space-4);">
          <label for="nudgeContext" style="display: block; font-weight: var(--font-medium); margin-bottom: var(--space-2);">Additional Context (optional)</label>
          <textarea id="nudgeContext" rows="3" placeholder="Share what you know about this person that might help personalize the message... (this will be saved as an insight)" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-gray-300); border-radius: var(--radius-sm); resize: vertical;"></textarea>
          <p style="font-size: var(--text-xs); color: var(--color-text-muted); margin-top: var(--space-1);">If provided, this will be recorded as an "admin_context" insight for future reference.</p>
        </div>

        <div id="nudgeMessagePreview" style="margin-bottom: var(--space-4); display: none;">
          <label style="display: block; font-weight: var(--font-medium); margin-bottom: var(--space-2);">Message Preview</label>
          <div style="background: white; border: 1px solid var(--color-gray-200); border-radius: var(--radius-sm); padding: var(--space-3); font-size: var(--text-sm); white-space: pre-wrap; max-height: 150px; overflow-y: auto;" id="nudgeMessageText"></div>
        </div>

        <div style="display: flex; gap: var(--space-2); justify-content: flex-end; flex-wrap: wrap;">
          <button type="button" onclick="closeNudgeModal()" class="btn btn-secondary">Cancel</button>
          <button type="button" onclick="saveNudgeAsInsight()" class="btn btn-secondary" id="saveNudgeBtn" style="display: none;">Just Save Context</button>
          <button type="button" onclick="sendNudgeOutreach()" class="btn btn-primary" id="sendNudgeBtn">Send with This Goal</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let allUsers = [];
    let allGroups = [];
    let goalTypes = [];
    let searchTimeout = null;
    let slackConfigured = false;
    let currentStatusFilter = '';
    let actionItems = [];
    let myAccounts = [];
    let currentTab = 'all-users';

    async function init() {
      try {
        // Load working groups, goal types, and action items in parallel
        const [groupsResponse, goalsResponse, actionResponse] = await Promise.all([
          fetch('/api/admin/working-groups'),
          fetch('/api/admin/goal-types'),
          fetch('/api/admin/action-items/mine')
        ]);

        if (!groupsResponse.ok) {
          if (groupsResponse.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          throw new Error('Failed to load working groups');
        }
        allGroups = await groupsResponse.json();
        populateGroupFilter();

        if (goalsResponse.ok) {
          goalTypes = await goalsResponse.json();
          populateGoalFilter();
        } else {
          console.error('Failed to load goal types:', goalsResponse.status);
        }

        // Load action items
        if (actionResponse.ok) {
          const actionData = await actionResponse.json();
          actionItems = actionData.items || [];
          renderActionItems();
        }

        // Check Slack sync status
        await checkSlackStatus();

        // Load users
        await loadUsers();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch (error) {
        console.error('Error initializing:', error);
        document.getElementById('loading').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load users. <a href="/auth/login">Try logging in again</a></p>';
      }
    }

    // =========================================================================
    // Action Items Functions
    // =========================================================================

    function renderActionItems() {
      const panel = document.getElementById('actionItemsPanel');
      const list = document.getElementById('actionItemsList');

      if (!actionItems || actionItems.length === 0) {
        panel.style.display = 'none';
        return;
      }

      panel.style.display = 'block';

      // Update counts
      const highCount = actionItems.filter(a => a.priority === 'high').length;
      const mediumCount = actionItems.filter(a => a.priority === 'medium').length;
      const lowCount = actionItems.filter(a => a.priority === 'low').length;
      document.getElementById('actionHighCount').textContent = highCount;
      document.getElementById('actionMediumCount').textContent = mediumCount;
      document.getElementById('actionLowCount').textContent = lowCount;

      // Render items (limit to 5)
      const displayItems = actionItems.slice(0, 5);
      list.innerHTML = displayItems.map(item => {
        const userName = item.user_name || item.user_email || 'Unknown User';
        const created = new Date(item.created_at).toLocaleDateString();
        return `
          <div class="action-item-card priority-${item.priority}">
            <div class="action-item-content">
              <div class="action-item-title">${escapeHtml(item.title)}</div>
              <div class="action-item-meta">
                <span class="action-item-user">${escapeHtml(userName)}</span>
                <span class="action-type-badge action-type-${item.action_type}">${formatActionType(item.action_type)}</span>
                <span>${created}</span>
              </div>
            </div>
            <div class="action-item-actions">
              <button class="btn btn-success btn-small" onclick="completeActionItem(${item.id})" title="Mark complete">‚úì</button>
              <button class="btn btn-secondary btn-small" onclick="snoozeActionItem(${item.id})" title="Snooze 1 day">‚è∞</button>
              <button class="btn btn-secondary btn-small" onclick="dismissActionItem(${item.id})" title="Dismiss">‚úï</button>
            </div>
          </div>
        `;
      }).join('');

      if (actionItems.length > 5) {
        list.innerHTML += `<div style="text-align: center; padding: var(--space-2);"><em>${actionItems.length - 5} more action items...</em></div>`;
      }
    }

    function formatActionType(type) {
      const labels = {
        nudge: 'Nudge',
        warm_lead: 'Warm Lead',
        momentum: 'Momentum',
        feedback: 'Feedback',
        alert: 'Alert',
        follow_up: 'Follow Up',
        celebration: 'üéâ Celebration'
      };
      return labels[type] || type;
    }

    async function completeActionItem(id) {
      try {
        const response = await fetch(`/api/admin/action-items/${id}/complete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ resolution_note: 'Completed from users page' })
        });
        if (response.ok) {
          actionItems = actionItems.filter(a => a.id !== id);
          renderActionItems();
        }
      } catch (error) {
        console.error('Error completing action item:', error);
      }
    }

    async function snoozeActionItem(id) {
      try {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const response = await fetch(`/api/admin/action-items/${id}/snooze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ until: tomorrow.toISOString() })
        });
        if (response.ok) {
          actionItems = actionItems.filter(a => a.id !== id);
          renderActionItems();
        }
      } catch (error) {
        console.error('Error snoozing action item:', error);
      }
    }

    async function dismissActionItem(id) {
      if (!confirm('Dismiss this action item?')) return;
      try {
        const response = await fetch(`/api/admin/action-items/${id}/dismiss`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ resolution_note: 'Dismissed from users page' })
        });
        if (response.ok) {
          actionItems = actionItems.filter(a => a.id !== id);
          renderActionItems();
        }
      } catch (error) {
        console.error('Error dismissing action item:', error);
      }
    }

    // =========================================================================
    // Tab Navigation
    // =========================================================================

    function switchTab(tabId) {
      currentTab = tabId;

      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.toLowerCase().includes(tabId.replace('-', ' ').replace('all ', ''))) {
          btn.classList.add('active');
        }
      });

      // Show/hide tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`tab-${tabId}`).classList.add('active');

      // Load data for the tab if needed
      if (tabId === 'my-accounts' && myAccounts.length === 0) {
        loadMyAccounts();
      }
    }

    // =========================================================================
    // My Accounts Functions
    // =========================================================================

    async function loadMyAccounts() {
      try {
        const response = await fetch('/api/admin/my-accounts');
        if (!response.ok) throw new Error('Failed to load accounts');
        myAccounts = await response.json();
        renderMyAccounts();
      } catch (error) {
        console.error('Error loading my accounts:', error);
      }
    }

    function renderMyAccounts() {
      const grid = document.getElementById('myAccountsGrid');
      const emptyState = document.getElementById('emptyAccountsState');

      if (!myAccounts || myAccounts.length === 0) {
        grid.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';

      grid.innerHTML = myAccounts.map(account => {
        const actionsClass = account.open_action_items > 0 ? 'has-items' : '';
        const lastActivity = account.last_slack_activity
          ? new Date(account.last_slack_activity).toLocaleDateString()
          : 'Never';
        const lastConvo = account.last_conversation
          ? new Date(account.last_conversation).toLocaleDateString()
          : 'Never';

        return `
          <div class="account-card">
            <div class="account-card-header">
              <div>
                <div class="account-name">${escapeHtml(account.account_name || 'Unknown')}</div>
                <div class="account-email">${escapeHtml(account.account_email || '')}</div>
                ${account.org_name ? `<div class="account-email">${escapeHtml(account.org_name)}</div>` : ''}
              </div>
              <span class="account-role-badge role-${account.role}">${account.role}</span>
            </div>
            <div class="account-stats">
              <span>Last Slack: ${lastActivity}</span>
              <span>Last Chat: ${lastConvo}</span>
            </div>
            <div class="account-actions-count ${actionsClass}">
              ${account.open_action_items > 0 ? `‚ö†Ô∏è ${account.open_action_items} action items` : '‚úì No pending actions'}
            </div>
            <div style="margin-top: var(--space-3); display: flex; gap: var(--space-2);">
              <button class="btn btn-info btn-small" onclick="showUserContext('${escapeJs(account.account_id)}', '${account.account_type === 'user' ? 'workos' : 'org'}', '${escapeJs(account.account_name || 'Account')}')">View</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function populateGoalFilter() {
      const select = document.getElementById('goalFilter');
      select.innerHTML = '<option value="">All Goals</option>' +
        goalTypes.map(g => `<option value="${g.goal_key}">${escapeHtml(g.name)}</option>`).join('');
    }

    async function checkSlackStatus() {
      try {
        const response = await fetch('/api/admin/slack/status');
        if (response.ok) {
          const status = await response.json();
          slackConfigured = status.configured;

          const banner = document.getElementById('syncBanner');
          if (slackConfigured) {
            banner.style.display = 'flex';
            if (status.last_sync) {
              const lastSync = new Date(status.last_sync);
              document.getElementById('syncStatus').textContent = 'Slack synced';
              document.getElementById('lastSyncTime').textContent =
                ' - Last sync: ' + lastSync.toLocaleString();
            } else {
              document.getElementById('syncStatus').textContent = 'Slack configured but not synced';
              document.getElementById('lastSyncTime').textContent = '';
            }

            // Check for suggested matches
            await checkSuggestedMatches();
          }
        }
      } catch (error) {
        console.error('Error checking Slack status:', error);
      }
    }

    async function checkSuggestedMatches() {
      try {
        const response = await fetch('/api/admin/slack/auto-link-suggested');
        if (response.ok) {
          const data = await response.json();
          const suggestedCount = data.suggestions?.length || 0;
          if (suggestedCount > 0) {
            document.getElementById('suggestedCount').textContent =
              suggestedCount + ' email matches found';
            document.getElementById('autoLinkBtn').style.display = 'inline-flex';
          }
        }
      } catch (error) {
        console.error('Error checking suggested matches:', error);
      }
    }

    async function syncWorkosUsers() {
      const btn = document.getElementById('syncWorkosBtn');
      btn.disabled = true;
      const originalHtml = btn.innerHTML;
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin"><path d="M21 12a9 9 0 11-9-9"/></svg> Syncing...';

      try {
        const response = await fetch('/api/admin/users/sync-workos', { method: 'POST' });
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            alert(`Synced users from WorkOS:\n‚Ä¢ ${result.orgs_processed} organizations processed\n‚Ä¢ ${result.memberships_created} user memberships synced`);
          } else {
            alert(`Sync completed with errors:\n‚Ä¢ ${result.orgs_processed} organizations processed\n‚Ä¢ ${result.memberships_created} memberships created\n‚Ä¢ ${result.errors.length} errors`);
          }
          await loadUsers();
        } else {
          const error = await response.json().catch(() => ({}));
          alert('Failed to sync WorkOS users: ' + (error.message || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error syncing WorkOS users:', error);
        alert('Error syncing WorkOS users');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
      }
    }

    async function syncSlackUsers() {
      const btn = document.getElementById('syncBtn');
      btn.disabled = true;
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin"><path d="M21 12a9 9 0 11-9-9"/></svg> Syncing...';

      try {
        const response = await fetch('/api/admin/slack/sync', { method: 'POST' });
        if (response.ok) {
          const result = await response.json();
          alert(`Synced ${result.total_synced} users (${result.new_users} new, ${result.updated_users} updated, ${result.auto_mapped} auto-mapped)`);
          await checkSlackStatus();
          await loadUsers();
        } else {
          alert('Failed to sync Slack users');
        }
      } catch (error) {
        console.error('Error syncing:', error);
        alert('Error syncing Slack users');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-9-9"/><polyline points="21 3 21 9 15 9"/></svg> Sync Slack';
      }
    }

    async function autoLinkSuggested() {
      const btn = document.getElementById('autoLinkBtn');
      btn.disabled = true;
      btn.textContent = 'Linking...';

      try {
        const response = await fetch('/api/admin/slack/auto-link-suggested', { method: 'POST' });
        if (response.ok) {
          const result = await response.json();
          alert(`Linked ${result.linked} users by email match`);
          document.getElementById('autoLinkBtn').style.display = 'none';
          document.getElementById('suggestedCount').textContent = '';
          await loadUsers();
        } else {
          alert('Failed to auto-link users');
        }
      } catch (error) {
        console.error('Error auto-linking:', error);
        alert('Error auto-linking users');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Auto-link matches';
      }
    }

    function populateGroupFilter() {
      const select = document.getElementById('groupFilter');
      select.innerHTML = '<option value="">All Working Groups</option>';

      allGroups.forEach(g => {
        const option = document.createElement('option');
        option.value = g.id;
        option.textContent = g.name + (g.is_private ? ' (Private)' : '');
        select.appendChild(option);
      });
    }

    async function loadUsers(retryCount = 0) {
      const search = document.getElementById('searchInput').value.trim();
      const statusFilter = document.getElementById('statusFilter').value;
      const goalFilter = document.getElementById('goalFilter').value;
      const groupFilter = document.getElementById('groupFilter').value;

      const params = new URLSearchParams();
      if (search) params.append('search', search);
      if (statusFilter) params.append('status', statusFilter);
      if (goalFilter) params.append('goal', goalFilter);
      if (groupFilter) params.append('group', groupFilter);

      try {
        const response = await fetch(`/api/admin/users?${params}`);
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || `HTTP ${response.status}`);
        }

        const data = await response.json();
        allUsers = data.users || [];

        renderUsers();
        updateStats(data.stats);
      } catch (error) {
        console.error('Error loading users:', error);
        // Retry up to 2 times with exponential backoff
        if (retryCount < 2) {
          const delay = Math.pow(2, retryCount) * 500; // 500ms, 1000ms
          console.log(`Retrying loadUsers in ${delay}ms (attempt ${retryCount + 2}/3)`);
          setTimeout(() => loadUsers(retryCount + 1), delay);
        } else {
          // Show error to user after all retries failed
          const tbody = document.getElementById('usersTableBody');
          tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: var(--space-8); color: var(--color-error-600);">
            Failed to load users. <button class="btn btn-secondary btn-small" onclick="loadUsers()">Retry</button>
          </td></tr>`;
        }
      }
    }

    function renderUsers() {
      const tbody = document.getElementById('usersTableBody');
      const emptyState = document.getElementById('emptyState');

      if (allUsers.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';

      tbody.innerHTML = allUsers.map(user => {
        // Determine source and display appropriately
        const sourceIcon = user.slack_user_id
          ? '<span class="source-icon" title="Has Slack account"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z"/></svg></span>'
          : '';

        const aaoIcon = user.workos_user_id
          ? '<span class="source-icon" title="Has AAO account"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></span>'
          : '';

        // Engagement score display
        const engagementHtml = renderEngagementScore(user.engagement_score);

        // Goal display
        const goalHtml = user.goal_key
          ? `<span class="goal-badge goal-${user.goal_key}">${escapeHtml(user.goal_name || formatGoalKey(user.goal_key))}</span>`
          : '<span class="score-na">‚Äî</span>';

        // Actions based on status
        let actions = '';

        // Add View Context button for all users that have either Slack or WorkOS ID
        const contextUserId = user.workos_user_id || user.slack_user_id;
        const contextType = user.workos_user_id ? 'workos' : 'slack';
        if (contextUserId) {
          actions += `<button class="btn btn-info btn-small" onclick="showUserContext('${escapeJs(contextUserId)}', '${contextType}', '${escapeJs(user.name || user.slack_real_name || user.slack_display_name || 'User')}', event)" title="View full context">View</button>`;
        }

        if (user.mapping_status === 'suggested_match') {
          actions += `<button class="btn btn-success btn-small" onclick="linkUser('${user.slack_user_id}', '${user.workos_user_id}', event)">Link</button>`;
        } else if (user.mapping_status === 'mapped') {
          actions += `<button class="btn btn-secondary btn-small" onclick="unlinkUser('${user.slack_user_id}')">Unlink</button>`;
        } else if (user.mapping_status === 'slack_only') {
          actions += `<span class="source-icon">Needs signup</span>`;
        }

        const displayName = user.name || user.slack_real_name || user.slack_display_name || 'Unknown';
        const displayEmail = user.email || user.slack_email || '';
        const displayOrg = user.org_name || '';

        // Make name clickable if user has context (reuse contextUserId/contextType from above)
        const nameHtml = contextUserId
          ? `<a href="#" class="user-name-link" onclick="showUserContext('${escapeJs(contextUserId)}', '${contextType}', '${escapeJs(displayName)}', event); return false;">${escapeHtml(displayName)}</a>`
          : escapeHtml(displayName);

        return `
          <tr>
            <td>
              <div class="user-name">${nameHtml} ${sourceIcon} ${aaoIcon}</div>
              <div class="user-email">${escapeHtml(displayEmail)}</div>
            </td>
            <td>
              ${user.org_id && displayOrg
                ? `<a href="/admin/organizations/${encodeURIComponent(user.org_id)}" class="user-org">${escapeHtml(displayOrg)}</a>`
                : '<span class="user-org"><em style="color: var(--color-text-muted);">No org</em></span>'}
            </td>
            <td>
              ${engagementHtml}
            </td>
            <td>
              ${goalHtml}
            </td>
            <td class="action-cell">
              ${actions}
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderEngagementScore(score) {
      if (score === null || score === undefined) {
        return '<span class="score-na">‚Äî</span>';
      }
      const level = score >= 50 ? 'high' : (score >= 20 ? 'medium' : 'low');
      return `<span class="score-bar"><span class="score-fill ${level}" style="width: ${Math.min(score, 100)}%"></span></span><span class="score-value">${score}</span>`;
    }

    function formatGoalKey(key) {
      if (!key) return '';
      return key.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    }

    function updateStats(stats) {
      if (stats) {
        document.getElementById('totalUsers').textContent = stats.total || 0;
        document.getElementById('mappedUsers').textContent = stats.mapped || 0;
        document.getElementById('suggestedUsers').textContent = stats.suggested || 0;
        document.getElementById('aaoOnlyUsers').textContent = stats.aao_only || 0;
        document.getElementById('slackOnlyUsers').textContent = stats.slack_only || 0;
      } else {
        // Fallback for non-unified endpoint (Slack not configured)
        document.getElementById('totalUsers').textContent = allUsers.length;
        document.getElementById('mappedUsers').textContent = '0';
        document.getElementById('suggestedUsers').textContent = '0';
        document.getElementById('aaoOnlyUsers').textContent = allUsers.length;
        document.getElementById('slackOnlyUsers').textContent = '0';
      }

      // Update active stat card
      document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
      if (currentStatusFilter) {
        const activeCard = document.getElementById('stat-' + currentStatusFilter.replace('_', '-').replace('suggested-match', 'suggested').replace('slack-only', 'slack').replace('aao-only', 'aao'));
        if (activeCard) activeCard.classList.add('active');
      } else {
        document.getElementById('stat-all').classList.add('active');
      }
    }

    function filterByStatus(status) {
      currentStatusFilter = status;
      document.getElementById('statusFilter').value = status === 'slack_only' ? 'slack_only' : status;
      loadUsers();
    }

    async function linkUser(slackUserId, workosUserId, event) {
      // Find and disable the button
      const btn = event?.target;
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Linking...';
      }

      try {
        const response = await fetch(`/api/admin/slack/users/${slackUserId}/link`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ workos_user_id: workosUserId })
        });
        if (response.ok) {
          // Update the row immediately to show success
          if (btn) {
            btn.textContent = 'Linked!';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
          }
          // Give a brief moment for visual feedback then reload
          setTimeout(() => loadUsers(), 300);
        } else {
          const errorData = await response.json().catch(() => ({}));
          alert(errorData.message || 'Failed to link user');
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'Link';
          }
        }
      } catch (error) {
        console.error('Error linking user:', error);
        alert('Error linking user');
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Link';
        }
      }
    }

    async function unlinkUser(slackUserId) {
      if (!confirm('Are you sure you want to unlink this user?')) return;

      try {
        const response = await fetch(`/api/admin/slack/users/${slackUserId}/unlink`, {
          method: 'POST'
        });
        if (response.ok) {
          await loadUsers();
        } else {
          alert('Failed to unlink user');
        }
      } catch (error) {
        console.error('Error unlinking user:', error);
        alert('Error unlinking user');
      }
    }

    function debounceSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(loadUsers, 300);
    }

    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('statusFilter').value = '';
      document.getElementById('goalFilter').value = '';
      document.getElementById('groupFilter').value = '';
      currentStatusFilter = '';
      loadUsers();
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Escape for use in JavaScript string literals within onclick attributes
    function escapeJs(text) {
      if (!text) return '';
      return String(text)
        .replace(/\\/g, '\\\\')
        .replace(/'/g, "\\'")
        .replace(/"/g, '\\"')
        .replace(/\n/g, '\\n')
        .replace(/\r/g, '\\r');
    }

    function formatInsightLabel(typeName) {
      const labels = {
        'plans_2026': '2026 Plans',
        'membership_goals': 'Membership Goals',
        'challenges': 'Challenges',
        'feedback': 'Feedback',
        'satisfaction': 'Satisfaction',
        'use_case': 'Use Cases',
        'timeline': 'Timeline',
        'decision_role': 'Decision Role',
        'competitors': 'Competitors',
        'intro_interest': 'Intro Interest'
      };
      return labels[typeName] || typeName.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    // =========================================================================
    // Outreach Functions
    // =========================================================================

    async function previewOutreach(slackUserId) {
      const previewDiv = document.getElementById(`outreachPreview-${slackUserId}`);
      if (!previewDiv) return;

      previewDiv.innerHTML = '<div style="padding: var(--space-3); color: var(--color-text-tertiary);">Loading preview...</div>';
      previewDiv.style.display = 'block';

      try {
        const response = await fetch(`/api/admin/outreach/preview/${slackUserId}`);
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to load preview');
        }

        const data = await response.json();

        let html = '<div style="background: var(--color-gray-50); border-radius: var(--radius-md); padding: var(--space-3);">';

        // Mode warning
        if (data.mode === 'disabled') {
          html += '<div style="background: var(--color-warning-100); color: var(--color-warning-700); padding: var(--space-2); border-radius: var(--radius-sm); margin-bottom: var(--space-3); font-size: var(--text-xs);">‚ö†Ô∏è Outreach is currently disabled (OUTREACH_MODE=disabled)</div>';
        } else if (data.mode === 'dry_run') {
          html += '<div style="background: var(--color-info-100); color: var(--color-info-700); padding: var(--space-2); border-radius: var(--radius-sm); margin-bottom: var(--space-3); font-size: var(--text-xs);">‚ÑπÔ∏è Dry run mode - messages will be logged but not sent</div>';
        } else if (data.mode === 'test') {
          html += '<div style="background: var(--color-info-100); color: var(--color-info-700); padding: var(--space-2); border-radius: var(--radius-sm); margin-bottom: var(--space-3); font-size: var(--text-xs);">‚ÑπÔ∏è Test mode - only test accounts will receive messages</div>';
        }

        // Eligibility
        if (!data.eligibility.canContact) {
          html += `<div style="background: var(--color-error-100); color: var(--color-error-700); padding: var(--space-2); border-radius: var(--radius-sm); margin-bottom: var(--space-3); font-size: var(--text-xs);">‚ùå Cannot contact: ${escapeHtml(data.eligibility.reason)}</div>`;
        }

        // Outreach type and goal
        html += `<div style="margin-bottom: var(--space-2); font-size: var(--text-xs);">
          <strong>Type:</strong> ${escapeHtml(data.outreach_type)}
          ${data.variant ? ` ¬∑ <strong>Variant:</strong> ${escapeHtml(data.variant.name)} (${escapeHtml(data.variant.tone)})` : ''}
        </div>`;

        if (data.addie_goal?.goal_name) {
          html += `<div style="margin-bottom: var(--space-2); font-size: var(--text-xs);">
            <strong>Addie's Goal:</strong> ${escapeHtml(data.addie_goal.goal_name)}
          </div>`;
        }

        // Preview message
        html += `<div style="margin-top: var(--space-2);">
          <div style="font-size: var(--text-xs); color: var(--color-text-tertiary); margin-bottom: var(--space-1);">Message Preview:</div>
          <div style="background: white; border: 1px solid var(--color-gray-200); border-radius: var(--radius-sm); padding: var(--space-3); font-size: var(--text-sm); white-space: pre-wrap;">${escapeHtml(data.preview_message)}</div>
        </div>`;

        html += '</div>';
        previewDiv.innerHTML = html;

      } catch (error) {
        previewDiv.innerHTML = `<div style="padding: var(--space-3); color: var(--color-error-600);">Error: ${escapeHtml(error.message)}</div>`;
      }
    }

    async function sendOutreach(slackUserId) {
      const btn = document.getElementById(`sendOutreachBtn-${slackUserId}`);
      if (!btn) return;

      if (!confirm('Send outreach to this user? This will DM them via Slack.')) {
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Sending...';

      try {
        const response = await fetch(`/api/admin/outreach/send/${slackUserId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to send outreach');
        }

        const data = await response.json();

        if (data.success) {
          btn.textContent = '‚úì Sent!';
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-success');

          // Refresh context to show updated outreach info
          setTimeout(() => {
            const userId = currentContextUser?.workos_user_id || currentContextUser?.slack_user_id;
            if (userId) viewContext(userId);
          }, 1500);
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (error) {
        alert('Failed to send outreach: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Send Outreach';
      }
    }

    let currentContextUser = null;

    // =========================================================================
    // Context Modal Functions
    // =========================================================================

    async function showUserContext(userId, type, userName, event) {
      if (event) event.stopPropagation();

      const modal = document.getElementById('contextModal');
      const modalTitle = document.getElementById('contextModalTitle');
      const modalBody = document.getElementById('contextModalBody');

      modalTitle.textContent = `Context: ${userName}`;
      modalBody.innerHTML = '<div style="text-align: center; padding: var(--space-8);"><p>Loading context...</p></div>';
      modal.classList.remove('hidden');

      try {
        const response = await fetch(`/api/admin/users/${userId}/context?type=${type}`);
        if (!response.ok) {
          throw new Error('Failed to fetch context');
        }
        const context = await response.json();

        // Store current user for outreach refresh
        currentContextUser = context;

        modalBody.innerHTML = renderContext(context, userId);
      } catch (error) {
        console.error('Error fetching context:', error);
        modalBody.innerHTML = `
          <div style="text-align: center; padding: var(--space-8); color: var(--color-error-600);">
            <p>Failed to load context.</p>
            <button class="btn btn-secondary btn-small" onclick="showUserContext('${escapeJs(userId)}', '${type}', '${escapeJs(userName)}')">Retry</button>
          </div>
        `;
      }
    }

    // Refresh context for current user (used after sending outreach)
    async function viewContext(userId) {
      if (!currentContextUser) return;
      const type = currentContextUser.workos_user?.workos_user_id ? 'workos' : 'slack';
      const name = currentContextUser.workos_user?.email ||
                   currentContextUser.slack_user?.display_name ||
                   currentContextUser.slack_user?.real_name ||
                   'User';
      await showUserContext(userId, type, name);
    }

    function closeContextModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('contextModal').classList.add('hidden');
    }

    // Wrapper to show context modal with automatic type detection
    // Called after adding insights or sending outreach
    function showContextModal(userId, userName) {
      // Find user in allUsers to determine the appropriate type
      const user = allUsers.find(u =>
        u.id === userId ||
        u.workos_user_id === userId ||
        u.slack_user_id === userId
      );

      if (user) {
        const contextUserId = user.workos_user_id || user.slack_user_id;
        if (!contextUserId) {
          // User found but has no identifiers - use original userId
          showUserContext(userId, 'slack', userName);
          return;
        }
        const contextType = user.workos_user_id ? 'workos' : 'slack';
        showUserContext(contextUserId, contextType, userName);
      } else {
        // Fallback: assume slack type if we can't find the user
        showUserContext(userId, 'slack', userName);
      }
    }

    async function loadAddieHomePreview(workosUserId, slackUserId) {
      const container = document.getElementById('addieHomePreviewContainer');
      const loading = document.getElementById('addieHomePreviewLoading');
      const error = document.getElementById('addieHomePreviewError');
      const content = document.getElementById('addieHomePreviewContent');
      const placeholder = document.getElementById('addieHomePreviewPlaceholder');

      // Show container, hide placeholder
      container.style.display = 'block';
      placeholder.style.display = 'none';
      loading.style.display = 'block';
      error.style.display = 'none';
      content.innerHTML = '';

      try {
        // Build query params - prefer Slack ID for Slack-based home, otherwise use WorkOS
        const params = new URLSearchParams({ format: 'html' });
        if (slackUserId) {
          params.append('slack_user_id', slackUserId);
        } else if (workosUserId) {
          params.append('user_id', workosUserId);
        }

        const response = await fetch(`/api/admin/addie/home/preview?${params.toString()}`);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || data.message || 'Failed to load home preview');
        }

        loading.style.display = 'none';

        // Inject CSS
        const styleEl = document.createElement('style');
        styleEl.textContent = data.css;
        content.innerHTML = '';
        content.appendChild(styleEl);

        // Inject HTML
        const contentDiv = document.createElement('div');
        contentDiv.innerHTML = data.html;
        content.appendChild(contentDiv);

      } catch (err) {
        console.error('Error loading Addie Home preview:', err);
        loading.style.display = 'none';
        error.style.display = 'block';
        error.textContent = err.message || 'Failed to load Addie Home preview';
      }
    }

    function renderContext(context, userId) {
      let html = '';

      // Planner Recommendation Section - Most important, show first
      if (context.planner?.recommended_action) {
        const action = context.planner.recommended_action;
        const slackUserId = context.slack_user?.slack_user_id;
        html += '<div class="context-section" style="background: linear-gradient(135deg, var(--color-primary-50), var(--color-gray-50)); border-left: 4px solid var(--color-brand); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">';
        html += '<h3 style="margin-bottom: var(--space-2);">Planner Recommendation</h3>';
        html += `<div style="font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--color-text-heading); margin-bottom: var(--space-2);">${escapeHtml(action.goal_name)}</div>`;
        html += `<div style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: var(--space-2);">${escapeHtml(action.reason)}</div>`;
        html += `<div style="font-size: var(--text-xs); color: var(--color-text-muted); display: flex; gap: var(--space-3); margin-bottom: var(--space-3);">
          <span>Priority: ${action.priority_score}</span>
          <span>Category: ${escapeHtml(action.category)}</span>
          <span>Method: ${escapeHtml(action.decision_method)}</span>
        </div>`;

        // Show message preview
        if (context.planner.message_preview) {
          html += '<div style="margin-top: var(--space-3); border-top: 1px solid var(--color-gray-200); padding-top: var(--space-3);">';
          html += '<div style="font-size: var(--text-xs); color: var(--color-text-muted); margin-bottom: var(--space-2);">Message Preview:</div>';
          html += `<div style="background: white; border: 1px solid var(--color-gray-200); border-radius: var(--radius-sm); padding: var(--space-3); font-size: var(--text-sm); white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${escapeHtml(context.planner.message_preview)}</div>`;

          // Send button and different approach link
          if (slackUserId && !context.outreach?.opted_out) {
            html += `<div style="margin-top: var(--space-3); display: flex; gap: var(--space-2); align-items: center; flex-wrap: wrap;">
              <button onclick="sendOutreach('${slackUserId}')" class="btn btn-primary btn-small" id="sendOutreachBtn-${slackUserId}">Send This Message</button>
              <span style="font-size: var(--text-xs); color: var(--color-text-muted);">via Slack DM</span>
              <a href="#" onclick="openNudgeModal('${slackUserId}', ${action.goal_id}); return false;" style="font-size: var(--text-xs); color: var(--color-brand); margin-left: auto;">Different approach?</a>
            </div>`;
          }
          html += '</div>';
        }

        if (context.planner.alternative_goals && context.planner.alternative_goals.length > 0) {
          html += '<div style="margin-top: var(--space-3); padding-top: var(--space-2); border-top: 1px solid var(--color-gray-200);">';
          html += '<div style="font-size: var(--text-xs); color: var(--color-text-muted); margin-bottom: var(--space-2);">Alternative goals (click to use instead):</div>';
          html += '<div style="display: flex; flex-wrap: wrap; gap: var(--space-1);">';
          html += context.planner.alternative_goals.map(g =>
            `<button onclick="openNudgeModal('${slackUserId}', ${g.id})" style="display: inline-block; padding: 4px var(--space-2); background: var(--color-gray-100); border: 1px solid var(--color-gray-200); border-radius: var(--radius-sm); font-size: var(--text-xs); cursor: pointer; transition: all 0.15s;" onmouseover="this.style.background='var(--color-primary-50)';this.style.borderColor='var(--color-brand)'" onmouseout="this.style.background='var(--color-gray-100)';this.style.borderColor='var(--color-gray-200)'">${escapeHtml(g.name)}</button>`
          ).join('');
          html += '</div></div>';
        }
        html += '</div>';
      } else if (context.planner && !context.planner.recommended_action) {
        html += '<div class="context-section" style="background: var(--color-gray-50); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">';
        html += '<h3 style="margin-bottom: var(--space-2);">Planner Status</h3>';
        const eligibility = context.planner.contact_eligibility;
        if (!eligibility?.can_contact) {
          html += `<div style="font-size: var(--text-sm); color: var(--color-warning-600);">Cannot contact: ${escapeHtml(eligibility?.reason || 'Unknown reason')}</div>`;
        } else {
          html += '<div style="font-size: var(--text-sm); color: var(--color-text-muted); font-style: italic;">No action recommended at this time.</div>';
        }
        html += '</div>';
      }

      // Capabilities Section - What has this member done?
      if (context.capabilities) {
        const caps = context.capabilities;
        html += '<div class="context-section">';
        html += '<h3>Capabilities</h3>';
        html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-2);">';

        // Account setup capabilities
        html += renderCapabilityItem('Account Linked', caps.account_linked);
        html += renderCapabilityItem('Profile Complete', caps.profile_complete);
        html += renderCapabilityItem('Offerings Set', caps.offerings_set);
        html += renderCapabilityItem('Email Prefs', caps.email_prefs_configured);

        // Team
        html += renderCapabilityItem('Has Team', caps.has_team_members);
        html += renderCapabilityItem('Org Admin', caps.is_org_admin);

        // Participation
        html += renderCapabilityCount('Working Groups', caps.working_group_count);
        html += renderCapabilityCount('Councils', caps.council_count);
        html += renderCapabilityCount('Events Registered', caps.events_registered);
        html += renderCapabilityCount('Events Attended', caps.events_attended);

        // Activity
        html += `<div style="padding: var(--space-2); background: var(--color-gray-50); border-radius: var(--radius-sm);">
          <span style="font-size: var(--text-xs); color: var(--color-text-muted);">Slack (30d)</span>
          <span style="font-weight: var(--font-medium); color: ${caps.slack_message_count_30d > 0 ? 'var(--color-success-600)' : 'var(--color-text-muted)'}; float: right;">${caps.slack_message_count_30d}</span>
        </div>`;
        html += `<div style="padding: var(--space-2); background: var(--color-gray-50); border-radius: var(--radius-sm);">
          <span style="font-size: var(--text-xs); color: var(--color-text-muted);">Last Active</span>
          <span style="font-weight: var(--font-medium); color: ${caps.last_active_days_ago !== null && caps.last_active_days_ago < 30 ? 'var(--color-success-600)' : 'var(--color-text-muted)'}; float: right;">${caps.last_active_days_ago !== null ? caps.last_active_days_ago + 'd ago' : 'Never'}</span>
        </div>`;

        html += '</div></div>';
      }

      // Identity & Status Section - Compact overview
      html += '<div class="context-section">';
      html += '<h3>Identity</h3>';
      html += '<div class="context-grid">';

      if (context.workos_user) {
        html += renderContextItem('Email', context.workos_user.email);
        const name = `${context.workos_user.first_name || ''} ${context.workos_user.last_name || ''}`.trim();
        if (name) html += renderContextItem('Name', name);
      }

      if (context.slack_user && !context.workos_user) {
        html += renderContextItem('Email', context.slack_user.email || 'Not set');
        html += renderContextItem('Slack Name', context.slack_user.display_name || context.slack_user.real_name || 'Not set');
      }

      // Show account status badges
      const statusItems = [];
      if (context.is_member) statusItems.push('<span class="context-badge" style="background: var(--color-success-100); color: var(--color-success-700);">Member</span>');
      if (context.slack_linked) statusItems.push('<span class="context-badge" style="background: #4A154B20; color: #4A154B;">Slack</span>');
      if (!context.slack_linked && context.slack_user) statusItems.push('<span class="context-badge" style="background: var(--color-warning-100); color: var(--color-warning-700);">Slack Unlinked</span>');

      if (statusItems.length > 0) {
        html += `<div class="context-item" style="grid-column: 1 / -1;">
          <div class="context-item-label">Status</div>
          <div class="context-badges">${statusItems.join(' ')}</div>
        </div>`;
      }

      html += '</div></div>';

      // Organization & Subscription Section - Combined
      if (context.organization || context.subscription) {
        html += '<div class="context-section">';
        html += '<h3>Organization</h3>';
        html += '<div class="context-grid">';
        if (context.organization) {
          html += renderContextItem('Company', context.organization.name);
          const subStatus = context.organization.subscription_status || 'None';
          html += renderContextItem('Subscription', subStatus, subStatus === 'active' ? 'success' : 'warning');
        }
        if (context.subscription?.product_name) {
          html += renderContextItem('Plan', context.subscription.product_name);
        }
        if (context.org_membership) {
          html += renderContextItem('Role', context.org_membership.role);
          if (context.org_membership.joined_at) {
            html += renderContextItem('Joined', new Date(context.org_membership.joined_at).toLocaleDateString());
          }
        }
        html += '</div></div>';
      }

      // Member Profile Section
      if (context.member_profile) {
        html += '<div class="context-section">';
        html += '<h3>Member Profile</h3>';
        html += '<div class="context-grid">';
        if (context.member_profile.tagline) {
          html += renderContextItem('Tagline', context.member_profile.tagline);
        }
        if (context.member_profile.headquarters) {
          html += renderContextItem('Location', context.member_profile.headquarters);
        }
        if (context.member_profile.offerings && context.member_profile.offerings.length > 0) {
          html += `<div class="context-item" style="grid-column: 1 / -1;">
            <div class="context-item-label">Offerings</div>
            <div class="context-badges">${context.member_profile.offerings.map(o => `<span class="context-badge">${escapeHtml(o)}</span>`).join('')}</div>
          </div>`;
        }
        html += '</div></div>';
      }

      // Engagement Section - Combined dashboard + slack activity
      html += '<div class="context-section">';
      html += '<h3>Activity</h3>';
      html += '<div class="context-grid">';

      if (context.engagement) {
        html += renderContextItem('Dashboard Logins (30d)', context.engagement.login_count_30d.toString());
        if (context.engagement.last_login) {
          html += renderContextItem('Last Login', new Date(context.engagement.last_login).toLocaleDateString());
        }
        html += renderContextItem('Email Clicks (30d)', context.engagement.email_click_count_30d.toString());
      }

      if (context.slack_activity) {
        html += renderContextItem('Slack Messages (30d)', context.slack_activity.total_messages_30d.toString());
        html += renderContextItem('Reactions Given', context.slack_activity.total_reactions_30d.toString());
        if (context.slack_activity.last_activity_at) {
          html += renderContextItem('Last Slack Activity', new Date(context.slack_activity.last_activity_at).toLocaleDateString());
        }
      }

      html += '</div></div>';

      // Working Groups Section
      if (context.working_groups && context.working_groups.length > 0) {
        html += '<div class="context-section">';
        html += '<h3>Working Groups</h3>';
        html += '<div class="context-badges">';
        context.working_groups.forEach(wg => {
          html += `<span class="context-badge ${wg.is_leader ? 'leader' : ''}">${escapeHtml(wg.name)}${wg.is_leader ? ' (Leader)' : ''}</span>`;
        });
        html += '</div></div>';
      }

      // Insights Section - From collected member insights
      // Strategic insights are highlighted at top, others shown below
      const slackUserIdForInsight = context.slack_user?.slack_user_id;
      if (context.insights && context.insights.length > 0) {
        const strategicTypes = ['plans_2026', 'membership_goals', 'challenges', 'feedback', 'satisfaction', 'use_case', 'admin_context'];
        const strategicInsights = context.insights.filter(i => strategicTypes.includes(i.type_name));
        const otherInsights = context.insights.filter(i => !strategicTypes.includes(i.type_name));

        // Strategic insights get prominent display
        if (strategicInsights.length > 0) {
          html += '<div class="context-section" style="background: linear-gradient(135deg, var(--color-success-50), var(--color-gray-50)); border-left: 4px solid var(--color-success-600); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">';
          html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3);">
            <h3 style="margin: 0;">Strategic Insights</h3>
            ${slackUserIdForInsight ? `<button onclick="openAddInsightModal('${slackUserIdForInsight}')" class="btn btn-small" style="font-size: var(--text-xs);">+ Add Insight</button>` : ''}
          </div>`;
          html += '<div style="display: grid; gap: var(--space-3);">';
          strategicInsights.forEach(insight => {
            const label = formatInsightLabel(insight.type_name);
            html += `<div style="background: white; border-radius: var(--radius-sm); padding: var(--space-3); box-shadow: var(--shadow-xs);">
              <div style="font-weight: var(--font-semibold); font-size: var(--text-xs); color: var(--color-success-700); text-transform: uppercase; margin-bottom: var(--space-1);">${escapeHtml(label)}</div>
              <div style="font-size: var(--text-sm); color: var(--color-text-primary);">${escapeHtml(insight.value)}</div>
            </div>`;
          });
          html += '</div></div>';
        }

        // Other insights shown in a more compact list
        if (otherInsights.length > 0) {
          html += '<div class="context-section">';
          html += '<h3>Other Insights</h3>';
          html += '<div style="max-height: 150px; overflow-y: auto;">';
          otherInsights.forEach(insight => {
            html += `<div style="background: var(--color-gray-50); border-radius: var(--radius-sm); padding: var(--space-2) var(--space-3); margin-bottom: var(--space-2);">
              <div style="font-weight: var(--font-medium); font-size: var(--text-xs); color: var(--color-text-heading);">${escapeHtml(insight.type_name || 'Insight')}</div>
              <div style="font-size: var(--text-sm); color: var(--color-text-primary);">${escapeHtml(insight.value)}</div>
            </div>`;
          });
          html += '</div></div>';
        }
      } else if (slackUserIdForInsight) {
        // No insights yet - show add button
        html += '<div class="context-section" style="background: var(--color-gray-50); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4); text-align: center;">';
        html += '<p style="color: var(--color-text-muted); margin-bottom: var(--space-3);">No insights recorded yet</p>';
        html += `<button onclick="openAddInsightModal('${slackUserIdForInsight}')" class="btn btn-primary btn-small">+ Add First Insight</button>`;
        html += '</div>';
      }

      // Recent Conversations Section (from new threads API)
      if (context.recent_conversations && context.recent_conversations.length > 0) {
        html += '<div class="context-section">';
        html += '<h3>Recent Conversations</h3>';
        html += '<div style="max-height: 200px; overflow-y: auto;">';
        context.recent_conversations.forEach(conv => {
          const date = new Date(conv.last_message_at).toLocaleDateString();
          const channel = conv.channel === 'slack' ? 'üí¨ Slack' : conv.channel === 'web' ? 'üåê Web' : conv.channel;
          const title = conv.title || `${conv.message_count} messages`;
          html += `<a href="/admin/addie?thread=${conv.thread_id}" target="_blank" style="display: block; background: var(--color-gray-50); border-radius: var(--radius-sm); padding: var(--space-2) var(--space-3); margin-bottom: var(--space-2); text-decoration: none; color: inherit;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: var(--text-sm); color: var(--color-text-primary);">${escapeHtml(title)}</span>
              <span style="font-size: var(--text-xs); color: var(--color-text-tertiary);">${channel}</span>
            </div>
            <div style="font-size: var(--text-xs); color: var(--color-text-tertiary);">${date} ¬∑ ${conv.message_count} messages</div>
          </a>`;
        });
        html += '</div></div>';
      } else if (context.addie_history) {
        // Fallback to old format if available
        html += '<div class="context-section">';
        html += '<h3>Conversation History</h3>';
        html += '<div class="context-grid">';
        html += renderContextItem('Total Conversations', context.addie_history.total_interactions.toString());
        if (context.addie_history.last_interaction_at) {
          html += renderContextItem('Last Conversation', new Date(context.addie_history.last_interaction_at).toLocaleDateString());
        }
        html += '</div>';
        if (context.addie_history.recent_topics && context.addie_history.recent_topics.length > 0) {
          html += '<div style="margin-top: var(--space-3);">';
          html += '<div class="context-item-label" style="margin-bottom: var(--space-2);">Recent Topics</div>';
          html += '<ul class="context-list">';
          context.addie_history.recent_topics.slice(0, 3).forEach(topic => {
            const truncatedTopic = topic.length > 100 ? topic.substring(0, 100) + '...' : topic;
            html += `<li>"${escapeHtml(truncatedTopic)}"</li>`;
          });
          html += '</ul></div>';
        }
        html += '</div>';
      }

      // Outreach History Section (for Slack users)
      if (context.outreach) {
        html += '<div class="context-section">';
        html += '<h3>Outreach History</h3>';
        html += '<div class="context-grid">';

        if (context.outreach.last_outreach_at) {
          const lastDate = new Date(context.outreach.last_outreach_at).toLocaleDateString();
          const daysAgo = context.outreach.days_since_outreach;
          html += renderContextItem('Last Outreach', `${lastDate} (${daysAgo} days ago)`);
        } else {
          html += renderContextItem('Last Outreach', 'Never contacted');
        }
        html += renderContextItem('Total Outreaches', context.outreach.total_outreach_count.toString());
        html += renderContextItem('Responses', context.outreach.responses_received.toString());
        if (context.outreach.opted_out) {
          html += `<div class="context-item" style="grid-column: 1 / -1;">
            <span class="context-badge" style="background: var(--color-error-100); color: var(--color-error-700);">Opted Out</span>
          </div>`;
        }
        html += '</div>';

        // Detailed outreach history with conversation threads
        if (context.outreach_history && context.outreach_history.length > 0) {
          html += '<div style="margin-top: var(--space-3); max-height: 250px; overflow-y: auto;">';
          context.outreach_history.forEach(outreach => {
            const date = new Date(outreach.sent_at).toLocaleDateString();
            const goalName = outreach.goal_name || 'General';
            const hasResponse = outreach.user_responded;
            const sentiment = outreach.response_sentiment;
            const intent = outreach.response_intent;

            // Sentiment badge colors
            let sentimentBadge = '';
            if (sentiment) {
              const colors = {
                positive: 'background: var(--color-success-100); color: var(--color-success-700);',
                neutral: 'background: var(--color-gray-100); color: var(--color-gray-700);',
                negative: 'background: var(--color-warning-100); color: var(--color-warning-700);',
                refusal: 'background: var(--color-error-100); color: var(--color-error-700);'
              };
              sentimentBadge = `<span style="font-size: var(--text-xs); padding: 2px 6px; border-radius: var(--radius-sm); ${colors[sentiment] || ''}">${sentiment}</span>`;
            }

            // Thread link if available
            const threadLink = outreach.thread_id
              ? `<a href="/admin/addie?thread=${encodeURIComponent(outreach.thread_id)}" target="_blank" style="color: var(--color-brand); font-size: var(--text-xs);">View Thread (${outreach.thread_message_count || 0} msgs)</a>`
              : '';

            html += `<div style="background: var(--color-gray-50); border-radius: var(--radius-sm); padding: var(--space-2) var(--space-3); margin-bottom: var(--space-2);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-1);">
                <span style="font-weight: var(--font-medium); font-size: var(--text-sm); color: var(--color-text-heading);">${escapeHtml(goalName)}</span>
                <span style="font-size: var(--text-xs); color: var(--color-text-tertiary);">${date}</span>
              </div>
              <div style="font-size: var(--text-xs); color: var(--color-text-muted); margin-bottom: var(--space-1);">
                ${hasResponse ? '‚úì Responded' : '‚óã No response'} ${sentimentBadge}
              </div>
              ${outreach.response_text ? `<div style="font-size: var(--text-xs); color: var(--color-text-secondary); font-style: italic; margin-bottom: var(--space-1);">"${escapeHtml(outreach.response_text.substring(0, 100))}${outreach.response_text.length > 100 ? '...' : ''}"</div>` : ''}
              ${threadLink}
            </div>`;
          });
          html += '</div>';
        }

        html += '</div>';
      }

      // Impersonation Link (if WorkOS user exists)
      if (context.workos_user) {
        html += `
          <a href="https://dashboard.workos.com/impersonation" target="_blank" rel="noopener noreferrer" class="impersonation-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="8.5" cy="7" r="4"/>
              <line x1="20" y1="8" x2="20" y2="14"/>
              <line x1="23" y1="11" x2="17" y2="11"/>
            </svg>
            Impersonate via WorkOS Dashboard
          </a>
        `;
      }

      // Addie Home Preview Section
      const workosUserId = context.workos_user?.workos_user_id;
      const slackUserId = context.slack_user?.slack_user_id;
      if (workosUserId || slackUserId) {
        html += `
          <div class="context-section" style="margin-top: var(--space-4);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3);">
              <h3 style="margin: 0;">Addie Home Preview</h3>
              <button class="btn btn-secondary btn-small" onclick="loadAddieHomePreview('${workosUserId || ''}', '${slackUserId || ''}')">
                Load Preview
              </button>
            </div>
            <div id="addieHomePreviewContainer" style="display: none;">
              <div id="addieHomePreviewLoading" style="text-align: center; padding: var(--space-4); color: var(--color-text-muted);">
                Loading Addie Home...
              </div>
              <div id="addieHomePreviewError" style="display: none; padding: var(--space-3); background: var(--color-error-50); border-radius: var(--radius-md); color: var(--color-error-600);"></div>
              <div id="addieHomePreviewContent" style="border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: var(--space-4); background: var(--color-bg-page);"></div>
            </div>
            <p id="addieHomePreviewPlaceholder" style="color: var(--color-text-muted); font-size: var(--text-sm); margin: 0;">
              Click "Load Preview" to see what this user's Addie Home looks like
            </p>
          </div>
        `;
      }

      return html;
    }

    function renderContextItem(label, value, valueClass = '') {
      return `
        <div class="context-item">
          <div class="context-item-label">${escapeHtml(label)}</div>
          <div class="context-item-value ${valueClass}">${escapeHtml(value)}</div>
        </div>
      `;
    }

    function renderCapabilityItem(label, value) {
      const done = !!value;
      return `<div style="padding: var(--space-2); background: var(--color-gray-50); border-radius: var(--radius-sm);">
        <span style="font-size: var(--text-xs); color: var(--color-text-muted);">${escapeHtml(label)}</span>
        <span style="font-weight: var(--font-medium); color: ${done ? 'var(--color-success-600)' : 'var(--color-error-600)'}; float: right;">${done ? 'Yes' : 'No'}</span>
      </div>`;
    }

    function renderCapabilityCount(label, count) {
      const hasAny = count > 0;
      return `<div style="padding: var(--space-2); background: var(--color-gray-50); border-radius: var(--radius-sm);">
        <span style="font-size: var(--text-xs); color: var(--color-text-muted);">${escapeHtml(label)}</span>
        <span style="font-weight: var(--font-medium); color: ${hasAny ? 'var(--color-success-600)' : 'var(--color-text-muted)'}; float: right;">${count}</span>
      </div>`;
    }

    // =========================================================================
    // Add Insight Modal Functions
    // =========================================================================

    let insightTypes = [];
    let currentInsightSlackUserId = null;

    async function loadInsightTypes() {
      if (insightTypes.length > 0) return; // Already loaded
      try {
        const response = await fetch('/api/admin/insight-types');
        if (response.ok) {
          const types = await response.json();
          insightTypes = types.filter(t => t.is_active);
          populateInsightTypeDropdown();
        }
      } catch (error) {
        console.error('Error loading insight types:', error);
      }
    }

    function populateInsightTypeDropdown() {
      const select = document.getElementById('insightType');
      select.innerHTML = '<option value="">Select type...</option>';

      // Group by strategic vs other
      const strategicTypes = ['plans_2026', 'membership_goals', 'challenges', 'feedback', 'satisfaction', 'use_case', 'admin_context'];
      const strategic = insightTypes.filter(t => strategicTypes.includes(t.name));
      const other = insightTypes.filter(t => !strategicTypes.includes(t.name));

      if (strategic.length > 0) {
        const group = document.createElement('optgroup');
        group.label = 'Strategic Insights';
        strategic.forEach(type => {
          const option = document.createElement('option');
          option.value = type.id;
          option.textContent = type.name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
          if (type.description) option.title = type.description;
          group.appendChild(option);
        });
        select.appendChild(group);
      }

      if (other.length > 0) {
        const group = document.createElement('optgroup');
        group.label = 'Other Insights';
        other.forEach(type => {
          const option = document.createElement('option');
          option.value = type.id;
          option.textContent = type.name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
          if (type.description) option.title = type.description;
          group.appendChild(option);
        });
        select.appendChild(group);
      }
    }

    async function openAddInsightModal(slackUserId) {
      currentInsightSlackUserId = slackUserId;
      document.getElementById('insightSlackUserId').value = slackUserId;
      document.getElementById('insightValue').value = '';
      document.getElementById('insightConfidence').value = 'medium';

      await loadInsightTypes();
      document.getElementById('addInsightModal').classList.remove('hidden');
      document.getElementById('insightType').focus();
    }

    function closeAddInsightModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('addInsightModal').classList.add('hidden');
      currentInsightSlackUserId = null;
    }

    async function submitInsight(event) {
      event.preventDefault();

      const slackUserId = document.getElementById('insightSlackUserId').value;
      const typeId = document.getElementById('insightType').value;
      const value = document.getElementById('insightValue').value.trim();
      const confidence = document.getElementById('insightConfidence').value;

      if (!slackUserId || !typeId || !value) {
        alert('Please fill in all required fields');
        return;
      }

      const btn = document.getElementById('submitInsightBtn');
      const originalText = btn.textContent;
      btn.textContent = 'Adding...';
      btn.disabled = true;

      try {
        const response = await fetch('/api/admin/insights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            slack_user_id: slackUserId,
            insight_type_id: parseInt(typeId),
            value: value,
            confidence: confidence,
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to add insight');
        }

        closeAddInsightModal();

        // Refresh the context modal to show the new insight
        const user = allUsers.find(u => u.slack_user_id === slackUserId);
        if (user) {
          showContextModal(user.id || slackUserId, user.display_name || user.email || 'User');
        }
      } catch (error) {
        alert('Error adding insight: ' + error.message);
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    // =========================================================================
    // NUDGE/OVERRIDE MODAL FUNCTIONS
    // =========================================================================

    let currentNudgeSlackUserId = null;
    let currentNudgeGoalId = null;
    let currentNudgeGoal = null;

    async function openNudgeModal(slackUserId, goalId) {
      currentNudgeSlackUserId = slackUserId;
      currentNudgeGoalId = goalId;

      // Set hidden fields
      document.getElementById('nudgeSlackUserId').value = slackUserId;
      document.getElementById('nudgeGoalId').value = goalId;

      // Reset form
      document.getElementById('nudgeContext').value = '';
      document.getElementById('nudgeGoalName').textContent = 'Loading...';
      document.getElementById('nudgeGoalDescription').textContent = '';
      document.getElementById('nudgeMessagePreview').style.display = 'none';

      // Show modal
      document.getElementById('nudgeModal').classList.remove('hidden');

      // Fetch goal details
      try {
        const response = await fetch(`/api/admin/outbound/goals/${goalId}`);
        if (!response.ok) throw new Error('Failed to load goal');

        currentNudgeGoal = await response.json();
        document.getElementById('nudgeGoalName').textContent = currentNudgeGoal.name;
        document.getElementById('nudgeGoalDescription').textContent = currentNudgeGoal.description || '';

        // Build and show message preview
        const user = allUsers.find(u => u.slack_user_id === slackUserId);
        const displayName = user?.display_name || user?.slack_real_name || 'there';
        const companyName = user?.company_name || 'your company';

        // Simple template substitution for preview
        let messagePreview = currentNudgeGoal.message_template || '';
        messagePreview = messagePreview.replace(/\{\{user_name\}\}/g, displayName);
        messagePreview = messagePreview.replace(/\{\{company_name\}\}/g, companyName);

        document.getElementById('nudgeMessageText').textContent = messagePreview;
        document.getElementById('nudgeMessagePreview').style.display = 'block';

        // Show "Just Save Context" button if context field has focus
        // Remove existing listener first to prevent accumulation on repeated modal opens
        const nudgeContextEl = document.getElementById('nudgeContext');
        nudgeContextEl.removeEventListener('input', toggleSaveContextButton);
        nudgeContextEl.addEventListener('input', toggleSaveContextButton);
      } catch (error) {
        console.error('Error loading goal:', error);
        document.getElementById('nudgeGoalName').textContent = 'Goal #' + goalId;
        document.getElementById('nudgeGoalDescription').textContent = 'Could not load goal details';
      }
    }

    function toggleSaveContextButton() {
      const hasContext = document.getElementById('nudgeContext').value.trim().length > 0;
      document.getElementById('saveNudgeBtn').style.display = hasContext ? 'inline-flex' : 'none';
    }

    function closeNudgeModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('nudgeModal').classList.add('hidden');
      currentNudgeSlackUserId = null;
      currentNudgeGoalId = null;
      currentNudgeGoal = null;
    }

    async function sendNudgeOutreach() {
      if (!currentNudgeSlackUserId || !currentNudgeGoalId) {
        alert('Missing user or goal information');
        return;
      }

      const adminContext = document.getElementById('nudgeContext').value.trim();

      if (!confirm(`Send outreach to this user using the "${currentNudgeGoal?.name || 'selected'}" goal? This will DM them via Slack.`)) {
        return;
      }

      const btn = document.getElementById('sendNudgeBtn');
      const originalText = btn.textContent;
      btn.textContent = 'Sending...';
      btn.disabled = true;

      try {
        const response = await fetch('/api/admin/outreach/send-with-goal', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            slack_user_id: currentNudgeSlackUserId,
            goal_id: currentNudgeGoalId,
            admin_context: adminContext || undefined,
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to send outreach');
        }

        const data = await response.json();

        if (data.success) {
          btn.textContent = 'Sent!';
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-success');

          // Close modal and refresh context after a moment
          setTimeout(() => {
            closeNudgeModal();
            // Refresh context modal
            const user = allUsers.find(u => u.slack_user_id === currentNudgeSlackUserId);
            if (user) {
              showContextModal(user.id || currentNudgeSlackUserId, user.display_name || user.email || 'User');
            }
          }, 1000);
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (error) {
        alert('Error sending outreach: ' + error.message);
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    async function saveNudgeAsInsight() {
      const adminContext = document.getElementById('nudgeContext').value.trim();

      if (!adminContext) {
        alert('Please enter some context to save');
        return;
      }

      if (!currentNudgeSlackUserId) {
        alert('Missing user information');
        return;
      }

      const btn = document.getElementById('saveNudgeBtn');
      const originalText = btn.textContent;
      btn.textContent = 'Saving...';
      btn.disabled = true;

      try {
        // First get the admin_context insight type
        const typesResponse = await fetch('/api/admin/insight-types');
        if (!typesResponse.ok) throw new Error('Failed to load insight types');

        const types = await typesResponse.json();
        const adminContextType = types.find(t => t.name === 'admin_context');

        if (!adminContextType) {
          throw new Error('admin_context insight type not found');
        }

        // Save the insight
        const response = await fetch('/api/admin/insights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            slack_user_id: currentNudgeSlackUserId,
            insight_type_id: adminContextType.id,
            value: adminContext,
            confidence: 'high',
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to save insight');
        }

        btn.textContent = 'Saved!';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-success');

        // Close modal and refresh context after a moment
        setTimeout(() => {
          closeNudgeModal();
          // Refresh context modal
          const user = allUsers.find(u => u.slack_user_id === currentNudgeSlackUserId);
          if (user) {
            showContextModal(user.id || currentNudgeSlackUserId, user.display_name || user.email || 'User');
          }
        }, 1000);
      } catch (error) {
        alert('Error saving insight: ' + error.message);
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeContextModal();
        closeAddInsightModal();
        closeNudgeModal();
      }
    });

    // Add spinning animation for sync button
    const style = document.createElement('style');
    style.textContent = `
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      .spin { animation: spin 1s linear infinite; }
    `;
    document.head.appendChild(style);

    // Initialize
    init();
  </script>
</body>
</html>
