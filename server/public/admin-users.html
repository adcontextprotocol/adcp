<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Admin - Users - AdCP Registry</title>
  <script src="/admin-nav.js"></script>
  <link rel="stylesheet" href="/design-system.css">
  <style>
    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-xl);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }
    h1 { margin-bottom: var(--space-2.5); color: var(--color-text-heading); }
    .subtitle {
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
    }
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-5);
      flex-wrap: wrap;
      gap: var(--space-4);
    }
    .filter-bar {
      display: flex;
      gap: var(--space-2.5);
      margin-bottom: var(--space-5);
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-bar input,
    .filter-bar select {
      padding: var(--space-2) var(--space-3);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }
    .filter-bar input {
      min-width: 200px;
    }
    .btn {
      padding: var(--space-2) var(--space-4);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
    }
    .btn-small { padding: var(--space-1.5) var(--space-3); font-size: var(--text-xs); }
    .btn-primary { background: var(--color-brand); color: white; }
    .btn-primary:hover { background: var(--color-primary-700); }
    .btn-secondary { background: var(--color-gray-200); color: var(--color-text-heading); }
    .btn-secondary:hover { background: var(--color-gray-300); }
    .btn-outline {
      background: transparent;
      color: var(--color-brand);
      border: var(--border-1) solid var(--color-brand);
    }
    .btn-outline:hover {
      background: var(--color-primary-50);
    }
    .btn-success { background: var(--color-success-600); color: white; }
    .btn-success:hover { background: var(--color-success-700); }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Stats Cards */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }
    .stat-card {
      background: var(--color-gray-50);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      text-align: center;
    }
    .stat-card.clickable {
      cursor: pointer;
      transition: var(--transition-all);
    }
    .stat-card.clickable:hover {
      background: var(--color-primary-50);
    }
    .stat-card.active {
      background: var(--color-primary-100);
      border: 2px solid var(--color-brand);
    }
    .stat-value {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--color-brand);
    }
    .stat-label {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }

    /* Users Table */
    .users-table {
      width: 100%;
      border-collapse: collapse;
    }
    .users-table th,
    .users-table td {
      padding: var(--space-3);
      text-align: left;
      border-bottom: var(--border-1) solid var(--color-gray-200);
    }
    .users-table th {
      font-weight: var(--font-semibold);
      color: var(--color-text-heading);
      background: var(--color-gray-50);
      font-size: var(--text-sm);
    }
    .users-table tr:hover {
      background: var(--color-gray-50);
    }
    .user-name {
      font-weight: var(--font-medium);
      color: var(--color-text-heading);
    }
    .user-email {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }
    .user-org {
      font-size: var(--text-sm);
      color: var(--color-text-muted);
    }
    .group-badges {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
    }
    .group-badge {
      display: inline-block;
      padding: 2px var(--space-2);
      background: var(--color-primary-100);
      color: var(--color-brand);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      text-decoration: none;
      transition: var(--transition-colors);
    }
    .group-badge:hover {
      background: var(--color-primary-200);
    }
    .group-badge.private {
      background: var(--color-warning-100);
      color: var(--color-warning-700);
    }
    .no-groups {
      color: var(--color-text-muted);
      font-size: var(--text-sm);
      font-style: italic;
    }
    .empty-state {
      text-align: center;
      padding: var(--space-10);
      color: var(--color-text-secondary);
    }

    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .status-mapped {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .status-unmapped {
      background: var(--color-gray-100);
      color: var(--color-gray-600);
    }
    .status-suggested {
      background: var(--color-warning-100);
      color: var(--color-warning-700);
    }
    .status-aao-only {
      background: var(--color-info-100);
      color: var(--color-info-700);
    }
    .status-slack-only {
      background: var(--color-primary-100);
      color: var(--color-primary-700);
    }

    /* Source indicator */
    .source-icon {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      font-size: var(--text-xs);
      color: var(--color-text-muted);
    }
    .source-icon svg {
      width: 14px;
      height: 14px;
    }

    /* Actions */
    .action-cell {
      display: flex;
      gap: var(--space-2);
    }

    /* Sync banner */
    .sync-banner {
      background: var(--color-info-50);
      border: 1px solid var(--color-info-200);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-5);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-3);
    }
    .sync-info {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }
    .sync-info strong {
      color: var(--color-text-heading);
    }

    /* Responsive table */
    @media (max-width: 768px) {
      .users-table thead { display: none; }
      .users-table tr {
        display: block;
        margin-bottom: var(--space-4);
        border: var(--border-1) solid var(--color-gray-200);
        border-radius: var(--radius-md);
      }
      .users-table td {
        display: block;
        border: none;
        padding: var(--space-2) var(--space-3);
      }
      .users-table td:first-child {
        padding-top: var(--space-3);
      }
      .users-table td:last-child {
        padding-bottom: var(--space-3);
      }
    }
  </style>
</head>
<body>
  <div id="loading" style="text-align: center; padding: var(--space-12); color: var(--color-text-secondary);">
    Loading...
  </div>

  <div id="content" style="display: none;">
    <div class="container">
      <div class="card">
        <div class="header-bar">
          <div>
            <h1>Users</h1>
            <p class="subtitle">Unified view of AAO members and Slack workspace users</p>
          </div>
          <div style="display: flex; gap: var(--space-2);">
            <button id="syncBtn" class="btn btn-outline" onclick="syncSlackUsers()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 11-9-9"/>
                <polyline points="21 3 21 9 15 9"/>
              </svg>
              Sync Slack
            </button>
            <a href="/api/admin/users/memberships?format=csv" class="btn btn-outline" download>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Export CSV
            </a>
          </div>
        </div>

        <!-- Sync Status Banner -->
        <div id="syncBanner" class="sync-banner" style="display: none;">
          <div class="sync-info">
            <strong id="syncStatus">Slack not synced</strong>
            <span id="lastSyncTime"></span>
          </div>
          <div style="display: flex; gap: var(--space-2);">
            <span id="suggestedCount" style="font-size: var(--text-sm);"></span>
            <button id="autoLinkBtn" class="btn btn-success btn-small" onclick="autoLinkSuggested()" style="display: none;">
              Auto-link matches
            </button>
          </div>
        </div>

        <!-- Stats -->
        <div class="stats-row">
          <div class="stat-card clickable" onclick="filterByStatus('')" id="stat-all">
            <div id="totalUsers" class="stat-value">-</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-card clickable" onclick="filterByStatus('mapped')" id="stat-mapped">
            <div id="mappedUsers" class="stat-value">-</div>
            <div class="stat-label">Both</div>
          </div>
          <div class="stat-card clickable" onclick="filterByStatus('suggested_match')" id="stat-suggested">
            <div id="suggestedUsers" class="stat-value">-</div>
            <div class="stat-label">Can Link</div>
          </div>
          <div class="stat-card clickable" onclick="filterByStatus('aao_only')" id="stat-aao">
            <div id="aaoOnlyUsers" class="stat-value">-</div>
            <div class="stat-label">Website Only</div>
          </div>
          <div class="stat-card clickable" onclick="filterByStatus('slack_only')" id="stat-slack">
            <div id="slackOnlyUsers" class="stat-value">-</div>
            <div class="stat-label">Slack Only</div>
          </div>
        </div>

        <!-- Filters -->
        <div class="filter-bar">
          <input type="text" id="searchInput" placeholder="Search users, orgs, emails..." oninput="debounceSearch()">
          <select id="statusFilter" onchange="loadUsers()">
            <option value="">All Statuses</option>
            <option value="mapped">Mapped</option>
            <option value="suggested_match">Suggested Match</option>
            <option value="aao_only">AAO Only</option>
            <option value="slack_only">Slack Only (Unmapped)</option>
          </select>
          <select id="groupFilter" onchange="loadUsers()">
            <option value="">All Working Groups</option>
          </select>
          <button class="btn btn-secondary btn-small" onclick="clearFilters()">Clear Filters</button>
        </div>

        <!-- Users Table -->
        <div id="usersTableContainer">
          <table class="users-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Organization</th>
                <th>Status</th>
                <th>Working Groups</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- Populated dynamically -->
            </tbody>
          </table>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
          No users found matching your filters.
        </div>
      </div>
    </div>
  </div>

  <script>
    let allUsers = [];
    let allGroups = [];
    let searchTimeout = null;
    let slackConfigured = false;
    let currentStatusFilter = '';

    async function init() {
      try {
        // Load working groups for filter dropdown
        const groupsResponse = await fetch('/api/admin/working-groups');
        if (!groupsResponse.ok) {
          if (groupsResponse.status === 401) {
            window.AdminNav.redirectToLogin();
            return;
          }
          throw new Error('Failed to load working groups');
        }
        allGroups = await groupsResponse.json();
        populateGroupFilter();

        // Check Slack sync status
        await checkSlackStatus();

        // Load users
        await loadUsers();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch (error) {
        console.error('Error initializing:', error);
        document.getElementById('loading').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load users. <a href="/auth/login">Try logging in again</a></p>';
      }
    }

    async function checkSlackStatus() {
      try {
        const response = await fetch('/api/admin/slack/status');
        if (response.ok) {
          const status = await response.json();
          slackConfigured = status.configured;

          const banner = document.getElementById('syncBanner');
          if (slackConfigured) {
            banner.style.display = 'flex';
            if (status.last_sync) {
              const lastSync = new Date(status.last_sync);
              document.getElementById('syncStatus').textContent = 'Slack synced';
              document.getElementById('lastSyncTime').textContent =
                ' - Last sync: ' + lastSync.toLocaleString();
            } else {
              document.getElementById('syncStatus').textContent = 'Slack configured but not synced';
              document.getElementById('lastSyncTime').textContent = '';
            }

            // Check for suggested matches
            await checkSuggestedMatches();
          }
        }
      } catch (error) {
        console.error('Error checking Slack status:', error);
      }
    }

    async function checkSuggestedMatches() {
      try {
        const response = await fetch('/api/admin/slack/auto-link-suggested');
        if (response.ok) {
          const data = await response.json();
          const suggestedCount = data.suggestions?.length || 0;
          if (suggestedCount > 0) {
            document.getElementById('suggestedCount').textContent =
              suggestedCount + ' email matches found';
            document.getElementById('autoLinkBtn').style.display = 'inline-flex';
          }
        }
      } catch (error) {
        console.error('Error checking suggested matches:', error);
      }
    }

    async function syncSlackUsers() {
      const btn = document.getElementById('syncBtn');
      btn.disabled = true;
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin"><path d="M21 12a9 9 0 11-9-9"/></svg> Syncing...';

      try {
        const response = await fetch('/api/admin/slack/sync', { method: 'POST' });
        if (response.ok) {
          const result = await response.json();
          alert(`Synced ${result.total_synced} users (${result.new_users} new, ${result.updated_users} updated, ${result.auto_mapped} auto-mapped)`);
          await checkSlackStatus();
          await loadUsers();
        } else {
          alert('Failed to sync Slack users');
        }
      } catch (error) {
        console.error('Error syncing:', error);
        alert('Error syncing Slack users');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-9-9"/><polyline points="21 3 21 9 15 9"/></svg> Sync Slack';
      }
    }

    async function autoLinkSuggested() {
      const btn = document.getElementById('autoLinkBtn');
      btn.disabled = true;
      btn.textContent = 'Linking...';

      try {
        const response = await fetch('/api/admin/slack/auto-link-suggested', { method: 'POST' });
        if (response.ok) {
          const result = await response.json();
          alert(`Linked ${result.linked} users by email match`);
          document.getElementById('autoLinkBtn').style.display = 'none';
          document.getElementById('suggestedCount').textContent = '';
          await loadUsers();
        } else {
          alert('Failed to auto-link users');
        }
      } catch (error) {
        console.error('Error auto-linking:', error);
        alert('Error auto-linking users');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Auto-link matches';
      }
    }

    function populateGroupFilter() {
      const select = document.getElementById('groupFilter');
      select.innerHTML = '<option value="">All Working Groups</option>';

      allGroups.forEach(g => {
        const option = document.createElement('option');
        option.value = g.id;
        option.textContent = g.name + (g.is_private ? ' (Private)' : '');
        select.appendChild(option);
      });
    }

    async function loadUsers() {
      const search = document.getElementById('searchInput').value.trim();
      const statusFilter = document.getElementById('statusFilter').value;
      const groupFilter = document.getElementById('groupFilter').value;

      // Use unified endpoint if Slack is configured
      const endpoint = slackConfigured ? '/api/admin/slack/unified' : '/api/admin/users';

      const params = new URLSearchParams();
      if (search) params.append('search', search);
      if (statusFilter) params.append('status', statusFilter);
      if (groupFilter) params.append('group', groupFilter);

      try {
        const response = await fetch(`${endpoint}?${params}`);
        if (!response.ok) throw new Error('Failed to load users');

        const data = await response.json();
        allUsers = data.users || [];

        renderUsers();
        updateStats(data.stats);
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    function renderUsers() {
      const tbody = document.getElementById('usersTableBody');
      const emptyState = document.getElementById('emptyState');

      if (allUsers.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';

      tbody.innerHTML = allUsers.map(user => {
        const groupBadges = (user.working_groups?.length > 0)
          ? user.working_groups.map(g =>
              `<a href="/admin/working-groups" class="group-badge ${g.is_private ? 'private' : ''}" title="${escapeHtml(g.name)}">${escapeHtml(g.name)}</a>`
            ).join('')
          : '<span class="no-groups">No groups</span>';

        const statusClass = getStatusClass(user.mapping_status);
        const statusLabel = getStatusLabel(user.mapping_status);

        // Determine source and display appropriately
        const sourceIcon = user.slack_user_id
          ? '<span class="source-icon" title="Has Slack account"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z"/></svg></span>'
          : '';

        const aaoIcon = user.workos_user_id
          ? '<span class="source-icon" title="Has AAO account"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></span>'
          : '';

        // Actions based on status
        let actions = '';
        if (user.mapping_status === 'suggested_match') {
          actions = `<button class="btn btn-success btn-small" onclick="linkUser('${user.slack_user_id}', '${user.workos_user_id}')">Link</button>`;
        } else if (user.mapping_status === 'mapped') {
          actions = `<button class="btn btn-secondary btn-small" onclick="unlinkUser('${user.slack_user_id}')">Unlink</button>`;
        } else if (user.mapping_status === 'slack_only') {
          actions = `<span class="source-icon">Needs AAO signup</span>`;
        }

        const displayName = user.name || user.slack_real_name || user.slack_display_name || 'Unknown';
        const displayEmail = user.email || user.slack_email || '';
        const displayOrg = user.org_name || '';

        return `
          <tr>
            <td>
              <div class="user-name">${escapeHtml(displayName)} ${sourceIcon} ${aaoIcon}</div>
              <div class="user-email">${escapeHtml(displayEmail)}</div>
            </td>
            <td>
              <span class="user-org">${escapeHtml(displayOrg) || '<em style="color: var(--color-text-muted);">No org</em>'}</span>
            </td>
            <td>
              <span class="status-badge ${statusClass}">${statusLabel}</span>
            </td>
            <td>
              <div class="group-badges">${groupBadges}</div>
            </td>
            <td class="action-cell">
              ${actions}
            </td>
          </tr>
        `;
      }).join('');
    }

    function getStatusClass(status) {
      switch (status) {
        case 'mapped': return 'status-mapped';
        case 'suggested_match': return 'status-suggested';
        case 'aao_only': return 'status-aao-only';
        case 'slack_only':
        case 'unmapped': return 'status-slack-only';
        default:
          // If Slack isn't configured, treat as Website Only
          return slackConfigured ? 'status-unmapped' : 'status-aao-only';
      }
    }

    function getStatusLabel(status) {
      switch (status) {
        case 'mapped': return 'Website + Slack';
        case 'suggested_match': return 'Can Link (email match)';
        case 'aao_only': return 'Website Only';
        case 'slack_only':
        case 'unmapped': return 'Slack Only';
        default:
          // If Slack isn't configured, show as Website user
          return slackConfigured ? (status || 'Unknown') : 'Website Only';
      }
    }

    function updateStats(stats) {
      if (stats) {
        document.getElementById('totalUsers').textContent = stats.total || 0;
        document.getElementById('mappedUsers').textContent = stats.mapped || 0;
        document.getElementById('suggestedUsers').textContent = stats.suggested || 0;
        document.getElementById('aaoOnlyUsers').textContent = stats.aao_only || 0;
        document.getElementById('slackOnlyUsers').textContent = stats.slack_only || 0;
      } else {
        // Fallback for non-unified endpoint (Slack not configured)
        document.getElementById('totalUsers').textContent = allUsers.length;
        document.getElementById('mappedUsers').textContent = '0';
        document.getElementById('suggestedUsers').textContent = '0';
        document.getElementById('aaoOnlyUsers').textContent = allUsers.length;
        document.getElementById('slackOnlyUsers').textContent = '0';
      }

      // Update active stat card
      document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
      if (currentStatusFilter) {
        const activeCard = document.getElementById('stat-' + currentStatusFilter.replace('_', '-').replace('suggested-match', 'suggested').replace('slack-only', 'slack').replace('aao-only', 'aao'));
        if (activeCard) activeCard.classList.add('active');
      } else {
        document.getElementById('stat-all').classList.add('active');
      }
    }

    function filterByStatus(status) {
      currentStatusFilter = status;
      document.getElementById('statusFilter').value = status === 'slack_only' ? 'slack_only' : status;
      loadUsers();
    }

    async function linkUser(slackUserId, workosUserId) {
      try {
        const response = await fetch(`/api/admin/slack/users/${slackUserId}/link`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ workos_user_id: workosUserId })
        });
        if (response.ok) {
          await loadUsers();
        } else {
          alert('Failed to link user');
        }
      } catch (error) {
        console.error('Error linking user:', error);
        alert('Error linking user');
      }
    }

    async function unlinkUser(slackUserId) {
      if (!confirm('Are you sure you want to unlink this user?')) return;

      try {
        const response = await fetch(`/api/admin/slack/users/${slackUserId}/unlink`, {
          method: 'POST'
        });
        if (response.ok) {
          await loadUsers();
        } else {
          alert('Failed to unlink user');
        }
      } catch (error) {
        console.error('Error unlinking user:', error);
        alert('Error unlinking user');
      }
    }

    function debounceSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(loadUsers, 300);
    }

    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('statusFilter').value = '';
      document.getElementById('groupFilter').value = '';
      currentStatusFilter = '';
      loadUsers();
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Add spinning animation for sync button
    const style = document.createElement('style');
    style.textContent = `
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      .spin { animation: spin 1s linear infinite; }
    `;
    document.head.appendChild(style);

    // Initialize
    init();
  </script>
</body>
</html>
