<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Admin - System Settings - AgenticAdvertising.org</title>
  <script src="/nav.js"></script>
  <script src="/admin-sidebar.js"></script>
  <link rel="stylesheet" href="/design-system.css">
  <style>
    body {
      background: var(--color-bg-page);
      min-height: 100vh;
    }
    .container {
      max-width: var(--container-lg);
      margin: var(--space-8) auto;
      padding: 0 var(--space-5);
    }
    .card {
      background: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-xs);
    }
    h1 { margin-bottom: var(--space-2.5); color: var(--color-text-heading); }
    h2 { margin-bottom: var(--space-4); color: var(--color-text-heading); font-size: var(--text-xl); }
    .subtitle {
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
      margin-bottom: var(--space-6);
    }
    .setting-section {
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-5);
      margin-bottom: var(--space-5);
    }
    .setting-section h3 {
      font-size: var(--text-base);
      color: var(--color-text-heading);
      margin-bottom: var(--space-2);
    }
    .setting-section p {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-4);
      line-height: 1.5;
    }
    .setting-row {
      display: flex;
      gap: var(--space-4);
      align-items: flex-end;
    }
    .setting-row .field {
      flex: 1;
    }
    .field label {
      display: block;
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--color-text-heading);
      margin-bottom: var(--space-1);
    }
    .field select,
    .field input {
      width: 100%;
      padding: var(--space-2.5);
      border: var(--border-1) solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-family: inherit;
    }
    .field select:focus,
    .field input:focus {
      outline: none;
      border-color: var(--color-brand);
    }
    .field small {
      display: block;
      margin-top: var(--space-1);
      color: var(--color-text-secondary);
      font-size: var(--text-xs);
    }
    .btn {
      padding: var(--space-2.5) var(--space-5);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: var(--transition-all);
      white-space: nowrap;
    }
    .btn-primary { background: var(--color-brand); color: white; }
    .btn-primary:hover { background: var(--color-primary-700); }
    .btn-primary:disabled { background: var(--color-gray-400); cursor: not-allowed; }
    .btn-secondary { background: var(--color-gray-200); color: var(--color-text-heading); }
    .btn-secondary:hover { background: var(--color-gray-300); }
    .btn-success { background: var(--color-success-500); color: white; }
    .current-value {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--color-info-50);
      border: var(--border-1) solid var(--color-info-200);
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
      color: var(--color-info-700);
      margin-bottom: var(--space-4);
    }
    .current-value.not-set {
      background: var(--color-gray-100);
      border-color: var(--color-gray-300);
      color: var(--color-text-secondary);
    }
    .status-message {
      padding: var(--space-2.5) var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-4);
      font-size: var(--text-sm);
    }
    .status-message.success {
      background: var(--color-success-100);
      color: var(--color-success-700);
    }
    .status-message.error {
      background: var(--color-error-100);
      color: var(--color-error-700);
    }
    .info-box {
      background: var(--color-info-50);
      border: var(--border-1) solid var(--color-info-200);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-5);
      font-size: var(--text-sm);
      color: var(--color-info-700);
    }
    .loading-channels {
      padding: var(--space-4);
      text-align: center;
      color: var(--color-text-secondary);
      font-size: var(--text-sm);
    }
  </style>
</head>
<body>
  <div id="adcp-nav"></div>

  <div id="loading" style="text-align: center; padding: var(--space-12); color: var(--color-text-secondary);">
    Loading...
  </div>

  <div id="content" style="display: none;">
    <div class="container">
      <div class="card">
        <h1>System Settings</h1>
        <p class="subtitle">Configure system-wide settings for AgenticAdvertising.org</p>

        <div id="statusMessage" class="status-message" style="display: none;"></div>

        <div class="info-box">
          These settings control how the system behaves. Changes take effect immediately.
        </div>

        <!-- Billing Channel Setting -->
        <div class="setting-section">
          <h3>Billing Notifications Channel</h3>
          <p>
            Choose which Slack channel receives billing notifications from Addie.
            This includes new subscriptions, payments, payment failures, and cancellations.
          </p>

          <div class="current-value" id="currentChannel">
            <span>Loading...</span>
          </div>

          <div class="setting-row">
            <div class="field">
              <label for="billingChannel">Select Channel</label>
              <select id="billingChannel" disabled>
                <option value="">Loading channels...</option>
              </select>
              <small>Only private channels are shown. Invite Addie to your billing channel first.</small>
            </div>
            <button class="btn btn-primary" id="saveBtn" onclick="saveBillingChannel()" disabled>
              Save
            </button>
          </div>
        </div>

        <!-- Escalation Channel Setting -->
        <div class="setting-section">
          <h3>Escalation Notifications Channel</h3>
          <p>
            Choose which Slack channel receives escalation notifications when Addie cannot fulfill a request.
            This allows admins to be notified when users need human assistance.
          </p>

          <div class="current-value" id="currentEscalationChannel">
            <span>Loading...</span>
          </div>

          <div class="setting-row">
            <div class="field">
              <label for="escalationChannel">Select Channel</label>
              <select id="escalationChannel" disabled>
                <option value="">Loading channels...</option>
              </select>
              <small>Select a channel where admins can see and respond to escalations. <a href="/admin/escalations">View escalations</a></small>
            </div>
            <button class="btn btn-primary" id="saveEscalationBtn" onclick="saveEscalationChannel()" disabled>
              Save
            </button>
          </div>
        </div>

        <!-- Admin Channel Setting -->
        <div class="setting-section">
          <h3>Admin notifications channel</h3>
          <p>
            Choose which Slack channel receives general admin notifications, including persona assessment completions.
          </p>

          <div class="current-value" id="currentAdminChannel">
            <span>Loading...</span>
          </div>

          <div class="setting-row">
            <div class="field">
              <label for="adminChannel">Select channel</label>
              <select id="adminChannel" disabled>
                <option value="">Loading channels...</option>
              </select>
              <small>Only private channels are shown. Invite Addie to your admin channel first.</small>
            </div>
            <button class="btn btn-primary" id="saveAdminChannelBtn" onclick="saveAdminChannel()" disabled>
              Save
            </button>
          </div>
        </div>

        <!-- Prospect Notifications Channel -->
        <div class="setting-section">
          <h3>Prospect notifications channel</h3>
          <p>
            Choose which Slack channel receives prospect triage notifications.
            New prospects, triage decisions, and claims are posted here.
          </p>

          <div class="current-value" id="currentProspectChannel">
            <span>Loading...</span>
          </div>

          <div class="setting-row">
            <div class="field">
              <label for="prospectChannel">Select channel</label>
              <select id="prospectChannel" disabled>
                <option value="">Loading channels...</option>
              </select>
              <small>Only private channels are shown. Invite Addie to your prospect channel first.</small>
            </div>
            <button class="btn btn-primary" id="saveProspectChannelBtn" onclick="saveProspectChannel()" disabled>
              Save
            </button>
          </div>
        </div>

        <!-- Prospect Triage Toggle -->
        <div class="setting-section">
          <h3>Automatic prospect triage</h3>
          <p>
            When enabled, Addie automatically triages new domains from Slack joins and website signups,
            creating prospect records and routing them to Addie or a human owner.
            Disable this to pause automatic prospect creation.
          </p>

          <div class="current-value" id="currentTriageStatus">
            <span>Loading...</span>
          </div>

          <div class="setting-row">
            <div class="field">
              <label for="triageEnabled">Prospect triage</label>
              <select id="triageEnabled">
                <option value="true">Enabled</option>
                <option value="false">Disabled</option>
              </select>
              <small>Changes take effect immediately for new Slack joins and signups.</small>
            </div>
            <button class="btn btn-primary" id="saveTriageBtn" onclick="saveTriageEnabled()" disabled>
              Save
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    let currentSettings = null;
    let slackChannels = [];

    // Load current settings
    async function loadSettings() {
      try {
        const response = await fetch('/api/admin/settings');
        if (!response.ok) {
          if (response.status === 401) {
            window.AdminSidebar.redirectToLogin();
            return;
          }
          throw new Error('Failed to load settings');
        }

        currentSettings = await response.json();
        updateCurrentChannelDisplay();
        updateCurrentEscalationChannelDisplay();
        updateCurrentAdminChannelDisplay();
        updateCurrentProspectChannelDisplay();
        updateTriageDisplay();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        // Load Slack channels for picker
        loadSlackChannels();
      } catch (error) {
        console.error('Error loading settings:', error);
        document.getElementById('loading').innerHTML =
          '<p style="color: var(--color-error-600);">Failed to load settings. <a href="/auth/login">Try logging in again</a></p>';
      }
    }

    // Load Slack channels for picker
    async function loadSlackChannels() {
      const billingSelect = document.getElementById('billingChannel');
      const escalationSelect = document.getElementById('escalationChannel');
      const adminSelect = document.getElementById('adminChannel');
      const prospectSelect = document.getElementById('prospectChannel');

      try {
        const response = await fetch('/api/admin/settings/slack-channels');
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'Failed to load channels');
        }

        const data = await response.json();
        slackChannels = data.channels;

        // Build options for all dropdowns
        let billingHtml = '<option value="">-- No channel (disabled) --</option>';
        let escalationHtml = '<option value="">-- No channel (disabled) --</option>';
        let adminHtml = '<option value="">-- No channel (disabled) --</option>';
        let prospectHtml = '<option value="">-- No channel (disabled) --</option>';

        if (slackChannels.length === 0) {
          const emptyOption = '<option value="">No private channels found - invite Addie first</option>';
          billingSelect.innerHTML = emptyOption;
          escalationSelect.innerHTML = emptyOption;
          adminSelect.innerHTML = emptyOption;
          prospectSelect.innerHTML = emptyOption;
          showStatusMessage('Addie is not in any private channels. Invite @Addie to your channels and refresh.', 'error');
        } else {
          slackChannels.forEach(ch => {
            const billingSelected = currentSettings?.billing_channel?.channel_id === ch.id ? 'selected' : '';
            const escalationSelected = currentSettings?.escalation_channel?.channel_id === ch.id ? 'selected' : '';
            const adminSelected = currentSettings?.admin_channel?.channel_id === ch.id ? 'selected' : '';
            const prospectSelected = currentSettings?.prospect_channel?.channel_id === ch.id ? 'selected' : '';
            billingHtml += `<option value="${ch.id}" ${billingSelected}>#${escapeHtml(ch.name)}</option>`;
            escalationHtml += `<option value="${ch.id}" ${escalationSelected}>#${escapeHtml(ch.name)}</option>`;
            adminHtml += `<option value="${ch.id}" ${adminSelected}>#${escapeHtml(ch.name)}</option>`;
            prospectHtml += `<option value="${ch.id}" ${prospectSelected}>#${escapeHtml(ch.name)}</option>`;
          });
          billingSelect.innerHTML = billingHtml;
          billingSelect.disabled = false;
          document.getElementById('saveBtn').disabled = false;

          escalationSelect.innerHTML = escalationHtml;
          escalationSelect.disabled = false;
          document.getElementById('saveEscalationBtn').disabled = false;

          adminSelect.innerHTML = adminHtml;
          adminSelect.disabled = false;
          document.getElementById('saveAdminChannelBtn').disabled = false;

          prospectSelect.innerHTML = prospectHtml;
          prospectSelect.disabled = false;
          document.getElementById('saveProspectChannelBtn').disabled = false;
        }
      } catch (error) {
        console.error('Error loading Slack channels:', error);
        billingSelect.innerHTML = '<option value="">Error loading channels</option>';
        escalationSelect.innerHTML = '<option value="">Error loading channels</option>';
        adminSelect.innerHTML = '<option value="">Error loading channels</option>';
        prospectSelect.innerHTML = '<option value="">Error loading channels</option>';
        showStatusMessage('Failed to load Slack channels: ' + error.message, 'error');
      }
    }

    // Update the current channel display
    function updateCurrentChannelDisplay() {
      const el = document.getElementById('currentChannel');
      const channel = currentSettings?.billing_channel;

      if (channel?.channel_id && channel?.channel_name) {
        el.className = 'current-value';
        el.innerHTML = `<strong>Current:</strong> #${escapeHtml(channel.channel_name)}`;
      } else {
        el.className = 'current-value not-set';
        el.innerHTML = '<strong>Current:</strong> Not configured (notifications disabled)';
      }
    }

    // Update the current escalation channel display
    function updateCurrentEscalationChannelDisplay() {
      const el = document.getElementById('currentEscalationChannel');
      const channel = currentSettings?.escalation_channel;

      if (channel?.channel_id && channel?.channel_name) {
        el.className = 'current-value';
        el.innerHTML = `<strong>Current:</strong> #${escapeHtml(channel.channel_name)}`;
      } else {
        el.className = 'current-value not-set';
        el.innerHTML = '<strong>Current:</strong> Not configured (escalation notifications disabled)';
      }
    }

    // Save billing channel
    async function saveBillingChannel() {
      const select = document.getElementById('billingChannel');
      const saveBtn = document.getElementById('saveBtn');
      const channelId = select.value || null;

      // Find channel name
      let channelName = null;
      if (channelId) {
        const channel = slackChannels.find(c => c.id === channelId);
        channelName = channel?.name || null;
      }

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const response = await fetch('/api/admin/settings/billing-channel', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channel_id: channelId, channel_name: channelName }),
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'Failed to save');
        }

        const data = await response.json();
        currentSettings.billing_channel = data.billing_channel;
        updateCurrentChannelDisplay();

        saveBtn.textContent = 'Saved!';
        saveBtn.classList.add('btn-success');
        showStatusMessage('Billing channel updated successfully', 'success');

        setTimeout(() => {
          saveBtn.textContent = 'Save';
          saveBtn.classList.remove('btn-success');
          saveBtn.disabled = false;
        }, 2000);
      } catch (error) {
        console.error('Error saving billing channel:', error);
        showStatusMessage('Failed to save: ' + error.message, 'error');
        saveBtn.textContent = 'Save';
        saveBtn.disabled = false;
      }
    }

    // Save escalation channel
    async function saveEscalationChannel() {
      const select = document.getElementById('escalationChannel');
      const saveBtn = document.getElementById('saveEscalationBtn');
      const channelId = select.value || null;

      // Find channel name
      let channelName = null;
      if (channelId) {
        const channel = slackChannels.find(c => c.id === channelId);
        channelName = channel?.name || null;
      }

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const response = await fetch('/api/admin/settings/escalation-channel', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channel_id: channelId, channel_name: channelName }),
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'Failed to save');
        }

        const data = await response.json();
        currentSettings.escalation_channel = data.escalation_channel;
        updateCurrentEscalationChannelDisplay();

        saveBtn.textContent = 'Saved!';
        saveBtn.classList.add('btn-success');
        showStatusMessage('Escalation channel updated successfully', 'success');

        setTimeout(() => {
          saveBtn.textContent = 'Save';
          saveBtn.classList.remove('btn-success');
          saveBtn.disabled = false;
        }, 2000);
      } catch (error) {
        console.error('Error saving escalation channel:', error);
        showStatusMessage('Failed to save: ' + error.message, 'error');
        saveBtn.textContent = 'Save';
        saveBtn.disabled = false;
      }
    }

    // Update the current admin channel display
    function updateCurrentAdminChannelDisplay() {
      const el = document.getElementById('currentAdminChannel');
      const channel = currentSettings?.admin_channel;

      if (channel?.channel_id && channel?.channel_name) {
        el.className = 'current-value';
        el.innerHTML = `<strong>Current:</strong> #${escapeHtml(channel.channel_name)}`;
      } else {
        el.className = 'current-value not-set';
        el.innerHTML = '<strong>Current:</strong> Not configured (admin notifications disabled)';
      }
    }

    // Save admin channel
    async function saveAdminChannel() {
      const select = document.getElementById('adminChannel');
      const saveBtn = document.getElementById('saveAdminChannelBtn');
      const channelId = select.value || null;

      let channelName = null;
      if (channelId) {
        const channel = slackChannels.find(c => c.id === channelId);
        channelName = channel?.name || null;
      }

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const response = await fetch('/api/admin/settings/admin-channel', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channel_id: channelId, channel_name: channelName }),
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'Failed to save');
        }

        const data = await response.json();
        currentSettings.admin_channel = data.admin_channel;
        updateCurrentAdminChannelDisplay();

        saveBtn.textContent = 'Saved!';
        saveBtn.classList.add('btn-success');
        showStatusMessage('Admin channel updated successfully', 'success');

        setTimeout(() => {
          saveBtn.textContent = 'Save';
          saveBtn.classList.remove('btn-success');
          saveBtn.disabled = false;
        }, 2000);
      } catch (error) {
        console.error('Error saving admin channel:', error);
        showStatusMessage('Failed to save: ' + error.message, 'error');
        saveBtn.textContent = 'Save';
        saveBtn.disabled = false;
      }
    }

    // Update the current prospect channel display
    function updateCurrentProspectChannelDisplay() {
      const el = document.getElementById('currentProspectChannel');
      const channel = currentSettings?.prospect_channel;

      if (channel?.channel_id && channel?.channel_name) {
        el.className = 'current-value';
        el.innerHTML = `<strong>Current:</strong> #${escapeHtml(channel.channel_name)}`;
      } else {
        el.className = 'current-value not-set';
        el.innerHTML = '<strong>Current:</strong> Not configured (prospect notifications disabled)';
      }
    }

    // Save prospect channel
    async function saveProspectChannel() {
      const select = document.getElementById('prospectChannel');
      const saveBtn = document.getElementById('saveProspectChannelBtn');
      const channelId = select.value || null;

      let channelName = null;
      if (channelId) {
        const channel = slackChannels.find(c => c.id === channelId);
        channelName = channel?.name || null;
      }

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const response = await fetch('/api/admin/settings/prospect-channel', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channel_id: channelId, channel_name: channelName }),
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'Failed to save');
        }

        const data = await response.json();
        currentSettings.prospect_channel = data.prospect_channel;
        updateCurrentProspectChannelDisplay();

        saveBtn.textContent = 'Saved!';
        saveBtn.classList.add('btn-success');
        showStatusMessage('Prospect channel updated successfully', 'success');

        setTimeout(() => {
          saveBtn.textContent = 'Save';
          saveBtn.classList.remove('btn-success');
          saveBtn.disabled = false;
        }, 2000);
      } catch (error) {
        console.error('Error saving prospect channel:', error);
        showStatusMessage('Failed to save: ' + error.message, 'error');
        saveBtn.textContent = 'Save';
        saveBtn.disabled = false;
      }
    }

    // Update triage toggle display
    function updateTriageDisplay() {
      const el = document.getElementById('currentTriageStatus');
      const enabled = currentSettings?.prospect_triage_enabled !== false;
      const select = document.getElementById('triageEnabled');

      if (enabled) {
        el.className = 'current-value';
        el.innerHTML = '<strong>Status:</strong> Enabled';
      } else {
        el.className = 'current-value not-set';
        el.innerHTML = '<strong>Status:</strong> Disabled';
      }
      select.value = String(enabled);
      document.getElementById('saveTriageBtn').disabled = false;
    }

    // Save triage enabled setting
    async function saveTriageEnabled() {
      const select = document.getElementById('triageEnabled');
      const saveBtn = document.getElementById('saveTriageBtn');
      const enabled = select.value === 'true';

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const response = await fetch('/api/admin/settings/prospect-triage-enabled', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled }),
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'Failed to save');
        }

        currentSettings.prospect_triage_enabled = enabled;
        updateTriageDisplay();

        saveBtn.textContent = 'Saved!';
        saveBtn.classList.add('btn-success');
        showStatusMessage(`Prospect triage ${enabled ? 'enabled' : 'disabled'}`, 'success');

        setTimeout(() => {
          saveBtn.textContent = 'Save';
          saveBtn.classList.remove('btn-success');
          saveBtn.disabled = false;
        }, 2000);
      } catch (error) {
        console.error('Error saving triage setting:', error);
        showStatusMessage('Failed to save: ' + error.message, 'error');
        saveBtn.textContent = 'Save';
        saveBtn.disabled = false;
      }
    }

    // Status message helpers
    function showStatusMessage(message, type) {
      const el = document.getElementById('statusMessage');
      el.textContent = message;
      el.className = `status-message ${type}`;
      el.style.display = 'block';

      if (type === 'success') {
        setTimeout(() => {
          el.style.display = 'none';
        }, 5000);
      }
    }

    // Utility: escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize
    loadSettings();
  </script>
</body>
</html>
