<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/AAo.svg" type="image/svg+xml">
  <title>Referrals - Manage - AgenticAdvertising.org</title>
  <link rel="stylesheet" href="/design-system.css">
  <script src="/nav.js"></script>
  <script src="/manage-sidebar.js"></script>
  <style>
    body {
      background: var(--color-bg-page);
    }

    .container {
      max-width: var(--container-wide);
      margin: var(--space-6) auto;
      padding: 0 var(--space-5);
    }

    .page-header {
      margin-bottom: var(--space-6);
    }

    .page-header h1 {
      color: var(--color-text-heading);
      margin-bottom: var(--space-1);
    }

    .page-header .subtitle {
      color: var(--color-text-secondary);
    }

    .section {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      margin-bottom: var(--space-5);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-border);
    }

    .section-title {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--color-text-heading);
    }

    .section-subtitle {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-1);
    }

    /* Create code form */
    .create-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-4);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }

    .form-group label {
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--color-text-secondary);
    }

    .form-group input {
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-bg-page);
      color: var(--color-text-body);
      font-size: var(--text-sm);
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--color-brand);
      box-shadow: 0 0 0 3px var(--color-primary-100);
    }

    .form-actions {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-top: var(--space-2);
    }

    .btn {
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: opacity 0.15s;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--color-brand);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      opacity: 0.9;
    }

    .form-error {
      color: var(--color-error);
      font-size: var(--text-sm);
    }

    /* Tables */
    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--text-sm);
    }

    th {
      text-align: left;
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--color-text-muted);
      border-bottom: 1px solid var(--color-border);
    }

    td {
      padding: var(--space-3);
      border-bottom: 1px solid var(--color-border-subtle);
      color: var(--color-text-body);
      vertical-align: top;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .code-cell {
      font-family: monospace;
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--color-text-heading);
    }

    .copy-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      color: var(--color-brand);
      cursor: pointer;
      font-size: var(--text-xs);
      background: none;
      border: none;
      padding: 0;
    }

    .copy-link:hover {
      text-decoration: underline;
    }

    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: 500;
    }

    .status-active { background: var(--color-success-bg); color: var(--color-success); }
    .status-revoked { background: var(--color-error-bg); color: var(--color-error); }
    .status-expired { background: var(--color-bg-subtle); color: var(--color-text-muted); }
    .status-converted { background: var(--color-brand-bg); color: var(--color-brand); }
    .status-pending { background: var(--color-warning-bg); color: var(--color-warning); }
    .status-accepted { background: var(--color-info-bg); color: var(--color-info); }

    .revoke-btn {
      background: none;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      padding: 2px 8px;
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      cursor: pointer;
    }

    .revoke-btn:hover {
      border-color: var(--color-error);
      color: var(--color-error);
    }

    .empty-state {
      text-align: center;
      padding: var(--space-8) 0;
      color: var(--color-text-muted);
    }

    .loading-text {
      color: var(--color-text-muted);
      font-size: var(--text-sm);
      padding: var(--space-4) 0;
    }
  </style>
</head>
<body>
  <div id="adcp-nav"></div>

  <div class="container">
    <div class="page-header">
      <h1>Referrals</h1>
      <p class="subtitle">Create and track member referral codes</p>
    </div>

    <!-- My referral codes -->
    <div class="section" id="myCodesSection">
      <div class="section-header">
        <div>
          <div class="section-title">My referral codes</div>
          <div class="section-subtitle" id="orgName">Loading...</div>
        </div>
      </div>

      <form id="createForm" onsubmit="handleCreateCode(event)">
        <div class="create-form">
          <div class="form-group">
            <label for="targetCompany">Target company (optional)</label>
            <input type="text" id="targetCompany" placeholder="e.g. Acme Corp" maxlength="200">
          </div>
          <div class="form-group">
            <label for="discountPercent">Discount %</label>
            <input type="number" id="discountPercent" placeholder="e.g. 10" min="1" max="100">
          </div>
          <div class="form-group">
            <label for="maxUses">Max uses</label>
            <input type="number" id="maxUses" placeholder="Unlimited" min="1">
          </div>
          <div class="form-group">
            <label for="customCode">Custom code (optional)</label>
            <input type="text" id="customCode" placeholder="e.g. ACME2026" maxlength="40">
          </div>
          <div class="form-group">
            <label for="expiresAt">Expires (optional)</label>
            <input type="date" id="expiresAt">
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary" id="createBtn">Create code</button>
          <span class="form-error" id="createError"></span>
        </div>
      </form>

      <div class="table-wrapper" style="margin-top: var(--space-4);">
        <div class="loading-text" id="myCodesLoading">Loading your codes...</div>
        <table id="myCodesTable" style="display: none;">
          <thead>
            <tr>
              <th>Code</th>
              <th>Target</th>
              <th>Discount</th>
              <th>Uses</th>
              <th>Status</th>
              <th>Expires</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="myCodesBody"></tbody>
        </table>
        <div class="empty-state" id="myCodesEmpty" style="display: none;">
          No referral codes yet. Create one above.
        </div>
      </div>
    </div>

    <!-- All referral activity -->
    <div class="section">
      <div class="section-header">
        <div>
          <div class="section-title">All referral activity</div>
          <div class="section-subtitle">Aggregate view across all members</div>
        </div>
      </div>

      <div class="table-wrapper">
        <div class="loading-text" id="allActivityLoading">Loading activity...</div>
        <table id="allActivityTable" style="display: none;">
          <thead>
            <tr>
              <th>Code</th>
              <th>Referrer</th>
              <th>Target</th>
              <th>Referred org</th>
              <th>Status</th>
              <th>Converted</th>
            </tr>
          </thead>
          <tbody id="allActivityBody"></tbody>
        </table>
        <div class="empty-state" id="allActivityEmpty" style="display: none;">
          No referral activity yet.
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentOrgId = null;

    function formatDate(dateStr) {
      if (!dateStr) return '—';
      return new Date(dateStr).toLocaleDateString();
    }

    function statusBadge(status) {
      return `<span class="status-badge status-${status}">${status}</span>`;
    }

    function copyJoinLink(code) {
      const url = `${window.location.origin}/join/${code}`;
      navigator.clipboard.writeText(url).then(() => {
        const btn = document.querySelector(`[data-copy="${code}"]`);
        if (btn) {
          const orig = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => { btn.textContent = orig; }, 1500);
        }
      });
    }

    function renderMyCodes(rows) {
      const loading = document.getElementById('myCodesLoading');
      const table = document.getElementById('myCodesTable');
      const empty = document.getElementById('myCodesEmpty');
      const tbody = document.getElementById('myCodesBody');

      loading.style.display = 'none';

      if (!rows || rows.length === 0) {
        empty.style.display = 'block';
        return;
      }

      // Deduplicate by code_id
      const byCodeId = new Map();
      for (const row of rows) {
        if (!byCodeId.has(row.code_id)) byCodeId.set(row.code_id, row);
      }

      tbody.innerHTML = Array.from(byCodeId.values()).map(row => `
        <tr>
          <td>
            <div class="code-cell">${row.code}</div>
            <button class="copy-link" data-copy="${row.code}" onclick="copyJoinLink('${row.code}')">
              Copy join link
            </button>
          </td>
          <td>${row.target_company_name || '—'}</td>
          <td>${row.discount_percent != null ? row.discount_percent + '%' : '—'}</td>
          <td>${row.used_count}${row.max_uses != null ? ' / ' + row.max_uses : ''}</td>
          <td>${statusBadge(row.code_status)}</td>
          <td>${formatDate(row.expires_at)}</td>
          <td>
            ${row.code_status === 'active'
              ? `<button class="revoke-btn" onclick="revokeCode(${row.code_id})">Revoke</button>`
              : ''}
          </td>
        </tr>
      `).join('');

      table.style.display = 'table';
    }

    function renderAllActivity(rows) {
      const loading = document.getElementById('allActivityLoading');
      const table = document.getElementById('allActivityTable');
      const empty = document.getElementById('allActivityEmpty');
      const tbody = document.getElementById('allActivityBody');

      loading.style.display = 'none';

      // Only show rows that have a referral (have been used)
      const used = rows.filter(r => r.referral_id != null);

      if (used.length === 0) {
        empty.style.display = 'block';
        return;
      }

      tbody.innerHTML = used.map(row => `
        <tr>
          <td class="code-cell">${row.code}</td>
          <td>${row.referrer_org_name || '—'}</td>
          <td>${row.target_company_name || '—'}</td>
          <td>${row.referred_org_name || row.referred_company_name || '—'}</td>
          <td>${statusBadge(row.referral_status || 'pending')}</td>
          <td>${formatDate(row.converted_at)}</td>
        </tr>
      `).join('');

      table.style.display = 'table';
    }

    async function loadMyCodes() {
      if (!currentOrgId) return;
      try {
        const res = await ManageSidebar.fetch(`/api/organizations/${currentOrgId}/referral-codes`);
        if (res.ok) {
          renderMyCodes(await res.json());
        } else {
          document.getElementById('myCodesLoading').textContent = 'Failed to load codes.';
        }
      } catch (err) {
        console.error('Error loading my codes:', err);
        document.getElementById('myCodesLoading').textContent = 'Failed to load codes.';
      }
    }

    async function loadAllActivity() {
      try {
        const res = await ManageSidebar.fetch('/api/admin/referrals');
        if (res.ok) {
          renderAllActivity(await res.json());
        } else {
          document.getElementById('allActivityLoading').textContent = 'Failed to load activity.';
        }
      } catch (err) {
        console.error('Error loading all activity:', err);
        document.getElementById('allActivityLoading').textContent = 'Failed to load activity.';
      }
    }

    async function handleCreateCode(e) {
      e.preventDefault();
      const errorEl = document.getElementById('createError');
      const btn = document.getElementById('createBtn');
      errorEl.textContent = '';
      btn.disabled = true;

      const body = {};
      const target = document.getElementById('targetCompany').value.trim();
      const discount = document.getElementById('discountPercent').value;
      const maxUses = document.getElementById('maxUses').value;
      const custom = document.getElementById('customCode').value.trim();
      const expires = document.getElementById('expiresAt').value;

      if (target) body.target_company_name = target;
      if (discount) body.discount_percent = parseInt(discount, 10);
      if (maxUses) body.max_uses = parseInt(maxUses, 10);
      if (custom) body.custom_code = custom;
      if (expires) body.expires_at = expires;

      try {
        const res = await ManageSidebar.fetch(`/api/organizations/${currentOrgId}/referral-codes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        const data = await res.json();
        if (!res.ok) {
          errorEl.textContent = data.error || 'Failed to create code';
        } else {
          document.getElementById('createForm').reset();
          await loadMyCodes();
          await loadAllActivity();
        }
      } catch (err) {
        errorEl.textContent = 'Network error — please try again';
      } finally {
        btn.disabled = false;
      }
    }

    async function revokeCode(codeId) {
      if (!confirm('Revoke this referral code? Existing referrals are not affected.')) return;
      try {
        const res = await ManageSidebar.fetch(`/api/organizations/${currentOrgId}/referral-codes/${codeId}`, {
          method: 'DELETE',
        });
        if (res.ok) {
          await loadMyCodes();
        } else {
          alert('Failed to revoke code');
        }
      } catch (err) {
        alert('Network error');
      }
    }

    async function init() {
      try {
        const res = await fetch('/api/me', { credentials: 'include' });
        if (res.status === 401) {
          window.location.href = '/auth/login?return_to=' + encodeURIComponent(window.location.pathname);
          return;
        }
        if (!res.ok) throw new Error('Failed to load user');

        const data = await res.json();
        const { org } = (window.DashboardNav && window.DashboardNav.resolveOrg)
          ? DashboardNav.resolveOrg(data.organizations)
          : { org: data.organizations?.[0] };

        if (!org) {
          document.getElementById('orgName').textContent = 'No organization found';
          return;
        }

        currentOrgId = org.id;
        document.getElementById('orgName').textContent = org.name;

        await Promise.all([loadMyCodes(), loadAllActivity()]);
      } catch (err) {
        console.error('Init error:', err);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>

  <div id="adcp-footer"></div>
</body>
</html>
