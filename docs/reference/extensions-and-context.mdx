# Extension Fields and Context

## Overview

AdCP provides two mechanisms for adding custom data to requests and responses:

- **`ext`** - Platform-specific extensions that MAY affect behavior (vendor-namespaced)
- **`context`** - Opaque correlation data that is echoed unchanged

### Extension Fields (`ext`)

AdCP supports extension fields via the `ext` object at three distinct layers:

- **Request extensions** - Operational metadata, test flags, caller context
- **Response extensions** - Processing diagnostics, debug info, operation hints
- **Object extensions** - Domain-specific persistent data

Extensions enable:

- **Platform-specific functionality** - Custom metadata for different ad platforms
- **Private agreements** - Publisher-buyer specific data exchange
- **Experimental features** - Testing capabilities before standardization
- **Forward compatibility** - Supporting emerging ad tech capabilities

Extension fields follow industry conventions established by IAB standards like OpenRTB, which uses extensions at multiple layers for different purposes.

## Extension Object

### Schema Pattern

Core objects include an optional `ext` field:

```json
{
  "product_id": "ctv_premium",
  "name": "Connected TV Premium Inventory",
  "ext": {
    "platform_specific_field": "value",
    "custom_metadata": {
      "nested": "data"
    }
  }
}
```

The `ext` object:
- Is always **optional** (never required)
- Accepts any valid JSON structure
- Must be preserved by implementations (even unknown fields)
- Is not validated by AdCP schemas (implementation-specific validation allowed)

### Extension Layers

AdCP supports extensions at three distinct layers, following the OpenRTB pattern:

#### 1. Request Extensions

All task request schemas support `ext` for platform-specific parameters:

```json
{
  "promoted_offering": "Tesla Model 3",
  "packages": [...],
  "context": {
    "buyer_campaign_id": "camp_abc",  // Internal tracking - echoed unchanged
    "ui_session_id": "sess_123"
  },
  "ext": {
    "gam": {
      "test_mode": true,
      "ad_unit_path": "/12345/premium"
    },
    "ttd": {
      "uid2_token": "..."
    }
  }
}
```

**Use request.ext for:**
- Platform-specific targeting parameters not in the core spec
- Vendor-specific configuration (always namespaced)
- Custom capabilities proposed for future spec inclusion
- Partner-specific delivery requirements

#### 2. Response Extensions

All task response schemas support `ext` for platform-specific metadata:

```json
{
  "media_buy": {
    "media_buy_id": "mb_123",
    "ext": {
      "gam": {
        "order_id": "1234567890",
        "dashboard_url": "https://..."
      }
    }
  },
  "context": {
    "ui_session_id": "sess_123"  // Echoed from request
  },
  "ext": {
    "gam": {
      "estimated_approval_time": "2-4 hours",
      "pending_review_items": ["creative_123"]
    }
  }
}
```

**Use response.ext for:**
- Platform-specific identifiers and URLs
- Vendor-specific metadata and diagnostics
- Extended response data not in core spec
- Partner-specific operational details

#### 3. Object Extensions

Core domain objects support `ext` for persistent data:

| Object | Use Cases |
|--------|-----------|
| **Product** | Platform inventory metadata, content classifications, custom targeting capabilities |
| **MediaBuy** | Campaign tracking IDs, attribution settings, custom reporting requirements |
| **CreativeManifest** | AI generation metadata, localization info, brand safety scores |
| **Package** | Delivery preferences, companion ad settings, custom optimization flags |

**Use object.ext for:**
- Persistent domain-specific data
- Platform campaign IDs
- Object-scoped custom fields
- Data that persists across API calls

## Context Object

### Purpose

The `context` object is for **opaque correlation data** that flows through AdCP unchanged. Think of it as a "pass-through envelope" for caller-specific metadata that agents don't parse or act upon.

**Key characteristics:**
- ✅ **Echoed unchanged** - Returned in responses and webhooks exactly as provided
- ✅ **Never parsed** - Agents treat it as opaque JSON
- ✅ **Never affects behavior** - Doesn't change how agents process requests
- ✅ **Always optional** - Not required for any AdCP operation

### Schema

```json
{
  "$ref": "/schemas/core/context.json"
}
```

The context object accepts any valid JSON structure with `additionalProperties: true`.

### Use Cases

**Internal tracking and correlation:**
```json
{
  "context": {
    "internal_campaign_id": "camp_xyz_2024",
    "buyer_organization_id": "org_123",
    "ui_session_id": "sess_abc",
    "trace_id": "trace_456",
    "user_token": "opaque_token_string"
  }
}
```

**UI state preservation:**
```json
{
  "context": {
    "ui_workflow_step": "creative_upload",
    "draft_id": "draft_789",
    "selected_products": ["prod_1", "prod_2"]
  }
}
```

**Request correlation across systems:**
```json
{
  "context": {
    "originating_system": "acme_dsp",
    "request_id": "req_abc123",
    "parent_transaction_id": "txn_456"
  }
}
```

### Extension vs Context

**When to use `context`:**
- Internal tracking IDs that don't affect processing
- UI session state or workflow metadata
- Correlation tokens for linking related requests
- Opaque data that needs to round-trip unchanged

**When to use `ext`:**
- Platform-specific configuration parameters
- Vendor-specific targeting or delivery options
- Custom capabilities that MAY affect agent behavior
- Partner-specific operational requirements

```json
{
  "context": {
    "ui_session_id": "sess_123",         // ✅ Opaque tracking
    "internal_campaign_id": "camp_xyz"   // ✅ Just echoed back
  },
  "ext": {
    "gam": {
      "test_mode": true,                 // ✅ MAY affect behavior
      "custom_targeting": {"..."}        // ✅ Platform-specific config
    }
  }
}
```

### Context in Responses

Agents **MUST** echo the request `context` unchanged in responses:

```json
// Request
{
  "promoted_offering": "Tesla Model 3",
  "context": {
    "ui_session": "sess_123",
    "campaign_id": "camp_xyz"
  }
}

// Response - context echoed exactly
{
  "media_buy": {"media_buy_id": "mb_456"},
  "context": {
    "ui_session": "sess_123",
    "campaign_id": "camp_xyz"
  }
}
```

### Context in Webhooks

Webhook payloads **MUST** include the original request context:

```json
{
  "webhook_type": "media_buy_approved",
  "media_buy_id": "mb_456",
  "context": {
    "ui_session": "sess_123",    // From original request
    "campaign_id": "camp_xyz"
  }
}
```

### Implementation Requirements

**Agents MUST:**
- Accept any valid JSON in `context` field
- Echo `context` unchanged in all responses
- Include `context` in webhook payloads
- Never reject requests due to unknown `context` content
- Never parse or act upon `context` data

**Agents MUST NOT:**
- Modify `context` data
- Use `context` to affect processing behavior
- Validate `context` structure
- Require specific `context` fields

## Namespacing Conventions

**CRITICAL**: All extensions **MUST** be namespaced under a vendor/platform key. Never use top-level fields in `ext`.

### Vendor/Platform Namespacing

Extensions are always nested under a vendor or platform namespace:

```json
{
  "ext": {
    "gam": {
      "custom_targeting": {
        "category": "premium",
        "genre": "sports"
      },
      "ad_unit_path": "/12345/premium"
    },
    "roku": {
      "app_ids": ["123456", "789012"],
      "content_genres": ["comedy", "drama"]
    },
    "ttd": {
      "uid2_token": "...",
      "advertiser_id": "adv_123"
    }
  }
}
```

**Why namespace?** Multiple vendors may add extensions simultaneously. Namespacing prevents collisions and makes ownership clear.

### Proposing Spec Additions

Extensions provide a path for capabilities to become standard:

1. **Start as vendor extension** - Implement as `ext.yourplatform.new_feature`
2. **Prove value** - Multiple vendors adopt similar patterns
3. **Propose to spec** - Submit as candidate for core AdCP
4. **Standardize** - If accepted, moves from `ext` to standard field

```json
// Phase 1: Vendor extension (proven in production)
{
  "ext": {
    "gam": {
      "contextual_segments": ["sports", "news"]
    },
    "magnite": {
      "contextual_categories": ["sports", "news"]
    }
  }
}

// Phase 2: If adopted widely, propose to core spec
// Phase 3: Becomes standard field `contextual_targeting`
{
  "contextual_targeting": {
    "categories": ["sports", "news"]
  }
}
```

## Validation Rules

### AdCP Schema Validation

- ✅ **Accepts** any valid JSON in `ext`
- ✅ **Does not enforce** specific `ext` structure
- ✅ **Validates** all standard fields strictly
- ⚠️ **May warn** about unknown top-level fields (typo detection)

### Implementation Requirements

Implementations **MUST**:
- Accept products/responses with `ext` fields they don't recognize
- Preserve unknown `ext` data when passing through to other systems
- Not reject requests solely due to unknown `ext` content

Implementations **MAY**:
- Validate vendor-specific `ext` fields per private agreements
- Document all custom `ext` fields they produce or consume
- Ignore `ext` data they don't understand

Implementations **SHOULD**:
- Follow namespacing conventions to avoid collisions
- Document their `ext` usage in API documentation
- Maintain backward compatibility when changing `ext` structures

## Common Extension Patterns

### Request-Level: Platform-Specific Parameters

Request extensions for vendor-specific configuration:

```json
// create_media_buy request with GAM-specific parameters
{
  "promoted_offering": "Tesla Model 3",
  "packages": [...],
  "context": {
    "buyer_campaign_id": "camp_xyz",  // Internal tracking
    "trace_id": "trace_abc123"
  },
  "ext": {
    "gam": {
      "test_mode": true,
      "skip_credit_check": true,
      "programmatic_guaranteed": true,
      "custom_targeting": {
        "content_vertical": "automotive"
      }
    }
  }
}
```

### Response-Level: Platform Identifiers

Response extensions for vendor-specific metadata:

```json
// create_media_buy response with platform IDs
{
  "media_buy": {
    "media_buy_id": "mb_123",
    "status": "pending_approval"
  },
  "ext": {
    "gam": {
      "order_id": "1234567890",
      "proposal_id": "prop_abc",
      "dashboard_url": "https://admanager.google.com/...",
      "estimated_approval_time": "2-4 hours"
    },
    "roku": {
      "deal_id": "deal_12345",
      "dashboard_url": "https://roku.com/dashboard/deal_12345"
    }
  }
}
```

### Object-Level: Platform-Specific Targeting

CTV platforms often have unique targeting capabilities:

```json
{
  "product_id": "ctv_premium",
  "ext": {
    "roku": {
      "content_genres": ["comedy", "drama", "documentary"],
      "content_rating": ["TV-PG", "TV-14"],
      "viewer_age_ranges": ["18-24", "25-34", "35-44"],
      "device_types": ["tv", "streaming_stick"]
    }
  }
}
```

### Measurement Platform Extensions

Vendor-specific measurement and tracking:

```json
{
  "media_buy_id": "mb_123",
  "ext": {
    "nielsen": {
      "dar_enabled": true,
      "campaign_id": "nielsen_camp_123"
    },
    "comscore": {
      "client_id": "1234567",
      "campaign_id": "camp_abc",
      "reporting_level": "creative"
    },
    "ias": {
      "viewability_tracking": true,
      "brand_safety_enabled": true
    }
  }
}
```

### Creative Platform Extensions

Platform-specific creative metadata:

```json
{
  "format_id": {
    "agent_url": "https://creative.adcontextprotocol.org",
    "id": "display_300x250"
  },
  "ext": {
    "midjourney": {
      "generation_id": "gen_abc123",
      "model_version": "v6",
      "prompt_hash": "sha256:..."
    },
    "gumgum": {
      "brand_safety_score": 0.95,
      "sentiment_analysis": "positive"
    }
  }
}
```

### Data Provider Extensions

Signal provider metadata:

```json
{
  "signal_agent_segment_id": "seg_auto_intenders",
  "ext": {
    "liveramp": {
      "segment_id": "lr_12345",
      "match_rate_estimate": 0.82,
      "refresh_frequency": "daily"
    },
    "neustar": {
      "data_recency_hours": 24,
      "confidence_score": 0.91
    }
  }
}
```

## Best Practices

### DO ✅

- **Always namespace extensions** under vendor/platform key (e.g., `ext.gam`, `ext.roku`)
- **Preserve unknown extensions** when forwarding data
- **Document your extensions** in API docs
- **Keep extensions optional** - don't make them required for functionality
- **Use semantic names** that clearly describe the data
- **Follow JSON conventions** - camelCase or snake_case consistently within your namespace
- **Propose widely-adopted patterns** to the core spec

### DON'T ❌

- **Don't use top-level fields** - always nest under a vendor namespace
- **Don't duplicate standard fields** - propose new spec fields instead
- **Don't include large binaries** - use URLs for assets, `ext` for metadata only
- **Don't put secrets** in `ext` - use proper authentication mechanisms
- **Don't include PII** without proper consent and encryption
- **Don't break compatibility** - treat your `ext` fields like standard API fields
- **Don't use `x_` prefix** - extensions are inherently experimental, namespace is enough
- **Don't use ext for internal tracking** - use `context` for opaque correlation data
- **Don't use context for behavior changes** - use namespaced `ext` for platform parameters

### Anti-Patterns

**❌ Bad: Top-level fields without namespacing**
```json
{
  "ext": {
    "test_mode": true,              // ❌ Not namespaced
    "campaign_id": "123",           // ❌ Not namespaced
    "custom_targeting": {"..."}     // ❌ Not namespaced
  }
}
```

**✅ Good: Always namespace extensions**
```json
{
  "ext": {
    "gam": {
      "test_mode": true,
      "campaign_id": "123",
      "custom_targeting": {"..."}
    }
  }
}
```

**❌ Bad: Internal tracking in ext**
```json
{
  "context": {
    "ui_session": "sess_123"
  },
  "ext": {
    "internal_campaign_id": "camp_xyz"  // ❌ Should be in context
  }
}
```

**✅ Good: Internal tracking in context, platform config in ext**
```json
{
  "context": {
    "ui_session": "sess_123",
    "internal_campaign_id": "camp_xyz"  // Opaque tracking
  },
  "ext": {
    "gam": {
      "order_name": "Tesla Q4"  // Platform-specific config
    }
  }
}
```

## Migration from Standard Fields

If an extension becomes widely adopted, it may be promoted to a standard AdCP field in a future version:

1. **Deprecation period** - Extension remains supported alongside new standard field
2. **Documentation** - Migration guide shows how to transition
3. **Dual support** - Accept both extension and standard field during transition
4. **Removal timeline** - Clear timeline for when extension support ends (typically 12+ months)

Example migration:

```json
// Old: Vendor extension (deprecated but still supported)
{
  "product_id": "ctv_premium",
  "ext": {
    "roku": {
      "content_genres": ["comedy", "drama"]
    }
  }
}

// New: Promoted to standard field (if adopted widely)
{
  "product_id": "ctv_premium",
  "content_genres": ["comedy", "drama"]  // Now standard field
}
```

## Extension Registry

This section can document commonly-used vendor extensions as they emerge in practice. Extensions are vendor-specific and not part of the core spec until formally adopted.

## Questions?

For questions about extension field design or to propose new standard fields, see the [AdCP GitHub discussions](https://github.com/adcontextprotocol/adcp/discussions).
