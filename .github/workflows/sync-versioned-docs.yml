name: Sync Versioned Docs and Schemas

on:
  push:
    branches:
      - main
      - 2.6.x
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    # Only run if triggered by main branch or manually, or if 2.6.x changes
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/2.6.x' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch 2.6.x branch
        run: git fetch origin 2.6.x

      - name: Sync docs from 2.6.x to v2.6-rc
        run: |
          # Remove existing v2.6-rc/docs to ensure clean sync
          rm -rf v2.6-rc/docs
          mkdir -p v2.6-rc

          # Extract docs folder from 2.6.x branch
          git archive origin/2.6.x -- docs | tar -x -C v2.6-rc/

      - name: Sync schemas from 2.6.x to dist/schemas/2.6.0
        run: |
          # Check if dist/schemas/2.6.0 exists in 2.6.x branch
          if git ls-tree -d origin/2.6.x -- dist/schemas/2.6.0 > /dev/null 2>&1; then
            # Remove existing 2.6.0 schemas to ensure clean sync
            rm -rf dist/schemas/2.6.0
            
            # Extract dist/schemas/2.6.0 folder from 2.6.x branch
            git archive origin/2.6.x -- dist/schemas/2.6.0 | tar -x
            echo "Synced dist/schemas/2.6.0 from 2.6.x branch"
          else
            echo "dist/schemas/2.6.0 does not exist in 2.6.x branch, skipping"
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync v2.6-rc docs and schemas from 2.6.x branch"
          title: "chore: sync v2.6-rc docs and schemas from 2.6.x branch"
          body: |
            This PR syncs from the 2.6.x branch:
            - Documentation to `v2.6-rc/docs/`
            - Schemas to `dist/schemas/2.6.0/` (if available)
            
            Auto-generated by the sync-versioned-docs workflow.
          branch: auto/sync-v2.6-rc
          delete-branch: true
          add-paths: |
            v2.6-rc/
            dist/schemas/2.6.0/
