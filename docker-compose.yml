services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: adcp_registry
      POSTGRES_USER: adcp
      POSTGRES_PASSWORD: localdev
    ports:
      - "5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U adcp"]
      interval: 5s
      timeout: 5s
      retries: 5

  app:
    build: .
    ports:
      - "${CONDUCTOR_PORT:-3000}:8080"
    env_file:
      - path: .env.local
        required: false
    environment:
      - NODE_ENV=production
      - PORT=8080
      - DATABASE_URL=postgresql://adcp:localdev@postgres:5432/adcp_registry
      - RUN_MIGRATIONS=true
      # WARNING: Only for local development - DO NOT use in production
      - ALLOW_INSECURE_COOKIES=true
      - DEV_USER_EMAIL=dev@example.com
      - DEV_USER_ID=dev-user-123
    volumes:
      # Mount public directory for hot reloading static files
      - ./server/public:/app/server/public:ro
      # Mount docs directory for Addie knowledge base
      - ./docs:/app/docs:ro
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  postgres_data:
